<!DOCTYPE html>
<html data-clipboard-buttons="" data-code-prettify="" data-code-sidebar="" data-hide-show-guide="" data-sts-import="" data-mobile-support="" data-search="">
<head>
<title>Getting Started · Building a Gateway</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link rel="stylesheet" type="text/css" href="/css/gsguide-cce08ab7a9f46db88819a14148e45bad.css" />

<meta property="og:title" content="Building a Gateway" />
<meta property="og:image" content="/img/spring-by-pivotal-9066b55828deb3c10e27e609af322c40.png" />
<meta property="og:description" content="this guide is designed to get you productive as quickly as possible and using the latest Spring project releases and techniques as recommended by the Spring team" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link active">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<main class="main-body--wrapper">
<div class="row-fluid">
<div class="span8 mobile-left-pane">
<div class="content--title desktop-only">Getting Started</div>
<article class="content--container">
<h1 class="title">Building a Gateway</h1>
<div class="article-body"><div class="paragraph">
<p>This guide walks you through how to use the Spring Cloud Gateway</p>
</div>
<div class="sect1">
<h2 id="_what_youll_build">What you’ll build</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You’ll build a gateway using <a href="https://cloud.spring.io/spring-cloud-gateway/">Spring Cloud Gateway</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_youll_need">What you’ll need</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li> <p>About 15 minutes</p> </li>
<li> <p>A favorite text editor or IDE</p> </li>
<li> <p><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">JDK 1.8</a> or later</p> </li>
<li> <p><a href="http://www.gradle.org/downloads">Gradle 4+</a> or <a href="https://maven.apache.org/download.cgi">Maven 3.2+</a></p> </li>
<li> <p>You can also import the code straight into your IDE:</p>
<div class="ulist">
<ul>
<li> <p><a href="/guides/gs/sts">Spring Tool Suite (STS)</a></p> </li>
<li> <p><a href="/guides/gs/intellij-idea/">IntelliJ IDEA</a></p> </li>
</ul>
</div> </li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_complete_this_guide">How to complete this guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Like most Spring <a href="/guides">Getting Started guides</a>, you can start from scratch and complete each step or you can bypass basic setup steps that are already familiar to you. Either way, you end up with working code.</p>
</div>
<div class="paragraph">
<p>To <strong>start from scratch</strong>, move on to <a href="#scratch">Build with Gradle</a>.</p>
</div>
<div class="paragraph">
<p>To <strong>skip the basics</strong>, do the following:</p>
</div>
<div class="ulist">
<ul>
<li> <p><a href="https://github.com/spring-guides/gs-gateway/archive/master.zip">Download</a> and unzip the source repository for this guide, or clone it using <a href="/understanding/Git">Git</a>: <code>git clone <a href="https://github.com/spring-guides/gs-gateway.git" class="bare">https://github.com/spring-guides/gs-gateway.git</a></code></p> </li>
<li> <p>cd into <code>gs-gateway/initial</code></p> </li>
<li> <p>Jump ahead to <a href="#initial">Creating A Simple Route</a>.</p> </li>
</ul>
</div>
<div class="paragraph">
<p><strong>When you finish</strong>, you can check your results against the code in <code>gs-gateway/complete</code>.</p>
</div>
</div>
</div>
<div class="sect1 reveal-gradle">
<h2 id="reveal-gradle">Build with Gradle</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1 use-gradle">
<h2 id="scratch">Build with Gradle</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First you set up a basic build script. You can use any build system you like when building apps with Spring, but the code you need to work with <a href="http://gradle.org">Gradle</a> and <a href="https://maven.apache.org">Maven</a> is included here. If you’re not familiar with either, refer to <a href="/guides/gs/gradle">Building Java Projects with Gradle</a> or <a href="/guides/gs/maven">Building Java Projects with Maven</a>.</p>
</div>
<div class="sect2">
<h3 id="_create_the_directory_structure">Create the directory structure</h3>
<div class="paragraph">
<p>In a project directory of your choosing, create the following subdirectory structure; for example, with <code>mkdir -p src/main/java/hello</code> on *nix systems:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>└── src
    └── main
        └── java
            └── hello</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_gradle_build_file">Create a Gradle build file</h3>
<div class="paragraph">
<p>Below is the <a href="https://github.com/spring-guides/gs-gateway/blob/master/initial/build.gradle">initial Gradle build file</a>.</p>
</div>
<div class="paragraph">
<p><code>build.gradle</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath("org.springframework.boot:spring-boot-gradle-plugin:2.1.7.RELEASE")
    }
}

apply plugin: 'java'
apply plugin: 'eclipse'
apply plugin: 'idea'
apply plugin: 'org.springframework.boot'
apply plugin: 'io.spring.dependency-management'

bootJar {
    baseName = 'gs-gateway'
    version =  '0.1.0'
}

repositories {
    mavenCentral()
}

sourceCompatibility = 1.8
targetCompatibility = 1.8

dependencyManagement {
    imports {
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:Greenwich.SR2"
    }
}

dependencies {
    compile("org.springframework.cloud:spring-cloud-starter-gateway")
    compile("org.springframework.cloud:spring-cloud-starter-netflix-hystrix")
    compile("org.springframework.cloud:spring-cloud-starter-contract-stub-runner"){
        exclude group: "org.springframework.boot", module: "spring-boot-starter-web"
    }
    testCompile("org.springframework.boot:spring-boot-starter-test")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://docs.spring.io/spring-boot/docs/current/gradle-plugin/reference/html">Spring Boot gradle plugin</a> provides many convenient features:</p>
</div>
<div class="ulist">
<ul>
<li> <p>It collects all the jars on the classpath and builds a single, runnable "über-jar", which makes it more convenient to execute and transport your service.</p> </li>
<li> <p>It searches for the <code>public static void main()</code> method to flag as a runnable class.</p> </li>
<li> <p>It provides a built-in dependency resolver that sets the version number to match <a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-dependencies/pom.xml">Spring Boot dependencies</a>. You can override any version you wish, but it will default to Boot’s chosen set of versions.</p> </li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1 reveal-maven">
<h2 id="reveal-maven">Build with Maven</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1 use-maven">
<h2 id="use-maven">Build with Maven</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First you set up a basic build script. You can use any build system you like when building apps with Spring, but the code you need to work with <a href="https://maven.apache.org">Maven</a> is included here. If you’re not familiar with Maven, refer to <a href="/guides/gs/maven">Building Java Projects with Maven</a>.</p>
</div>
<div class="sect2">
<h3 id="_create_the_directory_structure_2">Create the directory structure</h3>
<div class="paragraph">
<p>In a project directory of your choosing, create the following subdirectory structure; for example, with <code>mkdir -p src/main/java/hello</code> on *nix systems:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>└── src
    └── main
        └── java
            └── hello</pre>
</div>
</div>
<div class="paragraph">
<p><code>pom.xml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;gs-gateway&lt;/artifactId&gt;
    &lt;version&gt;0.1.0&lt;/version&gt;

    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.1.7.RELEASE&lt;/version&gt;
    &lt;/parent&gt;

    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
                &lt;version&gt;Greenwich.SR2&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-contract-stub-runner&lt;/artifactId&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
                    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://docs.spring.io/spring-boot/docs/current/maven-plugin">Spring Boot Maven plugin</a> provides many convenient features:</p>
</div>
<div class="ulist">
<ul>
<li> <p>It collects all the jars on the classpath and builds a single, runnable "über-jar", which makes it more convenient to execute and transport your service.</p> </li>
<li> <p>It searches for the <code>public static void main()</code> method to flag as a runnable class.</p> </li>
<li> <p>It provides a built-in dependency resolver that sets the version number to match <a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-dependencies/pom.xml">Spring Boot dependencies</a>. You can override any version you wish, but it will default to Boot’s chosen set of versions.</p> </li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1 reveal-sts">
<h2 id="reveal-sts">Build with your IDE</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1 use-sts">
<h2 id="use-sts">Build with your IDE</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li> <p>Read how to import this guide straight into <a href="/guides/gs/sts/">Spring Tool Suite</a>.</p> </li>
<li> <p>Read how to work with this guide in <a href="/guides/gs/intellij-idea">IntelliJ IDEA</a>.</p> </li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="initial">Creating A Simple Route</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Spring Cloud Gateway uses routes in order to process requests to downstream services. In this guide we will route all of our requests to <a href="https://httpbin.org">HTTPBin</a>. Routes can be configured a number of ways but for this guide we will use the Java API provided by the Gateway.</p>
</div>
<div class="paragraph">
<p>To get started, create a new <code>Bean</code> of type <code>RouteLocator</code> in <code>Application.java</code>.</p>
</div>
<div class="paragraph">
<p><code>src/main/java/gateway/Application.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Bean
public RouteLocator myRoutes(RouteLocatorBuilder builder) {
    return builder.routes().build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above <code>myRoutes</code> method takes in a <code>RouteLocatorBuilder</code> which can easily be used to create routes. In addition to just creating routes, <code>RouteLocatorBuilder</code> allows you to add predicates and filters to your routes so you can route handle based on certain conditions as well as alter the request/response as you see fit.</p>
</div>
<div class="paragraph">
<p>Let’s create a route that routes a request to <code><a href="https://httpbin.org/get" class="bare">https://httpbin.org/get</a></code> when a request is made to the Gateway at <code>/get</code>. In our configuration of this route we will add a filter that will add the request header <code>Hello</code> with the value <code>World</code> to the request before it is routed.</p>
</div>
<div class="paragraph">
<p><code>src/main/java/gateway/Application.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Bean
public RouteLocator myRoutes(RouteLocatorBuilder builder) {
    return builder.routes()
        .route(p -&gt; p
            .path("/get")
            .filters(f -&gt; f.addRequestHeader("Hello", "World"))
            .uri("http://httpbin.org:80"))
        .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To test our very simple Gateway, just run <code>Application.java</code>, it should be run on port <code>8080</code>. Once the application is running, make a request to <code><a href="http://localhost:8080/get" class="bare">http://localhost:8080/get</a></code>. You can do this using cURL by issuing the following command in your terminal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ curl http://localhost:8080/get</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should receive a response back that looks like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">{
  "args": {},
  "headers": {
    "Accept": "*/*",
    "Connection": "close",
    "Forwarded": "proto=http;host=\"localhost:8080\";for=\"0:0:0:0:0:0:0:1:56207\"",
    "Hello": "World",
    "Host": "httpbin.org",
    "User-Agent": "curl/7.54.0",
    "X-Forwarded-Host": "localhost:8080"
  },
  "origin": "0:0:0:0:0:0:0:1, 73.68.251.70",
  "url": "http://localhost:8080/get"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that HTTPBin shows that the header <code>Hello</code> with the value <code>World</code> was sent in the request.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_hystrix">Using Hystrix</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now lets do something a little more interesting. Since the services behind the Gateway could potentially behave poorly effecting our clients we might want to wrap the routes we create in circuit breakers. You can do this in the Spring Cloud Gateway using Hystrix. This is implemented via a simple filter that you can add to your requests. Lets create another route to demonstrate this.</p>
</div>
<div class="paragraph">
<p>In this example we will leverage HTTPBin’s delay API that waits a certain number of seconds before sending a response. Since this API could potentially take a long time to send its response we can wrap the route that uses this API in a <code>HystrixCommand</code>. Add a new route to our <code>RouteLocator</code> object that looks like the following</p>
</div>
<div class="paragraph">
<p><code>src/main/java/gateway/Application.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Bean
public RouteLocator myRoutes(RouteLocatorBuilder builder) {
    return builder.routes()
        .route(p -&gt; p
            .path("/get")
            .filters(f -&gt; f.addRequestHeader("Hello", "World"))
            .uri("http://httpbin.org:80"))
        .route(p -&gt; p
            .host("*.hystrix.com")
            .filters(f -&gt; f.hystrix(config -&gt; config.setName("mycmd")))
            .uri("http://httpbin.org:80")).
        build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are some differences between this new route configuration and the previous one we created. For one, we are using the host predicate instead of the path predicate. This means that as long as the host is <code>hystrix.com</code> we will route the request to HTTPBin and wrap that request in a <code>HystrixCommand</code>. We do this by applying a filter to the route. The Hystrix filter can be configured using a configuration object. In this example we are just giving the <code>HystrixCommand</code> the name <code>mycmd</code>.</p>
</div>
<div class="paragraph">
<p>Lets test this new route. Start the application, but this time we are going to make a request to <code>/delay/3</code>. It is also important that we include a <code>Host</code> header that has the a host of <code>hystrix.com</code> or else the request won’t be routed. In cURL this would look like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ curl --dump-header - --header 'Host: www.hystrix.com' http://localhost:8080/delay/3</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content"> We are using <code>--dump-header</code> to see the response headers, the <code>-</code> after <code>--dump-header</code> is telling cURL to print the headers to stdout. </td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph">
<p>After executing this command you should see the following in your terminal</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">HTTP/1.1 504 Gateway Timeout
content-length: 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see Hystrix timed out waiting for the response from HTTPBin. When Hystrix times out we can optionaly provide a fallback so that clients do not just received a <code>504</code> but something more meaninful. In a production scenario you may return some data from a cache for example, but in our simple example we will just return a response with the body <code>fallback</code> instead.</p>
</div>
<div class="paragraph">
<p>To do this, lets modify our Hystrix filter to provide a URL to call in the case of a timeout.</p>
</div>
<div class="paragraph">
<p><code>src/main/java/gateway/Application.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Bean
public RouteLocator myRoutes(RouteLocatorBuilder builder) {
    return builder.routes()
        .route(p -&gt; p
            .path("/get")
            .filters(f -&gt; f.addRequestHeader("Hello", "World"))
            .uri("http://httpbin.org:80"))
        .route(p -&gt; p
            .host("*.hystrix.com")
            .filters(f -&gt; f.hystrix(config -&gt; config
                .setName("mycmd")
                .setFallbackUri("forward:/fallback")))
            .uri("http://httpbin.org:80"))
        .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when the Hystrix wrapped route times out it will call <code>/fallback</code> in the Gateway app. Lets add the <code>/fallback</code> endpoint to our application.</p>
</div>
<div class="paragraph">
<p>In <code>Application.java</code> add the class level annotation <code>@RestController</code>, then add the following <code>@RequestMapping</code> to the class.</p>
</div>
<div class="paragraph">
<p><code>src/main/java/gateway/Application.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@RequestMapping("/fallback")
public Mono&lt;String&gt; fallback() {
    return Mono.just("fallback");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To test this new fallback functionality, restart the application and again issue the following cURL command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">$ curl --dump-header - --header 'Host: www.hystrix.com' http://localhost:8080/delay/3</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the fallback in place, we now see that we get a <code>200</code> back from the Gateway with the response body of <code>fallback</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">HTTP/1.1 200 OK
transfer-encoding: chunked
Content-Type: text/plain;charset=UTF-8

fallback</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_writing_tests">Writing Tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As a good developer, we should write some tests to make sure our Gateway is doing what we expect it should. In most cases we want to limit out dependencies on outside resources, especially in unit tests, so we should not depend on HTTPBin. One solution to this problem is to make the URI in our routes configurable, so we can easily change the URI if we need to.</p>
</div>
<div class="paragraph">
<p>In <code>Application.java</code> create a new class called <code>UriConfiguration</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@ConfigurationProperties
class UriConfiguration {

    private String httpbin = "http://httpbin.org:80";

    public String getHttpbin() {
        return httpbin;
    }

    public void setHttpbin(String httpbin) {
        this.httpbin = httpbin;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable this <code>ConfigurationProperties</code> we need to also add a class-level annotation to <code>Application.java</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>@EnableConfigurationProperties(UriConfiguration.class)</code></pre>
</div>
</div>
<div class="paragraph">
<p>With our new configuration class in place lets use it in the <code>myRoutes</code> method.</p>
</div>
<div class="paragraph">
<p><code>src/main/java/gateway/Application.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Bean
public RouteLocator myRoutes(RouteLocatorBuilder builder, UriConfiguration uriConfiguration) {
    String httpUri = uriConfiguration.getHttpbin();
    return builder.routes()
        .route(p -&gt; p
            .path("/get")
            .filters(f -&gt; f.addRequestHeader("Hello", "World"))
            .uri(httpUri))
        .route(p -&gt; p
            .host("*.hystrix.com")
            .filters(f -&gt; f
                .hystrix(config -&gt; config
                    .setName("mycmd")
                    .setFallbackUri("forward:/fallback")))
            .uri(httpUri))
        .build();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, instead of hardcoding the URL to HTTPBin we are getting the URL from our new configuration class instead.</p>
</div>
<div class="paragraph">
<p>Below is the complete contents of <code>Application.java</code>.</p>
</div>
<div class="paragraph">
<p><code>src/main/java/gateway/Application.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@SpringBootApplication
@EnableConfigurationProperties(UriConfiguration.class)
@RestController
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }

    @Bean
    public RouteLocator myRoutes(RouteLocatorBuilder builder, UriConfiguration uriConfiguration) {
        String httpUri = uriConfiguration.getHttpbin();
        return builder.routes()
            .route(p -&gt; p
                .path("/get")
                .filters(f -&gt; f.addRequestHeader("Hello", "World"))
                .uri(httpUri))
            .route(p -&gt; p
                .host("*.hystrix.com")
                .filters(f -&gt; f
                    .hystrix(config -&gt; config
                        .setName("mycmd")
                        .setFallbackUri("forward:/fallback")))
                .uri(httpUri))
            .build();
    }

    @RequestMapping("/fallback")
    public Mono&lt;String&gt; fallback() {
        return Mono.just("fallback");
    }
}

@ConfigurationProperties
class UriConfiguration {

    private String httpbin = "http://httpbin.org:80";

    public String getHttpbin() {
        return httpbin;
    }

    public void setHttpbin(String httpbin) {
        this.httpbin = httpbin;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a new class called <code>ApplicationTest</code> in <code>src/main/test/java/gateway</code>. In the new class add the following content.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@RunWith(SpringRunner.class)
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT,
		properties = {"httpbin=http://localhost:${wiremock.server.port}"})
@AutoConfigureWireMock(port = 0)
public class ApplicationTest {

	@Autowired
	private WebTestClient webClient;

	@Test
	public void contextLoads() throws Exception {
		//Stubs
		stubFor(get(urlEqualTo("/get"))
				.willReturn(aResponse()
					.withBody("{\"headers\":{\"Hello\":\"World\"}}")
					.withHeader("Content-Type", "application/json")));
		stubFor(get(urlEqualTo("/delay/3"))
			.willReturn(aResponse()
				.withBody("no fallback")
				.withFixedDelay(3000)));

		webClient
			.get().uri("/get")
			.exchange()
			.expectStatus().isOk()
			.expectBody()
			.jsonPath("$.headers.Hello").isEqualTo("World");

		webClient
			.get().uri("/delay/3")
			.header("Host", "www.hystrix.com")
			.exchange()
			.expectStatus().isOk()
			.expectBody()
			.consumeWith(
				response -&gt; assertThat(response.getResponseBody()).isEqualTo("fallback".getBytes()));
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our test is actually taking advantage of WireMock from Spring Cloud Contract in order stand up a server that can mock the APIs from HTTPBin. The first thing to notice is the use of <code>@AutoConfigureWireMock(port = 0)</code>. This annotation will start WireMock on a random port for us.</p>
</div>
<div class="paragraph">
<p>Next notice that we are taking advantage of our <code>UriConfiguration</code> class and setting the <code>httpbin</code> property in the <code>@SpringBootTest</code> annotation to the WireMock server running locally. Within the test we then setup "stubs" for the HTTPBin APIs we call via the Gateway and mock the behavior we expect. Finally we use <code>WebTestClient</code> to actually make requests to the Gateway and validate the responses.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Congratulations! You’ve just built your first Spring Coud Gateway application!</p>
</div>
<div class="paragraph">
<p>Want to write a new guide or contribute to an existing one? Check out our <a href="https://github.com/spring-guides/getting-started-guides/wiki">contribution guidelines</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-important" title="Important"></i> </td>
<td class="content"> All guides are released with an ASLv2 license for the code, and an <a href="https://creativecommons.org/licenses/by-nd/3.0/">Attribution, NoDerivatives creative commons license</a> for the writing. </td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</article>
</div>
<aside class="span4 content-right-pane--container mobile-left-pane" id="sidebar">
<a class="ci-status desktop-only" href="https://travis-ci.org/spring-guides/gs-gateway">
<img src="https://travis-ci.org/spring-guides/gs-gateway.svg?branch=master" />
</a>
<div class="right-pane-widget--container desktop-only">
<div class="github-actions https">
<h2>Get the Code</h2>
<div class="btn-group">
<button class="btn" data-protocol="https">HTTPS</button>
<button class="btn" data-protocol="ssh">SSH</button>
</div>
<div class="clone-url https">
<input id="clone-url-https" readonly="readonly" type="text" value="https://github.com/spring-guides/gs-gateway.git" />
<button class="copy-button github" data-toggle="tooltip" data-clipboard-text="https://github.com/spring-guides/gs-gateway.git"></button>
</div>
<div class="clone-url ssh">
<input id="clone-url-ssh" readonly="readonly" type="text" value="git@github.com:spring-guides/gs-gateway.git" />
<button class="copy-button github" data-toggle="tooltip" data-clipboard-text="git@github.com:spring-guides/gs-gateway.git"></button>
</div>
<a class="github_download btn btn-black uppercase" href="https://github.com/spring-guides/gs-gateway/archive/master.zip">Download ZIP</a>
<a class="gs-guide-import" href="https://github.com/spring-guides/gs-gateway.git">Import into STS</a>
<div class="go-to-repo--container">
<a href="https://github.com/spring-guides/gs-gateway"><i class="icon-github"></i>Go To Repo</a>
</div>
<div class="go-to-repo--container">
</div>
</div>
</div>
<div class="right-pane-widget--container">
<div class="related_resources">
<h3><a class="anchor" href="#projects" name="projects"></a>Projects</h3>
<ul>
<li><a href="https://spring.io/projects/spring-cloud-gateway">Spring Cloud Gateway</a></li>
</ul>
</div>
</div>
<div class="right-pane-widget--container">
<div>
<h3><a class="anchor" href="#table-of-contents" name="table-of-contents"></a>Table of contents</h3>
<div><ul class="sectlevel1">
<li><a href="#_what_youll_build">What you’ll build</a></li>
<li><a href="#_what_youll_need">What you’ll need</a></li>
<li><a href="#_how_to_complete_this_guide">How to complete this guide</a></li>
<li><a href="#scratch">Build with Gradle</a> </li>
<li><a href="#use-maven">Build with Maven</a> </li>
<li><a href="#use-sts">Build with your IDE</a></li>
<li><a href="#initial">Creating A Simple Route</a></li>
<li><a href="#_using_hystrix">Using Hystrix</a></li>
<li><a href="#_writing_tests">Writing Tests</a></li>
<li><a href="#_summary">Summary</a></li>
</ul></div>
</div>
</div>
</aside>
</div>
</main>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>