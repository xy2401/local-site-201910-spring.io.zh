<!DOCTYPE html>
<html data-clipboard-buttons="" data-code-prettify="" data-code-sidebar="" data-hide-show-guide="" data-sts-import="" data-mobile-support="" data-search="">
<head>
<title>Getting Started · Client Side Load Balancing with Ribbon and Spring Cloud</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link rel="stylesheet" type="text/css" href="/css/gsguide-cce08ab7a9f46db88819a14148e45bad.css" />

<meta property="og:title" content="Client Side Load Balancing with Ribbon and Spring Cloud" />
<meta property="og:image" content="/img/spring-by-pivotal-9066b55828deb3c10e27e609af322c40.png" />
<meta property="og:description" content="this guide is designed to get you productive as quickly as possible and using the latest Spring project releases and techniques as recommended by the Spring team" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link active">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<main class="main-body--wrapper">
<div class="row-fluid">
<div class="span8 mobile-left-pane">
<div class="content--title desktop-only">Getting Started</div>
<article class="content--container">
<h1 class="title">Client Side Load Balancing with Ribbon and Spring Cloud</h1>
<div class="article-body"><div class="paragraph">
<p>This guide walks you through the process of providing client-side load balancing for a microservice application using Netflix Ribbon.</p>
</div>
<div class="sect1">
<h2 id="_what_youll_build">What you’ll build</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You’ll build a microservice application that uses Netflix Ribbon and Spring Cloud Netflix to provide client-side load balancing in calls to another microservice.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_youll_need">What you’ll need</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li> <p>About 15 minutes</p> </li>
<li> <p>A favorite text editor or IDE</p> </li>
<li> <p><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">JDK 1.8</a> or later</p> </li>
<li> <p><a href="http://www.gradle.org/downloads">Gradle 4+</a> or <a href="https://maven.apache.org/download.cgi">Maven 3.2+</a></p> </li>
<li> <p>You can also import the code straight into your IDE:</p>
<div class="ulist">
<ul>
<li> <p><a href="/guides/gs/sts">Spring Tool Suite (STS)</a></p> </li>
<li> <p><a href="/guides/gs/intellij-idea/">IntelliJ IDEA</a></p> </li>
</ul>
</div> </li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_complete_this_guide">How to complete this guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Like most Spring <a href="/guides">Getting Started guides</a>, you can start from scratch and complete each step or you can bypass basic setup steps that are already familiar to you. Either way, you end up with working code.</p>
</div>
<div class="paragraph">
<p>To <strong>start from scratch</strong>, move on to <a href="#scratch">Build with Gradle</a>.</p>
</div>
<div class="paragraph">
<p>To <strong>skip the basics</strong>, do the following:</p>
</div>
<div class="ulist">
<ul>
<li> <p><a href="https://github.com/spring-guides/gs-client-side-load-balancing/archive/master.zip">Download</a> and unzip the source repository for this guide, or clone it using <a href="/understanding/Git">Git</a>: <code>git clone <a href="https://github.com/spring-guides/gs-client-side-load-balancing.git" class="bare">https://github.com/spring-guides/gs-client-side-load-balancing.git</a></code></p> </li>
<li> <p>cd into <code>gs-client-side-load-balancing/initial</code></p> </li>
<li> <p>Jump ahead to <a href="#initial">Write a server service</a>.</p> </li>
</ul>
</div>
<div class="paragraph">
<p><strong>When you finish</strong>, you can check your results against the code in <code>gs-client-side-load-balancing/complete</code>.</p>
</div>
</div>
</div>
<div class="sect1 reveal-gradle">
<h2 id="reveal-gradle">Build with Gradle</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1 use-gradle">
<h2 id="scratch">Build with Gradle</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First you set up a basic build script. You can use any build system you like when building apps with Spring, but the code you need to work with <a href="http://gradle.org">Gradle</a> and <a href="https://maven.apache.org">Maven</a> is included here. If you’re not familiar with either, refer to <a href="/guides/gs/gradle">Building Java Projects with Gradle</a> or <a href="/guides/gs/maven">Building Java Projects with Maven</a>.</p>
</div>
<div class="sect2">
<h3 id="_create_the_directory_structure">Create the directory structure</h3>
<div class="paragraph">
<p>In a project directory of your choosing, create the following subdirectory structure; for example, with <code>mkdir -p src/main/java/hello</code> on *nix systems:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>└── src
    └── main
        └── java
            └── hello</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_gradle_build_file">Create a Gradle build file</h3>
<div class="paragraph">
<p>Below is the <a href="https://github.com/spring-guides/gs-client-side-load-balancing/blob/master/initial/build.gradle">initial Gradle build file</a>.</p>
</div>
<div class="paragraph">
<p><code>say-hello/build.gradle</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">buildscript {
	ext {
		springBootVersion = '2.1.6.RELEASE'
	}
	repositories {
		mavenCentral()
	}
	dependencies {
		classpath("org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}")
	}
}

apply plugin: 'java'
apply plugin: 'eclipse'
apply plugin: 'org.springframework.boot'
apply plugin: 'io.spring.dependency-management'

bootJar {
	baseName = 'say-hello'
	version = '0.0.1-SNAPSHOT'
}
sourceCompatibility = 1.8
targetCompatibility = 1.8

repositories {
	mavenCentral()
}


dependencies {
	compile('org.springframework.boot:spring-boot-starter-web')
	testCompile('org.springframework.boot:spring-boot-starter-test')
}

eclipse {
	classpath {
		 containers.remove('org.eclipse.jdt.launching.JRE_CONTAINER')
		 containers 'org.eclipse.jdt.launching.JRE_CONTAINER/org.eclipse.jdt.internal.debug.ui.launcher.StandardVMType/JavaSE-1.8'
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>user/build.gradle</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">buildscript {
	ext {
		springBootVersion = '2.1.6.RELEASE'
	}
	repositories {
		mavenCentral()
	}
	dependencies {
		classpath("org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}")
	}
}

apply plugin: 'java'
apply plugin: 'eclipse'
apply plugin: 'org.springframework.boot'
apply plugin: 'io.spring.dependency-management'

bootJar {
	baseName = 'user'
	version = '0.0.1-SNAPSHOT'
}
sourceCompatibility = 1.8
targetCompatibility = 1.8

repositories {
	mavenCentral()
}


dependencies {
	compile('org.springframework.cloud:spring-cloud-starter-netflix-ribbon')
	compile('org.springframework.boot:spring-boot-starter-web')
	testCompile('org.springframework.boot:spring-boot-starter-test')
}

dependencyManagement {
	imports {
		mavenBom "org.springframework.cloud:spring-cloud-dependencies:Greenwich.SR3"
	}
}

eclipse {
	classpath {
		 containers.remove('org.eclipse.jdt.launching.JRE_CONTAINER')
		 containers 'org.eclipse.jdt.launching.JRE_CONTAINER/org.eclipse.jdt.internal.debug.ui.launcher.StandardVMType/JavaSE-1.8'
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://docs.spring.io/spring-boot/docs/current/gradle-plugin/reference/html">Spring Boot gradle plugin</a> provides many convenient features:</p>
</div>
<div class="ulist">
<ul>
<li> <p>It collects all the jars on the classpath and builds a single, runnable "über-jar", which makes it more convenient to execute and transport your service.</p> </li>
<li> <p>It searches for the <code>public static void main()</code> method to flag as a runnable class.</p> </li>
<li> <p>It provides a built-in dependency resolver that sets the version number to match <a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-dependencies/pom.xml">Spring Boot dependencies</a>. You can override any version you wish, but it will default to Boot’s chosen set of versions.</p> </li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1 reveal-maven">
<h2 id="reveal-maven">Build with Maven</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1 use-maven">
<h2 id="use-maven">Build with Maven</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First you set up a basic build script. You can use any build system you like when building apps with Spring, but the code you need to work with <a href="https://maven.apache.org">Maven</a> is included here. If you’re not familiar with Maven, refer to <a href="/guides/gs/maven">Building Java Projects with Maven</a>.</p>
</div>
<div class="sect2">
<h3 id="_create_the_directory_structure_2">Create the directory structure</h3>
<div class="paragraph">
<p>In a project directory of your choosing, create the following subdirectory structure; for example, with <code>mkdir -p src/main/java/hello</code> on *nix systems:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>└── src
    └── main
        └── java
            └── hello</pre>
</div>
</div>
<div class="paragraph">
<p><code>say-hello/pom.xml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

	&lt;groupId&gt;hello&lt;/groupId&gt;
	&lt;artifactId&gt;say-hello&lt;/artifactId&gt;
	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
	&lt;packaging&gt;jar&lt;/packaging&gt;

	&lt;name&gt;say-hello&lt;/name&gt;
	&lt;description&gt;Demo project for Spring Boot&lt;/description&gt;

	&lt;parent&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
		&lt;version&gt;2.1.6.RELEASE&lt;/version&gt;
		&lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
	&lt;/parent&gt;

	&lt;properties&gt;
		&lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
		&lt;java.version&gt;1.8&lt;/java.version&gt;
	&lt;/properties&gt;

	&lt;dependencies&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
		&lt;/dependency&gt;

		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
			&lt;scope&gt;test&lt;/scope&gt;
		&lt;/dependency&gt;
	&lt;/dependencies&gt;

	&lt;build&gt;
		&lt;plugins&gt;
			&lt;plugin&gt;
				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
			&lt;/plugin&gt;
		&lt;/plugins&gt;
	&lt;/build&gt;


&lt;/project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>user/pom.xml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

	&lt;groupId&gt;hello&lt;/groupId&gt;
	&lt;artifactId&gt;user&lt;/artifactId&gt;
	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
	&lt;packaging&gt;jar&lt;/packaging&gt;

	&lt;name&gt;user&lt;/name&gt;
	&lt;description&gt;Demo project for Spring Boot&lt;/description&gt;

	&lt;parent&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
		&lt;version&gt;2.1.6.RELEASE&lt;/version&gt;
		&lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
	&lt;/parent&gt;

	&lt;properties&gt;
		&lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
		&lt;java.version&gt;1.8&lt;/java.version&gt;
	&lt;/properties&gt;

	&lt;dependencies&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
			&lt;artifactId&gt;spring-cloud-starter-netflix-ribbon&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
		&lt;/dependency&gt;

		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
			&lt;scope&gt;test&lt;/scope&gt;
		&lt;/dependency&gt;
	&lt;/dependencies&gt;

	&lt;dependencyManagement&gt;
		&lt;dependencies&gt;
			&lt;dependency&gt;
				&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
				&lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
				&lt;version&gt;Greenwich.SR3&lt;/version&gt;
				&lt;type&gt;pom&lt;/type&gt;
				&lt;scope&gt;import&lt;/scope&gt;
			&lt;/dependency&gt;
		&lt;/dependencies&gt;
	&lt;/dependencyManagement&gt;

	&lt;build&gt;
		&lt;plugins&gt;
			&lt;plugin&gt;
				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
			&lt;/plugin&gt;
		&lt;/plugins&gt;
	&lt;/build&gt;

&lt;/project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://docs.spring.io/spring-boot/docs/current/maven-plugin">Spring Boot Maven plugin</a> provides many convenient features:</p>
</div>
<div class="ulist">
<ul>
<li> <p>It collects all the jars on the classpath and builds a single, runnable "über-jar", which makes it more convenient to execute and transport your service.</p> </li>
<li> <p>It searches for the <code>public static void main()</code> method to flag as a runnable class.</p> </li>
<li> <p>It provides a built-in dependency resolver that sets the version number to match <a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-dependencies/pom.xml">Spring Boot dependencies</a>. You can override any version you wish, but it will default to Boot’s chosen set of versions.</p> </li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1 reveal-sts">
<h2 id="reveal-sts">Build with your IDE</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1 use-sts">
<h2 id="use-sts">Build with your IDE</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li> <p>Read how to import this guide straight into <a href="/guides/gs/sts/">Spring Tool Suite</a>.</p> </li>
<li> <p>Read how to work with this guide in <a href="/guides/gs/intellij-idea">IntelliJ IDEA</a>.</p> </li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="initial">Write a server service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our “server” service is called Say Hello. It will return a random greeting (picked out of a static list of three) from an endpoint accessible at <code>/greeting</code>.</p>
</div>
<div class="paragraph">
<p>In <code>src/main/java/hello</code>, create the file <code>SayHelloApplication.java</code>. It should look like this:</p>
</div>
<div class="paragraph">
<p><code>say-hello/src/main/java/hello/SayHelloApplication.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package hello;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.bind.annotation.RequestMapping;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.*;

@RestController
@SpringBootApplication
public class SayHelloApplication {

  private static Logger log = LoggerFactory.getLogger(SayHelloApplication.class);

  @RequestMapping(value = "/greeting")
  public String greet() {
    log.info("Access /greeting");

    List&lt;String&gt; greetings = Arrays.asList("Hi there", "Greetings", "Salutations");
    Random rand = new Random();

    int randomNum = rand.nextInt(greetings.size());
    return greetings.get(randomNum);
  }

  @RequestMapping(value = "/")
  public String home() {
    log.info("Access /");
    return "Hi!";
  }

  public static void main(String[] args) {
    SpringApplication.run(SayHelloApplication.class, args);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@RestController</code> annotation gives the same effect as if we were using <code>@Controller</code> and <code>@ResponseBody</code> together. It marks <code>SayHelloApplication</code> as a controller class (which is what <code>@Controller</code> does) and ensures that return values from the class’s <code>@RequestMapping</code> methods will be automatically converted appropriately from their original types and written directly to the response body (which is what <code>@ResponseBody</code> does). We have one <code>@RequestMapping</code> method for <code>/greeting</code> and then another for the root path <code>/</code>. (We’ll want that second method when we get to working with Ribbon in just a bit.)</p>
</div>
<div class="paragraph">
<p>We’re going to run multiple instances of this application locally alongside a client service application, so create the directory <code>src/main/resources</code>, create the file <code>application.yml</code> within it, and then in that file, set a default value for <code>server.port</code>. (We’ll instruct the other instances of the application to run on other ports, as well, so that none of the Say Hello instances will conflict with the client when we get that running.) While we’re in this file, we’ll set the <code>spring.application.name</code> for our service too.</p>
</div>
<div class="paragraph">
<p><code>say-hello/src/main/resources/application.yml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yaml" data-lang="yaml">spring:
  application:
    name: say-hello

server:
  port: 8090</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_access_from_a_client_service">Access from a client service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The User application will be what our user sees. It will make a call to the Say Hello application to get a greeting and then send that to our user when the user visits the endpoint at <code>/hi</code>.</p>
</div>
<div class="paragraph">
<p>In the User application directory, under <code>src/main/java/hello</code>, add the file <code>UserApplication.java</code>:</p>
</div>
<div class="paragraph">
<p><code>user/src/main/java/hello/UserApplication.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package hello;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

@SpringBootApplication
@RestController
public class UserApplication {

  @Bean
  RestTemplate restTemplate(){
    return new RestTemplate();
  }

  @Autowired
  RestTemplate restTemplate;

  @RequestMapping("/hi")
  public String hi(@RequestParam(value="name", defaultValue="Artaban") String name) {
    String greeting = this.restTemplate.getForObject("http://localhost:8090/greeting", String.class);
    return String.format("%s, %s!", greeting, name);
  }

  public static void main(String[] args) {
    SpringApplication.run(UserApplication.class, args);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To get a greeting from Say Hello, we’re using Spring’s <code>RestTemplate</code> template class. <code>RestTemplate</code> makes an HTTP GET request to the Say Hello service’s URL as we provide it and gives us the result as a <code>String</code>. (For more information on using Spring to consume a RESTful service, see the <a href="https://spring.io/guides/gs/consuming-rest/">Consuming a RESTful Web Service</a> guide.)</p>
</div>
<div class="paragraph">
<p>Add the <code>spring.application.name</code> and <code>server.port</code> properties to <code>src/main/resources/application.properties</code> or <code>src/main/resources/application.yml</code>:</p>
</div>
<div class="paragraph">
<p><code>user/src/main/resources/application.yml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yaml" data-lang="yaml">spring:
  application:
    name: user

server:
  port: 8888</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_load_balance_across_server_instances">Load balance across server instances</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we can access <code>/hi</code> on the User service and see a friendly greeting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ curl http://localhost:8888/hi
Greetings, Artaban!

$ curl http://localhost:8888/hi?name=Orontes
Salutations, Orontes!</pre>
</div>
</div>
<div class="paragraph">
<p>To move beyond a single hard-coded server URL to a load-balanced solution, let’s set up Ribbon. In the <code>application.yml</code> file under <code>user/src/main/resources/</code>, add the following properties:</p>
</div>
<div class="paragraph">
<p><code>user/src/main/resources/application.yml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yaml" data-lang="yaml">say-hello:
  ribbon:
    eureka:
      enabled: false
    listOfServers: localhost:8090,localhost:9092,localhost:9999
    ServerListRefreshInterval: 15000</code></pre>
</div>
</div>
<div class="paragraph">
<p>This configures properties on a Ribbon <em>client</em>. Spring Cloud Netflix creates an <code>ApplicationContext</code> for each Ribbon client name in our application. This is used to give the client a set of beans for instances of Ribbon components, including:</p>
</div>
<div class="ulist">
<ul>
<li> <p>an <code>IClientConfig</code>, which stores client configuration for a client or load balancer,</p> </li>
<li> <p>an <code>ILoadBalancer</code>, which represents a software load balancer,</p> </li>
<li> <p>a <code>ServerList</code>, which defines how to get a list of servers to choose from,</p> </li>
<li> <p>an <code>IRule</code>, which describes a load balancing strategy, and</p> </li>
<li> <p>an <code>IPing</code>, which says how periodic pings of a server are performed.</p> </li>
</ul>
</div>
<div class="paragraph">
<p>In our case above, the client is named <code>say-hello</code>. The properties we set are <code>eureka.enabled</code> (which we set to <code>false</code>), <code>listOfServers</code>, and <code>ServerListRefreshInterval</code>. Load balancers in Ribbon normally get their server lists from a Netflix Eureka service registry. (See the <a href="https://spring.io/guides/gs/service-registration-and-discovery/">Service Registration and Discovery</a> guide for information on using a Eureka service registry with Spring Cloud.) For our simple purposes here, we’re skipping Eureka, so we set the <code>ribbon.eureka.enabled</code> property to <code>false</code> and instead give Ribbon a static <code>listOfServers</code>. <code>ServerListRefreshInterval</code> is the interval, in milliseconds, between refreshes of Ribbon’s service list.</p>
</div>
<div class="paragraph">
<p>In our <code>UserApplication</code> class, switch the <code>RestTemplate</code> to use the Ribbon client to get the server address for Say Hello:</p>
</div>
<div class="paragraph">
<p><code>user/src/main/java/hello/UserApplication.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package hello;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;
import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.cloud.netflix.ribbon.RibbonClient;

@SpringBootApplication
@RestController
@RibbonClient(name = "say-hello", configuration = SayHelloConfiguration.class)
public class UserApplication {

  @LoadBalanced
  @Bean
  RestTemplate restTemplate(){
    return new RestTemplate();
  }

  @Autowired
  RestTemplate restTemplate;

  @RequestMapping("/hi")
  public String hi(@RequestParam(value="name", defaultValue="Artaban") String name) {
    String greeting = this.restTemplate.getForObject("http://say-hello/greeting", String.class);
    return String.format("%s, %s!", greeting, name);
  }

  public static void main(String[] args) {
    SpringApplication.run(UserApplication.class, args);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We’ve made a couple of other related changes to the <code>UserApplication</code> class. Our <code>RestTemplate</code> is now also marked as <code>LoadBalanced</code>; this tells Spring Cloud that we want to take advantage of its load balancing support (provided, in this case, by Ribbon). The class is annotated with <code>@RibbonClient</code>, which we give the <code>name</code> of our client (<code>say-hello</code>) and then another class, which contains extra <code>configuration</code> for that client.</p>
</div>
<div class="paragraph">
<p>We’ll need to create that class. Add a new file, <code>SayHelloConfiguration.java</code>, in the <code>user/src/main/java/hello</code> directory:</p>
</div>
<div class="paragraph">
<p><code>user/src/main/java/hello/SayHelloConfiguration.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package hello;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;

import com.netflix.client.config.IClientConfig;
import com.netflix.loadbalancer.IPing;
import com.netflix.loadbalancer.IRule;
import com.netflix.loadbalancer.PingUrl;
import com.netflix.loadbalancer.AvailabilityFilteringRule;

public class SayHelloConfiguration {

  @Autowired
  IClientConfig ribbonClientConfig;

  @Bean
  public IPing ribbonPing(IClientConfig config) {
    return new PingUrl();
  }

  @Bean
  public IRule ribbonRule(IClientConfig config) {
    return new AvailabilityFilteringRule();
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can override any Ribbon-related bean that Spring Cloud Netflix gives us by creating our own bean with the same name. Here, we override the <code>IPing</code> and <code>IRule</code> used by the default load balancer. The default <code>IPing</code> is a <code>NoOpPing</code> (which doesn’t actually ping server instances, instead always reporting that they’re stable), and the default <code>IRule</code> is a <code>ZoneAvoidanceRule</code> (which avoids the Amazon EC2 zone that has the most malfunctioning servers, and might thus be a bit difficult to try out in our local environment).</p>
</div>
<div class="paragraph">
<p>Our <code>IPing</code> is a <code>PingUrl</code>, which will ping a URL to check the status of each server. Say Hello has, as you’ll recall, a method mapped to the <code>/</code> path; that means that Ribbon will get an HTTP 200 response when it pings a running Say Hello server. The <code>IRule</code> we set up, the <code>AvailabilityFilteringRule</code>, will use Ribbon’s built-in circuit breaker functionality to filter out any servers in an “open-circuit” state: if a ping fails to connect to a given server, or if it gets a read failure for the server, Ribbon will consider that server “dead” until it begins to respond normally.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content">
<div class="paragraph">
<p>The <code>@SpringBootApplication</code> annotation on the <code>UserApplication</code> class is equivalent to (among others) the <code>@Configuration</code> annotation that marks a class as a source of bean definitions. This is why we don’t need to annotate the <code>SayHelloConfiguration</code> class with <code>@Configuration</code>: since it’s in the same package as <code>UserApplication</code>, it is already being scanned for bean methods.</p>
</div>
<div class="paragraph">
<p>This approach does mean that our Ribbon configuration will be part of the main application context and therefore shared by <em>all</em> Ribbon clients in the User application. In a normal application, you can avoid this by keeping Ribbon beans out of the main application context (e.g., in this example, you could put <code>SayHelloConfiguration</code> in a different package from <code>UserApplication</code>).</p>
</div> </td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_trying_it_out">Trying it out</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Run the Say Hello service, using either Gradle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./gradlew bootRun</pre>
</div>
</div>
<div class="paragraph">
<p>or Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ mvn spring-boot:run</pre>
</div>
</div>
<div class="paragraph">
<p>Run other instances on ports 9092 and 9999, again using either Gradle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ SERVER_PORT=9092 ./gradlew bootRun</pre>
</div>
</div>
<div class="paragraph">
<p>or Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ SERVER_PORT=9999 mvn spring-boot:run</pre>
</div>
</div>
<div class="paragraph">
<p>Then start up the User service. Access <code>localhost:8888/hi</code> and then watch the Say Hello service instances. You can see Ribbon’s pings arriving every 15 seconds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>2016-03-09 21:13:22.115  INFO 90046 --- [nio-8090-exec-1] hello.SayHelloApplication                : Access /
2016-03-09 21:13:22.629  INFO 90046 --- [nio-8090-exec-3] hello.SayHelloApplication                : Access /</pre>
</div>
</div>
<div class="paragraph">
<p>And your requests to the User service should result in calls to Say Hello being spread across the running instances in round-robin form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>2016-03-09 21:15:28.915  INFO 90046 --- [nio-8090-exec-7] hello.SayHelloApplication                : Access /greeting</pre>
</div>
</div>
<div class="paragraph">
<p>Now shut down a Say Hello server instance. Once Ribbon has pinged the down instance and considers it down, you should see requests begin to be balanced across the remaining instances.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Congratulations! You’ve just developed a Spring application that performs client-side load balancing for calls to another application.</p>
</div>
<div class="paragraph">
<p>Want to write a new guide or contribute to an existing one? Check out our <a href="https://github.com/spring-guides/getting-started-guides/wiki">contribution guidelines</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-important" title="Important"></i> </td>
<td class="content"> All guides are released with an ASLv2 license for the code, and an <a href="https://creativecommons.org/licenses/by-nd/3.0/">Attribution, NoDerivatives creative commons license</a> for the writing. </td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</article>
</div>
<aside class="span4 content-right-pane--container mobile-left-pane" id="sidebar">
<a class="ci-status desktop-only" href="https://travis-ci.org/spring-guides/gs-client-side-load-balancing">
<img src="https://travis-ci.org/spring-guides/gs-client-side-load-balancing.svg?branch=master" />
</a>
<div class="right-pane-widget--container desktop-only">
<div class="github-actions https">
<h2>Get the Code</h2>
<div class="btn-group">
<button class="btn" data-protocol="https">HTTPS</button>
<button class="btn" data-protocol="ssh">SSH</button>
</div>
<div class="clone-url https">
<input id="clone-url-https" readonly="readonly" type="text" value="https://github.com/spring-guides/gs-client-side-load-balancing.git" />
<button class="copy-button github" data-toggle="tooltip" data-clipboard-text="https://github.com/spring-guides/gs-client-side-load-balancing.git"></button>
</div>
<div class="clone-url ssh">
<input id="clone-url-ssh" readonly="readonly" type="text" value="git@github.com:spring-guides/gs-client-side-load-balancing.git" />
<button class="copy-button github" data-toggle="tooltip" data-clipboard-text="git@github.com:spring-guides/gs-client-side-load-balancing.git"></button>
</div>
<a class="github_download btn btn-black uppercase" href="https://github.com/spring-guides/gs-client-side-load-balancing/archive/master.zip">Download ZIP</a>
<a class="gs-guide-import" href="https://github.com/spring-guides/gs-client-side-load-balancing.git">Import into STS</a>
<div class="go-to-repo--container">
<a href="https://github.com/spring-guides/gs-client-side-load-balancing"><i class="icon-github"></i>Go To Repo</a>
</div>
<div class="go-to-repo--container">
</div>
</div>
</div>
<div class="right-pane-widget--container">
<div>
<h3><a class="anchor" href="#table-of-contents" name="table-of-contents"></a>Table of contents</h3>
<div><ul class="sectlevel1">
<li><a href="#_what_youll_build">What you’ll build</a></li>
<li><a href="#_what_youll_need">What you’ll need</a></li>
<li><a href="#_how_to_complete_this_guide">How to complete this guide</a></li>
<li><a href="#scratch">Build with Gradle</a> </li>
<li><a href="#use-maven">Build with Maven</a> </li>
<li><a href="#use-sts">Build with your IDE</a></li>
<li><a href="#initial">Write a server service</a></li>
<li><a href="#_access_from_a_client_service">Access from a client service</a></li>
<li><a href="#_load_balance_across_server_instances">Load balance across server instances</a></li>
<li><a href="#_trying_it_out">Trying it out</a></li>
<li><a href="#_summary">Summary</a></li>
</ul></div>
</div>
</div>
</aside>
</div>
</main>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>