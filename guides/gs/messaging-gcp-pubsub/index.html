<!DOCTYPE html>
<html data-clipboard-buttons="" data-code-prettify="" data-code-sidebar="" data-hide-show-guide="" data-sts-import="" data-mobile-support="" data-search="">
<head>
<title>Getting Started · Messaging with Google Cloud Pub/Sub</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link rel="stylesheet" type="text/css" href="/css/gsguide-cce08ab7a9f46db88819a14148e45bad.css" />

<meta property="og:title" content="Messaging with Google Cloud Pub/Sub" />
<meta property="og:image" content="/img/spring-by-pivotal-9066b55828deb3c10e27e609af322c40.png" />
<meta property="og:description" content="this guide is designed to get you productive as quickly as possible and using the latest Spring project releases and techniques as recommended by the Spring team" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link active">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<main class="main-body--wrapper">
<div class="row-fluid">
<div class="span8 mobile-left-pane">
<div class="content--title desktop-only">Getting Started</div>
<article class="content--container">
<h1 class="title">Messaging with Google Cloud Pub/Sub</h1>
<div class="article-body"><div class="paragraph">
<p>This guide walks you through the process of exchanging messages between different parts of a program, or different programs, using <a href="https://docs.spring.io/spring-integration/reference/htmlsingle/#overview-endpoints-channeladapter">Spring Integration channel adapters</a> and <a href="https://cloud.google.com/pubsub/">Google Cloud Pub/Sub</a> as the underlying message exchange mechanism.</p>
</div>
<div class="sect1">
<h2 id="_what_youll_build">What you’ll build</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <a href="https://spring.io/guides/gs/spring-boot/">Spring Boot</a> web application that sends messages to itself and processes those messages.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_youll_need">What you’ll need</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li> <p>About 15 minutes</p> </li>
<li> <p>A favorite text editor or IDE</p> </li>
<li> <p><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">JDK 1.8</a> or later</p> </li>
<li> <p><a href="http://www.gradle.org/downloads">Gradle 4+</a> or <a href="https://maven.apache.org/download.cgi">Maven 3.2+</a></p> </li>
<li> <p>You can also import the code straight into your IDE:</p>
<div class="ulist">
<ul>
<li> <p><a href="/guides/gs/sts">Spring Tool Suite (STS)</a></p> </li>
<li> <p><a href="/guides/gs/intellij-idea/">IntelliJ IDEA</a></p> </li>
</ul>
</div> </li>
<li> <p><a href="https://cloud.google.com/pubsub/docs/quickstart-console">A Google Cloud Platform project with billing and Pub/Sub enabled</a></p> </li>
<li> <p><a href="https://cloud.google.com/sdk/">Google Cloud SDK</a></p> </li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_complete_this_guide">How to complete this guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Like most Spring <a href="/guides">Getting Started guides</a>, you can start from scratch and complete each step or you can bypass basic setup steps that are already familiar to you. Either way, you end up with working code.</p>
</div>
<div class="paragraph">
<p>To <strong>start from scratch</strong>, move on to <a href="#scratch">Build with Gradle</a>.</p>
</div>
<div class="paragraph">
<p>To <strong>skip the basics</strong>, do the following:</p>
</div>
<div class="ulist">
<ul>
<li> <p><a href="https://github.com/spring-guides/gs-messaging-gcp-pubsub/archive/master.zip">Download</a> and unzip the source repository for this guide, or clone it using <a href="/understanding/Git">Git</a>: <code>git clone <a href="https://github.com/spring-guides/gs-messaging-gcp-pubsub.git" class="bare">https://github.com/spring-guides/gs-messaging-gcp-pubsub.git</a></code></p> </li>
<li> <p>cd into <code>gs-messaging-gcp-pubsub/initial</code></p> </li>
<li> <p>Jump ahead to <a href="#initial">Add required dependencies</a>.</p> </li>
</ul>
</div>
<div class="paragraph">
<p><strong>When you finish</strong>, you can check your results against the code in <code>gs-messaging-gcp-pubsub/complete</code>.</p>
</div>
</div>
</div>
<div class="sect1 reveal-gradle">
<h2 id="reveal-gradle">Build with Gradle</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1 use-gradle">
<h2 id="scratch">Build with Gradle</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First you set up a basic build script. You can use any build system you like when building apps with Spring, but the code you need to work with <a href="http://gradle.org">Gradle</a> and <a href="https://maven.apache.org">Maven</a> is included here. If you’re not familiar with either, refer to <a href="/guides/gs/gradle">Building Java Projects with Gradle</a> or <a href="/guides/gs/maven">Building Java Projects with Maven</a>.</p>
</div>
<div class="sect2">
<h3 id="_create_the_directory_structure">Create the directory structure</h3>
<div class="paragraph">
<p>In a project directory of your choosing, create the following subdirectory structure; for example, with <code>mkdir -p src/main/java/hello</code> on *nix systems:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>└── src
    └── main
        └── java
            └── hello</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_gradle_build_file">Create a Gradle build file</h3>
<div class="paragraph">
<p>Below is the <a href="https://github.com/spring-guides/gs-messaging-gcp-pubsub/blob/master/initial/build.gradle">initial Gradle build file</a>.</p>
</div>
<div class="paragraph">
<p><code>build.gradle</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath("org.springframework.boot:spring-boot-gradle-plugin:2.1.6.RELEASE")
    }
}

apply plugin: 'java'
apply plugin: 'eclipse'
apply plugin: 'idea'
apply plugin: 'org.springframework.boot'
apply plugin: 'io.spring.dependency-management'

bootJar {
    baseName = 'gs-spring-cloud-gcp'
    version =  '0.1.0'
}

repositories {
    mavenCentral()
}

sourceCompatibility = 1.8
targetCompatibility = 1.8

dependencies {
    compile("org.springframework.boot:spring-boot-starter-web")
    testCompile("org.springframework.boot:spring-boot-starter-test")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://docs.spring.io/spring-boot/docs/current/gradle-plugin/reference/html">Spring Boot gradle plugin</a> provides many convenient features:</p>
</div>
<div class="ulist">
<ul>
<li> <p>It collects all the jars on the classpath and builds a single, runnable "über-jar", which makes it more convenient to execute and transport your service.</p> </li>
<li> <p>It searches for the <code>public static void main()</code> method to flag as a runnable class.</p> </li>
<li> <p>It provides a built-in dependency resolver that sets the version number to match <a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-dependencies/pom.xml">Spring Boot dependencies</a>. You can override any version you wish, but it will default to Boot’s chosen set of versions.</p> </li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1 reveal-maven">
<h2 id="reveal-maven">Build with Maven</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1 use-maven">
<h2 id="use-maven">Build with Maven</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First you set up a basic build script. You can use any build system you like when building apps with Spring, but the code you need to work with <a href="https://maven.apache.org">Maven</a> is included here. If you’re not familiar with Maven, refer to <a href="/guides/gs/maven">Building Java Projects with Maven</a>.</p>
</div>
<div class="sect2">
<h3 id="_create_the_directory_structure_2">Create the directory structure</h3>
<div class="paragraph">
<p>In a project directory of your choosing, create the following subdirectory structure; for example, with <code>mkdir -p src/main/java/hello</code> on *nix systems:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>└── src
    └── main
        └── java
            └── hello</pre>
</div>
</div>
<div class="paragraph">
<p><code>pom.xml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;gs-spring-cloud-gcp&lt;/artifactId&gt;
    &lt;version&gt;0.1.0&lt;/version&gt;

    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
        &lt;spring-boot-release.version&gt;2.1.6.RELEASE&lt;/spring-boot-release.version&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;dependencyManagement&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt;
                &lt;version&gt;${spring-boot-release.version}&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://docs.spring.io/spring-boot/docs/current/maven-plugin">Spring Boot Maven plugin</a> provides many convenient features:</p>
</div>
<div class="ulist">
<ul>
<li> <p>It collects all the jars on the classpath and builds a single, runnable "über-jar", which makes it more convenient to execute and transport your service.</p> </li>
<li> <p>It searches for the <code>public static void main()</code> method to flag as a runnable class.</p> </li>
<li> <p>It provides a built-in dependency resolver that sets the version number to match <a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-dependencies/pom.xml">Spring Boot dependencies</a>. You can override any version you wish, but it will default to Boot’s chosen set of versions.</p> </li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1 reveal-sts">
<h2 id="reveal-sts">Build with your IDE</h2>
<div class="sectionbody">
</div>
</div>
<div class="sect1 use-sts">
<h2 id="use-sts">Build with your IDE</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li> <p>Read how to import this guide straight into <a href="/guides/gs/sts/">Spring Tool Suite</a>.</p> </li>
<li> <p>Read how to work with this guide in <a href="/guides/gs/intellij-idea">IntelliJ IDEA</a>.</p> </li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="initial">Add required dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Add the following to your <code>pom.xml</code> file if you’re using Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>&lt;dependencies&gt;
    ...
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-gcp-starter-pubsub&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.integration&lt;/groupId&gt;
        &lt;artifactId&gt;spring-integration-core&lt;/artifactId&gt;
    &lt;/dependency&gt;
    ...
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, if you’re using Gradle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>dependencies {
    ...
    compile("org.springframework.cloud:spring-cloud-gcp-starter-pubsub:1.0.0.RELEASE")
    compile("org.springframework.integration:spring-integration-core")
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you’re using Maven, you are also strongly encouraged to use the Spring Cloud GCP bill of materials to control the versions of your dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>&lt;properties&gt;
    ...
    &lt;spring-cloud-gcp.version&gt;1.0.0.RELEASE&lt;/spring-cloud-gcp.version&gt;
    ...
&lt;/properties&gt;

&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
       ...
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-gcp-dependencies&lt;/artifactId&gt;
            &lt;version&gt;${spring-cloud-gcp.version}&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
        ...
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_set_up_google_cloud_pubsub_environment">Set up Google Cloud Pub/Sub environment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You will need a topic and a subscription to send and receive messages from Google Cloud Pub/Sub. You can create them in the <a href="https://console.cloud.google.com/cloudpubsub">Google Cloud Console</a> or, programatically, with the <code>PubSubAdmin</code> class.</p>
</div>
<div class="paragraph">
<p>For this exercise, create a topic called "testTopic" and a subscription for that topic called "testSubscription".</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_application_files">Create application files</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You’ll need a class to include the channel adapter and messaging configuration. Create a PubSubApplication class with the @SpringBootApplication header, as is typical with a Spring Boot application.</p>
</div>
<div class="paragraph">
<p><code>src/main/java/hello/PubSubApplication.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@SpringBootApplication
public class PubSubApplication {

  public static void main(String[] args) throws IOException {
    SpringApplication.run(PubSubApplication.class, args);
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additionally, since you’re building a web application, create a WebAppController class to separate between the controller and configuration logic.</p>
</div>
<div class="paragraph">
<p><code>src/main/java/hello/WebAppController.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@RestController
public class WebAppController {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We’re still missing two files for HTML and properties.</p>
</div>
<div class="paragraph">
<p><code>src/main/resources/static/index.html</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;title&gt;Spring Integration GCP sample&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div name="formDiv"&gt;
  &lt;form action="/publishMessage" method="post"&gt;
    Publish message: &lt;input type="text" name="message" /&gt; &lt;input type="submit" value="Publish!"/&gt;
  &lt;/form&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>src/main/resources/application.properties</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">#spring.cloud.gcp.project-id=[YOUR_GCP_PROJECT_ID_HERE]
#spring.cloud.gcp.credentials.location=file:[LOCAL_FS_CREDENTIALS_PATH]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Spring Cloud GCP Core Boot starter can auto-configure these two properties and make them optional. Properties from the properties file always have precedence over the Spring Boot configuration. The Spring Cloud GCP Core Boot starter is bundled with the Spring Cloud GCP Pub/Sub Boot starter.</p>
</div>
<div class="paragraph">
<p>The GCP project ID is auto-configured from the <code>GOOGLE_CLOUD_PROJECT</code> environment variable, among <a href="https://github.com/GoogleCloudPlatform/google-cloud-java/blob/master/google-cloud-core/src/main/java/com/google/cloud/ServiceOptions.java#L287">several other sources</a>. The OAuth2 credentials are auto-configured from the <a href="https://developers.google.com/identity/protocols/application-default-credentials">GOOGLE_APPLICATION_CREDENTIALS</a> environment variable. If the <a href="https://cloud.google.com/sdk/">Google Cloud SDK</a> is installed, this environment variable is easily configured by running the <code>gcloud auth application-default login</code> command in the same process of the app, or a parent one.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_an_inbound_channel_adapter">Create an inbound channel adapter</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An inbound channel adapter listens to messages from a Google Cloud Pub/Sub subscription and sends them to a Spring channel in an application.</p>
 </div>
<div class="paragraph">
<p>Instantiating an inbound channel adapter requires a <code>PubSubTemplate</code> instance and the name of an existing subscription. <code>PubSubTemplate</code> is Spring’s abstraction to subscribe to Google Cloud Pub/Sub topics. The Spring Cloud GCP Pub/Sub Boot starter provides an auto-configured <code>PubSubTemplate</code> instance which you can simply inject as a method argument.</p>
</div>
<div class="paragraph">
<p><code>src/main/java/hello/PubSubApplication.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">  @Bean
  public PubSubInboundChannelAdapter messageChannelAdapter(
      @Qualifier("pubsubInputChannel") MessageChannel inputChannel,
      PubSubTemplate pubSubTemplate) {
    PubSubInboundChannelAdapter adapter =
        new PubSubInboundChannelAdapter(pubSubTemplate, "testSubscription");
    adapter.setOutputChannel(inputChannel);
    adapter.setAckMode(AckMode.MANUAL);

    return adapter;
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The message acknowledgement mode is set in the adapter to automatic, by default. This behaviour may be overridden, as shown in the example.</p>
</div>
<div class="paragraph">
<p>After the channel adapter is instantiated, an output channel where the adapter sends the received messages to must be configured.</p>
</div>
<div class="paragraph">
<p><code>src/main/java/hello/PubSubApplication.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">  @Bean
  public MessageChannel pubsubInputChannel() {
    return new DirectChannel();
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Attached to an inbound channel is a service activator which is used to process incoming messages.</p>
</div>
<div class="paragraph">
<p><code>src/main/java/hello/PubSubApplication.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">  @Bean
  @ServiceActivator(inputChannel = "pubsubInputChannel")
  public MessageHandler messageReceiver() {
    return message -&gt; {
      LOGGER.info("Message arrived! Payload: " + new String((byte[]) message.getPayload()));
      AckReplyConsumer consumer =
          (AckReplyConsumer) message.getHeaders().get(GcpPubSubHeaders.ACKNOWLEDGEMENT);
      consumer.ack();
    };
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ServiceActivator</code> input channel name (e.g., <code>"pubsubInputChannel"</code>) must match the input channel method name. Whenever a new message arrives to that channel, it is processed by the returned <code>MessageHandler</code>.</p>
</div>
<div class="paragraph">
<p>In this example, the message is processed simply by logging its body and acknowledging it. In manual acknowledgement, a message is acknowledged using the <code>AckReplyConsumer</code> object, which is sent in the message headers.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_an_outbound_channel_adapter">Create an outbound channel adapter</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An outbound channel adapter listens to new messages from a Spring channel and publishes them to a Google Cloud Pub/Sub topic.</p>
</div>
<div class="paragraph">
<p>Instantiating an outbound channel adapter requires a <code>PubSubTemplate</code> and the name of an existing topic. <code>PubSubTemplate</code> is Spring’s abstraction to publish messages to Google Cloud Pub/Sub topics. The Spring Cloud GCP Pub/Sub Boot starter provides an auto-configured <code>PubSubTemplate</code> instance.</p>
</div>
<div class="paragraph">
<p><code>src/main/java/hello/PubSubApplication.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">  @Bean
  @ServiceActivator(inputChannel = "pubsubOutputChannel")
  public MessageHandler messageSender(PubSubTemplate pubsubTemplate) {
    return new PubSubMessageHandler(pubsubTemplate, "testTopic");
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use a <code>MessageGateway</code> to write messages to a channel and publish them to Google Cloud Pub/Sub.</p>
</div>
<div class="paragraph">
<p><code>src/main/java/hello/PubSubApplication.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">  @MessagingGateway(defaultRequestChannel = "pubsubOutputChannel")
  public interface PubsubOutboundGateway {

    void sendToPubsub(String text);
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>From this code, Spring auto-generates an object that can then be autowired into a private field in the application.</p>
</div>
<div class="paragraph">
<p><code>src/main/java/hello/WebAppController.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">  @Autowired
  private PubsubOutboundGateway messagingGateway;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_controller_logic">Add controller logic</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Add logic to your controller that lets you write to a Spring channel:</p>
</div>
<div class="paragraph">
<p><code>src/main/java/hello/WebAppController.java</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">package hello;

import hello.PubSubApplication.PubsubOutboundGateway;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.servlet.view.RedirectView;

@RestController
public class WebAppController {

  // tag::autowireGateway[]
  @Autowired
  private PubsubOutboundGateway messagingGateway;
  // end::autowireGateway[]

  @PostMapping("/publishMessage")
  public RedirectView publishMessage(@RequestParam("message") String message) {
    messagingGateway.sendToPubsub(message);
    return new RedirectView("/");
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authentication">Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Your application must be authenticated either via the GOOGLE_APPLICATION_CREDENTIALS environment variable or the <code>spring.cloud.gcp.credentials.location</code> property.</p>
</div>
<div class="paragraph">
<p>If you have the <a href="https://cloud.google.com/sdk/">Google Cloud SDK</a> installed, you can log in with your user account using the <code>gcloud auth application-default login</code> command.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can download a service account credentials file from the <a href="https://cloud.google.com/console">Google Cloud Console</a> and point the <code>spring.cloud.gcp.credentials.location</code> property in the <code>application.properties</code> file to it.</p>
</div>
<div class="paragraph">
<p>As a <a href="https://docs.spring.io/spring/docs/3.2.x/spring-framework-reference/html/resources.html">Spring Resource</a>, the <code>spring.cloud.gcp.credentials.location</code> can also be obtained from places other than the file system, like a URL, classpath, etc.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_make_the_application_executable">Make the application executable</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Although it is possible to package this service as a traditional <a href="/understanding/WAR">WAR</a> file for deployment to an external application server, the simpler approach demonstrated below creates a standalone application. You package everything in a single, executable JAR file, driven by a Java <code>main()</code> method. Also, you use Spring’s support for embedding the <a href="/understanding/Tomcat">Tomcat</a> servlet container as the HTTP runtime, instead of deploying to an external instance.</p>
</div>
<div class="paragraph">
<p><code>@SpringBootApplication</code> is a convenience annotation that adds all of the following:</p>
</div>
<div class="ulist">
<ul>
<li> <p><code>@Configuration</code>: Tags the class as a source of bean definitions for the application context.</p> </li>
<li> <p><code>@EnableAutoConfiguration</code>: Tells Spring Boot to start adding beans based on classpath settings, other beans, and various property settings. For example, if <code>spring-webmvc</code> is on the classpath, this annotation flags the application as a web application and activates key behaviors, such as setting up a <code>DispatcherServlet</code>.</p> </li>
<li> <p><code>@ComponentScan</code>: Tells Spring to look for other components, configurations, and services in the <code>hello</code> package, letting it find the controllers.</p> </li>
</ul>
</div>
<div class="paragraph">
<p>The <code>main()</code> method uses Spring Boot’s <code>SpringApplication.run()</code> method to launch an application. Did you notice that there was not a single line of XML? There is no <code>web.xml</code> file, either. This web application is 100% pure Java and you did not have to deal with configuring any plumbing or infrastructure.</p>
</div>
<div class="sect2">
<h3 id="_build_an_executable_jar">Build an executable JAR</h3>
<div class="paragraph">
<p>You can run the application from the command line with Gradle or Maven. You can also build a single executable JAR file that contains all the necessary dependencies, classes, and resources and run that. Building an executable jar so makes it easy to ship, version, and deploy the service as an application throughout the development lifecycle, across different environments, and so forth.</p>
</div>
<div class="paragraph">
<p>If you use Gradle, you can run the application by using <code>./gradlew bootRun</code>. Alternatively, you can build the JAR file by using <code>./gradlew build</code> and then run the JAR file, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock has-copy-button">
<div class="content">
<pre>java -jar build/libs/gs-messaging-gcp-pubsub-0.1.0.jar</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If you use Maven, you can run the application by using <code>./mvnw spring-boot:run</code>. Alternatively, you can build the JAR file with <code>./mvnw clean package</code> and then run the JAR file, as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock has-copy-button">
<div class="content">
<pre>java -jar target/gs-messaging-gcp-pubsub-0.1.0.jar</pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content"> The steps described here create a runnable JAR. You can also <a href="/guides/gs/convert-jar-to-war/">build a classic WAR file</a>. </td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph">
<p>Logging output is displayed. The service should be up and running within a few seconds.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_the_application">Test the application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that the application is running, you can test it. Open <a href="http://localhost:8080" class="bare">http://localhost:8080</a>, type a message in the input text box, press the "Publish!" button and verify that the message was correctly logged in your process terminal window.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Congratulations! You’ve just developed a Spring application that exchanges messages using Spring Integration GCP Pub/Sub channel adapters!</p>
</div>
<div class="paragraph">
<p>Want to write a new guide or contribute to an existing one? Check out our <a href="https://github.com/spring-guides/getting-started-guides/wiki">contribution guidelines</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-important" title="Important"></i> </td>
<td class="content"> All guides are released with an ASLv2 license for the code, and an <a href="https://creativecommons.org/licenses/by-nd/3.0/">Attribution, NoDerivatives creative commons license</a> for the writing. </td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</article>
</div>
<aside class="span4 content-right-pane--container mobile-left-pane" id="sidebar">
<a class="ci-status desktop-only" href="https://travis-ci.org/spring-guides/gs-messaging-gcp-pubsub">
<img src="https://travis-ci.org/spring-guides/gs-messaging-gcp-pubsub.svg?branch=master" />
</a>
<div class="right-pane-widget--container desktop-only">
<div class="github-actions https">
<h2>Get the Code</h2>
<div class="btn-group">
<button class="btn" data-protocol="https">HTTPS</button>
<button class="btn" data-protocol="ssh">SSH</button>
</div>
<div class="clone-url https">
<input id="clone-url-https" readonly="readonly" type="text" value="https://github.com/spring-guides/gs-messaging-gcp-pubsub.git" />
<button class="copy-button github" data-toggle="tooltip" data-clipboard-text="https://github.com/spring-guides/gs-messaging-gcp-pubsub.git"></button>
</div>
<div class="clone-url ssh">
<input id="clone-url-ssh" readonly="readonly" type="text" value="git@github.com:spring-guides/gs-messaging-gcp-pubsub.git" />
<button class="copy-button github" data-toggle="tooltip" data-clipboard-text="git@github.com:spring-guides/gs-messaging-gcp-pubsub.git"></button>
</div>
<a class="github_download btn btn-black uppercase" href="https://github.com/spring-guides/gs-messaging-gcp-pubsub/archive/master.zip">Download ZIP</a>
<a class="gs-guide-import" href="https://github.com/spring-guides/gs-messaging-gcp-pubsub.git">Import into STS</a>
<div class="go-to-repo--container">
<a href="https://github.com/spring-guides/gs-messaging-gcp-pubsub"><i class="icon-github"></i>Go To Repo</a>
</div>
<div class="go-to-repo--container">
</div>
</div>
</div>
<div class="right-pane-widget--container">
<div>
<h3><a class="anchor" href="#table-of-contents" name="table-of-contents"></a>Table of contents</h3>
<div><ul class="sectlevel1">
<li><a href="#_what_youll_build">What you’ll build</a></li>
<li><a href="#_what_youll_need">What you’ll need</a></li>
<li><a href="#_how_to_complete_this_guide">How to complete this guide</a></li>
<li><a href="#scratch">Build with Gradle</a> </li>
<li><a href="#use-maven">Build with Maven</a> </li>
<li><a href="#use-sts">Build with your IDE</a></li>
<li><a href="#initial">Add required dependencies</a></li>
<li><a href="#_set_up_google_cloud_pubsub_environment">Set up Google Cloud Pub/Sub environment</a></li>
<li><a href="#_create_application_files">Create application files</a></li>
<li><a href="#_create_an_inbound_channel_adapter">Create an inbound channel adapter</a></li>
<li><a href="#_create_an_outbound_channel_adapter">Create an outbound channel adapter</a></li>
<li><a href="#_add_controller_logic">Add controller logic</a></li>
<li><a href="#_authentication">Authentication</a></li>
<li><a href="#_make_the_application_executable">Make the application executable</a> </li>
<li><a href="#_test_the_application">Test the application</a></li>
<li><a href="#_summary">Summary</a></li>
</ul></div>
</div>
</div>
</aside>
</div>
</main>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>