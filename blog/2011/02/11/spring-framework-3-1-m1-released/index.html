<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Spring Framework 3.1 M1 released</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Spring Framework 3.1 M1 released" />
<meta name="twitter:description" content="&lt;p&gt;The first milestone release of Spring 3.1 has just been published [1], and this article kicks off a series of posts where I and other team members will walk through each of the major features. Even in the first milestone there’s already a lot to talk about!&lt;/p&gt;
&lt;ul&gt; 
 &lt;li&gt;Bean definition profiles&lt;/li&gt; 
 &lt;li&gt;Unified property management through Spring&#39;s new &lt;code&gt;Environment&lt;/code&gt; abstraction&lt;/li&gt; 
 &lt;li&gt;Enhancements to Java-based configuration with &lt;code&gt;@Feature&lt;/code&gt; methods&lt;/li&gt; 
 &lt;li&gt;Expanded MVC namespace support and a Java-based configuration equivalent&lt;/li&gt; 
 &lt;li&gt;Streaming support and new interception model for the &lt;code&gt;RestTemplate&lt;/code&gt; API&lt;/li&gt; 
 &lt;li&gt;Comprehensive caching support&lt;/li&gt; 
 &lt;li&gt;New &lt;code&gt;c:&lt;/code&gt; XML namespace for concise configuration of constructor injection&lt;/li&gt; 
&lt;/ul&gt;
" />
<meta name="twitter:creator" content="@cbeams" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/1e63dcf15fa29bebc0c68bc4d28b87e6?s=200" />

<meta property="og:title" content="Spring Framework 3.1 M1 released" />
<meta property="og:image" content="https://gravatar.com/avatar/1e63dcf15fa29bebc0c68bc4d28b87e6?s=200" />
<meta property="og:description" content="&lt;p&gt;The first milestone release of Spring 3.1 has just been published [1], and this article kicks off a series of posts where I and other team members will walk through each of the major features. Even in the first milestone there’s already a lot to talk about!&lt;/p&gt;
&lt;ul&gt; 
 &lt;li&gt;Bean definition profiles&lt;/li&gt; 
 &lt;li&gt;Unified property management through Spring&#39;s new &lt;code&gt;Environment&lt;/code&gt; abstraction&lt;/li&gt; 
 &lt;li&gt;Enhancements to Java-based configuration with &lt;code&gt;@Feature&lt;/code&gt; methods&lt;/li&gt; 
 &lt;li&gt;Expanded MVC namespace support and a Java-based configuration equivalent&lt;/li&gt; 
 &lt;li&gt;Streaming support and new interception model for the &lt;code&gt;RestTemplate&lt;/code&gt; API&lt;/li&gt; 
 &lt;li&gt;Comprehensive caching support&lt;/li&gt; 
 &lt;li&gt;New &lt;code&gt;c:&lt;/code&gt; XML namespace for concise configuration of constructor injection&lt;/li&gt; 
&lt;/ul&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2011-02-11 10:08:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Spring Framework 3.1 M1 released</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/1e63dcf15fa29bebc0c68bc4d28b87e6?s=20&amp;d=mm" />
<span class="author">Chris Beams</span>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2011-02-11 10:08:00.0">February 11, 2011</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="390" href="/blog/2011/02/11/spring-framework-3-1-m1-released#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><p>The first milestone release of Spring 3.1 has just been published [1], and this article kicks off a series of posts where I and other team members will walk through each of the major features. Even in the first milestone there&rsquo;s already a lot to talk about!</p>
<ul>
<li>Bean definition profiles</li>
<li>Unified property management through Spring's new <code>Environment</code> abstraction</li>
<li>Enhancements to Java-based configuration with <code>@Feature</code> methods</li>
<li>Expanded MVC namespace support and a Java-based configuration equivalent</li>
<li>Streaming support and new interception model for the <code>RestTemplate</code> API</li>
<li>Comprehensive caching support</li>
<li>New <code>c:</code> XML namespace for concise configuration of constructor injection</li>
</ul><p><br />Today I&rsquo;ll be covering the first item &ndash; a new feature we call <em>bean definition profiles</em>. One of our most frequent requests has been to provide a mechanism in the core container that allows for registration of different beans in different environments. The word &ldquo;environment&rdquo; can mean different things to different users, but a typical scenario might be registering monitoring infrastructure only when deploying an application into a performance environment, or registering customized implementations of beans for customer A vs. customer B deployments. Perhaps one of the most common cases would be working against a standalone datasource in development vs looking up that same datasource from JNDI when in QA or production. Bean definition profiles represent a general-purpose way to satisfy use cases of this kind, and we&rsquo;ll explore the latter use case in the examples below.</p>
<h3>Get hands-on with a sample</h3><p>I&rsquo;ve developed a small sample to accompany this post, and you might like to take a moment now to check it out (if not, don&rsquo;t worry; you don&rsquo;t need the code to read along below). Just follow the instructions on the README at <a href="https://bit.ly/gIHN2D"><a href="https://github.com/cbeams/spring-3.1-profiles-xml">https://github.com/cbeams/spring-3.1-profiles-xml</a></a>. If you&rsquo;re not familiar with Git, the README has instructions for SVN access, too.</p>
<h3>Understanding the application</h3><p>First let&rsquo;s take a look at a JUnit test case that demonstrates how transferring money between two accounts should work in our banking application:</p><p><code>src/test/com/bank/config/xml/IntegrationTests.java</code></p>
<pre><code class="prettyprint java"><br />public class IntegrationTests {
	@Test
	public void transferTenDollars() throws InsufficientFundsException {

		ApplicationContext ctx = // instantiate the spring container

		TransferService transferService = ctx.getBean(TransferService.class);
		AccountRepository accountRepository = ctx.getBean(AccountRepository.class);

		assertThat(accountRepository.findById(&quot;A123&quot;).getBalance(), equalTo(100.00));
		assertThat(accountRepository.findById(&quot;C456&quot;).getBalance(), equalTo(0.00));

		transferService.transfer(10.00, &quot;A123&quot;, &quot;C456&quot;);

		assertThat(accountRepository.findById(&quot;A123&quot;).getBalance(), equalTo(90.00));
		assertThat(accountRepository.findById(&quot;C456&quot;).getBalance(), equalTo(10.00));
	}
}
</code></pre><p>We&rsquo;ll get to the details of creating the Spring container in a moment, but first notice that our goal is simple &ndash; transfer $10.00 from account &ldquo;A123&rdquo; to account &ldquo;C456&rdquo;. The unit test simply asserts the initial balances in the two accounts, performs the transfer, then asserts that the final balances reflect the change.</p>
<h3>A typical XML configuration</h3><p>The bean definition profiles feature is supported equally well in Spring XML as it is when using Spring <code>@Configuration</code> classes to configure the container, but in today&rsquo;s post we&rsquo;ll cover the XML approach as that&rsquo;s what most users are familiar with.</p><p>Forgetting about bean definition profiles for a moment, to configure this application in Spring XML one would traditionally do something like the snippet below. Let&rsquo;s assume we&rsquo;re early in the development process and that working against a standalone datasource is preferred. We&rsquo;ll use HSQLDB for convenience, but you may of course imagine the datasource of your choosing being configured.</p><p><code>src/main/com/bank/config/xml/transfer-service-config.xml</code></p>
<pre><code class="prettyprint xml"><br />&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
	xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
	xmlns:jdbc=&quot;http://www.springframework.org/schema/jdbc&quot;
	xsi:schemaLocation=&quot;...&quot;&gt;

	&lt;bean id=&quot;transferService&quot; class=&quot;com.bank.service.internal.DefaultTransferService&quot;&gt;
		&lt;constructor-arg ref=&quot;accountRepository&quot;/&gt;
		&lt;constructor-arg ref=&quot;feePolicy&quot;/&gt;
	&lt;/bean&gt;

	&lt;bean id=&quot;accountRepository&quot; class=&quot;com.bank.repository.internal.JdbcAccountRepository&quot;&gt;
		&lt;constructor-arg ref=&quot;dataSource&quot;/&gt;
	&lt;/bean&gt;

	&lt;bean id=&quot;feePolicy&quot; class=&quot;com.bank.service.internal.ZeroFeePolicy&quot;/&gt;

	&lt;jdbc:embedded-database id=&quot;dataSource&quot;&gt;
		&lt;jdbc:script location=&quot;classpath:com/bank/config/sql/schema.sql&quot;/&gt;
		&lt;jdbc:script location=&quot;classpath:com/bank/config/sql/test-data.sql&quot;/&gt;
	&lt;/jdbc:embedded-database&gt;
&lt;/beans&gt;
</code></pre><p>The only potentially unfamiliar item above might be the use of Spring&rsquo;s <code>jdbc:</code> namespace. Introduced in Spring 3.0, the elements within allow for easy configuration of commonly used embedded database types. It&rsquo;s used here just as a convenience.</p><p>With this configuration in mind, we can now finish writing the unit test we started above.</p><p><code>src/test/com/bank/config/xml/IntegrationTests.java</code></p>
<pre><code class="prettyprint java"><br />public class IntegrationTests {
	@Test
	public void transferTenDollars() throws InsufficientFundsException {

		GenericXmlApplicationContext ctx = new GenericXmlApplicationContext();
		ctx.load(&quot;classpath:/com/bank/config/xml/transfer-service-config.xml&quot;);
		ctx.refresh();

		TransferService transferService = ctx.getBean(TransferService.class);
		AccountRepository accountRepository = ctx.getBean(AccountRepository.class);

		// perform transfer and issue assertions as above ...
	}
}
</code></pre><p><em>Side note:</em> We&rsquo;re using Spring&rsquo;s <code>GenericXmlApplicationContext</code> application context in order to load the XML configuration. Many Spring users will be more familiar with <code>ClassPathXmlApplicationContext</code>, which would work equally as well. As a general rule, however, <code>GenericXmlApplicationContext</code> is a more flexible alternative that should be generally preferred.</p><p>When running this test, the bar will be green. Our simple application is wired up by the container and we retrieve some of the beans and excercise them &ndash; nothing special to see here, folks. It gets interesting when we consider how this application will be deployed into a QA or production environment. For example, it is a common scenario for enterprises using Spring to develop web applications against Tomcat for ease-of-use reasons, but then deploy those applications into WebSphere in production. Chances are very good that the datasource for the application will be registered with the production application server&rsquo;s JNDI directory. This means that in order to get hold of the datasource, we must perform a JNDI lookup. Of course Spring provides great support for doing so, and one popular way is through Spring&rsquo;s <code>&lt;jee:jndi-lookup/&gt;</code> element. The production version of the configuration file above might end up looking something like the following:</p><p><code>src/main/com/bank/config/xml/transfer-service-config.xml</code></p>
<pre><code class="prettyprint xml"><br />&lt;beans ...&gt;
	&lt;bean id=&quot;transferService&quot; ... /&gt;

	&lt;bean id=&quot;accountRepository&quot; class=&quot;com.bank.repository.internal.JdbcAccountRepository&quot;&gt;
		&lt;constructor-arg ref=&quot;dataSource&quot;/&gt;
	&lt;/bean&gt;

	&lt;bean id=&quot;feePolicy&quot; ... /&gt;

	&lt;jee:jndi-lookup id=&quot;dataSource&quot; jndi-name=&quot;java:comp/env/jdbc/datasource&quot;/&gt;
&lt;/beans&gt;
</code></pre><p>Of course this configuration works perfectly well. The problem is how to switch between using these two variations based on the current environment. Over time, Spring users have devised a number of ways to get this done, usually relying on a combination of system environment variables and XML <code>&lt;import/&gt;</code> statements containing <code>${placeholder}</code> tokens that resolve to the correct configuration file path depending on the value of an environment variable. While these and other solutions can be made to work, they&rsquo;re hardly what we would call &ldquo;first-class&rdquo; solutions provided by the container.</p>
<h3>Enter bean definition profiles</h3><p>If we generalize the example use case above of enviroment-specific bean definitions, we end up with the need to register certain bean definitions in certain contexts, while not in others. You could say that you want to register a certain <em>profile</em> of bean definitions in situation A, and a different profile in situation B.</p><p>In Spring 3.1, <code>&lt;beans/&gt;</code> XML documents now incorporate this new concept. We can break our configuration down into the following three files. Notice the <code>profile=&ldquo;&hellip;&rdquo;</code> attribute on the <code>*-datasource.xml</code> files:</p><p><code>src/main/com/bank/config/xml/transfer-service-config.xml</code></p>
<pre><code class="prettyprint xml"><br />&lt;beans ...&gt;
	&lt;bean id=&quot;transferService&quot; ... /&gt;

	&lt;bean id=&quot;accountRepository&quot; class=&quot;com.bank.repository.internal.JdbcAccountRepository&quot;&gt;
		&lt;constructor-arg ref=&quot;dataSource&quot;/&gt;
	&lt;/bean&gt;

	&lt;bean id=&quot;feePolicy&quot; ... /&gt;
&lt;/beans&gt;
</code></pre><p><code>src/main/com/bank/config/xml/standalone-datasource-config.xml</code></p>
<pre><code class="prettyprint xml"><br />&lt;beans profile=&quot;dev&quot;&gt;
	&lt;jdbc:embedded-database id=&quot;dataSource&quot;&gt;
		&lt;jdbc:script location=&quot;classpath:com/bank/config/sql/schema.sql&quot;/&gt;
		&lt;jdbc:script location=&quot;classpath:com/bank/config/sql/test-data.sql&quot;/&gt;
	&lt;/jdbc:embedded-database&gt;
&lt;/beans&gt;
</code></pre><p><code>src/main/com/bank/config/xml/jndi-datasource-config.xml</code></p>
<pre><code class="prettyprint xml"><br />&lt;beans profile=&quot;production&quot;&gt;
	&lt;jee:jndi-lookup id=&quot;dataSource&quot; jndi-name=&quot;java:comp/env/jdbc/datasource&quot;/&gt;
&lt;/beans&gt;
</code></pre><p>We can then update the test case to load all three files:</p>
<pre><code class="prettyprint java"><br />	GenericXmlApplicationContext ctx = new GenericXmlApplicationContext();
	ctx.load(&quot;classpath:/com/bank/config/xml/*-config.xml&quot;);
	ctx.refresh();
</code></pre><p>But this is not quite enough. When running the unit test after these changes, we would see a <code>NoSuchBeanDefinitionException</code> thrown, because the container could not find the Spring bean named &ldquo;dataSource&rdquo;. The reason why is that while we have clearly defined two bean definition profiles &ndash; &ldquo;dev&rdquo; and &ldquo;production&rdquo;, we have not yet <i>activated</i> either of them.</p>
<h3>Enter the Environment</h3><p>New in 3.1 is Spring&rsquo;s notion of an <em><code>Environment</code></em>. This abstraction has been integrated throughout the container, and we&rsquo;ll see it several times over the blog posts in the coming days. For our purposes here, it&rsquo;s important to understand that the <code>Environment</code> contains information about which profiles (if any) are currently active. When the Spring <code>ApplicationContext</code> above is loading our three bean definition files, it pays close attention to the <code>&lt;beans profile=&ldquo;&hellip;&rdquo;&gt;</code> attribute in each of them. If it is present and set to the name of a profile that is not currently active, the entire file is skipped &ndash; no bean definitions are parsed or registered.</p><p>Activating a profile can be done in several ways, but the most straightforward is to do it programmatically against the <code>ApplicationContext</code> API:</p>
<pre><code class="prettyprint java"><br />	GenericXmlApplicationContext ctx = new GenericXmlApplicationContext();
	ctx.getEnvironment().setActiveProfiles(&quot;dev&quot;);
	ctx.load(&quot;classpath:/com/bank/config/xml/*-config.xml&quot;);
	ctx.refresh();
</code></pre><p>At this point, running our unit test will result in the green bar. Let&rsquo;s break down how the container thinks about things when loading the three files that match <code>*-config.xml</code>:</p>
<ul>
<li><code>transfer-service-config.xml</code> does not specify a profile attribute at all, so it is always parsed</li>
<li><code>standalone-datasource-config.xml</code> specifies <code>profile="dev"</code> and the "dev" profile is currently active, so it is parsed</li>
<li><code>jndi-datasource-config.xml</code> specifies <code>profile="production"</code> but the "production" profile is not currently active, so it is skipped.</li>
</ul><p>The result is exactly one registered bean named &ldquo;dataSource&rdquo;, which satisfies the dependency injection needs of the &ldquo;accountRepository&rdquo; bean. Everything works once again.</p><p>How then does one switch to the JNDI lookup when actually in production? Of course it&rsquo;s necessary to activate the &ldquo;production&rdquo; profile. It&rsquo;s fine to do this programmatically for the purpose of a unit test as above, but this approach won&rsquo;t be practical once the WAR file has been created and the application is ready for deployment. For this reason, profiles may also be activated <i>declaratively</i> through the <em><code>spring.profiles.active</code></em> property which may be specified through system environment variables, JVM system properties, servlet context parameters in <code>web.xml</code> or even as an entry in JNDI [2]. For example, you might configure <code>web.xml</code> as follows:</p>
<pre><code class="prettyprint xml"><br />  &lt;servlet&gt;
      &lt;servlet-name&gt;dispatcher&lt;/servlet-name&gt;
      &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;
      &lt;init-param&gt;
          &lt;param-name&gt;spring.profiles.active&lt;/param-name&gt;
          &lt;param-value&gt;production&lt;/param-value&gt;
      &lt;/init-param&gt;
  &lt;/servlet&gt;
</code></pre><p>Note that profiles are not an &ldquo;either-or&rdquo; proposition; it is possible to activate multiple profiles at once. Programmatically, simply provide multiple profile names to the <code>setActiveProfiles(</code>) method, which accepts <code>String&hellip;</code> varargs:</p>
<pre><code class="prettyprint java"><br />	ctx.getEnvironment().setActiveProfiles(&quot;profile1&quot;, &quot;profile2&quot;);
</code></pre><p>Declaratively, <code>spring.profiles.active</code> may accept a comma-separated list of profile names:</p>
<pre><code class="prettyprint source">	-Dspring.profiles.active=&quot;profile1,profile2&quot;
</code></pre><p>Bean definition files may be marked as candidates for more than one profile in a similar fashion:</p>
<pre><code class="prettyprint xml"><br />	&lt;beans profile=&quot;profile1,profile2&quot;&gt;
		...
	&lt;/beans&gt;
</code></pre><p>This allows for a flexible approach to decomposing your application, slicing and dicing which beans are registered under which circumstances.</p>
<h3>Making it even simpler: introducing nested <code>&lt;beans/&gt;</code> elements</h3><p>So far, bean definition profiles have provided us with a convenient mechanism for determining which beans get registered based on the deployment context of the application, but it came with one downside: Where above we had a single Spring XML configuration file, we now have three. This split was necessary in order to distinguish <code>profile=&ldquo;dev&rdquo;</code> vs. <code>profile=&ldquo;production&rdquo;</code> beans, because the <code>profile</code> attribute is specified at the <code>&lt;beans&gt;</code> element level.</p><p>With Spring 3.1, it is now possible to nest <code>&lt;beans/&gt;</code> elements within the same file. This means that we can, if desired, return to a single configuration file:</p>
<pre><code class="prettyprint java"><br />&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
	xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
	xmlns:jdbc=&quot;http://www.springframework.org/schema/jdbc&quot;
	xmlns:jee=&quot;http://www.springframework.org/schema/jee&quot;
	xsi:schemaLocation=&quot;...&quot;&gt;

	&lt;bean id=&quot;transferService&quot; class=&quot;com.bank.service.internal.DefaultTransferService&quot;&gt;
		&lt;constructor-arg ref=&quot;accountRepository&quot;/&gt;
		&lt;constructor-arg ref=&quot;feePolicy&quot;/&gt;
	&lt;/bean&gt;

	&lt;bean id=&quot;accountRepository&quot; class=&quot;com.bank.repository.internal.JdbcAccountRepository&quot;&gt;
		&lt;constructor-arg ref=&quot;dataSource&quot;/&gt;
	&lt;/bean&gt;

	&lt;bean id=&quot;feePolicy&quot; class=&quot;com.bank.service.internal.ZeroFeePolicy&quot;/&gt;

	&lt;beans profile=&quot;dev&quot;&gt;
		&lt;jdbc:embedded-database id=&quot;dataSource&quot;&gt;
			&lt;jdbc:script location=&quot;classpath:com/bank/config/sql/schema.sql&quot;/&gt;
			&lt;jdbc:script location=&quot;classpath:com/bank/config/sql/test-data.sql&quot;/&gt;
		&lt;/jdbc:embedded-database&gt;
	&lt;/beans&gt;

	&lt;beans profile=&quot;production&quot;&gt;
		&lt;jee:jndi-lookup id=&quot;dataSource&quot; jndi-name=&quot;java:comp/env/jdbc/datasource&quot;/&gt;
	&lt;/beans&gt;
&lt;/beans&gt;
</code></pre><p><code>spring-beans-3.1.xsd</code> has been updated to allow this nesting, but constrained to allow such elements only as the last ones in the file. This should help provide flexibility without incurring clutter in the XML files. While this enhancement was developed in service of bean definition profiles, nested <code>&lt;beans/&gt;</code> elements are useful in general. Imagine you have a subset of beans in a given file that should be marked <code>lazy-init=&ldquo;true&rdquo;</code>. Rather than marking each bean, you could instead declare a nested <code>&lt;beans default-lazy-init=&ldquo;true&rdquo;/&gt;</code> element, and all beans within will inherit that default. Beans defined elsewhere in the file will maintain the normal default of <code>lazy-init=&ldquo;false&rdquo;</code>. This applies for all the <code>default-*</code> attributes of the <code>&lt;beans/&gt;</code> element, such as <code>default-lazy-init</code>, <code>default-init-method</code>, <code>default-destroy-method</code>, and so on.</p>
<h3>Caveats</h3><p>There are a few things to watch out for when considering the use of bean definition profiles.</p><p><strong>Do not use profiles if a simpler approach can get the job done.</strong> If the only thing changing between profiles is the value of properties, Spring&rsquo;s existing <code>PropertyPlaceholderConfigurer</code> / <code>&lt;context:property-placeholder/&gt;</code> may be all you need.</p><p><strong>The set of beans registered between two profiles should probably be more similar than different.</strong> For example, if you have a radically different set of beans in dev and QA than you do in production, the question becomes: <em>are you testing everything you should be?</em>. As a rule of thumb, beans shouldn&rsquo;t differ much beyond the dev/QA split. An exception might be conditionally introducing monitoring aspects in a performance environment.</p><p><strong>Be careful not to ship &ldquo;too much&rdquo; into production.</strong> If you have certain beans and class libraries present during development but that are unnecessary or unwanted in production, you run the risk of packaging all of that up and deploying it live. This is wasteful (why drag everything into the WAR if it&rsquo;s not needed), but also potentially insecure. Remember that the way profiles are activated is through properties. For example, if your totally insecure &lsquo;no-op password encryptor&rsquo; bean definition and class are both present in the production environment, and all it takes to turn this on is the acccidental activation of the &lsquo;dev&rsquo; profile, the danger is clear. A couple options for mitigating this risk might be customizing your build system to exclude unnecessary or unwanted classes from the production deployment archives, or working with the native Java <code>SecurityManager</code> API to disallow access to the <code>spring.profiles.active</code> system environment variable and/or JVM system property. Doing so will mean that even though Spring may try to read these values, it won&rsquo;t be able to and will move on as if they&rsquo;d never been set.</p>
<h3>Summary</h3><p>That&rsquo;s it for now; I encourage you to take a look at the sample application and play around. For example, try running the unit tests as-is, then try setting the <code>spring.profiles.active</code> system property to &ldquo;production&rdquo; and see what happens.</p><p>In the next post in this series, we&rsquo;ll take a look at how bean definition profiles can be used when configuring the container with <code>@Configuration</code> classes instead of XML; the new <code>@Profile</code> annotation will help us out there.</p>
<h3>Footnotes</h3><p>[1] Milestone builds are published to <a href="http://maven.springframework.org/milestone">http://maven.springframework.org/milestone</a>. See the <a href="https://bit.ly/hnVADP">pom.xml</a> and <a href="https://bit.ly/ideYr9">build.gradle</a> files in the sample for details on how to pull from this repository.</p><p>[2] technically <code>spring.profiles.active</code> may be specified in any <code>PropertySource</code> object registered with the <code>ApplicationContext</code>&rsquo;s <code>Environment</code>. We&rsquo;ll cover the concept of property sources in a subsequent blog post.</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 390;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>