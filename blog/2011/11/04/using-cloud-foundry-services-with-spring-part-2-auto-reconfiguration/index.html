<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Using Cloud Foundry Services with Spring: Part 2 - Auto-reconfiguration</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Using Cloud Foundry Services with Spring: Part 2 - Auto-reconfiguration" />
<meta name="twitter:description" content="&lt;p&gt;If you watched the video for the &lt;a href=&quot;http://www.youtube.com/watch?v=o2iXuUkVJ9Q&quot;&gt;Cloud Foundry launch event&lt;/a&gt;, you saw that we deployed the Spring Travel application downloaded from Spring Web Flow samples, bound a MySQL service to it, and dragged and dropped the application to the Cloud Foundry server in STS, &lt;b&gt;without making a single line of change&lt;/b&gt; in the application itself. How’s that possible since the application is configured to use a local database? That’s when auto-reconfiguration comes into play.&lt;/p&gt;
&lt;p&gt;Cloud Foundry strives to keep your initial investment low. Beyond dollars and cents, a real investment comes from the time that a developer spends in getting started. Auto-reconfiguration is one mechanism that reduces initial investment when you want to get started with Cloud Foundry. In this blog, we explore how it works with Spring applications (grails applications use the same underlying mechanism and thus behave identically). &lt;/p&gt;
" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/8fa7e069d3807412499606915fddc108?s=200" />

<meta property="og:title" content="Using Cloud Foundry Services with Spring: Part 2 - Auto-reconfiguration" />
<meta property="og:image" content="https://gravatar.com/avatar/8fa7e069d3807412499606915fddc108?s=200" />
<meta property="og:description" content="&lt;p&gt;If you watched the video for the &lt;a href=&quot;http://www.youtube.com/watch?v=o2iXuUkVJ9Q&quot;&gt;Cloud Foundry launch event&lt;/a&gt;, you saw that we deployed the Spring Travel application downloaded from Spring Web Flow samples, bound a MySQL service to it, and dragged and dropped the application to the Cloud Foundry server in STS, &lt;b&gt;without making a single line of change&lt;/b&gt; in the application itself. How’s that possible since the application is configured to use a local database? That’s when auto-reconfiguration comes into play.&lt;/p&gt;
&lt;p&gt;Cloud Foundry strives to keep your initial investment low. Beyond dollars and cents, a real investment comes from the time that a developer spends in getting started. Auto-reconfiguration is one mechanism that reduces initial investment when you want to get started with Cloud Foundry. In this blog, we explore how it works with Spring applications (grails applications use the same underlying mechanism and thus behave identically). &lt;/p&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2011-11-04 17:33:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Using Cloud Foundry Services with Spring: Part 2 - Auto-reconfiguration</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/8fa7e069d3807412499606915fddc108?s=20&amp;d=mm" />
<span class="author">Ramnivas Laddad</span>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2011-11-04 17:33:00.0">November 04, 2011</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="446" href="/blog/2011/11/04/using-cloud-foundry-services-with-spring-part-2-auto-reconfiguration#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><p>If you watched the video for the <a href="https://www.youtube.com/watch?v=o2iXuUkVJ9Q">Cloud Foundry launch event</a>, you saw that we deployed the Spring Travel application downloaded from Spring Web Flow samples, bound a MySQL service to it, and dragged and dropped the application to the Cloud Foundry server in STS, <b>without making a single line of change</b> in the application itself. How’s that possible since the application is configured to use a local database? That’s when auto-reconfiguration comes into play.</p><p>Cloud Foundry strives to keep your initial investment low. Beyond dollars and cents, a real investment comes from the time that a developer spends in getting started. Auto-reconfiguration is one mechanism that reduces initial investment when you want to get started with Cloud Foundry. In this blog, we explore how it works with Spring applications (grails applications use the same underlying mechanism and thus behave identically). </p>
<h2>Leveraging dependency injection for auto-reconfiguration</h2><p>Your application consists of business logic and interaction with services such as database and messaging. In a typical Spring application, you take advantage of dependency injection (DI) to create beans for each service used and inject those beans into other beans that need access to those services. </p><p>Let&rsquo;s look at a typical Spring application that uses a relational database that will have a datasource bean defined as:</p>
<pre><code class="prettyprint xml"><br />&lt;bean class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; id=&quot;dataSource&quot;&gt;
    &lt;property name=&quot;driverClassName&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;
    &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/inventory-db&quot;/&gt;
    &lt;property name=&quot;username&quot; value=&quot;myuser&quot;/&gt;
    &lt;property name=&quot;password&quot; value=&quot;mypass&quot;/&gt;
&lt;/bean&gt;
</code></pre><p>We could externalize properties such as username and password into a separate file, but we embed values to focus on the auto-reconfiguration mechanism.</p><p>This bean may then be injected into other beans (in this case, into a JPA entity manager):</p>
<pre><code class="prettyprint xml"><br />&lt;bean class=&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot; id=&quot;entityManagerFactory&quot;&gt;
    &lt;property name=&quot;persistenceUnitName&quot; value=&quot;persistenceUnit&quot;/&gt;
    &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;
&lt;/bean&gt;
</code></pre><p>We can make one easy observation: The database URL points to a database on localhost, username is set to &ldquo;myuser&rdquo;, and password is set to &ldquo;mypass&rdquo;. When you push this application to Cloud Foundry and bind a MySQL or Postgres service, the URL for that service is not going to be <code>jdbc:<a href="mysql://localhost:3306/inventory-db">mysql://localhost:3306/inventory-db</a></code> and the username or password aren&rsquo;t going to be that easy! So without an additional mechanism, such an application will fail on startup. This is where the auto-reconfiguration mechanism comes into play. The auto-reconfiguration mechanism leverages DI to examine Spring application context, look for beans that correspond to services, and replace each of those services with beans created based on service bound to the application. The result is the user application works in local deployment and in Cloud Foundry without any change.</p><p>The following table shows what bean types auto-reconfiguration looks for reconfiguration.</p>
<table margin="1em" border="1">
<tbody>
<tr><th>Service Type</th><th>Replaced bean type</th></tr>
<tr><td>Mysql, Postgres</td><td><code>javax.sql.DataSource</code></td></tr>
<tr><td>Redis</td><td><code>org.springframework.data.redis.connection.RedisConnectionFactory</code></td></tr>
<tr><td>MongoDB</td><td><code>org.springframework.data.document.mongodb.MongoDbFactory</code></td></tr>
<tr><td>RabbitMQ</td><td><code>org.springframework.amqp.rabbit.connection.ConnectionFactory</code></td></tr>
<tbody>
</table><p>The underlying mechanism behind auto-reconfiguration uses a <code>BeanFactoryPostProcessor</code> that examines the application context before creating beans and swaps existing beans of matching types with equivalent beans based on services bound to the application. For relational databases, it also reconfigures the JPA entity manager factory or Hibernate session factory to adjust the dialect being used.</p><p>When your application is staged during the deployment process, Cloud Foundry will make two modifications:<br /><ol><br /><li>It will add an additional jar to your application that contains the <code>BeanFactoryPostProcessor</code> and attendant resources. Note that the jar used for auto-reconfiguration also comes with a version of the cloudfoundry-runtime. However, those classes are relocated to a different package through a shading mechanism. This allows your application to use a different version of the cloudfoundry-runtime without any conflict.</li><br /><li>It will modify web.xml to update files that constitute Spring&rsquo;s application context to add the <code>BeanFactoryPostProcessor</code> to it.</li><br /></ol></p>
<h2>Limitations</h2><p>Auto-reconfiguration of services work only under the following conditions:<br /><ol><br /><li>There may exactly be only one service of a given service type. For example, you may bind only one relational database service (MySQL or Postgres) to an application.</li><br /><li>There may exactly be only one bean of the matching type. For example, you may have only one <code>DataSource</code> bean in the application context.</li><br /></ol></p><p>If an application doesn&rsquo;t follow these limitations, the auto-reconfiguration mechanism will not take place. In those cases, you will need to use the <code>&lt;cloud&gt;</code> namespace described in the next blog with or without the Spring 3.1 profile support.</p><p>The auto-reconfiguration mechanism expects typical Spring applications. If your application context is complex, it may not work. In those cases, you can opt out of auto-reconfiguration as we will describe next.</p>
<h2>Opting out of auto-reconfiguration</h2><p>There may be situations where you would like to opt out of auto-reconfiguration. For example, you may have an in-memory relational database that should not be bound to a Cloud Foundry service. Cloud Foundry offers a few ways to opt out of auto-reconfiguration mechanism.<br /><ol><br /><li>Choose framework as &ldquo;JavaWeb&rdquo; when deploying the application. This will treat your application as if it isn&rsquo;t a Spring application. This is a hard opt out in that your application will remain unchanged (no jars will be added to your application and web.xml will remain unchanged). This also means that the profile feature discussed later in this blog series will not be available to such applications.</li><br /><li>Use any <code>&lt;cloud&gt;</code> element that creates a bean representing a service. This currently includes <code>&lt;cloud:data-source&gt;</code>, <code>&lt;cloud:mongo-db-factory&gt;</code>, <code>&lt;cloud:rabbit-connection-factory&gt;</code>, <code>&lt;cloud:redis-connection-factory&gt;</code>, and <code>&lt;cloud:service-scan&gt;</code>. If the application directly includes a bean based on the underlying type for these namespace elements (such as <code>CloudMongoDbFactoryBean</code>), opt-out will be in effect. Cloud Foundry uses this mechanism to opt out, since applications either want to have the auto-reconfiguration behavior or simply take control over service creating completely. We do not see the value in auto-reconfiguring some services and manually doing for others.</li><br /></ol></p>
<h2>Conclusion</h2><p>Auto-reconfiguration facility in Cloud Foundry is a wonderful way to get started. As your application matures or you need to bind to multiple services, you may need finer control over service connection objects. This is where the <code>&lt;cloud&gt;</code> namespace support comes into the picture. In the next blog in this series, Thomas Risberg will explain how to use it. Take it away Thomas.</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 446;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>