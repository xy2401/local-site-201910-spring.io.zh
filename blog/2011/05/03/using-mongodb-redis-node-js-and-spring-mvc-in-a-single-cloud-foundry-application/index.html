<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Using MongoDB, Redis, Node.js, and Spring MVC in a single Cloud Foundry Application</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Using MongoDB, Redis, Node.js, and Spring MVC in a single Cloud Foundry Application" />
<meta name="twitter:description" content="&lt;p&gt;Traditionally, applications have been defined by the principle technology they use. If you’re building a Spring MVC application, we call it a “Java app”. Since our application is primarily composed of Java components, we tend to stay in our own yards and not be terribly friendly with our neighbors until we’re forced to interact with them. We set up Java-based application servers and tend to think first of going to the Java language to solve a problem in our application whether that language is the best choice or not. It has usually just been too difficult to maintain multiple sets of runtime environments for our applications, so we stovepipe ourselves through sheer inertia.&lt;/p&gt;
" />
<meta name="twitter:creator" content="@j_brisbin" />
<meta name="twitter:image:src" content="http://gravatar.com/avatar/5500b5cf634f9a3921e4619778a1425f?s=200" />

<meta property="og:title" content="Using MongoDB, Redis, Node.js, and Spring MVC in a single Cloud Foundry Application" />
<meta property="og:image" content="http://gravatar.com/avatar/5500b5cf634f9a3921e4619778a1425f?s=200" />
<meta property="og:description" content="&lt;p&gt;Traditionally, applications have been defined by the principle technology they use. If you’re building a Spring MVC application, we call it a “Java app”. Since our application is primarily composed of Java components, we tend to stay in our own yards and not be terribly friendly with our neighbors until we’re forced to interact with them. We set up Java-based application servers and tend to think first of going to the Java language to solve a problem in our application whether that language is the best choice or not. It has usually just been too difficult to maintain multiple sets of runtime environments for our applications, so we stovepipe ourselves through sheer inertia.&lt;/p&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2011-05-03 21:39:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Using MongoDB, Redis, Node.js, and Spring MVC in a single Cloud Foundry Application</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/5500b5cf634f9a3921e4619778a1425f?s=20&amp;d=mm" />
<span class="author">Jon Brisbin</span>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2011-05-03 21:39:00.0">May 03, 2011</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="415" href="/blog/2011/05/03/using-mongodb-redis-node-js-and-spring-mvc-in-a-single-cloud-foundry-application#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><p>Traditionally, applications have been defined by the principle technology they use. If you&rsquo;re building a Spring MVC application, we call it a &ldquo;Java app&rdquo;. Since our application is primarily composed of Java components, we tend to stay in our own yards and not be terribly friendly with our neighbors until we&rsquo;re forced to interact with them. We set up Java-based application servers and tend to think first of going to the Java language to solve a problem in our application whether that language is the best choice or not. It has usually just been too difficult to maintain multiple sets of runtime environments for our applications, so we stovepipe ourselves through sheer inertia.</p><p><a href="http://cloudfoundry.com/">Cloud Foundry</a> turns that dynamic on its head because it is no longer inconvenient to use the right tool for the job. We simply are not forced to stovepipe our applications into one species any more (a &ldquo;Java app&rdquo; or a &ldquo;Node app&rdquo;). If we need really high volume, non-blocking throughput with XHR long-polling support, we can use <a href="https://nodejs.org/" title="Node.js Home">Node.js</a> for that portion of our application. If we need the flexibility and depth of library support found in the Spring family of projects, we can easily take advantage of them by using Java for that portion of the application. If we need both a fast key-value store for a cache or event bus and a capable document store for persisting data, we can use both in the same application without worrying about the logistics involved in setting these services up separately and managing them ourselves (or dumping them onto <a href="https://www.youtube.com/watch?v=d0KIF7i5yIM">our already-harried Operations staff</a>). </p><p>It also doesn&rsquo;t hurt our case any that deploying either species of application is as simple as issuing a &ldquo;push&rdquo; command from our favorite shell.</p>
<h3>Polyglot Programming ^ N</h3><p>What&rsquo;s that <a href="https://www.goodreads.com/quotes/show/37300">old saying</a>? &ldquo;If it&rsquo;s worth doing, it&rsquo;s worth overdoing&rdquo;? This example application is a poster child for that sentiment!</p><p>There are several components to <a href="http://ticker-analysis.cloudfoundry.com">this application</a>:</p>
<ol>
<li>A recurring event to generate random ticker data and emit it into an event bus.</li>
<li>A Node.js application to power a web front-end that uses <a href="http://socket.io/" title="Socket.IO Home">Socket.IO</a> for long-polling Ajax goodness.</li>
<li>A Spring MVC application to read individual data points from the event bus and summarize these into a document stored in MongoDB.</li>
</ol><p>Numbers 1 and 2 are handled in the same application: namely the Node.js app that powers the web front-end. Number 3 is a standard Spring MVC application that uses <a href="http://www.springsource.org/spring-data" title="Spring Data Home">the NoSQL support of the Spring Data family of projects</a> to connect to Redis and MongoDB in a single helper class.</p>
<h3>Node.js</h3><p>We&rsquo;re using Node.js because: a) it&rsquo;s lightweight, fast, and non-blocking, and: b) it&rsquo;s the zippered hoodie of the web world (it&rsquo;s what all the cool kids are wearing these days).</p><p>In all seriousness, Node.js is an excellent choice in which to deploy a web front-end. We&rsquo;re using it to asynchronously send ticker events to the browser using Socket.IO, to the database using the Mongoose MongoDB library, and over our application&rsquo;s event bus (in this case, Redis) to be consumed by code running in another application.</p><p>There&rsquo;s a lot here, so we&rsquo;ll take each part in chunks.</p>
<h3>Configuration</h3><p>Before we get too deep into the application, we need to discuss how to get configuration information from the Cloud Foundry environment. The hostname, port, user, and password you need to connect to your provisioned services is encoded into a JSON document stored in an environment variable named &ldquo;VCAP_SERVICES&rdquo;. There are various helper utilities springing up to aid the developer in using these configuration values (or defaults when running your app locally). The Node.js module we&rsquo;ll be using here will not necessarily reflect the official Node.js Cloud Foundry runtime module that is being worked on as we write this.</p>
<h5>Connecting to MongoDB</h5><p>To get the configuration information you need to connect to your MongoDB instance when running in Cloud Foundry, require the &ldquo;cloudfoundry&rdquo; module like so:</p>
<pre><code class="prettyprint javascript"><br />var cf       = require(&quot;cloudfoundry&quot;);
var mongoConfig = cf.getServiceConfig(&quot;ticker-analysis&quot;)
		|| { username: &quot;admin&quot;, password: &quot;password&quot;, hostname: &quot;localhost&quot;, port: 27017, db: &quot;tickeranalysis&quot; };
</code></pre><p>This either pulls our configuration information from the VCAP_SERVICES environment variable or provides a set of defaults for use when running locally.</p>
<h5>Set up mapping for Javascript entities</h5><p>We&rsquo;re using the Mongoose MongoDB mapping library for connecting to our database. We save our individual ticker events as well as read those saved by the Spring MVC application. The nice thing about using a document store to persist our data is that it gives us full cross-language support. We can save an object using the Spring Data mapping infrastructure and later read that object into our Node.js application using Mongoose.</p><p>To configure the Mongoose library, we need to define our models:</p>
<pre><code class="prettyprint javascript"><br />var mongoose = require(&quot;mongoose&quot;),
    Schema   = mongoose.Schema,
    ObjectId = Schema.ObjectId,
    DocumentObjectId = mongoose.Types.ObjectId;

var TickerEvent = new Schema({
	symbol: { type: String },
	 price: { type: Number },
	volume: { type: Number }
});
mongoose.model(&#39;TickerEvent&#39;, TickerEvent);
var TickerSummary = new Schema({
	      _id: { type: String },
	timestamp: { type: Number },
	      max: { type: Number },
	      min: { type: Number },
	  average: { type: Number },
	   volume: { type: Number }
});
mongoose.model(&#39;TickerSummary&#39;, TickerSummary);
</code></pre><p>The corresponding domain object on the Java side looks like this:</p>
<pre><code class="prettyprint java"><br />@Document(collection = &quot;tickersummary&quot;)
public class Summary {

	@Id
	private final String symbol;
	private final Long timestamp;
	private Float total = new Float(0);
	private Integer samples = 0;
	private Float min = Float.MAX_VALUE;
	private Float average = new Float(0);
	private Float max = Float.MIN_VALUE;
	private Integer volume = 0;

  // Constructors, getters, and setters...
}
</code></pre>
<h5>Express.js</h5><p>To power the web front-end, we&rsquo;ll be using the <a href="https://expressjs.com/" title="Express.js Home">express.js web framework</a> for Node.js. Of note in this block is our use of a special method on the Cloud Foundry Node.js module to tell us whether we&rsquo;re running in the cloud or not. If we are, then we don&rsquo;t want to dump our exceptions to the browser like we do when we&rsquo;re running in development.</p>
<pre><code class="prettyprint javascript"><br />var express  = require(&quot;express&quot;);
var app      = express.createServer();
app.configure(function() {
  
  // Standard express setup
	app.use(express.methodOverride());
	app.use(express.bodyParser());
	app.use(app.router);	
	app.use(express.static(__dirname + &#39;/public&#39;));
	
	// Use the Jade template engine
	app.set(&#39;view engine&#39;, &#39;jade&#39;);
	app.set(&#39;running in cloud&#39;, cf.isRunningInCloud());
	
  // Don&#39;t give away information about our environment in production
	if(!cf.isRunningInCloud()) {
		app.use(express.errorHandler({ dumpExceptions: true, showStack: true }));
	}
	
});
</code></pre>
<h5>Socket.IO</h5><p>We&rsquo;re using Socket.IO for Ajax long-polling to pipe our server-side events to a listening browser. Since Cloud Foundry is only in beta, it doesn&rsquo;t yet support full-blown websockets (it&rsquo;s on the roadmap). To set this up, we&rsquo;re going to specify that Socket.IO use long polling since we already know the dynamic routing infrastructure won&rsquo;t be happy with us otherwise. We also have to reset this connection after 10 seconds to keep the timeout police from confiscating our connections. As the Cloud Foundry platform evolves, this will likely be a moot point. But for the time being, just keep these caveats in mind if using Ajax push with Cloud Foundry.</p>
<pre><code class="prettyprint javascript"><br />var io = require(&quot;socket.io&quot;).listen(app, {
	transports: [&#39;xhr-polling&#39;], 
	transportOptions: {
		&#39;xhr-polling&#39;: {duration: 10000} 
	} 
});
</code></pre>
<h3>The Event Emitter</h3><p>To generate the actual data points, we could have chosen to subscribe to any of the publicly-available stock ticker feeds. Since it doesn&rsquo;t actually matter in this case how the data is constituted and we get a better chance to illustrate cross-runtime integration at a deeper level by doing so, we&rsquo;re going to randomly generate our ticker data. </p><p>To publish these events to another listening application, we need to use Redis&rsquo; pub/sub functionality as an event bus. To do that in Node.js, we set up two separate Redis client instances. One will be used for listening for events to send to the browser and the other will be the outbound publisher client.</p>
<pre><code class="prettyprint javascript"><br />// Get our Cloud Foundry config information or default to localhost
var redisConfig = cf.getServiceConfig(&quot;ticker-stream&quot;)
		|| { hostname: &quot;localhost&quot;, port: 6379, password: false };

// Create Redis client instances
var redisClient = redis.createClient(redisConfig.port, redisConfig.hostname);
var redisPublisher = redis.createClient(redisConfig.port, redisConfig.hostname);
if(redisConfig.password) {
  // Cloud Foundry Redis instances are secured with a password
	redisClient.auth(redisConfig.password);
	redisPublisher.auth(redisConfig.password);
}

redisClient.subscribe(&quot;ticker-stream&quot;);
redisClient.on(&quot;message&quot;, function(channel, json) {
	var data = JSON.parse(json);
	
	// Save this event to the database
	var TickerEvent = db.model(&#39;TickerEvent&#39;, &#39;tickerdata&#39;);
	var te = new TickerEvent({
		symbol: data.symbol,
		price: data.price,
		volume: data.volume
	});
	te.save(function(err) {
		if(err) {
			throw(err);
		}
	});
	
	// Broadcast this event to the browser
	io.broadcast(json);
	
});
</code></pre><p>To send the data, we have a helper method that we call setTimeout on and pass a random wait time of 3-7 seconds.</p>
<pre><code class="prettyprint javascript"><br />var tickerSender;
function sendTickerEvent() {
	var symbolInfo = {
		symbol: getRandomSymbol(), 
		price: getRandomPrice(),
		volume: getRandomVolume()
	};
	redisPublisher.publish(&quot;ticker-stream&quot;, JSON.stringify(symbolInfo));

	// Call ourselves again after 3-7 seconds
	tickerSender = setTimeout(sendTickerEvent, getRandomTimeout());
}
</code></pre>
<h5>Express.js Routes</h5><p>Our routes for the web application are pretty sparse. We need to render the home page with the Javascript magic in it to power the UI and provide a route for getting the summary document from MongoDB to display on the right-hand side of the page when the user clicks on a ticker symbol link.</p>
<pre><code class="prettyprint javascript"><br />app.get(&quot;/&quot;, function(req, resp) {
	resp.render(&quot;home&quot;, {
		pageTitle: &quot;Ticker Analysis Sample&quot;
	});
});

app.get(&quot;/summary/:symbol&quot;, function(req, resp) {
	var TickerSummary = db.model(&quot;TickerSummary&quot;, &quot;tickersummary&quot;);
	TickerSummary.findById(req.params.symbol, function(err, data) {
		if(err) {
			// Handle error
		}
		resp.send(JSON.stringify(data));
	});
});
</code></pre><p>To initialize our data generation, we need to make sure our random event emitter is running. But since we don&rsquo;t want our database to fill up when no one&rsquo;s looking at the page, we&rsquo;ll just start the event emitter the first time a user hits our application. After that, we&rsquo;ll just leave it running until the timeout &ldquo;tickerSender&rdquo; is cleared (you can add a route to do that, if you want).</p>
<pre><code class="prettyprint javascript"><br />// Socket.IO-based Ticker Stream
io.on(&quot;connection&quot;, function(client) {
	if(!tickerSender) {
	  // Start the ticker stream if one hasn&#39;t been already
		sendTickerEvent();
	}
});
</code></pre>
<h5>Getting the application port number</h5><p>To tell Express.js what port our application should run on, we need to read the environment variable VCAP_APP_PORT. There&rsquo;s another method on our Cloud Foundry Node.js module to do that for us. So our call to listen() looks like this:</p>
<pre><code class="prettyprint javascript"><br />app.listen(cf.getAppPort());
</code></pre>
<h3>Spring MVC</h3><p>We <em>could</em> keep this in the family and handle the summary calculations in Node.js. But sometimes there&rsquo;s very good business reasons for using a Java/Spring component for a portion of your application. Our purpose here is to illustrate how this can be done so you can choose the right tool for the job.</p>
<h5>Spring Configuration</h5><p>You&rsquo;ll remember when we were dealing with the Node.js portion that we had to get configuration parameters from our environment when running in Cloud Foundry. Our Spring application has the same need. But since there&rsquo;s already a capable Cloud Foundry runtime library for Java, we&rsquo;ll use that to extract the bits we need to connect to our provisioned MongoDB instance.</p><p>The first thing we need to do is declare a couple additional namespaces. One for the Cloud Foundry runtime, and one for the MongoDB support.</p>
<pre><code class="prettyprint xml"><br />&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
			 xmlns:cloud=&quot;http://schema.cloudfoundry.org/spring&quot;
			 xmlns:mongo=&quot;http://www.springframework.org/schema/data/mongo&quot;
			 xmlns:p=&quot;http://www.springframework.org/schema/p&quot;
			 xmlns:util=&quot;http://www.springframework.org/schema/util&quot;
			 xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
			 xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
			 http://schema.cloudfoundry.org/spring http://schema.cloudfoundry.org/spring/cloudfoundry-spring-0.6.xsd
			 http://www.springframework.org/schema/data/mongo http://www.springframework.org/schema/data/mongo/spring-mongo-1.0.xsd
			 http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.0.xsd&quot;&gt;
</code></pre><p>In particular, note that we&rsquo;re going to be using Spring 3.1, which is still in pre-release status. You don&rsquo;t have to use Spring 3.1 to use Cloud Foundry. But the &lt;a href=&ldquo;<a href="http://blog.springsource.com/2011/02/14/spring-3-1-m1-introducing-profile/">http://blog.springsource.com/2011/02/14/spring-3-1-m1-introducing-profile/</a>&rdquo; &ldquo;Blog post about profiles&rdquo;&gt;profiles feature of Spring 3.1</a> will make our configuration easier. </p><p>To configure our MongoDB connection, we&rsquo;ll use the &lt;mongo:mongo/&gt; namespace configuration helper when running locally, and it&rsquo;s cousin, the &lt;cloud:mongo/&gt; namespace configuration helper when running in the cloud. In our &ldquo;default&rdquo; profile, we&rsquo;ll set up some properties to mimic those we&rsquo;ll have available when running in the cloud&ndash;we&rsquo;ll just set them to our local MongoDB server.</p>
<pre><code class="prettyprint xml"><br />&lt;!-- Use this when running locally --&gt;
&lt;beans profile=&quot;default&quot;&gt;
	&lt;util:properties id=&quot;serviceProperties&quot;&gt;
		&lt;prop key=&quot;ticker-analysis.db&quot;&gt;tickeranalysis&lt;/prop&gt;
		&lt;prop key=&quot;ticker-analysis.username&quot;&gt;admin&lt;/prop&gt;
		&lt;prop key=&quot;ticker-analysis.password&quot;&gt;passwd&lt;/prop&gt;
	&lt;/util:properties&gt;
	&lt;mongo:mongo id=&quot;mongo&quot;/&gt;
	&lt;bean id=&quot;redisConnectionFactory&quot;
				class=&quot;org.springframework.data.keyvalue.redis.connection.jedis.JedisConnectionFactory&quot;/&gt;
&lt;/beans&gt;

&lt;!-- Use this when running in the cloud --&gt;
&lt;beans profile=&quot;cloud&quot;&gt;
	&lt;cloud:service-properties id=&quot;serviceProperties&quot;/&gt;
	&lt;cloud:mongo id=&quot;mongo&quot;/&gt;
	&lt;cloud:redis-connection-factory id=&quot;redisConnectionFactory&quot;/&gt;
&lt;/beans&gt;

&lt;!-- MongoDB --&gt;
&lt;mongo:mapping-converter id=&quot;mappingConverter&quot;/&gt;
&lt;bean id=&quot;mongoTemplate&quot; class=&quot;org.springframework.data.document.mongodb.MongoTemplate&quot;
			p:username=&quot;#{serviceProperties[&#39;ticker-analysis.username&#39;]}&quot;
			p:password=&quot;#{serviceProperties[&#39;ticker-analysis.password&#39;]}&quot;&gt;
	&lt;constructor-arg ref=&quot;mongo&quot;/&gt;
	&lt;constructor-arg name=&quot;databaseName&quot; value=&quot;#{serviceProperties[&#39;ticker-analysis.db&#39;]}&quot;/&gt;
	&lt;constructor-arg name=&quot;defaultCollectionName&quot; value=&quot;tickerdata&quot;/&gt;
	&lt;constructor-arg ref=&quot;mappingConverter&quot;/&gt;
&lt;/bean&gt;
</code></pre><p>The properties for our provisioned services, as you will notice, follow the convention SERVICE_NAME.PROPERTY_NAME. In this example, I have a MongoDB service provisioned with the name &ldquo;ticker-analysis&rdquo;:</p>
<pre><code class="prettyprint code">&gt; vmc services

============== System Services ==============
... [omitted for brevity]

=========== Provisioned Services ============

+-----------------+---------+
| Name            | Service |
+-----------------+---------+
| ticker-stream   | redis   |
| ticker-analysis | mongodb |
+-----------------+---------+
</code></pre><p>As you might be able to guess now, my Redis connection follows a similar pattern.</p>
<h5>Selecting the profile to use</h5><p>Astute readers will immediately wonder: &ldquo;but how does it know which profile to use?&rdquo; In our case, we&rsquo;ll be using an ApplicationContextInitializer that sets our profile based on whether or not the proper environment variables are available.</p><p>Here&rsquo;s all we need to set our profile at runtime so we can run with the &ldquo;default&rdquo; profile during development and the &ldquo;cloud&rdquo; profile when running in Cloud Foundry:</p>
<pre><code class="prettyprint java"><br />public class CloudApplicationContextInitializer implements ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; {

	@Override
	public void initialize(ConfigurableApplicationContext applicationContext) {
		CloudEnvironment env = new CloudEnvironment();
		if (env.getInstanceInfo() != null) {
			// We&#39;re running in the cloud, set the profile accordingly
			applicationContext.getEnvironment().setActiveProfiles(&quot;cloud&quot;);
		}
		else {
			applicationContext.getEnvironment().setActiveProfiles(&quot;default&quot;);
		}
	}

}
</code></pre><p>To activate this ApplicationContextInitializer, we add it to our web.xml:</p>
<pre><code class="prettyprint xml"><br />&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;web-app version=&quot;2.5&quot; xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot;
	xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
	xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;&gt;

	&lt;context-param&gt;
		&lt;param-name&gt;contextInitializerClasses&lt;/param-name&gt;
		&lt;param-value&gt;org.cloudfoundry.services.CloudApplicationContextInitializer&lt;/param-value&gt;
	&lt;/context-param&gt;
	
&lt;/web-app&gt;
</code></pre>
<h5>The Spring layer</h5><p>Our Spring layer is pretty simple. We have a helper class that leverages the MessageListenerAdapter in <a href="http://www.springsource.org/spring-data/redis" title="Spring Data Redis Home">the Spring Data Redis support</a>. Our bean will be invoked whenever Redis gets a message for that event. Inside that handler, we&rsquo;ll be using <a href="http://www.springsource.org/spring-data/mongodb" title="Spring Data MongoDB Home">the Spring Data MongoDB support</a> to map a POJO onto that document so we can update the min, max, and average values.</p>
<pre><code class="prettyprint java"><br />public void handleMessage(String json) throws IOException {

  // Use the Jackson ObjectMapper to turn a JSON document into a POJO
	TickerEvent event = mapper.readValue(new StringReader(json), TickerEvent.class);

  // Load the existing document or start a new one
	Summary summ = mongoTemplate.findOne(query(where(&quot;_id&quot;).is(event.getSymbol())), Summary.class);
	if (null == summ) {
		summ = new Summary(event.getSymbol(), System.currentTimeMillis());
	}
	// Recalculate min, max, and average
	summ.addTickerEvent(event);

  // Save the modified document back
	mongoTemplate.save(summ);
	
}
</code></pre>
<h5>Provide REST endpoints if you want</h5><p>We don&rsquo;t need to expose anything in our Spring layer to the web. It does its work offline, doesn&rsquo;t require input from the user, and doesn&rsquo;t provide the summary data directly to a web client.</p><p>That being said, we might want to put a simple Controller in that will let us know what&rsquo;s going on inside our Java helper class. We created just such a class in our sample application.</p>
<pre><code class="prettyprint java"><br />@Controller
@RequestMapping(&quot;/summaries&quot;)
public class SummariesController {

	@Autowired
	private SummaryService summaryService;

	@RequestMapping(value = &quot;/&quot;, method = RequestMethod.GET)
	public @ResponseBody List&lt;Summary&gt; summaries() {
	  // Return all summaries
		return summaryService.getSummaries();
	}

	@RequestMapping(value = &quot;/{symbol}&quot;, method = RequestMethod.GET)
	public @ResponseBody Summary summary(@PathVariable String symbol) {
	  // Return a specific summary document
		return summaryService.getSummary(symbol);
	}
}
</code></pre><p>This is not something you&rsquo;d want to do in a production application. But for developing on Cloud Foundry and getting some insight into what sometimes feels like a black box, it might make sense to put in a few controller methods that expose your Spring layer&rsquo;s innards.</p>
<h3>Clear as mud?</h3><p>I don&rsquo;t know about you, but I get a little bored with the simplistic nature of many examples and tutorials. Admittedly, there&rsquo;s nothing simplistic about this sample application! It might seem a little like drinking from a fire hose here, but the goal was to provide you with enough meat on the bones to keep you busy for a while as you investigate Cloud Foundry and get your cloud [sea] legs.</p><p>The example app is live on Cloud Foundry:<br /><ul><li><a href="http://ticker-analysis.cloudfoundry.com"><a href="http://ticker-analysis.cloudfoundry.com">http://ticker-analysis.cloudfoundry.com</a></a></li></ul></p><p>All the source code is in the Cloud Foundry samples repo on GitHub:<br /><ul><li><a href="https://github.com/SpringSource/cloudfoundry-samples/tree/master/ticker-analysis"><a href="https://github.com/SpringSource/cloudfoundry-samples/tree/master/ticker-analysis">https://github.com/SpringSource/cloudfoundry-samples/tree/master/ticker-analysis</a></a></li></ul></p><p>For help getting up-to-speed with Cloud Foundry, you can access the forums:<br /><ul><li><a href="http://support.cloudfoundry.com/forums/373015-knowledge-base"><a href="http://support.cloudfoundry.com/forums/373015-knowledge-base">http://support.cloudfoundry.com/forums/373015-knowledge-base</a></a></li></ul></p><p>Comprehensive documentation is still in flux because, frankly, so is the Cloud Foundry platform. It&rsquo;s a bit of a moving target at the moment. The community is maintaining <a href="https://github.com/SpringSource/cloudfoundry-samples/wiki/Node">some wiki pages on github</a>, though, which should help some.</p><p>The <a href="https://github.com/SpringSource/cloudfoundry-samples/tree/master/ticker-analysis/node-ticker-analysis/node_modules/cloudfoundry">Node.js module referenced earlier</a> (to provide easier access to the Cloud Foundry environment variables) is actually part of the sample application until a full-blown Cloud Foundry runtime is released for Node.js.</p><p>Happy hacking!</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 415;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>