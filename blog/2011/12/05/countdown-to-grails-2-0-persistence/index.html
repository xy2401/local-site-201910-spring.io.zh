<html  data-code-prettify="" data-mobile-support="" data-search=""><head>
<title>倒计时Grails 2.0：持久性</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="Countdown to Grails 2.0: Persistence">
<meta name="twitter:description" content="<p>It’s been a while since the last Countdown blog post, but the release of 2.0.0.RC3 gives me a good reason to write another. In the last post, I focused on database migration and how we are standardising on the new Database Migration Plugin. I’ll be continuing on the theme of persistence here and introducing several great new features, particularly around querying.</p>
<h2>Miscellaneous</h2>
<p>Let’s start with some of the minor improvements. First, abstract domain classes are now treated as most people would expect: an abstract base domain class results in a table for it and its subclasses. For example, consider the hierarchy shown in the figure. Prior to Grails 2 this would result in separate ‘employee’ and ‘manager’ tables. Now you just get the one ‘person’ table.</p>
">

<meta property="og:title" content="Countdown to Grails 2.0: Persistence">
<meta property="og:description" content="<p>It’s been a while since the last Countdown blog post, but the release of 2.0.0.RC3 gives me a good reason to write another. In the last post, I focused on database migration and how we are standardising on the new Database Migration Plugin. I’ll be continuing on the theme of persistence here and introducing several great new features, particularly around querying.</p>
<h2>Miscellaneous</h2>
<p>Let’s start with some of the minor improvements. First, abstract domain classes are now treated as most people would expect: an abstract base domain class results in a table for it and its subclasses. For example, consider the hierarchy shown in the figure. Prior to Grails 2 this would result in separate ‘employee’ and ‘manager’ tables. Now you just get the one ‘person’ table.</p>
">
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2011-12-05 10:45:00.0">
</head>
<body >

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">倒计时Grails 2.0：持久性</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="null?s=20&d=mm"> <span class="author">彼得·莱德布鲁克</span>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2011-12-05 10:45:00.0">2011年12月5日</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2011/12/05/countdown-to-grails-2-0-persistence#disqus_thread" data-disqus-identifier="452">
</a></div>
</div>
</header>
<div class="blog--post"><p>自上次Countdown博客文章以来已经有一段时间了，但是2.0.0的发布。RC3给了我另一个理由。在上一篇文章中，我专注于数据库迁移以及我们如何在新的数据库迁移插件上进行标准化。我将在这里继续介绍持久性主题，并介绍几个很棒的新功能，尤其是关于查询的功能。</p>
<h2>杂</h2><p>让我们从一些小的改进开始。首先，现在像大多数人期望的那样对待抽象域类：抽象基础域类为其生成了一个表及其子类。例如，考虑图中所示的层次结构。在Grails 2之前，这将导致单独的“员工”和“经理”表。现在，您仅获得一个“人”表。</p><p><a href="http://blog.springsource.org/wp-content/uploads/2011/11/abstract-domain-inheritance.png"><img src="http://blog.springsource.org/wp-content/uploads/2011/11/abstract-domain-inheritance.png" alt="由Employee和Manager类扩展的Abstract Person类" title="抽象领域层次" width="284" height="175" class="aligncenter size-full wp-image-10310"></a></p><p>不幸的是，这构成了突破性的变化，但是新的行为更有意义，因此我们认为在这种情况下突破是合理的。如果当前正在使用抽象域类，则可以：（1）升级时将它们移到“ src / groovy”目录中；或（2）迁移您的数据，例如使用数据库迁移插件。</p>
<h3>查找或创建</h3><p>下一个功能简化了常见的编码模式，该模式在应用程序引导程序内部特别有用。您是否发现自己正在编写如下代码？</p>
<pre><code class="prettyprint groovy">def adminRole = Role.findByName(&quot;admin&quot;)
if (!adminRole) {
    adminRole = new Role(name: &quot;admin&quot;).save()
}
</code></pre><p>基本上是“我需要一个特定的对象，但如果不存在，则创建它。”它很常见且很冗长，足以证明使用专用方法是合理的。实际上，现在只有四种方法可用于此模式。他们是：</p>
<ol>
<li>findOrCreateBy（）</li>
<li>findOrSaveBy（）</li>
<li>findOrCreateWhere（）</li>
<li>findOrSaveWhere（）</li>
</ol><p>前两个是动态<tt>findBy *（）的</tt>变体。后两个接受包含域类属性及其值的参数映射。每个集合还具有“创建”和“保存”版本，前者指示如果域实例不存在，则应创建<em>但不保存它</em> 。后者当然会自动保存新实例。</p><p>那么，这些角色与我们的管理员角色示例的外观如何？</p>
<ol>
<li>findOrCreateByName（“ admin”）</li>
<li>findOrSaveByName（“ admin”）</li>
<li>findOrCreateWhere（名称：“ admin”）</li>
<li>findOrSaveWhere（名称：“ admin”）</li>
</ol><p>我想您会更加简洁和翔实。</p>
<h3>多个数据源</h3><p>在介绍主要功能（又称为我最喜欢的功能）之前，我想指出Burt Beckwith的Datasources插件现已折叠到Grails核心中。这意味着，一旦下载Grails，就可以开始定义多个（关系）数据源。然后，您可以做一些有趣的事情，例如将域类映射到特定的数据库：</p>
<pre><code class="prettyprint groovy">class User {
    ...
    static mapping = {
        datasource &#39;auth&#39;
    }
}
</code></pre><p>甚至指定用于单个检索的数据源：</p>
<pre><code class="prettyprint groovy">// Retrieve the zip code specifically from our audit DB
def zipCode = ZipCode.auditing.get(42)
</code></pre><p>和商店：</p>
<pre><code class="prettyprint groovy">// Save some zip code to the audit DB
zipCode.auditing.save()
</code></pre><p><a href="http://grails.org/doc/2.0.0.RC3/guide/conf.html#multipleDatasources">用户指南</a>从用户角度提供了有关其工作方式的更多信息。</p>
<h2>新查询语法</h2><p>现在是主要事件：新的Where查询。Grails并没有缺少查询选项，它具有动态查找器，条件查询和HQL支持，因此您可能想知道为什么我们要引入另一种查询。好的，条件查询功能强大，但是语法可能会令人困惑。HQL通常用于更高级的用法。动态查找器仅适用于最简单的方案，而不能让您查询关系。查询通过引入更自然的（对于程序员）语法而在动态查找器和条件/ SQL之间架起了桥梁，同时提供了几乎与条件查询一样的功能。</p><p>让我们看一个简单的例子：</p>
<pre><code class="prettyprint groovy">def year2000 = ...
Book.where { author =~ &quot;Stephen%&quot; &amp;&amp; publishDate &gt; year2000 }.list()
</code></pre><p>这个查询展示了几个强大的功能，但让我印象深刻的第一件事是它的可读性。作为Groovy或Java开发人员，我知道标准中使用的运算符以及它们如何组合。我很快就能知道，以上查询将返回作者姓名以“ Stephen”开头且出版日期为2000年之后的图书。即使没有阅读任何有关Where查询语法的文档！</p><p>除了上述查询的可读性之外，请注意对条件使用运算符（=〜在SQL中映射为“ ilike”），对条件（&&和||）进行组合的逻辑运算符以及使用<tt>list（）</tt>方法来实际执行查询。逻辑运算符对我来说是天赐之物，因为我发现它们比标准查询中的“和”和“或”块更易于阅读和理解。</p><p><tt>list（）</tt>方法的意义在于， <tt>DomainClass.where（）</tt>返回称为分离查询的内容，这意味着您可以一次又一次地重用它。您甚至可以使用动态查找器代替<tt>list（）</tt>来进一步过滤结果。实际上，也可以使用标准条件查询语法来进行分离查询- <a href="http://grails.org/doc/2.0.0.RC3/guide/GORM.html#detachedCriteria">用户指南</a>再次提供了有关此信息的更多信息。</p><p>由于Where查询采用闭包形式，因此您可以执行更高级的操作，例如在条件中包括Groovy条件：</p>
<pre><code class="prettyprint groovy">def constrainName = true
def bookIds = Book.where {
    if (constrainName) {
        author.name =~ &quot;Stephen%&quot;
    }
    publishDate in start..end
}.property(&quot;id&quot;)
</code></pre><p>这意味着您只需轻按一下即可包含或排除标准。可能想到的一个问题是，这两个标准如何结合？默认情况下，单独语句中的条件（例如本示例中的<tt>publishDate</tt>和<tt>author.name）</tt>与隐式AND组合。如果您希望对这些语句进行OR，则可以使用新的<tt>whereAny（）</tt>方法代替<tt>where（）</tt> 。两者之间的语法相同。</p><p>上面的示例还演示了<em>投影</em>支持：仅检索单个属性的值或聚合值而不是域实例本身的能力。因此，以上代码将返回<tt>Book</tt> ID列表，而不是<tt>Book</tt>实例。您甚至可以链接投影以获得额外的灵活性。</p><p>我要强调的最后一个很酷的功能：在查询条件中包括聚合函数非常容易。本示例返回所有早于平均值的作者：</p>
<pre><code class="prettyprint groovy">Author.where { age &gt; avg(age) }
</code></pre><p>实际上，这只是子查询冰山的一角，因为您还可以将附加条件应用于子查询，如本示例所示：</p>
<pre><code class="prettyprint groovy">def query = Person.where {
  age &gt; avg(age).of { lastName == &quot;Simpson&quot; } &amp;&amp; firstName == &quot;Homer&quot;
}
</code></pre><p>如您所见，Where查询在易于使用的程序包中提供了许多功能。我确实认为它们将成为Grails应用程序中的实际查询，取代标准查询和潜在的动态查找器。</p>
<h2>域类重装</h2><p>如果Where查询不够，最终的功能将真正吸引Grails的长期用户：使用<tt>run-app</tt>重载强大的域类！在早期版本的Grails中，更改域类将导致servlet容器重新启动，这可能需要一些时间。现在，修改域类的行为就像其他任何类更改一样（顺便说一下，其中包括<tt>src / java中</tt>的Java类）！</p><p>我将在下一期Countdown to Grails 2.0博客文章中附带的截屏视频中对此进行演示，但是您可以自己尝试一下。您可以添加，删除和重命名属性。您甚至可以更改它们的类型。您唯一需要了解的是，当重新加载域类时， <tt>dbCreate</tt>设置将生效。如果将其保留为默认的“ create-drop”，那么任何现有数据都将从数据库中丢失。但是，如果将值更改为“ update”，则不会丢失任何数据，并且数据库架构仍会更新。唯一需要注意的是，“更新”不能很好地处理某些类型的迁移，但是在开发过程中，这通常不是问题。</p><p>Grails第2版中为每个人提供了一些功能。对于日常开发，Where查询和强大的域类重装将变得更加容易。对多个数据源的支持将使需要在单个应用程序中处理多个关系数据库的开发人员感到满意。数据库迁移插件使处理关系数据库的生产数据迁移的方法标准化。所有这些都会很快传给您！</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 452;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>请启用JavaScript以查看<a href="http://disqus.com/?ref_noscript">由Disqus提供</a>的<a href="http://disqus.com/?ref_noscript">评论。</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">由<span class="logo-disqus">Disqus</span>提供动力的评论</a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>背部</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">所有帖子</a> <a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">工程</a> <a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">发布</a> <a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">新闻与活动</a> <a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>将The Spring Team的更新发送到您的收件箱</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">球队</a></li>
<li><a href="/tools">工具类</a></li>
<li><a href="https://store.pivotal.io/">商店</a></li>
<li><a href="/blog">通讯</a></li>
</ul>
</div>
</div>© <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a> ，Inc.保留所有权利。
<a href="https://pivotal.io/terms-of-use">使用条款</a> • <a href="https://pivotal.io/privacy-policy">隐私</a> • <a href="/trademarks">商标准则</a>
<div id="teconsent" style="display:inline-block"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>