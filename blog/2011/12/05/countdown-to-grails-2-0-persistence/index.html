<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Countdown to Grails 2.0: Persistence</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Countdown to Grails 2.0: Persistence" />
<meta name="twitter:description" content="&lt;p&gt;It’s been a while since the last Countdown blog post, but the release of 2.0.0.RC3 gives me a good reason to write another. In the last post, I focused on database migration and how we are standardising on the new Database Migration Plugin. I’ll be continuing on the theme of persistence here and introducing several great new features, particularly around querying.&lt;/p&gt;
&lt;h2&gt;Miscellaneous&lt;/h2&gt;
&lt;p&gt;Let’s start with some of the minor improvements. First, abstract domain classes are now treated as most people would expect: an abstract base domain class results in a table for it and its subclasses. For example, consider the hierarchy shown in the figure. Prior to Grails 2 this would result in separate ‘employee’ and ‘manager’ tables. Now you just get the one ‘person’ table.&lt;/p&gt;
" />

<meta property="og:title" content="Countdown to Grails 2.0: Persistence" />
<meta property="og:description" content="&lt;p&gt;It’s been a while since the last Countdown blog post, but the release of 2.0.0.RC3 gives me a good reason to write another. In the last post, I focused on database migration and how we are standardising on the new Database Migration Plugin. I’ll be continuing on the theme of persistence here and introducing several great new features, particularly around querying.&lt;/p&gt;
&lt;h2&gt;Miscellaneous&lt;/h2&gt;
&lt;p&gt;Let’s start with some of the minor improvements. First, abstract domain classes are now treated as most people would expect: an abstract base domain class results in a table for it and its subclasses. For example, consider the hierarchy shown in the figure. Prior to Grails 2 this would result in separate ‘employee’ and ‘manager’ tables. Now you just get the one ‘person’ table.&lt;/p&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2011-12-05 10:45:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Countdown to Grails 2.0: Persistence</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="null?s=20&amp;d=mm" />
<span class="author">Peter Ledbrook</span>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2011-12-05 10:45:00.0">December 05, 2011</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="452" href="/blog/2011/12/05/countdown-to-grails-2-0-persistence#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><p>It&rsquo;s been a while since the last Countdown blog post, but the release of 2.0.0.RC3 gives me a good reason to write another. In the last post, I focused on database migration and how we are standardising on the new Database Migration Plugin. I&rsquo;ll be continuing on the theme of persistence here and introducing several great new features, particularly around querying.</p>
<h2>Miscellaneous</h2><p>Let&rsquo;s start with some of the minor improvements. First, abstract domain classes are now treated as most people would expect: an abstract base domain class results in a table for it and its subclasses. For example, consider the hierarchy shown in the figure. Prior to Grails 2 this would result in separate &lsquo;employee&rsquo; and &lsquo;manager&rsquo; tables. Now you just get the one &lsquo;person&rsquo; table.</p><p><a href="http://blog.springsource.org/wp-content/uploads/2011/11/abstract-domain-inheritance.png"><img src="http://blog.springsource.org/wp-content/uploads/2011/11/abstract-domain-inheritance.png" alt="Abstract Person class extended by Employee and Manager classes" title="Abstract domain hierarchy" width="284" height="175" class="aligncenter size-full wp-image-10310" /></a></p><p>Unfortunately this constitutes a breaking change, but the new behaviour makes much more sense and so we think the break is justified in this case. If you are using abstract domain classes currently, then you can either: (1) move them into the &lsquo;src/groovy&rsquo; directory when you upgrade; or (2) migrate your data, for example with the Database Migration plugin.</p>
<h3>Find or create</h3><p>The next feature simplifies a common coding pattern that&rsquo;s particularly useful inside the application bootstrap. Have you ever found yourself writing code like the following?</p>
<pre><code class="prettyprint groovy">def adminRole = Role.findByName(&quot;admin&quot;)
if (!adminRole) {
    adminRole = new Role(name: &quot;admin&quot;).save()
}
</code></pre><p>It&rsquo;s basically &ldquo;I need a particular object, but if it doesn&rsquo;t exist create it.&rdquo; It&rsquo;s common and verbose enough to justify a dedicated method. In fact there are now four methods just for this pattern. They are:</p>
<ol>
<li>findOrCreateBy()</li>
<li>findOrSaveBy()</li>
<li>findOrCreateWhere()</li>
<li>findOrSaveWhere()</li>
</ol><p>The first two are variants of the dynamic <tt>findBy*()</tt>. The second two accept a map of arguments containing the domain class properties and their values. Each set also has &ldquo;Create&rdquo; and &ldquo;Save&rdquo; versions, the former indicating that if the domain instance does not exist it should be created <em>but not saved</em>. The latter of course will automatically save the new instance.</p><p>So how do each of these look with our administrator role example?</p>
<ol>
<li>findOrCreateByName("admin")</li>
<li>findOrSaveByName("admin")</li>
<li>findOrCreateWhere(name: "admin")</li>
<li>findOrSaveWhere(name: "admin")</li>
</ol><p>Much more succinct and informative I think you&rsquo;ll agree.</p>
<h3>Multiple data sources</h3><p>Before going onto the big features (AKA my favourite ones), I&rsquo;d just like to point out that Burt Beckwith&rsquo;s Datasources plugin has now been folded into Grails core. This means that as soon as you download Grails you can start defining multiple (relational) data sources. You can then do interesting things such as map a domain class to a particular database:</p>
<pre><code class="prettyprint groovy">class User {
    ...
    static mapping = {
        datasource &#39;auth&#39;
    }
}
</code></pre><p>or even specify the data source to use for individual retrievals:</p>
<pre><code class="prettyprint groovy">// Retrieve the zip code specifically from our audit DB
def zipCode = ZipCode.auditing.get(42)
</code></pre><p>and stores:</p>
<pre><code class="prettyprint groovy">// Save some zip code to the audit DB
zipCode.auditing.save()
</code></pre><p>The <a href="http://grails.org/doc/2.0.0.RC3/guide/conf.html#multipleDatasources">user guide</a> has more information on just how it works from a user perspsective.</p>
<h2>New query syntax</h2><p>Now for the main event: the new Where queries. Grails hasn&rsquo;t been short of options for querying, with dynamic finders, criteria queries and HQL support, so you may wonder why we&rsquo;re introducing another one. Well, criteria queries are powerful, but the syntax can be confusing. HQL is typically for more advanced usage. Dynamic finders only work for the simplest scenarios and don&rsquo;t let you query on relations. Where queries bridge the gap between dynamic finders and criteria/SQL by introducing a more natural (for programmers) syntax while offering almost as much power as criteria queries.</p><p>Let&rsquo;s look at a simple example:</p>
<pre><code class="prettyprint groovy">def year2000 = ...
Book.where { author =~ &quot;Stephen%&quot; &amp;&amp; publishDate &gt; year2000 }.list()
</code></pre><p>This one query demonstrates several powerful features, but the first thing that strikes me is how readable it is. As a Groovy or Java developer, I recognise the operators used in the criteria and how they combine. I can tell very quickly that the above query will return me the books whose author name begins with &ldquo;Stephen&rdquo; and whose publication date is after the year 2000. Even without reading any documentation on the Where query syntax!</p><p>Beyond the readability of the above query, note the use of operators for criteria (=~ maps to &lsquo;ilike&rsquo; in SQL), logical operators for combining criteria (&amp;&amp; and ||) and the use of the <tt>list()</tt> method to actually execute the query. The logical operators are a god-send to me because I find them easier to read and understand than the &lsquo;and&rsquo; and &lsquo;or&rsquo; blocks in criteria queries.</p><p>The significance of the <tt>list()</tt> method is that <tt>DomainClass.where()</tt> returns what is known as a detached query, meaning you can reuse it again and again. You can even use dynamic finders in place of <tt>list()</tt> to filter results further. In fact, detached queries are also available using the standard criteria query syntax - again <a href="http://grails.org/doc/2.0.0.RC3/guide/GORM.html#detachedCriteria">the user guide</a> has more information on that.</p><p>Since the Where query takes a closure, you can do more advanced things such as include Groovy conditions in the criteria:</p>
<pre><code class="prettyprint groovy">def constrainName = true
def bookIds = Book.where {
    if (constrainName) {
        author.name =~ &quot;Stephen%&quot;
    }
    publishDate in start..end
}.property(&quot;id&quot;)
</code></pre><p>This means you can include or exclude criteria at the flick of a switch. One question that may spring to mind is how do the two criteria combine? By default, criteria in separate statements, such as <tt>publishDate</tt> and <tt>author.name</tt> in this example, are combined with an implicit AND. If you would rather OR the statements, then you can use the new <tt>whereAny()</tt> method in place of <tt>where()</tt>. The syntax is otherwise identical between the two.</p><p>The above example also demonstrates <em>projection</em> support: the ability to retrieve just the value of a single property or an aggregate value instead of the domain instances themselves. So the above code will return a list of <tt>Book</tt> ids rather than <tt>Book</tt> instances. You can even chain projections for extra flexibility.</p><p>One last cool feature I want to highlight: it&rsquo;s trivially easy to include aggregate functions in the query criteria. This example returns all authors that are older than the average:</p>
<pre><code class="prettyprint groovy">Author.where { age &gt; avg(age) }
</code></pre><p>This is in fact just the tip of the sub-query iceberg as you can also apply extra criteria to a sub-query, as demonstrated in this example:</p>
<pre><code class="prettyprint groovy">def query = Person.where {
  age &gt; avg(age).of { lastName == &quot;Simpson&quot; } &amp;&amp; firstName == &quot;Homer&quot;
}
</code></pre><p>As you can see, Where queries provide plenty of features in an easy to use package. I genuinely think they will become the defacto queries in Grails applications, displacing criteria queries and potentially dynamic finders.</p>
<h2>Domain class reloading</h2><p>If the Where queries weren&rsquo;t enough, the final feature will really appeal to long-time Grails users: robust domain class reloading with <tt>run-app</tt>! In previous versions of Grails, changing a domain class would result in the servlet container being restarted, which could take some time. Now, modifying a domain class behaves just like any other class change (that includes Java classes in <tt>src/java</tt> by the way)!</p><p>I&rsquo;ll demonstrate this in a screencast that will go with the next Countdown to Grails 2.0 blog post, but feel free to try it out yourself. You can add, remove and rename properties. You can even change the type of them. The only thing you need to be aware of is that when a domain class is reloaded, the <tt>dbCreate</tt> setting takes effect. If this is left as the default &ldquo;create-drop&rdquo;, then any existing data will be lost from the database. However, if you change the value to &ldquo;update&rdquo;, you don&rsquo;t lose any data and the database schema still updates. The only thing to be careful of is that &ldquo;update&rdquo; doesn&rsquo;t handle some types of migration very well, but during development this isn&rsquo;t usually an issue.</p><p>There&rsquo;s something for everyone in version 2 of Grails. For day to day development, the Where queries and robust domain class reloading will make like easier. Support for multiple data sources will please the developers that need to work against multiple relational databases from a single application. And the database migration plugin standardises the approach for dealing with production data migrations with relational databases. All of this will be coming to you soon!</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 452;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>