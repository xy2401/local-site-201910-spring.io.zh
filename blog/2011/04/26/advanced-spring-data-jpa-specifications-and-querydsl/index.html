<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Advanced Spring Data JPA - Specifications and Querydsl</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Advanced Spring Data JPA - Specifications and Querydsl" />
<meta name="twitter:description" content="&lt;p&gt;In my &lt;a href=&quot;http://blog.springsource.com/2011/02/10/getting-started-with-spring-data-jpa&quot;&gt;last blog post&lt;/a&gt; I introduced the basic feature set of Spring Data JPA. In this post I’d like to dive into some more features and how they can help you simplify data access layer implementation even further. The Spring Data repository abstraction consists of an interface based programming model, some factory classes and a Spring namespace to easily configure the infrastructure. A typical repository interface looks something like this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;prettyprint java&quot;&gt;public interface CustomerRepository extends JpaRepository&amp;lt;Customer, Long&amp;gt; {

  Customer findByEmailAddress(String emailAddress);

  List&amp;lt;Customer&amp;gt; findByLastname(String lastname, Sort sort);

  Page&amp;lt;Customer&amp;gt; findByFirstname(String firstname, Pageable pageable);
}
&lt;/code&gt;&lt;/pre&gt;
" />
<meta name="twitter:creator" content="@odrotbohm" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/977c74bb044a9d4fa90b305824eda390?s=200" />

<meta property="og:title" content="Advanced Spring Data JPA - Specifications and Querydsl" />
<meta property="og:image" content="https://gravatar.com/avatar/977c74bb044a9d4fa90b305824eda390?s=200" />
<meta property="og:description" content="&lt;p&gt;In my &lt;a href=&quot;http://blog.springsource.com/2011/02/10/getting-started-with-spring-data-jpa&quot;&gt;last blog post&lt;/a&gt; I introduced the basic feature set of Spring Data JPA. In this post I’d like to dive into some more features and how they can help you simplify data access layer implementation even further. The Spring Data repository abstraction consists of an interface based programming model, some factory classes and a Spring namespace to easily configure the infrastructure. A typical repository interface looks something like this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;prettyprint java&quot;&gt;public interface CustomerRepository extends JpaRepository&amp;lt;Customer, Long&amp;gt; {

  Customer findByEmailAddress(String emailAddress);

  List&amp;lt;Customer&amp;gt; findByLastname(String lastname, Sort sort);

  Page&amp;lt;Customer&amp;gt; findByFirstname(String firstname, Pageable pageable);
}
&lt;/code&gt;&lt;/pre&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2011-04-26 09:52:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
 </div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Advanced Spring Data JPA - Specifications and Querydsl</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/977c74bb044a9d4fa90b305824eda390?s=20&amp;d=mm" />
<a class="author" rel="author" href="/team/ogierke">Oliver Drotbohm</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2011-04-26 09:52:00.0">April 26, 2011</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="412" href="/blog/2011/04/26/advanced-spring-data-jpa-specifications-and-querydsl#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><p>In my <a href="http://blog.springsource.com/2011/02/10/getting-started-with-spring-data-jpa">last blog post</a> I introduced the basic feature set of Spring Data JPA. In this post I&rsquo;d like to dive into some more features and how they can help you simplify data access layer implementation even further. The Spring Data repository abstraction consists of an interface based programming model, some factory classes and a Spring namespace to easily configure the infrastructure. A typical repository interface looks something like this:</p>
<pre><code class="prettyprint java">public interface CustomerRepository extends JpaRepository&lt;Customer, Long&gt; {

  Customer findByEmailAddress(String emailAddress);

  List&lt;Customer&gt; findByLastname(String lastname, Sort sort);

  Page&lt;Customer&gt; findByFirstname(String firstname, Pageable pageable);
}
</code></pre>
<p>The first method simply expects to find a single customer with a given email address, the second method returns all customers with a given lastname and applies the given <code>Sort</code> to the result whereas the third method returns a <code>Page</code> of customers. For details have a look at the <a href="http://blog.springsource.com/2011/02/10/getting-started-with-spring-data-jpa">former blog post</a>.</p>
<p>Although this approach is really convenient (you don&rsquo;t even have to write a single line of implementation code to get the queries executed) it has two drawbacks: first, the number of query methods might grow for larger applications because of - and that&rsquo;s the second point - the queries define a fixed set of criterias. To avoid these two drawbacks, wouldn&rsquo;t it be cool if you could come up with a set of atomic predicates that you could combine dynamically to build your query?</p>
<p>If you are a long time JPA user you might answer: isn&rsquo;t that what the Criteria API is for? Right, so let&rsquo;s have a look what a sample business requirement implementation could look like using the JPA Criteria API. Here&rsquo;s the use case: on their birthday&rsquo;s we want to send a voucher to all long term customers. How do we retrieve the ones that match?</p>
<p>We pretty much have two parts to the predicate: the birthday as well as what we call long-term-customer. Let&rsquo;s assume the latter means that the customer account was created at least two years ago. Here&rsquo;s how it would look like implemented using the JPA 2.0 Criteria API.</p>
<pre><code class="prettyprint java">LocalDate today = new LocalDate();

CriteriaBuilder builder = em.getCriteriaBuilder();
CriteriaQuery&lt;Customer&gt; query = builder.createQuery(Customer.class);
Root&lt;Customer&gt; root = query.from(Customer.class);

Predicate hasBirthday = builder.equal(root.get(Customer_.birthday), today);
Predicate isLongTermCustomer = builder.lessThan(root.get(Customer_.createdAt), today.minusYears(2); 
query.where(builder.and(hasBirthday, isLongTermCustomer));
em.createQuery(query.select(root)).getResultList();
</code></pre>
<p>What do we have here? We create a new <code>LocalDate</code> for convenience and go on with three lines of boilerplate to set up the necessary JPA infrastructure instances. Then we have two lines building the predicates, one to concatenate both and a last one to execute the actual query. We&rsquo;re using the meta-model classes introduced with JPA 2.0 and generated by the Annotation Processing API. The main problem with this code is that the predicates are not easy to externalize and reuse because you need to set up the <code>CriteriaBuilder</code>, <code>CriteriaQuery</code> and <code>Root</code> first. Also, readability of the code is poor as it is hard to quickly infer the intent of the code upon first glance. </p>
<h3>Specifications</h3>
<p>To be able to define reusable <code>Predicate</code>s we introduced the <code>Specification</code> interface that is derived from concepts introduced in Eric Evans&rsquo; <a href="http://www.infoq.com/minibooks/domain-driven-design-quickly">Domain Driven Design</a> book. It defines a specification as a predicate over an entity which is exactly what our <code>Specification</code> interface represents. The actually only consists of a single method:</p>
<pre><code class="prettyprint java">public interface Specification&lt;T&gt; {
  Predicate toPredicate(Root&lt;T&gt; root, CriteriaQuery query, CriteriaBuilder cb);
}
</code></pre>
<p>so we can now easily use a helper class like this:</p>
<pre><code class="prettyprint java">public CustomerSpecifications {

  public static Specification&lt;Customer&gt; customerHasBirthday() {
    return new Specification&lt;Customer&gt; {
      public Predicate toPredicate(Root&lt;T&gt; root, CriteriaQuery query, CriteriaBuilder cb) {
        return cb.equal(root.get(Customer_.birthday), today);
      }
    };
  }

  public static Specification&lt;Customer&gt; isLongTermCustomer() {
    return new Specification&lt;Customer&gt; {
      public Predicate toPredicate(Root&lt;T&gt; root, CriteriaQuery query, CriteriaBuilder cb) {
        return cb.lessThan(root.get(Customer_.createdAt), new LocalDate.minusYears(2));
      }
    };
  }
}
</code></pre>
<p>Admittedly, not the most beautiful code in the world but it serves our initial requirement quite nicely: we can refer to a set of atomic specifications. The next question is: how will we execute these specifications? To do so, you simply extend <code>JpaSpecificationExecutor</code> in your repository interface and thus &ldquo;pull in&rdquo; an API to execute <code>Specification</code>s:</p>
<pre><code class="prettyprint java">public interface CustomerRepository extends JpaRepository&lt;Customer&gt;, JpaSpecificationExecutor {
  // Your query methods here
}
</code></pre>
<p>A client can now do:</p>
<pre><code class="prettyprint java">customerRepository.findAll(hasBirthday());
customerRepository.findAll(isLongTermCustomer());
</code></pre>
<p>The basic repository implementation will prepare the <code>CriteriaQuery</code>, <code>Root</code> and <code>CriteriaBuilder</code> for you, apply the <code>Predicate</code> created by the given <code>Specification</code> and execute the query. But couldn&rsquo;t we just have created simple query methods to achieve that? Correct, but remember our second initial requirement. We wanted to be able to freely combine atomic <code>Specification</code>s to create new ones one the fly. To do so we have a helper class <code>Specifications</code> that provides <code>and(…)</code> and <code>or(…)</code> methods to concatenate atomic <code>Specification</code>s. There&rsquo;s also a <code>where(…)</code> that provides some syntactic sugar to make the expression more readable. The use case sample I came up with in the beginning looks like this:</p>
<pre><code class="prettyprint java">customerRepository.findAll(where(customerHasBirthday()).and(isLongTermCustomer()));
</code></pre>
<p>This reads fluently, improving readability as well as providing additional flexibility as compared to the use of the JPA Criteria API alone. The only caveat here is that coming up with the <code>Specification</code> implementation requires quite some coding effort.</p>
<a name="querydsl"></a>
<h3>Querydsl</h3>
<p>To cure that pain an open-source project called <a href="http://www.querydsl.com">Querydsl</a> has come up with a quite similar but also different approach. Just like the JPA Criteria API it uses a Java 6 annotation processor to generate meta-model objects but produces a much more approachable API. Another cool thing about the project is that it has not only has support for JPA but also allows querying Hibernate, JDO, Lucene, JDBC and even plain collections.</p>
<p>So to get that up and running you add Querydsl to your <code>pom.xml</code> and configure the APT plugin accordingly. </p>
<pre><code class="prettyprint xml">&lt;plugin&gt;
  &lt;groupId&gt;com.mysema.maven&lt;/groupId&gt;
  &lt;artifactId&gt;maven-apt-plugin&lt;/artifactId&gt;
  &lt;version&gt;1.0&lt;/version&gt;
  &lt;executions&gt;
    &lt;execution&gt;
      &lt;phase&gt;generate-sources&lt;/phase&gt;
      &lt;goals&gt;
        &lt;goal&gt;process&lt;/goal&gt;
      &lt;/goals&gt;
      &lt;configuration&gt;
        &lt;outputDirectory&gt;target/generated-sources&lt;/outputDirectory&gt;
        &lt;processor&gt;com.mysema.query.apt.jpa.JPAAnnotationProcessor&lt;/processor&gt;
      &lt;/configuration&gt;
    &lt;/execution&gt;
  &lt;/executions&gt;
&lt;/plugin&gt;
</code></pre>
<p>This will cause your build to create special query classes - <code>QCustomer</code> inside the very same package in our case.</p>
<pre><code class="prettyprint java">QCustomer customer = QCustomer.customer;
LocalDate today = new LocalDate();
BooleanExpression customerHasBirthday = customer.birthday.eq(today);
BooleanExpression isLongTermCustomer = customer.createdAt.lt(today.minusYears(2));
</code></pre>
<p>This is not only almost fluent English out of the box, the <code>BooleanExpression</code>s are even reusable without further wrapping which lets us get rid off the additional (and a bit ugly to implement) <code>Specification</code> wrapper. A further plus is that you get IDE code completion at every dot on the right hand side of the assignments, so <code>customer. + CTRL + SPACE</code> would list all properties. <code>customer.birthday. + CTRL + SPACE</code> would list all available keywords and so on. To execute Querydsl predicates you simply let your repository extend <code>QueryDslPredicateExecutor</code>:</p>
<pre><code class="prettyprint java">public interface CustomerRepository extends JpaRepository&lt;Customer&gt;, QueryDslPredicateExecutor {
  // Your query methods here
}
</code></pre>
<p>Clients can then simply do:</p>
<pre><code class="prettyprint java">BooleanExpression customerHasBirthday = customer.birthday.eq(today);
BooleanExpression isLongTermCustomer = customer.createdAt.lt(today.minusYears(2));
customerRepository.findAll(customerHasBirthday.and(isLongTermCustomer));
</code></pre>
<h3>Summary</h3>
<p>Spring Data JPA repository abstraction allows executing predicates either via JPA Criteria API predicates wrapped into a Specification object or via Querydsl predicates. To enable this functionality you simply let your repository extend JpaSpecificationExecutor or QueryDslPredicateExecutor (you could even use both side by side if you liked). Note that you need the Querydsl JARs in the class in case you decide for the Querydsl approach.</p>
<h3>One more thing</h3>
<p>One more cool thing about the Querydsl approach is that it is not only available for our JPA repositories but for our MongoDB support as well. The functionality is included in the just released M2 release of Spring Data MongoDB already. Beyond that both the Mongo and JPA module of Spring Data are supported on the <a href="http://www.cloudfoundry.com/">CloudFoundry</a> platform. See the <a href="https://github.com/SpringSource/cloudfoundry-samples/wiki">cloudfoundry-samples wiki</a> for getting started with Spring Data and CloudFoundry.</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 412;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>