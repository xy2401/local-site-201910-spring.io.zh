<html  data-code-prettify="" data-mobile-support="" data-search=""><head>
<title>深入了解Grails和Cloud Foundry</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="Deeper into Grails & Cloud Foundry">
<meta name="twitter:description" content="<p>In <a href=" 2011="" 04="" 12="" one-step-deployment-with-grails-and-cloud-foundry="" ="=">my previous post, I showed you how easy it is to deploy a Grails application to <a href=" http: www.cloudfoundry.com"></head><body >Cloud Foundry using the corresponding plugin. Hopefully that whetted your appetite and you are ready to look at a more complex Grails application that demonstrates the power of the GORM plugins and stretches the Cloud Foundry services. If you don’t have a Cloud Foundry account yet, please be patient. The response to the announcement has been phenomenal so it is going to take some time to work through the backlog of requests. 
">

<meta property="og:title" content="Deeper into Grails & Cloud Foundry">
<meta property="og:description" content="<p>In <a href=" 2011="" 04="" 12="" one-step-deployment-with-grails-and-cloud-foundry="" ="=">my previous post, I showed you how easy it is to deploy a Grails application to <a href=" http: www.cloudfoundry.com">Cloud Foundry using the corresponding plugin. Hopefully that whetted your appetite and you are ready to look at a more complex Grails application that demonstrates the power of the GORM plugins and stretches the Cloud Foundry services. If you don’t have a Cloud Foundry account yet, please be patient. The response to the announcement has been phenomenal so it is going to take some time to work through the backlog of requests. 
">
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2011-04-21 08:27:00.0">



<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
 <header>
<h1 class="blog--title">深入了解Grails和Cloud Foundry</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="null?s=20&d=mm"> <span class="author">彼得·莱德布鲁克</span>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2011-04-21 08:27:00.0">2011年4月21日</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2011/04/21/deeper-into-grails-cloud-foundry#disqus_thread" data-disqus-identifier="409">
</a></div>
</div>
</header>
<div class="blog--post"><p>在<a href="/2011/04/12/one-step-deployment-with-grails-and-cloud-foundry/">我以前的文章中</a> ，我向您展示了使用相应插件将Grails应用程序部署到<a href="http://www.cloudfoundry.com">Cloud Foundry的</a>过程是多么容易。希望这能激发您的胃口，并且您可以准备看一个更复杂的Grails应用程序，该应用程序演示GORM插件的功能并扩展Cloud Foundry服务。如果您还没有Cloud Foundry帐户，请耐心等待。对该公告的响应非常出色，因此需要花费一些时间来处理积压的请求。</p>
<h2>GrailsTwitter</h2><p>简单的Twitter克隆几乎已成为示例Grails应用程序的标准，因此毫不奇怪为Cloud Foundry开发了另一个版本。您可以<a href="https://github.com/SpringSource/cloudfoundry-samples/tree/master/grailstwitter/">在GitHub上</a>找到代码以及其他Cloud Foundry示例，还可以测试已经在云上运行<a href="http://grailstwitter.cloudfoundry.com/">的应用程序实例</a> 。</p><p>在这种情况下，我们将数据存储与MongoDB混合使用，用于存储状态消息和标签，用于用户信息的SQL数据库（因为我们使用的是Spring Security）和用于缓存总体标签信息的Redis：</p>
<p style="text-align:center"><a href="http://blog.springsource.com/wp-content/uploads/2011/04/grailstwitter-cf-model.png"><img src="http://blog.springsource.com/wp-content/uploads/2011/04/grailstwitter-cf-model.png" alt="" title="GrailsTwitter的数据模型" width="416" height="222" class="size-full wp-image-8555"></a><br>GrailsTwitter的数据模型</p><p><tt>Person</tt>和<tt>Authority</tt>域类是标准的Spring Security，因此除了Hibernate映射它们之外，我不会再赘述，因此在部署应用程序时需要Cloud Foundry MySQL服务。</p><p>更令人感兴趣的是<tt>Status</tt>域类。通过向类添加静态<tt>mapWith</tt>属性，我们可以确保将其实例存储在MongoDB中而不是SQL存储中：</p>
<pre><code class="prettyprint groovy">package org.grails.twitter

import org.grails.twitter.auth.Person

class Status {
    static mapWith = &quot;mongo&quot;
    static transients = [&quot;author&quot;]
	
    String message
    Long authorId
    List&lt;String&gt; tags = []
    Date dateCreated
	
    Person getAuthor() {
        return Person.get(authorId)
    }
}
</code></pre><p>除此之外，它看起来像一个非常标准的GORM域类。那么，我们如何将存储在MongoDB中的状态消息链接到存储在SQL数据库中的用户呢？在这种情况下，我们不能使用标准的GORM一对一关系，因此，我们将用户的ID明确存储在状态消息中，并添加一个临时的只读<tt>作者</tt>属性，以便于访问关联的<tt>Person</tt>实例。 。当您知道如何时就很简单！</p><p>您还可以看到标记没有存储为单独的域实例（标记是状态消息中以“＃”开头的任何字符串）。相反，每个<tt>状态</tt>将其标签列表存储为纯字符串-MongoDB网站上建议的一种方法。这意味着保存和检索状态消息非常便宜，但是确实提出了一个重要的问题：您如何找出系统中有哪些标签，每个标签有多少次出现？毕竟没有“ tag”表可查询，这通常是关系数据库中需要的表。</p><p>这就是MongoDB对map-reduce函数的支持。map函数将所有状态消息中的所有标签分解，然后reduce函数将每个状态标签的总数进行汇总。您可以在<tt><a href="https://github.com/SpringSource/cloudfoundry-samples/blob/master/grailstwitter/grails-app/services/org/grails/twitter/TagService.groovy#L33">TagService.cacheTags（）</a></tt>方法中查看相关代码。可能需要一些时间来了解/缩小地图，但对于并行计算而言却很棒。但是，对于单个MongoDB实例，此操作并不是很快。因此，缓存结果是有意义的。</p>
<h2>快取</h2><p>每当我想到缓存时，我的想法都会立即转到Ehcache。就像Java平台上开源缓存的老爸。即使是针对Grails的Spring Cache插件，目前也已硬编码以使用它。那么，当它部署到云中时，我们可以将其用于我们的应用程序吗？如果我们只打算拥有一个应用程序实例，那么可以肯定。您只需要配置磁盘存储的位置，尽管这并非易事，我稍后将讨论文件系统访问。但是云部署的主要优势之一是能够快速创建多个实例来处理负载的能力，在这种情况下，Ehcache是不可选择的。</p><p>缓存通常是简单明了的键值存储，因此Cloud Foundry上目前有替代方法，Redis服务以及其他缓存服务（如<a href="https://www.vmware.com/products/vfabric-gemfire/overview.html">vFabric Gemfire）</a>都在开发中。在GrailsTwitter应用程序中，我们枚举标签及其总数，并将结果存储在Redis排序集中。这是在确保通过原子方式更新集合的事务（通过<tt>redis.multi（）/。exec（）</tt> ）中完成的-之所以重要，是因为可能同时有很多请求同时发送给标签列表。另外，排序集可确保我们始终按“总数”的顺序检索标签。</p><p>当然，由于Redis是一个独立的实例，因此您可以根据需要拥有任意数量的应用程序实例：它们都将使用相同的Redis服务。该应用程序也是如何直接使用Redis而不是通过GORM API的有用演示，我们不会在GrailsTwitter中将任何域类映射到Redis。</p><p>该示例应用程序还演示了Searchable插件的用法，该插件基于Compass，在这种情况下可以处理用户搜索。现在，该插件必须将其搜索索引存储在某个地方，那么当我们将应用程序部署到Cloud Foundry时，它如何知道将它们放在哪里？</p>
<h2>文件系统访问</h2><p>在许多生产环境中，您预先知道可以在哪里存储文件（例如搜索索引），因此可以将路径放入运行时配置中。或者，您可以通过<tt>grails.config.locations</tt>设置包含一个外部配置文件，而Ops会将相应的路径放入该文件中。但是，使用Cloud Foundry，您不会事先知道任何可用的文件位置，也无法部署外部配置文件。</p><p>幸运的是，Cloud Foundry在运行时通过<tt>HOME</tt>环境变量提供了合适的文件路径。您的应用程序所需要做的就是读取它，然后使用该路径作为基础创建所需的任何目录和文件。对于Searchable，Cloud Foundry插件会自动基于<tt>HOME</tt>变量将搜索索引的标准位置替换为标准位置，因此您无需执行任何操作！</p><p>这些都是好东西，但是云中的文件系统访问存在严重问题，在谈论Ehcache时，我曾提到过它：如果您有多个应用程序实例，则每个实例将拥有自己的（不同的）副本。文件。这很少是您想要的。例如，所有应用程序实例都应共享相同的搜索索引，否则，点击一个实例的用户将获得与另一个实例所服务的用户不同的搜索结果。</p><p>Cloud Foundry仍处于初期阶段，因此您可以预期全年会有更多服务上线。搜索服务（以及其他服务）的请求已经存在。同时，我们可以提供一种变通方法，以说明解决云中协调难题的通用解决方案：使用Redis对发布/订阅消息传递的支持来保持文件同步。例如，在Grails Twitter中，我们可以在每次添加用户时触发一个事件，然后所有实例将侦听该事件并为新用户建立索引。修改或删除的用户也是如此。用于Grails的Redis插件在撰写本文时不支持开箱即用的发布/订阅（即将发布！），但是您可以使用Spring Data，直到该支持可用为止。</p>
<h2>未来</h2><p>如您所见，通过明智地使用可用的服务（尤其是Redis），您已经可以将中等复杂的应用程序部署到Cloud Foundry。而且，您可以将应用程序部署到Cloud Foundry的简单性使其成为引人注目的部署目标。</p><p>尽管如此，重要的是要了解将来会向Cloud Foundry添加更多服务，这将使您能够部署具有更多功能的应用程序。随着这些服务的到来，我们将致力于确保相应的Grails支持与现有的支持一样流畅，易于使用。因此，尝试一下，玩得开心，并期待Cloud Foundry服务的一些激动人心的附加功能！</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 409;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>请启用JavaScript以查看<a href="http://disqus.com/?ref_noscript">由Disqus提供</a>的<a href="http://disqus.com/?ref_noscript">评论。</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">由<span class="logo-disqus">Disqus</span>提供动力的评论</a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>背部</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">所有帖子</a> <a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">工程</a> <a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">发布</a> <a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">新闻与活动</a> <a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>将The Spring Team的更新发送到您的收件箱</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">球队</a></li>
<li><a href="/tools">工具类</a></li>
<li><a href="https://store.pivotal.io/">商店</a></li>
<li><a href="/blog">通讯</a></li>
</ul>
</div>
</div>© <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a> ，Inc.保留所有权利。
<a href="https://pivotal.io/terms-of-use">使用条款</a> • <a href="https://pivotal.io/privacy-policy">隐私</a> • <a href="/trademarks">商标准则</a>
<div id="teconsent" style="display:inline-block"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>