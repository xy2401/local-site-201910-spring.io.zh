<html dir="ltr" data-code-prettify="" data-mobile-support="" data-search=""><head>
<title>RabbitMQ：在Cloud Foundry上启用Grails全文搜索</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>System.config({baseURL: "/b92013b"});</script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>System.import('app/main.js')</script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="RabbitMQ: Enabling Grails full text search on Cloud Foundry">
<meta name="twitter:description" content="<p>In my <a href=" http:="" ="" blog.springsource.com="" 2011="" 04="" 21="" deeper-into-grails-cloud-foundry="" ="="></meta>second blog about Grails and Cloud Foundry I introduced a variant of the <a href=" https: github.com SpringSource cloudfoundry-samples tree master grailstwitter"></head><body dir="ltr">Grails Twitter example that could be hosted on <a href="http://www..cloudfoundry.com/">CloudFoundry.com</a> At the time I mentioned that full text search using the Searchable plugin would limit you to a single application instance because the search indices would be unique to each instance. In other words, you might very easily get different search results depending on which application instance your browser is routed to.
<p>I also said that one option for fixing this problem would be to synchronise the search indices across the instances. But that doesn’t sound particularly easy, does it? As it happens, the introduction of the RabbitMQ service into Cloud Foundry means that the required code changes are far smaller than you might expect. So let’s see how I added full text search for the Grails Twitter status messages.</p>
">

<meta property="og:title" content="RabbitMQ: Enabling Grails full text search on Cloud Foundry">
<meta property="og:description" content="<p>In my <a href=" http:="" ="" blog.springsource.com="" 2011="" 04="" 21="" deeper-into-grails-cloud-foundry="" ="="></meta>second blog about Grails and Cloud Foundry I introduced a variant of the <a href=" https: github.com SpringSource cloudfoundry-samples tree master grailstwitter">Grails Twitter example that could be hosted on <a href="http://www..cloudfoundry.com/">CloudFoundry.com</a> At the time I mentioned that full text search using the Searchable plugin would limit you to a single application instance because the search indices would be unique to each instance. In other words, you might very easily get different search results depending on which application instance your browser is routed to.
<p>I also said that one option for fixing this problem would be to synchronise the search indices across the instances. But that doesn’t sound particularly easy, does it? As it happens, the introduction of the RabbitMQ service into Cloud Foundry means that the required code changes are far smaller than you might expect. So let’s see how I added full text search for the Grails Twitter status messages.</p>
">
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2011-08-29 13:00:00.0">



<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">// Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }</script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">RabbitMQ：在Cloud Foundry上启用Grails全文搜索</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="null?s=20&d=mm"> <span class="author">彼得·莱德布鲁克</span>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2011-08-29 13:00:00.0">2011年8月29日</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2011/08/29/rabbitmq-enabling-grails-full-text-search-on-cloud-foundry#disqus_thread" data-disqus-identifier="435">
</a></div>
</div>
</header>
<div class="blog--post"><p>在<a href="http://blog.springsource.com/2011/04/21/deeper-into-grails-cloud-foundry/">关于Grails和Cloud Foundry的第二个博客中，</a>我介绍了可以在<a href="http://www..cloudfoundry.com/">CloudFoundry.com</a>上托管的<a href="https://github.com/SpringSource/cloudfoundry-samples/tree/master/grailstwitter">Grails Twitter示例</a>的变体。当时，我提到使用Searchable插件进行全文搜索会将您限制为单个应用程序实例，因为搜索索引对于每个实例都是唯一的。换句话说，根据浏览器路由到哪个应用程序实例，您可能很容易获得不同的搜索结果。</p><p>我还说过，解决此问题的一种方法是在实例之间同步搜索索引。但这听起来并不容易，不是吗？碰巧的是，将RabbitMQ服务引入Cloud Foundry意味着所需的代码更改远远小于您的预期。因此，让我们看看如何为Grails Twitter状态消息添加全文搜索。</p>
<h2>使状态消息可搜索</h2><p>Searchable插件强烈假设您要为标准GORM域类建立索引。这意味着Hibernate / SQL。但是Grails Twitter状态消息存储在MongoDB中，而不是MySQL中。我们可以使它们可搜索吗？是的，我们可以，但是要牺牲一些功能。</p><p>与普通域类一样，搜索<tt>Status</tt>实例的第一步是添加一个<tt>searchable</tt>属性：</p>
<pre><code class="prettyprint groovy">package org.grails.twitter

import org.grails.twitter.auth.Person

class Status {
    static mapWith = "mongo"
    static transients = ["author"]

    static searchable = {
        only = ["message", "dateCreated"]
        authorId index: "no", store: "yes"
    }
	
    String message
    Long authorId
    List<String> tags = []
    Date dateCreated
	
    Person getAuthor() {
        return Person.get(authorId)
    }

    static constraints = {
        message maxSize: 160
    }
}
</code></pre><p>在这种情况下，我希望能够搜索消息的创建日期和内容，但仅此而已。我也想从搜索结果中链接到邮件的作者。但是，如果未对<tt>authorId</tt>编制索引，则搜索结果将不包含张贴者的ID。因此，我将<tt>authorId</tt>存储在索引中，但不要使其可搜索（索引：“否”）。简单，不是吗？显示搜索结果后，它们现在可以包括每封邮件作者的姓名。</p><p>索引非Hibernate域类的一个重要限制是镜像将不起作用。这意味着新消息在保存时不会自动编入索引。幸运的是，我们实际上并不需要这种行为，因此我在<tt>Config.groovy中</tt>禁用了镜像和“启动时批量索引”：</p>
<pre><code class="prettyprint groovy">searchable {
    ...
    mirrorChanges = false
    bulkIndexOnStartup = false
}
</code></pre><p>当然，我们确实希望在启动时为状态消息建立索引，因为Cloud Foundry上的文件系统是临时的，因此每次启动时都需要重建搜索索引。但是自动索引也不适用于非Hibernate域类，因此我在<tt>BootStrap.groovy</tt>的结尾处求助于手动索引：</p>
<pre><code class="prettyprint groovy">...
class BootStrap {

    def searchableService
    def springSecurityService

    def init = { servletContext ->
        ...
        // Index all Hibernate mapped domain classes.
        searchableService.reindex()

        // Index all status messages.
        def statusMessages = Status.list()
        log.info "Indexing ${statusMessages.size()} status messages"
        Status.reindex(statusMessages)
        log.info "Finished indexing"
    }
    ...
}
</code></pre><p>那不是很多的代码，但是足以使状态消息可搜索。剩下要做的就是确保为新消息建立索引，并确保在应用程序实例之间同步搜索索引。</p>
<h2>与RabbitMQ同步</h2><p>保持搜索索引同步的基本模型非常简单：</p><p><img src="http://blog.springsource.com/wp-content/uploads/2011/08/grailstwitter-search-sync.png" alt="" title="使用RabbitMQ同步搜索索引" width="430" height="252" class="aligncenter size-full wp-image-9490"></p><p>每次保存状态消息时，都会将一条消息发送到RabbitMQ代理，然后将其转发到所有应用程序实例。然后，每个实例都会为该消息标识的<tt>Status</tt>实例编制索引。</p><p>在实现此功能之前，我们需要安装RabbitMQ插件：<br></p><pre><br> grails install-plugin rabbitmq<br></pre><p></p><p>下一个工作是为代理配置适当的交换和队列。之前我已经写过关于<a href="http://blog.springsource.com/2010/06/14/understanding-amqp-the-protocol-used-by-rabbitmq/">AMQP协议</a>和<a href="http://blog.springsource.com/2010/08/23/rabbitmq-plugin-for-grails-early-access/">RabbitMQ插件的</a>博客，所以在这里我不会详细讨论交换和队列。可以说，我们所需要的只是一个扇出交换（所有消息都路由到所有侦听器）和一个订阅该交换的Grails服务。所以在<tt>Config.groovy中</tt>我添加：</p>
<pre><code class="prettyprint groovy">rabbitmq {
    connectionfactory {
        username = 'guest'
        password = 'guest'
        hostname = 'localhost'
    }

    queues = {
        exchange name: 'search.sync', type: fanout, durable: false
    }
}
</code></pre><p>重要的一点是交换声明：将应用程序部署到Cloud Foundry时，将忽略连接工厂设置，因为RabbitMQ服务在运行时绑定到了应用程序。</p><p>发送消息是一种方式：</p>
<pre><code class="prettyprint groovy">...
class StatusService {
    def springSecurityService
    def tagService
    
    void updateStatus(long userId, String message) {
        def status = new Status(message: message, authorId: userId).save(flush: true, failOnError: true)
        rabbitSend 'search.sync', '', "${status.id}:${status.class.name}"
        
        runAsync {
            tagService.extractTagsFromMessage(status)
        }
    }
    ...
}
</code></pre><p>为状态消息建立索引的服务并不复杂：</p>
<pre><code class="prettyprint groovy">package org.grails.twitter

class SyncService {
    static rabbitSubscribe = "search.sync"
    static transactional = false

    def grailsApplication
    def searchableService

    void handleMessage(String message) {
        def parts = message.split(/:/)
        if (parts.size() != 2) {
            log.error "Invalid message: $message"
            return
        }

        def domainClass = grailsApplication.getDomainClass(parts[1])
        log.debug "Reindexing instance ${parts[0]} of ${parts[1]}"
        try {
            searchableService.reindex(domainClass.clazz.get(parts[0]))
        }
        catch (Exception ex) {
            log.error "Failed to index instance ${parts[0]} of ${parts[1]}", ex
        }
    }
}
</code></pre><p>因此， <tt>rabbitSend（）</tt>方法用于发送包含<tt>Status</tt>实例ID和类名称的简单字符串。在这种情况下，我们只处理<tt>Status</tt>实例，但是使服务对所有潜在的可搜索域类通用是很有用的。同样，使用Groovy意味着我们不必进行任何讨厌的反射：我们只需获取类并直接在其上调用我们想要的方法！</p><p><tt>SyncService</tt>的重要部分是<tt>rabbitSubscribe</tt>属性和<tt>handleMessage（）</tt>方法。前者声明该服务应订阅交换“ search.sync”，这是我向其发送消息的交换。每次从该交换接收到一条消息时，都会使用该消息的内容作为参数来调用<tt>handleMessage（）</tt>方法。因此，该方法提取类名和实例ID，然后使用Grails <tt>DomainClass.get（）</tt>方法从数据存储（MongoDB中获取我们的<tt>Status</tt>消息）检索相关实例。最后， <tt>searchableService.reindex（）</tt>方法将状态消息添加到本地搜索索引。当然，这在每个应用程序实例上都在发生。</p><p>现在，该应用程序可以部署到Cloud Foundry，并可以扩展到允许的最大实例数！您可以在<a href="http://grailstwitter.cloudfoundry.com/">CloudFoundry.com</a>上查看结果。请注意，在GitHub项目中，我已经做了一些UI工作来支持全文搜索，但是这些更改与手头的主题并不真正相关。</p>
<h2>包起来</h2><p>我不得不说，我很惊讶自己几乎不需要多少代码就可以使搜索索引同步。不仅如此，而且由于编码非常简单，因此我能够集中精力于如何解决问题而不是对其进行编码。最重要的是，使用Cloud Foundry意味着部署包括创建和绑定RabbitMQ服务，然后运行<tt>grails prod cf-update</tt>命令将更改推送到服务器。简单的东西。</p><p>如您所见，RabbitMQ可以为与云有关的问题提供创新的解决方案，而Grails插件通过其约定的强大功能使其易于使用。您可以在同一应用程序的不同实例，不同的Grails应用程序甚至使用不同语言和框架编写的应用程序之间进行通信。例如，我们可以部署一个简单的Node.js或Sinatra应用程序，该应用程序会记录并显示“ search.sync”消息，以便您可以跟踪它们。基本上，RabbitMQ是您的云工具箱中的必不可少的项目。</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">var disqus_shortname = 'spring-io';
      var disqus_identifier = 435;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));</script>
<noscript>请启用JavaScript以查看<a href="http://disqus.com/?ref_noscript">由Disqus提供</a>的<a href="http://disqus.com/?ref_noscript">评论。</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">由<span class="logo-disqus">Disqus</span>提供动力的评论</a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>背部</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">所有帖子</a> <a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">工程</a> <a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">发布</a> <a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">新闻与活动</a> <a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>将The Spring Team的更新发送到您的收件箱</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });</script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">球队</a></li>
<li><a href="/tools">工具类</a></li>
<li><a href="https://store.pivotal.io/">商店</a></li>
<li><a href="/blog">通讯</a></li>
</ul>
</div>
</div>© <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a> ，Inc.保留所有权利。
<a href="https://pivotal.io/terms-of-use">使用条款</a> • <a href="https://pivotal.io/privacy-policy">隐私</a> • <a href="/trademarks">商标准则</a>
<div id="teconsent" style="display:inline-block"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>