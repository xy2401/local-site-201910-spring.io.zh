<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>The Login Page: Angular JS and Spring Security Part II</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="The Login Page: Angular JS and Spring Security Part II" />
<meta name="twitter:description" content="&lt;blockquote&gt;
 &lt;p&gt;Note: the source code and test for this blog continue to evolve, but the changes to the text are not being maintained here. Please see &lt;a href=&quot;https://spring.io/guides/tutorials/spring-security-and-angular-js/&quot;&gt;the tutorial version&lt;/a&gt; for the most up to date content.&lt;/p&gt; 
&lt;/blockquote&gt;
&lt;p&gt;In this article we continue &lt;a href=&quot;http://spring.io/blog/2015/01/12/spring-and-angular-js-a-secure-single-page-application&quot; title=&quot;First Article in the Series&quot;&gt;our discussion&lt;/a&gt; of how to use &lt;a href=&quot;http://projects.spring.io/spring-security&quot;&gt;Spring Security&lt;/a&gt; with &lt;a href=&quot;http://angularjs.org&quot;&gt;Angular JS&lt;/a&gt; in a “single page application”. Here we show how to use Angular JS to authenticate a user via a form and fetch a secure resource to render in the UI. This is the second in a series of articles, and you can catch up on the basic building blocks of the application or build it from scratch by reading the &lt;a href=&quot;http://spring.io/blog/2015/01/12/spring-and-angular-js-a-secure-single-page-application&quot; title=&quot;First Article in the Series&quot;&gt;first article&lt;/a&gt;, or you can just go straight to the &lt;a href=&quot;https://github.com/dsyer/spring-security-angular/tree/master/single&quot;&gt;source code in Github&lt;/a&gt;. In the first article we built a simple application that used HTTP Basic authentication to protect the backend resources. In this one we add a login form, give the user some control over whether to authenticate or not, and fix the issues with the first iteration (principally lack of CSRF protection).&lt;/p&gt;
" />
<meta name="twitter:creator" content="@david_syer" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/ae671230e3a1c2a0eefa7604990084f1?s=200" />

<meta property="og:title" content="The Login Page: Angular JS and Spring Security Part II" />
<meta property="og:image" content="https://gravatar.com/avatar/ae671230e3a1c2a0eefa7604990084f1?s=200" />
<meta property="og:description" content="&lt;blockquote&gt;
 &lt;p&gt;Note: the source code and test for this blog continue to evolve, but the changes to the text are not being maintained here. Please see &lt;a href=&quot;https://spring.io/guides/tutorials/spring-security-and-angular-js/&quot;&gt;the tutorial version&lt;/a&gt; for the most up to date content.&lt;/p&gt; 
&lt;/blockquote&gt;
&lt;p&gt;In this article we continue &lt;a href=&quot;http://spring.io/blog/2015/01/12/spring-and-angular-js-a-secure-single-page-application&quot; title=&quot;First Article in the Series&quot;&gt;our discussion&lt;/a&gt; of how to use &lt;a href=&quot;http://projects.spring.io/spring-security&quot;&gt;Spring Security&lt;/a&gt; with &lt;a href=&quot;http://angularjs.org&quot;&gt;Angular JS&lt;/a&gt; in a “single page application”. Here we show how to use Angular JS to authenticate a user via a form and fetch a secure resource to render in the UI. This is the second in a series of articles, and you can catch up on the basic building blocks of the application or build it from scratch by reading the &lt;a href=&quot;http://spring.io/blog/2015/01/12/spring-and-angular-js-a-secure-single-page-application&quot; title=&quot;First Article in the Series&quot;&gt;first article&lt;/a&gt;, or you can just go straight to the &lt;a href=&quot;https://github.com/dsyer/spring-security-angular/tree/master/single&quot;&gt;source code in Github&lt;/a&gt;. In the first article we built a simple application that used HTTP Basic authentication to protect the backend resources. In this one we add a login form, give the user some control over whether to authenticate or not, and fix the issues with the first iteration (principally lack of CSRF protection).&lt;/p&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2015-01-12 12:20:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">The Login Page: Angular JS and Spring Security Part II</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/ae671230e3a1c2a0eefa7604990084f1?s=20&amp;d=mm" />
<a class="author" rel="author" href="/team/dsyer">Dave Syer</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2015-01-12 12:20:00.0">January 12, 2015</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="1904" href="/blog/2015/01/12/the-login-page-angular-js-and-spring-security-part-ii#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><blockquote><p>Note: the source code and test for this blog continue to evolve, but the changes to the text are not being maintained here. Please see <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/">the tutorial version</a> for the most up to date content.</p>
</blockquote><p>In this article we continue <a href="https://spring.io/blog/2015/01/12/spring-and-angular-js-a-secure-single-page-application" title="First Article in the Series">our discussion</a> of how to use <a href="https://projects.spring.io/spring-security">Spring Security</a> with <a href="http://angularjs.org">Angular JS</a> in a &ldquo;single page application&rdquo;. Here we show how to use Angular JS to authenticate a user via a form and fetch a secure resource to render in the UI. This is the second in a series of articles, and you can catch up on the basic building blocks of the application or build it from scratch by reading the <a href="https://spring.io/blog/2015/01/12/spring-and-angular-js-a-secure-single-page-application" title="First Article in the Series">first article</a>, or you can just go straight to the <a href="https://github.com/dsyer/spring-security-angular/tree/master/single">source code in Github</a>. In the first article we built a simple application that used HTTP Basic authentication to protect the backend resources. In this one we add a login form, give the user some control over whether to authenticate or not, and fix the issues with the first iteration (principally lack of CSRF protection).</p>
<blockquote><p>Reminder: if you are working through this article with the sample application, be sure to clear your browser cache of cookies and HTTP Basic credentials. In Chrome the best way to do that for a single server is to open a new incognito window.</p>
</blockquote><h2><a href="#add-navigation-to-the-home-page" class="anchor" name="add-navigation-to-the-home-page"></a>Add Navigation to the Home Page</h2><p>The core of a single page application is a static &ldquo;index.html&rdquo;. We already had a really basic one, but for this application we need to offer some navigation features (login, logout, home), so let&rsquo;s modify it (in &ldquo;src/main/resources/static&rdquo;):</p>
<pre><code class="prettyprint html">&lt;!doctype html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Hello AngularJS&lt;/title&gt;
&lt;link
	href=&quot;css/angular-bootstrap.css&quot;
	rel=&quot;stylesheet&quot;&gt;
&lt;style type=&quot;text/css&quot;&gt;
[ng\:cloak], [ng-cloak], .ng-cloak {
	display: none !important;
}
&lt;/style&gt;
&lt;/head&gt;

&lt;body ng-app=&quot;hello&quot; ng-cloak class=&quot;ng-cloak&quot;&gt;
	&lt;div ng-controller=&quot;navigation&quot; class=&quot;container&quot;&gt;
		&lt;ul class=&quot;nav nav-pills&quot; role=&quot;tablist&quot;&gt;
			&lt;li class=&quot;active&quot;&gt;&lt;a href=&quot;#/&quot;&gt;home&lt;/a&gt;&lt;/li&gt;
			&lt;li&gt;&lt;a href=&quot;#/login&quot;&gt;login&lt;/a&gt;&lt;/li&gt;
			&lt;li ng-show=&quot;authenticated&quot;&gt;&lt;a href=&quot;&quot; ng-click=&quot;logout()&quot;&gt;logout&lt;/a&gt;&lt;/li&gt;
		&lt;/ul&gt;
	&lt;/div&gt;
	&lt;div ng-view class=&quot;container&quot;&gt;&lt;/div&gt;
	&lt;script src=&quot;js/angular-bootstrap.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
	&lt;script src=&quot;js/hello.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><p>It&rsquo;s not much different than the original in fact. Salient features:</p>
<ul>
<li><p>There is a <code>&lt;ul&gt;</code> for the navigation bar. All the links come straight back to the home page, but in a way that Angular will recognize once we get it set up with &ldquo;routes&rdquo;.</p></li>
<li><p>All the content is going to be added as &ldquo;partials&rdquo; in the <code>&lt;div&gt;</code> labelled &ldquo;ng-view&rdquo;.</p></li>
<li><p>The &ldquo;ng-cloak&rdquo; has been moved up to the body because we want to hide the whole page until Angular can work out which bits to render. Otherwise the menus and content can &ldquo;flicker&rdquo; as they are moved around when the page loads.</p></li>
<li><p>As in the <a href="https://spring.io/blog/2015/01/12/spring-and-angular-js-a-secure-single-page-application" title="First Article in the Series">first article</a>, the front end assets &ldquo;angular-bootstrap.css&rdquo; and &ldquo;angular-bootstrap.js&rdquo; are generated from JAR libraries at build time.</p></li>
</ul><h2><a href="#add-navigation-to-the-angular-application" class="anchor" name="add-navigation-to-the-angular-application"></a>Add Navigation to the Angular Application</h2><p>Let&rsquo;s modify the &ldquo;hello&rdquo; application (in &ldquo;src/main/resources/public/js/hello.js&rdquo;) to add some navigation features. We can start by adding some configuration for routes, so that the links in the home page actually do something. E.g.</p>
<pre><code class="prettyprint javascript">angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39; ])
  .config(function($routeProvider, $httpProvider) {

	$routeProvider.when(&#39;/&#39;, {
		templateUrl : &#39;home.html&#39;,
		controller : &#39;home&#39;
	}).when(&#39;/login&#39;, {
		templateUrl : &#39;login.html&#39;,
		controller : &#39;navigation&#39;
	}).otherwise(&#39;/&#39;);

    $httpProvider.defaults.headers.common[&quot;X-Requested-With&quot;] = &#39;XMLHttpRequest&#39;;

  })
  .controller(&#39;home&#39;, function($scope, $http) {
    $http.get(&#39;/resource/&#39;).success(function(data) {
      $scope.greeting = data;
    })
  })
  .controller(&#39;navigation&#39;, function() {});
</code></pre><p>We added a dependency on an Angular module called <a href="https://docs.angularjs.org/api/ngRoute">&ldquo;ngRoute&rdquo;</a> and this allowed us to inject a magic <code>$routeProvider</code> into the config function (Angular does dependency injection by naming convention, and recognizes the names of your function parameters). The <code>$routeProvider</code> is then used inside the function to set up links to &ldquo;/&rdquo; (the &ldquo;home&rdquo; controller) and &ldquo;/login&rdquo; (the &ldquo;login&rdquo; controller). The &ldquo;templateUrls&rdquo; are relative paths from the root of the routes (i.e. &ldquo;/&rdquo;) to &ldquo;partial&rdquo; views that will be used to render the model created by each controller.</p><p>The custom &ldquo;X-Requested-With&rdquo; is a conventional header sent by browser clients, and it used to be the default in Angular but they <a href="https://github.com/angular/angular.js/issues/1004">took it out in 1.3.0</a>. Spring Security responds to it by not sending a &ldquo;WWW-Authenticate&rdquo; header in a 401 response, and thus the browser will not pop up an authentication dialog (which is desirable in our app since we want to control the authentication).</p><p>In order to use the &ldquo;ngRoute&rdquo; module, we need to add a line to the &ldquo;wro.xml&rdquo; configuration that builds the static assets (in &ldquo;src/main/wro&rdquo;):</p>
<pre><code class="prettyprint xml">&lt;groups xmlns=&quot;http://www.isdc.ro/wro&quot;&gt;
  &lt;group name=&quot;angular-bootstrap&quot;&gt;
    ...
    &lt;js&gt;webjar:angularjs/1.3.8/angular-route.min.js&lt;/js&gt;
   &lt;/group&gt;
&lt;/groups&gt;
</code></pre><h3><a href="#the-greeting" class="anchor" name="the-greeting"></a>The Greeting</h3><p>The greeting content from the old home page can go in &ldquo;home.html&rdquo; (right next to the &ldquo;index.html&rdquo; in &ldquo;src/main/resources/static&rdquo;):</p>
<pre><code class="prettyprint html">&lt;h1&gt;Greeting&lt;/h1&gt;
&lt;div ng-show=&quot;authenticated&quot;&gt;
	&lt;p&gt;The ID is {{greeting.id}}&lt;/p&gt;
	&lt;p&gt;The content is {{greeting.content}}&lt;/p&gt;
&lt;/div&gt;
&lt;div  ng-show=&quot;!authenticated&quot;&gt;
	&lt;p&gt;Login to see your greeting&lt;/p&gt;
&lt;/div&gt;
</code></pre><p>Since the user now has the choice whether to login or not (before it was all controlled by the browser), we need to distinguish in the UI between content that is secure and that which is not. We have anticipated this by adding references to an (as yet non-existent) <code>authenticated</code> variable.</p><h3><a href="#the-login-form" class="anchor" name="the-login-form"></a>The Login Form</h3><p>The login form goes in &ldquo;login.html&rdquo;:</p>
<pre><code class="prettyprint html">&lt;div class=&quot;alert alert-danger&quot; ng-show=&quot;error&quot;&gt;
	There was a problem logging in. Please try again.
&lt;/div&gt;
&lt;form role=&quot;form&quot; ng-submit=&quot;login()&quot;&gt;
	&lt;div class=&quot;form-group&quot;&gt;
		&lt;label for=&quot;username&quot;&gt;Username:&lt;/label&gt; &lt;input type=&quot;text&quot;
			class=&quot;form-control&quot; id=&quot;username&quot; name=&quot;username&quot; ng-model=&quot;credentials.username&quot;/&gt;
	&lt;/div&gt;
	&lt;div class=&quot;form-group&quot;&gt;
		&lt;label for=&quot;password&quot;&gt;Password:&lt;/label&gt; &lt;input type=&quot;password&quot;
			class=&quot;form-control&quot; id=&quot;password&quot; name=&quot;password&quot; ng-model=&quot;credentials.password&quot;/&gt;
	&lt;/div&gt;
	&lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;Submit&lt;/button&gt;
&lt;/form&gt;
</code></pre><p>This is a very standard login form, with 2 inputs for username and password and a button for submitting the form via <a href="https://docs.angularjs.org/api/ng/directive/ngSubmit"><code>ng-submit</code></a>. You don&rsquo;t need an action on the form tag, so it&rsquo;s probably better not to put one in at all. There is also an error message, shown only if the angular <code>$scope</code> contains an <code>error</code>. The form controls use <a href="https://docs.angularjs.org/api/ng/directive/ngModel"><code>ng-model</code></a> to pass data between the HTML and the Angular controller, and in this case we are using a <code>credentials</code> object to hold the username and pasword. According to the routes we defined the login form is linked with the &ldquo;navigation&rdquo; controller, which is so far empty, so let&rsquo;s head over to that to fill in some gaps.</p><h2><a href="#the-authentication-process" class="anchor" name="the-authentication-process"></a>The Authentication Process</h2><p>To support the login form we just added we need to add some more features. On the client side these will be implemented in the &ldquo;navigation&rdquo; controller, and on the server it will be Spring Security configuration.</p><h3><a href="#submitting-the-login-form" class="anchor" name="submitting-the-login-form"></a>Submitting the Login Form</h3><p>To submit the form we need to define the <code>login()</code> function that we referenced already in the form via <code>ng-submit</code>, and the <code>credentials</code> object that we referenced via <code>ng-model</code>. Let&rsquo;s flesh out the &ldquo;navigation&rdquo; controller in &ldquo;hello.js&rdquo; (omitting the routes config and the &ldquo;home&rdquo; controller):</p>
<pre><code class="prettyprint javascript">angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39; ]) // ... omitted code
.controller(&#39;navigation&#39;,

  function($rootScope, $scope, $http, $location) {

  var authenticate = function(credentials, callback) {

    var headers = credentials ? {authorization : &quot;Basic &quot;
        + btoa(credentials.username + &quot;:&quot; + credentials.password)
    } : {};

    $http.get(&#39;user&#39;, {headers : headers}).success(function(data) {
      if (data.name) {
        $rootScope.authenticated = true;
      } else {
        $rootScope.authenticated = false;
      }
      callback &amp;&amp; callback();
    }).error(function() {
      $rootScope.authenticated = false;
      callback &amp;&amp; callback();
    });

  }

  authenticate();
  $scope.credentials = {};
  $scope.login = function() {
      authenticate($scope.credentials, function() {
        if ($rootScope.authenticated) {
          $location.path(&quot;/&quot;);
          $scope.error = false;
        } else {
          $location.path(&quot;/login&quot;);
          $scope.error = true;
        }
      });
  };
});
</code></pre><p>All of the code in the &ldquo;navigation&rdquo; controller will be executed when the page loads because the <code>&lt;div&gt;</code> containing the menu bar is visible and is decorated with <code>ng-controller=&quot;navigation&quot;</code>. In addition to initializing the <code>credentials</code> object, it defines 2 functions, the <code>login()</code> that we need in the form, and a local helper function <code>authenticate()</code> which tries to load a &ldquo;user&rdquo; resource from the backend. The <code>authenticate()</code> function is called when the controller is loaded to see if the user is actually already authenticated (e.g. if he had refreshed the browser in the middle of a session). We need the <code>authenticate()</code> function to make a remote call because the actual authentication is done by the server, and we don&rsquo;t want to trust the browser to keep track of it.</p><p>The <code>authenticate()</code> function sets an application-wide flag called <code>authenticated</code> which we have already used in our &ldquo;home.html&rdquo; to control which parts of the page are rendered. We do this using <a href="https://docs.angularjs.org/api/ng/service/$rootScope"><code>$rootScope</code></a> because it&rsquo;s convenient and easy to follow, and we need to share the <code>authenticated</code> flag between the &ldquo;navigation&rdquo; and the &ldquo;home&rdquo; controllers. Angular experts might prefer to share data through a shared user-defined service (but it ends up being the same mechanism).</p><p>The <code>authenticate()</code> makes a GET to a relative resource (relative to the deployment root of your application) &ldquo;/user&rdquo;. When called from the <code>login()</code> function it adds the Base64-encoded credentials in the headers so on the server it does an authentication and accepts a cookie in return. The <code>login()</code> function also sets a local <code>$scope.error</code> flag accordingly when we get the result of the authentication, which is used to control the display of the error message above the login form.</p><h3><a href="#the-currently-authenticated-user" class="anchor" name="the-currently-authenticated-user"></a>The Currently Authenticated User</h3><p>To service the <code>authenticate()</code> function we need to add a new endpoint to the backend:</p>
<pre><code class="prettyprint java">@SpringBootApplication
@RestController
public class UiApplication {
  
  @RequestMapping(&quot;/user&quot;)
  public Principal user(Principal user) {
    return user;
  }

  ...

}
</code></pre><p>This is a useful trick in a Spring Security application. If the &ldquo;/user&rdquo; resource is reachable then it will return the currently authenticated user (an <a href="https://github.com/spring-projects/spring-security/blob/master/core/src/main/java/org/springframework/security/core/Authentication.java" title="Authentication"><code>Authentication</code></a>), and otherwise Spring Security will intercept the request and send a 401 response through an <a href="https://github.com/spring-projects/spring-security/blob/master/web/src/main/java/org/springframework/security/web/AuthenticationEntryPoint.java" title="AuthenticationEntryPoint"><code>AuthenticationEntryPoint</code></a>.</p><h3><a href="#handling-the-login-request-on-the-server" class="anchor" name="handling-the-login-request-on-the-server"></a>Handling the Login Request on the Server</h3><p>Spring Security makes it easy to handle the login request. We just need to add some configuration to our <a href="https://github.com/dsyer/spring-security-angular/blob/master/single/src/main/java/demo/UiApplication.java">main application class</a> (e.g. as an inner class):</p>
<pre><code class="prettyprint java">@SpringBootApplication
@RestController
public class UiApplication {

  ...

  @Configuration
  @Order(SecurityProperties.ACCESS_OVERRIDE_ORDER)
  protected static class SecurityConfiguration extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
      http
        .httpBasic()
      .and()
        .authorizeRequests()
          .antMatchers(&quot;/index.html&quot;, &quot;/home.html&quot;, &quot;/login.html&quot;, &quot;/&quot;).permitAll()
          .anyRequest().authenticated();
    }
  }

}
</code></pre><p>This is a standard Spring Boot application with Spring Security customization, just allowing anonymous access to the static (HTML) resources (the CSS and JS resources are already accessible by default). The HTML resources need to be available to anonymous users, not just ignored by Spring Security, for reasons that will become clear.</p><h2><a href="#csrf-protection" class="anchor" name="csrf-protection"></a>CSRF Protection</h2><p>The application is almost ready to use, but if you try running it you will find that the login form doesn&rsquo;t work. Look at the responses in the browser and you will see why:</p>
<pre><code class="prettyprint">POST /login HTTP/1.1
...
Content-Type: application/x-www-form-urlencoded

username=user&amp;password=password

HTTP/1.1 403 Forbidden
Set-Cookie: JSESSIONID=3941352C51ABB941781E1DF312DA474E; Path=/; HttpOnly
Content-Type: application/json;charset=UTF-8
Transfer-Encoding: chunked
...

{&quot;timestamp&quot;:1420467113764,&quot;status&quot;:403,&quot;error&quot;:&quot;Forbidden&quot;,&quot;message&quot;:&quot;Expected CSRF token not found. Has your session expired?&quot;,&quot;path&quot;:&quot;/login&quot;}
</code></pre><p>That&rsquo;s good because it means that Spring Security&rsquo;s built-in CSRF protection has kicked in to prevent us from shooting ourselves in the foot. All it wants is a token sent to it in a header called &ldquo;X-CSRF&rdquo;. The value of the CSRF token was available server side in the <code>HttpRequest</code> attributes from the initial request that loaded the home page. To get it to the client we could render it using a dynamic HTML page on the server, or expose it via a custom endpoint, or else we could send it as a cookie. The last choice is the best because Angular has <a href="https://docs.angularjs.org/api/ng/service/$http">built in support for CSRF</a> (which it calls &ldquo;XSRF&rdquo;) based on cookies.</p><p>So all we need on the server is a custom filter that will send the cookie. Angular wants the cookie name to be &ldquo;XSRF-TOKEN&rdquo; and Spring Security provides it as a request attribute, so we just need to transfer the value from a request attribute to a cookie:</p>
<pre><code class="prettyprint java">public class CsrfHeaderFilter extends OncePerRequestFilter {
  @Override
  protected void doFilterInternal(HttpServletRequest request,
      HttpServletResponse response, FilterChain filterChain)
      throws ServletException, IOException {
    CsrfToken csrf = (CsrfToken) request.getAttribute(CsrfToken.class
        .getName());
    if (csrf != null) {
      Cookie cookie = WebUtils.getCookie(request, &quot;XSRF-TOKEN&quot;);
      String token = csrf.getToken();
      if (cookie==null || token!=null &amp;&amp; !token.equals(cookie.getValue())) {
        cookie = new Cookie(&quot;XSRF-TOKEN&quot;, token);
        cookie.setPath(&quot;/&quot;);
        response.addCookie(cookie);
      }
    }
    filterChain.doFilter(request, response);
  }
}
</code></pre><p>To finish the job and make it completely generic we should be careful to set the cookie path to the context path of the application (instead of hard-coded to &ldquo;/&rdquo;), but this is good enough for the application we are working on. </p><p>We need to install this filter in the application somewhere, and it needs to go after the Spring Security <code>CsrfFilter</code> so that the request attribute is available. Since we have Spring Security protecting these resources there&rsquo;s no better place than in the Spring Security filter chain, e.g. extending the <code>SecurityConfiguration</code> above:</p>
<pre><code class="prettyprint java">@Configuration
@Order(SecurityProperties.ACCESS_OVERRIDE_ORDER)
protected static class SecurityConfiguration extends WebSecurityConfigurerAdapter {
  @Override
  protected void configure(HttpSecurity http) throws Exception {
    http
      .httpBasic().and()
      .authorizeRequests()
        .antMatchers(&quot;/index.html&quot;, &quot;/home.html&quot;, &quot;/login.html&quot;, &quot;/&quot;).permitAll().anyRequest()
        .authenticated().and()
      .addFilterAfter(new CsrfHeaderFilter(), CsrfFilter.class);
  }
}
</code></pre><p>The other thing we have to do on the server is tell Spring Security to expect the CSRF token in the format that Angular wants to send it back (a header called &ldquo;X-XRSF-TOKEN&rdquo; instead of the default &ldquo;X-CSRF-TOKEN&rdquo;). We do this by customizing the CSRF filter:</p>
<pre><code class="prettyprint java">@Override
protected void configure(HttpSecurity http) throws Exception {
  http
    .httpBasic().and()
    ...
    .csrf().csrfTokenRepository(csrfTokenRepository());
}

private CsrfTokenRepository csrfTokenRepository() {
  HttpSessionCsrfTokenRepository repository = new HttpSessionCsrfTokenRepository();
  repository.setHeaderName(&quot;X-XSRF-TOKEN&quot;);
  return repository;
}
</code></pre><p>With those changes in place we don&rsquo;t need to do anything on the client side and the login form is now working.</p><h2><a href="#logout" class="anchor" name="logout"></a>Logout</h2><p>The application is almost finished functionally. The last thing we need to do is implement the logout feature that we sketched in the home page. Here&rsquo;s a reminder what the navigation bar looks like:</p>
<pre><code class="prettyprint html">&lt;div ng-controller=&quot;navigation&quot; class=&quot;container&quot;&gt;
  &lt;ul class=&quot;nav nav-pills&quot; role=&quot;tablist&quot;&gt;
    &lt;li class=&quot;active&quot;&gt;&lt;a href=&quot;#/&quot;&gt;home&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&quot;#/login&quot;&gt;login&lt;/a&gt;&lt;/li&gt;
    &lt;li ng-show=&quot;authenticated&quot;&gt;&lt;a href=&quot;&quot; ng-click=&quot;logout()&quot;&gt;logout&lt;/a&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/div&gt;
</code></pre><p>If the user is authenticated then we show a &ldquo;logout&rdquo; link and hook it to a <code>logout()</code> function in the &ldquo;navigation&rdquo; controller. The implementation of the function is relatively simple:</p>
<pre><code class="prettyprint javascript">angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39; ]). 
// ...
.controller(&#39;navigation&#39;, function(...) {

...

$scope.logout = function() {
  $http.post(&#39;logout&#39;, {}).success(function() {
    $rootScope.authenticated = false;
    $location.path(&quot;/&quot;);
  }).error(function(data) {
    $rootScope.authenticated = false;
  });
}

...

});
</code></pre><p>It sends an HTTP POST to &ldquo;/logout&rdquo; which we now need to implement on the server. This is straightforward:</p>
<pre><code class="prettyprint java">@Override
protected void configure(HttpSecurity http) throws Exception {
  http
    ...
  .and()
    .logout()
    ...
  ;
}
</code></pre><p>(we just added <code>.logout()</code> to the <code>HttpSecurity</code> configuration builder).</p><h2><a href="#how-does-it-work" class="anchor" name="how-does-it-work"></a>How Does it Work?</h2><p>The interactions between the browser and the backend can be seen in your browser if you use some developer tools (usually F12 opens this up, works in Chrome by default, requires a plugin in Firefox). Here&rsquo;s a summary:</p>
<table>
<thead>
<tr>
<th>Verb </th>
<th>Path </th>
<th>Status </th>
<th>Response</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET </td>
<td>/ </td>
<td>200 </td>
<td>index.html</td>
</tr>
<tr>
<td>GET </td>
<td>/css/angular-bootstrap.css </td>
<td>200 </td>
<td>Twitter bootstrap CSS</td>
</tr>
<tr>
<td>GET </td>
<td>/js/angular-bootstrap.js </td>
<td>200 </td>
<td>Bootstrap and Angular JS</td>
</tr>
<tr>
<td>GET </td>
<td>/js/hello.js </td>
<td>200 </td>
<td>Application logic</td>
</tr>
<tr>
<td>GET </td>
<td>/user </td>
<td>401 </td>
<td>Unauthorized</td>
</tr>
<tr>
<td>GET </td>
<td>/home.html </td>
<td>200 </td>
<td>Home page</td>
</tr>
<tr>
<td>GET </td>
<td>/resource </td>
<td>401 </td>
<td>Unauthorized</td>
</tr>
<tr>
<td>GET </td>
<td>/login.html </td>
<td>200 </td>
<td>Angular login form partial</td>
</tr>
<tr>
<td>GET </td>
<td>/user </td>
<td>401 </td>
<td>Unauthorized</td>
</tr>
<tr>
<td>GET </td>
<td>/user </td>
<td>200 </td>
<td>Send credentials and get JSON</td>
</tr>
<tr>
<td>GET </td>
<td>/resource </td>
<td>200 </td>
<td>JSON greeting</td>
</tr>
</tbody>
</table><p>The responses that are marked &ldquo;ignored&rdquo; above are HTML responses received by Angular in an XHR call, and since we aren&rsquo;t processing that data the HTML is dropped on the floor. We do look for an authenticated user in the case of the &ldquo;/user&rdquo; resource, but since it isn&rsquo;t there in the first call, that response is dropped.</p><p>Look more closely at the requests and you will see that they all have cookies. If you start with a clean browser (e.g. incognito in Chrome), the very first request has no cookies going off to the server, but the server sends back &ldquo;Set-Cookie&rdquo; for &ldquo;JSESSIONID&rdquo; (the regular <code>HttpSession</code>) and &ldquo;X-XSRF-TOKEN&rdquo; (the CRSF cookie that we set up above). Subsequent requests all have those cookies, and they are important: the application doesn&rsquo;t work without them, and they are providing some really basic security features (authentication and CSRF protection). The values of the cookies change when the user authenticates (after the POST) and this is another important security feature (preventing <a href="https://en.wikipedia.org/wiki/Session_fixation">session fixation attacks</a>).</p>
<blockquote><p>Note: it is not adequate for CSRF protection to rely on a cookie being sent back to the server because the browser will automatically send it even if you are not in a page loaded from your application (a Cross Site Scripting attack, otherwise known as <a href="https://en.wikipedia.org/wiki/Cross-site_scripting">XSS</a>). The header is not automatically sent, so the origin is under control. You might see that in our application the CSRF token is sent to the client as a cookie, so we will see it being sent back automatically by the browser, but it is the header that provides the protection.</p>
</blockquote><h2><a href="#help-how-is-my-application-going-to-scale" class="anchor" name="help-how-is-my-application-going-to-scale"></a>Help, How is My Application Going to Scale?</h2><p>&ldquo;But wait&hellip;&rdquo; you are saying, &ldquo;isn&rsquo;t it Really Bad to use session state in a single-page application?&rdquo; The answer to that question is going to have to be &ldquo;mostly&rdquo;, because it very definitely is a Good Thing to use the session for authentication and CSRF protection. That state has to be stored somewhere, and if you take it out of the session, you are going to have to put it somewhere else and manage it manually yourself, on both the server and the client. That&rsquo;s just more code and probably more maintenance, and generally re-inventing a perfectly good wheel.</p><p>&ldquo;But, but&hellip;&rdquo; you are going to respond, &ldquo;how do I scale my application horizontally now?&rdquo; This is the &ldquo;real&rdquo; question you were asking above, but it tends to get shortened to &ldquo;session state is bad, I must be stateless&rdquo;. Don&rsquo;t panic. The main point to take on board here is that security <em>is</em> stateful. You can&rsquo;t have a secure, stateless application. So where are you going to store the state? That&rsquo;s all there is to it. <a href="https://spring.io/team/rwinch">Rob Winch</a> gave a very useful and insightful talk at <a href="https://skillsmatter.com/skillscasts/5398-the-state-of-securing-restful-apis-with-spring">Spring Exchange 2014</a> explaining the need for state (and the ubiquity of it - TCP and SSL are stateful, so your system is stateful whether you knew it or not), which is probably worth a look if you want to look into this topic in more depth.</p><p>The good news is you have a choice. The easiest choice is to store the session data in-memory, and rely on sticky sessions in your load balancer to route requests from the same session back to the same JVM (they all support that somehow). That&rsquo;s good enough to get you off the ground and will work for a <em>really</em> large number of use cases. The other choice is to share the session data between instances of your application. As long as you are strict and only store the security data, it is small and changes infrequently (only when users log in and out, or their session times out), so there shouldn&rsquo;t be any major infrastructure problems. It&rsquo;s also really easy to do with <a href="https://github.com/spring-projects/spring-session/">Spring Session</a>. We&rsquo;ll be using Spring Session in the next article in this series, so there&rsquo;s no need to go into any detail about how to set it up here, but it is literally a few lines of code and a Redis server, which is super fast.</p>
<blockquote><p>Tip: another easy way to set up shared session state is to deploy your application as a WAR file to Cloud Foundry <a href="https://run.pivotal.io">Pivotal Web Services</a> and bind it to a Redis service.</p>
</blockquote><h2><a href="#but-what-about-my-custom-token-implementation-it-rsquo-s-stateless-look" class="anchor" name="but-what-about-my-custom-token-implementation-it-rsquo-s-stateless-look"></a>But, What about My Custom Token Implementation (it&rsquo;s Stateless, Look)?</h2><p>If that was your response to the last section, then read it again because maybe you didn&rsquo;t get it the first time. It&rsquo;s probably not stateless if you stored the token somewhere, but even if you didn&rsquo;t (e.g. you use JWT encoded tokens), how are you going to provide CSRF protection? It&rsquo;s important. Here&rsquo;s a rule of thumb (attributed to Rob Winch): if your application or API is going to be accessed by a browser, you need CSRF protection. It&rsquo;s not that you can&rsquo;t do it without sessions, it&rsquo;s just that you&rsquo;d have to write all that code yourself, and what would be the point because it&rsquo;s already implemented and works perfectly well on top of <code>HttpSession</code> (which in turn is part of the container you are using and baked into specs since the very beginning)? Even if you decide you don&rsquo;t need CSRF, and have a perfectly &ldquo;stateless&rdquo; (non-session based) token implementation, you still had to write extra code in the client to consume and use it, where you could have just delegated to the browser and server&rsquo;s own built-in features: the browser always sends cookies, and the server always has a session (unless you switch it off). That code is not business logic, and it isn&rsquo;t making you any money, it&rsquo;s just an overhead, so even worse, it costs you money.</p><h2><a href="#conclusion" class="anchor" name="conclusion"></a>Conclusion</h2><p>The application we have now is close to what a user might expect in a &ldquo;real&rdquo; application in a live environment, and it probably could be used as a template for building out into a more feature rich application with that architecture (single server with static content and JSON resources). We are using the <code>HttpSession</code> for storing security data, relying on our clients to respect and use the cookies we send them, and we are comfortable with that because it lets us concentrate on our own business domain. In the <a href="https://spring.io/blog/2015/01/20/the-resource-server-angular-js-and-spring-security-part-iii" title="Third Article in the Series">next article</a> we expand the architecture to a separate authentication and UI server, plus a standalone resource server for the JSON. This is obviously easily generalised to multiple resource servers. We are also going to introduce Spring Session into the stack and show how that can be used to share authentication data.</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 1904;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>