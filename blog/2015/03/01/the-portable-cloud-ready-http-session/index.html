<html dir="ltr" data-code-prettify="" data-mobile-support="" data-search=""><head>
<title>可移植的，支持云的HTTP会话</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>System.config({baseURL: "/b92013b"});</script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>System.import('app/main.js')</script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="The Portable, Cloud-Ready HTTP Session">
<meta name="twitter:description" class="anchor" content="<h2><a href=" #a-framework-for-all-seasons-and-architecture="="></head><body dir="ltr">A Framework for all Seasons (and Architectures)
<p>Spring walks an interesting line. It provides a lot of value no matter where you run it, and - because it’s built on dependency injection layer - it offers a natural piece of indirection between the underlying layer and the applications that run on top of it. This indirection promotes code portability through decoupling: your application code is ignorant of where the <code>javax.sql.DataSource</code> (or whatever) handle it’s using comes from, be it a JNDI lookup, environment variables, or a simple new’d-up bean provided by Spring. This decoupling and the rich toolbox of features on top of Spring supporting all manner of use cases - batch processing, integration, stream processing, web services, microservices, operations, web applications, security, etc. - have made Spring a logical choice for developers deploying to (sometimes-embedded) web containers like Apache Tomcat or Eclipse Jetty, to application servers like WebSphere and WildFly, and to cloud runtimes like Google App Engine, Heroku, OpenShift, and (my personal favorite these days) Cloud Foundry. This portability is <em>also</em> what makes it easy to forklift most (reasonably-written!) applications from the application servers into lighter web containers and, ultimately, into the cloud.</p>
">
<meta name="twitter:creator" content="@starbuxman">
<meta name="twitter:image:src" content="https://gravatar.com/avatar/fb22593caf24e4bb4c98d467cdd247e6?s=200">

<meta property="og:title" content="The Portable, Cloud-Ready HTTP Session">
<meta property="og:image" content="https://gravatar.com/avatar/fb22593caf24e4bb4c98d467cdd247e6?s=200">
<meta class="anchor" name="a-framework-for-all-seasons-and-architectures" property="og:description" content="<h2><a href=" #a-framework-for-all-seasons-and-architecture="=">A Framework for all Seasons (and Architectures)
<p>Spring walks an interesting line. It provides a lot of value no matter where you run it, and - because it’s built on dependency injection layer - it offers a natural piece of indirection between the underlying layer and the applications that run on top of it. This indirection promotes code portability through decoupling: your application code is ignorant of where the <code>javax.sql.DataSource</code> (or whatever) handle it’s using comes from, be it a JNDI lookup, environment variables, or a simple new’d-up bean provided by Spring. This decoupling and the rich toolbox of features on top of Spring supporting all manner of use cases - batch processing, integration, stream processing, web services, microservices, operations, web applications, security, etc. - have made Spring a logical choice for developers deploying to (sometimes-embedded) web containers like Apache Tomcat or Eclipse Jetty, to application servers like WebSphere and WildFly, and to cloud runtimes like Google App Engine, Heroku, OpenShift, and (my personal favorite these days) Cloud Foundry. This portability is <em>also</em> what makes it easy to forklift most (reasonably-written!) applications from the application servers into lighter web containers and, ultimately, into the cloud.</p>
">
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2015-03-01 23:51:00.0">



<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">// Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }</script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">可移植的，支持云的HTTP会话</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/fb22593caf24e4bb4c98d467cdd247e6?s=20&d=mm"> <a class="author" rel="author" href="/team/jlong">乔什·朗（Josh Long）</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2015-03-01 23:51:00.0">2015年3月1日</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2015/03/01/the-portable-cloud-ready-http-session#disqus_thread" data-disqus-identifier="2002">
</a></div>
</div>
</header>
<div class="blog--post"><h2><a href="#a-framework-for-all-seasons-and-architectures" class="anchor" name="a-framework-for-all-seasons-and-architectures"></a>适用于所有季节的框架（和体系结构）</h2><p>春天走了一条有趣的路线。无论它在哪里运行，它都提供了很多价值；而且-因为它是建立在依赖注入层上的，所以它在基础层和在其之上运行的应用程序之间提供了自然的间接。这种间接方式通过解耦来提高代码的可移植性：您的应用程序代码不知道<code>javax.sql.DataSource</code> （或其他）句柄来自JNDI查找，环境变量或Spring提供的简单的new-d-up bean。Spring的这种脱钩和丰富的功能工具箱支持各种用例（批处理，集成，流处理，Web服务，微服务，操作，Web应用程序，安全性等），这使Spring成为开发人员的合理选择部署到（有时是嵌入式的）Web容器（例如Apache Tomcat或Eclipse Jetty），应用程序服务器（例如WebSphere和WildFly）以及云运行时（例如Google App Engine，Heroku，OpenShift和（今天我个人最喜欢的）Cloud Foundry）。这种便携性<em>也</em>使叉车最容易（合理编写！）从应用程序服务器到轻量级的Web容器，最终到云中的应用程序。</p><h2><a href="#the-stateful-fly-in-the-ointment" class="anchor" name="the-stateful-fly-in-the-ointment"></a>美中不足的是</h2><p>所以有什么问题？为什么要写这个博客呢？</p><p>但是，对于使用HTTP会话的应用程序来说，情况并不理想。扩展HTTP会话才是问题所在，请原谅HTTP会话术语“ pun- <em>sticky”</em> 。您将看到应用程序扩展HTTP会话需要完成两件事：会话亲和力和会话复制。会话相似性（或<em>粘性会话</em> ）意味着对集群Web应用程序的请求将被路由到最初发出HTTP会话cookie的节点。如果该应用程序实例应脱机，则会话复制可确保相关状态在另一个节点上可用。客户端可以无缝路由到那里，保留所有对话状态的概念。这并不是<em>说</em>很难在流行的容器配置HTTP会话复制。这是有关<a href="https://tomcat.apache.org/tomcat-6.0-doc/cluster-howto.html">使用Apache Tomcat</a>进行设置的页面，以及有关如何使用<a href="https://www.eclipse.org/jetty/documentation/9.2.3.v20140905/session-clustering-jdbc.html">Jetty</a>进行设置的页面。典型的会话复制策略涉及使用多播网络通知群集状态更改中的其他节点。在只有几个节点的小型环境中，会话亲和力和会话复制效果很好。除非您使用嵌入式Web容器，否则配置HTTP会话复制是需要在容器中配置的另一件事，而不是应用程序的控制范围。</p><h2><a href="#that-rsquo-s-ok-the-cloud-rsquo-ll-fix-it-right" class="anchor" name="that-rsquo-s-ok-the-cloud-rsquo-ll-fix-it-right"></a>没关系，云将修复它，对吧？</h2><p>您可能会认为-将应用程序移至云中后，这种配置（如果没有其他设置）将变得更容易且更可预测，但实际上可能会更加痛苦！在包括Amazon Web Services在内的大多数云环境中，组播网络都是不容错过的。即使在像Heroku或Cloud Foundry这样的更高级别，更以应用程序为中心的平台即服务环境中，会话复制也不是那么容易。例如，Heroku <a href="https://devcenter.heroku.com/articles/intro-for-java-developers">不提供会话亲缘关系，也不提供会话复制</a> 。这种限制是可以理解的：除了多播网络的限制外，应用程序应（尽可能）使服务器端状态最小化。请记住，Heroku将应用程序的RAM限制为512MB！如果您不尝试将备用RAM视为数据库或持久层，这已绰绰有余！就Cloud Foundry而言，它为更大的开发人员社区提供服务，并在各种数据中心内本地运行，因此它必须更加实用。例如，Pivotal Web服务（运行<a href="http://cloudfoundry.org">Cloud Foundry</a> ）为应用程序提供1GB的RAM，并且它已经提供了几年的会话亲和力。直到去年下半年，当对buildpack的更改启用了对<a href="https://blog.pivotal.io/cloud-foundry-pivotal/products/session-replication-on-cloud-foundry-2">部署到Apache Tomcat Web服务器的默认独立配置的</a>任何基于<code>.war</code>的Web应用程序的会话复制时，它才提供会话复制。但是，此支持不使用多播网络。相反，它使用配置任何绑定的Redis备份服务以与Tomcat容器的会话复制策略结合使用的约定。实际上，使用像Redis这样的支持服务，或者也许是一些共享文件系统，实际上是在云中进行会话复制的唯一明智的方法。</p><p>所有这些方法都有不同的权衡：</p>
<ul>
<li>有些是特定于容器的，这意味着它们不会轻易从一种环境迁移到另一种环境。</li>
<li>他们可能会增加操作的复杂性（如果您仍然有该团队！）这在应用程序和生产之间引入了更多的摩擦</li>
<li>他们可能会使用在云环境中无法正常运行的mutlicast网络</li>
<li>他们可能依赖Cloud Foundry Java buildpack之类的<em>魔术</em> ，该<em>魔术</em>只知道部署到独立Apache Tomcat的<code>.war</code> ，而不是嵌入式<code>.jar</code>或实际上其他网络容器（如Jetty）。</li>
<li>所有其他这些点的隐含限制是持久性策略不可插入。组播不适合您吗？太好了，使用Redis。Redis是否不适合您，并且想使用Memcache或其他不易获得的支持？哦…</li>
</ul><h2><a href="#enter-spring-session" class="anchor" name="enter-spring-session"></a>进入春季会议</h2><p>Spring Session为所有这些问题提供了一个非常好的解决方案。它是标准Servlet HTTP会话抽象的包装。轻松插入任何应用程序，无论它们是否基于Spring。它充当HTTP会话前面的代理，将请求转发到策略实现。开箱即用，有一个支持使用<code>java.util.Map<K,V></code>以及与Redis直接兼容的另一个。使用<code>java.util.Map<K,V></code></p><p><code>java.util.Map<K,V></code></p><p><code>java.util.Map<K,V></code></p><code>java.util.Map<K,V></code></div><code>java.util.Map<K,V></code></div><code>java.util.Map<K,V></code></article><code>java.util.Map<K,V></code></div><code>java.util.Map<K,V></code></div><code>java.util.Map<K,V></code></div><code>java.util.Map<K,V></code></div><code>java.util.Map<K,V></code></body></html>