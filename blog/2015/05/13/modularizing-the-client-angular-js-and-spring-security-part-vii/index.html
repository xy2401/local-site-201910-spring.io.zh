<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Modularizing the Client: Angular JS and Spring Security Part VII</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Modularizing the Client: Angular JS and Spring Security Part VII" />
<meta name="twitter:description" content="&lt;p&gt;In this article we continue &lt;a href=&quot;https://spring.io/blog/2015/03/23/multiple-ui-applications-and-a-gateway-single-page-application-with-spring-and-angular-js-part-vi&quot; title=&quot;Sixth Article in the Series&quot;&gt;our discussion&lt;/a&gt; of how to use &lt;a href=&quot;http://projects.spring.io/spring-security&quot;&gt;Spring Security&lt;/a&gt; with &lt;a href=&quot;http://angularjs.org&quot;&gt;Angular JS&lt;/a&gt; in a “single page application”. Here we show how to modularize the client-side code, and how to use “nice” URL paths without the fragment notation (e.g. “/#/login”) which Angular uses by default, but most users dislike. This is the seventh in a series of articles, and you can catch up on the basic building blocks of the application or build it from scratch by reading the &lt;a href=&quot;https://spring.io/blog/2015/01/12/spring-and-angular-js-a-secure-single-page-application&quot; title=&quot;First Article in the Series&quot;&gt;first article&lt;/a&gt;, or you can just go straight to the &lt;a href=&quot;https://github.com/dsyer/spring-security-angular/tree/master/modular&quot;&gt;source code in Github&lt;/a&gt;. We will be able to tidy up a lot of loose ends from the JavaScript code of the rest of this series, and at the same time show how it can fit very snugly against a backend server built from Spring Security and Spring Boot.&lt;/p&gt;
" />
<meta name="twitter:creator" content="@david_syer" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/ae671230e3a1c2a0eefa7604990084f1?s=200" />

<meta property="og:title" content="Modularizing the Client: Angular JS and Spring Security Part VII" />
<meta property="og:image" content="https://gravatar.com/avatar/ae671230e3a1c2a0eefa7604990084f1?s=200" />
<meta property="og:description" content="&lt;p&gt;In this article we continue &lt;a href=&quot;https://spring.io/blog/2015/03/23/multiple-ui-applications-and-a-gateway-single-page-application-with-spring-and-angular-js-part-vi&quot; title=&quot;Sixth Article in the Series&quot;&gt;our discussion&lt;/a&gt; of how to use &lt;a href=&quot;http://projects.spring.io/spring-security&quot;&gt;Spring Security&lt;/a&gt; with &lt;a href=&quot;http://angularjs.org&quot;&gt;Angular JS&lt;/a&gt; in a “single page application”. Here we show how to modularize the client-side code, and how to use “nice” URL paths without the fragment notation (e.g. “/#/login”) which Angular uses by default, but most users dislike. This is the seventh in a series of articles, and you can catch up on the basic building blocks of the application or build it from scratch by reading the &lt;a href=&quot;https://spring.io/blog/2015/01/12/spring-and-angular-js-a-secure-single-page-application&quot; title=&quot;First Article in the Series&quot;&gt;first article&lt;/a&gt;, or you can just go straight to the &lt;a href=&quot;https://github.com/dsyer/spring-security-angular/tree/master/modular&quot;&gt;source code in Github&lt;/a&gt;. We will be able to tidy up a lot of loose ends from the JavaScript code of the rest of this series, and at the same time show how it can fit very snugly against a backend server built from Spring Security and Spring Boot.&lt;/p&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2015-05-13 14:50:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Modularizing the Client: Angular JS and Spring Security Part VII</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/ae671230e3a1c2a0eefa7604990084f1?s=20&amp;d=mm" />
<a class="author" rel="author" href="/team/dsyer">Dave Syer</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2015-05-13 14:50:00.0">May 13, 2015</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="2084" href="/blog/2015/05/13/modularizing-the-client-angular-js-and-spring-security-part-vii#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><p>In this article we continue <a href="https://spring.io/blog/2015/03/23/multiple-ui-applications-and-a-gateway-single-page-application-with-spring-and-angular-js-part-vi" title="Sixth Article in the Series">our discussion</a> of how to use <a href="https://projects.spring.io/spring-security">Spring Security</a> with <a href="http://angularjs.org">Angular JS</a> in a &ldquo;single page application&rdquo;. Here we show how to modularize the client-side code, and how to use &ldquo;nice&rdquo; URL paths without the fragment notation (e.g. &ldquo;/#/login&rdquo;) which Angular uses by default, but most users dislike. This is the seventh in a series of articles, and you can catch up on the basic building blocks of the application or build it from scratch by reading the <a href="https://spring.io/blog/2015/01/12/spring-and-angular-js-a-secure-single-page-application" title="First Article in the Series">first article</a>, or you can just go straight to the <a href="https://github.com/dsyer/spring-security-angular/tree/master/modular">source code in Github</a>. We will be able to tidy up a lot of loose ends from the JavaScript code of the rest of this series, and at the same time show how it can fit very snugly against a backend server built from Spring Security and Spring Boot.</p><h2><a href="#breaking-up-the-application" class="anchor" name="breaking-up-the-application"></a>Breaking up the Application</h2><p>The sample application that we worked with so far in this series was trivial enough that we could get away with a single JavaScript source file for the whole thing. No larger application will ever end up that way, even if it starts out life like this one, so to mimic real life in a sample we are going to break things up. A good starting point would be to take the &ldquo;single&rdquo; application from <a href="https://spring.io/blog/2015/01/12/the-login-page-angular-js-and-spring-security-part-ii" title="Second Article in the Series">Part II</a> and have a look at its structure in the source code. Here&rsquo;s a directory listing for the static content (excluding the &ldquo;application.yml&rdquo; that belongs on the server):</p>
<pre><code class="prettyprint">static/
 js/
   hello.js
 home.html
 login.html
 index.html
</code></pre><p>There are a few problems with this. One is obvious: all the JavaScript is in a single file (<code>hello.js</code>). Another is more subtle: we have HTML &ldquo;partials&rdquo; for views inside our application (&ldquo;login.html&rdquo; and &ldquo;home.html&rdquo;) but they are all in a flat structure and not associated with the controller code that uses them.</p><p>Let&rsquo;s take a closer look at the JavaScript and we will see that Angular makes it easy for us to break it up into more manageable pieces:</p>
<pre><code class="prettyprint">angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39; ]).config(

  function($routeProvider, $httpProvider) {

    $routeProvider.when(&#39;/&#39;, {
      templateUrl : &#39;home.html&#39;,
      controller : &#39;home&#39;
    }).when(&#39;/login&#39;, {
      templateUrl : &#39;login.html&#39;,
      controller : &#39;navigation&#39;
    }).otherwise(&#39;/&#39;);

    ...

}).controller(&#39;navigation&#39;,
    function($rootScope, $scope, $http, $location, $route) {
      ...
}).controller(&#39;home&#39;, function($scope, $http) {
    ...
  })
});
</code></pre><p>There is some &ldquo;config&rdquo; and there are 2 controllers (&ldquo;home&rdquo; and &ldquo;navigation&rdquo;), and the controllers seem to map nicely to the partials (&ldquo;home.html&rdquo; and &ldquo;login.html&rdquo; respectively). So let&rsquo;s break them out into those pieces:</p>
<pre><code class="prettyprint">static/
  js/
    home/
      home.js
      home.html
    navigation/
      navigation.js
      login.html
    hello.js
  index.html
</code></pre><p>The controller definitions have moved into their own modules, alongside the HTML that they need to operate - nice and modular. If we had needed images or custom stylesheets we would have done the same with those.</p>
<blockquote><p>Note: all the client-side code is under a single directory, &ldquo;js&rdquo; (except <code>index.html</code> because that is a &ldquo;welcome&rdquo; page and loads automatically from the &ldquo;static&rdquo; directory). This is intentional because it makes it easy to apply a single Spring Security access rule to all the static resources. These ones are all unsecured (because <code>/js/**</code> is unsecure by default in a Spring Boot application), but you might need other rules for other applications, in which case you would pick a different path.</p>
</blockquote><p>For example, here&rsquo;s the <code>home.js</code>:</p>
<pre><code class="prettyprint javascript">angular.module(&#39;home&#39;, []).controller(&#39;home&#39;, function($scope, $http) {
	$http.get(&#39;/user/&#39;).success(function(data) {
		$scope.user = data.name;
	});
});
</code></pre><p>and here&rsquo;s the new <code>hello.js</code>:</p>
<pre><code class="prettyprint javascript">angular
    .module(&#39;hello&#39;, [ &#39;ngRoute&#39;, &#39;home&#39;, &#39;navigation&#39; ])
    .config(

        function($routeProvider, $httpProvider) {

          $routeProvider.when(&#39;/&#39;, {
            templateUrl : &#39;js/home/home.html&#39;,
            controller : &#39;home&#39;
          }).when(&#39;/login&#39;, {
            templateUrl : &#39;js/navigation/login.html&#39;,
            controller : &#39;navigation&#39;
          }).otherwise(&#39;/&#39;);

          $httpProvider.defaults.headers.common[&#39;X-Requested-With&#39;] = &#39;XMLHttpRequest&#39;;

        });
</code></pre><p>Notice how the &ldquo;hello&rdquo; module <em>depends on</em> the other two by listing them in the initial declaration along with <code>ngRoute</code>. To make that work you just need to load the module definitions in the right order in <code>index.html</code>:</p>
<pre><code class="prettyprint html">...
&lt;script src=&quot;js/angular-bootstrap.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;js/home/home.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;js/navigation/navigation.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;js/hello.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
...
</code></pre><p>This is the Angular JS dependency management system in action. Other frameworks have similar (and arguably superior) features. Also, in a larger application, you might use a build time step to bundle all the JavaScript together so it can be loaded efficiently by the browser, but that&rsquo;s almost a matter of taste.</p><h2><a href="#using-ldquo-natural-rdquo-routes" class="anchor" name="using-ldquo-natural-rdquo-routes"></a>Using &ldquo;Natural&rdquo; Routes</h2><p>The Angular <code>$routeProvider</code> by default works with fragment locators in the URL path, e.g. the login page is specified as a route in <code>hello.js</code> as &ldquo;/login&rdquo; and this translates into &ldquo;/#/login&rdquo; in the actual URL (the one you see in the browser window). This is so that the JavaScript in the <code>index.html</code>, loaded via the root path &ldquo;/&rdquo;, stays active on all routes. The fragment naming is a bit unfamiliar to users and it is sometimes more convenient to use &ldquo;natural&rdquo; routes, where the URL path is the same as the Angular route declarations, e.g. &ldquo;/login&rdquo; for &ldquo;/login&rdquo;. You can&rsquo;t do that if you have <em>only</em> static resources, because <code>index.html</code> can only be loaded one way, but if you have some active components in the stack (a proxy or some server-side logic) then you can arrange for it to work by loading <code>index.html</code> from all the Angular routes.</p><p>In this series you have Spring Boot, so of course you have server-side logic, and using a simple Spring MVC controller you can naturalize the routes in your application. All you need is a a way to enumerate the Angular routes in the server. Here we choose to do it by a naming convention: all paths that do not contain a period (and are not explicitly mapped already) are Angular routes, and should forward to the home page:</p>
<pre><code class="prettyprint java">@RequestMapping(value = &quot;/{[path:[^\\.]*}&quot;)
public String redirect() {
  return &quot;forward:/&quot;;
}
</code></pre><p>This method just needs to be in a <code>@Controller</code> (not a <code>@RestController</code>) somewhere in the Spring application. We use a &ldquo;forward&rdquo; (not a &ldquo;redirect&rdquo;) so that the browser remembers the &ldquo;real&rdquo; route, and that&rsquo;s what the user sees in the URL. It also means that any saved-request mechanisms around authentication in Spring Security would work out of the box, although we won&rsquo;t be taking advantage of that in this application.</p>
<blockquote><p>Note: the application in the sample code <a href="https://github.com/dsyer/spring-security-angular/tree/master/modular">in github</a> has an extra route, so you can see a slightly more fully featured, and therefore hopefully realistic, application (&ldquo;/home&rdquo; and &ldquo;/message&rdquo; are different modules with slightly different views).</p>
</blockquote><p>To complete the application with &ldquo;natural&rdquo; routes, you need to tell Angular about it. There are two steps. First, in <code>hello.js</code> you add a line to the <code>config</code> function setting the &ldquo;HTML5 mode&rdquo; in the <code>$locationProvider</code>:</p>
<pre><code class="prettyprint javascript">angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39;, &#39;home&#39;, &#39;navigation&#39; ]).config(

  function($locationProvider, $routeProvider, $httpProvider) {

    $locationProvider.html5Mode(true);
    ...
});
</code></pre><p>Coupled with that you need an extra <code>&lt;base/&gt;</code> element in the header of the HTML in <code>index.html</code>, and you need to change the links in the menu bar to remove the fragments (&ldquo;#&rdquo;):</p>
<pre><code class="prettyprint html">&lt;html&gt;
&lt;head&gt;
&lt;base href=&quot;/&quot; /&gt;
...
&lt;/head&gt;
&lt;body ng-app=&quot;hello&quot; ng-cloak class=&quot;ng-cloak&quot;&gt;
	&lt;div ng-controller=&quot;navigation&quot; class=&quot;container&quot;&gt;
		&lt;ul class=&quot;nav nav-pills&quot; role=&quot;tablist&quot;&gt;
			&lt;li&gt;&lt;a href=&quot;/&quot;&gt;home&lt;/a&gt;&lt;/li&gt;
			&lt;li&gt;&lt;a href=&quot;/login&quot;&gt;login&lt;/a&gt;&lt;/li&gt;
			&lt;li ng-show=&quot;authenticated&quot;&gt;&lt;a href=&quot;&quot; ng-click=&quot;logout()&quot;&gt;logout&lt;/a&gt;&lt;/li&gt;
		&lt;/ul&gt;
	&lt;/div&gt;
...
&lt;/html&gt;
</code></pre><p>Angular uses the <code>&lt;base/&gt;</code> element to anchor the routes and write the URLs that show up in the browser. You are running in a Spring Boot application so the default setting is to serve from root path &ldquo;/&rdquo; (on port 8080). If you need to be able to serve from different root paths with the same application then you will need to render that path into the HTML using a server-side template (many people prefer to stick with static resources for a Single Page Application, so they are stuck with a static root path).</p><h2><a href="#extracting-the-authentication-concerns" class="anchor" name="extracting-the-authentication-concerns"></a>Extracting the Authentication Concerns</h2><p>When you modularized the application above you should have found that the code worked just by splitting it into modules, but there is a small niggle there that we are still using <code>$rootScope</code> to share state between the controllers. There&rsquo;s nothing horribly wrong with that for such a small application and it got us a decent prototype to play with quite quickly, so let&rsquo;s not be too sad about it, but now we can take the opportunity to extract all the authentication concerns into a separate module. In Angular terms what you need is a &ldquo;service&rdquo;, so create a new module (&ldquo;auth&rdquo;) next to your &ldquo;home&rdquo; and &ldquo;navigation&rdquo; modules:</p>
<pre><code class="prettyprint">static/
  js/
    auth/
      auth.js
    home/
      home.js
      home.html
    navigation/
      navigation.js
      login.html
    hello.js
  index.html
</code></pre><p>Before writing the <code>auth.js</code> code we can anticipate the changes in the other modules. First in <code>navigation.js</code> you should make the &ldquo;navigation&rdquo; module depend on the new &ldquo;auth&rdquo; module, and inject the &ldquo;auth&rdquo; service into the controller (and of course <code>$rootScope</code> is no longer needed):</p>
<pre><code class="prettyprint">angular.module(&#39;navigation&#39;, [&#39;auth&#39;]).controller(
		&#39;navigation&#39;,

		function($scope, auth) {

			$scope.credentials = {};

			$scope.authenticated = function() {
				return auth.authenticated;
			}

			$scope.login = function() {
				auth.authenticate($scope.credentials, function(authenticated) {
					if (authenticated) {
						console.log(&quot;Login succeeded&quot;)
						$scope.error = false;
					} else {
						console.log(&quot;Login failed&quot;)
						$scope.error = true;
					}
				})
			};

			$scope.logout = function() {
              auth.clear();
            }

		});

</code></pre><p>It isn&rsquo;t very different from the old controller (it still needs functions for user actions, login and logout, and an object to hold the credentials for login), but it has abstracted the implementation to the new &ldquo;auth&rdquo; service. The &ldquo;auth&rdquo; service will need an <code>authenticate()</code> function to support the <code>login()</code>, and a <code>clear()</code> function to support <code>logout()</code>. It also has a flag <code>authenticated</code> that replaces the <code>$rootScope.authenticated</code> from the old controller. We use the <code>authenticated</code> flag in a function with the same name attached to the <code>$scope</code> of the controller, so that Angular will keep checking its value and update the UI when the user logs in.</p><p>Suppose you want to make the &ldquo;auth&rdquo; module re-usable, so you don&rsquo;t want any hard-coded paths in it. That&rsquo;s not a problem, but you will need to initialize or configure the paths in the <code>hello.js</code> module, so you can add a <code>run()</code> function:</p>
<pre><code class="prettyprint">angular
  .module(&#39;hello&#39;, [ &#39;ngRoute&#39;, &#39;auth&#39;, &#39;home&#39;, &#39;navigation&#39; ])
  .config(
	...
  }).run(function(auth) {

    auth.init(&#39;/&#39;, &#39;/login&#39;, &#39;/logout&#39;);

});
</code></pre><p>The <code>run()</code> function can call into any of the modules that &ldquo;hello&rdquo; depends on, in this case injecting an <code>auth</code> service and initializing it with the paths of the home page, login and logout endpoints respectively.</p><p>Now you need to load the &ldquo;auth&rdquo; module in <code>index.html</code> in addition to the other modules (and before the &ldquo;login&rdquo; module since it depends on &ldquo;auth&rdquo;):</p>
<pre><code class="prettyprint html">...
&lt;script src=&quot;js/auth/auth.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
...
&lt;script src=&quot;js/hello.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
...
</code></pre><p>Then finally you can write the code for the three functions you pencilled in above (<code>authenticate()</code>, <code>clear()</code> and <code>init()</code>). Here&rsquo;s most of the code:</p>
<pre><code class="prettyprint javascript">angular.module(&#39;auth&#39;, []).factory(
    &#39;auth&#39;,

    function($http, $location) {

      var auth = {

        authenticated : false,

        loginPath : &#39;/login&#39;,
        logoutPath : &#39;/logout&#39;,
        homePath : &#39;/&#39;,

        authenticate : function(credentials, callback) {

          var headers = credentials &amp;&amp; credentials.username ? {
            authorization : &quot;Basic &quot;
                + btoa(credentials.username + &quot;:&quot;
                    + credentials.password)
          } : {};

          $http.get(&#39;user&#39;, {
            headers : headers
          }).success(function(data) {
            if (data.name) {
              auth.authenticated = true;
            } else {
              auth.authenticated = false;
            }
            $location.path(auth.homePath);
            callback &amp;&amp; callback(auth.authenticated);
          }).error(function() {
            auth.authenticated = false;
            callback &amp;&amp; callback(false);
          });

        },
        
        clear : function() { ... },
        
        init : function(homePath, loginPath, logoutPath) { ... }

      };

      return auth;

    });

</code></pre><p>The &ldquo;auth&rdquo; module creates a factory for an <code>auth</code> service (which you already injected into the &ldquo;navigation&rdquo; controller for instance). The factory is just a function that returns an object (<code>auth</code>), and the object has to have the three functions and the flag that we anticipated above. Above, we have shown an implementation of the <code>authenticate()</code> function, which is substantially the same as the old one in the &ldquo;navigation&rdquo; controller, it calls out to a backend resource at &ldquo;/user&rdquo;, sets a flag <code>authenticated</code> and calls an optional callback with the value of the flag. If successful, it also sends the user to the <code>homePath</code> using the <code>$location</code> service (we will improve on this in a minute).</p><p>Here is a bare-bones implementation of the <code>init()</code> function that just sets up the various paths you didn&rsquo;t want to hard code in the &ldquo;auth&rdquo; module:</p>
<pre><code class="prettyprint javascript">init : function(homePath, loginPath, logoutPath) {
  auth.homePath = homePath;
  auth.loginPath = loginPath;
  auth.logoutPath = logoutPath;
}
</code></pre><p>The <code>clear()</code> function implementation comes next, but it&rsquo;s rather simple:</p>
<pre><code class="prettyprint javascript">clear : function() {
  auth.authenticated = false;
  $location.path(auth.loginPath);
  $http.post(auth.logoutPath, {});
}
</code></pre><p>It unsets the <code>authenticated</code> flag, sends the user back to the login page, and then sends an HTTP POST to the logout path. The POST succeeds because we still have the CSRF protection features from the original &ldquo;single&rdquo; application in place. If you see a 403, look at the error message and server logs, then check that you have that filter in place and the XSRF cookie is being sent.</p><p>The very last change is to the <code>index.html</code> so that the &ldquo;logout&rdquo; link is hidden when the user is not authenticated:</p>
<pre><code class="prettyprint html">&lt;html&gt;
...
&lt;body ng-app=&quot;hello&quot; ng-cloak class=&quot;ng-cloak&quot;&gt;
  &lt;div ng-controller=&quot;navigation&quot; class=&quot;container&quot;&gt;
    &lt;ul class=&quot;nav nav-pills&quot; role=&quot;tablist&quot;&gt;
          ...
      &lt;li ng-show=&quot;authenticated()&quot;&gt;&lt;a href=&quot;&quot; ng-click=&quot;logout()&quot;&gt;logout&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
...
&lt;/html&gt;
</code></pre><p>You simply need to convert the flag <code>authenticated</code> to a function call <code>authenticated()</code>, so that the &ldquo;navigation&rdquo; controller can reach into the &ldquo;auth&rdquo; service and find the value of the flag, now that it is not in <code>$rootScope</code>.</p><h2><a href="#redirecting-to-the-login-page" class="anchor" name="redirecting-to-the-login-page"></a>Redirecting to the Login Page</h2><p>The way we have implemented our home page up to now it has some content it can display when the user is anauthenticated (it just invites them to log in). Some applications work that way, and some don&rsquo;t. Some provide a different user experience where the user never sees anything apart from the login page until he is authenticated, so let&rsquo;s see how we might convert our application to this pattern.</p><p>Hiding all content with a login page is a classic cross-cutting concern: you don&rsquo;t want all the logic for showing the login page stuck in all the UI modules (it would be duplicated everywhere, making the code harder to read and harder to maintain). Spring Security is all about cross-cutting concerns in the server, since it builds on top of <code>Filters</code> and AOP interceptors. Unfortunately that won&rsquo;t help us much in a Single Page Application, but fortunately Angular also has some features that make it easy to implement the pattern we want. The feature that helps us here is that you can install a listener for &ldquo;route changes&rdquo;, so every time the user moves to a new route (i.e. clicks on a menu bar or whatever) or when the page loads for the first time, you get to inspect the route and if you need to you can change it.</p><p>To install the listener you can write a small piece of extra code in your <code>auth.init()</code> function (since that is already arranged to run when the main &ldquo;hello&rdquo; module loads):</p>
<pre><code class="prettyprint javascript">angular.module(&#39;auth&#39;, []).factory(
    &#39;auth&#39;,

    function($rootScope, $http, $location) {

      var auth = {
      
        ...

        init : function(homePath, loginPath, logoutPath) {
          ...
          $rootScope.$on(&#39;$routeChangeStart&#39;, function() {
            enter();
          });
        }

      };

      return auth;

    });
</code></pre><p>We registered a simple listener which just delegates to a new <code>enter()</code> function, so now you need to implement that as well in the &ldquo;auth&rdquo; module factory function (where it has access to the factory object itself):</p>
<pre><code class="prettyprint javascript">enter = function() {
  if ($location.path() != auth.loginPath) {
    auth.path = $location.path();
    if (!auth.authenticated) {
      $location.path(auth.loginPath);
    }
  }          
}
</code></pre><p>The logic is simple: if the path just changed to something other than the login page, then make a record of the path value, and then if the user is not authenticated, go to the login page. The reason we save the path value is so we can go back to it after a successful authentication (Spring Security has this feature server side and it&rsquo;s quite nice for users). You do that in the <code>authenticate()</code> function by adding some code to the success handler:</p>
<pre><code class="prettyprint javascript">authenticate : function(credentials, callback) {
 ...
 $http.get(&#39;user&#39;, {
  headers : headers
  }).success(function(data) {
      ...
      $location.path(auth.path==auth.loginPath ? auth.homePath : auth.path);
  }).error(...);

},
</code></pre><p>On successful authentication we just set the location to either the home page or the most recently selected path (as long as it&rsquo;s not the login page).</p><p>There is one final change to make the user experience more uniform: we would like to show the login page instead of the home page when the application first starts up. You already have that logic (redirect to login page) in the <code>authenticate()</code> function, so all you need to do is add some code in the <code>init()</code> function to authenticate with empty credentials (which fails unless the user has a cookie already):</p>
<pre><code class="prettyprint javascript">init : function(homePath, loginPath, logoutPath) {
  ...
  auth.authenticate({}, function(authenticated) {
    if (authenticated) {
      $location.path(auth.path);
    }
  });
  ...
}
</code></pre><p>As long as <code>auth.path</code> is initialized with <code>$location.path()</code>, this will even work if the user types in a route explicitly into the browser (i.e. doesn&rsquo;t want to load the home page first).</p><p>Fire up the application (using your IDE and the <code>main()</code> method, or on the command line with <code>mvn spring-boot:run</code>) and visit it at <a href="http://localhost:8080">http://localhost:8080</a> to see the result.</p>
<blockquote><p>Reminder: be sure to clear your browser cache of cookies and HTTP Basic credentials. In Chrome the best way to do that is to open a new incognito window.</p>
</blockquote><h2><a href="#conclusion" class="anchor" name="conclusion"></a>Conclusion</h2><p>In this article we have seen how to modularize an Angular application (taking as a starting point the application from <a href="https://spring.io/blog/2015/01/12/the-login-page-angular-js-and-spring-security-part-ii" title="Second Article in the Series">Part II</a> of <a href="https://spring.io/blog/2015/01/12/spring-and-angular-js-a-secure-single-page-application" title="First Article in the Series">the series</a>), how to make it redirect to a login page, and how to use &ldquo;natural&rdquo; routes that can be typed or bookmarked easily by users. We took a step back from the last couple of articles in the series, concentrating on the client-side code a bit more, and temporarily ditching the distributed architecture that we were building in Parts III-VI. That doesn&rsquo;t mean that the changes here can&rsquo;t be applied to those other applications (actually it&rsquo;s fairly trivial) - it was just to simplify the server-side code while we were learning how to do things on the client. There <em>were</em> a couple of server-side features that we used or discussed briefly though (for instance the use of a &ldquo;forward&rdquo; view in Spring MVC to enable &ldquo;natural&rdquo; routes), so we have continued the theme of Angular and Spring working together, and shown that they do so quite well with small tweaks here and there.</p><p>The <a href="https://spring.io/blog/2015/05/19/testing-an-angular-application-angular-js-and-spring-security-part-viii">next part in the series</a> is about testing the client-side code.</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 2084;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>