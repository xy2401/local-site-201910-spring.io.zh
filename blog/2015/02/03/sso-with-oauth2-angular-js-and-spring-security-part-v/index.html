<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>SSO with OAuth2: Angular JS and Spring Security Part V</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="SSO with OAuth2: Angular JS and Spring Security Part V" />
<meta name="twitter:description" content="&lt;blockquote&gt;
 &lt;p&gt;Note: the source code and test for this blog continue to evolve, but the changes to the text are not being maintained here. Please see &lt;a href=&quot;https://spring.io/guides/tutorials/spring-security-and-angular-js/&quot;&gt;the tutorial version&lt;/a&gt; for the most up to date content.&lt;/p&gt; 
&lt;/blockquote&gt;
&lt;p&gt;In this article we continue &lt;a href=&quot;http://spring.io/blog/2015/01/28/the-api-gateway-pattern-angular-js-and-spring-security-part-iv&quot; title=&quot;Fourth Article in the Series&quot;&gt;our discussion&lt;/a&gt; of how to use &lt;a href=&quot;http://projects.spring.io/spring-security&quot;&gt;Spring Security&lt;/a&gt; with &lt;a href=&quot;http://angularjs.org&quot;&gt;Angular JS&lt;/a&gt; in a “single page application”. Here we show how to use &lt;a href=&quot;http://projects.spring.io/spring-security-oauth/&quot;&gt;Spring Security OAuth&lt;/a&gt; together with &lt;a href=&quot;http://projects.spring.io/spring-cloud/&quot;&gt;Spring Cloud&lt;/a&gt; to extend our API Gateway to do Single Sign On and OAuth2 token authentication to backend resources. This is the fifth in a series of articles, and you can catch up on the basic building blocks of the application or build it from scratch by reading the &lt;a href=&quot;http://spring.io/blog/2015/01/12/spring-and-angular-js-a-secure-single-page-application&quot; title=&quot;First Article in the Series&quot;&gt;first article&lt;/a&gt;, or you can just go straight to the &lt;a href=&quot;https://github.com/dsyer/spring-security-angular/tree/master/oauth2&quot;&gt;source code in Github&lt;/a&gt;. In the &lt;a href=&quot;http://spring.io/blog/2015/01/28/the-api-gateway-pattern-angular-js-and-spring-security-part-iv&quot; title=&quot;Fourth Article in the Series&quot;&gt;last article&lt;/a&gt; we built a small distributed application that used &lt;a href=&quot;https://github.com/spring-projects/spring-session/&quot;&gt;Spring Session&lt;/a&gt; to authenticate the backend resources and &lt;a href=&quot;http://projects.spring.io/spring-cloud/&quot;&gt;Spring Cloud&lt;/a&gt; to implement an embedded API Gateway in the UI server. In this article we extract the authentication responsibilities to a separate server to make our UI server the first of potentially many Single Sign On applications to the authorization server. This is a common pattern in many applications these days, both in the enterprise and in social startups. We will use an OAuth2 server as the authenticator, so that we can also use it to grant tokens for the backend resource server. Spring Cloud will automatically relay the access token to our backend, and enable us to further simplify the implementation of both the UI and resource servers.&lt;/p&gt;
" />
<meta name="twitter:creator" content="@david_syer" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/ae671230e3a1c2a0eefa7604990084f1?s=200" />

<meta property="og:title" content="SSO with OAuth2: Angular JS and Spring Security Part V" />
<meta property="og:image" content="https://gravatar.com/avatar/ae671230e3a1c2a0eefa7604990084f1?s=200" />
<meta property="og:description" content="&lt;blockquote&gt;
 &lt;p&gt;Note: the source code and test for this blog continue to evolve, but the changes to the text are not being maintained here. Please see &lt;a href=&quot;https://spring.io/guides/tutorials/spring-security-and-angular-js/&quot;&gt;the tutorial version&lt;/a&gt; for the most up to date content.&lt;/p&gt; 
&lt;/blockquote&gt;
&lt;p&gt;In this article we continue &lt;a href=&quot;http://spring.io/blog/2015/01/28/the-api-gateway-pattern-angular-js-and-spring-security-part-iv&quot; title=&quot;Fourth Article in the Series&quot;&gt;our discussion&lt;/a&gt; of how to use &lt;a href=&quot;http://projects.spring.io/spring-security&quot;&gt;Spring Security&lt;/a&gt; with &lt;a href=&quot;http://angularjs.org&quot;&gt;Angular JS&lt;/a&gt; in a “single page application”. Here we show how to use &lt;a href=&quot;http://projects.spring.io/spring-security-oauth/&quot;&gt;Spring Security OAuth&lt;/a&gt; together with &lt;a href=&quot;http://projects.spring.io/spring-cloud/&quot;&gt;Spring Cloud&lt;/a&gt; to extend our API Gateway to do Single Sign On and OAuth2 token authentication to backend resources. This is the fifth in a series of articles, and you can catch up on the basic building blocks of the application or build it from scratch by reading the &lt;a href=&quot;http://spring.io/blog/2015/01/12/spring-and-angular-js-a-secure-single-page-application&quot; title=&quot;First Article in the Series&quot;&gt;first article&lt;/a&gt;, or you can just go straight to the &lt;a href=&quot;https://github.com/dsyer/spring-security-angular/tree/master/oauth2&quot;&gt;source code in Github&lt;/a&gt;. In the &lt;a href=&quot;http://spring.io/blog/2015/01/28/the-api-gateway-pattern-angular-js-and-spring-security-part-iv&quot; title=&quot;Fourth Article in the Series&quot;&gt;last article&lt;/a&gt; we built a small distributed application that used &lt;a href=&quot;https://github.com/spring-projects/spring-session/&quot;&gt;Spring Session&lt;/a&gt; to authenticate the backend resources and &lt;a href=&quot;http://projects.spring.io/spring-cloud/&quot;&gt;Spring Cloud&lt;/a&gt; to implement an embedded API Gateway in the UI server. In this article we extract the authentication responsibilities to a separate server to make our UI server the first of potentially many Single Sign On applications to the authorization server. This is a common pattern in many applications these days, both in the enterprise and in social startups. We will use an OAuth2 server as the authenticator, so that we can also use it to grant tokens for the backend resource server. Spring Cloud will automatically relay the access token to our backend, and enable us to further simplify the implementation of both the UI and resource servers.&lt;/p&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2015-02-03 14:30:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">SSO with OAuth2: Angular JS and Spring Security Part V</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/ae671230e3a1c2a0eefa7604990084f1?s=20&amp;d=mm" />
<a class="author" rel="author" href="/team/dsyer">Dave Syer</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2015-02-03 14:30:00.0">February 03, 2015</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="1907" href="/blog/2015/02/03/sso-with-oauth2-angular-js-and-spring-security-part-v#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><blockquote><p>Note: the source code and test for this blog continue to evolve, but the changes to the text are not being maintained here. Please see <a href="https://spring.io/guides/tutorials/spring-security-and-angular-js/">the tutorial version</a> for the most up to date content.</p>
</blockquote><p>In this article we continue <a href="https://spring.io/blog/2015/01/28/the-api-gateway-pattern-angular-js-and-spring-security-part-iv" title="Fourth Article in the Series">our discussion</a> of how to use <a href="https://projects.spring.io/spring-security">Spring Security</a> with <a href="http://angularjs.org">Angular JS</a> in a &ldquo;single page application&rdquo;. Here we show how to use <a href="https://projects.spring.io/spring-security-oauth/">Spring Security OAuth</a> together with <a href="https://projects.spring.io/spring-cloud/">Spring Cloud</a> to extend our API Gateway to do Single Sign On and OAuth2 token authentication to backend resources. This is the fifth in a series of articles, and you can catch up on the basic building blocks of the application or build it from scratch by reading the <a href="https://spring.io/blog/2015/01/12/spring-and-angular-js-a-secure-single-page-application" title="First Article in the Series">first article</a>, or you can just go straight to the <a href="https://github.com/dsyer/spring-security-angular/tree/master/oauth2">source code in Github</a>. In the <a href="https://spring.io/blog/2015/01/28/the-api-gateway-pattern-angular-js-and-spring-security-part-iv" title="Fourth Article in the Series">last article</a> we built a small distributed application that used <a href="https://github.com/spring-projects/spring-session/">Spring Session</a> to authenticate the backend resources and <a href="https://projects.spring.io/spring-cloud/">Spring Cloud</a> to implement an embedded API Gateway in the UI server. In this article we extract the authentication responsibilities to a separate server to make our UI server the first of potentially many Single Sign On applications to the authorization server. This is a common pattern in many applications these days, both in the enterprise and in social startups. We will use an OAuth2 server as the authenticator, so that we can also use it to grant tokens for the backend resource server. Spring Cloud will automatically relay the access token to our backend, and enable us to further simplify the implementation of both the UI and resource servers.</p>
<blockquote><p>Reminder: if you are working through this article with the sample application, be sure to clear your browser cache of cookies and HTTP Basic credentials. In Chrome the best way to do that for a single server is to open a new incognito window.</p>
</blockquote><h2><a href="#creating-an-oauth2-authorization-server" class="anchor" name="creating-an-oauth2-authorization-server"></a>Creating an OAuth2 Authorization Server</h2><p>Our first step is to create a new server to handle authentication and token management. Following the steps in <a href="https://spring.io/blog/2015/01/12/spring-and-angular-js-a-secure-single-page-application" title="First Article in the Series">Part I</a> we can begin with <a href="https://start.spring.io">Spring Boot Initializr</a>. E.g. using curl on a UN*X like system:</p>
<pre><code class="prettyprint">$ curl https://start.spring.io/starter.tgz -d style=web \
-d style=security -d name=authserver | tar -xzvf - 
</code></pre><p>You can then import that project (it&rsquo;s a normal Maven Java project by default) into your favourite IDE, or just work with the files and &ldquo;mvn&rdquo; on the command line.</p><h3><a href="#adding-the-oauth2-dependencies" class="anchor" name="adding-the-oauth2-dependencies"></a>Adding the OAuth2 Dependencies</h3><p>We need to add the <a href="https://projects.spring.io/spring-security-oauth">Spring OAuth</a> dependencies, so in our <a href="https://github.com/dsyer/spring-security-angular/blob/master/oauth2/authserver/pom.xml">POM</a> we add:</p>
<pre><code class="prettyprint xml">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.security.oauth&lt;/groupId&gt;
  &lt;artifactId&gt;spring-security-oauth2&lt;/artifactId&gt;
  &lt;version&gt;2.0.5.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><p>The authorization server is pretty easy to implement. A minimal version looks like this:</p>
<pre><code class="prettyprint java">@SpringBootApplication
public class AuthserverApplication extends WebMvcConfigurerAdapter {

  public static void main(String[] args) {
    SpringApplication.run(AuthserverApplication.class, args);
  }
  
  @Configuration
  @EnableAuthorizationServer
  protected static class OAuth2Config extends AuthorizationServerConfigurerAdapter {

    @Autowired
    private AuthenticationManager authenticationManager;
    
    @Override
    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {
      endpoints.authenticationManager(authenticationManager);
    }

@Override
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
      clients.inMemory()
          .withClient(&quot;acme&quot;)
          .secret(&quot;acmesecret&quot;)
          .authorizedGrantTypes(&quot;authorization_code&quot;, &quot;refresh_token&quot;,
              &quot;password&quot;).scopes(&quot;openid&quot;);
    }

}
</code></pre><p>We only had to do 2 things (after adding <code>@EnableAuthorizationServer</code>):</p>
<ul>
<li><p>Register a client &ldquo;acme&rdquo; with a secret and some authorized grant types including &ldquo;authorization_code&rdquo;.</p></li>
<li><p>Inject the default <code>AuthenticationManager</code> from Spring Boot autoconfiguration and wire it into the OAuth2 endpoints.</p></li>
</ul><p>Now let&rsquo;s get it running on port 9999, with a predictable password for testing:</p>
<pre><code class="prettyprint properties">server.port=9999
security.user.password=password
server.contextPath=/uaa
</code></pre><p>We also set the context path so that it doesn&rsquo;t use the default (&ldquo;/&rdquo;) because otherwise you can get cookies for other servers on localhost being sent to the wrong server. So get the server running and we can make sure it is working:</p>
<pre><code class="prettyprint">$ mvn spring-boot:run
</code></pre><p>or start the <code>main()</code> method in your IDE.</p><h3><a href="#testing-the-authorization-server" class="anchor" name="testing-the-authorization-server"></a>Testing the Authorization Server</h3><p>Our server is using the Spring Boot default security settings, so like the server in <a href="https://spring.io/blog/2015/01/12/spring-and-angular-js-a-secure-single-page-application" title="First Article in the Series">Part I</a> it will be protected by HTTP Basic authentication. To initiate an <a href="https://tools.ietf.org/html/rfc6749#section-1.3.1">authorization code token grant</a> you visit the authorization endpoint, e.g. at <a href="http://localhost:9999/uaa/oauth/authorize?response_type=code&client_id=acme&redirect_uri=http://example.com">http://localhost:9999/uaa/oauth/authorize?response_type=code&client_id=acme&redirect_uri=http://example.com</a> once you have authenticated you will get a redirect to example.com with an authorization code attached, e.g. <a href="http://example.com/?code=jYWioI">http://example.com/?code=jYWioI</a>.</p>
<blockquote><p>Note: for the purposes of this sample application we have created a client &ldquo;acme&rdquo; with no registered redirect, which is what enables us to get a redirect the example.com. In a production application you should always register a redirect (and use HTTPS).</p>
</blockquote><p>The code can be exchanged for an access token using the &ldquo;acme&rdquo; client credentials on the token endpoint:</p>
<pre><code class="prettyprint">$ curl acme:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2b4a48464e584e48594e5f6b4744484a474344585f">[email&#160;protected]</a>:9999/uaa/oauth/token  \
-d grant_type=authorization_code -d client_id=acme     \
-d redirect_uri=http://example.com -d code=jYWioI
{&quot;access_token&quot;:&quot;2219199c-966e-4466-8b7e-12bb9038c9bb&quot;,&quot;token_type&quot;:&quot;bearer&quot;,&quot;refresh_token&quot;:&quot;d193caf4-5643-4988-9a4a-1c03c9d657aa&quot;,&quot;expires_in&quot;:43199,&quot;scope&quot;:&quot;openid&quot;}
</code></pre><p>The access token is a UUID (&ldquo;2219199c&hellip;&rdquo;), backed by an in-memory token store in the server. We also got a refresh token that we can use to get a new access token when the current one expires.</p>
<blockquote><p>Note: since we allowed &ldquo;password&rdquo; grants for the &ldquo;acme&rdquo; client we can also get a token directly from the token endpoint using curl and user credentials instead of an authorization code. This is not suitable for a browser based client, but it&rsquo;s useful for testing.</p>
</blockquote><p>If you followed the link above you would have seen the whitelabel UI provided by Spring OAuth. To start with we will use this and we can come back later to beef it up like we did in <a href="https://spring.io/blog/2015/01/12/the-login-page-angular-js-and-spring-security-part-ii" title="Second Article in the Series">Part II</a> for the self-contained server.</p><p><span id="changing-the-resource-server"></span></p><h2><a href="#changing-the-resource-server" class="anchor" name="changing-the-resource-server"></a>Changing the Resource Server</h2><p>If we follow on from <a href="https://spring.io/blog/2015/01/28/the-api-gateway-pattern-angular-js-and-spring-security-part-iv" title="Fourth Article in the Series">Part IV</a>, our resource server is using <a href="https://github.com/spring-projects/spring-session/">Spring Session</a> for authentication, so we can take that out and replace it with Spring OAuth. We also need to remove the Spring Session and Redis dependencies, so replace this:</p>
<pre><code class="prettyprint xml">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.session&lt;/groupId&gt;
  &lt;artifactId&gt;spring-session&lt;/artifactId&gt;
  &lt;version&gt;1.0.0.RC1&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-redis&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><p>with this:</p>
<pre><code class="prettyprint xml">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.security.oauth&lt;/groupId&gt;
  &lt;artifactId&gt;spring-security-oauth2&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><p>and then remove the session <code>Filter</code> from the <a href="https://github.com/dsyer/spring-security-angular/blob/master/vanilla-oauth2/resource/src/main/groovy/demo/ResourceApplication.groovy">main application class</a>, replacing it with the convenient <code>@EnableOAuth2Resource</code> annotation (from Spring Cloud Security):</p>
<pre><code class="prettyprint java">@SpringBootApplication
@RestController
@EnableOAuth2Resource
class ResourceApplication {

  @RequestMapping(&#39;/&#39;)
  def home() {
    [id: UUID.randomUUID().toString(), content: &#39;Hello World&#39;]
  }

  static void main(String[] args) {
    SpringApplication.run ResourceApplication, args
  }
}

</code></pre><p>That much is enough to get us a protected resource. Run the application and hit the home page with a command line client:</p>
<pre><code class="prettyprint">$ curl -v localhost:9000
&gt; GET / HTTP/1.1
&gt; User-Agent: curl/7.35.0
&gt; Host: localhost:9000
&gt; Accept: */*
&gt; 
&lt; HTTP/1.1 401 Unauthorized
...
&lt; WWW-Authenticate: Bearer realm=&quot;null&quot;, error=&quot;unauthorized&quot;, error_description=&quot;An Authentication object was not found in the SecurityContext&quot;
&lt; Content-Type: application/json;charset=UTF-8
{&quot;error&quot;:&quot;unauthorized&quot;,&quot;error_description&quot;:&quot;An Authentication object was not found in the SecurityContext&quot;}
</code></pre><p>and you will see a 401 with a &ldquo;WWW-Authenticate&rdquo; header indicating that it wants a bearer token. We are going to add a small amount of external configuration (in &ldquo;application.properties&rdquo;) to allow the resource server to decode the tokens it is given and authenticate a user:</p>
<pre><code class="prettyprint properties">...
spring.oauth2.resource.userInfoUri: http://localhost:9999/uaa/user
</code></pre><p>This tells the server that it can use the token to access a &ldquo;/user&rdquo; endpoint and use that to derive authentication information (it&rsquo;s a bit like the <a href="https://developers.facebook.com/docs/graph-api/reference/v2.2/user/?locale=en_GB">&ldquo;/me&rdquo; endpoint</a> in the Facebook API). Effectively it provides a way for the resource server to decode the token, as expressed by the <code>ResourceServerTokenServices</code> interface in Spring OAuth2.</p>
<blockquote><p>Note: the <code>userInfoUri</code> is by far not the only way of hooking a resource server up with a way to decode tokens. In fact it&rsquo;s sort of a lowest common denominator (and not part of the spec), but quite often available from OAuth2 providers (like Facebook, Cloud Foundry, Github), and other choices are available. For instance you can encode the user authentication in the token itself (e.g. with <a href="http://jwt.io/" title="Jason Web Tokens">JWT</a>), or use a shared backend store. There is also a <code>/token_info</code> endpoint in CloudFoundry, which provides more detailed information than the user info endpoint, but which requires more thorough authentication. Different options (naturally) provide different benefits and trade-offs, but a full discussion of those is outside the scope of this article.</p>
</blockquote><h2><a href="#implementing-the-user-endpoint" class="anchor" name="implementing-the-user-endpoint"></a>Implementing the User Endpoint</h2><p>On the authorization server we can easily add that endpoint</p>
<pre><code class="prettyprint java">@SpringBootApplication
@RestController
@EnableResourceServer
public class AuthserverApplication {

  @RequestMapping(&quot;/user&quot;)
  public Principal user(Principal user) {
    return user;
  }

  ...

}

</code></pre><p>We added a <code>@RequestMapping</code> the same as the UI server in <a href="https://spring.io/blog/2015/01/12/the-login-page-angular-js-and-spring-security-part-ii" title="Second Article in the Series">Part II</a>, and also the <code>@EnableResourceServer</code> annotation from Spring OAuth, which by default secures everything in an authorization server except the &ldquo;/oauth/*&rdquo; endpoints.</p><p>With that endpoint in place we can test it and the greeting resource, since they both now accept bearer tokens that were created by the authorization server:</p>
<pre><code class="prettyprint">$ TOKEN=2219199c-966e-4466-8b7e-12bb9038c9bb
$ curl -H &quot;Authorization: Bearer $TOKEN&quot; localhost:9000
{&quot;id&quot;:&quot;03af8be3-2fc3-4d75-acf7-c484d9cf32b1&quot;,&quot;content&quot;:&quot;Hello World&quot;}
$ curl -H &quot;Authorization: Bearer $TOKEN&quot; localhost:9999/uaa/user
{&quot;details&quot;:...,&quot;principal&quot;:{&quot;username&quot;:&quot;user&quot;,...},&quot;name&quot;:&quot;user&quot;}
</code></pre><p>(substitute the value of the access token that you obtain from your own authorization server to get that working yourself).</p><h2><a href="#the-ui-server" class="anchor" name="the-ui-server"></a>The UI Server</h2><p>The final piece of this application we need to complete is the UI server, extracting the authentication part and delegating to the authorization server. So, as with <a href="#changing-the-resource-server">the resource server</a>, we first need to remove the Spring Session and Redis dependencies and replace them with Spring OAuth2.</p><p>Once that is done we can remove the session filter and the &ldquo;/user&rdquo; endpoint as well, and set up the application to redirect to the authorization server (using the <code>@EnableOAuth2Sso</code> annotation):</p>
<pre><code class="prettyprint java">@SpringBootApplication
@EnableZuulProxy
@EnableOAuth2Sso
public class UiApplication {

  public static void main(String[] args) {
    SpringApplication.run(UiApplication.class, args);
  }

  @Configuration
  @Order(SecurityProperties.ACCESS_OVERRIDE_ORDER)
  protected static class SecurityConfiguration extends WebSecurityConfigurerAdapter {
</code></pre><p>Recall from <a href="https://spring.io/blog/2015/01/28/the-api-gateway-pattern-angular-js-and-spring-security-part-iv" title="Fourth Article in the Series">Part IV</a> that the UI server, by virtue of the <code>@EnableZuulProxy</code>, acts an API Gateway and we can declare the route mappings in YAML. So the &ldquo;/user&rdquo; endpoint can be proxied to the authorization server:</p>
<pre><code class="prettyprint yaml">zuul:
  routes:
    resource:
      path: /resource/**
      url: http://localhost:9000
    user:
      path: /user/**
      url: http://localhost:9999/uaa/user
</code></pre><p>Lastly, we need to change the <code>WebSecurityConfigurerAdapter</code> to an <code>OAuth2SsoConfigurerAdapter</code> since now it is going to be used to modify the defaults in the SSO filter chain set up by <code>@EnableOAuth2Sso</code>:</p>
<pre><code class="prettyprint">  @Configuration
  protected static class SecurityConfiguration extends OAuth2SsoConfigurerAdapter {

    @Override
    public void match(RequestMatchers matchers) {
      matchers.anyRequest();
    }

    @Override
    public void configure(HttpSecurity http) throws Exception {
      http.authorizeRequests().antMatchers(&quot;/index.html&quot;, &quot;/home.html&quot;, &quot;/&quot;)
          .permitAll().anyRequest().authenticated().and().csrf()
          .csrfTokenRepository(csrfTokenRepository()).and()
          .addFilterAfter(csrfHeaderFilter(), CsrfFilter.class);
    }
    
    ... // the csrf*() methods are the same as the old WebSecurityConfigurerAdapter
  }
</code></pre><p>The main changes (apart from the base class name) are that the matchers<br />go into their own method, and there is no need for <code>formLogin()</code> any more.</p><p>There are also some mandatory external configuration properties for the<br /><code>@EnableOAuth2Sso</code> annotation to be able to contact and authenticate with<br />thr right authorization server. So we need this in <code>application.yml</code>:</p>
<pre><code class="prettyprint yaml">spring:
  oauth2:
    sso:
      home:
        secure: false
        path: /,/**/*.html
    client:
      accessTokenUri: http://localhost:9999/uaa/oauth/token
      userAuthorizationUri: http://localhost:9999/uaa/oauth/authorize
      clientId: acme
      clientSecret: acmesecret
    resource:
      userInfoUri: http://localhost:9999/uaa/user
</code></pre><p>The bulk of that is about the OAuth2 client (&ldquo;acme&rdquo;) and the<br />authorization server locations. There is also a <code>userInfoUri</code> (just<br />like in the resource server) so that the user can be authenticated in<br />the UI app itself. The &ldquo;home&rdquo; stuff is about allowing anonymous access<br />to the static resources in our single page application.</p><h3><a href="#in-the-client" class="anchor" name="in-the-client"></a>In the Client</h3><p>There are some minor tweaks to the UI application on the front end that we still need to make to trigger the redirect to the authorization server. The first is in the navigation bar in &ldquo;index.html&rdquo; where the &ldquo;login&rdquo; link changes from an Angular route:</p>
<pre><code class="prettyprint html">&lt;div ng-controller=&quot;navigation&quot; class=&quot;container&quot;&gt;
  &lt;ul class=&quot;nav nav-pills&quot; role=&quot;tablist&quot;&gt;
    ...
    &lt;li&gt;&lt;a href=&quot;#/login&quot;&gt;login&lt;/a&gt;&lt;/li&gt;
    ...
  &lt;/ul&gt;
&lt;/div&gt;
</code></pre><p>to a plain HTML link</p>
<pre><code class="prettyprint html">&lt;div ng-controller=&quot;navigation&quot; class=&quot;container&quot;&gt;
  &lt;ul class=&quot;nav nav-pills&quot; role=&quot;tablist&quot;&gt;
    ...
    &lt;li&gt;&lt;a href=&quot;login&quot;&gt;login&lt;/a&gt;&lt;/li&gt;
    ...
  &lt;/ul&gt;
&lt;/div&gt;
</code></pre><p>The &ldquo;/login&rdquo; endpoint that this goes to is handled by Spring Security and if the user is not authenticated it will result in a redirect to the authorization server.</p><p>We can also remove the definition of the <code>login()</code> function in the &ldquo;navigation&rdquo; controller, and the &ldquo;/login&rdquo; route from the Angular configuration, which simplifies the implementation a bit:</p>
<pre><code class="prettyprint javascript">angular.module(&#39;hello&#39;, [ &#39;ngRoute&#39; ]).config(function($routeProvider) {

  $routeProvider.when(&#39;/&#39;, {
    templateUrl : &#39;home.html&#39;,
    controller : &#39;home&#39;
  }).otherwise(&#39;/&#39;);

}). // ...
.controller(&#39;navigation&#39;,

function($rootScope, $scope, $http, $location, $route) {

  $http.get(&#39;user&#39;).success(function(data) {
    if (data.name) {
      $rootScope.authenticated = true;
    } else {
      $rootScope.authenticated = false;
    }
  }).error(function() {
    $rootScope.authenticated = false;
  });

  $scope.credentials = {};

  $scope.logout = function() {
    $http.post(&#39;logout&#39;, {}).success(function() {
      $rootScope.authenticated = false;
      $location.path(&quot;/&quot;);
    }).error(function(data) {
      $rootScope.authenticated = false;
    });
  }

});
</code></pre><h2><a href="#how-does-it-work" class="anchor" name="how-does-it-work"></a>How Does it Work?</h2><p>Run all the servers together now, and visit the UI in a browser at <a href="http://localhost:8080">http://localhost:8080</a>. Click on the &ldquo;login&rdquo; link and you will be redirected to the authorization server to authenticate (HTTP Basic popup) and approve the token grant (whitelabel HTML), before being redirected to the home page in the UI with the greeting fetched from the OAuth2 resource server using the same token as we authenticated the UI with.</p><p>The interactions between the browser and the backend can be seen in your browser if you use some developer tools (usually F12 opens this up, works in Chrome by default, requires a plugin in Firefox). Here&rsquo;s a summary:</p>
<table>
<thead>
<tr>
<th>Verb </th>
<th>Path </th>
<th>Status </th>
<th>Response</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET </td>
<td>/ </td>
<td>200 </td>
<td>index.html</td>
</tr>
<tr>
<td>GET </td>
<td>/css/angular-bootstrap.css </td>
<td>200 </td>
<td>Twitter bootstrap CSS</td>
</tr>
<tr>
<td>GET </td>
<td>/js/angular-bootstrap.js </td>
<td>200 </td>
<td>Bootstrap and Angular JS</td>
</tr>
<tr>
<td>GET </td>
<td>/js/hello.js </td>
<td>200 </td>
<td>Application logic</td>
</tr>
<tr>
<td>GET </td>
<td>/home.html </td>
<td>200 </td>
<td>HTML partial for home page</td>
</tr>
<tr>
<td>GET </td>
<td>/user </td>
<td>302 </td>
<td>Redirect to login page</td>
</tr>
<tr>
<td>GET </td>
<td>/login </td>
<td>302 </td>
<td>Redirect to auth server</td>
</tr>
<tr>
<td>GET </td>
<td>(uaa)/oauth/authorize </td>
<td>401 </td>
<td>(ignored)</td>
</tr>
<tr>
<td>GET </td>
<td>/resource </td>
<td>302 </td>
<td>Redirect to login page</td>
</tr>
<tr>
<td>GET </td>
<td>/login </td>
<td>302 </td>
<td>Redirect to auth server</td>
</tr>
<tr>
<td>GET </td>
<td>(uaa)/oauth/authorize </td>
<td>401 </td>
<td>(ignored)</td>
</tr>
<tr>
<td>GET </td>
<td>/login </td>
<td>302 </td>
<td>Redirect to auth server</td>
</tr>
<tr>
<td>GET </td>
<td>(uaa)/oauth/authorize </td>
<td>200 </td>
<td>HTTP Basic auth happens here</td>
</tr>
<tr>
<td>POST </td>
<td>(uaa)/oauth/authorize </td>
<td>302 </td>
<td>User approves grant, redirect to /login</td>
</tr>
<tr>
<td>GET </td>
<td>/login </td>
<td>302 </td>
<td>Redirect to home page</td>
</tr>
<tr>
<td>GET </td>
<td>/user </td>
<td>200 </td>
<td>(Proxied) JSON authenticated user</td>
</tr>
<tr>
<td>GET </td>
<td>/home.html </td>
<td>200 </td>
<td>HTML partial for home page</td>
</tr>
<tr>
<td>GET </td>
<td>/resource </td>
<td>200 </td>
<td>(Proxied) JSON greeting</td>
</tr>
</tbody>
</table><p>The requests prefixed with (uaa) are to the authorization server. The responses that are marked &ldquo;ignored&rdquo; are responses received by Angular in an XHR call, and since we aren&rsquo;t processing that data they are dropped on the floor. We do look for an authenticated user in the case of the &ldquo;/user&rdquo; resource, but since it isn&rsquo;t there in the first call, that response is dropped.</p><p>In the &ldquo;/trace&rdquo; endpoint of the UI (scroll down to the bottom) you will see the proxied backend requests to &ldquo;/user&rdquo; and &ldquo;/resource&rdquo;, with <code>remote:true</code> and the bearer token instead of the cookie (as it would have been in <a href="https://spring.io/blog/2015/01/28/the-api-gateway-pattern-angular-js-and-spring-security-part-iv" title="Fourth Article in the Series">Part IV</a>) being used for authentication. Spring Cloud Security has taken care of this for us: by recognising that we has <code>@EnableOAuth2Sso</code> and <code>@EnableZuulProxy</code> it has figured out that (by default) we want to relay the token to the proxied backends.</p>
<blockquote><p>Note: As in previous articles, try to use a different browser for &ldquo;/trace&rdquo; so that there is no chance of authentication crossover (e.g. use Firefox if yoused Chrome for testing the UI).</p>
</blockquote><h2><a href="#the-logout-experience" class="anchor" name="the-logout-experience"></a>The Logout Experience</h2><p>If you click on the &ldquo;logout&rdquo; link you will see that the home page changes (the greeting is no longer displayed) so the user is no longer authenticated with the UI server. Click back on &ldquo;login&rdquo; though and you actually <em>don&rsquo;t</em> need to go back through the authentication and approval cycle in the authorization server (because you haven&rsquo;t logged out of that). Opinions will be divided as to whether that is a desirable user experience, and it&rsquo;s a notoriously tricky problem (Single Sign Out: <a href="https://www.sciencedirect.com/science/article/pii/S2214212614000179">Science Direct article</a> and <a href="https://wiki.shibboleth.net/confluence/display/SHIB2/SLOIssues">Shibboleth docs</a>). The ideal user experience might not be technically feasible, and you also have to be suspicious sometimes that users really want what they say they want. &ldquo;I want &lsquo;logout&rsquo; to log me out&rdquo; sounds simple enough, but the obvious response is, &ldquo;Logged out of what? Do you want to be logged out of <em>all</em> the systems controlled by this SSO server, or just the one that you clicked the &lsquo;logout&rsquo; link in?&rdquo; We don&rsquo;t have room to discuss this topic more broadly here but it does deserve more attention. If you are interested then there is some discussion of the principles and some (fairly unappetising) ideas about implementations in the <a href="https://openid.net/connect/">Open ID Connect</a> specification.</p><h2><a href="#conclusion" class="anchor" name="conclusion"></a>Conclusion</h2><p>This is almost the end of our shallow tour through the Spring Security and Angular JS stack. We have a nice architecture now with clear responsibilities in three separate components, UI/API Gateway, resource server and authorization server/token granter. The amount of non-business code in all layers is now minimal, and it&rsquo;s easy to see where to extend and improve the implementation with more business logic. The next steps will be to tidy up the UI in our authorization server, and probably add some more tests, including tests on the JavaScript client. Another interesting task is to extract all the boiler plate code and put it in a library (e.g. &ldquo;spring-security-angular&rdquo;) containing Spring Security and Spring Session autoconfiguration and some webjars resources for the navigation controller in the Angular piece. Having read the articles in thir series, anyone who was hoping to learn the inner workings of either Angular JS or Spring Security will probably be disappointed, but if you wanted to see how they can work well together and how a little bit of configuration can go a long way, then hopefully you will have had a good experience. <a href="https://projects.spring.io/spring-cloud/">Spring Cloud</a> is new and these samples required snapshots when they were written, but there are release candidates available and a GA release coming soon, so check it out and send some feedback <a href="https://github.com/spring-cloud">via Github</a> or <a href="https://gitter.im/spring-cloud/spring-cloud">gitter.im</a>.</p><p>The <a href="https://spring.io/blog/2015/03/23/multiple-ui-applications-and-a-gateway-single-page-application-with-spring-and-angular-js-part-vi">next article</a> in the series is about access decisions (beyond authentication) and employs multiple UI applications behind the same proxy.</p><h2><a href="#addendum-bootstrap-ui-and-jwt-tokens-for-the-authorization-server" class="anchor" name="addendum-bootstrap-ui-and-jwt-tokens-for-the-authorization-server"></a>Addendum: Bootstrap UI and JWT Tokens for the Authorization Server</h2><p>You will find another version of this application in the <a href="https://github.com/dsyer/spring-security-angular/tree/master/oauth2">source code in Github</a> which has a pretty login page and user approval page implemented similarly to the way we did the login page in <a href="https://spring.io/blog/2015/01/12/the-login-page-angular-js-and-spring-security-part-ii" title="Second Article in the Series">Part II</a>. It also uses <a href="http://jwt.io/" title="Jason Web Tokens">JWT</a> to encode the tokens, so instead of using the &ldquo;/user&rdquo; endpoint, the resource server can pull enough information out of the token itself to do a simple authentication. The browser client still uses it, proxied through the UI server, so that it can determine if a user is authenticated (it doesn&rsquo;t need to do that very often, compared to the likely number of calls to a resource server in a real application).</p></div>
</div>
<section id="disqus_thread"></section>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 1907;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>