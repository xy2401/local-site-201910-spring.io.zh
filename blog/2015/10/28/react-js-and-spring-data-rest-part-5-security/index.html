<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>React.js and Spring Data REST: Part 5 - Security</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="React.js and Spring Data REST: Part 5 - Security" />
<meta name="twitter:description" content="&lt;div id=&quot;preamble&quot;&gt; 
 &lt;div class=&quot;sectionbody&quot;&gt; 
  &lt;div class=&quot;admonitionblock note&quot;&gt; 
   &lt;table&gt; 
    &lt;tbody&gt; 
     &lt;tr&gt; 
      &lt;td class=&quot;icon&quot;&gt; &lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt; &lt;/td&gt; 
      &lt;td class=&quot;content&quot;&gt;To see updates to this code, visit our &lt;a href=&quot;https://spring.io/guides/tutorials/react-and-spring-data-rest/&quot;&gt;React.js and Spring Data REST tutorial&lt;/a&gt;.&lt;/td&gt; 
     &lt;/tr&gt; 
    &lt;/tbody&gt; 
   &lt;/table&gt; 
  &lt;/div&gt; 
  &lt;div class=&quot;paragraph&quot;&gt; 
   &lt;p&gt;In the &lt;a href=&quot;https://spring.io/blog/2015/10/13/react-js-and-spring-data-rest-part-4-events&quot;&gt;previous session&lt;/a&gt;, you made the app dynamically response to updates from other users via Spring Data REST’s built in event handlers and the Spring Framework’s WebSocket support. But no application is complete without securing the whole thing so that only proper users have access to the UI and the resources behind it.&lt;/p&gt; 
  &lt;/div&gt; 
  &lt;div class=&quot;paragraph&quot;&gt; 
   &lt;p&gt;Feel free to &lt;a href=&quot;https://github.com/gregturn/react-and-spring-data-rest/tree/master/security&quot;&gt;grab the code&lt;/a&gt; from this repository and follow along. This session is based on the previous session’s app with extra things added.&lt;/p&gt; 
  &lt;/div&gt; 
 &lt;/div&gt; 
&lt;/div&gt;
" />
<meta name="twitter:creator" content="@gregturn" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/43e9a9d63f7f4f9891c9fcd592b89cfa?s=200" />

<meta property="og:title" content="React.js and Spring Data REST: Part 5 - Security" />
<meta property="og:image" content="https://gravatar.com/avatar/43e9a9d63f7f4f9891c9fcd592b89cfa?s=200" />
<meta property="og:description" content="&lt;div id=&quot;preamble&quot;&gt; 
 &lt;div class=&quot;sectionbody&quot;&gt; 
  &lt;div class=&quot;admonitionblock note&quot;&gt; 
   &lt;table&gt; 
    &lt;tbody&gt; 
     &lt;tr&gt; 
      &lt;td class=&quot;icon&quot;&gt; &lt;i class=&quot;fa icon-note&quot; title=&quot;Note&quot;&gt;&lt;/i&gt; &lt;/td&gt; 
      &lt;td class=&quot;content&quot;&gt;To see updates to this code, visit our &lt;a href=&quot;https://spring.io/guides/tutorials/react-and-spring-data-rest/&quot;&gt;React.js and Spring Data REST tutorial&lt;/a&gt;.&lt;/td&gt; 
     &lt;/tr&gt; 
    &lt;/tbody&gt; 
   &lt;/table&gt; 
  &lt;/div&gt; 
  &lt;div class=&quot;paragraph&quot;&gt; 
   &lt;p&gt;In the &lt;a href=&quot;https://spring.io/blog/2015/10/13/react-js-and-spring-data-rest-part-4-events&quot;&gt;previous session&lt;/a&gt;, you made the app dynamically response to updates from other users via Spring Data REST’s built in event handlers and the Spring Framework’s WebSocket support. But no application is complete without securing the whole thing so that only proper users have access to the UI and the resources behind it.&lt;/p&gt; 
  &lt;/div&gt; 
  &lt;div class=&quot;paragraph&quot;&gt; 
   &lt;p&gt;Feel free to &lt;a href=&quot;https://github.com/gregturn/react-and-spring-data-rest/tree/master/security&quot;&gt;grab the code&lt;/a&gt; from this repository and follow along. This session is based on the previous session’s app with extra things added.&lt;/p&gt; 
  &lt;/div&gt; 
 &lt;/div&gt; 
&lt;/div&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2015-10-28 14:04:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">React.js and Spring Data REST: Part 5 - Security</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/43e9a9d63f7f4f9891c9fcd592b89cfa?s=20&amp;d=mm" />
<a class="author" rel="author" href="/team/gturnquist">Greg Turnquist</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2015-10-28 14:04:00.0">October 28, 2015</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="2288" href="/blog/2015/10/28/react-js-and-spring-data-rest-part-5-security#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><div id="preamble">
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tbody>
<tr>
<td class="icon"> <i class="fa icon-note" title="Note"></i> </td>
<td class="content">To see updates to this code, visit our <a href="https://spring.io/guides/tutorials/react-and-spring-data-rest/">React.js and Spring Data REST tutorial</a>.</td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph">
<p>In the <a href="https://spring.io/blog/2015/10/13/react-js-and-spring-data-rest-part-4-events">previous session</a>, you made the app dynamically response to updates from other users via Spring Data REST&#8217;s built in event handlers and the Spring Framework&#8217;s WebSocket support. But no application is complete without securing the whole thing so that only proper users have access to the UI and the resources behind it.</p>
</div>
<div class="paragraph">
<p>Feel free to <a href="https://github.com/gregturn/react-and-spring-data-rest/tree/master/security">grab the code</a> from this repository and follow along. This session is based on the previous session&#8217;s app with extra things added.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_spring_security_to_the_project">Adding Spring Security to the project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before getting underway, you need to add a couple dependencies to your project&#8217;s pom.xml file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.thymeleaf.extras&lt;/groupId&gt;
    &lt;artifactId&gt;thymeleaf-extras-springsecurity4&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This bring in Spring Boot&#8217;s Spring Security starter as well as some extra Thymeleaf tags to do security look ups in the web page.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_defining_the_security_model">Defining the security model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the past session, you have worked with a nice payroll system. It&#8217;s handy to declare things on the backend and let Spring Data REST do the heavy lifting. The next step is to model a system where security controls need to be instituted.</p>
</div>
<div class="paragraph">
<p>If this is a payroll system, then only managers would be accessing it. So kick things off by modeling a <code>Manager</code> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Data
@ToString(exclude = "password")
@Entity
public class Manager {

	public static final PasswordEncoder PASSWORD_ENCODER = new BCryptPasswordEncoder();

	private @Id @GeneratedValue Long id;

	private String name;

	private @JsonIgnore String password;

	private String[] roles;

	public void setPassword(String password) {
		this.password = PASSWORD_ENCODER.encode(password);
	}

	protected Manager() {}

	public Manager(String name, String password, String... roles) {

		this.name = name;
		this.setPassword(password);
		this.roles = roles;
	}

}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<code>PASSWORD_ENCODER</code> is the means to encrypt new passwords or to take password inputs and encrypt them before comparison.
</li>
<li>
<code>id</code>, <code>name</code>, <code>password</code>, and <code>roles</code> define the parameters needed to restrict access.
</li>
<li>
<p>The customized <code>setPassword()</code> ensures that passwords are never stored in the clear.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a key thing to keep in mind when designing your security layer. Secure the right bits of data (like passwords) and do NOT let them get printed to console, into logs, or exported via JSON serialization.</p>
</div>
<div class="ulist">
<ul>
<li>
<code>@ToString(exclude = "password")</code> ensures that the Lombok-generated toString() method will NOT print out the password.
</li>
<li>
<code>@JsonIgnore</code> applied to the password field protects from Jackson serializing this field.
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_a_manager_s_repository">Creating a manager&#8217;s repository</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Data is so good at managing entities. Why not create a repository to handle these managers?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@RepositoryRestResource(exported = false)
public interface ManagerRepository extends Repository&lt;Manager, Long&gt; {

	Manager save(Manager manager);

	Manager findByName(String name);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of extending the usual <code>CrudRepository</code>, you don&#8217;t need so many methods. Instead, you need to save data (which is also used for updates) and you need to look up existing users. Hence, you can use Spring Data Common&#8217;s minimal <code>Repository</code> marker interface. It comes with no predefined operations.</p>
</div>
<div class="paragraph">
<p>Spring Data REST, by default, will export any repository it finds. You do NOT want this repository exposed for REST operations! Apply the <code>@RepositoryRestResource(exported = false)</code> annotation to block it from export. This prevents the repository from being served up as well as any metadata.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_linking_employees_with_their_managers">Linking employees with their managers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The last bit of modeling security is to associate employees with a manager. In this domain, an employee can have one manager while a manager can have multiple employees:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Data
@Entity
public class Employee {

	private @Id @GeneratedValue Long id;
	private String firstName;
	private String lastName;
	private String description;

	private @Version @JsonIgnore Long version;

	private @ManyToOne Manager manager;

	private Employee() {}

	public Employee(String firstName, String lastName, String description, Manager manager) {
		this.firstName = firstName;
		this.lastName = lastName;
		this.description = description;
		this.manager = manager;
	}
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
The manager attribute is linked via JPA&#8217;s <code>@ManyToOne</code>. Manager doesn&#8217;t need the <code>@OneToMany</code> because you haven&#8217;t defined the need to look that up.
</li>
<li>
The utility constructor call is updated to support initialization.
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_securing_employees_to_their_managers">Securing employees to their managers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Security supports a multitude of options when it comes to defining security policies. In this session, you want to restrict things such that ONLY managers can view employee payroll data, and that saving, updating, and deleting operations are confined to the employee&#8217;s manager. In other words, any manager can log in and view the data, but only a given employee&#8217;s manager can make any changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@PreAuthorize("hasRole('ROLE_MANAGER')")
public interface EmployeeRepository extends PagingAndSortingRepository&lt;Employee, Long&gt; {

	@Override
	@PreAuthorize("#employee?.manager == null or #employee?.manager?.name == authentication?.name")
	Employee save(@Param("employee") Employee employee);

	@Override
	@PreAuthorize("@employeeRepository.findOne(#id)?.manager?.name == authentication?.name")
	void delete(@Param("id") Long id);

	@Override
	@PreAuthorize("#employee?.manager?.name == authentication?.name")
	void delete(@Param("employee") Employee employee);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@PreAuthorize</code> at the top of the interface restricts access to people with <strong>ROLE_MANAGER</strong>.</p>
</div>
<div class="paragraph">
<p>On <code>save()</code>, either the employee&#8217;s manager is null (initial creation of a new employee when no manager has been assigned), or the employee&#8217;s manager&#8217;s name matches the currently authenticated user&#8217;s name. Here you are using <a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#el-access">Spring Security&#8217;s SpEL expressions</a> to define access. It comes with a handy "?." property navigator to handle null checks. It&#8217;s also important to note using the <code>@Param(&#8230;&#8203;)</code> on the arguments to link HTTP operations with the methods.</p>
</div>
<div class="paragraph">
<p>On <code>delete()</code>, the method either has access to the employee, or in the event it only has an id, then it must find the <strong>employeeRepository</strong> in the application context, perform a <code>findOne(id)</code>, and then check the manager against the currently authenticated user.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_writing_a_code_userdetails_code_service">Writing a <code>UserDetails</code> service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A common point of integration with security is to define a <code>UserDetailsService</code>. This is the way to connect your user&#8217;s data store into a Spring Security interface. Spring Security needs a way to look up users for security checks, and this is the bridge. Thankfully with Spring Data, the effort is quite minimal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Component
public class SpringDataJpaUserDetailsService implements UserDetailsService {

	private final ManagerRepository repository;

	@Autowired
	public SpringDataJpaUserDetailsService(ManagerRepository repository) {
		this.repository = repository;
	}

	@Override
	public UserDetails loadUserByUsername(String name) throws UsernameNotFoundException {
		Manager manager = this.repository.findByName(name);
		return new User(manager.getName(), manager.getPassword(),
				AuthorityUtils.createAuthorityList(manager.getRoles()));
	}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>SpringDataJpaUserDetailsService</code> implements Spring Security&#8217;s <code>UserDetailsService</code>. The interface has one method: <code>loadByUsername()</code>. This method is meant to return a <code>UserDetails</code> object so Spring Security can interrogate the user&#8217;s information.</p>
</div>
<div class="paragraph">
<p>Because you have a <code>ManagerRepository</code>, there is no need to write any SQL or JPA expressions to fetch this needed data. In this class, it is autowired by constructor injection.</p>
</div>
<div class="paragraph">
<p><code>loadByUsername()</code> taps into the custom finder you write a moment ago, <code>findByName()</code>. It then populates a Spring Security <code>User</code> instance, which implements the <code>UserDetails</code> interface. You are also using Spring Securiy&#8217;s <code>AuthorityUtils</code> to transition from an array of string-based roles into a Java <code>List</code> of <code>GrantedAuthority</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wiring_up_your_security_policy">Wiring up your security policy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>@PreAuthorize</code> expressions applied to your repository are <strong>access rules</strong>. These rules are for nought without a security policy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfiguration extends WebSecurityConfigurerAdapter {

	@Autowired
	private SpringDataJpaUserDetailsService userDetailsService;

	@Override
	protected void configure(AuthenticationManagerBuilder auth) throws Exception {
		auth
			.userDetailsService(this.userDetailsService)
				.passwordEncoder(Manager.PASSWORD_ENCODER);
	}

	@Override
	protected void configure(HttpSecurity http) throws Exception {
		http
			.authorizeRequests()
				.antMatchers("/bower_components/**", "/*.js",
						"/*.jsx", "/main.css").permitAll()
				.anyRequest().authenticated()
				.and()
			.formLogin()
				.defaultSuccessUrl("/", true)
				.permitAll()
				.and()
			.httpBasic()
				.and()
			.csrf().disable()
			.logout()
				.logoutSuccessUrl("/");
	}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code has a lot of complexity in it, so let&#8217;s walk through it, first talking about the annotations and APIs. Then we&#8217;ll discuss the security policy it defines.</p>
</div>
<div class="ulist">
<ul>
<li>
<code>@EnableWebSecurity</code> tells Spring Boot to drop its autoconfigured security policy and use this one instead. For quick demos, autoconfigured security is okay. But for anything real, you should write the policy yourself.
</li>
<li>
<code>@EnableGlobalMethodSecurity</code> turns on method-level security with Spring Security&#8217;s sophisticated <a href="https://docs.spring.io/spring-security/site/docs/current/reference/htmlsingle/#el-pre-post-annotations">@Pre and @Post annotations</a>.
</li>
<li>
It extends <code>WebSecsurityConfigurerAdapter</code>, a handy base class to write policy.
</li>
<li>
It autowired the <code>SpringDataJpaUserDetailsService</code> by field inject and then plugs it in via the <code>configure(AuthenticationManagerBuilder)</code> method. The <code>PASSWORD_ENCODER</code> from <code>Manager</code> is also setup.
</li>
<li>
The pivotal security policy is written in pure Java with the <code>configure(HttpSecurity)</code>.
</li>
</ul>
</div>
<div class="paragraph">
<p>The security policy says to authorize all requests using the access rules defined earlier.</p>
</div>
<div class="ulist">
<ul>
<li>
The paths listed in <code>antMatchers()</code> are granted unconditional access since there is no reason to block static web resources.
</li>
<li>
Anything that doesn&#8217;t match that falls into <code>anyRequest().authenticated()</code> meaning it requires authentication.
</li>
<li>
With those access rules setup, Spring Security is told to use form-based authentication, defaulting to "/" upon success, and to grant access to the login page.
</li>
<li>
BASIC login is also configured with CSRF disabled. This is mostly for demonstrations and not recommended for production systems without careful analysis.
</li>
<li>
Logout is configured to take the user to "/".
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
BASIC authentication is handy when you are experimenting with curl. Using curl to access a form-based system is daunting. It&#8217;s important to recognize that authenticting with any mechanism over HTTP (not HTTPS) puts you at risk of credentials being sniffed over the wire. CSRF is a good protocol to leave intact. It is simply disabled to make interaction with BASIC and curl easier. In production, it&#8217;s best to leave it on.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_security_details_automatically">Adding security details automatically</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A good user experience is when the application can automatically apply context. In this example, if a logged in manager creates a new employee record, it makes sense for that manager to own it. With Spring Data REST&#8217;s event handlers, there is no need for the user to explicitly link it. It also ensures the user doesn&#8217;t accidentally records to the wrong manager.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Component
@RepositoryEventHandler(Employee.class)
public class SpringDataRestEventHandler {

	private final ManagerRepository managerRepository;

	@Autowired
	public SpringDataRestEventHandler(ManagerRepository managerRepository) {
		this.managerRepository = managerRepository;
	}

	@HandleBeforeCreate
	public void applyUserInformationUsingSecurityContext(Employee employee) {

		String name = SecurityContextHolder.getContext().getAuthentication().getName();
		Manager manager = this.managerRepository.findByName(name);
		if (manager == null) {
			Manager newManager = new Manager();
			newManager.setName(name);
			newManager.setRoles(new String[]{"ROLE_MANAGER"});
			manager = this.managerRepository.save(newManager);
		}
		employee.setManager(manager);
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@RepositoryEventHandler(Employee.class)</code> flags this event handler as only applied to <code>Employee</code> objects. The <code>@HandleBeforeCreate</code> annotation gives you a chance to alter the incoming <code>Employee</code> record before it gets written to the database.</p>
</div>
<div class="paragraph">
<p>In this sitation, you lookup the current user&#8217;s security context to get the user&#8217;s name. Then look up the associated manager using <code>findByName()</code> and apply it to the manager. There is a little extra glue code to create a new manager if he or she doesn&#8217;t exist in the system yet. But that is mostly to support initialization of the database. In a real production system, that code should be removed and instead depend on the DBAs or Security Ops team to properly maintain the user data store.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pre_loading_manager_data">Pre-loading manager data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Loading managers and linking employees to these managers is rather straight forward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Component
public class DatabaseLoader implements CommandLineRunner {

	private final EmployeeRepository employees;
	private final ManagerRepository managers;

	@Autowired
	public DatabaseLoader(EmployeeRepository employeeRepository,
						  ManagerRepository managerRepository) {

		this.employees = employeeRepository;
		this.managers = managerRepository;
	}

	@Override
	public void run(String... strings) throws Exception {

		Manager greg = this.managers.save(new Manager("greg", "turnquist",
							"ROLE_MANAGER"));
		Manager oliver = this.managers.save(new Manager("oliver", "gierke",
							"ROLE_MANAGER"));

		SecurityContextHolder.getContext().setAuthentication(
			new UsernamePasswordAuthenticationToken("greg", "doesn't matter",
				AuthorityUtils.createAuthorityList("ROLE_MANAGER")));

		this.employees.save(new Employee("Frodo", "Baggins", "ring bearer", greg));
		this.employees.save(new Employee("Bilbo", "Baggins", "burglar", greg));
		this.employees.save(new Employee("Gandalf", "the Grey", "wizard", greg));

		SecurityContextHolder.getContext().setAuthentication(
			new UsernamePasswordAuthenticationToken("oliver", "doesn't matter",
				AuthorityUtils.createAuthorityList("ROLE_MANAGER")));

		this.employees.save(new Employee("Samwise", "Gamgee", "gardener", oliver));
		this.employees.save(new Employee("Merry", "Brandybuck", "pony rider", oliver));
		this.employees.save(new Employee("Peregrin", "Took", "pipe smoker", oliver));

		SecurityContextHolder.clearContext();
	}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The one wrinkle is that Spring Security is active with access rules in full force when this loader runs. Thus to save employee data, you must use Spring Security&#8217;s <code>setAuthentication()</code> API to authenticate this loader with the proper name and role. At the end, the security context is cleared out.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_touring_your_secured_rest_service">Touring your secured REST service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With all these mods in place, you can fire up the application (<code>./mvnw spring-boot:run</code>) and check out the mods using cURL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ curl -v -u greg:turnquist localhost:8080/api/employees/1
*   Trying ::1...
* Connected to localhost (::1) port 8080 (#0)
* Server auth using Basic with user 'greg'
&gt; GET /api/employees/1 HTTP/1.1
&gt; Host: localhost:8080
&gt; Authorization: Basic Z3JlZzp0dXJucXVpc3Q=
&gt; User-Agent: curl/7.43.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 OK
&lt; Server: Apache-Coyote/1.1
&lt; X-Content-Type-Options: nosniff
&lt; X-XSS-Protection: 1; mode=block
&lt; Cache-Control: no-cache, no-store, max-age=0, must-revalidate
&lt; Pragma: no-cache
&lt; Expires: 0
&lt; X-Frame-Options: DENY
&lt; Set-Cookie: JSESSIONID=E27F929C1836CC5BABBEAB78A548DF8C; Path=/; HttpOnly
&lt; ETag: "0"
&lt; Content-Type: application/hal+json;charset=UTF-8
&lt; Transfer-Encoding: chunked
&lt; Date: Tue, 25 Aug 2015 15:57:34 GMT
&lt;
{
  "firstName" : "Frodo",
  "lastName" : "Baggins",
  "description" : "ring bearer",
  "manager" : {
    "name" : "greg",
    "roles" : [ "ROLE_MANAGER" ]
  },
  "_links" : {
    "self" : {
      "href" : "http://localhost:8080/api/employees/1"
    }
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p>This shows a lot more details than during the first session. First of all, Spring Security turns on several HTTP protocols to protect against various attack vectors (Pragma, Expires, X-Frame-Options, etc.). You are also issuing BASIC credentials with <code>-u greg:turnquist</code> which renders the Authorization header.</p>
</div>
<div class="paragraph">
<p>Amidst all the headers, you can see the <strong>ETag</strong> header from your versioned resource.</p>
</div>
<div class="paragraph">
<p>Finally, inside the data itself, you can see a new attribute: <strong>manager</strong>. You can see that it includes the name and roles, but NOT the password. That is due to using <code>@JsonIgnore</code> on that field. Because Spring Data REST didn&#8217;t export that repository, it&#8217;s values are inlined in this resource. You&#8217;ll put that to good use as you update the UI in the next section.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_displaying_manager_info_on_the_ui">Displaying manager info on the UI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With all these mods in the backend, you can now shift to updating things in the frontend. First of all, show an employee&#8217;s manager inside the `&lt;Employee /&gt; ` React component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var Employee = React.createClass({
    handleDelete: function () {
        this.props.onDelete(this.props.employee);
    },
    render: function () {
        return (
            &lt;tr&gt;
                &lt;td&gt;{this.props.employee.entity.firstName}&lt;/td&gt;
                &lt;td&gt;{this.props.employee.entity.lastName}&lt;/td&gt;
                &lt;td&gt;{this.props.employee.entity.description}&lt;/td&gt;
                &lt;td&gt;{this.props.employee.entity.manager.name}&lt;/td&gt;
                &lt;td&gt;
                    &lt;UpdateDialog employee={this.props.employee}
                                  attributes={this.props.attributes}
                                  onUpdate={this.props.onUpdate}/&gt;
                &lt;/td&gt;
                &lt;td&gt;
                    &lt;button onClick={this.handleDelete}&gt;Delete&lt;/button&gt;
                &lt;/td&gt;
            &lt;/tr&gt;
        )
    }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>This merely adds a column for <code>this.props.employee.entity.manager.name</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_filtering_out_json_schema_metadata">Filtering out JSON Schema metadata</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If a field is shown in the data output, it is safe to assume it has an entry in the JSON Schema metadata. You can see it in the following excerpt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
	...
    "manager" : {
      "readOnly" : false,
      "$ref" : "#/descriptors/manager"
    },
    ...
  },
  ...
  "$schema" : "http://json-schema.org/draft-04/schema#"
}</pre>
</div>
</div>
<div class="paragraph">
<p>The manager field isn&#8217;t something you want people to edit directly. Since it&#8217;s inlined, it should be viewed as a read only attribute. To filter it out inlined entries from the <code>CreateDialog</code> and <code>UpdatDialog</code>, just delete such entries after fetching the JSON Schema metadata.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">/**
 * Filter unneeded JSON Schema properties, like uri references and
 * subtypes ($ref).
 */
Object.keys(schema.entity.properties).forEach(function (property) {
    if (schema.entity.properties[property].hasOwnProperty('format') &amp;&amp;
        schema.entity.properties[property].format === 'uri') {
        delete schema.entity.properties[property];
    }
    if (schema.entity.properties[property].hasOwnProperty('$ref')) {
        delete schema.entity.properties[property];
    }
});

this.schema = schema.entity;
this.links = employeeCollection.entity._links;
return employeeCollection;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code trims out both URI relations as well as $ref entries.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_trapping_for_unauthorized_access">Trapping for unauthorized access</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With security checks configured on the backend, add a handler in case someone tries to update a record without authorization:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">onUpdate: function (employee, updatedEmployee) {
    client({
        method: 'PUT',
        path: employee.entity._links.self.href,
        entity: updatedEmployee,
        headers: {
            'Content-Type': 'application/json',
            'If-Match': employee.headers.Etag
        }
    }).done(response =&gt; {
        /* Let the websocket handler update the state */
    }, response =&gt; {
        if (response.status.code === 403) {
            alert('ACCESS DENIED: You are not authorized to update ' +
                employee.entity._links.self.href);
        }
        if (response.status.code === 412) {
            alert('DENIED: Unable to update ' + employee.entity._links.self.href +
                '. Your copy is stale.');
        }
    });
},</code></pre>
</div>
</div>
<div class="paragraph">
<p>You had code to catch an HTTP 412 error. This traps an HTTP 403 status code and provides a suitable alert.</p>
</div>
<div class="paragraph">
<p>Do the same for delete operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">onDelete: function (employee) {
    client({method: 'DELETE', path: employee.entity._links.self.href}
    ).done(response =&gt; {/* let the websocket handle updating the UI */},
    response =&gt; {
        if (response.status.code === 403) {
            alert('ACCESS DENIED: You are not authorized to delete ' +
                employee.entity._links.self.href);
        }
    });
},</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is coded similarly with a tailored error messages.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_some_security_details_to_the_ui">Add some security details to the UI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The last thing to crown this version of the app is to display who is logged in as well providing a logout button.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;div&gt;
    Hello, &lt;span th:text="${#authentication.name}"&gt;user&lt;/span&gt;.
    &lt;form th:action="@{/logout}" method="post"&gt;
        &lt;input type="submit" value="Log Out"/&gt;
    &lt;/form&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_putting_it_all_together">Putting it all together</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With these changes in the frontend, restart the application and navigate to <a href="http://localhost:8080" class="bare">http://localhost:8080</a>.</p>
</div>
<div class="paragraph">
<p>You are immediately redirected to a login form. This form is supplied by Spring Security, though you can <a href="https://spring.io/guides/gs/securing-web/">create your own</a> if you wish. Login as greg / turnquist.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/gregturn/react-and-spring-data-rest/raw/master/security/images/security-1.png" alt="security 1">
</div>
</div>
<div class="paragraph">
<p>You can see the newly added manager column. Go through a couple pages until you find employees owned by <strong>oliver</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/gregturn/react-and-spring-data-rest/raw/master/security/images/security-2.png" alt="security 2">
</div>
</div>
<div class="paragraph">
<p>Click on <strong>Update</strong>, make some changes, and then hit <strong>Update</strong>. It should fail with the following pop-up:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://github.com/gregturn/react-and-spring-data-rest/raw/master/security/images/security-3.png" alt="security 3">
</div>
</div>
<div class="paragraph">
<p>If you try <strong>Delete</strong>, it should fail with a similar message. Create a new employee, and it should be assigned to you.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_review">Review</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this session:</p>
</div>
<div class="ulist">
<ul>
<li>
You defined the model of manager and linked it to an employee via a 1-to-many relationship.
</li>
<li>
You created a repository for managers and told Spring Data REST to not export.
</li>
<li>
You wrote a set of access rules for the empoyee repository and also write a security policy.
</li>
<li>
You wrote another Spring Data REST event handler to trap creation events before they happen so they current user could be assigned as the employee&#8217;s manager.
</li>
<li>
You updated the UI to show an employee&#8217;s manager and also display error pop-ups when unauthorized actions are taken.
</li>
</ul>
</div>
<div class="paragraph">
<p>Issues?</p>
</div>
<div class="paragraph">
<p>The webpage has become quite sophisticated. But what about managing relationships and inlined data? The create/update dialogs aren&#8217;t really suited for that. It might require some custom written forms.</p>
</div>
<div class="paragraph">
<p>Managers have access to employee data. Should employees have access? If you were to add more details like phone numbers and addresses, how would you model it? How would you grant employees access to the system so they could update those specific fields? Are there more hypermedia controls that would be handy to put on the page? I hope you liked this series.</p>
</div>
</div>
</div></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 2288;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>