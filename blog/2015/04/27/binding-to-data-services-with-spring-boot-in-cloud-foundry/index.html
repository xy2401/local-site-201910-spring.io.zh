<html dir="ltr" data-code-prettify="" data-mobile-support="" data-search=""><head>
<title>在Cloud Foundry中使用Spring Boot绑定到数据服务</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>System.config({baseURL: "/b92013b"});</script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>System.import('app/main.js')</script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="Binding to Data Services with Spring Boot in Cloud Foundry">
<meta name="twitter:description" content="<p>In this article we look at how to bind a <a href=" http:="" ="" projects.spring.io="" spring-boo="="></head><body dir="ltr">Spring Boot application to data services (JDBC, NoSQL, messaging etc.) and the various sources of default and automatic behaviour in <a href="http://pivotal.io/cloud">Cloud Foundry</a>, providing some guidance about which ones to use and which ones will be active under what conditions. Spring Boot provides a lot of autoconfiguration and external binding features, some of which are relevant to Cloud Foundry, and many of which are not. <a href="http://cloud.spring.io/spring-cloud-connectors">Spring Cloud Connectors</a> is a library that you can use in your application if you want to create your own components programmatically, but it doesn’t do anything “magical” by itself. And finally there is the Cloud Foundry <a href="https://github.com/cloudfoundry/java-buildpack">java buildpack</a> which has an “auto-reconfiguration” feature that tries to ease the burden of moving simple applications to the cloud. The key to correctly configuring middleware services, like JDBC or AMQP or Mongo, is to understand what each of these tools provides, how they influence each other at runtime, and and to switch parts of them on and off. The goal should be a smooth transition from local execution of an application on a developer’s desktop to a test environment in Cloud Foundry, and ultimately to production in Cloud Foundry (or otherwise) with no changes in source code or packaging, per the <a href="http://12factor.net">twelve-factor application</a> guidelines.
">
<meta name="twitter:creator" content="@david_syer">
<meta name="twitter:image:src" content="https://gravatar.com/avatar/ae671230e3a1c2a0eefa7604990084f1?s=200">

<meta property="og:title" content="Binding to Data Services with Spring Boot in Cloud Foundry">
<meta property="og:image" content="https://gravatar.com/avatar/ae671230e3a1c2a0eefa7604990084f1?s=200">
<meta property="og:description" content="<p>In this article we look at how to bind a <a href=" http:="" ="" projects.spring.io="" spring-boo="=">Spring Boot application to data services (JDBC, NoSQL, messaging etc.) and the various sources of default and automatic behaviour in <a href="http://pivotal.io/cloud">Cloud Foundry</a>, providing some guidance about which ones to use and which ones will be active under what conditions. Spring Boot provides a lot of autoconfiguration and external binding features, some of which are relevant to Cloud Foundry, and many of which are not. <a href="http://cloud.spring.io/spring-cloud-connectors">Spring Cloud Connectors</a> is a library that you can use in your application if you want to create your own components programmatically, but it doesn’t do anything “magical” by itself. And finally there is the Cloud Foundry <a href="https://github.com/cloudfoundry/java-buildpack">java buildpack</a> which has an “auto-reconfiguration” feature that tries to ease the burden of moving simple applications to the cloud. The key to correctly configuring middleware services, like JDBC or AMQP or Mongo, is to understand what each of these tools provides, how they influence each other at runtime, and and to switch parts of them on and off. The goal should be a smooth transition from local execution of an application on a developer’s desktop to a test environment in Cloud Foundry, and ultimately to production in Cloud Foundry (or otherwise) with no changes in source code or packaging, per the <a href="http://12factor.net">twelve-factor application</a> guidelines.
">
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2015-04-27 14:10:00.0">



<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">// Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }</script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">在Cloud Foundry中使用Spring Boot绑定到数据服务</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/ae671230e3a1c2a0eefa7604990084f1?s=20&d=mm"> <a class="author" rel="author" href="/team/dsyer">戴夫·瑟</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2015-04-27 14:10:00.0">2015年4月27日</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2015/04/27/binding-to-data-services-with-spring-boot-in-cloud-foundry#disqus_thread" data-disqus-identifier="2093">
</a></div>
</div>
</header>
<div class="blog--post"><p>在本文中，我们研究了如何将<a href="https://projects.spring.io/spring-boot">Spring Boot</a>应用程序绑定到数据服务（JDBC，NoSQL，消息传递等）以及<a href="https://pivotal.io/cloud">Cloud Foundry中</a>各种默认和自动行为的来源，并提供了有关使用哪些以及将使用哪些的指南。在什么条件下保持活跃。Spring Boot提供了许多自动配置和外部绑定功能，其中一些与Cloud Foundry相关，而许多则与Cloud Foundry不相关。<a href="https://cloud.spring.io/spring-cloud-connectors">Spring Cloud Connectors</a>是一个库，如果您想以编程方式创建自己的组件，可以在应用程序中使用它，但是它本身并没有做任何“神奇的事情”。最后是Cloud Foundry <a href="https://github.com/cloudfoundry/java-buildpack">java buildpack</a> ，它具有“自动重新配置”功能，该功能试图减轻将简单应用程序迁移到云的负担。正确配置诸如JDBC或AMQP或Mongo之类的中间件服务的关键是要了解这些工具各自提供的功能，它们在运行时如何相互影响以及将它们的某些部分打开和关闭。目标应该是从开发人员桌面上的应用程序本地执行到Cloud Foundry中的测试环境的平稳过渡，并最终过渡到Cloud Foundry中的生产（或其他方式），而无需更改源代码或打包，这<a href="http://12factor.net">十二个要素应用</a>指南。</p>
<p>本文附带一些<a href="https://github.com/dsyer/cloud-middleware-blog">简单的源代码</a> 。要使用它，您可以克隆存储库并将其导入到您喜欢的IDE中。您将需要从整个项目中删除两个依赖项，以达到我们开始讨论具体代码示例的同一点，即<code>spring-boot-starter-cloud-connectors</code>和<code>auto-reconfiguration</code> 。</p>
<blockquote>
<p>注意：正在讨论的所有库的当前坐标为<code>org.springframework.boot:spring-boot-*:1.2.3.RELEASE</code> ， <code>org.springframework.cloud:spring-cloud-*-connector:1.1.1.RELEASE</code> ， <code>org.cloudfoundry:auto-reconfiguration:1.7.0.RELEASE</code> 。</p>
<p>提示：github中的源代码包括<code>docker-compose.yml</code>文件。如果尚未运行本地MySQL数据库，则可以使用它来创建本地MySQL数据库。您实际上并不需要它来运行下面的大多数代码，但它可能对验证其是否有效很有用。</p>
</blockquote><h2><a href="#punchline-for-the-impatient" class="anchor" name="punchline-for-the-impatient"></a>不耐烦的打孔电话</h2>
<p>如果您想跳过这些细节，而您只需要使用H2在本地运行以及使用MySQL在云中运行的方法，那么从这里开始，然后在您想更深入地了解其他内容时阅读其余内容。（对于其他数据服务，例如RabbitMQ，Redis，Mongo等，也存在类似的选项。）</p>
<p>您的第一个也是最简单的选择是什么都不做：根本不定义<code>DataSource</code>而是将H2放在类路径上。春天开机时会创建嵌入H2 <code>DataSource</code>你，当你在本地运行。当您在云中运行时，Cloud Foundry buildpack将检测数据库服务绑定并为您创建一个<code>DataSource</code> 。如果还添加了Spring Cloud Connectors，则只要包含连接器，您的应用程序就可以在其他云平台上运行。如果您只想使某些工作正常，那可能就足够了。</p>
<p>如果要在生产中运行严肃的应用程序，则可能需要调整一些连接池设置（例如，池的大小，各种超时，对借位标志的重要测试）。在这种情况下，buildpack自动重新配置<code>DataSource</code>不能满足您的要求，您需要选择一种替代，有一些或多或少明智的选择。</p>
<p>最好的选择可能是使用<a href="https://cloud.spring.io/spring-cloud-connectors">Spring Cloud Connectors</a>显式创建一个<code>DataSource</code> ，但要受“ cloud”配置文件的保护：</p>
<pre><code class="prettyprint java">@Configuration
@Profile("cloud")
public class DataSourceConfiguration {

  @Bean
  public Cloud cloud() {
    return new CloudFactory().getCloud();
  }

  @Bean
  @ConfigurationProperties(DataSourceProperties.PREFIX)
  public DataSource dataSource() {
    return cloud().getSingletonServiceConnector(DataSource.class, null);
  }

}
</code></pre>
<p>您可以使用<code>spring.datasource.*</code>属性（例如，在<code>application.properties</code>或特定于配置文件的版本中）在运行时设置其他属性。buildpack将自动为您激活“云”配置文件。</p>
<p>现在了解详细信息。我们需要对运行时应用程序中发生的事情进行了解，因此我们可以从中学习如何为配置数据服务做出明智的选择。</p><h2><a href="#layers-of-autoconfiguration" class="anchor" name="layers-of-autoconfiguration"></a>自动配置层</h2>
<p>让我们使用一个带有<code>DataSource</code>简单应用程序（类似的考虑适用于RabbitMQ，Mongo和Redis）：</p>
<pre><code class="prettyprint java">@SpringBootApplication
public class CloudApplication {
	
	@Autowired
	private DataSource dataSource;
	
	public static void main(String[] args) {
		SpringApplication.run(CloudApplication.class, args);
	}

}
</code></pre>
<p>这是一个完整的应用程序： <code>DataSource</code>可以<code>@Autowired</code>因为它是由Spring Boot为我们创建的。<code>DataSource</code>的详细信息（具体类，JDBC驱动程序，连接URL等）取决于类路径上的内容。假设应用程序通过<code>spring-boot-starter-jdbc</code> （或<code>spring-boot-starter-data-jpa</code> ）使用Spring JDBC，因此它具有可从Tomcat获得的<code>DataSource</code>实现（即使它不是Web应用程序） ，这就是Spring Boot的用途。</p>
<p>考虑以下情况时会发生什么：</p>
<ul>
<li>
<p>CLASSPATH包含H2（只），除首发：该<code>DataSource</code>是从Tomcat高性能池<code>DataSourceAutoConfiguration</code>并将其连接到内存数据库“TESTDB”。</p></li>
<li>
<p>Classpath包含H2和MySQL： <code>DataSource</code>仍然是H2（与以前相同），因为我们没有为MySQL提供任何其他配置，并且Spring Boot无法猜测用于连接的凭据。</p></li>
<li>
<p>将<code>spring-boot-starter-cloud-connectors</code>到类路径： <code>DataSource</code>没有更改，因为Spring Cloud Connector不会检测到它们正在Cloud平台中运行。初学者附带的提供程序都在寻找特定的环境变量，除非您进行设置或在Cloud Foundry，Heroku等中运行该应用程序，否则它们将找不到。</p></li>
<li>
<p>使用<code>spring.profiles.active=cloud</code>在“云”配置文件中运行应用程序： <code>DataSource</code>尚未更改，但这是当您的应用程序在Cloud Foundry中运行时<a href="https://github.com/cloudfoundry/java-buildpack">Java buildpack</a>要做的事情之一。</p></li>
<li>
<p>在“ cloud”配置文件中运行，并提供一些环境变量来模拟在Cloud Foundry中运行并绑定到MySQL服务：</p>
<pre><code class="prettyprint">VCAP_APPLICATION={"name":"application","instance_id":"FOO"}
VCAP_SERVICES={"mysql":[{"name":"mysql","tags":["mysql"],"credentials":{"uri":"mysql://root:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="4634292932062a2925272a2e293532">[email protected]</a>/test"}}]}
</code></pre>
<p>（“标签”提示我们要创建一个MySQL <code>DataSource</code> ，“ uri”提供位置，“名称”成为bean ID）。现在， <code>DataSource</code>正在使用MySQL和<code>VCAP_*</code>环境变量提供的凭据。Spring Boot对连接器有一些自动配置，因此，如果您查看应用程序中的bean，您会看到一个<code>CloudFactory</code> bean和<code>DataSource</code> bean（ID为“ mysql”）。<a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/cloud/CloudAutoConfiguration.java">自动配置</a>等效于将<code>@ServiceScan</code>添加到您的应用程序配置中。仅当您的应用程序在“ cloud”配置文件中运行，并且仅当不存在<code>Cloud</code>类型的<code>@Bean</code>且配置标志<code>spring.cloud.enabled</code>不是“ false”时，它才处于活动状态。</p></li>
<li>
<p>从Java buildpack中添加“自动重新配置” JAR（Maven协调<code>org.cloudfoundry:auto-reconfiguration:1.7.0.RELEASE</code> ）。您可以将其添加为本地依赖项，以模拟在Cloud Foundry中运行应用程序，但是对实际应用程序执行此操作是不正常的（这只是为了试验自动配置）。自动重配置JAR现在具有创建<code>DataSource</code>所需的一切，但还没有（尚未），因为它检测到您已经具有类型为<code>CloudFactory</code>的bean，该bean是Spring Boot添加的。</p></li>
<li>
<p>删除明确的“云”配置文件。当您的应用启动时，配置文件仍将处于活动状态，因为自动重新配置JAR会将其重新添加回去。<code>DataSource</code>仍然没有更改，因为Spring Boot通过<code>@ServiceScan</code>为您创建了它。</p></li>
<li>
<p>删除<code>spring-boot-starter-cloud-connectors</code>依赖项，以便Spring Boot停止创建<code>CloudFactory</code> 。自动重新配置JAR实际上具有自己的Spring Cloud Connectors（所有具有不同包名称的类）副本，并且现在使用它们来创建<code>DataSource</code> （在<code>BeanFactoryPostProcessor</code> ）。Spring Boot自动配置的<code>DataSource</code>被替换为通过<code>VCAP_SERVICES</code>绑定到MySQL的<code>DataSource</code> 。无法控制池属性，但仍会使用Tomcat池（如果可用）（不支持Hikari或DBCP2）。</p></li>
<li>
<p>删除自动重配置JAR， <code>DataSource</code>恢复为H2。</p></li>
</ul>
<blockquote>
<p>提示：将Web和执行器启动器与<code>endpoints.health.sensitive=false</code>以通过“ / health”快速检查<code>DataSource</code> 。您还可以使用“ / beans”，“ / env”和“ / autoconfig”端点查看自动配置中的内容以及原因。</p>
<p>注意：在Cloud Foundry中运行或在本地classpath中包含自动重新配置JAR都会激活“ cloud”配置文件（出于相同的原因）。<code>VCAP_*</code> env vars是使Spring Cloud和/或自动重配置JAR创建bean的东西。</p>
<p>注意： <code>VCAP_SERVICES</code>的URL实际上不是“ jdbc”方案，对于JDBC连接应该是必需的。但是，这是Cloud Foundry通常采用的格式，因为它几乎适用于Java以外的所有其他语言。Spring Cloud Connector或buildpack自动重新配置（如果它们正在创建<code>DataSource</code> ）将为您将其转换为<code>jdbc:*</code> URL。</p>
<p>注意：MySQL URL还包含用户凭证和数据库名称，这些用户凭证和数据库名称对于示例源代码中<code>docker-compose.yml</code>创建的Docker容器有效。如果您的本地MySQL服务器具有不同的凭据，则可以替换这些凭据。</p>
<p>提示：如果您使用本地MySQL服务器并希望验证其是否已连接，则可以使用Spring Boot Actuator中的“ / health”端点（已包含在示例代码中）。或者，您可以在类路径的根目录中创建一个<code>schema-mysql.sql</code>文件，并在其中放置一个简单的保持活动查询（例如<code>SELECT 1</code> ）。Spring Boot将在启动时运行该程序，因此，如果应用程序成功启动，则说明您已正确配置数据库。</p>
</blockquote>
<p>自动重新配置JAR始终位于Cloud Foundry中的类路径上（默认情况下），但是如果找到<code>org.springframework.cloud.CloudFactory</code></p><code>org.springframework.cloud.CloudFactory</code></div><code>org.springframework.cloud.CloudFactory</code></div><code>org.springframework.cloud.CloudFactory</code></article><code>org.springframework.cloud.CloudFactory</code></div><code>org.springframework.cloud.CloudFactory</code></div><code>org.springframework.cloud.CloudFactory</code></div><code>org.springframework.cloud.CloudFactory</code></div><code>org.springframework.cloud.CloudFactory</code></body></html>