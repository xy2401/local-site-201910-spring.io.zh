<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Our plans for building OSGi applications</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Our plans for building OSGi applications" />
<meta name="twitter:description" content="&lt;p&gt;In the recent days and weeks, we’ve seen an increasing amount of interest in the future of build solutions for applications made up of OSGi bundles. Due to our heavy involvement with OSGi, this is something that is near and dear to our hearts and we’ve spent a long time looking at customer requirements and solutions for those requirements. In this blog entry, I will outline the requirements that we have identified and present the solutions that we see to these requirements.&lt;/p&gt;
&lt;p&gt;I’m very interested in hearing from anyone who has extra requirements, thinks the requirements we have are bogus or has better ideas for solutions.&lt;/p&gt;
" />

<meta property="og:title" content="Our plans for building OSGi applications" />
<meta property="og:description" content="&lt;p&gt;In the recent days and weeks, we’ve seen an increasing amount of interest in the future of build solutions for applications made up of OSGi bundles. Due to our heavy involvement with OSGi, this is something that is near and dear to our hearts and we’ve spent a long time looking at customer requirements and solutions for those requirements. In this blog entry, I will outline the requirements that we have identified and present the solutions that we see to these requirements.&lt;/p&gt;
&lt;p&gt;I’m very interested in hearing from anyone who has extra requirements, thinks the requirements we have are bogus or has better ideas for solutions.&lt;/p&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2009-03-18 16:59:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Our plans for building OSGi applications</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="null?s=20&amp;d=mm" />
<span class="author">Rob Harrop</span>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2009-03-18 16:59:00.0">March 18, 2009</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="213" href="/blog/2009/03/18/our-plans-for-building-osgi-applications#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><p>In the recent days and weeks, we&rsquo;ve seen an increasing amount of interest in the future of build solutions for applications made up of OSGi bundles. Due to our heavy involvement with OSGi, this is something that is near and dear to our hearts and we&rsquo;ve spent a long time looking at customer requirements and solutions for those requirements. In this blog entry, I will outline the requirements that we have identified and present the solutions that we see to these requirements.</p><p>I&rsquo;m very interested in hearing from anyone who has extra requirements, thinks the requirements we have are bogus or has better ideas for solutions.</p>
<h2>Requirements for OSGi Build</h2>
<h4>No duplication of dependency metadata</h4><p>A real problem with current OSGi builds is that dependency metadata can be duplicated in many places. For dm Server, we have dependencies described in ivy.xml, .classpath and MANIFEST.MF files. Any long-term solution for OSGi builds must require only one location for dependency metadata.</p>
<h4>Work with existing build solutions </h4><p>Given the unique nature of OSGi applications it is tempting to try and start from scratch with the build system. We entertained this idea for some time, but it became apparent that this wasn&rsquo;t workable technically nor was it the best solution for our users. </p><p>Our users are heavily vested in the build solution they have chosen, and making them move doesn&rsquo;t seem like the pragmatic approach. Instead, users want a solution that will slot nicely into their Maven or Ant builds.</p>
<h4>Generate manifest files automatically </h4><p>Probably the easiest way to move to OSGi is to start generating manifest files automatically from the associated metadata available for an application module. Ideally, this approach will lead to minimal changes to application code or to the way developers work with that code.</p>
<h4>Derive build dependencies from OSGi manifest </h4><p>Although manifest generation is a valid approach, many users are interested in treating their OSGi manifests as the canonical description of dependency metadata. These users want to drive their builds from the metadata they have written in their manifests. To support easy manifest creation, many users want to see support for manifest templates. A manifest template allows for boilerplate manifest content to be generated automatically, whilst giving users full control over important information such as versions.</p><p>This approach uses the manifest as the central dependency descriptor in the IDE and in the offline build. Developers write the OSGi manifest by hand, or with help from tooling, and the manifest is used by the build tooling in a similar way to how Maven uses the pom.xml and Ivy uses ivy.xml.</p><p>Using OSGi metadata for resolution allows for the full set of OSGi resolution rules to be applied during build. This will allow for more accurate matching of the build-time dependency resolution to the resolution that will occur at runtime.</p><p>A potential drawback of this approach is that developers will need to specify test dependencies in their manifests. Both Maven and Ivy have ways of marking dependencies for use in the test environment only, and a similar solution is needed when using manifests for dependency resolution.</p>
<h2> Scenarios</h2><p>From these requirements, we have derived four main scenarios. Interestingly, each of these scenarios is represented by one or more of the users I interact with frequently for dm Server.</p>
<h4>1. Maven and Eclipse - pom.xml-driven </h4><p>Along with the next scenario, this is the most frequent one we encounter, and it is the one we are currently spending the most time working on. With this approach, developers are carrying out their development tasks as they would for any normal Maven/Eclipse project. </p><p>The OSGi manifest file is generated by plugins for Maven and for Eclipse. The developer can choose to have the Eclipse plugin regenerate the manifest as part of the incremental build or on-demand.</p><p>Most of the metadata needed to generate the OSGi manifest can be found in the Java code (source/bytecode). However, it is not possible to derive sensible version numbers for dependencies from bytecode. In this case, versions can be extracted from the pom.xml file or from a customisable manifest template.</p><p>The manifest template can carry more information than just version numbers, allowing developers to add OSGi attributes and directives along with any custom headers. </p>
<h4>2. Ant, Ivy and Eclipse - ivy.xml-driven </h4><p>This approach is similar to the Maven, pom-driven approach except that dependency metadata will be extracted from the ivy.xml file and not from the pom.xml file.</p><p>Developers will have access to Ant tasks to perform manifest generation at the appropriate stage in the build.</p><p>The biggest drawback of this approach is the lack of compelling Ivy integration in Eclipse. For Ivy 2, the Eclipse plugin support is sadly lacking. One approach we are considering is to create the Eclipse classpath from the generated manifest. This is tooling that we already support and will be extending for the next two scenarios. Developers will write ivy.xml files, generate their manifest using the Eclipse plugin and have the Eclipse classpath updated automatically.</p>
<h4>3. Maven and Eclipse - MANIFEST.MF-driven </h4><p>In this approach, the OSGi manifest file is the definitive declaration of project dependency metadata. Developers may choose to write the entire manifest by hand, but most likely they will be writing a manifest template and letting our plugins do the rest.</p><p>The dm Server tools already come with an Eclipse classpath container that is driven by the manifest and this will be extended to support accurate transitive dependency resolution. </p><p>To support testing is this environment, the plugins will allow for both MANIFEST.MF and TEST.MF files to be written, with TEST.MF describing dependencies that apply only for testing and MANIFEST.MF describing dependencies that apply during test and production.</p><p>The last remaining piece for this scenario is how to plug into Maven. We are currently investigating two approaches: replacing/integrating with the Maven dependency resolver or generating a pom.xml file. I&rsquo;m interested in hearing your opinions on which approach you think has most merit and would be most beneficial to you.</p>
<h4>4. Ant, Ivy and Eclipse - MANIFEST.MF-driven </h4><p>This approach is very similar to using Maven in a manifest-driven way. Unlike scenario 2, this scenario does not suffer from the lack of decent Ivy/Eclipse integration because we will using the same manifest-driven Eclipse classpath container as in scenario 3.</p>
<h2>Tools for OSGi build</h2><p>To address the requirements outlined we are building a suite of tools that work alongside Maven, Ant and Ivy to provide an integrated solution for building OSGi applications.</p>
<h4>Bundlor </h4><p>Bundlor is a tool that we have been using internally for some time to generate OSGi manifests. We used it predominantly to create all the bundles that you see in our <a href="http://www.springsource.com/repository">Enterprise Bundle Repository</a>. Bundlor can be used to generate manifests for legacy libraries that were created without much consideration for OSGi. Bundlor can also be used for generating manifests for bundles that you are creating specifially with OSGi in mind. Bundlor removes most of the donkey-work involved in creating high quality bundle manifests. </p><p>Bundlor supports the notion of a manifest template that allows you to customize the generated manifests. Using the template you can add versions and attributes to package imports and exports, exclude packages from exports, add imports when automatic detection is impossible and also add extra manifest headers. The code snippet below shows a manifest from one of our sample applications.</p>
<pre><code class="prettyprint code">Manifest-Version: 1.0
Bundle-ManifestVersion: 2
Bundle-Name: GreenPages Service
Bundle-SymbolicName: greenpages
Bundle-Vendor: SpringSource Inc.
Bundle-Version: 1.0
Import-Template: org.springframework.*;version=&quot;[2.5.6.A,3.0)&quot;
Excluded-Exports: greenpages.internal
</code></pre><p>In this sample, the <span style="font-family: monospace">Excluded-Exports</span> header is being used to prevent <span style="font-family: monospace">greenpages.internal</span> from being exposed. The <span style="font-family: monospace">Import-Template</span> header is used to set a version for all package names that match the <span style="font-family: monospace">org.springframework.*</span> pattern. The project code is scanned to determine the set of possible imports and exports. The template file is then used to control which of the imports/exports in this set actually make it into the manifest and what versions they have. Importantly, the generation process will correctly generate <a href="http://blog.springsource.com/2008/10/20/understanding-the-osgi-uses-directive/">uses metadata</a> for you, removing one of the most tedious jobs.</p><p>Bundlor will actually support the creation of two manifest files: MANIFEST.MF and TEST.MF. The TEST.MF file will be used to describe dependencies that are needed only during test. This is important for developers who want to use manifest-driven builds but don&rsquo;t want to pollute production manifests with test dependencies.</p><p>In the next few weeks we will be releasing our first public milestone of Bundlor. In this release, you will be able to generate manifests for projects from within Ant and Maven, and you&rsquo;ll be able to customise those manifests using a manifest template. In the next few milestones after that, we&rsquo;ll be adding support for automatically detecting versions for dependencies from pom.xml and ivy.xml files.</p><p>We&rsquo;ll be switching most of our samples from hand-written manifests to use Bundlor and manifest templates in time for Bundlor 1.0 final. In addition, we will be moving dm Server to Bundlor as well, discarding all our hand-written manifests.</p>
<h4> BundlorEclipse </h4><p>BundlorEclipse is an Eclipse plugin that makes the Bundlor features available directly in your Eclipse IDE. Using this plugin, you can have fully-incremental manifest generation performed as part of your normal Eclipse build lifecycle. If, like me, you are a bit too free and easy with the save button, you can configure BundlorEclipse to only generate manifests on demand.</p><p>When combining this with the forthcoming dm Server in-container test framework, you&rsquo;ll be able to launch full dm Server test environments, complete with manifest files for all your bundles, all from within Eclipse.</p>
<h4>Offline dependency resolver </h4><p>OSGi has its own rules for how dependencies between modules are resolved and how these are validated and turned into a consistent class space. Outside of OSGi, build tools work on a flat classpath which lists the JARs and directories to search for classes. </p><p>To support a manifest-driven build, we&rsquo;ll be creating an offline dependency resolver that performs OSGi resolution without starting Equinox or dm Server. We&rsquo;ll be pairing this with a tool that will flatten on OSGi resolution graph into a simple classpath for compile and test. This flattening process will be fully configurable by users who will be able to supply policy information to govern how multiple versions in the OSGi graph are mapped to a single version in the classpath.</p>
<h4>Manifest classpath container </h4><p>Using the dependency resolver, we&rsquo;ll be able to improve our manifest classpath container to create a full, transitive classpath for each Eclipse project.</p>
<h4>Maven/Ivy dependency resolver/pom.xml/ivy.xml generator </h4><p>The dependency resolver will also form the core part of our dependency resolver/pom.xml/ivy.xml generator tool. The critical observation here being that as a developer you should expect to get consistent results inside Eclipse and in your build tool.</p>
<h2>Why Bundlor and not Bnd?</h2><p>As you may be aware, Peter Kriens, OSGi Technical Director, makes available a tool called bnd that serves a similar purpose to Bundlor. Our original position was to use bnd for our own projects and to use it as part of our tooling. Indeed, the Spring Dynamic Modules was using bnd to create its bundles long before Bundlor came along. So why did we decide to create Bundlor? </p><p>The main reason for creating for creating Bundlor was that we had to support some additional features that weren&rsquo;t present in bnd such as:</p>
<ul>
<li>JDT-based source code scanning</li>
<li>Partial code handling</li>
<li>Incremental manifest creation</li>
</ul><p>These features are used to support BundlorEclipse. We use JDT-based scanning in place of bytecode scanning in Eclipse to improve the user experience and to get much better integration into the Eclipse build lifecycle. Eclipse handles partially correct code quite well, and we wanted Bundlor to be able to support partial code in much the same way. </p><p>In BundlorEclipse, it is possible to configure Bundlor to run every time you save changes in the IDE. To make this performant, we support incremental manifest generation. When you make changes to your code, Bundlor can track what changes have to be made to manifest files and avoid having to recreate all manifests.</p>
<h2>Working with IDEs other than Eclipse</h2><p>We are aware that, although Eclipse is the dominant IDE for Java developers, there is still a significant number of developers running IDEs such as IntelliJ and NetBeans.</p><p>Whilst we won&rsquo;t be committing to build any plugins for these IDEs ourselves we will be making all the tools described available as open source enabling other people to create plugins for their favorite IDEs. </p><p>Our approach to building our tools has been to try and encapsulate as much functionality as possible in general-purpose libraries. We are committed to working with the NetBeans and IntelliJ teams to help them integrate our tool libraries into their IDEs. </p><p>The ideal end result is that no matter what IDE you are using, you can still get access to the same underlying OSGi tools.</p>
<h2>Further requirements</h2><p>The requirements for OSGi build don&rsquo;t stop with the 4 scenarios that I&rsquo;ve outlined. There are many more features and enhancements that can improve the experience for developers working with OSGi applications.</p>
<h4> Bulk bundle generation </h4><p>Many shops will have a large backlog of JAR artifacts that are not OSGi bundles. We plan to extend Bundlor to support bulk bundle generation. In this mode, you will be able to save time by pointing Bundlor at a directory of JARs and having Bundlor create bundles for all of them. In addition, to this, Bundlor will be able to use the relationships between these artifacts to work out what the version ranges for dependencies should be. This will reduce the amount of template code you have to write whilst still resulting in high-quality bundles. </p>
<h4>Repository-driven code completion </h4><p>When building dm Server applications with manifest-driven builds, you have to write the initial manifest imports by hand. With support for repository-driven code completion, you will be able to get Eclipse code completion against the dm Server repository that will generate both Java imports and manifest imports. Using this feature, you&rsquo;ll be able to build up your manifest dependencies as needed, without having to switch to the manifest file.</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 213;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>