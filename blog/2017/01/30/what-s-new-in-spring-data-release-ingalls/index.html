<html  data-code-prettify="" data-mobile-support="" data-search=""><head></head><body >﻿
<title>Spring Data Release Ingalls中的新增功能？</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="What's New in Spring Data Release Ingalls?">
<meta name="twitter:description" >
<meta name="twitter:creator" content="@mp911de">
<meta name="twitter:image:src" content="https://gravatar.com/avatar/6494a9d91e9ffef9adc8253257f1b35e?s=200">

<meta property="og:title" content="What's New in Spring Data Release Ingalls?">
<meta property="og:image" content="https://gravatar.com/avatar/6494a9d91e9ffef9adc8253257f1b35e?s=200">
<meta property="og:description" >
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2017-01-30 12:47:00.0">



<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Spring Data Release Ingalls中的新增功能？</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/6494a9d91e9ffef9adc8253257f1b35e?s=20&d=mm"> <a class="author" rel="author" href="/team/mp911de">马克·帕鲁奇</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2017-01-30 12:47:00.0">一月30，2017</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2017/01/30/what-s-new-in-spring-data-release-ingalls#disqus_thread" data-disqus-identifier="2804">
</a></div>
</div>
</header>
<div class="blog--post"><div class="paragraph">
<p>您可能已经看到，我们<a href="https://spring.io/blog/2017/01/26/spring-data-release-train-ingalls-goes-ga">刚刚宣布</a>了Spring Data发布火车Ingalls的GA发布。由于该发行版包含太多的功能以致无法在发行公告中进行介绍，因此我想使用本文更深入地了解火车上15个模块随附的更改和功能。</p>
</div>
<div class="sect1">
<h2 id="housekeeping"><a class="anchor" href="#housekeeping"></a>家政</h2>
<div class="sectionbody">
<div class="paragraph">
<p>发行版依赖项的一个非常根本的变化是升级到Spring Framework 4.3（当前为4.3.6）作为基准。其他依赖项升级主要由基础商店驱动程序和实现的主要版本变化驱动，这些变化需要反映在这些模块公开的API的潜在重大更改中。</p>
</div>
<div class="paragraph">
<p>Ingalls还附带了一个新的Spring数据模块：Spring Data LDAP。 Spring LDAP项目已经提供了Spring Data信息库支持已经有一段时间了。在遇到一些小故障和不兼容之后，我们决定将LDAP存储库支持移至单独的Spring Data模块中，以使其与发行版更加紧密地对齐。</p>
</div>
<div class="paragraph">
<p>模块设置的另一个重大变化是Apache Cassandra的Spring Data现在已经成为核心模块，这意味着它已经并且将由Pivotal的Spring Data团队维护。非常感谢以前的核心维护者David Webb和Matthew T.Adams所做的一切。</p>
</div>
<div class="paragraph">
<p>除了这些非常根本的更改之外，团队还一直在开发一系列新功能：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>使用方法句柄在转换子系统中进行属性访问。</p>
</li>
<li>
<p>支持基于REST负载的XML和JSON投影（通用）</p>
</li>
<li>
<p>使用Spring Data REST进行跨域资源共享</p>
</li>
<li>
<p>更多用于数组，算术，日期和集合操作的MongoDB Aggregation Framework运算符。</p>
</li>
<li>
<p>支持Redis Geo命令。</p>
</li>
<li>
<p>升级到Cassandra 3.0，在存储库查询方法，用户定义类型，Java 8类型（可选，Stream），JSR-310和ThreeTen Backport中支持查询派生。</p>
</li>
<li>
<p>支持Javaslang <code>Option</code> ，存储库查询方法的集合和地图类型。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>这些是我想在本文其余部分中讨论的内容。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="performance-improvements"><a class="anchor" href="#performance-improvements"></a>性能提升</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="methodhandles-for-improved-object-access"><a class="anchor" href="#methodhandles-for-improved-object-access"></a> MethodHandles用于改善对象访问</h3>
<div class="paragraph">
<p>我们发布培训的一个主要主题是提高对象到商店映射子系统访问域类数据的性能。传统上，Spring Data为此使用了反射，要么直接检查字段，要么调用属性的访问器方法。</p>
</div>
<div class="paragraph">
<p>尽管反射性能在Java 8中得到了显着改善，但是我们仍然可以使用另一种方法来使性能接近本机访问： <code>MethodHandle</code> s。如果将它们保存在类的静态字段中，则使用它们的速度特别快，这对我们构成了挑战，因为我们不知道您要预先保留的域类型的结构。但是，我们已经通过使用ASM生成可直接调用构造函数的定制工厂，对域对象实例的创建进行了类似的优化。现在，我们继续将相同的想法应用于我们的<code>PersistentPropertyAccessor</code>实现：我们检查类型并ASM生成一个包含静态final的类<code>MethodHandle</code> s，然后使用我们的API读写属性来避免反射。万一这些类公开了公共API（例如访问器），我们就使用它们。</p>
</div>
<div class="paragraph">
<p>如果您有兴趣，可以在<a href="https://github.com/spring-projects/spring-data-commons/blob/17366031071c68ddb87a9de1debac6f1dda85524/src/main/java/org/springframework/data/mapping/model/ClassGeneratingPropertyAccessorFactory.java">此处</a>找到实现代码。但是，请准备好自己，ASM代码阅读起来可能会有些复杂。如果您至少运行Java 7，则所有使用对象到存储映射的Spring Data模块都将从此更改中受益（即，JPA不这样做）。您可以在<a href="https://jira.spring.io/browse/DATACMNS-809">请求更改</a>的<a href="https://jira.spring.io/browse/DATACMNS-809">票证中</a>找到更多详细信息。我们发现性能从20％提高到70％。</p>
</div>
</div>
<div class="sect2">
<h3 id="domain-event-publication-from-aggregate-roots"><a class="anchor" href="#domain-event-publication-from-aggregate-roots"></a>从聚合根发布域事件</h3>
<div class="paragraph">
<p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/#context-functionality-events">Spring Application Events</a>通常用于在应用程序内发布技术事件。但是，它们还是使用域事件基础结构来解耦系统各部分的出色工具。通常这样实现：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class OrderManagement {

  private final ApplicationEventPublisher publisher;
  private final OrderRepository orders;

  @Transactional
  void completeOrder(Order order) {

    OrderCompletedEvent event = order.complete();
    orders.save(order);
    publisher.publish(event);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>查看聚合根如何产生事件，然后服务组件通过Spring的事件发布该事件<code>ApplicationEventPublisher</code> 。该模式通常是一个不错的模式，但是涉及很多仪式，并且在业务组件中引入了一种技术框架依赖性，人们可能希望避免这种依赖性。</p>
</div>
<div class="paragraph">
<p>借助Spring Data Ingalls发布培训，存储库现在可以检查传递给<code>save(…)</code>聚合方法注释的方法<code>@DomainEvents</code> ，调用该方法并通过事件发布者自动发布返回的对象。所以假设<code>Order.complete()</code>实现看起来像这样（ <code>AbstractAggregateRoot</code>是包含注释方法的Spring Data提供的类型）：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class Order extends AbstractAggregateRoot {

  Order complete() {
    register(new OrderCompletedEvent(this));
    return this;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>客户端代码可以简化为</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class OrderManagement {

  private final OrderRepository orders;

  @Transactional
  void completeOrder(Order order) {
    repository.save(order.complete());
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>如您所见，不再有对Spring基础结构的引用。事件发布由负责它的组件（聚合根）负责。在<a href="https://docs.spring.io/spring-data/commons/docs/current/reference/html/#core.domain-events">参考文档中</a>阅读有关该新机制的更多信息。目前，团队中正在围绕领域事件提出更高级的想法。观看此空间以获取更多更新。</p>
</div>
</div>
<div class="sect2">
<h3 id="pagination"><a class="anchor" href="#pagination"></a>分页</h3>
<div class="paragraph">
<p>Spring Data MongoDB和Spring Data JPA的分页查询现在受益于<a href="https://github.com/spring-projects/spring-data-commons/blob/17366031071c68ddb87a9de1debac6f1dda85524/src/main/java/org/springframework/data/repository/support/PageableExecutionUtils.java#L46">改进的提取策略</a> ，该<a href="https://github.com/spring-projects/spring-data-commons/blob/17366031071c68ddb87a9de1debac6f1dda85524/src/main/java/org/springframework/data/repository/support/PageableExecutionUtils.java#L46">策略</a>更加积极地尝试避免执行计数查询。构造一个<code>Page</code>需要获取的数据，通常需要查询返回的总记录数。尽管可以使用范围选择和索引来优化数据查询，但是计数查询非常昂贵，因为它们需要扫描表或索引。如果您请求最后一个仅部分填充的页面，我们可以跳过对记录的计数，因为可以根据结果页面中项目的偏移量和数量来计算元素的总数。</p>
</div>
</div>
<div class="sect2">
<h3 id="mongodb-dbref-resolution"><a class="anchor" href="#mongodb-dbref-resolution"></a> MongoDB DBRef解析</h3>
<div class="paragraph">
<p>Spring Data MongoDB的另一个与性能相关的更改<code>DBRef</code>正在获取。如果集合中的引用指向同一个数据库集合，则在<a href="https://github.com/spring-projects/spring-data-mongodb/blob/b79474c92c231ee4f2b3bd77fdde12878002acef/spring-data-mongodb/src/main/java/org/springframework/data/mongodb/core/convert/MappingMongoConverter.java#L1253">单个批量操作</a>中获取引用的集合。这意味着，wen基本上可以使用单个查询而不是每个元素一个查询来读取相关集合。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="xml-and-json-based-projections-for-rest-payloads"><a class="anchor" href="#xml-and-json-based-projections-for-rest-payloads"></a> REST有效负载的基于XML和JSON的投影</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://spring.io/blog/2014/09/09/spring-data-release-train-evans-goes-ga">Evans</a>和<a href="https://spring.io/blog/2016/05/03/what-s-new-in-spring-data-hopper">Hopper</a>发行列车附带了投影功能，这些功能允许通过应用投影界面来自定义现有域对象的视图。投影可以在应用程序代码（存储库或手动实现的Spring MVC控制器）中使用，也可以与Spring Data REST一起使用，以通过Web端点公开域对象上的专用视图。该投影还可以用于绑定表单提交（有关详细信息，请参见此示例）。现在，借助Ingalls，我们可以扩展该支持以处理JSON和XML请求：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@RestController
class UserController {

  /**
   * Receiving POST requests supporting both JSON and XML.
   */
  @PostMapping(value = "/")
  HttpEntity&lt;String&gt; post(@RequestBody UserPayload user) {

    return ResponseEntity
      .ok(String.format("firstname: %s, lastname: %s",
        user.getFirstname(), user.getLastname()));
  }
}

@ProjectedPayload
public interface UserPayload {

  @XBRead("//firstname")
  @JsonPath("$..firstname")
  String getFirstname();

  @XBRead("//lastname")
  @JsonPath("$..lastname")
  String getLastname();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>投影界面带有注释<code>@ProjectedPayload</code>启用投影和投影方法注释包含<a href="https://github.com/jayway/JsonPath#getting-started">JSON路径</a>或<a href="https://xmlbeam.org/t01.html#E01:_Printing_some_weather_data">XPath表达式</a> 。</p>
</div>
<div class="paragraph">
<p>如果省略了这些属性注释，我们将采用默认值（即<code>$.firstname</code>要么<code>/firstname</code>等等）。这里的基本思想是-而不是使用对象结构映射传入的数据-确切地指向您感兴趣的有效负载部分。使用JSON Path表达式或XPath可以使您对要访问的元素的实际位置更加宽容，从而使有效负载结构中的更改不必破坏使用者。查看上面的示例如何查找<code>firstname</code>文档中的任何位置。如果产生JSON的一方决定突然将其嵌套到例如<code>user</code>文档或XML子节点，不需要更改使用的代码。</p>
</div>
<div class="paragraph">
<p>如果要在客户端上使用这种有效负载访问，则只需注册相应的<code>HttpMessageConverter</code>上的实例<code>RestTemplate</code> ：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
class Config {

  @Bean
  RestTemplateBuilder builder() {
    return new RestTemplateBuilder()
      .additionalMessageConverters(new ProjectingJackson2HttpMessageConverter())
      .additionalMessageConverters(new XmlBeamHttpMessageConverter());
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>投影绑定支持使用<a href="https://github.com/jayway/JsonPath">JsonPath</a>评估JSON路径表达式，并使用<a href="https://xmlbeam.org/">XMLBeam</a>评估XPath表达式。您可以在<a href="https://github.com/spring-projects/spring-data-examples/tree/c523b8d468484075658a2b3c63a4a718c54bab16/web/projection">Spring Data Examples资源库中</a>找到完整的示例。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cross-origin-resource-sharing-with-spring-data-rest"><a class="anchor" href="#cross-origin-resource-sharing-with-spring-data-rest"></a>使用Spring Data REST进行跨域资源共享</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://en.wikipedia.org/wiki/Same-origin_policy">同源策略</a>限制了在浏览器内部使用客户端JavaScript请求。默认情况下，禁止从应用程序服务器以外的其他来源请求数据，因为这是跨源请求。启用跨域资源共享（CORS）要求目标服务器提供随每个HTTP响应发送的<a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS标头</a> 。Spring Data REST的Ingalls版本现在使您可以轻松：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@CrossOrigin
public interface CustomerRepository extends CrudRepository&lt;Customer, Long&gt; {}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-http" data-lang="http">GET /customers/1 HTTP/1.1
Origin: http://localhost</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-http" data-lang="http">HTTP/1.1 200 OK
Vary: Origin
ETag: "0"
Access-Control-Allow-Origin: http://localhost
Access-Control-Allow-Credentials: true
Last-Modified: Tue, 24 Jan 2017 09:38:01 GMT
Content-Type: application/hal+json;charset=UTF-8</code></pre>
</div>
</div>
<div class="paragraph">
<p>导出的域类和存储库可以用注释<code>@CrossOrigin</code>以启用CORS，并且注释可以用于自定义设置。对于更多的全局配置，您可以使用<code>RepositoryRestConfigurer.configureRepositoryRestConfiguration(…)</code>以获得对所有Spring Data REST公开资源的CORS设置的完全控制。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Component
public class SpringDataRestCustomization extends
  RepositoryRestConfigurerAdapter {

  @Override
  public void configureRepositoryRestConfiguration(
    RepositoryRestConfiguration config) {

    config.getCorsRegistry().addCorsMapping("/person/**")
      .allowedOrigins("http://domain2.com")
      .allowedMethods("PUT", "DELETE")
      .allowedHeaders("header1", "header2", "header3")
      .exposedHeaders("header1", "header2")
      .allowCredentials(false).maxAge(3600);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>在<a href="https://docs.spring.io/spring-data/rest/docs/current/reference/html/#customizing-sdr.configuring-cors">参考文档中</a>找到有关此内容的更多详细信息。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="new-mongodb-aggregation-framework-operators"><a class="anchor" href="#new-mongodb-aggregation-framework-operators"></a>新的MongoDB聚合框架运算符</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MongoDB团队会定期添加<a href="https://docs.mongodb.com/manual/release-notes/3.4/#aggregation">新的聚合框架运算符</a> 。通过Ingalls发布培训，我们借此机会增强了Spring Data MongoDB的可用运算符集，使其与MongoDB运算符以及您如何与它们交互。此版本增加了对以下聚合运算符和聚合阶段的本机支持：</p>
</div>
<div class="sect2">
<h3 id="aggregation-operators"><a class="anchor" href="#aggregation-operators"></a>集合运算符</h3>
<div class="ulist">
<ul>
<li>
<p><code>$anyElementTrue</code> ， <code>$allElementsTrue</code> ， <code>$setEquals</code> ， <code>$setIntersection</code> ， <code>$setUnion</code> ， <code>$setDifference</code> ，<code>$setIsSubset</code></p>
</li>
<li>
<p><code>$filter</code> ， <code>$in</code> ， <code>$indexOfArray</code> ， <code>$range</code> ， <code>$reverseArray</code> ， <code>$reduce</code> ，<code>$zip</code></p>
</li>
<li>
<p><code>$indexOfBytes</code> ， <code>$indexOfCP</code> ， <code>$split</code> ， <code>$strLenBytes</code> ， <code>$strLenCP</code> ，<code>$substrCP</code></p>
</li>
<li>
<p><code>$stdDevPop</code> ，<code>$stdDevSamp</code></p>
</li>
<li>
<p><code>$abs</code> ， <code>$ceil</code> ， <code>$exp</code> ， <code>$floor</code> ， <code>$ln</code> ， <code>$log</code> ， <code>$log10</code> ， <code>$pow</code> ， <code>$sqrt</code> ，<code>$trunc</code></p>
</li>
<li>
<p><code>$arrayElementAt</code> ， <code>$concatArrays</code> ，<code>$isArray</code></p>
</li>
<li>
<p><code>$literal</code> ，<code>$let</code></p>
</li>
<li>
<p><code>$dayOfYear</code> ， <code>$dayOfMonth</code> ， <code>$dayOfWeek</code> ， <code>$year</code> ， <code>$month</code> ， <code>$week</code> ， <code>$hour</code> ， <code>$minute</code> ， <code>$second</code> ， <code>$millisecond</code> ， <code>$dateToString</code> ， <code>$isoDayOfWeek</code> ， <code>$isoWeek</code> ，<code>$isoWeekYear</code></p>
</li>
<li>
<p><code>$count</code> ， <code>$cond</code> ， <code>$ifNull</code> ， <code>$map</code> ， <code>$switch</code> ，<code>$type</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="aggregation-stages"><a class="anchor" href="#aggregation-stages"></a>聚集阶段</h3>
<div class="ulist">
<ul>
<li>
<p><code>$facet</code> ， <code>$bucket</code> ，<code>$bucketAuto</code></p>
</li>
<li>
<p><code>$replaceRoot</code> ， <code>$unwind</code> ，<code>$graphLookup</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>聚合运算符具有创建的入口点，并以流畅的样式构建。多个聚合器按外观分组，例如<code>ArrayOperators</code> ， <code>ArithmeticOperators</code>还有很多。可以在入口点方法中使用字段引用和聚合表达式。可通过以下方式访问聚合阶段操作员的入口点<code>Aggregation</code> 。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Aggregation.newAggregation(
  project()
    .and(ArrayOperators.arrayOf("instock").concat("ordered")).as("items")
);

Aggregation.newAggregation(
  project()
    .and(ArithmeticOperators.valueOf("quizzes").sum()).as("quizTotal")
);

Aggregation.newAggregation(
  group().stdDevSamp("age").as("ageStdDev")
);

Aggregation.newAggregation(Employee.class,
  match(Criteria.where("name").is("Andrew")),
  graphLookup("employee")
    .startWith("reportsTo")
    .connectFrom("reportsTo")
    .connectTo("name")
    .depthField("depth")
    .maxDepth(5)
    .as("reportingHierarchy"));

Aggregation.newAggregation(bucketAuto("field", 5)
  .andOutputExpression("netPrice + tax").as("total")
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>任何当前不支持的聚合运算符和表达式都可以通过实现<code>AggregationOperation</code>要么<code>AggregationExpression</code>分别。还请注意，其中一些运算符是在最近的MongoDB版本中引入的，只能与这些运算符一起使用。</p>
</div>
<div class="paragraph">
<p>越来越多的运营商为他们相互结合开辟了全新的可能性。运算符可以嵌套在各种组合中，有时可能会导致难以阅读的代码。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">newAggregation(
  project()
    .and(ConditionalOperators.when(Criteria.where("a").gte(42))
      .then("answer")
      .otherwise("no-answer"))
      .as("deep-tought")
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>为了简化此代码，我们现在支持Spring表达式语言（SpEL）表达式来表示相同的投影，如下所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">newAggregation(
  project()
    .andExpression("cond(a &gt;= 42, 'answer', 'no-answer')")
    .as("deep-tought")
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>聚合中对SpEL的支持并不是全新的。实际上，它从Spring Data MongoDB 1.6开始就可用。到目前为止，它支持算术运算（例如<code>'$items.price' * '$items.quantity'</code> ）。Ingalls在此处添加的新内容是，现在可以将聚合运算符表示为接受参数的函数。您可以通过使用字段名称将字段传递给聚合运算符。然后，聚合框架评估SpEL表达式并为聚合运算符创建BSON文档。</p>
</div>
<div class="paragraph">
<p>SpEL的网关是<code>AggregationSpELExpression.expressionOf(…)</code>可以在所有能够提交SpEL的地方提交SpEL表达式<code>AggregationExpression</code> 。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">newAggregation(
  group("number")
    .first(expressionOf("cond(a &gt;= 42, 'answer', 'no-answer')"))
    .as("deep-tought")
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>有关更多详细信息，请<a href="https://docs.spring.io/spring-data/mongodb/docs/current/reference/html/#mongo.aggregation">参考参考文档</a>或<a href="https://github.com/spring-projects/spring-data-examples/blob/9a2e95a784cf449bdda372668ae78e8d5c06956d/mongodb/aggregation/src/test/java/example/springdata/mongodb/aggregation/SpringBooksIntegrationTests.java">MongoDB Aggegation Framework示例</a> 。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="redis-geo-indexes"><a class="anchor" href="#redis-geo-indexes"></a> Redis地理索引</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Redis 3.2支持地理索引，我们在地理索引方面得到了社区的大力支持。我们通过Ingalls提供地理索引支持，可通过以下途径获得<code>RedisTemplate</code>和Redis存储库。让我们看一个例子：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">geoOperations.geoAdd("Sicily", new Point(13.361389, 38.115556), "Arigento");
geoOperations.geoAdd("Sicily", new Point(15.087269, 37.502669), "Catania");
geoOperations.geoAdd("Sicily", new Point(13.583333, 37.316667), "Palermo");

GeoResults&lt;GeoLocation&lt;String&gt;&gt; result =
  geoOperations.geoRadiusByMember("Sicily", "Palermo",
    new Distance(100, DistanceUnit.KILOMETERS));

List&lt;String&gt; geohashes = geoOperations.geoHash("Sicily", "Arigento", "Catania");
List&lt;Point&gt; points = geoOperations.geoPos("Sicily", "Arigento", "Palermo");</code></pre>
</div>
</div>
<div class="paragraph">
<p>地理位置索引与您的域类无缝集成。具有地理空间值的域对象可以在地理索引中建立索引，并通过Redis存储库进行查询。以下示例显示域类和存储库接口声明：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class City {

  @Id String id;
  String name;

  @GeoIndexed Point location;
}

public interface CityRepository extends Repository&lt;City, String&gt; {

  List&lt;City&gt; findByLocationNear(Point point, Distance distance);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>使用声明存储库查询<code>Near</code>要么<code>Within</code>关键字可让您在附近使用地理空间查询<code>Point</code>或在<code>Circle</code> 。注意<code>@GeoIndexed</code>用于的注释<code>location</code>允许使用可与派生的地理空间查询方法一起使用的地理索引。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-data-for-apache-cassandra"><a class="anchor" href="#spring-data-for-apache-cassandra"></a> Apache Cassandra的Spring数据</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Apache Cassandra的Spring Data现在是Spring Data团队维护的核心模块。除了开发工作的主要所有权发生变化外，Ingalls发布的火车还对模块本身进行了一系列值得注意的更改。</p>
</div>
<div class="paragraph">
<p>我们已升级到Datastax Java Driver 3.1，因此Apache Cassandra的Spring Data现在支持Apache Cassandra 3.0（1.2、2.0、2.1、2.2和3.0，最高3.9）。</p>
</div>
<div class="paragraph">
<p>此版本还附带了对查询派生的支持，因此您不一定必须使用字符串查询，而是可以从查询方法名称派生Apache Cassandra CQL查询：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface BasicUserRepository extends Repository&lt;User, Long&gt; {

  /**
   * Derived query method.
   * Creates {@code SELECT * FROM users WHERE username = ?0}.
   */
  User findUserByUsername(String username);

  /**
   * Derived query method using SASI (SSTable Attached Secondary Index)
   * features through the {@code LIKE} keyword.
   * This query corresponds with
   * {@code SELECT * FROM users WHERE lastname LIKE '?0'}.
   * {@link User#lastname} is not part of the
   * primary key so it requires a secondary index.
   */
  List&lt;User&gt; findUsersByLastnameStartsWith(String lastnamePrefix);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>您可以在<a href="https://github.com/spring-projects/spring-data-examples/blob/c523b8d468484075658a2b3c63a4a718c54bab16/cassandra/example/src/main/java/example/springdata/cassandra/basic/BasicUserRepository.java">示例存储库中</a>找到有关Apache Cassandra的Spring Data的查询数据派生<a href="https://github.com/spring-projects/spring-data-examples/blob/c523b8d468484075658a2b3c63a4a718c54bab16/cassandra/example/src/main/java/example/springdata/cassandra/basic/BasicUserRepository.java">示例</a> 。</p>
</div>
<div class="paragraph">
<p>查询派生支持Apache Cassandra提供的所有谓词，并且附带有SASI（SSTable附加二级索引）索引的谓词。在这种情况下，查询派生不考虑主键或具有辅助索引的列。不支持<code>AllowFiltering</code> <a href="https://jira.spring.io/browse/DATACASS-376">还没</a> 。此外，存储库查询方法还支持<code>Stream</code>作为返回类型。用一个<code>Stream</code>不会预加载整个结果集，而是在拉动流时对结果进行迭代。</p>
</div>
<div class="paragraph">
<p>为了解决问题，您现在可以在域类中使用JSR-310和ThreeTen反向端口类型以及JodaTime类型，这些类型是作为Java 8支持故事的一部分添加的。JSR-310类型将转换为本地Apache Cassandra数据类型。有关详细信息，请参考修订的<a href="https://docs.spring.io/spring-data/cassandra/docs/1.5.0.RELEASE/reference/html/#mapping-conversion">参考文档</a>或我们的<a href="https://github.com/spring-projects/spring-data-examples/tree/c523b8d468484075658a2b3c63a4a718c54bab16/cassandra/java8">Java 8示例</a> 。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class Order {

  @Id String id;
  LocalDate orderDate;
  ZoneId zoneId;
}

public interface OrderRepository extends Repository&lt;Order, String&gt; {

  /**
   * Method parameters are converted according the registered
   * Converters into Cassandra types.
   */
  @Query("SELECT * from pizza_orders WHERE orderdate = ?0 and zoneid = ?1 ALLOW FILTERING")
  Order findOrderByOrderDateAndZoneId(LocalDate orderDate, ZoneId zoneId);

  /**
   * String-based query using native data types.
   */
  @Query("SELECT * from pizza_orders WHERE orderdate = ?0 and zoneid = ?1 ALLOW FILTERING")
  Order findOrderByDate(com.datastax.driver.core.LocalDate orderDate, String zoneId);

  /**
   * Streaming query.
   */
  Stream&lt;Order&gt; findAll();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>可以通过注册自定义转换来配置数据类型支持。有关此的详细信息，请确保您<a href="https://github.com/spring-projects/spring-data-examples/tree/c523b8d468484075658a2b3c63a4a718c54bab16/cassandra/example/src/main/java/example/springdata/cassandra/convert">在GitHub上</a>查看了<a href="https://github.com/spring-projects/spring-data-examples/tree/c523b8d468484075658a2b3c63a4a718c54bab16/cassandra/example/src/main/java/example/springdata/cassandra/convert">专用于此</a>的示例。</p>
</div>
<div class="paragraph">
<p>最后一个值得注意的功能是用户定义的类型（UDT）。使用Ingalls，您现在可以使用嵌入在您的域类中的映射的用户定义类型，也可以只使用本机<code>UDTValue</code>类型。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Table
public class Person {

  @Id int id;

  String firstname, lastname;
  Address current;
  List&lt;Address&gt; previous;

  @CassandraType(type = Name.UDT, userTypeName = "address")
  UDTValue alternative;
}

@UserDefinedType
public class Address {
  String street, zip, city;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>显式映射的iser定义的类型将结构化值映射到<code>UDTValue</code>在隐蔽的情况下，这样您就可以在使用Spring Data for Apache Cassandra处理映射的同时继续使用域类。</p>
</div>
<div class="paragraph">
<p>UDT值存储在一行中，该行使映射的UDT嵌入对象。您可以将UDT用作单个属性或作为集合类型的一部分。如果使用模式创建，则在应用程序启动时在数据存储区中创建用户定义的类型。从概念上讲，UDT是值对象，这意味着更新UDT值（通过保存域对象）会导致替换整个值。</p>
</div>
<div class="paragraph">
<p>有关特定功能的详细信息，请参考修订的<a href="https://docs.spring.io/spring-data/cassandra/docs/1.5.0.RELEASE/reference/html/">参考文档</a>或<a href="https://github.com/spring-projects/spring-data-examples/tree/9a2e95a784cf449bdda372668ae78e8d5c06956d/cassandra/example/src/main/java/example/springdata/cassandra/udt">UDT示例</a> 。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="support-for-javaslang"><a class="anchor" href="#support-for-javaslang"></a>对Javaslang的支持</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Data存储库现在支持<a href="http://www.javaslang.io/">Javaslang</a>的<a href="https://static.javadoc.io/io.javaslang/javaslang/2.1.0-alpha/javaslang/control/Option.html"><code>Option</code></a>和集合类型作为存储库查询方法的返回值。 <code>Option</code>可以用作JDK 8的替代品<code>Optional</code> ， <a href="https://static.javadoc.io/io.javaslang/javaslang/2.1.0-alpha/javaslang/collection/Seq.html"><code>Seq</code></a>可以替代JDK <code>List</code> 。Javaslang的<code>Set</code>和<code>Map</code>也受支持，并且从其JDK对应对象透明地映射。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public interface PersonRepository extends Repository&lt;Person, Long&gt; {

    Option&lt;Person&gt; findById(Long id);

    Seq&lt;Person&gt; findByFirstnameContaining(String firstname);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>有关更多信息，请参见<a href="https://github.com/spring-projects/spring-data-examples/blob/a41f69127caba6f7b96c868336b93968c000f728/jpa/javaslang/src/test/java/example/PersonRepositoryIntegrationTests.java#L49-L73">带有Javaslang</a>的<a href="https://github.com/spring-projects/spring-data-examples/blob/a41f69127caba6f7b96c868336b93968c000f728/jpa/javaslang/src/test/java/example/PersonRepositoryIntegrationTests.java#L49-L73">JPA示例</a> 。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-data-ldap"><a class="anchor" href="#spring-data-ldap"></a> Spring Data LDAP</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring LDAP项目已经为Spring Data存储库本身提供了相当长的支持。借助Ingalls，我们已经将支持内容提取到了Spring Data模块中，以便我们对内部SPI所做的更改可以更快地传播到基于LDAP的实现中。</p>
</div>
<div class="paragraph">
<p>如果您是现有的Spring LDAP存储库用户，那么您将受到此更改的影响，并且需要对项目进行两项更改：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>加<a href="https://projects.spring.io/spring-data-ldap/#quick-start"><code>Spring Data LDAP</code></a>到您的项目依赖项。</p>
</li>
<li>
<p>将软件包从以下位置更改为存储库组件<code>org.springframework.ldap.repository</code>至<code>org.springframework.data.ldap.repository</code> 。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>也就是说，Spring LDAP 2.3.0已经删除了其存储库支持，如果您按照上述步骤操作，则可以继续将LDAP存储库与Spring Data LDAP 1.0一起使用。通过查看我们的<a href="https://github.com/spring-projects/spring-data-examples/tree/9a2e95a784cf449bdda372668ae78e8d5c06956d/ldap/example">Spring Data LDAP示例，</a>了解有关LDAP存储库的更多信息。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion"><a class="anchor" href="#conclusion"></a>结论</h2>
<div class="sectionbody">
<div class="paragraph">
<p>希望我能为您简要介绍Ingalls发布系列的新功能。我们希望通过<a href="https://gitter.im/spring-projects/spring-data">Gitter渠道</a>收到您的反馈。另外，请继续报告您在<a href="https://jira.spring.io">JIRA中</a>发现的所有错误。编码愉快！</p>
</div>
</div>
</div></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 2804;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>请启用JavaScript以查看<a href="http://disqus.com/?ref_noscript">由Disqus提供</a>的<a href="http://disqus.com/?ref_noscript">评论。</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">由<span class="logo-disqus">Disqus</span>提供动力的评论</a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>背部</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">所有帖子</a> <a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">工程</a> <a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">发布</a> <a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">新闻与活动</a> <a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>将The Spring Team的更新发送到您的收件箱</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">球队</a></li>
<li><a href="/tools">工具类</a></li>
<li><a href="https://store.pivotal.io/">商店</a></li>
<li><a href="/blog">通讯</a></li>
</ul>
</div>
</div>© <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a> ，Inc.保留所有权利。
<a href="https://pivotal.io/terms-of-use">使用条款</a> • <a href="https://pivotal.io/privacy-policy">隐私</a> • <a href="/trademarks">商标准则</a>
<div id="teconsent" style="display:inline-block"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>