<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Dynamic DataSource Routing</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Dynamic DataSource Routing" />
<meta name="twitter:description" content="&lt;p&gt;Spring 2.0.1 introduced an &lt;code&gt;AbstractRoutingDataSource&lt;/code&gt;. I believe that it deserves attention, since (based on frequent questions from clients) I have a hunch that there are quite a few ‘home-grown’ solutions to this problem floating around. That combined with the fact that it is trivial to implement yet easy to overlook, and now I have several reasons to dust off my corner of the team blog.&lt;/p&gt;
&lt;p&gt;The general idea is that a routing &lt;code&gt;DataSource&lt;/code&gt; acts as an intermediary - while the ‘real’ DataSource can be determined dynamically at runtime based upon a lookup key. One potential use-case is for ensuring transaction-specific isolation levels which are not supported by standard JTA. For that, Spring provides an implementation: &lt;code&gt;IsolationLevelDataSourceRouter&lt;/code&gt;. Consult its JavaDoc for a detailed description including configuration examples. &lt;/p&gt;
" />
<meta name="twitter:creator" content="@m_f_" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/443e6ec0242c3f54001dae34374780e2?s=200" />

<meta property="og:title" content="Dynamic DataSource Routing" />
<meta property="og:image" content="https://gravatar.com/avatar/443e6ec0242c3f54001dae34374780e2?s=200" />
<meta property="og:description" content="&lt;p&gt;Spring 2.0.1 introduced an &lt;code&gt;AbstractRoutingDataSource&lt;/code&gt;. I believe that it deserves attention, since (based on frequent questions from clients) I have a hunch that there are quite a few ‘home-grown’ solutions to this problem floating around. That combined with the fact that it is trivial to implement yet easy to overlook, and now I have several reasons to dust off my corner of the team blog.&lt;/p&gt;
&lt;p&gt;The general idea is that a routing &lt;code&gt;DataSource&lt;/code&gt; acts as an intermediary - while the ‘real’ DataSource can be determined dynamically at runtime based upon a lookup key. One potential use-case is for ensuring transaction-specific isolation levels which are not supported by standard JTA. For that, Spring provides an implementation: &lt;code&gt;IsolationLevelDataSourceRouter&lt;/code&gt;. Consult its JavaDoc for a detailed description including configuration examples. &lt;/p&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2007-01-23 21:57:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Dynamic DataSource Routing</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/443e6ec0242c3f54001dae34374780e2?s=20&amp;d=mm" />
<a class="author" rel="author" href="/team/mfisher">Mark Fisher</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2007-01-23 21:57:00.0">January 23, 2007</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="50" href="/blog/2007/01/23/dynamic-datasource-routing#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><p>Spring 2.0.1 introduced an <code>AbstractRoutingDataSource</code>. I believe that it deserves attention, since (based on frequent questions from clients) I have a hunch that there are quite a few &lsquo;home-grown&rsquo; solutions to this problem floating around. That combined with the fact that it is trivial to implement yet easy to overlook, and now I have several reasons to dust off my corner of the team blog.</p><p>The general idea is that a routing <code>DataSource</code> acts as an intermediary - while the &lsquo;real&rsquo; DataSource can be determined dynamically at runtime based upon a lookup key. One potential use-case is for ensuring transaction-specific isolation levels which are not supported by standard JTA. For that, Spring provides an implementation: <code>IsolationLevelDataSourceRouter</code>. Consult its JavaDoc for a detailed description including configuration examples. </p><p>Another interesting use-case is determination of the DataSource based on some attribute of the current user&rsquo;s context. What follows is a rather contrived example to demonstrate this idea.</p><p>First, I created a <code>Catalog</code> that extends Spring 2.0&rsquo;s <code>SimpleJdbcDaoSupport</code>. That base class only requires an instance of any implementation of <code>javax.sql.DataSource</code>, and then it creates a <code>SimpleJdbcTemplate</code> for you. Since it extends <code>JdbcDaoSupport</code>, the <code>JdbcTemplate</code> is also available. However, the &ldquo;simple&rdquo; version provides many nice Java 5 conveniences. You can read more detail about that in <a href="https://spring.io/blog/2006/11/28/simplejdbctemplate-spring-2-0-and-java-5">this blog</a> by Ben Hale.</p><p>Anyways, here&rsquo;s the code for my <code>Catalog</code>:</p>
<pre><code class="prettyprint java">package blog.datasource;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;

import org.springframework.jdbc.core.simple.ParameterizedRowMapper;
import org.springframework.jdbc.core.simple.SimpleJdbcDaoSupport;

public class Catalog extends SimpleJdbcDaoSupport {
	
   public List&lt;Item&gt; getItems() {
      String query = &quot;select name, price from item&quot;;
      return getSimpleJdbcTemplate().query(query, new ParameterizedRowMapper&lt;Item&gt;() {
            public Item mapRow(ResultSet rs, int row) throws SQLException {
               String name = rs.getString(1);
               double price = rs.getDouble(2);
               return new Item(name, price);
            }
      });
   }
}
</code></pre><p>As you can see, the <code>Catalog</code> simply returns a list of <code>item</code> objects. The <code>Item</code> just contains name and price properties:</p>
<pre><code class="prettyprint java">package blog.datasource;

public class Item {

   private String name;
   private double price;
	
   public Item(String name, double price) {
      this.name = name;
      this.price = price;
   }

   public String getName() {
      return name;
   }

   public double getPrice() {
      return price;
   }

   public String toString() {
      return name + &quot; (&quot; + price + &quot;)&quot;;
   }

}
</code></pre><p>Now, in order to demonstrate multiple DataSources, I created an enum for different Customer types (representing &ldquo;levels&rdquo; of membership I guess), and I created three different databases - so that each type of customer would get a distinct item list (I did mention that this would be a contrived example didn&rsquo;t I?). The important thing is that each of the databases are equivalent in terms of the schema. That way the Catalog&rsquo;s query will work against any of them - just returning different results. In this case, it&rsquo;s just the &ldquo;item&rdquo; table with 2 columns: name and price. And&hellip; here is the enum:</p>
<pre><code class="prettyprint java">public enum CustomerType {
   BRONZE, 
   SILVER, 
   GOLD
}
</code></pre><p>It&rsquo;s time to create some bean definitions. Since I have 3 datasources where everything is the same except for the port number, I created a parent bean so that the shared properties can be inherited. Then, I added the 3 bean definitions to represent the per-CustomerType DataSources:</p>
<pre><code class="prettyprint xml">&lt;bean id=&quot;parentDataSource&quot;
         class=&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;
         abstract=&quot;true&quot;&gt;
   &lt;property name=&quot;driverClassName&quot; value=&quot;org.hsqldb.jdbcDriver&quot;/&gt;
   &lt;property name=&quot;username&quot; value=&quot;sa&quot;/&gt;
&lt;/bean&gt;
		
&lt;bean id=&quot;goldDataSource&quot; parent=&quot;parentDataSource&quot;&gt;
   &lt;property name=&quot;url&quot; value=&quot;jdbc:hsqldb:hsql://localhost:${db.port.gold}/blog&quot;/&gt;
&lt;/bean&gt;

&lt;bean id=&quot;silverDataSource&quot; parent=&quot;parentDataSource&quot;&gt;
   &lt;property name=&quot;url&quot; value=&quot;jdbc:hsqldb:hsql://localhost:${db.port.silver}/blog&quot;/&gt;
&lt;/bean&gt;

&lt;bean id=&quot;bronzeDataSource&quot; parent=&quot;parentDataSource&quot;&gt;
   &lt;property name=&quot;url&quot; value=&quot;jdbc:hsqldb:hsql://localhost:${db.port.bronze}/blog&quot;/&gt;
&lt;/bean&gt;

&lt;bean class=&quot;org.springframework.beans.factory.config.PropertyPlaceholderConfigurer&quot;&gt;
   &lt;property name=&quot;location&quot; value=&quot;classpath:/blog/datasource/db.properties&quot;/&gt;
&lt;/bean&gt;	
</code></pre><p>Notice that I added a <code>PropertyPlaceholderConfigurer</code> so that I could externalize the port numbers in a &ldquo;db.properties&rdquo; file, like so:</p>
<pre>db.port.gold=9001
db.port.silver=9002
db.port.bronze=9003
</pre><p>Now things start to get interesting. I need to supply the &ldquo;routing&rdquo; DataSource to my <code>Catalog</code> so that it can dynamically get connections from the 3 different databases at runtime based on the current customer&rsquo;s type. As I mentioned, the <code>AbstractRoutingDataSource</code> can be rather simple to implement. Here is my implementation:</p>
<pre><code class="prettyprint java">package blog.datasource;

import org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;

public class CustomerRoutingDataSource extends AbstractRoutingDataSource {

   @Override
   protected Object determineCurrentLookupKey() {
      return CustomerContextHolder.getCustomerType();
   }
}
</code></pre><p>&hellip;and the <code>CustomerContextHolder</code> simply provides access to a thread-bound <code>CustomerType</code>. In reality, the &lsquo;context&rsquo; would likely hold more information about the customer. Also note that if you are using Spring Security, then you could retrieve some information from the userDetails. For this example, it&rsquo;s just the customer &ldquo;type&rdquo;:</p>
<pre><code class="prettyprint java">public class CustomerContextHolder {

   private static final ThreadLocal&lt;CustomerType&gt; contextHolder = 
            new ThreadLocal&lt;CustomerType&gt;();
	
   public static void setCustomerType(CustomerType customerType) {
      Assert.notNull(customerType, &quot;customerType cannot be null&quot;);
      contextHolder.set(customerType);
   }

   public static CustomerType getCustomerType() {
      return (CustomerType) contextHolder.get();
   }

   public static void clearCustomerType() {
      contextHolder.remove();
   }
}
</code></pre><p>Finally, I just need to configure the catalog and routing DataSource beans. As you can see, the &ldquo;real&rdquo; DataSource references are provided in a Map. If you provide Strings, they can be resolved as JNDI names (or any custom resolution strategy can be provided - see the JavaDoc). Also, I&rsquo;ve simply set the &lsquo;bronzeDataSource&rsquo; as the default:</p>
<pre><code class="prettyprint xml">&lt;bean id=&quot;catalog&quot; class=&quot;blog.datasource.Catalog&quot;&gt;
   &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;
&lt;/bean&gt;

&lt;bean id=&quot;dataSource&quot; class=&quot;blog.datasource.CustomerRoutingDataSource&quot;&gt;
   &lt;property name=&quot;targetDataSources&quot;&gt;
      &lt;map key-type=&quot;blog.datasource.CustomerType&quot;&gt;
         &lt;entry key=&quot;GOLD&quot; value-ref=&quot;goldDataSource&quot;/&gt;
         &lt;entry key=&quot;SILVER&quot; value-ref=&quot;silverDataSource&quot;/&gt;
      &lt;/map&gt;
   &lt;/property&gt;
   &lt;property name=&quot;defaultTargetDataSource&quot; ref=&quot;bronzeDataSource&quot;/&gt;
&lt;/bean&gt;
</code></pre><p>Of course I&rsquo;d like to see this working, so I&rsquo;ve created a simple test (extending one of Spring&rsquo;s integration test support classes). I added 3 items to the &ldquo;gold&rdquo; database, 2 items to the &ldquo;silver&rdquo; database, and only 1 item to the &ldquo;bronze&rdquo; database. This is the test:</p>
<pre><code class="prettyprint java">public class CatalogTests extends AbstractDependencyInjectionSpringContextTests {

   private Catalog catalog;

   public void setCatalog(Catalog catalog) {
      this.catalog = catalog;
   }

   public void testDataSourceRouting() {
      CustomerContextHolder.setCustomerType(CustomerType.GOLD);
      List&lt;Item&gt; goldItems = catalog.getItems();
      assertEquals(3, goldItems.size());
      System.out.println(&quot;gold items: &quot; + goldItems);

      CustomerContextHolder.setCustomerType(CustomerType.SILVER);
      List&lt;Item&gt; silverItems = catalog.getItems();
      assertEquals(2, silverItems.size());
      System.out.println(&quot;silver items: &quot; + silverItems);
	
      CustomerContextHolder.clearCustomerType();
      List&lt;Item&gt; bronzeItems = catalog.getItems();
      assertEquals(1, bronzeItems.size());
      System.out.println(&quot;bronze items: &quot; + bronzeItems);		
   }

   protected String[] getConfigLocations() {
      return new String[] {&quot;/blog/datasource/beans.xml&quot;};
   }	
}
</code></pre><p>&hellip;and rather than simply taking a screenshot of the green bar, you&rsquo;ll notice I&rsquo;ve provided some console output - the results!:</p>
<pre>gold items: [gold item #1 (250.0), gold item #2 (325.45), gold item #3 (55.6)]
silver items: [silver item #1 (25.0), silver item #2 (15.3)]
bronze items: [bronze item #1 (23.75)]
</pre><p>As you can see, the configuration is simple. Better still, the data-access code is not concerned with looking up different DataSources. For more information, consult the JavaDoc for <code>AbstractRoutingDataSource</code>.</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 50;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>