<html  data-code-prettify="" data-mobile-support="" data-search=""><head>
<title>Spring 2.1中的注释驱动依赖注入</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="Annotation-Driven Dependency Injection in Spring 2.1">
<meta name="twitter:description" >
<meta name="twitter:creator" content="@m_f_">
<meta name="twitter:image:src" content="https://gravatar.com/avatar/443e6ec0242c3f54001dae34374780e2?s=200">

<meta property="og:title" content="Annotation-Driven Dependency Injection in Spring 2.1">
<meta property="og:image" content="https://gravatar.com/avatar/443e6ec0242c3f54001dae34374780e2?s=200">
<meta property="og:description" >
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2007-05-14 17:35:00.0">



<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Spring 2.1中的注释驱动依赖注入</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/443e6ec0242c3f54001dae34374780e2?s=20&d=mm"> <a class="author" rel="author" href="/team/mfisher">马克·费舍尔</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2007-05-14 17:35:00.0">2007年5月14日</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2007/05/14/annotation-driven-dependency-injection-in-spring-2-1#disqus_thread" data-disqus-identifier="74">
</a></div>
</div>
</header>
<div class="blog--post"><p>Spring 2.0引入了注释支持和注释感知配置选项，使用Java 5（或更高版本）进行开发的Spring用户可以利用这些选项：</p><table>
<tbody><tr>
<th><a href="http://static.springframework.org/spring/docs/2.0.x/api/org/springframework/transaction/annotation/Transactional.html">@交易</a></th>
<td>用于划分和配置事务定义</td>
</tr>
<tr>
<th><a href="https://www.eclipse.org/aspectj/doc/released/aspectj5rt-api/org/aspectj/lang/annotation/Aspect.html">@Aspect</a> （AspectJ）</th>
<td>用于定义方面以及@Pointcut定义和建议（@ Before，@ After，@ Around）</td>
</tr>
<tr>
<th><a href="http://static.springframework.org/spring/docs/2.0.x/api/org/springframework/stereotype/Repository.html">@资料库</a></th>
<td>用于指示用作存储库的类（也称为数据访问对象或DAO）</td>
</tr>
<tr>
<th><a href="http://static.springframework.org/spring/docs/2.0.x/api/org/springframework/beans/factory/annotation/Required.html">@Required</a></th>
<td>为强制注释的bean属性提供了一个值</td>
</tr>
</tbody></table>
<p></p>
<p>在Spring 2.1中，注释驱动配置的主题已得到显着扩展，并将随着我们向RC1版本的发展而继续发展。实际上，现在可以通过注释来驱动Spring的依赖项注入。此外，Spring可以<em>发现</em>需要在应用程序上下文中配置的bean。
</p>
<p>该博客文章将以10个易于遵循的步骤，以教程式的形式介绍基本功能。我将在本周晚些时候跟进一些更高级的功能和自定义选项的信息。如果您对替代配置选项感兴趣，还应该查看<a href="http://www.springframework.org/javaconfig">Spring Java Configuration</a>项目和<a href="http://blog.interface21.com/main/2006/11/28/a-java-configuration-option-for-spring/">此博客</a> 。
</p>
<p>本教程至少需要Java 5，并且建议使用Java 6（否则，在步骤1的末尾只有一个要求）。
</p>
<h2>步骤1：</h2>
<p>抓取<a href="https://downloads.sourceforge.net/springframework/spring-framework-2.1-m1-with-dependencies.zip">spring-framework-2.1-m1-with-dependencies.zip</a> 。解压缩档案后，您将在“ dist”目录中找到spring.jar和spring-mock.jar。将它们添加到您的CLASSPATH以及以下文件中（显示的路径是相对于所提取的2.1-m1归档文件的'lib'目录而言的）：</p><ul>
<li>asm / asm-2.2.3.jar</li>
<li>asm / asm-commons-2.2.3.jar</li>
<li>Aspectj / aspectjweaver.jar</li>
<li>hsqldb / hsqldb.jar</li>
<li>jakarta-commons / commons-logging.jar</li>
<li>log4j / log4j-1.2.14.jar</li>
</ul>（注意：如果您未在Java 6上运行，则还需要添加j2ee / common-annotations.jar）<p></p>
<h2>第2步：</h2><p>提供示例的接口和类。我试图使它尽可能简单，但能够演示主要功能。我将所有代码和配置都包含在一个“博客”包中。我鼓励遵循相同的准则，以使示例按原样工作。否则，请确保进行必要的修改。首先， <em>GreetingService</em>接口：</p>
<pre><code class="prettyprint java"><br />public interface GreetingService {
    String greet(String name);
}
</code></pre><p>然后，一个简单的实现：</p>
<pre><code class="prettyprint java"><br />public class GreetingServiceImpl implements GreetingService {
    private MessageRepository messageRepository;

    public void setMessageRepository(MessageRepository messageRepository) {
        this.messageRepository = messageRepository;
    }

    public String greet(String name) {
        Locale locale = Locale.getDefault();
        String message = messageRepository.getMessage(locale.getDisplayLanguage());
        return message + &quot; &quot; + name;
    }
}
</code></pre><p>由于服务依赖于<em>MessageRepository</em> ，因此接下来请定义该接口：</p>
<pre><code class="prettyprint java"><br />public interface MessageRepository {
    String getMessage(String language);
}
</code></pre><p>现在，存根实现：</p>
<pre><code class="prettyprint java"><br />public class StubMessageRepository implements MessageRepository {
    Map&lt;String,String&gt; messages = new HashMap&lt;String,String&gt;();

    public void initialize() {
        messages.put(&quot;English&quot;, &quot;Welcome&quot;);
        messages.put(&quot;Deutsch&quot;, &quot;Willkommen&quot;);
    }

    public String getMessage(String language) {
        return messages.get(language);
    }
}
</code></pre><p></p><p></p>
<h2>第三步：</h2>
<p>为Spring应用程序上下文定义bean。注意，我包括了一个新的'context'名称空间（注意：'aop'名称空间也包括在这里，将在最后一步中使用）：```xml <beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:aop="http://www.springframework.org/schema/aop" xmlns:context="http://www.springframework.org/schema/context" xsi:schemalocation="http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
           http://www.springframework.org/schema/aop
           http://www.springframework.org/schema/aop/spring-aop-2.0.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context-2.1.xsd"><bean class="blog.GreetingServiceImpl"></bean><bean class="blog.StubMessageRepository"></bean></beans>显然，这种配置有点稀疏。您可能会猜到，“上下文”名称空间将很快发挥作用。
</p>
<h2>第四步：</h2><p>利用Spring的基础支持类提供一个简单的测试用例：</p>
<pre><code class="prettyprint java"><br />public class GreetingServiceImplTests extends AbstractDependencyInjectionSpringContextTests {
    private GreetingService greetingService;

    public void setGreetingService(GreetingService greetingService) {
        this.greetingService = greetingService;
    }

    @Override
    protected String[] getConfigLocations() {
        return new String[] { &quot;/blog/applicationContext.xml&quot; };
    }

    public void testEnglishWelcome() {
        Locale.setDefault(Locale.ENGLISH);
        String name = &quot;Spring Community&quot;;
        String greeting = greetingService.greet(name);
        assertEquals(&quot;Welcome &quot; + name, greeting);
    }

    public void testGermanWelcome() {
        Locale.setDefault(Locale.GERMAN);
        String name = &quot;Spring Community&quot;;
        String greeting = greetingService.greet(name);
        assertEquals(&quot;Willkommen &quot; + name, greeting);
    }
}
</code></pre><p>尝试运行测试，请注意测试失败，并显示NullPointerException。这是可以预期的，因为尚未为GreetingServiceImpl提供MessageRepository。在接下来的两个步骤中，您将添加注释以分别驱动依赖项注入和初始化。<br></p><p></p>
<h2>步骤5：</h2><p>在GreetingServiceImpl的setter方法上提供@Autowired批注，例如：</p>
<pre><code class="prettyprint java"><br />@Autowired
public void setMessageRepository(MessageRepository messageRepository) {
    this.messageRepository = messageRepository;
}
</code></pre><p>然后，将“ annotation-config”元素（来自新的“ context”名称空间）添加到您的配置中：</p>
<pre><code class="prettyprint xml"><br />&lt;beans ... &gt;
    
    &lt;context:annotation-config/&gt;

    &lt;bean class=&quot;blog.GreetingServiceImpl&quot;/&gt;

    &lt;bean class=&quot;blog.StubMessageRepository&quot;/&gt;

&lt;/beans&gt; 
</code></pre><p>重新运行测试。它们仍然会失败，但是如果您仔细观察，那将是一个新问题。断言失败，因为返回的消息为空。这意味着，“messageRepository”属性被<em>设置</em>在问候的服务！现在，只需要初始化StubMessageRepository。<br></p><p></p>
<h2>步骤6：</h2><p>Spring为初始化回调提供了两个选项：Spring的InitializingBean接口或XML中的“ init-method”声明。从Spring 2.1开始，支持JSR-250注释-提供了另一个选项：@PostConstruct（和@PreDestroy注释可用于销毁回调，正如您很快就会看到的那样）。在StubMessageRepository中，将注释添加到<em>initialize</em>方法中：</p>
<pre><code class="prettyprint java"><br />@PostConstruct
public void initialize() {
    messages.put(&quot;English&quot;, &quot;Welcome&quot;);
    messages.put(&quot;Deutsch&quot;, &quot;Willkommen&quot;);
}
</code></pre><p>重新运行测试。这次他们应该通过！<br></p><p></p>
<h2>步骤7：</h2>
<p>@Autowired批注还可用于基于构造函数的注入。如果您想尝试该选项，请从GreetingServiceImpl中删除setter方法，然后添加此构造函数（然后重新运行测试）： }```如果愿意，您甚至可以使用场注入。删除构造函数，将注释直接添加到字段中，然后重新运行测试。代码应如下所示：```java @Autowired private MessageRepository messageRepository; ```</p>
<h2>步骤8：</h2>
<p>添加MessageRepository的基于JDBC的存储库实现：Java公用类JdbcMessageRepository实现MessageRepository {private SimpleJdbcTemplate jdbcTemplate; @PostConstruct public void setUpDatabase（）{jdbcTemplate.update（“创建表消息（语言varchar（20），消息varchar（100））”）； jdbcTemplate.update（“插入消息（语言，消息）值（'英语'，'欢迎'）”）； jdbcTemplate.update（“插入消息（语言，消息）值（'Deutsch'，'Willkommen'）”）； } @PreDestroy public void tearDownDatabase（）{jdbcTemplate.update（“删除表消息”）; } public String getMessage（String language）{return jdbcTemplate.queryForObject（“从消息中选择消息，其中language =？“，String.class，language）;}}```注意，除了@PostConstruct进行初始化外，它还使用@PreDestroy标记要在销毁时调用的方法。此实现尚不清楚一件事：如何提供SimpleJdbcTemplate？一种选择是为模板提供bean定义。另一个选择是以某种方式为模板的构造函数提供DataSource实现。添加以下（带注释）方法：```java @Autowired public void createTemplate（DataSource dataSource）{this.jdbcTemplate = new SimpleJdbcTemplate（dataSource）; }```这说明了依赖项注入可以通过任意方法（不是传统的“ setter”）来工作。下一步将对此进行测试。
</p>
<h2>步骤9：</h2>
<p>在Spring 2.1中，甚至可以发现“候选” bean，而不是如上所述在XML中明确提供。默认情况下会识别某些注释。这包括@Repository批注以及新的@Component批注。将这两个注释分别添加到JdbcMessageRepository和GreetingServiceImpl：```java @Repository公共类JdbcMessageRepository实现MessageRepository {...}``````java @Component公共类GreetingServiceImpl实现GreetingService {...}然后通过删除现有的显式bean定义并仅添加<em>组件扫描</em>标签来修改XML文件： <beans ...=""><context:component-scan base-package="blog"></context:component-scan></beans>然后，仅添加DataSource bean定义和用于配置属性占位符的新标记：XML <beans ...=""><context:component-scan base-package="blog"></context:component-scan><context:property-placeholder location="classpath:blog/jdbc.properties"></context:property-placeholder> <bean class="org.springframework.jdbc.datasource.DriverManagerDataSource"><property name="driverClassName" value="${jdbc.driver}"></property><property name="url" value="${jdbc.url}"></property><property name="username" value="${jdbc.username}"></property><property name="password" value="${jdbc.password}"></property></bean></beans>以及jdbc.properties文件本身：java的jdbc.driver = org.hsqldb.jdbcDriver jdbc.url = jdbc：hsqldb：mem：blog jdbc.username = sa jdbc.password =重新运行测试，即使只在XML中定义了数据源，您也应该看到绿色的条。</p>
<h2>步骤10：</h2>
<p>最后，添加一个方面（默认情况下也会自动检测@Aspect注释）：```java @Aspect public class ServiceInvocationLogger {private int invocationCount; @Pointcut（“ execution（* Blog。*服务+。*（..））“）公共无效serviceInvocation（）{} @Before（” serviceInvocation（）“）public void log（）{invocationCount ++; System.out.println（” service invocation＃“ + invocationCount）;}}`为了激活自动代理生成，只需在xml中添加以下标签： <aop:aspectj-autoproxy></aop:aspectj-autoproxy>重新运行测试，您应该会看到日志消息！
</p>
<p>注意：扫描和配置过程无需任何XML即可启动，并且可以自定义（例如，检测您自己的注释和/或类型）。我将在下一篇文章中讨论这些功能以及更多内容。
</p>
<p>同时，我希望这篇文章能很好地达到目的-提供这些Spring 2.1新功能的动手经验。与往常一样，我们希望能收到社区的反馈，请随时发表评论！
</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 74;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>请启用JavaScript以查看<a href="http://disqus.com/?ref_noscript">由Disqus提供</a>的<a href="http://disqus.com/?ref_noscript">评论。</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">由<span class="logo-disqus">Disqus</span>提供动力的评论</a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>背部</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">所有帖子</a> <a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">工程</a> <a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">发布</a> <a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">新闻与活动</a> <a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>将The Spring Team的更新发送到您的收件箱</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">工具类</a></li>
<li><a href="https://store.pivotal.io/">商店</a></li>
<li><a href="/blog">通讯</a></li>
</ul>
</div>
</div>© <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a> ，Inc.保留所有权利。
<a href="https://pivotal.io/terms-of-use">使用条款</a> • <a href="https://pivotal.io/privacy-policy">隐私</a> • <a href="/trademarks">商标准则</a>
<div id="teconsent" style="display:inline-block"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>