<html  data-code-prettify="" data-mobile-support="" data-search=""><head></head><body >﻿
<title>在SpringSource dm Server中部署GWT应用程序-第3部分</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="Deploying GWT Applications in SpringSource dm Server - Part 3">
<meta name="twitter:description" >
<meta property="og:title" content="Deploying GWT Applications in SpringSource dm Server - Part 3">
<meta property="og:description" >
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2008-12-19 21:37:00.0">



<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">在SpringSource dm Server中部署GWT应用程序-第3部分</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="null?s=20&d=mm"> <span class="author">本·科里</span>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2008-12-19 21:37:00.0">2008年12月19日</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2008/12/19/deploying-gwt-applications-in-springsource-dm-server-part-3#disqus_thread" data-disqus-identifier="192">
</a></div>
</div>
</header>
<div class="blog--post"><h2>介绍</h2><p>这是系列文章（共三部分）中的最后一篇博客，描述了在<a href="http://www.springsource.com/products/suite/dmserver" target="_blank">SpringSource dm Server™中</a>逐步构建和部署GWT应用程序的方法。第一个博客介绍了从示例GWT应用程序创建简单WAR文件的过程，第二个博客将GWT依赖项转换为OSGi包，可以在多个应用程序之间共享。这个最后的博客将使用Spring Dynamic Modules将我们的GWT示例进一步模块化为OSGi服务。这应该清楚地证明OSGi模块化的好处：在运行时删除和替换服务，无缝管理捆绑软件的多个版本以及使用dm Server进行部署和管理的直接性。</p><p>这是该系列中唯一实际使用Spring Framework的博客。Spring用于配置Spring动态模块以及发布和使用OSGi服务。它还展示了一种通过GWT远程处理桥接Spring托管bean的世界的机制。但是，我很清楚Spring / GWT集成本身就是一个重要的话题，因此在这里我有意保留一个简单的解决方案。</p><p>请参阅<a href="http://blog.springsource.com/2008/11/07/deploying-gwt-applications-in-springsource-dm-server-part-1/" target="_blank">第1部分</a> ，获取GWT <a href="https://code.google.com/docreader/#p=google-web-toolkit-doc-1-5&s=google-web-toolkit-doc-1-5&t=GettingStarted" target="_blank">StockWatcher</a>示例的背景以及我使用的软件。</p><p>另外请注意，您可以跳过所有这些繁琐的说明，并放大至底部的下载摘要。<br></p><h2>快速赶上</h2><br>在<a href="http://blog.springsource.com/2008/11/07/deploying-gwt-applications-in-springsource-dm-server-part-1/" target="_blank">第1部分中</a> ，我们从头开始将GWT StockWatcher示例应用程序构建为Eclipse项目，然后将代码生成到Dynamic Web项目中，然后将其部署到dm Server中。最后，我们将Dynamic Web项目导出到WAR文件中，并将其部署在STS之外。<p></p><p>在<a href="http://blog.springsource.com/2008/11/24/deploying-gwt-applications-in-springsource-dm-server-part-2/" target="_blank">第2部分中</a> ，我们从WAR文件中删除了GWT依赖项，并将它们转换为OSGi捆绑包，该捆绑包已安装到dm Server的存储库中。这样做之后，我们便能够部署使用GWT远程处理的任何数量的应用程序，而不必在WAR中包括任何GWT依赖项。</p><p>在最后一部分中，我们将使用Spring动态模块进一步模块化应用程序。您可能会问的一个问题是……为什么？这不是一个坏问题-没有人希望为此不必要地使其代码复杂化。在确定共享服务方法是否会有所帮助时，您可以将其归结为一些简单的问题：<br></p><p style="padding-left:30px">-我的应用程序中是否有其他部分可能需要使用的部分？<br>-应用程序中的不同组件会以不同的速度发展吗？<br>-是否可能需要维护同一组件的多个并发版本？<br>-我是否希望能够在运行时将更改部署到应用程序中的组件？</p><p>看一下我们的Stockwatcher应用程序，它目前仅限于一个股票市场。我们知道世界各地有许多不同的市场，因此要使其更具灵活性，一定要使其具有进入不同市场的能力，这就是我们要做的-将我们的股票市场转变为共享市场服务。一个捆绑包将包含定义市场能做什么的共享API。然后，其他捆绑包可以是该API的实现-也许一个用于伦敦，一个用于纽约。然后，我们将能够部署所需的市场，启动它，停止它，取消部署并用另一个替换它-所有这些都在运行时进行。</p><p>我意识到，将一个WAR文件转换为共享服务的过程可能比从头开始以模块化方式设计它要普遍得多，因此，该博客将进一步建立在我们<a href="http://blog.springsource.com/2008/11/24/deploying-gwt-applications-in-springsource-dm-server-part-2/" target="_blank">第2部分中的</a>基础上，而不是重新开始。您可以从第2部分的Eclipse项目<a href="http://blog.springsource.com/wp-content/uploads/2008/11/stockwatcherwarslproj.zip">在这里</a>所有的工作和完成的项目在第3部分<a href="http://blog.springsource.com/wp-content/uploads/2008/12/stockwatcherwarssproj.zip">在这里</a> （你需要，如果你做的定义GWT_ROOT_INSTALL CLASSPATH变量）。希望我在较早的博客中提出的有关划分源代码的一些建议最终将变得有意义！<br></p><h2>步骤1：创建StockService API捆绑包</h2><br>为了创建伦敦和纽约StockWatcherService实施包，我们需要为它们提供通用的API。显然，模块化通用代码是一种好习惯，但是还有一个更重要的原因，为什么我们需要单独的API捆绑包。如果要取消部署dm Server中正在运行的应用程序中的捆绑软件，则可以安全地删除实现服务的代码，但是不能删除其余代码所依赖的任何接口。因此，将我们的服务接口和通用代码放入一个API捆绑包中是有意义的，这将成为其他捆绑包的依赖项。<p></p><p>要在Eclipse中创建一个简单的bundle项目，请右键单击并选择New-> Other-> SpringSource dm Server-> Bundle Project。这将为您创建一个骨架<tt>MANIFEST.MF</tt> 。我们不需要将其作为Spring Dynamic Module，因为它的唯一目的是提供API，并且它自己没有任何bean实例，因此可以使用vanilla bundle。<br></p><p style="padding-left:30px">-指定StockWatcherServiceAPI作为项目名称<br>-如果愿意，可以单击“项目布局”中的“配置默认值…”链接来配置源目录。为了保持一致，我将其设置为<tt>src / main / java</tt><br>-将套件名称和符号名称设置为<tt>com.google.gwt.sample.stockwatcher.client.api</tt> ，并将版本保持为<tt>1.0.0</tt><br>-模块类型应为“ <tt>无”</tt> ，目标运行时应为dm服务器实例。如果没有选择的选项，则需要单击“新建”并创建一个。<br>-现在，您可以单击“完成”，并且应该看到带有生成的<tt>MANIFEST.MF的</tt>新捆绑包项目。</p><p>下一步是将API代码移到新项目中。将整个<tt>com.google.gwt.sample.stockwatcher.client.api</tt>包从StockWatcherWar项目拖放到新的捆绑包项目中。这是客户端和服务器共享的所有代码。它应该包含<tt>StockPriceService</tt>接口和<tt>StockPrice</tt>和<tt>DelistedException</tt>类。如果成功，那么几乎所有事情都应该被打破！</p><p>接下来，让我们考虑一下我们需要从新捆绑包中导出的内容。好吧，在这种情况下很简单-一个包中的API。在<tt>MANIFEST.MF</tt>编辑器的“运行时”选项卡中，将包添加到“导出的包”列表中并保存。</p><p>现在，我们需要考虑我们的API代码需要哪些依赖关系，换句话说，为什么不再构建。显然，我们在<a href="http://blog.springsource.com/2008/11/24/deploying-gwt-applications-in-springsource-dm-server-part-2/" target="_blank">第2部分中</a>创建的GWT包将是一个好的开始。在Dependencies选项卡中，将com.google.gwt捆绑包添加到Import Bundle列表中（如果未列出，则可能不在dm Server存储库中，这将在<a href="http://blog.springsource.com/2008/11/24/deploying-gwt-applications-in-springsource-dm-server-part-2/" target="_blank">第2部分中进行</a>说明）并保存。这应该可以解决新项目中的所有构建问题，但其他项目仍应中断。现在，让我们忽略它，因为还有更多的重构工作要做。</p><p>此时，StockWatcherServiceAPI项目应如下所示：</p><p><a href="http://blog.springsource.com/wp-content/uploads/2008/12/picture-1c.png"><img class="alignnone size-full wp-image-771" title="StockWatcherServiceAPI项目" src="http://blog.springsource.com/wp-content/uploads/2008/12/picture-1c.png" alt=""></a></p><p>其<tt>MANIFEST.MF</tt>应该如下所示：</p><p><a href="http://blog.springsource.com/wp-content/uploads/2008/12/picture-2c.png"><img class="alignnone size-full wp-image-772" title="StockWatcherServiceAPI MANIFEST.MF" src="http://blog.springsource.com/wp-content/uploads/2008/12/picture-2c.png" alt=""></a><br></p><h2>步骤2：创建一个StockPriceService服务包</h2><br>创建了包含公共代码的API包之后，我们可以从中创建多个服务实现，让我们创建其中一个实现。我们将从伦敦开始。<p></p><p>使用第1步中的说明创建一个名为“ StockWatcherServiceLondon”的新捆绑项目，并将其捆绑名称为com.google.gwt.sample.stockwatcher.service.london</p><p>因此，让我们考虑一下此捆绑包的需求。它需要代码来实现伦敦股票价格服务，以及一种将该服务作为共享服务导出到OSGi注册表的方法。第一部分是一个简单的重构工作，因为我们已经有了一些可以重用的服务代码。对于第二部分，将捆绑包变成Spring动态模块将是最简单的方法，因为它使使用Spring bean的发布和使用OSGi服务变得非常简单。</p><p>首先是第一件事。返回并查看<tt>StockPriceServiceImpl.java</tt>中的服务实现。您将看到<tt>StockPriceService</tt>代码绑定到<tt>RemoteServiceServlet</tt> 。需要保留servlet才能使远程工作，但是我们需要提取实现代码并使用它来创建共享服务。在第4部分的稍后部分，将需要修改servlet以使用我们创建的服务。</p><p>因此，从StockWatcherWar项目复制<tt>com.google.gwt.sample.stockwatcher.server</tt>程序包，然后将其粘贴到StockWatcherServiceLondon的<tt>src / main / java</tt>中。现在，您应该拥有一个可以重构的<tt>StockPriceServiceImpl.java</tt>副本。</p><p>删除<tt>扩展了RemoteServiceServlet</tt> ， <tt>RemoteServiceServlet</tt>导入和<tt>SerialVersionUID</tt>字段，因为现在不需要这些。保存更改后，您将看到我们需要为捆绑软件导入一些依赖关系-具体来说，就是在步骤1中创建的API捆绑软件。</p><p><a href="http://blog.springsource.com/wp-content/uploads/2008/12/picture-2d.png"><img class="alignnone size-full wp-image-777" title="StockWatcherService伦敦代码" src="http://blog.springsource.com/wp-content/uploads/2008/12/picture-2d.png" alt=""></a></p><p>编辑<tt>MANIFEST.MF</tt> ，为<tt>com.google.gwt.sample.stockwatcher.client.api</tt>添加导入包。保存后，清单中将显示一个错误，指出无法解析该软件包。我们做错了什么？！问题是，当您在Eclipse中的捆绑项目之间进行导入和导出时，您需要告诉工具以允许项目共享引用。右键单击StockWatcherServiceLondon，然后选择“属性”->“项目引用”。选中StockWatcherServiceAPI的复选框，然后单击确定。然后，您需要伪造<tt>MANIFEST.MF</tt>编辑以获取更改。现在，您应该看到StockWatcherServiceAPI被列为捆绑依赖项。让我明确地说，一旦从Eclipse导出了包，您就无需执行此额外的步骤-仅当您想在包之间只是项目时才在它们之间创建依赖项时。</p><p>您还应该解决另一个问题。尽管com..client.api捆绑软件导入了com.google.gwt捆绑软件，但该导入是该捆绑软件专用的。导入com..client.api捆绑包的任何捆绑包都不会继承此依赖关系-必须显式进行。因此，在<tt>MANIFEST.MF中</tt> ，为com.google.gwt捆绑包添加一个<tt>Import-Bundle</tt>并保存。如果您仍然在<tt>StockPriceServiceImpl.java中</tt>发现问题， <tt>则</tt>可能需要对其进行伪编辑，否则您做错了什么。</p><p><a href="http://blog.springsource.com/wp-content/uploads/2008/12/picture-7d.png"><img class="alignnone size-full wp-image-778" title="StockWatcherServiceLondon <tt> MANIFEST.MF </ tt>" src="http://blog.springsource.com/wp-content/uploads/2008/12/picture-7d.png" alt=""></a></p><p>辉煌！现在，我们正在创建共享服务。这是当前的外观：</p><p><a href="http://blog.springsource.com/wp-content/uploads/2008/12/picture-1d.png"><img class="alignnone size-full wp-image-776" title="StockWatcherService伦敦层次结构" src="http://blog.springsource.com/wp-content/uploads/2008/12/picture-1d.png" alt=""></a></p><p>下一步是将StockPriceServiceLondon转换为OSGi服务。我们将使用Spring动态模块来做到这一点。Spring动态模块的原理很简单-您在<tt>/ META-INF / spring</tt>文件夹中提供Spring配置文件，并在部署捆绑包时为您创建一个ApplicationContext。这是一种将Spring管理的bean导出为OSGi服务的极好且非常简单的方法。</p><p>因此，在<tt>/ META-INF中</tt>创建一个<tt>/ spring</tt>文件夹（右键单击<tt>/ META-INF</tt>并选择New-> Folder）。然后右键单击新的<tt>/ spring</tt>文件夹并选择New-> Spring Bean Definition。您可以随意调用它，但在我的示例中，它称为<tt>serviceLondon-config.xml</tt> 。输入名称，然后单击完成。现在，我们需要将<tt>StockPriceServiceImpl</tt>定义为Spring bean，以便在部署捆绑包时创建其实例。如果您熟悉Spring，这应该很容易。如果不是，则需要插入以下XML：<br></p><pre class="xml"> &lt;bean id=&ldquo;stockPrices&rdquo;<br /> class=&ldquo;com.google.gwt.sample.stockwatcher.server.StockPriceServiceImpl&rdquo;/&gt;</pre><br>最后，我们需要将此bean导出为OSGi服务。我们可以在同一个配置文件中执行此操作，但是最好将OSGi依赖项分开。因此，创建另一个名为osgi-config.xml的Spring Bean定义，这次单击Next，然后在单击Finish之前选中osgi名称空间复选框。要将bean导出为OSGi服务，请插入以下XML：<br><pre class="xml"> &lt;osgi:service<br /> interface=&ldquo;com.google.gwt.sample.stockwatcher.client.api.StockPriceService&rdquo;<br /> ref=&ldquo;stockPrices&rdquo;/&gt;</pre><br>而已！现在，我们有了一个可创建共享服务的捆绑包。在继续进行之前，进行测试将是一个明智的主意，以确保它的行为符合我们的预期。<br><h2>步骤3：测试共享服务包</h2><br>在这里，我将描述两种测试方法：快速而肮脏的方法以及正确记录的自动JUnit方法。可以说这应该是一个单独发布的博客，但我认为这是一个重要的主题，可以在此处详细介绍。<br><h3>快速而肮脏的测试：</h3><br>快速而肮脏的方法是破解另一个将消耗服务的Spring Dynamic Module，将其注入到测试类中，然后仅记录输出。这是确保服务正常工作的好方法，但是显然，它没有断言任何内容并且不能在测试框架中运行。<p></p><p>因此，我们已经构建了一个Spring Dynamic Module，因此对于这个新的TestConsumer模块，我仅着重介绍它们之间的区别。该模块将需要导入com.google.gwt.sample.stockwatcher.client.api捆绑包（或软件包），并且它将需要一些Java代码来调用服务客户端。您将需要在<tt>/ META-INF / spring</tt>文件夹中的2个spring配置文件：</p><p>一个用于测试bean（例如<tt>testConsumer-config.xml</tt> ）<br></p><pre class="xml"> &lt;bean id=&ldquo;consumer&rdquo; class=&ldquo;com.ben.consumer.Consumer&rdquo;&gt;<br /> &lt;constructor-arg ref=&ldquo;priceService&rdquo;/&gt;<br /> &lt;/bean&gt;</pre><br>一个用于<tt><osgi:reference>< /tt="">使用服务（例如<tt>osgi-config.xml</tt> ）<br><pre class="xml"> &lt;osgi:reference id=&ldquo;priceService&rdquo;<br /> interface=&ldquo;com.google.gwt.sample.stockwatcher.client.api.StockPriceService&rdquo;/&gt;</pre><br>在Java代码中，只需使用一些任意字符串调用<tt>service.getPrices（new String {“ foo”，“ bar”}）</tt> ，就应该返回一个<tt>StockPrice</tt>对象数组。如果要将输出记录到<tt>System.err</tt> ， <tt><dm server="" install="" directory="">它将</dm></tt>显示在dm Server的跟踪目录中： <tt><dm server="" install="" directory="">/ servicability / trace / <name of="" your="" test="" bundle="">/trace.log</name></dm></tt> 。<p></p><p>要在STS中运行快速而肮脏的测试，您需要启动dm Server。然后，将整个StockWatcherServiceAPI项目拖放到服务器上。成功部署项目后，您应该会收到类似以下的控制台消息： <tt>'com.google.gwt.sample.stockwatcher.client.api'版本'1'的部署完成</tt> 。接下来，将整个StockPriceServiceLondon项目拖放到服务器上，并等待部署消息。如果所有步骤均成功初始化，则将测试项目拖放到服务器上。</p><p><a href="http://blog.springsource.com/wp-content/uploads/2008/12/picture-1e.png"><img class="alignnone size-full wp-image-809" title="将测试包部署到服务器" src="http://blog.springsource.com/wp-content/uploads/2008/12/picture-1e.png" alt=""></a></p><p>如果您想让服务器每次都开始清理（擦除旧的跟踪输出等），则在启动配置中添加<tt>-Dcom.springsource.server.clean = true</tt> VM参数，您可以通过双击该参数来找到它。服务器实例，选择“打开启动配置”，然后单击“参数”选项卡。</p><p>如果这不起作用并且您不确定原因，则可以<a href="http://blog.springsource.com/wp-content/uploads/2008/12/stockwatcherwarssproj.zip">在此处</a>下载我的整个Eclipse工作区。<br></p><h3>自动化的JUnit OSGi捆绑包测试：</h3><br>你可以阅读的参考指南中的Spring动态模块的自动化集成测试的支持， <a href="http://static.springframework.org/osgi/docs/1.1.2/reference/html/testing.html" target="_blank">在这里</a> 。<tt>AbstractConfigurableBundleCreator</tt>测试类将启动OSGi框架，加载所有必需的测试包，然后将您的测试代码构建为即时打包并对其进行测试。如果您认为这听起来很复杂，那将是对的。亲爱的读者，不想让您感到陌生，我还是亲自尝试了一下，我必须说实话，将其设置为使所有必需的依赖项正常工作有点麻烦。因此，这是我逐步启动并逐步运行的指南。<p></p><p>因此，该测试希望可以从本地Maven存储库中获取所有依赖项。您可以将测试配置为使用其他类型的依赖性管理，但是为了简单起见（嘿！）我正在使用Maven。首先，我通过添加<tt><a href="http://m2eclipse.sonatype.org/update/">http://m2eclipse.sonatype.org/update/</a></tt>作为更新站点来安装m2eclipse（帮助->软件更新->可用站点->添加站点）。建议取消选择可选的Maven POM编辑器，否则您将收到一堆不满意的依赖项警告，并且该警告将无法安装。</p><p>创建一个名为StockWatcherServiceTest的新Java项目（以<tt>src / main / java</tt>作为源文件夹）。右键单击项目，然后选择Maven->启用依赖关系管理以使项目Mavenize。接下来，创建一个新的包（在我的情况<tt>com.ben），</tt>并从 Spring DM参考指南<tt>SimpleOSGiTest</tt>代码复制到测试类在包（注意，测试框架不会允许您使用默认的包）。该测试类将帮助我们进行完整性检查，以确保所有依赖项均已正确设置。</p><p>您会注意到该测试尚未编译，因为我们还没有所需的依赖项。您需要在<tt>pom.xml</tt>文件中指定正确的依赖关系。为了节省拳头和亵渎神灵的时间，您可以<a href="http://blog.springsource.com/wp-content/uploads/2008/12/pomxml.zip">在此处</a>查看我的<tt>pom.xml</tt>文件（包含在完整的工作区中， <a href="http://blog.springsource.com/wp-content/uploads/2008/12/stockwatcherwarssproj.zip">在此处</a>下载）。一旦依赖项正常工作，看看是否可以在示例代码中发现错字，添加Java导入，现在应该有一个可以编译的测试类。</p><p>尝试通过右键单击->运行方式-> JUnit测试来运行测试。如果收到<tt>ClassNotFoundException</tt> ，那是因为测试在错误的位置查找<tt>.class</tt>文件。解决此问题的最简单方法是覆盖<tt>getRootPath（）</tt>并返回<tt>“ file：./ target / classes”</tt>或生成您的.class文件的任何路径。</p><p>希望您现在应该有一个绿色的条，它至少证明该测试用例启动了Equinox框架，并且能够成功创建动态捆绑包。现在，我们可以为StockWatcherServiceLondon捆绑包创建适当的单元测试。</p><p>下一步是使测试依赖项捆绑包正确加载和解决。为此，需要将必需的捆绑软件安装在本地maven存储库中，并在<tt>测试用例的getTestBundlesNames（）</tt>中指定。</p><p>让我们首先处理Maven：先前创建的<tt>pom.xml</tt>文件应该已经下载了外部依赖项，但是我们需要将com..client.api，com..service.london和com.google.gwt捆绑包添加到maven中。手动存储库。我通过修饰项目并为每个项目创建一个<tt>pom.xml</tt>文件来对工作区中的捆绑包执行此操作。这里有一些陷阱。首先，要使Maven提取<tt>MANIFEST.MF</tt>文件，必须在<tt>pom.xml中</tt>配置<tt>maven-jar-plugin</tt>并将其指向文件的位置。<a href="http://blog.springsource.com/wp-content/uploads/2008/12/pomxml1.zip">在这里</a>查看我的<tt>pom.xml</tt> 。其次，我发现Spring dm Server专有的<tt>Import-Bundle</tt>清单条目不起作用，因此我不得不更改两个项目以改为使用多个<tt>Import-Package</tt>条目。进行这些更改后，打开命令提示符，更改为项目目录，然后键入<tt>mvn install</tt> 。这将构建插件并将其安装到本地Maven存储库中。要安装我们在<a href="http://blog.springsource.com/2008/11/24/deploying-gwt-applications-in-springsource-dm-server-part-2/" target="_blank">第2部分中</a>构建的gwt插件，我使用了以下命令行： <tt>mvn install：install-file -DgroupId = com.google.gwt -DartifactId = com.google.gwt -Dversion = 1.5.3 -Dpackaging = maven -plugin -Dfile = <location of="" jar="" file=""></location></tt> 。在这一点上，值得检查的是，通过解压存储库中的jar并检查清单是否合理，可以正确构建插件。</p><p>一旦所有测试包都构建并安装到存储库中，就需要在测试用例中的<tt>getTestBundlesNames（）</tt>方法中指定它们。语法在<a href="http://static.springframework.org/osgi/docs/1.1.2/reference/html/testing.html" target="_blank">参考文档</a>中进行了描述，我指定了4个捆绑包：com..client.api，com..service.london，com.google.gwt和javax.servlet。</p><p>希望在这一点上，您可以在没有任何实际断言的情况下运行测试，但是您应该可以成功地安装并启动所有测试包，而不会出现任何问题。如果不起作用，一个有用的调试工具是启用Equinox telnet控制台，并使用该控制台检查预期的导入和导出是否都正确。如果您收到<tt>ClassNotFoundException</tt> ，则可能不是。启用控制台的方法是重写<tt>createPlatform（）</tt>并调用<tt>System.setProperty（“ osgi.console”，“ 9000”）</tt> 。</p><p>一旦所有捆绑包都已解析并正确启动，您终于可以编写一些断言了！我们需要使用com..service.london捆绑包导出的服务。将<tt><osgi:reference>< /tt="">上面的快速且肮脏的示例中的<tt><osgi:reference>< /tt="">行复制<tt><osgi:reference>< /tt="">到<tt>osgi-config.xml</tt>文件中，然后将其添加到测试用例的<tt>getConfigLocations（）</tt>方法中，该方法将返回配置文件的String数组。在这种情况下，我们将使其成为普通的OSGi捆绑包，而不是Spring Dynamic Module，因此无需将该文件放在<tt>/ spring</tt>文件夹中。</osgi:reference><></tt></osgi:reference></tt></osgi:reference></tt></p><p><tt>在集成测试中，Spring会将所有由Spring管理的bean自动装配到有合适的setter的测试用例中，因此添加<tt>setStockPriceService（StockPriceService s）</tt>方法会将OSGi服务注入到测试类中。一旦有了对服务的引用，就可以开始对它进行声明……最后！</tt></p><p><tt>现在，我意识到这是对最终的简单概念的非常冗长的描述。坦白说，了解配置的最佳方法是在<a href="http://blog.springsource.com/wp-content/uploads/2008/12/stockwatcherwarssproj.zip">此处</a>查看我的Eclipse工作区。我已经对其进行了详细描述，因为看到一个可行的示例是一回事，而了解到达目标的过程和陷阱则是另一回事。但是，一旦设置，这是一种以自动化方式集成测试捆绑服务的强大方法。<br></tt></p><h2><tt>步骤4：使用共享服务</tt></h2><tt><br>在步骤2中，我们创建了一个API捆绑包和一个共享服务捆绑包。现在，我们需要在编译时和运行时重构其他项目以使用这些捆绑软件。在第2步结束时，您将打破StockWatcherWar和StockWatcher项目中的某些依赖项。让我们先解决这些问题。<p></p><p>从StockWatcher开始，它已损坏，因为我们从其依赖的WAR项目中删除了API。更改其构建时依赖性，以使其引用StockWatcherServiceAPI项目（右键单击->构建路径->配置构建路径->项目）。该项目没有运行时依赖关系，因此这是所有需要完成的工作。</p><p>StockWatcherWar现在将需要进行一些修改以使用我们在步骤2中创建的OSGi服务。当前，它仍然包含我们在第2步中复制到服务捆绑包的服务代码，因此要做的一项工作是删除该代码，然后将其替换为委派给OSGi服务的调用。但是，这意味着我们将需要以某种方式将对服务包的引用传递给类……这也意味着我们实际上需要从某个地方获取它的实例。让我们进一步解构。</p><p>好的，所以我们已经知道如何获得对服务的引用，因为我们在上面的测试方法中进行了引用：创建spring配置文件并添加<tt><osgi:reference>< /tt="">标签。因此，让我们从此开始。在<tt>/ META-INF中</tt>创建一个新的Spring Bean定义（右键单击-> New-> Spring Bean定义），然后根据需要进行调用（例如<tt>osgi-config.xml</tt> ），并确保选中osgi名称空间复选框以获取架构包括在内。添加<tt><osgi:reference>< /tt="">第3步中的<tt><osgi:reference>< /tt="">示例代码，您现在有了一个Spring配置文件来使用OSGi服务。该配置文件是否应该进入<tt>/ spring</tt>子目录以使其成为Spring动态模块？正确答案为否。我们需要使用它来引导<tt>web.xml中</tt>定义的ApplicationContext的特定<tt>样式</tt> ，因此我们不需要为我们自动创建另一种样式。</osgi:reference><></tt></osgi:reference><></tt></osgi:reference></tt></p><p>在我们讨论主题时，编辑web.xml并添加以下行：<br></p><pre class="xml"> &lt;context-param&gt;<br /> &lt;param-name&gt;contextClass&lt;/param-name&gt;<br /> &lt;param-value&gt;com.springsource.server.web.dm.ServerOsgiBundleXmlWebApplicationContext&lt;/param-value&gt;<br /> &lt;/context-param&gt;</p>
<pre><code class="prettyprint">&amp;lt;context-param&amp;gt;
    &amp;lt;param-name&amp;gt;contextConfigLocation&amp;lt;/param-name&amp;gt;
    &amp;lt;param-value&amp;gt;/META-INF/*.xml&amp;lt;/param-value&amp;gt;
&amp;lt;/context-param&amp;gt;&lt;/pre&gt;
</code></pre>
</code></pre><p>This will bootstrap a dm Server ApplicationContext and use all of the xml files in /META-INF to configure it.</p><p>Next, we need to work out how to pass this Spring-managed service instance to the <tt>StockPriceServiceImpl</tt> class, in other words, a way of bridging the Spring and servlet worlds. One way to do this is to look up the <tt>ApplicationContext</tt> in the <tt>ServletContext</tt> and call <tt>getBean()</tt> on it. This isn’t great because it requires us to hard-code a bean name into the service code and rely on dependency lookup. A cleaner mechanism is to use a Spring-managed <tt>ServletFilter</tt>, inject the service instance into it and then pass that through to the servlet using a static constant for the lookup. This is what I have implemented here:</p><p><a href="http://blog.springsource.com/wp-content/uploads/2008/12/picture-1f.png"><img class="alignnone size-full wp-image-875" title="ServletFilter" src="http://blog.springsource.com/wp-content/uploads/2008/12/picture-1f.png" alt=""></a></p><p>This class should be created in the StockWatcherWar project along with the <tt>StockPriceServiceImpl</tt> class. Also, don’t forget to delegate to the <tt>FilterChain</tt> in <tt>doFilter()</tt>.</p><p>If you’ve been following the instructions carefully, neither this class or <tt>StockPriceServiceImpl</tt> will compile at this point, due to the refactoring in Step 1. To fix this, you need to add the StockWatcherServiceAPI as a project reference to StockWatcherWar (right-click->Properties->Project References) and then add com.google.gwt.sample.stockwatcher.client.api to the <tt>Import-Bundle</tt> list. With this change, the code should now compile.</p><p>Now that we have a bridge between the servlet and the ApplicationContext, all we need to do is to create an instance of the <tt>ServletFilter</tt> and inject the service into it. Create another spring bean definition in <tt>/META-INF</tt>, call it whatever you like (eg. <tt>stockwatcher-config.xml</tt>). Copy the following configuration into it (assuming that the bean name for the OSGi service you used was <tt>priceService</tt>):<br></p><pre class="xml"> &lt;bean id=&ldquo;myFilter&rdquo; class=&ldquo;com.google.gwt.sample.stockwatcher.server.StockPriceServiceFilter&rdquo;&gt;<br /> &lt;constructor-arg ref=&ldquo;priceService&rdquo;/&gt;<br /> &lt;/bean&gt;</pre><br>Finally, we need a little magic trick called a <tt>DelegatingFilterProxy</tt>. This class delegates all incoming and out-going servlet requests to a Spring-managed <tt>ServletFilter</tt> and is defined in <tt>web.xml</tt>. Copy this code into your <tt>web.xml</tt> (it assumes that the bean name for your <tt>ServletFilter</tt> is <tt>myFilter</tt>)<br><pre class="xml"> &lt;filter&gt;<br /> &lt;filter-name&gt;myFilter&lt;/filter-name&gt;<br /> &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;<br /> &lt;init-param&gt;<br /> &lt;param-name&gt;targetFilterLifecycle&lt;/param-name&gt;<br /> &lt;param-value&gt;true&lt;/param-value&gt;<br /> &lt;/init-param&gt;<br /> &lt;/filter&gt;</p>
<pre><code class="prettyprint">&amp;lt;filter-mapping&amp;gt;
    &amp;lt;filter-name&amp;gt;myFilter&amp;lt;/filter-name&amp;gt;
    &amp;lt;servlet-name&amp;gt;StockService&amp;lt;/servlet-name&amp;gt;
&amp;lt;/filter-mapping&amp;gt;&lt;/pre&gt;
</code></pre>
</code></pre><p>The pieces of the jigsaw are finally coming together. You’ll see that in the code above we also mapped the <tt>DelegatingFilterProxy</tt> to the StockService servlet. The <tt>web.xml</tt> configuration is now complete.</p><p>All that remains now is to get hold of the service instance in the <tt>StockPriceServiceImpl</tt> code and use it!</p><p><a href="http://blog.springsource.com/wp-content/uploads/2008/12/picture-1g.png"><img class="alignnone size-full wp-image-876" title="StockPriceServiceImpl" src="http://blog.springsource.com/wp-content/uploads/2008/12/picture-1g.png" alt=""></a></p><p>Given that we seem to have thought of everything, try deploying the WAR project to dm Server, following the same instructions used for the quick and dirty test in Step 3: Drop the API project onto the Server, then the London Service project and finally the StockWatcherWar project.</p><p>You should see the following:</p><p><tt><br>[2008-12-19 17:46:23.504] onnection(4)-192.168.1.5 <SPDE0010I> Deployment of ‘com.google.gwt.sample.stockwatcher.client.api’ version ‘1’ completed.<br>[2008-12-19 17:46:44.125] onnection(4)-192.168.1.5 <SPDE0010I> Deployment of ‘StockWatcherServiceLondon’ version ‘1’ completed.<br>[2008-12-19 17:47:03.528] onnection(4)-192.168.1.5 <SPSC1000I> Creating web application ‘/StockWatcherWar’.<br>[2008-12-19 17:47:03.544] async-delivery-thread-1 <SPSC1001I> Starting web application ‘/StockWatcherWar’.<br>[2008-12-19 17:47:03.676] async-delivery-thread-1 <SPSC1005E> Failed to start web application ‘/StockWatcherWar’: consult the Server trace.log for further details.<br>[2008-12-19 17:47:03.680] async-delivery-thread-1 <SPSC1002I> Removing web application ‘/StockWatcherWar’.<br>[2008-12-19 17:47:03.752] onnection(4)-192.168.1.5 <SPDE0011E> Deployment of ‘com.google.sample.stockwatcher’ version ‘1’ failed.<br></tt></p><p>Deployment failed? After all that? Gadzooks! What’s wrong here?</p><p>Have a look at the trace file in <tt><dm Server installation>/serviceability/trace/com.google.sample.stockwatcher-1/trace.log</tt>. You should see a <tt>ClassNotFoundException: org.springframework.web.context.ContextLoaderListener</tt>. The problem is that, now that we’re in the world of explicit imports and exports, we need to explicitly import the bundles that give us the Spring support in the WAR file, so add the following bundles to the <tt>Import-Bundle</tt> entry: org.springframework.context, org.springframework.core, org.springframework.beans and org.springframework.web. It should now look like this:</p><p><a href="http://blog.springsource.com/wp-content/uploads/2008/12/picture-1h.png"><img class="alignnone size-full wp-image-877" title="Final WAR MODULE.MF" src="http://blog.springsource.com/wp-content/uploads/2008/12/picture-1h.png" alt=""></a></p><p>Now try to deploy it again. This time, I promise, it <em>should</em> work. Don’t move onto Step 5 until it does.<br></p><h2>Step 5: Celebrate</h2><br>Raid the mini-bar, make a cup of tea, do a little dance or punch the air, whatever is appropriate for your culture and budget.<br><h2>Step 6: Hot-swap different services</h2><br>Now it’s time to show off one of dm Server’s party pieces.<p></p><p>First, let’s create another stock market service we can swap in. This is not much more than a copy/paste job. Right-click on the StockWatcherServiceLondon project, select Copy and then Paste. Name the copied project StockWatcherServiceNewYork. The things to edit are as follows:<br></p><p style="padding-left: 30px;">- <tt>MANIFEST.MF</tt> - update the bundle name and symbolic name from London to NewYork.<br>- <tt>serviceLondon-config.xml</tt> - rename, but no need to change any of the contents<br>- <tt>StockPriceServiceImpl.java</tt> - change the prices considerably so that it’s obvious we’re using a different stock market. I just added 500 to each price. Go Dow Jones!</p><p>Now for the fun part. Start up the StockWatcherWar with the London stock service as before and add a few stocks so that you can see it working:</p><p><a href="http://blog.springsource.com/wp-content/uploads/2008/12/picture-1i.png"><img class="alignnone size-full wp-image-879" title="Working with London" src="http://blog.springsource.com/wp-content/uploads/2008/12/picture-1i.png" alt=""></a></p><p>Then right-click on the StockWatcherServiceLondon entry in the Servers view and select Remove. This will undeploy the StockWatcherServiceLondon bundle from the server. You’ll now see the application pause. The call to the remote service will block until dm Server has polled for a replacement service. So let’s give it one. Take the StockPriceServiceNewYork project and drop it onto the server. Wait a couple of seconds and… hey presto… the application is now using the New York service (note the significant increase in prices).</p><p><a href="http://blog.springsource.com/wp-content/uploads/2008/12/picture-1j.png"><img class="alignnone size-full wp-image-880" title="Running with NewYork service" src="http://blog.springsource.com/wp-content/uploads/2008/12/picture-1j.png" alt=""></a><br></p><h2>Step 7: Deploy outside of STS</h2><br>Deploying the application outside of STS is a simple matter of exporting the bundles. The technique differs depending on whether or not you are using Maven and whether Maven is automatically doing the job for you. Using Export->Jar File on a Maven project will fail unless you only export the <tt>/src</tt> directory. You’ll also need to select “Use existing manifest from workspace” regardless of whether you are using Maven or not.<p></p><p>Once the bundles are exported, there are a couple of ways of packaging them and then a couple of ways to deploy them.</p><p>In terms of packaging, you can leave them as individual bundles, or you can combine them all into a single PAR file. A PAR file looks like a bundle which contains bundles and is described <a href="http://static.springsource.com/projects/dm-server/1.0.x/programmer-guide/htmlsingle/programmer-guide.html#architecture-pars" target="_blank">here</a>. The significant benefit of using a PAR file is that runs its bundles in a “scope”, so it is completely isolated from other bundles running in other applications. However, if you deploy the application as a PAR, you can’t then hot-swap individual bundles within it.</p><p>Once you’ve decided on the deployment mode, you can either upload the file(s) using the admin console or you can copy them into the <tt><dm Server installation>/pickup</tt> directory. The first time you do this, the server needs to be already running and you should copy the bundles into the directory in the correct order. dm Server remembers the order for the next time you start the server. The advantage of using this mechanism is that you can hot-deploy or undeploy individual bundles simply by moving them in and out of this directory.<br></p><h2>Download Summary</h2><br>I realise I’ve been scattering the downloads throughout the blog, so I thought I’d summarise them here. Also, apologies for zipping up small files, but the blogging tool won’t allow me to upload raw XML or Java files for security reasons. Have fun!<p></p>

 <ul>
  
  <li><p>Entire Part 3 workspace projects, including both types of test mechanism are <a href="http://blog.springsource.com/wp-content/uploads/2008/12/stockwatcherwarssproj.zip">here</a>.</p></li>
  
  <li><p>The exported bundles can be downloaded <a href="http://blog.springsource.com/wp-content/uploads/2008/12/bundles.zip">here</a>.</p></li>
  
  <li><p>A PAR file of the project (with London market) can be downloaded <a href="http://blog.springsource.com/wp-content/uploads/2008/12/comgooglegwtsamplestockwatcher-100par.zip">here</a>.</p></li>

 </ul></pre></pre></tt></osgi:reference><></tt></div>
    </div>
    <section id="disqus_thread"></section>
    <script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 192;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
    <noscript>请启用JavaScript以查看<a href="http://disqus.com/?ref_noscript">由Disqus提供</a>的<a href="http://disqus.com/?ref_noscript">评论。</a></noscript>
    <a class="dsq-brlink" href="https://disqus.com">由<span class="logo-disqus">Disqus</span>提供动力的评论</a>
    <div class="mobile-only">
      <p><a href="/blog">
        <i class="icon-chevron-left"></i>背部</a></p>
    </div>
  </article>
        <aside class="span4 mobile-right-pane" id="sidebar">
          <div>
    <ul class="right-pane-widget--container secondary-nav with-icon">
      <li class="blog-category">
        <div class="icon blog-icon all-posts"></div>
        <a href="/blog">所有帖子</a> <a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
      </li>
      <li class="blog-category active">
        <div class="icon blog-icon engineering"></div>
        <a href="/blog/category/engineering">工程</a> <a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
      </li>
      <li class="blog-category">
        <div class="icon blog-icon releases"></div>
        <a href="/blog/category/releases">发布</a> <a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
      </li>
      <li class="blog-category">
        <div class="icon blog-icon news-and-events"></div>
        <a href="/blog/category/news">新闻与活动</a> <a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
      </li>
    </ul>
    <ul class="social-btn--container">
      <a class="social-btn twitter" href="https://twitter.com/springcentral"></a>
      
      <a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
      <a class="social-btn youtube" href="/videos"></a>
    </ul>
    <div id="blog-sidebar-newsletter">
      <p>将The Spring Team的更新发送到您的收件箱</p>
      <script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
      <form id="mktoForm_4723"></form>
      <script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
    </div>
  </div>
        </aside>
      </div>
    </div>
  </div>

    <footer class="footer">
      <div class="container-fluid">
        <div class="row-fluid">
          <div class="span12">
            <div class="navbar">
              <div class="container">
                <ul class="nav">
                  <li><a href="/team">Team</a></li>
                  <li><a href="/tools">工具类</a></li>
                  <li><a href="https://store.pivotal.io/">商店</a></li>
                  <li><a href="/blog">通讯</a></li>
                </ul>
              </div>
            </div>© <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a> ，Inc.保留所有权利。
            <a href="https://pivotal.io/terms-of-use">使用条款</a> • <a href="https://pivotal.io/privacy-policy">隐私</a> • <a href="/trademarks">商标准则</a> 
            <div id="teconsent" style="display:inline-block"></div> 
            
          </div>
        </div>
      </div>
    </footer>
    <div id="scrim"></div>
  </div>


</body></html>