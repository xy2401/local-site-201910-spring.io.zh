<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Before a JDBC operation, flush the Hibernate Session (includes TSE example code)</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Before a JDBC operation, flush the Hibernate Session (includes TSE example code)" />
<meta name="twitter:description" content="&lt;p&gt;Mixing code in one and the same transaction that uses an Object-Relational Mapper with code that doesn’t, can cause issues with data not being available in the underlying database when it should be. Since this is a situation I come across once every now and then, I figured it would be helpful for all if I write down my solution to this problem.&lt;/p&gt;
&lt;p&gt;In short: what I will present in the remainder of this post is an aspect that triggers the underlying persistence mechanism (JPA, Hibernate, TopLink) to send any dirty data to the database.&lt;/p&gt;
" />

<meta property="og:title" content="Before a JDBC operation, flush the Hibernate Session (includes TSE example code)" />
<meta property="og:description" content="&lt;p&gt;Mixing code in one and the same transaction that uses an Object-Relational Mapper with code that doesn’t, can cause issues with data not being available in the underlying database when it should be. Since this is a situation I come across once every now and then, I figured it would be helpful for all if I write down my solution to this problem.&lt;/p&gt;
&lt;p&gt;In short: what I will present in the remainder of this post is an aspect that triggers the underlying persistence mechanism (JPA, Hibernate, TopLink) to send any dirty data to the database.&lt;/p&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2008-01-04 11:17:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Before a JDBC operation, flush the Hibernate Session (includes TSE example code)</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="null?s=20&amp;d=mm" />
<span class="author">Alef Arendsen</span>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2008-01-04 11:17:00.0">January 04, 2008</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="124" href="/blog/2008/01/04/before-a-jdbc-operation-flush-the-hibernate-session-includes-tse-example-code#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><p>Mixing code in one and the same transaction that uses an Object-Relational Mapper with code that doesn&rsquo;t, can cause issues with data not being available in the underlying database when it should be. Since this is a situation I come across once every now and then, I figured it would be helpful for all if I write down my solution to this problem.</p><p>In short: what I will present in the remainder of this post is an aspect that triggers the underlying persistence mechanism (JPA, Hibernate, TopLink) to send any dirty data to the database.</p><p>I presented this aspect by the way during one of my sessions at <a href="http://www.thespringexperience.com">The Spring Experience</a> last December and this post also has the source code for those of you who were waiting for it.</p>
<h3>The need for mixing usage of ORM engines with straight JDBC</h3><p>In many enterprise applications, an Object-Relational Mapping engine is used to manage the storage and retrieval of (sometimes complex) domain models. I don&rsquo;t think I have to argue that in situations where a heavily interlinked domain model needs to be persisted an ORM tool might increase productivity not to speak of efficiency over straight JDBC.</p><p>This does not mean however that writing explicit SQL in an application can be completely disposed of. In many situations, one still needs to write the occasional SQL query to satisfy a certain requirement in an application. I usually see several reasons why people still write SQL queries by hand and execute them in Java code such as:</p>
<ul>
<li>Testing code: code that uses an ORM tool still needs to be tested. To be absolutely certain that a piece of data access code (using an ORM tool) is correctly inserting records in the database, one need to verify the database itself... using straight SQL queries. I consider it a very good practice to for example first insert an object using an ORM tool to then verify the number of rows has increased</li>
<li>Stored procedures: it's best to call stored procedures with a JDBC call instead of via clunky APIs. I really don't want to get into the <a href="http://discuss.joelonsoftware.com/default.asp?joel.3.187483.43">debate</a> <a href="http://www.codinghorror.com/blog/archives/000117.html">whether</a> or not <a href="http://andrewsquire.spaces.live.com/blog/cns!C6B693813503C90D!144.entry">stored</a> <a href="http://discuss.joelonsoftware.com/default.asp?joel.3.186548.7">procedures</a> are good. If you're into that, just read some of these posts. Story is: I come across projects frequently that use stored procs and want to mix code that does so with code that uses an ORM engine. For example to first insert several new objects, after which an aggregation needs to be performed over the newly inserted records and the records already available.</li>
<li>Operations that involves a very large amount of similar objects. This could be the case when for example you need to set the canceled flag of a million orders from <i>true</i> to <i>false</i>. I personally might not want to use an ORM engine for this (sometimes even if the ORM engine has a clean DML to handle the dirty work for me).</li>
</ul>
<h3>Issue with mixing ORM operations with straight SQL</h3><p>There is one big issue with mixing operations executed by an ORM engine with operations using straight SQL in your application. To understand this, first have a look at the following piece of pseudo code (considering the database is empty):</p>
<pre><code class="prettyprint code">start transaction

create part with name Bolt
associate with ORM engine (i.e. save using entity manager)

update part set stock = 15 where name=&#39;Bolt&#39;

end transaction
</code></pre><p>The update statement here will fail, although we <i>did</i> associate the part with the entity manager (in other words: asked the entity manager to persist it for us). The entity manager will however not have inserted the record in the database right as a result of you associating it with the entity manager. This is called write-behind&ndash;something virtually all ORM engines implement. Dirty state in the entity manager (such as our newly created part instance) will not be sent to the database (using SQL statements) immediately, but (usually) only when the transaction ends.</p><p>As you might have figured out by now as a general rule, this concept of write-behind can cause serious issues when at certain points in time, you expect data to be available in the database when it&rsquo;s not (yet)!</p>
<h3>Solving the problem the right way</h3><p>There are several solutions to this problem. One (very ignorant) solution would be to simply say: let&rsquo;s change the pseudo code a bit to include two transactions:</p>
<pre><code class="prettyprint code">start transaction
create part with name Bolt
associate with ORM engine (i.e. save using entity manager)
end transaction

start transaction
update part set stock = 15 where name=&#39;Bolt&#39;
end transaction
</code></pre><p>For obvious reasons, this is not the right solution. Solving the problem this way would result in two separate transactions. If the idea was for these two actions to be executed in one atomic operation, this is not the case anymore.</p><p>The right solution here would be to have the ORM engine <i>save its changes to the database before the SQL query executes</i>. Fortunately both <a href="http://java.sun.com/javaee/5/docs/api/javax/persistence/EntityManager.html#flush()">JPA</a> as well as <a href="http://www.hibernate.org/hib_docs/v3/api/org/hibernate/Session.html#flush()">Hibernate</a> for example offer ways to do this. Forcing an ORM engine to save its changes to the database is called <b>flushing</b>. With this in mind, we can modify the pseudo code to make it work:</p>
<pre><code class="prettyprint code">start transaction

create part with name Bolt
associate with ORM engine (i.e. save using entity manager)

*** flush

update part set stock = 15 where name=&#39;Bolt&#39;

end transaction
</code></pre>
<h3>Solving the problem in the right place</h3><p>Now that we have solved the problem, let&rsquo;s put this code into context. I&rsquo;ve previously used the <a href="http://blog.interface21.com/main/2007/03/12/carplant-not-accepting-null-carmodels/">CarPlant example</a> to illustrate certain things and I will do this again now. The following sequence diagram shows the CarPartsInventory first inserting a part using the Hibernate Session, after which it is updating the stock using a Spring JdbcTemplate (using a straight JDBC connection underneath). All this runs inside one transaction.</p><p><img id="image251" src="http://blog.springsource.com/main/wp-content/uploads/2008/01/hib-flush1.png" alt="hib-flush1.png" /></p><p>If we translate the pseudo code directly to Java code, we have to add the flush() call and that&rsquo;s where a tough question comes up: where do we put the flush() call: do we make it part of the addPart() call (right after we&rsquo;ve associated the part with the Session) or do we make it part of the updateStock() call (before the UPDATE statement is issued).</p><p>Whatever way you look at it, both are evil:</p>
<ul>
<li>Making it part of the addPart() call essentially defeats the whole concept of write-behind. Write after inserting a part, we immediately force Hibernate to flush the session, therefore it is not capable of optimizing anymore in case multiple parts need to be inserted in the same transaction</li>
<li>Making it part of the updateStock() call is better when looking at the previous argument, but what if there is an additional SQL statement that needs to be executed, do we need to add the flush() call there as well?</li>
</ul><p><img id="image252" src="http://blog.springsource.com/main/wp-content/uploads/2008/01/hib-flush2.png" alt="hib-flush2.png" /></p><p>Concluding we have three requirements (adding the part, updating it and flushing the session) and only two places we can add code to to get solve the requirement. This is where where aspect-orientation comes in. Aspect-oriented programming techniques essentially give up an additional place we can add code to to solve this requirement. In other words, it allows us to solve each requirement in its own separate module.</p>
<h3>Implementing the three requirements in three different modules</h3><p>Let&rsquo;s tackle each requirement in a separate module. Fortunately, the first two requirements are pretty straightforward:</p><p><b>Inserting a new part</b></p>
<pre><code class="prettyprint java"><br />private SessionFactory sessionFactory;

public void insertPart(Part p) {
	sessionFactory.getCurrentSession().save(p);
}
</code></pre><p>Using the Hibernate SessionFactory, we obtain a session. The session is used to save the new part.</p><p><b>Updating the stock of a part</b></p>
<pre><code class="prettyprint java"><br />private SimpleJdbcTemplate jdbcTemplate;

public void updateStock(Part p, int stock) {
	jdbcTemplate.update(&quot;update stock set stock = stock + ? where number=?&quot;, 
		stock, p.getNumber());
}
</code></pre><p><b>Synchronizing the session</b><br />As a general rule, we can say that <i>whenever a JDBC operation is about to take place, first flush the session if it is dirty</i>. We can re-phrase this to <i>before a call to a JDBC operation, flush the Hibernate session if it&rsquo;s dirty</i>. There are two important element in this phrase. The last part specified <i>what</i> we want to do. The first part answer the question <i>where</i> and <i>when</i> we want to execute the flushing behavior.</p>
<ul>
<li><b>when</b>: before
<li><b>where</b>: a call to a JDBC operation</li>
<li><b>what</b>: flush a dirty Hibernate session</li>
</ul><p>It is easy to translate this to AspectJ if one knows the AspectJ language. Even if you do not want to use AspectJ, it is possible to get this behavior in place by using Spring AOP.</p>
<pre><code class="prettyprint java"><br />public aspect HibernateStateSynchronizer {

	private SessionFactory sessionFactory;
	
	public void setSessionFactory(SessionFactory sessionFactory() {
		this.sessionFactory = sessionFactory;
	}

	pointcut jdbcOperation() : 
		call(* org.springframework.jdbc.core.simple.SimpleJdbcTemplate.*(..));
		
	before() jdbcOperation() {
		Session session = sessionFactory.getCurrentSession();
		if (session.isDirty()) {
			session.flush();
		}
	}
}
</code></pre><p>This aspect will implement the required behavior; it will flush the Hibernate session whenever a JDBC operation is about to take place.</p>
<h3>Variations</h3><p>There are a few things to keep in mind when reviewing this aspect.</p><p>First of all, the places where you want this behavior to be applied may vary. The example above applies the behavior to all calls to methods on the SimpleJdbcTemplate. This might be too much for your taste. The pointcut can easily be modified to apply the behavior to methods annotated by a certain annotation (think: execution(@JdbcOperation *(..))).</p><p>Secondly, you might wonder what might happen if there is no Hibernate Session available. SessionFactory.getCurrentSession() always creates a new Session in a Spring-managed environment. If you want this aspect to work, even if there is no SessionFactory at all, or if no Session has been created yet (and you do not want one to be created), you should modify the aspect to use the SessionFactoryUtils class from Spring. This class has methods that allow you to ask for a Session and not get one back if none is available.</p>
<h3>Source code</h3><p>The source code accompanying this entry implements the HibernateStateSynchronizer aspect using AspectJ. It would be pretty straightforward to modify this aspect to make it work with Spring AOP however.</p><p>The HibernateCarPartsInventoryTests test case illustrates the behavior. When the aspect is enabled, the testAddPart() method succeeds. When the aspect it disabled (by excluding it from the build path for example, or by commenting the before() advice), the test will fail, because the count statement the same amount of records every time it executed (in other words, the part is not present in the database at the time the query executes).</p><p>In the current setup, the before advice is commented out, so the test will <b>fail</b>. Note that the pom.xml file for this project includes the Maven AspectJ plugin. There might be some warnings about version conflicts (caused by the plugin using a different AspectJ version than the project itself), but despite those warnings being there, it should still work.</p><p>The source code: <a id="p253" href="http://blog.springsource.com/main/wp-content/uploads/2008/01/carplant.zip">carplant.zip</a></p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 124;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>