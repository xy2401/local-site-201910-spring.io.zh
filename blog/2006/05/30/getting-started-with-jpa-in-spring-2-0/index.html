<html  data-code-prettify="" data-mobile-support="" data-search=""><head>
<title>Spring 2.0中的JPA入门</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="Getting Started With JPA in Spring 2.0">
<meta name="twitter:description" >
<meta name="twitter:creator" content="@m_f_">
<meta name="twitter:image:src" content="https://gravatar.com/avatar/443e6ec0242c3f54001dae34374780e2?s=200">

<meta property="og:title" content="Getting Started With JPA in Spring 2.0">
<meta property="og:image" content="https://gravatar.com/avatar/443e6ec0242c3f54001dae34374780e2?s=200">
<meta property="og:description" >
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2006-05-30 13:03:00.0">
</head>
<body >

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Spring 2.0中的JPA入门</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/443e6ec0242c3f54001dae34374780e2?s=20&d=mm"> <a class="author" rel="author" href="/team/mfisher">马克·费舍尔</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2006-05-30 13:03:00.0">2006年5月30日</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2006/05/30/getting-started-with-jpa-in-spring-2-0#disqus_thread" data-disqus-identifier="8">
</a></div>
</div>
</header>
<div class="blog--post"><p>该博客文章的目的是提供一个简单的逐步指南，以在<i>独立</i>于Spring框架的环境中开始使用JPA。尽管JPA规范最初是<i>EJB 3.0</i>的持久性机制，但幸运的是，任何这样的机制实际上都应该能够持久化简单的POJO。因此，在您的类路径中有几个JAR和一些Spring配置的Bean之后，您就可以开始在您喜欢的IDE中尝试JPA代码了。我将使用Glassfish JPA-这是参考实现，它基于Oracle的TopLink ORM框架。</p>
<h2>初始设置</h2><p>确保您使用的是Java 5（JPA和EJB 3.0的先决条件）。</p><p>从以下位置下载玻璃鱼JPA罐： <a href="https://glassfish.dev.java.net/downloads/persistence/JavaPersistence.html"></a> <a href="https://glassfish.dev.java.net/downloads/persistence/JavaPersistence.html">https://glassfish.dev.java.net/downloads/persistence/JavaPersistence.html</a><br>（注意：我使用的是“ V2_build_02” jar，但任何更高版本也应适用。）</p><p>要从“安装程序”罐中解开罐，请运行：<br><tt>java -jar glassfish-persistence-installer-v2-b02.jar</tt><br>（这是接受许可协议所必需的）</p><p>将<tt>toplink-essentials.jar</tt>添加到您的类路径中</p><p>添加包含您的数据库驱动程序的JAR（在示例中，我使用的是hsqldb.jar版本1.8.0.1，但仅需进行少量更改即可适应另一个数据库）。</p><p>使用2.0 M5版本添加以下Spring JAR（在此处提供： <a href="https://sourceforge.net/project/showfiles.php?group_id=73357"></a> <a href="https://sourceforge.net/project/showfiles.php?group_id=73357">http://sourceforge.net/project/showfiles.php?group_id=73357</a> ）。<br></p><ul><br> <li>spring.jar<br> </li><li>spring-jpa.jar<br> </li><li>spring-mock.jar<br></li></ul><p></p><p>最后，将这些罐子也添加到您的类路径中：<br></p><ul><br> <li>commons-logging.jar<br> </li><li>log4j.jar<br> </li><li>junit.jar<br></li></ul><p></p>
<h2>代码-域模型</h2><p>此示例将基于仅3个类的有目的的简单域模型。注意注释的使用。使用JPA，可以选择使用批注或XML文件来指定对象关系映射元数据-甚至是两种方法的组合。在这里，我选择仅使用批注-对于这些批注，将在域模型代码清单之后立即提供简短说明。</p><p>一， <tt>餐厅</tt>类：</p>
<pre><code class="prettyprint java"><br />package blog.jpa.domain;

import java.util.Set;
import javax.persistence.CascadeType;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.JoinColumn;
import javax.persistence.JoinTable;
import javax.persistence.ManyToMany;
import javax.persistence.OneToOne;

@Entity
public class Restaurant {

  @Id
  @GeneratedValue(strategy = GenerationType.AUTO)
  private long id;

  private String name;

  @OneToOne(cascade = CascadeType.ALL)
  private Address address;

  @ManyToMany
  @JoinTable(inverseJoinColumns = @JoinColumn(name = &quot;ENTREE_ID&quot;))
  private Set&lt;Entree&gt; entrees;

  public long getId() {
    return id;
  }

  public void setId(long id) {
    this.id = id;
  }

  public String getName() {
    return name;
  }

  public void setName(String name) {
    this.name = name;
  }

  public Address getAddress() {
    return address;
  }

  public void setAddress(Address address) {
    this.address = address;
  }

  public Set&lt;Entree&gt; getEntrees() {
    return entrees;
  }

  public void setEntrees(Set&lt;Entree&gt; entrees) {
    this.entrees = entrees;
  }

}
</code></pre><p>二， <tt>Address</tt>类：</p>
<pre><code class="prettyprint java"><br />package blog.jpa.domain;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;

@Entity
public class Address {

  @Id
  @GeneratedValue(strategy = GenerationType.AUTO)
  private long id;

  @Column(name = &quot;STREET_NUMBER&quot;)
  private int streetNumber;

  @Column(name = &quot;STREET_NAME&quot;)
  private String streetName;

  public long getId() {
    return id;
  }

  public void setId(long id) {
    this.id = id;
  }

  public int getStreetNumber() {
    return streetNumber;
  }

  public void setStreetNumber(int streetNumber) {
    this.streetNumber = streetNumber;
  }

  public String getStreetName() {
    return streetName;
  }

  public void setStreetName(String streetName) {
    this.streetName = streetName;
  }

}
</code></pre><p>三， <tt>主菜</tt>类：</p>
<pre><code class="prettyprint java"><br />package blog.jpa.domain;

import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;

@Entity
public class Entree {

  @Id
  @GeneratedValue(strategy = GenerationType.AUTO)
  private long id;

  private String name;

  private boolean vegetarian;

  public long getId() {
    return id;
  }

  public void setId(long id) {
    this.id = id;
  }

  public String getName() {
    return name;
  }

  public void setName(String name) {
    this.name = name;
  }

  public boolean isVegetarian() {
    return vegetarian;
  }

  public void setVegetarian(boolean vegetarian) {
    this.vegetarian = vegetarian;
  }

}
</code></pre><p>如您所见，并非每个持久字段都已注释。JPA使用默认值（例如使用与属性名完全匹配的列名），因此在许多情况下，您无需显式指定元数据。但是，您仍然可以选择这样做，以提供更全面的自文档代码。请注意，在<tt>Entree</tt>类中，我没有为String属性“ name”或布尔属性“ vegetarian”使用注释。但是，在<tt>Address</tt>类中，我使用的是注释，因为我想为数据库中的列使用非默认名称（例如，我选择了“ STREET_NAME”，而默认名称是“ STREETNAME”）。</p><p>当然，任何ORM机制的最重要特征之一就是指定对象之间关系到其数据库副本的映射的方式。在<tt>Restaurant</tt>类中，有一个<tt>@OneToOne</tt>批注描述与<tt>地址</tt>的关系，而有<tt>@ManyToMany</tt>批注描述与<tt>Entree</tt>类的成员的关系。由于这些其他类的实例也由<tt>EntityManager</tt>管理，因此可以指定“级联”规则。例如，当删除<tt>餐馆</tt>时，关联的<tt>地址</tt>也将被删除。稍后，您将看到此场景的测试用例。</p><p>最后，看一下@Id注释和ID的@GeneratedValue的指定“策略”。该元数据用于描述<i>主密钥</i>生成策略，该策略进而控制数据库内的身份。</p><p>要了解有关这些和其他JPA注释的更多信息，请查看JPA规范-实际上是<a href="https://www.jcp.org/en/jsr/detail?id=220">JSR-220</a>的子集。</p>
<h2>代码-数据访问层</h2><p>为了访问域模型的实例，最好创建一个通用接口，该接口隐藏有关基础持久性机制的所有详细信息。这样，如果以后再切换到JPA以外的版本，则不会对体系结构产生影响。这也使测试服务层更加容易，因为它可以创建此数据访问接口的存根实现-甚至是动态模拟实现。</p><p>这是界面。请注意，任何JPA或Spring类都不存在依赖关系。实际上，这里不是核心Java类的唯一依赖项是我的域模型的类（在这种简单情况下，只有一个<tt>-Restaurant</tt> ）：</p>
<pre><code class="prettyprint java"><br />package blog.jpa.dao;

import java.util.List;
import blog.jpa.domain.Restaurant;

public interface RestaurantDao {

  public Restaurant findById(long id);

  public List&lt;Restaurant&gt; findByName(String name);

  public List&lt;Restaurant&gt; findByStreetName(String streetName);

  public List&lt;Restaurant&gt; findByEntreeNameLike(String entreeName);

  public List&lt;Restaurant&gt; findRestaurantsWithVegetarianEntrees();

  public void save(Restaurant restaurant);

  public Restaurant update(Restaurant restaurant);

  public void delete(Restaurant restaurant);

}
</code></pre><p>对于此接口的实现，我将扩展Spring的<tt>JpaDaoSupport</tt>类。这提供了一种检索<tt>JpaTemplate</tt>的便捷方法。如果您将Spring与JDBC或其他ORM技术一起使用，那么您可能会对这种方法非常熟悉。</p><p>应该注意的是，使用<tt>JpaDaoSupport</tt>是可选的。只需将<tt>EntityManagerFactory</tt>提供给其构造函数，就<tt>可以</tt>直接构造<tt>JpaTemplate</tt> 。实际上， <tt>JpaTemplate</tt>本身是可选的。如果您不希望将JPA异常自动转换为Spring的运行时异常层次结构，则可以完全避免<tt>使用JpaTemplate</tt> 。在那种情况下，您可能仍然对Spring的<tt>EntityManagerFactoryUtils</tt>类感兴趣，该类提供了一种方便的静态方法来获取共享的（因此是事务性的） <tt>EntityManager</tt> 。</p><p>这是实现：</p>
<pre><code class="prettyprint java"><br />package blog.jpa.dao;

import java.util.List;
import org.springframework.orm.jpa.support.JpaDaoSupport;
import blog.jpa.domain.Restaurant;

public class JpaRestaurantDao extends JpaDaoSupport implements RestaurantDao {

  public Restaurant findById(long id) {
    return getJpaTemplate().find(Restaurant.class, id);
  }

  public List&lt;Restaurant&gt; findByName(String name) {
    return getJpaTemplate().find(&quot;select r from Restaurant r where r.name = ?1&quot;, name);
  }

  public List&lt;Restaurant&gt; findByStreetName(String streetName) {
    return getJpaTemplate().find(&quot;select r from Restaurant r where r.address.streetName = ?1&quot;, streetName);
  }

  public List&lt;Restaurant&gt; findByEntreeNameLike(String entreeName) {
    return getJpaTemplate().find(&quot;select r from Restaurant r where r.entrees.name like ?1&quot;, entreeName);
  }

  public List&lt;Restaurant&gt; findRestaurantsWithVegetarianEntrees() {
    return getJpaTemplate().find(&quot;select r from Restaurant r where r.entrees.vegetarian = &#39;true&#39;&quot;);
  }

  public void save(Restaurant restaurant) {
    getJpaTemplate().persist(restaurant);
  }

  public Restaurant update(Restaurant restaurant) {
    return getJpaTemplate().merge(restaurant);
  }

  public void delete(Restaurant restaurant) {
    getJpaTemplate().remove(restaurant);
  }

}
</code></pre>
<h2>服务层</h2><p>由于此处的目的是集中于数据访问层的JPA实现，因此省略了服务层。显然，在现实情况中，服务层将在系统体系结构中发挥关键作用。这将是事务的分界点-通常，它们将在Spring配置中以声明方式分界。在下一步中，当您查看配置时，您会注意到我提供了一个“ transactionManager” bean。基础测试类使用它自动将每个测试方法包装在事务中，并且它是与将事务层包装服务层方法的“ transactionManager”相同。最重要的一点是，数据访问层中没有与事务相关的代码。使用Spring <tt>JpaTemplate</tt>可以确保在所有DAO之间共享相同的<tt>EntityManager</tt> 。因此，事务传播会自动发生-由服务层决定。换句话说，它的行为实际上与Spring框架中配置的其他持久性机制完全相同。没有针对JPA的特定内容-因此，将其排除在此针对JPA的条目之外的理由。</p>
<h2>组态</h2><p>由于我选择了基于注释的映射，因此在介绍域类时，您实际上已经看到了大多数特定于JPA的配置。如上所述，也有可能通过XML（在“ orm.xml”文件中）配置那些映射。唯一需要的其他配置是在“ META-INF / persistence.xml”中。在这种情况下，这非常简单，因为与数据库相关的属性将通过Spring配置中提供的依赖项注入“数据源”提供给<tt>EntityManagerFactory</tt> （下一个原因）。“ persistence.xml”中的唯一其他信息是使用本地还是全局（JTA）事务。以下是“ persistence.xml”文件的内容：</p>
<pre><code class="prettyprint xml"><br />&lt;persistence xmlns=&quot;http://java.sun.com/xml/ns/persistence&quot; version=&quot;1.0&quot;&gt;

  &lt;persistence-unit name=&quot;SpringJpaGettingStarted&quot; transaction-type=&quot;RESOURCE_LOCAL&quot;/&gt;

&lt;/persistence&gt;
</code></pre><p>在Spring配置中只有4个bean（好吧，还有两个内部bean）。首先，有一个“ restaurantDao”（我故意将“ jpa”保留在bean名称之外，因为取决于DAO的任何服务层bean都应只与通用接口有关）。此DAO的JPA实现唯一需要的属性是用于创建<tt>JpaTemplate</tt>的“ entityManagerFactory”。“ entityManagerFactory”取决于“ dataSource”，并且没有关于JPA的特定信息。在此配置中，您将看到一个<tt>DriverManagerDataSource</tt> ，但是在生产代码中，它将被一个连接池取代-通常是通过<tt>JndiObjectFactoryBean</tt> （或Spring 2.0的新的便捷<jndi:lookup>标签）获得的连接池<jndi:lookup>。最后一个bean是测试类所需的“ transactionManager”。这与用于服务层中划分的事务的“ transactionManager”相同。实现类是Spring的<tt>JpaTransactionManager</tt> 。对于熟悉为JDBC，Hibernate，JDO，TopLink或iBATIS配置Spring的任何人，大多数这些bean看起来都非常熟悉。唯一的例外是<tt>EntityManagerFactory</tt> 。我将简要讨论它，但是首先看一下完整的“ applicationContext.xml”文件：</jndi:lookup></jndi:lookup></p>
<pre><code class="prettyprint xml"><br />&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
  xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
  xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;

  &lt;bean id=&quot;restaurantDao&quot; class=&quot;blog.jpa.dao.JpaRestaurantDao&quot;&gt;
    &lt;property name=&quot;entityManagerFactory&quot; ref=&quot;entityManagerFactory&quot;/&gt;
  &lt;/bean&gt;

  &lt;bean id=&quot;entityManagerFactory&quot; class=&quot;org.springframework.orm.jpa.ContainerEntityManagerFactoryBean&quot;&gt;
    &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;
    &lt;property name=&quot;jpaVendorAdapter&quot;&gt;
      &lt;bean class=&quot;org.springframework.orm.jpa.vendor.TopLinkJpaVendorAdapter&quot;&gt;
        &lt;property name=&quot;showSql&quot; value=&quot;true&quot;/&gt;
        &lt;property name=&quot;generateDdl&quot; value=&quot;true&quot;/&gt;
        &lt;property name=&quot;databasePlatform&quot; value=&quot;oracle.toplink.essentials.platform.database.HSQLPlatform&quot;/&gt;
      &lt;/bean&gt;
    &lt;/property&gt;
    &lt;property name=&quot;loadTimeWeaver&quot;&gt;
      &lt;bean class=&quot;org.springframework.instrument.classloading.SimpleLoadTimeWeaver&quot;/&gt;
    &lt;/property&gt;
  &lt;/bean&gt;

  &lt;bean id=&quot;dataSource&quot; class=&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;&gt;
    &lt;property name=&quot;driverClassName&quot; value=&quot;org.hsqldb.jdbcDriver&quot;/&gt;
    &lt;property name=&quot;url&quot; value=&quot;jdbc:hsqldb:hsql://localhost/&quot;/&gt;
    &lt;property name=&quot;username&quot; value=&quot;sa&quot;/&gt;
    &lt;property name=&quot;password&quot; value=&quot;&quot;/&gt;
  &lt;/bean&gt;

  &lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.orm.jpa.JpaTransactionManager&quot;&gt;
    &lt;property name=&quot;entityManagerFactory&quot; ref=&quot;entityManagerFactory&quot;/&gt;
    &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;
  &lt;/bean&gt;

&lt;/beans&gt;
</code></pre><p>首先，您会看到“ entityManagerFactory”需要知道“ dataSource”。接下来是“ jpaVendorAdapter”，因为这里有各种JPA实现。在这种情况下，我已经将<tt>TopLinkJpaVendorAdapter</tt>配置为内部bean，它具有一些自己的属性。有一个布尔属性可指定是否应显示SQL，还有一个布尔属性可用于生成DDL。这两个参数都设置为“ true”，因此每次执行测试时都会自动生成数据库模式。这在早期开发阶段非常方便，因为它为映射，列名称等方面的实验提供了即时反馈。“ databasePlatformClass”提供了正在使用的特定数据库的必要信息。最后，“ entityManagerFactory”具有“ loadTimeWeaver”的属性，该属性在JPA持久性提供程序对类文件的转换中起着一定作用，以适应某些特性，例如延迟加载。</p>
<h2>整合测试</h2><p>学习新API的最好方法也许就是编写一堆测试用例。<tt>JpaRestaurantDaoTests</tt>类提供一些基本测试。为了了解有关JPA的更多信息，请修改代码和/或配置并观察对这些测试的影响。例如，尝试修改<i>级联</i>设置-或关联的基数。注意， <tt>JpaRestaurantDaoTests</tt>扩展了Spring的<tt>AbstractJpaTests</tt> 。您可能已经熟悉Spring的<tt>AbstractTransactionalDataSourceSpringContextTests</tt> 。此类的行为方式相同，因为默认情况下，由测试方法引起的任何数据库更改都将回滚。实际上， <tt>AbstractJpaTests的</tt>作用还不止这些，但是进入这些细节超出了本条目的范围。如果有兴趣，请查看<tt>AbstractJpaTests</tt>的源代码。</p><p>这是<tt>JpaRestaurantDaoTests</tt>代码：</p>
<pre><code class="prettyprint java"><br />package blog.jpa.dao;

import java.util.List;
import org.springframework.test.jpa.AbstractJpaTests;
import blog.jpa.dao.RestaurantDao;
import blog.jpa.domain.Restaurant;

public class JpaRestaurantDaoTests extends AbstractJpaTests {

  private RestaurantDao restaurantDao;

  public void setRestaurantDao(RestaurantDao restaurantDao) {
    this.restaurantDao = restaurantDao;
  }

  protected String[] getConfigLocations() {
    return new String[] {&quot;classpath:/blog/jpa/dao/applicationContext.xml&quot;};
  }

  protected void onSetUpInTransaction() throws Exception {
    jdbcTemplate.execute(&quot;insert into address (id, street_number, street_name) values (1, 10, &#39;Main Street&#39;)&quot;);
    jdbcTemplate.execute(&quot;insert into address (id, street_number, street_name) values (2, 20, &#39;Main Street&#39;)&quot;);
    jdbcTemplate.execute(&quot;insert into address (id, street_number, street_name) values (3, 123, &#39;Dover Street&#39;)&quot;);

    jdbcTemplate.execute(&quot;insert into restaurant (id, name, address_id) values (1, &#39;Burger Barn&#39;, 1)&quot;);
    jdbcTemplate.execute(&quot;insert into restaurant (id, name, address_id) values (2, &#39;Veggie Village&#39;, 2)&quot;);
    jdbcTemplate.execute(&quot;insert into restaurant (id, name, address_id) values (3, &#39;Dover Diner&#39;, 3)&quot;);

    jdbcTemplate.execute(&quot;insert into entree (id, name, vegetarian) values (1, &#39;Hamburger&#39;, 0)&quot;);
    jdbcTemplate.execute(&quot;insert into entree (id, name, vegetarian) values (2, &#39;Cheeseburger&#39;, 0)&quot;);
    jdbcTemplate.execute(&quot;insert into entree (id, name, vegetarian) values (3, &#39;Tofu Stir Fry&#39;, 1)&quot;);
    jdbcTemplate.execute(&quot;insert into entree (id, name, vegetarian) values (4, &#39;Vegetable Soup&#39;, 1)&quot;);

    jdbcTemplate.execute(&quot;insert into restaurant_entree (restaurant_id, entree_id) values (1, 1)&quot;);
    jdbcTemplate.execute(&quot;insert into restaurant_entree (restaurant_id, entree_id) values (1, 2)&quot;);
    jdbcTemplate.execute(&quot;insert into restaurant_entree (restaurant_id, entree_id) values (2, 3)&quot;);
    jdbcTemplate.execute(&quot;insert into restaurant_entree (restaurant_id, entree_id) values (2, 4)&quot;);
    jdbcTemplate.execute(&quot;insert into restaurant_entree (restaurant_id, entree_id) values (3, 1)&quot;);
    jdbcTemplate.execute(&quot;insert into restaurant_entree (restaurant_id, entree_id) values (3, 2)&quot;);
    jdbcTemplate.execute(&quot;insert into restaurant_entree (restaurant_id, entree_id) values (3, 4)&quot;);
  }

  public void testFindByIdWhereRestaurantExists() {
    Restaurant restaurant = restaurantDao.findById(1);
    assertNotNull(restaurant);
    assertEquals(&quot;Burger Barn&quot;, restaurant.getName());
  }

  public void testFindByIdWhereRestaurantDoesNotExist() {
    Restaurant restaurant = restaurantDao.findById(99);
    assertNull(restaurant);
  }

  public void testFindByNameWhereRestaurantExists() {
    List&lt;Restaurant&gt; restaurants = restaurantDao.findByName(&quot;Veggie Village&quot;);
    assertEquals(1, restaurants.size());
    Restaurant restaurant = restaurants.get(0);
    assertEquals(&quot;Veggie Village&quot;, restaurant.getName());
    assertEquals(&quot;Main Street&quot;, restaurant.getAddress().getStreetName());
    assertEquals(2, restaurant.getEntrees().size());
  }

  public void testFindByNameWhereRestaurantDoesNotExist() {
    List&lt;Restaurant&gt; restaurants = restaurantDao.findByName(&quot;No Such Restaurant&quot;);
    assertEquals(0, restaurants.size());
  }

  public void testFindByStreetName() {
    List&lt;Restaurant&gt; restaurants = restaurantDao.findByStreetName(&quot;Main Street&quot;);
    assertEquals(2, restaurants.size());
    Restaurant r1 = restaurantDao.findByName(&quot;Burger Barn&quot;).get(0);
    Restaurant r2 = restaurantDao.findByName(&quot;Veggie Village&quot;).get(0);
    assertTrue(restaurants.contains(r1));
    assertTrue(restaurants.contains(r2));
  }

  public void testFindByEntreeNameLike() {
    List&lt;Restaurant&gt; restaurants = restaurantDao.findByEntreeNameLike(&quot;%burger&quot;);
    assertEquals(2, restaurants.size());
  }

  public void testFindRestaurantsWithVegetarianOptions() {
    List&lt;Restaurant&gt; restaurants = restaurantDao.findRestaurantsWithVegetarianEntrees();
    assertEquals(2, restaurants.size());
  }

  public void testModifyRestaurant() {
    String oldName = &quot;Burger Barn&quot;;
    String newName = &quot;Hamburger Hut&quot;;
    Restaurant restaurant = restaurantDao.findByName(oldName).get(0);
    restaurant.setName(newName);
    restaurantDao.update(restaurant);
    List&lt;Restaurant&gt; results = restaurantDao.findByName(oldName);
    assertEquals(0, results.size());
    results = restaurantDao.findByName(newName);
    assertEquals(1, results.size());
  }

  public void testDeleteRestaurantAlsoDeletesAddress() {
    String restaurantName = &quot;Dover Diner&quot;;
    int preRestaurantCount = jdbcTemplate.queryForInt(&quot;select count(*) from restaurant&quot;);
    int preAddressCount = jdbcTemplate.queryForInt(&quot;select count(*) from address where street_name = &#39;Dover Street&#39;&quot;);
    Restaurant restaurant = restaurantDao.findByName(restaurantName).get(0);
    restaurantDao.delete(restaurant);
    List&lt;Restaurant&gt; results = restaurantDao.findByName(restaurantName);
    assertEquals(0, results.size());
    int postRestaurantCount = jdbcTemplate.queryForInt(&quot;select count(*) from restaurant&quot;);
    assertEquals(preRestaurantCount - 1, postRestaurantCount);
    int postAddressCount = jdbcTemplate.queryForInt(&quot;select count(*) from address where street_name = &#39;Dover Street&#39;&quot;);
    assertEquals(preAddressCount - 1, postAddressCount);
  }

  public void testDeleteRestaurantDoesNotDeleteEntrees() {
    String restaurantName = &quot;Dover Diner&quot;;
    int preRestaurantCount = jdbcTemplate.queryForInt(&quot;select count(*) from restaurant&quot;);
    int preEntreeCount = jdbcTemplate.queryForInt(&quot;select count(*) from entree&quot;);
    Restaurant restaurant = restaurantDao.findByName(restaurantName).get(0);
    restaurantDao.delete(restaurant);
    List&lt;Restaurant&gt; results = restaurantDao.findByName(restaurantName);
    assertEquals(0, results.size());
    int postRestaurantCount = jdbcTemplate.queryForInt(&quot;select count(*) from restaurant&quot;);
    assertEquals(preRestaurantCount - 1, postRestaurantCount);
    int postEntreeCount = jdbcTemplate.queryForInt(&quot;select count(*) from entree&quot;);
    assertEquals(preEntreeCount, postEntreeCount);
  }
}
</code></pre>
<h2>进一步阅读</h2><p>JPA是一个广泛的话题，而本博客只是从头开始-主要目的是演示Spring的基于JPA的持久性实现的基本配置。显然，就对象关系映射而言，此域模型是微不足道的。但是，一旦有了此有效的配置，就可以在探索JPA提供的ORM功能的同时在此处扩展示例。我强烈建议您通过JavaDoc和Spring参考文档仔细研究Spring JPA支持。2.0 RC1版本在参考文档的ORM部分中的JPA上增加了一个小节。</p><p>以下是一些有用的链接：</p><p><a href="https://www.jcp.org/en/jsr/detail?id=220">JSR-220</a> （包含JPA规范）<br><a href="https://glassfish.dev.java.net/javaee5/persistence/">Glassfish JPA</a> （参考实现）<br><a href="http://commerce.bea.com/showproduct.jsp?family=KODO&major=4.0&minor=0">Kodo 4.0</a> （基于Kodo的BEA的JPA实现）<br><a href="http://www.hibernate.org/371.html">Hibernate JPA迁移指南</a></p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 8;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>请启用JavaScript以查看<a href="http://disqus.com/?ref_noscript">由Disqus提供</a>的<a href="http://disqus.com/?ref_noscript">评论。</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">由<span class="logo-disqus">Disqus</span>提供动力的评论</a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>背部</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">所有帖子</a> <a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">工程</a> <a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">发布</a> <a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">新闻与活动</a> <a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>将The Spring Team的更新发送到您的收件箱</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">球队</a></li>
<li><a href="/tools">工具类</a></li>
<li><a href="https://store.pivotal.io/">商店</a></li>
<li><a href="/blog">通讯</a></li>
</ul>
</div>
</div>© <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a> ，Inc.保留所有权利。
<a href="https://pivotal.io/terms-of-use">使用条款</a> • <a href="https://pivotal.io/privacy-policy">隐私</a> • <a href="/trademarks">商标准则</a>
<div id="teconsent" style="display:inline-block"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>