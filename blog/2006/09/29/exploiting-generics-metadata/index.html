<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Exploiting Generics Metadata</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Exploiting Generics Metadata" />
<meta name="twitter:description" content="&lt;p&gt;It is a common misconception that I hear when talking with clients that all information about generic types is erased from your Java class files. This is entirely untrue. All static generic information is maintained, and only generic information about individual instances is erased. So if I have a class &lt;span style=&quot;font-family:courier&quot;&gt;Foo&lt;/span&gt; that implements &lt;span style=&quot;font-family:courier&quot;&gt;List&amp;lt;String&amp;gt;&lt;/span&gt;, then I can determine that &lt;span style=&quot;font-family:courier&quot;&gt;Foo&lt;/span&gt; implements the List interface parameterised by &lt;span style=&quot;font-family:courier&quot;&gt;String&lt;/span&gt; at runtime. However, if I instantiate an instance of &lt;span style=&quot;font-family:courier&quot;&gt;ArrayList&amp;lt;String&amp;gt;&lt;/span&gt; at runtime, I cannot take that instance and determine its concrete type parameter (I can determine that &lt;span style=&quot;font-family:courier&quot;&gt;ArrayList&lt;/span&gt; requires type parameters). In this entry I’m going to show you a practical usage for some of the available generics metadata that simplifies the creation of strategy interfaces and implementations that differ by the type of object they process.&lt;/p&gt;
" />

<meta property="og:title" content="Exploiting Generics Metadata" />
<meta property="og:description" content="&lt;p&gt;It is a common misconception that I hear when talking with clients that all information about generic types is erased from your Java class files. This is entirely untrue. All static generic information is maintained, and only generic information about individual instances is erased. So if I have a class &lt;span style=&quot;font-family:courier&quot;&gt;Foo&lt;/span&gt; that implements &lt;span style=&quot;font-family:courier&quot;&gt;List&amp;lt;String&amp;gt;&lt;/span&gt;, then I can determine that &lt;span style=&quot;font-family:courier&quot;&gt;Foo&lt;/span&gt; implements the List interface parameterised by &lt;span style=&quot;font-family:courier&quot;&gt;String&lt;/span&gt; at runtime. However, if I instantiate an instance of &lt;span style=&quot;font-family:courier&quot;&gt;ArrayList&amp;lt;String&amp;gt;&lt;/span&gt; at runtime, I cannot take that instance and determine its concrete type parameter (I can determine that &lt;span style=&quot;font-family:courier&quot;&gt;ArrayList&lt;/span&gt; requires type parameters). In this entry I’m going to show you a practical usage for some of the available generics metadata that simplifies the creation of strategy interfaces and implementations that differ by the type of object they process.&lt;/p&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2006-09-29 10:45:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Exploiting Generics Metadata</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="null?s=20&amp;d=mm" />
<span class="author">Rob Harrop</span>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2006-09-29 10:45:00.0">September 29, 2006</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="30" href="/blog/2006/09/29/exploiting-generics-metadata#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><p>It is a common misconception that I hear when talking with clients that all information about generic types is erased from your Java class files. This is entirely untrue. All static generic information is maintained, and only generic information about individual instances is erased. So if I have a class <span style="font-family:courier">Foo</span> that implements <span style="font-family:courier">List&lt;String&gt;</span>, then I can determine that <span style="font-family:courier">Foo</span> implements the List interface parameterised by <span style="font-family:courier">String</span> at runtime. However, if I instantiate an instance of <span style="font-family:courier">ArrayList&lt;String&gt;</span> at runtime, I cannot take that instance and determine its concrete type parameter (I can determine that <span style="font-family:courier">ArrayList</span> requires type parameters). In this entry I&#8217;m going to show you a practical usage for some of the available generics metadata that simplifies the creation of strategy interfaces and implementations that differ by the type of object they process.</p>
<p>A pattern that I see occurring in many applications is the use of some kind of strategy interface with concrete implementations each of which handles a particular input type. For example, consider a simple scenario from the investment banking world. Any publicly traded company can issue <a href="http://www.investopedia.com/articles/03/081303.asp">Corporate Actions</a> that bring about an actual change to their stock. A key example of this is a dividend payment which pays out a certain amount of cash, stock or property per shared to all shareholders. Within an investment bank, receiving notification of these events and calculating the resultant entitlements is very important in order to keep trading books up to date with the correct stock and cash values.</p>
<p>As a concrete example of this, consider BigBank which holds 1,200,000 IBM stock. IBM decides to issue a dividend paying $0.02 per share. As a result, BigBank needs to receive notification of the dividend action and, at the appropriate point in time, update their trading books to reflect the additional $24,000 of cash available. </p>
<p>The calculation of entitlement will differ greatly depending on which type of Corporate Action is being performed. For example, a merger will most likely result in the loss of stock in one company and the gain of stock in another.</p>
<p>If we think about how this might look in a Java application we could assume to see something like this (heavily simplified) example:</p>
<pre><code class="prettyprint java"><br />public class CorporateActionEventProcessor {

    public void onCorporateActionEvent(CorporateActionEvent event) {
        // do we have any stock for this security?

        // if so calculate our entitlements
    }
}
</code></pre>
<p>Notifications about events probably come in via a number of mechanisms from external parties and then get sent to this <span style="font-family:courier">CorporateActionEventProcessor</span> class. The <span style="font-family:courier">CorporateActionEvent</span> interface might be realised via a number of concrete classes:</p>
<pre><code class="prettyprint java"><br />public class DividendCorporateActionEvent implements CorporateActionEvent {

    private PayoutType payoutType;
    private BigDecimal ratioPerShare;

    // ...
}

public class MergerCorporateActionEvent implements CorporateActionEvent {

    private String currentIsin; // security we currently hold
    private String newIsin; // security we get
    private BigDecimal conversionRatio;
}
</code></pre>
<p>The process of calculating entitlements might be encapsulated by an interface such as this:</p>
<pre><code class="prettyprint java"><br />public interface EntitlementCalculator {
    void calculateEntitlement(CorporateActionEvent event);
}
</code></pre>
<p>Along with this interface we are likely to see a number of implementations looking like this:</p>
<pre><code class="prettyprint java"><br />public class DividendEntitlementCalculator implements EntitlementCalculator {

    public void calculateEntitlement(CorporateActionEvent event) {
        if(event instanceof DividendCorporateActionEvent) {
            DividendCorporateActionEvent dividendEvent = (DividendCorporateActionEvent)event;
            // do some processing now
        }
    }
}
</code></pre>
<p>Our <span style="font-family:courier">CorporateActionEventProcessor</span> might then look something like this:</p>
<pre><code class="prettyprint java"><br />public class CorporateActionEventProcessor {

    private Map&lt;Class, EntitlementCalculator&gt; entitlementCalculators = new HashMap&lt;Class, EntitlementCalculator&gt;();

    public CorporateActionEventProcessor() {
        this.entitlementCalculators.put(DividendCorporateActionEvent.class, new DividendEntitlementCalculator());
    }

    public void onCorporateActionEvent(CorporateActionEvent event) {
        // do we have any stock for this security?

        // if so calculate our entitlements
        EntitlementCalculator entitlementCalculator = this.entitlementCalculators.get(event.getClass());
    }
}
</code></pre>
<p>Here you can see we maintain a <span style="font-family:courier">Map</span> of <span style="font-family:courier">CorporateActionEvent</span> type to <span style="font-family:courier">EntitlementCalculator</span> implementation and we use this to locate the correct <span style="font-family:courier">EntitlementCalculator</span> for each <span style="font-family:courier">CorporateActionEvent</span>.</p>
<p>Looking back at this example the first glaring issue is that <span style="font-family:courier">EntitlementCalculator.calculateEntitlement</span> is typed to receive only <span style="font-family:courier">CorporateActionEvent</span> resulting in a type check and cast inside each implementation. We can easily fix this using generics:</p>
<pre><code class="prettyprint java"><br />public interface EntitlementCalculator&lt;E extends CorporateActionEvent&gt; {
    void calculateEntitlement(E event);
}

public class DividendEntitlementCalculator implements EntitlementCalculator&lt;DividendCorporateActionEvent&gt; {

    public void calculateEntitlement(DividendCorporateActionEvent event) {

    }
}
</code></pre>
<p>As you can see we introduced a type parameter, <span style="font-family:courier">E</span>, which is bound to extend <span style="font-family:courier">CorporateActionEvent</span>. We then define that <span style="font-family:courier">DividendEntitlementCalculator</span> implements <span style="font-family:courier">EntitlementCalculator&lt;DividendCorporateActionEvent&gt;</span> resulting in <span style="font-family:courier">E</span> being replaced with <span style="font-family:courier">DividendCorporateActionEvent</span> as appropriate within the <span style="font-family:courier">DividendEntitlementCalculator</span>. removing the need to type check and cast.</p>
<p>The <span style="font-family:courier">CorporateActionEventProcessor</span> class continues to work as it is, however there is now some duplication and also the chance for errors. When registering a particular <span style="font-family:courier">EntitlementCalculator</span> we still have to specify the type it handles even though this is already specified in the class definition. Given this, it is possible to register an <span style="font-family:courier">EntitlementCalculator</span> for a type that it cannot possibly handle:</p>
<pre><code class="prettyprint java"><br />public CorporateActionEventProcessor() {
        this.entitlementCalculators.put(MergerCorporateActionEvent.class, new DividendEntitlementCalculator());
}
</code></pre>
<p>Thankfully it is pretty easy to fix this by pulling the parameter type from the generic interface declaration and using this as the key type:</p>
<pre><code class="prettyprint java"><br />public void registerEntitlementCalculator(EntitlementCalculator calculator) {
    this.entitlementCalculators.put(extractTypeParameter(calculator.getClass()), calculator);
}
</code></pre>
<p>We start by adding a <span style="font-family:courier">registerEntitlementCalculator</span> method which delegates to <span style="font-family:courier">extractTypeParameter</span> to find the type parameter for the <span style="font-family:courier">EntitlementCalculator</span> class.</p>
<pre><code class="prettyprint java"><br />private Class extractTypeParameter(Class&lt;? extends EntitlementCalculator&gt; calculatorType) {
    Type[] genericInterfaces = calculatorType.getGenericInterfaces();

    // find the generic interface declaration for EntitlementCalculator&lt;E&gt;
    ParameterizedType genericInterface = null;
    for (Type t : genericInterfaces) {
        if (t instanceof ParameterizedType) {
            ParameterizedType pt = (ParameterizedType)t;
            if (EntitlementCalculator.class.equals(pt.getRawType())) {
                genericInterface = pt;
                break;
            }
        }
    }

    if(genericInterface == null) {
        throw new IllegalArgumentException(&quot;Type &#39;&quot; + calculatorType
               + &quot;&#39; does not implement EntitlementCalculator&lt;E&gt;.&quot;);
    }

    return (Class)genericInterface.getActualTypeArguments()[0];
}
</code></pre>
<p>Here we start by grabbing the <span style="font-family:courier">Type[]</span> representing the generic interfaces of the <span style="font-family:courier">EntitlementCalculator</span> type by calling <span style="font-family:courier">Class.getGenericInterfaces()</span>. This method differs greatly from <span style="font-family:courier">Class.getInterfaces()</span> which returns <span style="font-family:courier">Class[]</span>. Calling <span style="font-family:courier">DividendEntitlementCalculator.class.getInterfaces()</span> returns a single <span style="font-family:courier">Class</span> instance representing the <span style="font-family:courier">EntitlementCalculator</span> type. Calling <span style="font-family:courier">DividendEntitlementCalculator.class.getGenericInterfaces()</span> returns a single <span style="font-family:courier">ParameterizedType</span> instance representing the <span style="font-family:courier">EntitlementCalculator</span> type with a type argument of <span style="font-family:courier">DividendCorporateActionEvent</span>. Calling <span style="font-family:courier">getGenericInterfaces()</span> on a class with both generic and non-generic interfaces will return an array with both <span style="font-family:courier">Class</span> and <span style="font-family:courier">ParameterizedType</span> instances.</p>
<p>Next, we iterate over the <span style="font-family:courier">Type[]</span> and find the <span style="font-family:courier">ParameterizedType</span> instance whose &#8220;raw type&#8221; is <span style="font-family:courier">EntitlementCalculator</span>. From this we can extract the type argument for <span style="font-family:courier">E</span> using <span style="font-family:courier">getTypeArguments()</span> and returning the first array instance - which we know will always exist in this scenario.</p>
<p>Calling code can simply pass in the <span style="font-family:courier">EntitlementCalculator</span> implementations as required:</p>
<pre><code class="prettyprint java"><br />CorporateActionEventProcessor processor = createCorporateActionEventProcessor();
processor.registerEntitlementCalculator(new DividendEntitlementCalculator());
</code></pre>
<p>This is now a really nice API and be extended even further with something like Spring where you can use <span style="font-family:courier">ListableBeanFactory.getBeansOfType()</span> to locate all configured <span style="font-family:courier">EntitlementCalculator</span> implementations and automatically register them with the <span style="font-family:courier">CorporateActionEventProcessor</span>.</p>
<h2 id="whatsnext">What's Next?</h2><p><p>One interesting situation some of you may have noticed here is that it is entirely possible to have code like this:</p>
<pre><code class="prettyprint java"><br />EntitlementCalculator calculator = new DividendEntitlementCalculator();
calculator.calculateEntitlement(new MergerCorporateActionEvent());
</code></pre>
<p>This code will compile just fine but we know that the <span style="font-family:courier">DividendEntitlementCalculator.calculateEntitlement</span> method only accepts a <span style="font-family:courier">DividendCorporateActionEvent</span> object. So why does that compile? And, since it does compile what happens at runtime? Well, to answer the second question first - Java still ensure type safety by throwing <span style="font-family:courier">ClassCastException</span> at runtime. Why this works and to answer the question of why this example actually compiles I'll be writing another entry soon...</p>
<h2 id="furtherreading">Further Reading</h2>
<p><a href="https://www.amazon.com/dp/0471497584/">Securities Operations</a></p>
<p><a href="https://www.amazon.com/dp/0470870664">Corporate Actions</a></p>
<p><a href="http://java.sun.com/j2se/1.5/pdf/generics-tutorial.pdf#search=%22java%205%20generics%22">Generics in the Java Programming Language</a></p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 30;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>