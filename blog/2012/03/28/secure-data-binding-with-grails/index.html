<html  data-code-prettify="" data-mobile-support="" data-search=""><head>
<title>使用Grails进行安全的数据绑定</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="Secure Data Binding With Grails">
<meta name="twitter:description" >
<meta name="twitter:creator" content="@jeffscottbrown">
<meta name="twitter:image:src" content="https://gravatar.com/avatar/e72a741751057c298657c338b4680b33?s=200">

<meta property="og:title" content="Secure Data Binding With Grails">
<meta property="og:image" content="https://gravatar.com/avatar/e72a741751057c298657c338b4680b33?s=200">
<meta property="og:description" >
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2012-03-28 16:43:00.0">
</head>
<body >

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">使用Grails进行安全的数据绑定</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/e72a741751057c298657c338b4680b33?s=20&d=mm"> <span class="author">杰夫·斯科特·布朗</span>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2012-03-28 16:43:00.0">2012年3月28日</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2012/03/28/secure-data-binding-with-grails#disqus_thread" data-disqus-identifier="466">
</a></div>
</div>
</header>
<div class="blog--post"><h2>介绍</h2><p>Grails框架为Web应用程序开发人员提供了许多工具和技术，以简化解决常见的应用程序开发难题的过程。</p><p>其中有许多事情可以简化通常与数据绑定相关联的繁琐而繁琐的问题。通常，Grails使数据绑定非常简单，因为它提供了几种将数据图绑定到对象图的技术。</p><p>应用程序开发人员必须了解每种技术的含义，以便确定哪种技术最适合任何给定用例，这一点很重要。</p>
<h2>Web应用程序数据绑定概述</h2><p>对于许多Web应用程序来说，一个真正常见的任务是使应用程序接受一组http请求参数并将这些参数绑定到对象。然后，该对象可能存储在数据库中，用于执行某种计算或用于执行某种应用程序逻辑。在Grails应用程序中，其中一些通常是通过控制器操作执行的，并且数据通常绑定到域对象。</p><p>考虑一个看起来像这样的域类：<br></p><h4>代码清单1</h4><p></p>
<pre><code class="prettyprint groovy">class Employee {
    String firstName
    String lastName
    BigDecimal salary
}
</code></pre><p>应用程序中可能存在一个允许更新firstName和lastName属性的表单。该表格可能不允许更新salary属性，该属性只能由应用程序的其他部分进行更新。</p><p>用于更新特定员工的控制器操作可能类似于以下内容：<br></p><h4>代码清单2</h4><p></p>
<pre><code class="prettyprint groovy">class EmployeeController {
    def updateEmployee() {
        // retrieve the employee from the database
        def employee = Employee.get(params.id)

        // update properties in the employee
        employee.firstName = params.firstName
        employee.lastName = params.lastName

        // update the database
        employee.save()
    }
}
</code></pre><p>Grails可以通过允许如下所示来简化此操作：</p>
<h4>代码清单3</h4>
<pre><code class="prettyprint groovy">class EmployeeController {
    def updateEmployee() {
        // retrieve the employee from the database
        def employee = Employee.get(params.id)

        // update properties in the employee
        employee.properties = params

        // update the database
        employee.save()
    }
}
</code></pre><p>每个示例均假设存在名为firstName和lastName的请求参数。在第一个示例中，对于需要更新的每个属性都有一行代码，但是在第二个示例中，仅一行代码说明了所有需要更新的属性。</p><p>在此特定示例中，我们仅消除了一行代码，但是如果Employee对象中有很多要更新的属性，则第一个示例将变得更长且更乏味，而第二个示例将保持完全相同。</p>
<h2>一个潜在的问题</h2><p>代码清单3比代码清单2更干净，并且需要的维护更少，但是对于任何特定用例而言，它可能是最好的事情，也可能不是最好的事情。</p><p>更简单的方法的一个问题是它可能允许用户更新应用程序开发人员不打算允许的属性。</p><p>例如，如果有一个名为薪水的请求参数，代码清单2中的代码将忽略该请求参数，但代码清单3中的代码将使用该参数的值来更新Employee对象中的salary属性，这可能是有问题的。</p><p>应用程序代码可以使用多种技术来防御类似的情况。一种是使用代码清单2中所示的方法。另一种是在要求完成数据绑定时向Grails提供属性名称的白名单或黑名单。</p><p>提供白名单的一种方法如下所示：</p>
<h4>代码清单4</h4>
<pre><code class="prettyprint groovy">class EmployeeController {
    def updateEmployee() {
        // retrieve the employee from the database
        def employee = Employee.get(params.id)

        // update the firstName and lastName properties in the employee
        employee.properties[&#39;firstName&#39;, &#39;lastName&#39;] = params

        // update the database
        employee.save()
    }
}
</code></pre><p>代码清单4中的代码将仅将firstName和lastName请求参数绑定到employee对象，而忽略所有其他请求参数。如果有一个名为薪水的请求参数，它将不会导致雇员对象中的薪水属性被更新。</p><p>另一种技术是使用添加到所有Grails控制器的bindData方法。bindData方法允许提供属性名称的白名单和/或黑名单：</p>
<h4>代码清单5</h4>
<pre><code class="prettyprint groovy">class EmployeeController {
    def updateEmployee() {
        // retrieve the employee from the database
        def employee = Employee.get(params.id)

        // update the firstName and lastName properties in the employee
        bindData(employee, params, [include: [&#39;firstName&#39;, &#39;lastName&#39;]])

        // or... bindData(employee, params, [exclude: [&#39;salary&#39;]])

        // update the database
        employee.save()
    }
}
</code></pre>
<h2>数据绑定和依赖注入</h2><p>上述潜在问题可能会以多种方式导致应用程序出现问题。一种就是允许员工的薪水属性在应用程序的一部分中被更新，而这是不允许的。可能出现此问题的另一种方式是，如果对具有任何属性的对象执行数据绑定，这些属性是从Spring应用程序上下文注入到对象中的。</p><p>考虑如下代码：<br></p><h4>代码清单6</h4><p></p>
<pre><code class="prettyprint groovy">class TaxCalculator {
    def taxRate

    def calculateTax(baseAmount) {
        baseAmount * taxRate
    }
}

class InvoiceHelper {
    def taxCalculator

    def calculateInvoice(...) {
        // do something with the parameters that involves invoking
        // taxCalculator.calculateTax(...) to generate some total
    }
}
</code></pre><p>考虑在Spring应用程序上下文中配置了TaxCalculator实例以及InvoiceHelper实例。TaxCalculator实例自动连接到InvoiceHelper实例。</p><p>现在考虑这样的Grails域类：<br></p><h3>代码清单7</h3><p></p>
<pre><code class="prettyprint groovy">class Vendor {
    def invoiceHelper
    String vendorName

    // ...
}
</code></pre><p>Grails控制器可能会执行以下操作来更新数据库中当前保留的供应商：<br></p><h4>代码清单8</h4><p></p>
<pre><code class="prettyprint groovy">class VendorController {
    def updateVendor = {
        // retrieve the vendor from the database
        def vendor = Vendor.get(params.id)

        // update properties in the vendor
        vendor.properties = params

        // update the database
        vendor.save()
    }
}
</code></pre><p>潜在的问题是，它可能会无意间允许更新Spring应用程序上下文中的TaxCalculator实例中的taxRate属性。</p><p>如果有一个名为invoiceHelper.taxCalculator.taxRate的请求参数，那么执行“ vendor.properties = params”时就会发生这种情况。根据应用程序中的某些其他详细信息，可能会导致应用程序发生意外的问题。</p><p>在Grails 2.0.2中，这不是问题，因为Vendor类中的invoiceHelper属性是动态类型的，并且如下所述，动态类型的属性是不可绑定的，除非它们明确地包含在白名单中。如果invoiceHelper属性是静态类型的，则它将受到数据绑定的约束。</p><p>在Grails 2.0.2之前，编码清单8中的代码是有问题的，但是可以使用上述白名单或黑名单技术轻松处理。</p><p>使用数据绑定构造函数时，会出现相同问题的另一个版本：<br></p><h4>代码清单9</h4><p></p>
<pre><code class="prettyprint groovy">class VendorController {
    def createVendor = {
        // create a new Vendor
        def vendor = new Vendor(params)

        // save to the database
        vendor.save()
    }
}
</code></pre><p>在Grails 2.0.2和Grails 1.3.8之前，执行“新的Vendor（params）”是创建Vendor对象，然后再次对Vendor实例进行依赖注入，然后进行数据绑定，将参数绑定到实例。</p><p>由于事件的顺序，如果参数包含名为“ invoiceHelper.taxCalculator.taxRate”的请求参数，则此代码将遇到上述相同的问题。</p><p>在Grails 2.0.2和Grails 1.3.8中，事件的顺序被更改，因此创建了Vendor对象，然后再次对实例执行数据绑定，然后执行依赖项注入。</p><p>使用该事件序列，Spring Bean中的数据绑定突变属性没有危险，因为只有在数据绑定发生之后才注入Spring Bean。</p><p>对于Grails 2.0.2和Grails 1.3.8之前的Grails版本，解决此问题的简单方法如下：<br></p><h4>代码清单10</h4><p></p>
<pre><code class="prettyprint groovy">class VendorController {
    def createVendor = {
        // create a new Vendor
        def vendor = new Vendor()

        vendor.properties[&#39;vendorName&#39;] = params

        // or... bindData(vendor, params, [include: [&#39;vendorName&#39;]])
        // or... bindData(vendor, params, [exclude: [&#39;invoiceHelper&#39;]])

        // save to the database
        vendor.save()
    }
}
</code></pre><p>这对于每个域类都不是问题，但是对于将Spring bean自动连接到其中的域类则可能存在问题。顺便说一句，同一组问题适用于Grails命令对象，这些对象也受数据绑定和自动依赖项注入的影响。</p>
<h2>Grails 2.0.2数据绑定改进</h2><p>这些技术在很长一段时间内一直受到Grails的支持。Grails 2.0.2将为管理数据绑定提供更大的灵活性。在Grails 2.0.2中，代码清单4和5中的代码将与以前的版本完全相同。提供白名单或黑名单时，将受到尊重。</p><p>但是，当未提供白名单或黑名单时，例如“ employee.properties = params”，Grails 2.0.2的行为可能有所不同，具体取决于<br>Employee类。</p><p>在Grails 2.0.2中，数据绑定机制默认情况下将排除所有静态，瞬态或动态类型的属性。为了更精细地控制默认情况下可绑定的内容和不可绑定的内容，Grails 2.0.2支持新的可绑定约束：<br></p><h4>代码清单11</h4><p></p>
<pre><code class="prettyprint groovy">class Employee {
    String firstName
    String lastName
    BigDecimal salary

    static constraints = {
        salary bindable: false
    }
}
</code></pre><p>代码清单11显示了如何表达默认情况下salary属性是不可绑定的。这意味着当应用程序执行“ employee.properties = params”之类的操作时，salary属性将不受数据绑定的约束。</p><p>如果该属性曾经明确包含在白名单中，例如“ employee.properties ['firstName'，'lastName'，'salary'] = params”，那么它将受到数据绑定的约束。</p>
<h2>结论</h2><p>Grails提供的数据绑定机制允许编写干净的表达代码，而不会被很多繁琐的数据绑定相关细节所困扰。对于应用程序开发人员而言，重要的是要了解使用这些技术的含义，以便可以针对任何特定用例实现最佳方法。<br></p><h3>参考文献</h3><br><ul><br> <li><a href="http://grails.org/doc/2.0.2/">Grails 2.0.2用户指南</a></li><br> <li><a href="http://grails.org/doc/2.0.2/guide/theWebLayer.html#dataBinding">数据绑定文件</a></li><br> <li><a href="http://grails.org/doc/2.0.2/ref/Constraints/bindable.html">可绑定约束文档</a></li><br></ul><p></p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 466;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>请启用JavaScript以查看<a href="http://disqus.com/?ref_noscript">由Disqus提供</a>的<a href="http://disqus.com/?ref_noscript">评论。</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">由<span class="logo-disqus">Disqus</span>提供动力的评论</a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>背部</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">所有帖子</a> <a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">工程</a> <a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">发布</a> <a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">新闻与活动</a> <a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>将The Spring Team的更新发送到您的收件箱</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">工具类</a></li>
<li><a href="https://store.pivotal.io/">商店</a></li>
<li><a href="/blog">通讯</a></li>
</ul>
</div>
</div>© <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a> ，Inc.保留所有权利。
<a href="https://pivotal.io/terms-of-use">使用条款</a> • <a href="https://pivotal.io/privacy-policy">隐私</a> • <a href="/trademarks">商标准则</a>
<div id="teconsent" style="display:inline-block"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>