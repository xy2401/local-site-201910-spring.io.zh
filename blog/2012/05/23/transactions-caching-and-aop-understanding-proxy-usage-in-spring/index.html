<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Transactions, Caching and AOP: understanding proxy usage in Spring</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Transactions, Caching and AOP: understanding proxy usage in Spring" />
<meta name="twitter:description" content="&lt;p&gt;In the Spring framework, many technical features rely on proxy usage. We are going to go in depth on this topic using three examples: &lt;a href=&quot;#tx&quot;&gt;Transactions&lt;/a&gt;, &lt;a href=&quot;#cache&quot;&gt;Caching&lt;/a&gt; and&lt;a href=&quot;#config&quot;&gt; Java Configuration&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;All the code samples shown in this blog entry are available &lt;a title=&quot;samples&quot; href=&quot;https://github.com/michaelisvy/proxy-samples&quot;&gt;on my github account&lt;/a&gt;.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;tx&quot;&gt;Transactions&lt;/a&gt;&lt;/h3&gt;
&lt;h4&gt;First step: no transaction&lt;/h4&gt;
&lt;p&gt;The Service class below is not transactional &lt;em&gt;yet&lt;/em&gt;. Let’s first look at it &lt;em&gt;as is &lt;/em&gt;and then make it become transactional.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;prettyprint java&quot;&gt;&lt;br&gt;@Service
public class AccountServiceImpl&amp;nbsp; implements AccountService {
 //…

//Not specifying a transaction policy here!
 public void create(Account account) {
 entityManager.persist(account);
 }
}

&lt;/code&gt;&lt;/pre&gt;
" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/e0dffdc6678a8035ce431e3bc46a82f8?s=200" />

<meta property="og:title" content="Transactions, Caching and AOP: understanding proxy usage in Spring" />
<meta property="og:image" content="https://gravatar.com/avatar/e0dffdc6678a8035ce431e3bc46a82f8?s=200" />
<meta property="og:description" content="&lt;p&gt;In the Spring framework, many technical features rely on proxy usage. We are going to go in depth on this topic using three examples: &lt;a href=&quot;#tx&quot;&gt;Transactions&lt;/a&gt;, &lt;a href=&quot;#cache&quot;&gt;Caching&lt;/a&gt; and&lt;a href=&quot;#config&quot;&gt; Java Configuration&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;All the code samples shown in this blog entry are available &lt;a title=&quot;samples&quot; href=&quot;https://github.com/michaelisvy/proxy-samples&quot;&gt;on my github account&lt;/a&gt;.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;tx&quot;&gt;Transactions&lt;/a&gt;&lt;/h3&gt;
&lt;h4&gt;First step: no transaction&lt;/h4&gt;
&lt;p&gt;The Service class below is not transactional &lt;em&gt;yet&lt;/em&gt;. Let’s first look at it &lt;em&gt;as is &lt;/em&gt;and then make it become transactional.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;prettyprint java&quot;&gt;&lt;br&gt;@Service
public class AccountServiceImpl&amp;nbsp; implements AccountService {
 //…

//Not specifying a transaction policy here!
 public void create(Account account) {
 entityManager.persist(account);
 }
}

&lt;/code&gt;&lt;/pre&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2012-05-23 09:05:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Transactions, Caching and AOP: understanding proxy usage in Spring</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/e0dffdc6678a8035ce431e3bc46a82f8?s=20&amp;d=mm" />
<span class="author">Michael Isvy</span>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2012-05-23 09:05:00.0">May 23, 2012</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="474" href="/blog/2012/05/23/transactions-caching-and-aop-understanding-proxy-usage-in-spring#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><p>In the Spring framework, many technical features rely on proxy usage. We are going to go in depth on this topic using three examples: <a href="#tx">Transactions</a>, <a href="#cache">Caching</a> and<a href="#config"> Java Configuration</a>.</p><p>All the code samples shown in this blog entry are available <a title="samples" href="https://github.com/michaelisvy/proxy-samples">on my github account</a>.</p>

<h3><a name="tx">Transactions</a></h3>
<h4>First step: no transaction</h4><p>The Service class below is not transactional <em>yet</em>. Let’s first look at it <em>as is </em>and then make it become transactional.</p>
<pre><code class="prettyprint java"><br />@Service
public class AccountServiceImpl  implements AccountService {
 //…

//Not specifying a transaction policy here!
 public void create(Account account) {
 entityManager.persist(account);
 }
}

</code></pre><p>Since the method “create” is not transactional, it will most likely throw an exception (because this Account object should not be persisted outside of a transaction).</p><p>Here is what we have at runtime:<br />﻿<a href="http://blog.springsource.org/wp-content/uploads/2012/05/no-proxy.png"><img class="size-full wp-image-11115 aligncenter" title="no-proxy" src="http://blog.springsource.org/wp-content/uploads/2012/05/no-proxy.png" alt="" width="394" height="218" /></a><br /><h4>Second step: adding transactional behavior configuration</h4><br />Let us now add @Transactional on top of the create(…) method:</p>
<pre><code class="prettyprint java"><br />@Service
public class AccountServiceImpl  implements AccountService {
 @PersistenceContext
 private EntityManager entityManager;

 @Transactional
 public void create(Account account) {
 entityManager.persist(account);
 }

}
</code></pre><p>And here is the corresponding Spring configuration:</p>
<pre><code class="prettyprint xml"><br />&lt;bean id=&quot;transactionManager&quot;&gt;
 &lt;property name=&quot;entityManagerFactory&quot; ref=&quot;entityManagerFactory&quot; /&gt;
&lt;/bean&gt;

&lt;tx:annotation-driven/&gt;
</code></pre><p>Inside Spring generic configuration, we have used  &lt;tx:annotation-driven /&gt; . It means that all @Transactional annotations should be scanned at startup time and the targeted methods should become transactional. So where is the transactional behavior happening?</p><p>Before startup, we still have the same files as before:</p><p><a href="http://blog.springsource.org/wp-content/uploads/2012/05/before-startup.png"><img class="aligncenter size-full wp-image-11121" title="before-startup" src="http://blog.springsource.org/wp-content/uploads/2012/05/before-startup.png" alt="" width="252" height="208" /></a></p><p>At startup time, a new class is created, called proxy. This one is in charge of adding Transactional behavior as follows:</p><p><a href="http://blog.springsource.org/wp-content/uploads/2012/05/Transactional-proxy-after-startup.png"><img class="aligncenter size-full wp-image-11122" title="Transactional-proxy-after-startup" src="http://blog.springsource.org/wp-content/uploads/2012/05/Transactional-proxy-after-startup.png" alt="" width="572" height="266" /></a></p><p>The generated proxy class comes on top of AccountServiceImpl. It adds Transactional behavior to it <a href="#note">[1]</a>.<br /><div></p><p>So how to make sure that a proxy is indeed being used? For your own understanding, it’s interesting to go back into the code and see with your very eyes that you are indeed using a proxy.</p><p>A simple way is to print out the class name:</p>
<pre><code class="prettyprint java"><br /><br />AccountService accountService = (AccountService) applicationContext.getBean(AccountService.class);
String accountServiceClassName = accountService.getClass().getName();
logger.info(accountServiceClassName);
</code></pre><p>On my computer, it shows the following output:</p>
<pre><code class="prettyprint java"><br /><br />INFO : transaction.TransactionProxyTest - $Proxy13
</code></pre><p>This class is a Dynamic Proxy, generated by Spring using the JDK Reflection API (more information <a title="Proxy Javadoc" href="https://docs.oracle.com/javase/6/docs/api/java/lang/reflect/Proxy.html">here</a>).</p><p>At shutdown (eg. When the application  is stopped), the proxy class will be destroyed and you will only have AccountService and AccountServiceImpl on the file system:</p><p><a href="http://blog.springsource.org/wp-content/uploads/2012/05/before-startup1.png"><img class="aligncenter size-full wp-image-11125" title="after shutdown" src="http://blog.springsource.org/wp-content/uploads/2012/05/before-startup1.png" alt="" width="252" height="208" /></a></p>

<h3>How does Spring wire the proxy in-lieu of the target class?</h3><p></div><br /><div>Let us consider a consider a class that uses an instance of AccountService:</div><br /><div><br />```java</p><p>@Controller<br />public class AccountController {<br /> private AccountService accountService;</p><p>private void setAccountService(AccountService accountService) {<br /> this.accountService=accountService;<br />}</p><p>//…<br />}<br />```</p><p><a href="http://blog.springsource.org/wp-content/uploads/2012/05/proxy-and-target1.png"><img class="aligncenter size-full wp-image-11128" title="proxy-and-target" src="http://blog.springsource.org/wp-content/uploads/2012/05/proxy-and-target1.png" alt="" width="316" height="255" /></a></p><p></div><br /><div></p><p>The attribute accountService is of type AccountService (interface). The variable dependency is on the interface type AccountService, not the implementation type, which reduces the coupling between classes. This is a best practice.</p><p>As seen before, both AccountServiceImpl and the generated Proxy implement the interface AccountService.<br />•    If there is a proxy, Spring injects the proxy<br />•    If not, Spring injects the instance of type AccountServiceImpl.</p><p></div><br />&nbsp;<br /><h3><a name="cache">Caching</a></h3><br /><div></p><p>Declarative caching is a new feature in Spring 3.1 that works like Spring’s declarative transaction support.</p><p>The @Cacheable annotation should be used in that way:</p><p></div><br /><div><br />```java</p><p>public class AccountServiceImpl  implements AccountService {</p><p>@Cacheable(value=&ldquo;accounts&rdquo;, key=&ldquo;#id&rdquo;)<br />public Account findAccount (long id) {<br /> // only enter method body if result is not in the cache already<br /> }<br />}<br />```</p><p>You should also have enabled caching inside Spring configuration as follows:</p>
<pre><code class="prettyprint xml"><br />&lt;cache:annotation-driven /&gt;
</code></pre><p>Here are the expected results:</p>
<pre><code class="prettyprint java"><br />accountService.findAccount (1); // Result stored into cache for key “1”
accountService.findAccount (1); // Result retrieved from cache. Target method not called.
accountService.findAccount (2); // Result stored into cache for key “2”
</code></pre><p>At runtime, a proxy is used to add Caching behavior.</p><p></div><br /><div><a href="http://blog.springsource.org/wp-content/uploads/2012/05/proxy-caching.png"><img class="aligncenter size-full wp-image-11129" title="proxy-caching" src="http://blog.springsource.org/wp-content/uploads/2012/05/proxy-caching.png" alt="" width="580" height="265" /></a><br /><em>Note: Spring 3.1 embeds a fairly simple cache implementation. It is usually recommended to use another implementation such as ehcache. On the sample application available here (<a href="https://github.com/michaelisvy/proxy-samples)">https://github.com/michaelisvy/proxy-samples)</a>, you’ll find some examples using both the embedded cache implementation and ehcache.</em></div><br /><h3>What if the bean class does not implement any interface?</h3><br />In the previous example, we mentioned that a proxy should implement the same Interface as your bean.<br />Thankfully, Spring can also proxy beans that don’t have an interface. There are many cases where implementing an interface is not the best way to go.</p><p>By default, if your bean does not implement an interface, Spring uses technical inheritance: at startup time, a new class is created. It inherits from your bean class and adds behavior in the child methods.<br /><div><a href="http://blog.springsource.org/wp-content/uploads/2012/05/proxy-transaction-inheritance.png"><img class="aligncenter size-full wp-image-11130" title="proxy-transaction-inheritance" src="http://blog.springsource.org/wp-content/uploads/2012/05/proxy-transaction-inheritance.png" alt="" width="417" height="336" /></a></div><br /><div>In order to generate such proxies, Spring uses a third party library called <a href="http://cglib.sourceforge.net/">cglib</a>. Unfortunately, this project is not active anymore. In Spring 3.2, it is very likely that Spring will be using Javassist instead by default (<a title="jira SPR-5654" href="https://jira.springsource.org/browse/SPR-5654">see here for more details</a>).</div><br /><div></p>

<h3><a name="config">Java Configuration</a></h3><p></div><br /><div></p><p><em>Note: this section requires some background knowledge of Java Configuration in Spring. Please feel free to skip it if you are not comfortable with this new configuration style.</em></p><p><em>You can learn more about Java Configuration <a href="http://blog.springsource.org/2009/12/22/configuration-simplifications-in-spring-3-0/">here</a>.  There is also an excellent article which discusses the various configuration styles <a href="http://blog.springsource.org/2010/11/09/green-beans-putting-the-spring-in-your-step-and-application/ ">here</a>.<br /></em></p><p></div><br /><div>When using Java Configuration, the configuration is stored in a Java class such as this one:</div><br /><div><br />```java</p><p>@Configuration<br />public class JavaConfig {</p><p>@Bean<br /> public AccountService accountService() {</p><p>return new AccountServiceImpl((accountRepository());<br /> }<br />@Bean<br /> public AccountRepository accountRepository () {<br />//…<br /> }</p><p>}<br />```</p><p>Spring calls the method accountService() every time it needs to wire an instance of the bean “accountService” and this one returns a “new” object of type AccountService. If 10 beans are using a dependency of type AccountService, this method is called 10 times.</p><p>However, no matters the Spring configuration has been made using Java Configuration or not, every bean should be a singleton by default. How is that possible and where is the magic happening?<br />This diagram explains how things work internally:</p><p></div><br /><div><a href="http://blog.springsource.org/wp-content/uploads/2012/05/java-config.png"><img class="aligncenter size-full wp-image-11131" title="java-config" src="http://blog.springsource.org/wp-content/uploads/2012/05/java-config.png" alt="" width="507" height="328" /></a></div><br /><div></p><p>So the Proxy is adding behavior there. In the case that your bean should be a singleton, the action to turn your Plain Old Java Object into a singleton is performed by a child class (Proxy).</p><p></div><br /><div><br />&nbsp;<br /><h3>Conclusion</h3><br />We’ve seen some use-cases on how proxies are used inside the Spring framework. There are many other examples: Aspect Oriented Programming, Security (using Spring Security), thread safety, scopes, etc…</p><p>If you would like to know more on the impact on performance when using proxies, you can read <a href="http://blog.springsource.org/2007/07/19/debunking-myths-proxies-impact-performance/">Alef Arendsen’s blog entry here</a>.</p><p></div><br /><div></p>
<hr size="1" />
<div><a name="note">[1]</a>to be exact: the proxy class does not contain the transaction code internally. It delegates transaction handling to some classes that are part of the Spring framework. Spring will then handle transactions according to the Transaction Manager you have declared.&nbsp;
</div><p></div></p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 474;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>