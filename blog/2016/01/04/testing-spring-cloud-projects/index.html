<html  data-code-prettify="" data-mobile-support="" data-search=""><head>
<title>测试Spring Cloud项目</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="Testing Spring Cloud Projects">
<meta name="twitter:description" >
<meta name="twitter:creator" content="@mgrzejszczak">
<meta name="twitter:image:src" content="https://gravatar.com/avatar/d4b43000c99fccc46455f42a841fa62e?s=200">

<meta property="og:title" content="Testing Spring Cloud Projects">
<meta property="og:image" content="https://gravatar.com/avatar/d4b43000c99fccc46455f42a841fa62e?s=200">
<meta property="og:description" >
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2016-01-04 17:21:00.0">



<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">测试Spring Cloud项目</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/d4b43000c99fccc46455f42a841fa62e?s=20&d=mm"> <a class="author" rel="author" href="/team/marcingrzejszczak">马尔辛·格热兹扎克（Marcin Grzejszczak）</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2016-01-04 17:21:00.0">2016年1月4日</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2016/01/04/testing-spring-cloud-projects#disqus_thread" data-disqus-identifier="2334">
</a></div>
</div>
</header>
<div class="blog--post"><p>欢迎来到我作为Spring Cloud团队成员的第一篇博客文章:)</p>
<p>自从我加入以来已经有一个月了，值得分享那段时间发生的一些有趣的事情。</p>
<p>如果您一直在阅读<a href="https://toomuchcoding.blogspot.com">Too Much Coding博客上的</a>任何文章，那么您就会知道我对两件事感到疯狂-测试和微服务。由于我目前所做的都是与微服务相关的，因此今天的帖子将涉及测试。</p><h1><a href="#the-spring-cloud-projects" class="anchor" name="the-spring-cloud-projects"></a> Spring Cloud项目</h1>
<p>当我加入Spring Cloud团队时，我对Github进行了快速浏览，结果发现我们有很多项目需要管理，其中包括：</p>
<ul>
<li><a href="https://github.com/spring-cloud/spring-cloud-netflix/">Spring Cloud Netflix</a> （包括Eureka发现服务和注册表，Hystrix，Feign和RIbbon支持）</li>
<li><a href="https://github.com/spring-cloud/spring-cloud-zookeeper/">Spring Cloud Zookeeper</a></li>
<li><a href="https://github.com/spring-cloud/spring-cloud-consul">spring-cloud-consul</a></li>
<li><a href="https://github.com/spring-cloud/spring-cloud-sleuth">Spring Cloud侦探</a></li>
</ul>
<p>它们都依赖于Spring和Spring Boot。当然，它们每个都有自己的版本。那是很多相互依赖的关系，不是吗？</p><h1><a href="#how-to-test-dependencies" class="anchor" name="how-to-test-dependencies"></a>如何测试依赖关系？</h1>
<p>我想确定的是，如果有人在Spring核心或Spring Boot中进行了某些更改，那么我们将立即知道我们的库仍在运行。当然，我们可以在CI工具上创建重复的构建，但是即使集成测试通过了，也仍然存在类路径和JAR打包问题的可能性。</p>
<p>我建议写一些端到端测试……</p>
<p>现在，无论谁阅读我的这篇有关微服务<a href="https://toomuchcoding.blogspot.com/2015/09/microservice-deployment.html">部署的</a>文章，都会说我发疯了，因为我完全反对那种特定情况下的端到端测试。那么，发生了什么变化？</p><h2><a href="#why-end-to-end-tests-were-a-good-idea" class="anchor" name="why-end-to-end-tests-were-a-good-idea"></a>为什么端到端测试是一个好主意？</h2><h3><a href="#binary-approach-is-it-working-or-not" class="anchor" name="binary-approach-is-it-working-or-not"></a>二进制方法-是否有效？</h3>
<p>拥有如此众多的项目，在这个时候我不想漫游所有的Github存储库，检查它们的测试并向自己保证一切都很好。我想要一个黑盒解决方案，该解决方案可以告诉我应用程序是否正常运行。</p><h3><a href="#cross-project-testing" class="anchor" name="cross-project-testing"></a>跨项目测试</h3>
<p>创建的应用程序将使用我们的许多不同项目。端到端测试将选择其中的任何重大更改。</p><h3><a href="#application-packaging" class="anchor" name="application-packaging"></a>应用包装</h3>
<p>我检查了几次测试， <code>./gradlew bootRun</code>一切似乎都正常。除了事实<code>java -jar ...</code>没用，因为包装坏了。我也想测试一下。</p><h3><a href="#sample-of-usage" class="anchor" name="sample-of-usage"></a>使用样本</h3>
<p>我想创建几个项目，介绍可以使用Spring Cloud的方式。我想踏入新的Spring Cloud用户的行列，并在一个地方可以快速设置应用程序，基础架构的整个世界，然后单击以查看有何反应。</p><h1><a href="#the-brewery-project" class="anchor" name="the-brewery-project"></a>啤酒厂项目</h1>
<p>由于我一直在<a href="http://lanyrd.com/profile/marcin-grzejszczak/past/">谈论微服务，因此</a>我已经准备好了示例代码（对最初解决方案的合著者<a href="https://github.com/szimano">Szimano表示敬意</a> ）。我已经对其进行了调整，弯曲并对其进行了破解，然后<a href="https://github.com/spring-cloud-samples/brewery">酿酒厂</a>就来到了。</p><h2><a href="#the-high-overview" class="anchor" name="the-high-overview"></a>高概述</h2>
<p>总体思路是，存在3个相互通信的应用程序：<br>-展示服务<br>-冲泡服务<br>-zuul服务</p>
<p><strong>呈现服务</strong>是用户的UI，他可以在其中订购要酿造啤酒的原料。它的后端还具有酿造过程的状态。</p>
<p>这是服务的用户界面：</p>
<p><img src="https://raw.githubusercontent.com/spring-cloud-samples/brewery/master/img/Brewery_UI.png" alt="图表"></p>
<p><strong>酿造服务</strong>是负责多种功能的大型应用程序。最初，它被拆分为几个微服务，但是为了简单起见，我们决定删除可部署单元的数量。回到功能上，这些是：<br>-收集食材<br>-使啤酒成熟<br>-将啤酒放入瓶中<br>-报告（侦听系统中的事件并将其放入内存中的数据存储中）</p>
<p><strong>zuul服务</strong>只是一个Zuul路由器。</p>
<p>该系统的思想是所有组件都在使用服务发现或Spring Cloud Stream在彼此之间进行通信。</p>
<p>请查看<a href="https://github.com/spring-cloud-samples/brewery/blob/master/README.md">自述文件</a>以获取有关项目结构的更多信息。</p><h2><a href="#re-usability" class="anchor" name="re-usability"></a>重用性</h2>
<p>我想要实现的是可重用性。为了使用<a href="https://github.com/spring-cloud/spring-cloud-zookeeper/">Spring Cloud Zookeeper</a>作为Service Registry测试<a href="https://github.com/spring-cloud/spring-cloud-sleuth">Spring Cloud Sleuth</a> ，我不想更改任何代码。只是想用不同的参数运行测试。</p>
<p>我们正在使用Spring Cloud抽象来做到这一点，因此，如果我们从Eureka更改为Consul，则根本无需更改任何代码，并且应用程序仍应能够通信（这是JAR和配置更改的问题）。我也想测试一下。</p><h2><a href="#conventions" class="anchor" name="conventions"></a>约定</h2>
<p>以下是Brewery应用中的一堆约定。最主要的是您有一个特定的后缀<code>docker-compose</code>与测试功能相对应的yml文件。</p>
<ul>
<li>docker-compose-CONSUL.yml</li>
<li>docker-compose-EUREKA.yml</li>
<li>docker-compose-SLEUTH_STREAM.yml</li>
<li>docker-compose-SLEUTH.yml</li>
<li>docker-compose-ZOOKEEPER.yml</li>
</ul>
<p>这些docker-compose文件中的每个文件都知道如何运行应用程序和基础结构的整个领域来测试给定的功能。</p><h2><a href="#how-to-run-the-apps" class="anchor" name="how-to-run-the-apps"></a>如何运行应用程序？</h2>
<p>首先，您必须使用Gradle构建应用程序及其Dockerfile。另外你还必须通过<code>WHAT_TO_TEST</code>系统参数。基于该参数，选择应用程序的类路径。范例<code>SLEUTH</code> 。</p>
<pre><code class="prettyprint">./gradlew clean build -DWHAT_TO_TEST=SLEUTH --parallel
</code></pre>
<p>一旦完成，就可以运行上述bash脚本来运行所需的应用程序：</p>
<pre><code class="prettyprint">docker-compose -f docker-compose-SLEUTH.yml up -d
</code></pre>
<p><strong>注意</strong> ：有时启动顺序很重要，因此如果您要手动执行操作，请检查相应bash文件中的给定功能，例如<code>docker-compose-SLEUTH.sh</code> 。</p>
<p>通常，最好将应用程序一起启动并运行测试。怎么做？这只是一个班轮。请查看下一部分以获取更多信息。</p><h2><a href="#how-to-run-the-tests" class="anchor" name="how-to-run-the-tests"></a>如何进行测试？</h2>
<p>就像文档说的那样：</p>
<blockquote>
<p>最简单的方法是：</p>
<pre><code class="prettyprint">Create a symbolic link somewhere on your drive to the acceptance-tests/scripts/runDockerAcceptanceTests.sh file.
You can execute that script with such options
    -t what do you want to test (SLEUTH, ZOOKEEPER etc.)
    -v in which version of the BOM (defaults to Brixton.BUILD-SNAPSHOT)
    -h where is your docker host? (defaults to &#39;127.0.0.1&#39; - provide your docker-machine host here)
    -r is brewery repo already in place and needs to be reset? (defaults to not resetting of repo)
</code></pre>
<p>一旦运行脚本，便会克隆啤酒厂应用程序，并使用正确的lib版本构建该文件并执行正确的测试。</p>
</blockquote>
<p>因此，如果要运行测试，只需复制以下代码即可：</p>
<pre><code class="prettyprint">git clone https://github.com/spring-cloud-samples/brewery.git
ln -s brewery/acceptance-tests/scripts/runDockerAcceptanceTests.sh  .
bash runDockerAcceptanceTests.sh -t SLEUTH
</code></pre>
<p>如果您是Mac用户，则最后一行应该是这样（例如192.168.50.60是您的docker-machine IP）</p>
<pre><code class="prettyprint">bash runDockerAcceptanceTests.sh -t SLEUTH -h 192.168.50.60
</code></pre>
<p>如果您的依赖项已下载了所有构建，则测试的下载和运行最多需要5分钟。</p>
<p>如果已经设置了所有应用程序，则可以手动运行验收测试。有关详细信息，请参阅下一部分。</p><h2><a href="#how-do-the-tests-look-like-and-how-to-run-them" class="anchor" name="how-do-the-tests-look-like-and-how-to-run-them"></a>测试看起来如何以及如何运行？</h2>
<p>验收测试位于啤酒厂的<a href="https://github.com/spring-cloud-samples/brewery/tree/master/acceptance-tests">验收测试</a> Gradle模块下。您可以运行它们</p>
<ul>
<li>从IDE（记住要通过适当的<code>-DWHAT_TO_TEST</code>系统参数）</li>
<li>来自Gradle（SLEUTH的示例） <code>./gradlew :acceptance-tests:acceptanceTests -DWHAT_TO_TEST=SLEUTH</code> ）<ul>
<li>如果您在Mac上运行，则必须另外通过<code>-DLOCAL_URL=192.168.60.50</code>参数在哪里<code>192.168.60.50</code>是您的docker-machine的IP。</li>
</ul>
</li>
</ul>
<p>测试使用Groovy和<a href="https://spockframework.github.io/spock/docs/1.0/">Spock框架</a>编写。如果您从未听说过Spock，现在是时候开始在项目中使用它了。检出<a href="https://github.com/spring-cloud-samples/brewery/blob/master/acceptance-tests/src/test/groovy/io/spring/cloud/samples/brewery/acceptance/SleuthBreweryAcceptanceSpec.groovy">Github代码</a>以及啤酒厂使用的Spock测试示例。</p>
<p>如果将Spock与<a href="https://github.com/renatoathaydes/spock-reports">Spock报告</a>结合使用，则可以得到非常不错的BDD，如测试输出</p>
<p><img src="https://raw.githubusercontent.com/spring-cloud-samples/brewery/master/img/Spock_reports.png" alt="spock_reports"></p><h1><a href="#are-end-to-end-tests-a-silver-bullet" class="anchor" name="are-end-to-end-tests-a-silver-bullet"></a>端到端测试是灵丹妙药吗？</h1>
<p>看起来一切都很棒，但实际上并非如此。端到端测试有其良好的一面，但肯定也有很多不利的一面。那些是：</p>
<ul>
<li>较长的反馈周期（您必须等待5分钟左右才能查看测试是否通过）</li>
<li>难以调试（您有大约8个可能会中断的应用程序-您必须检查每个应用程序的日志以查看出了什么问题）</li>
<li>网络问题和随机故障（这是最坏的情况，通常是随机的-突然数据包被破坏，Zipkin服务器没有收到对于测试通过至关重要的跨度……）</li>
<li>测试代码位于测试库之外（幸运的是，测试代码没有更改，但是将与应用程序相关的所有代码都放在一个存储库中会更好）</li>
</ul>
<p>当前的设置适合我们的需求，但实际上，我们希望进一步改进。因此，我们正在考虑对当前测试方法进行一些改进。</p><h1><a href="#what-rsquo-s-next" class="anchor" name="what-rsquo-s-next"></a>下一步是什么？</h1>
<p>当前，端到端测试与Travis上的构建一起执行。但…</p>
<ul>
<li>最终，我们计划使这些测试仅在周期性的基础上在CI服务器中运行。</li>
<li>我们将把端到端测试的一部分作为集成测试移到给定的库中，以便调试任何问题都更加容易</li>
<li>我们想要扩展测试，以便它们也可以在Cloud Foundry上执行</li>
</ul>
<p>目的是从库的代码库执行的测试中获得更快的反馈。我们也希望我们的集成测试更加可靠。</p><h1><a href="#summary" class="anchor" name="summary"></a>摘要</h1>
<p>在这篇文章中，您可以看到：</p>
<ul>
<li>如何酿造啤酒</li>
<li>一种使用Docker，Docker Compose，Travis，Bash脚本和Gradle测试开源库的方法</li>
<li>端到端测试的优缺点</li>
<li>Spring Cloud团队测试其库的长期计划是什么</li>
<li>敏捷的工作方式（我们有一种测试方法-e2e测试-但我们知道它的缺点，并且我们正在迭代地计划迁移到更好的解决方案）</li>
</ul><h1><a href="#updates" class="anchor" name="updates"></a>更新</h1>
<p>[15.01.2016]现在，执行e2e测试要容易得多：</p>
<pre><code class="prettyprint">git clone https://github.com/spring-cloud-samples/brewery.git
cd brewery
bash runAcceptanceTests.sh -t SLEUTH
</code></pre>
<p>没有更多的符号链接（和更少的docker-compose）！</p>
<p>如果您想运行测试并最终杀死所有应用程序，只需执行</p>
<pre><code class="prettyprint">git clone https://github.com/spring-cloud-samples/brewery.git
cd brewery
bash runAcceptanceTests.sh -t SLEUTH -k
</code></pre>
<p>还请查看Brewery项目自述文件是否有任何更改： <a href="https://github.com/spring-cloud-samples/brewery">https</a> : <a href="https://github.com/spring-cloud-samples/brewery">//github.com/spring-cloud-samples/brewery</a></p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 2334;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>请启用JavaScript以查看<a href="http://disqus.com/?ref_noscript">由Disqus提供</a>的<a href="http://disqus.com/?ref_noscript">评论。</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">由<span class="logo-disqus">Disqus</span>提供动力的评论</a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>背部</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">所有帖子</a> <a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">工程</a> <a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">发布</a> <a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">新闻与活动</a> <a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>将The Spring Team的更新发送到您的收件箱</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">球队</a></li>
<li><a href="/tools">工具类</a></li>
<li><a href="https://store.pivotal.io/">商店</a></li>
<li><a href="/blog">通讯</a></li>
</ul>
</div>
</div>© <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a> ，Inc.保留所有权利。
<a href="https://pivotal.io/terms-of-use">使用条款</a> • <a href="https://pivotal.io/privacy-policy">隐私</a> • <a href="/trademarks">商标准则</a>
<div id="teconsent" style="display:inline-block"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>