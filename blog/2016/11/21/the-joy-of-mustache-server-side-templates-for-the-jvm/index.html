<html dir="ltr" data-code-prettify="" data-mobile-support="" data-search="" lang="zh-Hans"><head>
<title>小胡子的喜悦：JVM的服务器端模板</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>System.config({baseURL: "/b92013b"});</script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>System.import('app/main.js')</script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="The Joy of Mustache: Server Side Templates for the JVM">
<meta name="twitter:description" content="<div class=" paragrap="="> 
 </head><body dir="ltr"><p>I don’t do much server-side templating, but when I do…​ well frankly, I tend to forget things. Every template language has its strengths and weaknesses, and they all have syntax to remember, and more frequently to forget. Recently I completed some work on the old <a href="https://github.com/spring-projects/spring-petclinic">Spring Petclinic</a>, converting it to use <a href="http://www.thymeleaf.org/">Thymeleaf</a> in the view layer, and re-organizing the code to be a bit more "modern". I enjoyed working with Thymeleaf 3, and found it a pleasant experience, but had to spend a lot of time scanning documentation and samples. Then I had another little project that needed some templates, and I remembered my fondness for <a href="http://mustache.github.com">Mustache</a>, which we added to Spring Boot back in version 1.2, and which plays an important role in the excellent <a href="https://github.com/spring-projects/spring-restdocs">Spring REST Docs</a> tool. I added <code>spring-boot-starter-mustache</code> to my new project, and was up and running within seconds.</p> 

">
<meta name="twitter:creator" content="@david_syer">
<meta name="twitter:image:src" content="https://gravatar.com/avatar/ae671230e3a1c2a0eefa7604990084f1?s=200">

<meta property="og:title" content="The Joy of Mustache: Server Side Templates for the JVM">
<meta property="og:image" content="https://gravatar.com/avatar/ae671230e3a1c2a0eefa7604990084f1?s=200">
<meta property="og:description" content="<div class=" paragrap="="> 
 <p>I don’t do much server-side templating, but when I do…​ well frankly, I tend to forget things. Every template language has its strengths and weaknesses, and they all have syntax to remember, and more frequently to forget. Recently I completed some work on the old <a href="https://github.com/spring-projects/spring-petclinic">Spring Petclinic</a>, converting it to use <a href="http://www.thymeleaf.org/">Thymeleaf</a> in the view layer, and re-organizing the code to be a bit more "modern". I enjoyed working with Thymeleaf 3, and found it a pleasant experience, but had to spend a lot of time scanning documentation and samples. Then I had another little project that needed some templates, and I remembered my fondness for <a href="http://mustache.github.com">Mustache</a>, which we added to Spring Boot back in version 1.2, and which plays an important role in the excellent <a href="https://github.com/spring-projects/spring-restdocs">Spring REST Docs</a> tool. I added <code>spring-boot-starter-mustache</code> to my new project, and was up and running within seconds.</p> 

">
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2016-11-21 10:46:00.0">



<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">// Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }</script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">小胡子的喜悦：JVM的服务器端模板</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/ae671230e3a1c2a0eefa7604990084f1?s=20&d=mm"> <a class="author" rel="author" href="/team/dsyer">戴夫·瑟</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2016-11-21 10:46:00.0">2016年11月21日</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2016/11/21/the-joy-of-mustache-server-side-templates-for-the-jvm#disqus_thread" data-disqus-identifier="2701">
</a></div>
</div>
</header>
<div class="blog--post"><div class="paragraph">
<p>我并没有做太多服务器端模板的工作，但是当我这样做时......坦率地说，我倾向于忘记一些事情。每种模板语言都有其优点和缺点，并且都有记住的语法，更经常要忘记的语法。最近，我完成了旧的<a href="https://github.com/spring-projects/spring-petclinic">Spring Petclinic的</a>一些工作，将其转换为在视图层中使用<a href="http://www.thymeleaf.org/">Thymeleaf</a> ，并重新组织了代码以使其更具“现代性”。我喜欢与Thymeleaf 3一起工作，感到很愉快，但是不得不花很多时间扫描文档和样本。然后，我有了另一个需要一些模板的小项目，我想起了我对<a href="https://mustache.github.com">Mustache的</a>爱好，我们在1.2版中将其添加到Spring Boot中，并且在出色的<a href="https://github.com/spring-projects/spring-restdocs">Spring REST Docs</a>工具中起着重要的作用。我在新项目中添加了<code>spring-boot-starter-mustache</code> ，并在几秒钟内启动并运行。</p>
</div>
<div class="paragraph">
<p>我想向您展示什么是<a href="https://github.com/samskivert/jmustache">JMustache</a>整洁的小工具，用于服务器端HTML渲染（或其他纯文本格式）。我一直喜欢<a href="https://mustache.github.com/">Moustache的</a>原因在于它的简单性-它“足够”的模板-如果您必须在JVM中渲染模板，您真的不希望有一个比这个更干净，更精简，更轻量的库。有一个jar文件没有依赖性，它为您的类路径增加了78kb，这不会伤害任何人，并且会在很多脸上露出微笑。它具有很少的功能，对于不记得语法的人来说非常有用，并且该手册简短，全面，易读且有用。</p>
</div>
<div class="paragraph">
<p>如果继续阅读，当我们构建示例应用程序时，您将看到如何使用Mustache构建HTML页面，呈现静态和动态内容，构建表单和菜单以及将页面布局抽象为单独的组件。Mustache的简单性令人眼前一亮，并指导您将逻辑放入Java中，并保持模板尽可能整洁。作为侧边栏，您将了解如何以一种稍微不寻常但有趣的方式使用自定义登录表单保护应用程序的安全。</p>
</div>
<div class="sect1">
<h2 id="sample-code"><a class="anchor" href="#sample-code"></a>样例代码</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/dsyer/mustache-sample">GitHub上</a>的文本后面有一些示例代码。这是一个很小的Spring MVC应用程序，也使用Spring Security。如果您希望看到它与文本一起逐步发展，可以使用一些标签：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>“基础”是工作应用程序的起点</p>
</li>
<li>
<p>“包含”使用页眉和页脚创建可重复使用的布局</p>
</li>
<li>
<p>“布局”是使用Moustache lambda进行的稍微高级的实现</p>
</li>
<li>
<p>“菜单”使用更多的Spring Boot和Mustache功能添加了更多UI元素</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>在每个阶段，您都可以签出标签并运行该应用程序。在项目的根目录中有一个Maven包装器，因此您可以从命令行构建和运行它，例如</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code>$ git clone https://github.com/dsyer/mustache-sample
$ cd mustache-sample
$ git checkout base
$ ./mvnw spring-boot:run</code></pre>
</div>
</div>
<div class="paragraph">
<p>可以从命令行将项目导入到您最喜欢的IDE中，然后在<code>DemoApplication</code>运行main方法，而<code>DemoApplication</code> 。</p>
</div>
<div class="paragraph">
<p>该应用程序在<a href="http://localhost:8080" class="bare">http：// localhost：8080上运行</a> ，您可以使用任何用户名和密码（甚至为空！）进行身份验证。示例应用程序中没有真正的功能，但是它确实具有登录和注销功能以及一个主页，以提供一些挂钩来显示模板功能。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started"><a class="anchor" href="#getting-started"></a>入门</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://projects.spring.io/spring-boot/">Spring Boot</a>具有对JMustache的自动配置支持，因此很容易通过Spring MVC应用程序启动和运行。您可以从<a href="https://start.spring.io">Spring Initializr</a>生成一个项目，并要求它提供<code>spring-boot-starter-mustache</code> 。</p>
</div>
<div class="paragraph">
<p>Spring Boot自动为JMustache配置一个<code>ViewResolver</code> ，因此您可以通过提供一个返回视图名称的控制器来实现主页。</p>
</div>
<div class="listingblock">
<div class="title">HomeController.java</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Controller
class HomeController {
  @GetMapping("/")
  String home() {
    return "index";
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>使用此控制器，当用户访问主页（“ /”）时，Spring将在<code>classpath:/templates/index.html</code>渲染模板，这意味着在项目的目录<code>src/main/resources/templates</code>中。例如，您可以将其放入并确认其有效：</p>
</div>
<div class="listingblock">
<div class="title">index.html</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-html" data-lang="html"><!doctype html>
<html lang="en">
  <body>
    <h1>Demo</h1>
    <div>Hello World</div>
  </body>
</html></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="make-the-application-secure"><a class="anchor" href="#make-the-application-secure"></a>使应用程序安全</h3>
<div class="paragraph">
<p>那里还没有动态（模板）内容。让我们确保应用安全并添加登录表单，这时您将需要动态内容。因此，将<code>spring-cloud-starter-security</code>到您的依赖项中，主页将被自动保护。假设您希望在“ / login”处有一个登录表单，因此需要控制器：</p>
</div>
<div class="listingblock">
<div class="title">LoginController.java</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Controller
@RequestMapping("/login")
class LoginController {

	@GetMapping
	public String form() {
		return "login";
	}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>您还需要一些基本的安全配置，如果您从Spring Security扩展基类，则可以将其作为方法添加到主应用程序中：</p>
</div>
<div class="listingblock">
<div class="title">DemoApplication.java</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@SpringBootApplication
public class DemoApplication extends WebSecurityConfigurerAdapter {

  @Override
  protected void configure(HttpSecurity http) throws Exception {
    http.authorizeRequests()
          .antMatchers("/login", "/error").permitAll()
          .antMatchers("/**").authenticated()
        .and().exceptionHandling()
          .authenticationEntryPoint(new LoginUrlAuthenticationEntryPoint("/login"));
  }

}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">注意</div>
</td>
<td class="content">这是用于表单登录的稍微非常规的配置，因为它没有使用内置的<code>formLogin()</code> ，后者会自动添加身份验证入口点。如果是这样的分心然后跳到下一个部分，只需添加<code>.formLogin()</code>到您的配置，而不是<code>exceptionHandling()</code>以上（后一切<code>.and()</code></td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="custom-authentication-processing-with-spring-mvc"><a class="anchor" href="#custom-authentication-processing-with-spring-mvc"></a>使用Spring MVC进行自定义身份验证处理</h3>
<div class="paragraph">
<p>Spring Security使用<code>Filter</code>实现表单登录（以及其他所有功能），这就是内置<code>formLogin()</code>配置<code>formLogin()</code> 。只是为了使事情变得有趣，您将在Spring MVC处理程序中进行身份验证，使您能够添加一些自定义逻辑，并且MVC比过滤器更易于使用。</p>
</div>
<div class="paragraph">
<p>因此，让我们用一种处理用户名/密码身份验证的方法扩展<code>LoginController</code> （很容易扩展到更复杂的逻辑）。它需要做的主要事情是验证输入，如果它是真实用户，则填充<code>SecurityContext</code> ：</p>
</div>
<div class="listingblock">
<div class="title">LoginController.java</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@PostMapping
public void authenticate(@RequestParam Map<String, String> map) throws Exception {
  Authentication result = new UsernamePasswordAuthenticationToken(
      map.get("username"), "N/A",
      AuthorityUtils.commaSeparatedStringToAuthorityList("ROLE_USER"));
  SecurityContextHolder.getContext().setAuthentication(result);
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">注意</div>
</td>
<td class="content">在这个简单的示例中，只有一条“幸福之路”-所有用户都已通过身份验证。显然，这不是一个非常安全的身份验证过程，您可能希望在真实控制器中抛出<code>AuthenticationException</code> ，例如<code>BadCredentialsException</code> 。异常将由Spring Security处理。
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>为了模仿内置的Spring Security登录表单的行为，您还需要能够重定向到用户在登录之前尝试访问的“保存的请求”。Spring Security为此提供了一个<code>AuthenticationSuccessHandler</code>抽象，以及一个了解已保存请求的简单实现。因此， <code>authenticate</code>方法可以使用它（它需要servlet请求和响应，您可以将它们添加为方法参数，Spring MVC将注入它们）：</p>
</div>
<div class="listingblock">
<div class="title">LoginController.java</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">private AuthenticationSuccessHandler handler = new SavedRequestAwareAuthenticationSuccessHandler();

@PostMapping
public void authenticate(@RequestParam Map<String, String> map,
    HttpServletRequest request, HttpServletResponse response) throws Exception {
  // ... authenticate user from request parameters
  handler.onAuthenticationSuccess(request, response, result);
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="the-login-form"><a class="anchor" href="#the-login-form"></a>登录表格</h3>
<div class="paragraph">
<p>现在您准备好接受身份验证请求，您需要一个供用户填写和提交的表格。该<code>LoginController</code>呈现的“登录”模板，所以你需要一个“login.html的”添加到您的模板文件夹。例如：</p>
</div>
<div class="listingblock">
<div class="title">login.html</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-html" data-lang="html"><!doctype html>
<html lang="en">
<body>
  <h1>Login</h1>
  <form action="/login" method="post">                            <b class="conum">(1)</b>
    <label for="username">Username:</label>
    <input type="text" name="username" />                         <b class="conum">(2)</b>
    <label for="password">Password:</label>
    <input type="password" name="password" />                     <b class="conum">(3)</b>
    <input type="hidden" name="_csrf" value="{{_csrf.token}}" />  <b class="conum">(4)</b>
    <button type="submit" class="btn btn-primary">Submit</button>
  </form>
</body>
</html></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>带有提交按钮的表单，用于将内容发送到“ POST / login”</p>
</li>
<li>
<p>用户名字段输入</p>
</li>
<li>
<p>密码字段输入</p>
</li>
<li>
<p>CSRF令牌，采用Spring Security要求的格式。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>CSRF令牌是您的第一份动态内容，它向您展示Mustache的工作原理，以及附带的为什么将其称为“ Mustache”。来自“上下文”（在本例中为Spring MVC模型对象）的变量可以使用双括号或“小括号”（ <code>{{</code>和<code>}}</code> ）进行呈现。JMustache还在变量内导航对象图，因此<code>_csrf.token</code>解析为“ _csrf”对象的“ token”属性。</p>
</div>
<div class="paragraph">
<p>Spring Security将“ _csrf”对象放入请求属性中。要将其复制到MVC模型，您需要在<code>application.properties</code>进行设置：</p>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-properties" data-lang="properties">spring.mustache.expose-request-attributes=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>完成所有操作后，您应该发现在浏览器中访问该应用程序时将首先重定向到“ / login”。由于处理程序中的验证逻辑较弱（不存在），因此您可以在表单中放入任何您喜欢的内容，然后提交它以查看主页。</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<div class="title">注意</div>
</td>
<td class="content">在示例应用程序中，我们通过webjars导入了一些样式表，以使应用程序看起来更好一些，但它们并未向功能添加任何内容。
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>该示例代码具有一个“基本”标签，该标签是具有到目前为止我们所看到的所有功能的应用程序。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="layout-abstractions-using-includes"><a class="anchor" href="#layout-abstractions-using-includes"></a>布局抽象：使用包含</h2>
<div class="sectionbody">
<div class="paragraph">
<p>我们的应用程序中只有2页，但是即使代码量很小，HTML中也会有很多重复。将所有页面的一些常见元素提取到可重复使用的模板中很有用。一种方法是使用“包含”。因此，我们可以将顶部和底部的内容提取到“ header.html”中：</p>
</div>
<div class="listingblock">
<div class="title">header.html</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-html" data-lang="html"><!doctype html>
<html lang="en">
<body></code></pre>
</div>
</div>
<div class="paragraph">
<p>和“ footer.html”</p>
</div>
<div class="listingblock">
<div class="title">footer.html</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-html" data-lang="html"></body>
</html></code></pre></div></div></div></div></div></div></article></div></div></div></div>

}} {{> header}}<h1>演示版</h1>
    <div>你好，世界</div>{{> footer}} {{！


{{{layout.body}}}


  <title>{{{layout.title}}}</title>

{{{layout.body}}}


  <title>{{{layout.title}}}</title>


  <form id="logout" action="/logout" method="post">
    <input type="hidden" name="_csrf" value="{{_csrf.token}}">
    <button type="submit" class="btn btn-primary">登出</button>
  </form> {{{layout.body}}}


  <title>{{{layout.title}}}</title>


  <ul class="nav nav-pills" role="tablist">{{#menus}}<li><a href="{{path}}">{{名称}}</a></li>{{/ menus}}<li><a href="#" onclick="document.getElementById('#logout').submit()">登出</a></li>
  </ul>{{{layout.body}}} <form id="logout" action="/logout" method="post">
    <input type="hidden" name="_csrf" value="{{_csrf.token}}">
  </form>

</body></html>