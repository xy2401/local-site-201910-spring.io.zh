<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Custom test slice with Spring Boot 1.4</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Custom test slice with Spring Boot 1.4" />
<meta name="twitter:description" content="&lt;p&gt;Spring Boot 1.4 includes a major overhaul of testing support and one of these features is &lt;em&gt;test slicing&lt;/em&gt;. I’d like to take the opportunity in this blog post to further explain what it is and how you can easily create your own slices.&lt;/p&gt;
&lt;p&gt;Test slicing is about segmenting the &lt;code&gt;ApplicationContext&lt;/code&gt; that is created for your test. Typically, if you want to test a controller using &lt;code&gt;MockMvc&lt;/code&gt;, surely you don’t want to bother with the data layer. Instead you’d probably want to &lt;em&gt;mock&lt;/em&gt; the service that your controller uses and validate that all the web-related interaction works as expected. This can be summarized in the example below:&lt;/p&gt;
" />
<meta name="twitter:creator" content="@snicoll" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/33d0963a20138828608f3f61927545b8?s=200" />

<meta property="og:title" content="Custom test slice with Spring Boot 1.4" />
<meta property="og:image" content="https://gravatar.com/avatar/33d0963a20138828608f3f61927545b8?s=200" />
<meta property="og:description" content="&lt;p&gt;Spring Boot 1.4 includes a major overhaul of testing support and one of these features is &lt;em&gt;test slicing&lt;/em&gt;. I’d like to take the opportunity in this blog post to further explain what it is and how you can easily create your own slices.&lt;/p&gt;
&lt;p&gt;Test slicing is about segmenting the &lt;code&gt;ApplicationContext&lt;/code&gt; that is created for your test. Typically, if you want to test a controller using &lt;code&gt;MockMvc&lt;/code&gt;, surely you don’t want to bother with the data layer. Instead you’d probably want to &lt;em&gt;mock&lt;/em&gt; the service that your controller uses and validate that all the web-related interaction works as expected. This can be summarized in the example below:&lt;/p&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2016-08-30 09:31:12.489" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Custom test slice with Spring Boot 1.4</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/33d0963a20138828608f3f61927545b8?s=20&amp;d=mm" />
<a class="author" rel="author" href="/team/snicoll">Stéphane Nicoll</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2016-08-30 09:31:12.489">August 30, 2016</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="2590" href="/blog/2016/08/30/custom-test-slice-with-spring-boot-1-4#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><p>Spring Boot 1.4 includes a major overhaul of testing support and one of these features is <em>test slicing</em>. I&rsquo;d like to take the opportunity in this blog post to further explain what it is and how you can easily create your own slices.</p>
<p>Test slicing is about segmenting the <code>ApplicationContext</code> that is created for your test. Typically, if you want to test a controller using <code>MockMvc</code>, surely you don&rsquo;t want to bother with the data layer. Instead you&rsquo;d probably want to <em>mock</em> the service that your controller uses and validate that all the web-related interaction works as expected. This can be summarized in the example below:</p>
<pre><code class="prettyprint java">@RunWith(SpringRunner.class)
@WebMvcTest(UserVehicleController.class)
public class UserVehicleControllerTests {

    @Autowired
    private MockMvc mvc;

    @MockBean
    private UserVehicleService userVehicleService;

    @Test
    public void testExample() throws Exception {
        given(this.userVehicleService.getVehicleDetails(&quot;sboot&quot;))
                .willReturn(new VehicleDetails(&quot;Honda&quot;, &quot;Civic&quot;));
        this.mvc.perform(get(&quot;/sboot/vehicle&quot;).accept(MediaType.TEXT_PLAIN))
                .andExpect(status().isOk()).andExpect(content().string(&quot;Honda Civic&quot;));
    }

}
</code></pre>
<p><code>@WebMvcTest</code> is the web test slice in Spring Boot 1.4. When it is present, you instruct Spring Boot that a web environment is required and that only the specified controller(s) should be instantiated. Because it knows about the nature of the test, it can take additional smart decisions for you (e.g. auto-configure <code>MockMvc</code> so that all that&rsquo;s left is to inject it). Also, your controller has a dependency towards <code>UserVehicleService</code> so starting the context would lead to a failure because the <code>ApplicationContext</code> doesn&rsquo;t know about it (remember, only the web infrastructure and <code>UserVehicleController</code> are known). <code>@MockBean</code> is used here to register a <code>UserVehicleService</code> mock so that it can be transparently injected in the controller.</p>
<p>Let&rsquo;s now have a look to the implementation to better understand how Spring Boot manages this for you. Our first stop is <code>@WebMvcTest</code> (removing <code>@Target</code> and friends for brievety):</p>
<pre><code class="prettyprint java">@BootstrapWith(WebMvcTestContextBootstrapper.class)
@OverrideAutoConfiguration(enabled = false)
@TypeExcludeFilters(WebMvcTypeExcludeFilter.class)
@AutoConfigureCache
@AutoConfigureWebMvc
@AutoConfigureMockMvc
@ImportAutoConfiguration
public @interface WebMvcTest { ... }
</code></pre>
<p>This declaration can be split in 3 areas:</p>
<ul>
<li>Auto-configuration customizations</li>
<li>Classpath scanning tuning</li>
<li>Test bootstrap</li>
</ul><h2><a href="#auto-configuration-customizations" class="anchor" name="auto-configuration-customizations"></a>Auto-configuration customizations</h2>
<p>Spring Boot 1.4 now defines a <code>spring-boot-test-autoconfigure</code> module that provides a collection of test-related auto-configurations. These auto-configurations are composable and can help you crafting your own infrastructure easily. </p>
<p>Back to <code>@WebMvcTest</code>, the first thing we want to do is to disable the default auto-configuration: <code>OverrideAutoConfiguration</code> does that. Because the default auto-configuration is now disabled, you have to opt-in for the relevant auto-configurations you want to include. The three <code>AutoConfigure</code> annotations do that for us: they make sure that a web environment is available, <code>MockMvc</code> is configured and a no-op cache manager is available. Let&rsquo;s have a look to an excerpt of <code>AutoconfigureMockMvc</code>:</p>
<pre><code class="prettyprint java">@ImportAutoConfiguration
@PropertyMapping(&quot;spring.test.mockmvc&quot;)
public @interface AutoConfigureMockMvc {

    boolean addFilters() default true;

    @PropertyMapping(&quot;webclient.enabled&quot;)
    boolean webClientEnabled() default true;

    ...
}
</code></pre>
<p><code>@ImportAutoConfiguration</code> is an annotation that lists the auto-configurations that should be included. Alternatively, you can provide the list in <code>META-INF/spring.factories</code> using the fully qualified name of the annotation for the key. This is what&rsquo;s defined for <code>AutoConfigureMockMvc</code>:</p>
<pre><code class="prettyprint">org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc=\
org.s.boot.test.autoconfigure.web.servlet.MockMvcAutoConfiguration,\
org.s.boot.test.autoconfigure.web.servlet.MockMvcSecurityAutoConfiguration,\
org.s.boot.test.autoconfigure.web.servlet.MockMvcWebClientAutoConfiguration,\
org.s.boot.test.autoconfigure.web.servlet.MockMvcWebDriverAutoConfiguration
</code></pre>
<p>You get the idea: each annotation brings some auto-configurations and you can compose them any way you want. You&rsquo;ll notice that <code>WebMvcTest</code> has also a <code>ImportAutoConfiguration</code> but there&rsquo;s no entry in <code>spring.factories</code> for it. Spring Boot will scan all <code>spring.factories</code> in the classpath and <em>merge</em> the content if necessary. If a module of yours wants to add additional behaviour to <code>@WebMvcTest</code> (or <code>@AutoConfigureMockMvc</code>), all that&rsquo;s required is to create a <code>META-INF/spring.factories</code> and register additional auto-configuration classes. You can also use <code>@AutoconfigureBefore</code> and <code>@AutoconfigureAfter</code> to order them.</p>
<p>Test auto-configurations are configurable as usual: the <code>@PropertyMapping</code> annotation at class-level maps the attributes of the annotation to the <code>Environment</code> so that the auto-configuration code can extract the value and adapt the configuration accordingly. We can see the <code>webClientEnabled</code> attribute above is transparently used in the auto-configuration:</p>
<pre><code class="prettyprint java">@ConditionalOnProperty(prefix = &quot;spring.test.mockmvc.webclient&quot;, 
        name = &quot;enabled&quot;, matchIfMissing = true)
public class MockMvcWebClientAutoConfiguration { ... }
</code></pre><h2><a href="#classpath-scanning-tuning" class="anchor" name="classpath-scanning-tuning"></a>Classpath scanning tuning</h2>
<p><code>TypeExcludeFilters</code> is a way to tune classpath scanning. In the case of <code>@WebMvcTest</code> we&rsquo;re only going to <a href="https://github.com/spring-projects/spring-boot/blob/bbc91cc03f5df31c1985811d07abe4f9a906355e/spring-boot-test-autoconfigure/src/main/java/org/springframework/boot/test/autoconfigure/web/servlet/WebMvcTypeExcludeFilter.java">include certain web-related components</a> and ignore all the rest. This is quite powerful as you can use classpath scanning the usual way and only include what&rsquo;s required for your slice.</p><h2><a href="#test-bootstrap" class="anchor" name="test-bootstrap"></a>Test bootstrap</h2>
<p>Finally, the new test bootstrap makes sure to identify the <code>@SpringBootApplication</code> annotated class in your project (unless one is specified). This is a nice default as you don&rsquo;t have to specify it anymore and classpath scanning will be right <em>by default</em>.</p><h2><a href="#creating-your-own-slice" class="anchor" name="creating-your-own-slice"></a>Creating your own slice</h2>
<p>Based on this knowledge, creating your own slice is actually pretty easy. An example of such slice could be a new <code>DataJdbcTest</code>, a slice similar to <code>DataJpaTest</code> that only configures <code>JdbcTemplate</code> and does not use JPA. If you want to play with the code right the way, check the <a href="https://github.com/snicoll-scratches/demo-data-jdbc-test">github repository</a> for more details.</p>
<p>Our first step is to create <code>@AutoconfigureDataJdbc</code></p>
<pre><code class="prettyprint java">package com.example.test.autoconfigure.jdbc;

import java.lang.annotation.*;
import org.springframework.boot.autoconfigure.ImportAutoConfiguration;

@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@ImportAutoConfiguration
public @interface AutoconfigureDataJdbc {
}
</code></pre>
<p>and register the relevant auto-configurations to apply when this annotation is present. Again, create a <code>META-INF/spring.factories</code> resource:</p>
<pre><code class="prettyprint">com.example.test.autoconfigure.jdbc.AutoconfigureDataJdbc=\
org.s.boot.autoconfigure.flyway.FlywayAutoConfiguration,\
org.s.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,\
org.s.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration,\
org.s.boot.autoconfigure.jdbc.JdbcTemplateAutoConfiguration,\
org.s.boot.autoconfigure.liquibase.LiquibaseAutoConfiguration,\
org.s.boot.autoconfigure.transaction.TransactionAutoConfiguration
</code></pre>
<p>Once that reusable infrastructure is in place, you can create your test slice and simply specify that you need a database and jdbc:</p>
<pre><code class="prettyprint java">@BootstrapWith(SpringBootTestContextBootstrapper.class)
@OverrideAutoConfiguration(enabled = false)
@TypeExcludeFilters(DataJdbcTypeExcludeFilter.class)
@Transactional
@AutoConfigureCache
@AutoconfigureDataJdbc
@AutoConfigureTestDatabase
@ImportAutoConfiguration
public @interface DataJdbcTest { }
</code></pre>
<p><a href="https://github.com/snicoll-scratches/demo-data-jdbc-test/blob/d0c0eaaecfc048a7543a86f3e9c91804eabad6e0/src/main/java/com/example/test/autoconfigure/jdbc/DataJdbcTypeExcludeFilter.java#L13"><code>DataJdbcTypeExcludeFilter</code></a> makes sure to exclude all your other services as such test shouldn&rsquo;t require any of your beans by default. It could be improve to allow services to be defined as a parameter of the annotation, pretty much like <code>WebMvcTest</code> adds specified controller(s).</p>
<p>Once you&rsquo;ve done that, you only need to add your annotation and your <code>JdbcTemplate</code> is auto-configured for you with a test database:</p>
<pre><code class="prettyprint java">@RunWith(SpringRunner.class)
@DataJdbcTest
public class DataJdbcSampleTests {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    ...
}
</code></pre><h2><a href="#summary" class="anchor" name="summary"></a>Summary</h2>
<p>Spring Boot 1.4 brings auto-configuration to your tests and allows you to easily compose your own test annotations. In this article we&rsquo;ve seen how <code>WebMvcTest</code> works and how you could create your own &ldquo;jdbc&rdquo; slice. We&rsquo;re actually <a href="https://github.com/spring-projects/spring-boot/issues/6563">considering adding that annotation in the next release</a> so please <a href="gitter.im/spring-projects/spring-boot">keep the feedback coming</a>!</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 2590;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>