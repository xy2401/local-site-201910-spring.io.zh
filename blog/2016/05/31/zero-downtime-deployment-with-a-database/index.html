<html dir="ltr" data-code-prettify="" data-mobile-support="" data-search=""><head>
<title>数据库零停机部署</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>System.config({baseURL: "/b92013b"});</script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>System.import('app/main.js')</script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="Zero Downtime Deployment with a Database">
<meta name="twitter:description" content="<div class=" paragrap="="> 
 </head><body dir="ltr"><p>This article will explain in depth how to tackle issues related to database compatibility and the deployment process. We will present what can happen with your production applications if you try to perform such a deployment unprepared. We will then walk through the steps in the lifecycle of an application that are necessary to have zero downtime. The result of our operations will be applying a backward incompatible database change in a backward compatible way.</p> 

<div class="paragraph"> 
 <p>If you want to work through the code samples below, you will find everything you need in <a href="https://github.com/spring-cloud-samples/zero-downtime-deployment">GitHub</a>.</p> 
</div>
">
<meta name="twitter:creator" content="@mgrzejszczak">
<meta name="twitter:image:src" content="https://gravatar.com/avatar/d4b43000c99fccc46455f42a841fa62e?s=200">

<meta property="og:title" content="Zero Downtime Deployment with a Database">
<meta property="og:image" content="https://gravatar.com/avatar/d4b43000c99fccc46455f42a841fa62e?s=200">
<meta property="og:description" content="<div class=" paragrap="="> 
 <p>This article will explain in depth how to tackle issues related to database compatibility and the deployment process. We will present what can happen with your production applications if you try to perform such a deployment unprepared. We will then walk through the steps in the lifecycle of an application that are necessary to have zero downtime. The result of our operations will be applying a backward incompatible database change in a backward compatible way.</p> 

<div class="paragraph"> 
 <p>If you want to work through the code samples below, you will find everything you need in <a href="https://github.com/spring-cloud-samples/zero-downtime-deployment">GitHub</a>.</p> 
</div>
">
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2016-05-31 09:09:00.0">



<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">// Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }</script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">数据库零停机部署</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/d4b43000c99fccc46455f42a841fa62e?s=20&d=mm"> <a class="author" rel="author" href="/team/marcingrzejszczak">马尔辛·格热兹扎克（Marcin Grzejszczak）</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2016-05-31 09:09:00.0">2016年5月31日</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2016/05/31/zero-downtime-deployment-with-a-database#disqus_thread" data-disqus-identifier="2513">
</a></div>
</div>
</header>
<div class="blog--post"><div class="paragraph">
<p>本文将深入解释如何解决与数据库兼容性和部署过程有关的问题。如果您尝试不准备执行这种部署，我们将介绍生产应用程序可能发生的情况。然后，我们将逐步完成应用程序生命周期中为零停机所必需的步骤。我们的操作结果将以向后兼容的方式应用向后不兼容的数据库更改。</p>
</div>
<div class="paragraph">
<p>如果您想浏览下面的代码示例，则可以在<a href="https://github.com/spring-cloud-samples/zero-downtime-deployment">GitHub中</a>找到所需的一切。</p>
</div>
<div class="sect1">
<h2 id="_introduction">介绍</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_zero_downtime_deployment">零停机时间部署</h3>
<div class="paragraph">
<p>什么是<strong>零停机</strong>神话般的<strong>部署</strong> ？您可以说，如果您可以成功地将新版本的应用程序引入生产环境而又不让用户看到该应用程序已关闭，则可以通过这种方式部署您的应用程序。从用户和公司的角度来看，这是最佳的部署方案，因为可以引入新功能并且可以消除错误，而不会造成任何中断。</p>
</div>
<div class="paragraph">
<p>你怎么能做到？有很多方法，但是其中一种方法是：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>部署服务的版本1</p>
</li>
<li>
<p>将数据库迁移到新版本</p>
</li>
<li>
<p>与版本1并行部署服务的版本2</p>
</li>
<li>
<p>一旦您看到版本2像魅力一样工作，只需降低版本1</p>
</li>
<li>
<p>你完成了！</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>很简单，不是吗？不幸的是，这并非易事，我们稍后将重点介绍。现在，让我们检查另一个常见的部署过程，即蓝绿色部署。</p>
</div>
<div class="paragraph">
<p>您听说过<a href="http://martinfowler.com/bliki/BlueGreenDeployment.html">蓝绿色部署</a>吗？有了Cloud Foundry，这非常容易做到。只需查看<a href="https://spring.io/blog/2014/04/04/project-sagan-zero-downtime-deployments">本文</a> ，我们将对其进行更深入的描述。要快速回顾一下，进行蓝绿色部署很简单：</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="ulist">
<ul>
<li>
<p>维护您的生产环境的两个副本（“蓝色”和“绿色”）；</p>
</li>
<li>
<p>通过将生产URL映射到蓝色环境，将所有流量路由到蓝色环境；</p>
</li>
<li>
<p>在绿色环境中部署和测试对应用程序的任何更改；</p>
</li>
<li>
<p>通过将URL映射到绿色并将其从蓝色取消映射来“翻转开关”。</p>
</li>
</ul>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>蓝绿色部署是一种使您轻松引入新功能的方法，而不必担心某些东西会完全破坏生产。这是由于这样的事实，即使是这种情况，您也可以通过“翻转开关”轻松地回滚路由器以指向先前的环境。</p>
</div>
<div class="paragraph">
<p>阅读完以上所有内容后，您可能会问自己一个问题： <em>零停机部署与蓝绿色部署有什么关系？</em></p>
</div>
<div class="paragraph">
<p>嗯，它们有很多共同点，因为维护同一环境的两个副本会使支持该环境的工作加倍。这就是为什么某些团队，如<a href="http://martinfowler.com/bliki/BlueGreenDeployment.html">马丁·福勒</a> （ <a href="http://martinfowler.com/bliki/BlueGreenDeployment.html">Martin Fowler）所说</a> ，倾向于对这种方法进行变更：</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>另一种变化是使用相同的数据库，从而为Web和域层设置了蓝绿色的开关。</p>
</div>
<div class="paragraph">
<p>使用这种技术，数据库通常是一个挑战，尤其是当您需要更改架构以支持软件的新版本时。</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>在这里，我们得出了本文将要涉及的主要问题。<strong>数据库</strong> 。让我们再看一下这句话：</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>将数据库迁移到新版本</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>现在，您应该问自己一个问题-如果数据库更改向后不兼容怎么办？我的应用程序版本1不会爆炸吗？实际上，它将......</p>
</div>
<div class="paragraph">
<p>因此，即使零停机/蓝绿色部署带来的好处是巨大的，公司还是倾向于遵循这样更安全的部署应用程序的过程：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>使用新版本的应用程序准备软件包</p>
</li>
<li>
<p>关闭正在运行的应用程序</p>
</li>
<li>
<p>运行数据库迁移脚本</p>
</li>
<li>
<p>部署并运行新版本的应用程序</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>在本文中，我们将更深入地描述如何使用数据库和代码，以便从零停机时间部署中受益。</p>
</div>
</div>
<div class="sect2">
<h3 id="_database_issues">数据库问题</h3>
<div class="paragraph">
<p>如果您有一个无状态应用程序，该应用程序没有在数据库中存储任何数据，则可以立即开始零停机时间部署。不幸的是，大多数软件必须将数据存储在某个地方。这就是为什么在进行任何形式的更改之前必须三思而后行的原因。在详细介绍如何以可能零停机时间部署的方式更改模式之前，让我们首先关注模式版本控制。</p>
</div>
<div class="sect3">
<h4 id="_schema_versioning">模式版本控制</h4>
<div class="paragraph">
<p>在本文中，我们将使用<a href="http://flywaydb.org">Flyway</a>作为架构版本控制工具。自然地，我们还将编写一个对Flyway具有本机支持的Spring Boot应用程序，并将在应用程序上下文设置后执行模式迁移。使用Flyway时，您可以将迁移脚本存储在项目文件夹中（默认情况下在<code>classpath:db/migration</code> ）。在这里，您可以看到此类迁移文件的示例</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">└── db
 └── migration
     ├── V1__init.sql
     ├── V2__Add_surname.sql
     ├── V3__Final_migration.sql
     └── V4__Remove_lastname.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>在此示例中，我们可以看到4个迁移脚本，如果先前未执行，则将在应用程序启动时一个接一个地执行。让我们以其中一个文件（ <code>V1__init.sql</code> ）为例。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">CREATE TABLE PERSON (
	id BIGINT GENERATED BY DEFAULT AS IDENTITY,
	first_name varchar(255) not null,
	last_name varchar(255) not null
);

insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code></pre>
</div>
</div>
<div class="paragraph">
<p>这很容易解释：您可以使用SQL定义应如何更改数据库。有关Spring Boot和Flyway的更多信息， <a href="https://docs.spring.io/spring-boot/docs/1.3.5.RELEASE/reference/html/howto-database-initialization.html#howto-execute-flyway-database-migrations-on-startup">请查看Spring Boot Docs</a> 。</p>
</div>
<div class="paragraph">
<p>在Spring Boot中使用模式版本控制工具，您将获得2大好处。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>您将数据库更改与代码更改脱钩</p>
</li>
<li>
<p>数据库迁移与应用程序部署同时进行-简化了部署过程</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_solving_the_database_issue">解决数据库问题</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在本文的以下部分中，我们将重点介绍两种更改数据库的方法。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>向后不兼容</p>
</li>
<li>
<p>向下兼容</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>第一个将显示为警告，不要在没有任何准备的情况下尝试进行零停机时间部署。第二个将提出一个建议的解决方案，说明如何执行零停机时间部署并同时保持向后兼容性。</p>
</div>
<div class="paragraph">
<p>我们将要处理的项目将是一个简单的Spring Boot Flyway应用程序，其中的<code>Person</code>在数据库中具有<code>first_name</code>和<code>last_name</code> 。我们想将<code>last_name</code>列重命名为<code>surname</code> 。</p>
</div>
<div class="sect2">
<h3 id="_assumptions">假设条件</h3>
<div class="paragraph">
<p>在详细介绍之前，我们需要针对我们的应用定义几个假设。我们希望获得的关键结果是拥有一个相当简单的过程。</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<div class="title">小费</div>
</td>
<td class="content">商业专业提示。简化流程可以为您节省大量的支持费用（在公司工作的人越多，您可以节省的钱就更多）！
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><strong>我们不想进行数据库回滚</strong></p>
</div>
<div class="paragraph">
<p>不这样做会简化部署过程（某些数据库回滚几乎是不可能的，例如回滚删除操作）。我们更喜欢仅回滚应用程序。这样，即使您具有不同的数据库（例如SQL和NoSQL），您的部署管道也将看起来相同。</p>
</div>
<div class="paragraph">
<p><strong>我们希望始终能够将应用程序回滚到一个版本（而不是其他版本）</strong></p>
</div>
<div class="paragraph">
<p>我们只想回滚。如果当前版本中存在无法轻松解决的错误，我们希望能够恢复到最新的工作版本。我们假定最后一个工作版本是前一个版本。要为多个部署保持代码和数据库兼容性，将非常困难且成本很高。</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<div class="title">小费</div>
</td>
<td class="content">出于可读性考虑，我们将对本文中的应用程序进行主要的版本控制。
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_step_1_initial_situation">步骤1：初始情况</h3>
<div class="paragraph">
<p>应用程式版本： <code>1.0.0</code></p>
</div>
<div class="paragraph">
<p>数据库版本： <code>v1</code></p>
</div>
<div class="sect3">
<h4 id="_comment">评论</h4>
<div class="paragraph">
<p>这将是我们将要考虑的应用程序的初始状态。</p>
</div>
</div>
<div class="sect3">
<h4 id="_db_changes">数据库更改</h4>
<div class="paragraph">
<p>该数据库包含一个名为<code>last_name</code>的列。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">CREATE TABLE PERSON (
	id BIGINT GENERATED BY DEFAULT AS IDENTITY,
	first_name varchar(255) not null,
	last_name varchar(255) not null
);

insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_code_changes">代码变更</h4>
<div class="paragraph">
<p>该应用程序将Person数据存储到名为<code>last_name</code>的列中：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">/*
 * Copyright 2012-2016 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package sample.flyway;

import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;

@Entity
public class Person {
	@Id
	@GeneratedValue
	private Long id;
	private String firstName;
	private String lastName;

	public String getFirstName() {
		return this.firstName;
	}

	public void setFirstName(String firstName) {
		this.firstName = firstName;
	}

	public String getLastName() {
		return this.lastName;
	}

	public void setLastName(String lastname) {
		this.lastName = lastname;
	}

	@Override
	public String toString() {
		return "Person [firstName=" + this.firstName + ", lastName=" + this.lastName
				+ "]";
	}
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_renaming_a_column_in_backward_incompatible_way">以向后不兼容的方式重命名列</h3>
<div class="paragraph">
<p>如果要更改列名称，请看下面的示例：</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<div class="title">警告</div>
</td>
<td class="content">以下示例故意以可能会破坏的方式进行。我们正在展示它来描述数据库兼容性问题。
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>应用程式版本： <code>2.0.0.BAD</code></p>
</div>
<div class="paragraph">
<p>数据库版本： <code>v2bad</code></p>
</div>
<div class="sect3">
<h4 id="_comment_2">评论</h4>
<div class="paragraph">
<p>当前的更改不允许我们同时运行两个实例（旧实例和新实例）。因此，零停机时间部署将难以实现（如果我们考虑到假设，这实际上是不可能的）。</p>
</div>
<div class="sect4">
<h5 id="_a_b_testing">A / B测试</h5>
<div class="paragraph">
<p>当前的情况是，我们已经将一个应用程序部署到版本<code>1.0.0</code>并在<code>v1</code>部署到了db。我们要部署版本为<code>2.0.0.BAD</code></p><code>2.0.0.BAD</code></div><code>2.0.0.BAD</code></div><code>2.0.0.BAD</code></div><code>2.0.0.BAD</code></div><code>2.0.0.BAD</code></div><code>2.0.0.BAD</code></div><code>2.0.0.BAD</code></div><code>2.0.0.BAD</code></div><code>2.0.0.BAD</code></article><code>2.0.0.BAD</code></div><code>2.0.0.BAD</code></div><code>2.0.0.BAD</code></div><code>2.0.0.BAD</code></div><code>2.0.0.BAD</code></body></html>