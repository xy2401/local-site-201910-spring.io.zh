<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Zero Downtime Deployment with a Database</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Zero Downtime Deployment with a Database" />
<meta name="twitter:description" content="&lt;div class=&quot;paragraph&quot;&gt; 
 &lt;p&gt;This article will explain in depth how to tackle issues related to database compatibility and the deployment process. We will present what can happen with your production applications if you try to perform such a deployment unprepared. We will then walk through the steps in the lifecycle of an application that are necessary to have zero downtime. The result of our operations will be applying a backward incompatible database change in a backward compatible way.&lt;/p&gt; 
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt; 
 &lt;p&gt;If you want to work through the code samples below, you will find everything you need in &lt;a href=&quot;https://github.com/spring-cloud-samples/zero-downtime-deployment&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt; 
&lt;/div&gt;
" />
<meta name="twitter:creator" content="@mgrzejszczak" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/d4b43000c99fccc46455f42a841fa62e?s=200" />

<meta property="og:title" content="Zero Downtime Deployment with a Database" />
<meta property="og:image" content="https://gravatar.com/avatar/d4b43000c99fccc46455f42a841fa62e?s=200" />
<meta property="og:description" content="&lt;div class=&quot;paragraph&quot;&gt; 
 &lt;p&gt;This article will explain in depth how to tackle issues related to database compatibility and the deployment process. We will present what can happen with your production applications if you try to perform such a deployment unprepared. We will then walk through the steps in the lifecycle of an application that are necessary to have zero downtime. The result of our operations will be applying a backward incompatible database change in a backward compatible way.&lt;/p&gt; 
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt; 
 &lt;p&gt;If you want to work through the code samples below, you will find everything you need in &lt;a href=&quot;https://github.com/spring-cloud-samples/zero-downtime-deployment&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt; 
&lt;/div&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2016-05-31 09:09:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Zero Downtime Deployment with a Database</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/d4b43000c99fccc46455f42a841fa62e?s=20&amp;d=mm" />
<a class="author" rel="author" href="/team/marcingrzejszczak">Marcin Grzejszczak</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2016-05-31 09:09:00.0">May 31, 2016</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="2513" href="/blog/2016/05/31/zero-downtime-deployment-with-a-database#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><div class="paragraph">
<p>This article will explain in depth how to tackle issues related to database compatibility and the deployment process.
We will present what can happen with your production applications if you try to perform
such a deployment unprepared. We will then walk through the steps in the lifecycle of an application that are necessary
to have zero downtime. The result of our operations will be applying a backward incompatible database change in a backward compatible way.</p>
</div>
<div class="paragraph">
<p>If you want to work through the code samples below, you will find everything you need in <a href="https://github.com/spring-cloud-samples/zero-downtime-deployment">GitHub</a>.</p>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_zero_downtime_deployment">Zero downtime deployment</h3>
<div class="paragraph">
<p>What is this mythical <strong>zero downtime deployment</strong>? You can say that your application is deployed that way if you can
successfully introduce a new version of your application to production without making the user see that the application
went down in the meantime. From the user&#8217;s and the company&#8217;s point of view it&#8217;s the best possible scenario of deployment
since new features can be introduced and bugs can be eliminated without any outage.</p>
</div>
<div class="paragraph">
<p>How can you achieve that? There are number of ways but one of them is just to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>deploy version 1 of your service</p>
</li>
<li>
<p>migrate your database to a new version</p>
</li>
<li>
<p>deploy version 2 of your service in parallel to the version 1</p>
</li>
<li>
<p>once you see that version 2 works like a charm just bring down version 1</p>
</li>
<li>
<p>you&#8217;re done!</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Easy, isn&#8217;t it? Unfortunately, it&#8217;s not that easy and we&#8217;ll focus on that later on. Right now let&#8217;s check another
common deployment process which is the blue green deployment.</p>
</div>
<div class="paragraph">
<p>Have you ever heard of <a href="http://martinfowler.com/bliki/BlueGreenDeployment.html">blue green deployment</a>? With Cloud Foundry it&#8217;s
extremely easy to do. Just check out <a href="https://spring.io/blog/2014/04/04/project-sagan-zero-downtime-deployments">this article</a> where
we describe it in more depth. To quickly recap, doing blue green deployment is as simple as:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="ulist">
<ul>
<li>
<p>maintain two copies of your production environment (“blue” and “green”);</p>
</li>
<li>
<p>route all traffic to the the blue environment by mapping production URLs to it;</p>
</li>
<li>
<p>deploy and test any changes to the application in the green environment;</p>
</li>
<li>
<p>“flip the switch” by mapping URLs onto green and unmapping them from blue.</p>
</li>
</ul>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Blue green deployment is an approach that gives you ease of introducing new features without the stress that
something will completely blow up on production. That&#8217;s due to the fact that even if that would be the case,
you can easily rollback your router to point to a previous environment just by "flipping the switch".</p>
</div>
<div class="paragraph">
<p>After reading all of the above you could ask yourself a question: <em>What does zero downtime deployment have to do with Blue green deployment?</em></p>
</div>
<div class="paragraph">
<p>Well, they have quite a lot in common since maintaining two copies of the same environment leads to doubling the effort
required to support it. That&#8217;s why some teams, as <a href="http://martinfowler.com/bliki/BlueGreenDeployment.html">Martin Fowler states it</a>,
tend to perform a variation of that approach:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Another variation would be to use the same database, making the blue-green switches for web and domain layers.</p>
</div>
<div class="paragraph">
<p>Databases can often be a challenge with this technique, particularly when you need to change the schema to support a new version of the software.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>And here we arrive at the main problem that we will touch in this article. <strong>The database</strong>. Let&#8217;s have another glimpse on this phrase:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>migrate your database to a new version</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Now you should ask yourself a question - what if the database change is backward incompatible? Won&#8217;t my version 1 of the application
just blow up? Actually, it will&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>So even though the benefits of zero downtime / blue green deployment are gigantic, companies tend to follow such a safer process
of deploying their apps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>prepare a package with the new version of the application</p>
</li>
<li>
<p>shut down the running application</p>
</li>
<li>
<p>run the database migration scripts</p>
</li>
<li>
<p>deploy and run the new version of the application</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this article we&#8217;ll describe in more depth how you can work with your database and your code so that you can profit from the
benefits of the zero downtime deployment.</p>
</div>
</div>
<div class="sect2">
<h3 id="_database_issues">Database issues</h3>
<div class="paragraph">
<p>If you have a stateless application that doesn&#8217;t store any data in the database then you can start doing zero downtime deployment
right now. Unfortunately, most software has to store the data somewhere. That&#8217;s why you have to think twice before doing any sort
of schema changes. Before we go into the details of how to change the schema in such a way that zero downtime deployment is possible
let&#8217;s focus on schema versioning first.</p>
</div>
<div class="sect3">
<h4 id="_schema_versioning">Schema versioning</h4>
<div class="paragraph">
<p>In this article we will use <a href="http://flywaydb.org">Flyway</a> as a schema versioning tool. Naturally we&#8217;re also writing a Spring Boot application
that has native support for Flyway and will execute the schema migration upon application context setup. When using Flyway
you can store the migration scripts inside your projects folder (by default under <code>classpath:db/migration</code>). Here you can see an example
of such migration files</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">└── db
 └── migration
     ├── V1__init.sql
     ├── V2__Add_surname.sql
     ├── V3__Final_migration.sql
     └── V4__Remove_lastname.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example we can see 4 migration scripts that, if not executed previously, will be executed one after another when the application
starts. Let&#8217;s take a look at one of the files (<code>V1__init.sql</code>) as an example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">CREATE TABLE PERSON (
	id BIGINT GENERATED BY DEFAULT AS IDENTITY,
	first_name varchar(255) not null,
	last_name varchar(255) not null
);

insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s pretty self-explanatory: you can use SQL to define how your database should be changed. For more information about Spring Boot
and Flyway <a href="https://docs.spring.io/spring-boot/docs/1.3.5.RELEASE/reference/html/howto-database-initialization.html#howto-execute-flyway-database-migrations-on-startup">check the Spring Boot Docs</a>.</p>
</div>
<div class="paragraph">
<p>Using a schema versioning tool with Spring Boot, you receive 2 great benefits.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>you decouple database changes from the code changes</p>
</li>
<li>
<p>database migration happens together with your application deployment - your deployment process gets simplified</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_solving_the_database_issue">Solving the database issue</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the following section of the article we will focus on presenting two approaches to database changes.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>backward incompatible</p>
</li>
<li>
<p>backward compatible</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The first one will be shown as a warning to not to try to do zero downtime deployment without some preparations.
The second one will present a suggested solution of how one can perform zero downtime deployment and maintain
backward compatibility at the same time.</p>
</div>
<div class="paragraph">
<p>Our project that we will work on will be a simple Spring Boot Flyway application in which we have a <code>Person</code>
that has a <code>first_name</code> and a <code>last_name</code> in the database. We want to rename the <code>last_name</code> column into <code>surname</code>.</p>
</div>
<div class="sect2">
<h3 id="_assumptions">Assumptions</h3>
<div class="paragraph">
<p>Before we go into details we need to define a couple of assumptions towards our applications. The key result that we
would like to obtain is to have a fairly simple process.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Business PRO-TIP. Simplifying processes can save you a lot of money on support (the more people work in your company the more money you can save)!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>We don&#8217;t want to do database rollbacks</strong></p>
</div>
<div class="paragraph">
<p>Not doing them simplifies the deployment process (some database rollbacks are close to impossible like rolling back a delete).
We prefer to rollback only the applications. That way even if you have different databases (e.g. SQL and NoSQL) then your
deployment pipeline will look the same.</p>
</div>
<div class="paragraph">
<p><strong>We want ALWAYS to be able to rollback the application one version back (not more)</strong></p>
</div>
<div class="paragraph">
<p>We want to rollback only as a necessity. If there is a bug in the current version that can&#8217;t be solved easily we want to be
able to bring back the last working version. We assume that this last working version is the previous one. Maintaining code and database
compatibility for more than a single deployment would be extremely difficult and costly.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
For readability purposes we will be versioning the applications in this article with major increments.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_step_1_initial_situation">Step 1: Initial situation</h3>
<div class="paragraph">
<p>Version of the app: <code>1.0.0</code></p>
</div>
<div class="paragraph">
<p>Version of the DB: <code>v1</code></p>
</div>
<div class="sect3">
<h4 id="_comment">Comment</h4>
<div class="paragraph">
<p>This will be the initial state of the application that we will take into consideration.</p>
</div>
</div>
<div class="sect3">
<h4 id="_db_changes">DB changes</h4>
<div class="paragraph">
<p>The db contains a column called <code>last_name</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">CREATE TABLE PERSON (
	id BIGINT GENERATED BY DEFAULT AS IDENTITY,
	first_name varchar(255) not null,
	last_name varchar(255) not null
);

insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_code_changes">Code changes</h4>
<div class="paragraph">
<p>The app stores the Person data into a column called <code>last_name</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">/*
 * Copyright 2012-2016 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package sample.flyway;

import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;

@Entity
public class Person {
	@Id
	@GeneratedValue
	private Long id;
	private String firstName;
	private String lastName;

	public String getFirstName() {
		return this.firstName;
	}

	public void setFirstName(String firstName) {
		this.firstName = firstName;
	}

	public String getLastName() {
		return this.lastName;
	}

	public void setLastName(String lastname) {
		this.lastName = lastname;
	}

	@Override
	public String toString() {
		return "Person [firstName=" + this.firstName + ", lastName=" + this.lastName
				+ "]";
	}
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_renaming_a_column_in_backward_incompatible_way">Renaming a column in backward-incompatible way</h3>
<div class="paragraph">
<p>Let&#8217;s take a look at the following example if you want to change the column name:</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The following example is deliberately done in such a way that it will break. We&#8217;re showing it to depict the problem of database
compatibility.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Version of the app: <code>2.0.0.BAD</code></p>
</div>
<div class="paragraph">
<p>Version of the DB: <code>v2bad</code></p>
</div>
<div class="sect3">
<h4 id="_comment_2">Comment</h4>
<div class="paragraph">
<p>Current changes DO NOT allow us to run two instances (old and new) at the same time. Thus zero down time
deployment will be difficult to achieve (if we take into consideration out assumptions it&#8217;s actually impossible).</p>
</div>
<div class="sect4">
<h5 id="_a_b_testing">A/B testing</h5>
<div class="paragraph">
<p>The current situation is that we have an app deployed to production in version <code>1.0.0</code> and db in <code>v1</code>. We want to deploy the second
instance of the app that will be in version <code>2.0.0.BAD</code> and update the db to <code>v2bad</code>.</p>
</div>
<div class="paragraph">
<p>Steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>a new instance is deployed in version <code>2.0.0.BAD</code> that updates the db to <code>v2bad</code></p>
</li>
<li>
<p>in <code>v2bad</code> of the database the column <code>last_name</code> is no longer existing - it got changed to <code>surname</code></p>
</li>
<li>
<p>the db and app upgrade is successful and you have some instances working in <code>1.0.0</code>, others in <code>2.0.0.BAD</code>. All are talking to db
in <code>v2bad</code></p>
</li>
<li>
<p>all instances of version <code>1.0.0</code> will start producing exceptions cause they will try to insert data to <code>last_name</code> column which is
no longer there</p>
</li>
<li>
<p>all instances of version <code>2.0.0.BAD</code> will work without any issues</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As you can if we do backward incompatible changes of the DB and the application, A/B testing is impossible.</p>
</div>
</div>
<div class="sect4">
<h5 id="_rolling_back_the_application">Rolling back the application</h5>
<div class="paragraph">
<p>Let&#8217;s assume that after trying to do A/B deployment we&#8217;ve decided that we need to rollback the app back to version <code>1.0.0</code>. We assumed
that we don&#8217;t want to roll back the database.</p>
</div>
<div class="paragraph">
<p>Steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>we shut down the instance that was running with version <code>2.0.0.BAD</code></p>
</li>
<li>
<p>the database is still in <code>v2bad</code></p>
</li>
<li>
<p>since version <code>1.0.0</code> doesn&#8217;t understand what <code>surname</code> column is it will produce exceptions</p>
</li>
<li>
<p>hell broke loose and we can&#8217;t go back</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As you can if we do backward incompatible changes of the DB and the application, we can&#8217;t roll back to a previous version.</p>
</div>
</div>
<div class="sect4">
<h5 id="_logs_from_script_execution">Logs from script execution</h5>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">Backward incompatible scenario:

01) Run 1.0.0
02) Wait for the app (1.0.0) to boot
03) Generate a person by calling POST localhost:9991/person to version 1.0.0
04) Run 2.0.0.BAD
05) Wait for the app (2.0.0.BAD) to boot
06) Generate a person by calling POST localhost:9991/person to version 1.0.0 &lt;-- this should fail
07) Generate a person by calling POST localhost:9992/person to version 2.0.0.BAD &lt;-- this should pass

Starting app in version 1.0.0
Generate a person in version 1.0.0
Sending a post to 127.0.0.1:9991/person. This is the response:

{"firstName":"b73f639f-e176-4463-bf26-1135aace2f57","lastName":"b73f639f-e176-4463-bf26-1135aace2f57"}

Starting app in version 2.0.0.BAD
Generate a person in version 1.0.0
Sending a post to 127.0.0.1:9991/person. This is the response:

curl: (22) The requested URL returned error: 500 Internal Server Error

Generate a person in version 2.0.0.BAD
Sending a post to 127.0.0.1:9995/person. This is the response:

{"firstName":"e156be2e-06b6-4730-9c43-6e14cfcda125","surname":"e156be2e-06b6-4730-9c43-6e14cfcda125"}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_db_changes_2">DB changes</h4>
<div class="paragraph">
<p>The migration script renames the column from <code>last_name</code> to <code>surname</code></p>
</div>
<div class="paragraph">
<p>Initial Flyway script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">CREATE TABLE PERSON (
	id BIGINT GENERATED BY DEFAULT AS IDENTITY,
	first_name varchar(255) not null,
	last_name varchar(255) not null
);

insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code></pre>
</div>
</div>
<div class="paragraph">
<p>Script renaming <code>last_name</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">-- This change is backward incompatible - you can't do A/B testing
ALTER TABLE PERSON CHANGE last_name surname VARCHAR;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_code_changes_2">Code changes</h4>
<div class="paragraph">
<p>We have changed the field name from <code>lastName</code> to <code>surname</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_renaming_a_column_in_backward_compatible_way">Renaming a column in backward-compatible way</h3>
<div class="paragraph">
<p>This is the most frequent situation that we can encounter. We need to perform backward incompatible changes. We have already
proven that to do zero downtime deployment we must not simply apply the database migration without extra work. In this
section of the article we will go through 3 deployments of the application together with the database migrations to achieve
the desired effect and at the same time be backward compatible.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
As a reminder - Let&#8217;s assume that we have the DB in version <code>v1</code>. It contains the columns <code>first_name</code> and <code>last_name</code>.
We want to change the <code>last_name</code> into <code>surname</code>. We also have the app in version <code>1.0.0</code> which doesn&#8217;t use the <code>surname</code> column just yet.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_step_2_adding_surname">Step 2: Adding surname</h3>
<div class="paragraph">
<p>Version of the app: <code>2.0.0</code></p>
</div>
<div class="paragraph">
<p>Version of the DB: <code>v2</code></p>
</div>
<div class="sect3">
<h4 id="_comment_3">Comment</h4>
<div class="paragraph">
<p>By adding a new column and copying its contents we have created backward compatible changes of the db. ATM if we
rollback the JAR / have an old JAR working at the same tame it won&#8217;t break at runtime.</p>
</div>
<div class="sect4">
<h5 id="_rolling_a_new_version">Rolling a new version</h5>
<div class="paragraph">
<p>Steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>migrate your db to create the new column called <code>surname</code>. Now your db is in <code>v2</code></p>
</li>
<li>
<p>copy the data from the <code>last_name</code> column to <code>surname</code>. <strong>NOTE</strong> that if you have a lot of this data then you should consider batch
migration!</p>
</li>
<li>
<p>write the code to use <strong>BOTH</strong> the <strong>new</strong> and the <strong>old</strong> column. Now your app is in version <code>2.0.0</code></p>
</li>
<li>
<p>read the surname value from <code>surname</code> column if it&#8217;s not null and from <code>last_name</code> if <code>surname</code> wasn&#8217;t set.
You can remove the <code>getLastName()</code> from the code since it will produce nulls when your app is rolled back from <code>3.0.0</code> to <code>2.0.0</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you&#8217;re using Spring Boot Flyway those two steps will be performed upon booting the version <code>2.0.0</code> of the app. If you&#8217;re running
database versioning tool manually then you&#8217;d have to do it in separate processes (first manually upgrade the db version and then deploy
the new app).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Remember that the newly created column <strong>MUST NOT</strong> be <strong>NOT NULL</strong>. If you rollback, the old app has no knowledge of the new
column and won&#8217;t set it upon <code>Insert</code>. But if you add that constraint and your db is in <code>v2</code> it would require the value of the new
column to be set. That would result in constraint violations.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
You should remove the <code>getLastName()</code> method because in version <code>3.0.0</code> there is no notion of <code>last_name</code> column in the code.
That means that nulls will be set there. You can leave the method and add null-checks but a much better solution would be to ensure
that in the logic of <code>getSurname()</code> you pick the proper, non-null value.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_a_b_testing_2">A/B testing</h5>
<div class="paragraph">
<p>The current situation is that we have an app deployed to production in version <code>1.0.0</code> and db in <code>v1</code>. We want to deploy the second
instance of the app that will be in version <code>2.0.0</code> and update the db to <code>v2</code>.</p>
</div>
<div class="paragraph">
<p>Steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>a new instance is deployed in version <code>2.0.0</code> that updates the db to <code>v2</code></p>
</li>
<li>
<p>in the meantime some requests got processed by instances being in version <code>1.0.0</code></p>
</li>
<li>
<p>the upgrade is successful and you have some instances working in <code>1.0.0</code>, others in <code>2.0.0</code>. All are talking to db in <code>v2</code></p>
</li>
<li>
<p>version <code>1.0.0</code> is not using the database&#8217;s column <code>surname</code> and version <code>2.0.0</code> is. They don&#8217;t interfere each other, no exceptions
should be thrown.</p>
</li>
<li>
<p>version <code>2.0.0</code> is saving data to both old and new column thus it&#8217;s backward compatible</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If you have any queries that count items basing on values from old / new column you have to remember that now you have
duplicate values (most likely still being migrated). E.g. if you want to count the number of users whose last name (however you call it)
starts with a letter <code>A</code> then until the data migration (<code>old</code> &#8594; <code>new</code> column) is done you might have inconsistent data if you
perform the query against the new column.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_rolling_back_the_application_2">Rolling back the application</h5>
<div class="paragraph">
<p>The current situation is that we have app in version <code>2.0.0</code> and db in <code>v2</code>.</p>
</div>
<div class="paragraph">
<p>Steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>roll back your app to version <code>1.0.0</code>.</p>
</li>
<li>
<p>version <code>1.0.0</code> is not using the database&#8217;s column <code>surname</code> thus rollback should be successful</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_db_changes_3">DB changes</h4>
<div class="paragraph">
<p>The db contains a column called <code>last_name</code>.</p>
</div>
<div class="paragraph">
<p>Initial Flyway script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">CREATE TABLE PERSON (
	id BIGINT GENERATED BY DEFAULT AS IDENTITY,
	first_name varchar(255) not null,
	last_name varchar(255) not null
);

insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code></pre>
</div>
</div>
<div class="paragraph">
<p>Script adding <code>surname</code> column.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Remember NOT TO ADD any NOT NULL constraints to the added column. Cause if you rollback the JAR
the old version doesn&#8217;t have the notion of the added column and automatically a NULL value will be set. In case
of having a constraint the old application will blow up.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">-- NOTE: This field can't have the NOT NULL constraint cause if you rollback, the old version won't know about this field
-- and will always set it to NULL
ALTER TABLE PERSON ADD surname varchar(255);

-- WE'RE ASSUMING THAT IT'S A FAST MIGRATION - OTHERWISE WE WOULD HAVE TO MIGRATE IN BATCHES
UPDATE PERSON SET PERSON.surname = PERSON.last_name</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_code_changes_3">Code changes</h4>
<div class="paragraph">
<p>We are storing data in both <code>last_name</code> and <code>surname</code>. Also, we are reading from the <code>last_name</code> column cause
it is most up to date. During the deployment process some requests might have been processed by the instance that
hasn&#8217;t yet been upgraded.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">/*
 * Copyright 2012-2016 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package sample.flyway;

import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;

@Entity
public class Person {
	@Id
	@GeneratedValue
	private Long id;
	private String firstName;
	private String lastName;
	private String surname;

	public String getFirstName() {
		return this.firstName;
	}

	public void setFirstName(String firstName) {
		this.firstName = firstName;
	}

	/**
	 * Reading from the new column if it's set. If not the from the old one.
	 *
	 * When migrating from version 1.0.0 -&gt; 2.0.0 this can lead to a possibility that some data in
	 * the surname column is not up to date (during the migration process lastName could have been updated).
	 * In this case one can run yet another migration script after all applications have been deployed in the
	 * new version to ensure that the surname field is updated.
	 *
	 * However it makes sense since when looking at the migration from 2.0.0 -&gt; 3.0.0. In 3.0.0 we no longer
	 * have a notion of lastName at all - so we don't update that column. If we rollback from 3.0.0 -&gt; 2.0.0 if we
	 * would be reading from lastName, then we would have very old data (since not a single datum was inserted
	 * to lastName in version 3.0.0).
	 */
	public String getSurname() {
		return this.surname != null ? this.surname : this.lastName;
	}

	/**
	 * Storing both FIRST_NAME and SURNAME entries
	 */
	public void setSurname(String surname) {
		this.lastName = surname;
		this.surname = surname;
	}

	@Override
	public String toString() {
		return "Person [firstName=" + this.firstName + ", lastName=" + this.lastName + ", surname=" + this.surname
				+ "]";
	}
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_3_removing_last_name_from_code">Step 3: Removing last name from code</h3>
<div class="paragraph">
<p>Version of the app: <code>3.0.0</code></p>
</div>
<div class="paragraph">
<p>Version of the DB: <code>v3</code></p>
</div>
<div class="sect3">
<h4 id="_comment_4">Comment</h4>
<div class="paragraph">
<p>By adding a new column and copying its contents we have created backward compatible changes of the db. ATM if we
rollback the JAR / have an old JAR working at the same time it won&#8217;t break at runtime.</p>
</div>
<div class="sect4">
<h5 id="_rolling_back_the_application_3">Rolling back the application</h5>
<div class="paragraph">
<p>The current situation is that we have app in version <code>3.0.0</code> and db in <code>v3</code>. Version <code>3.0.0</code> is not storing data
into the <code>last_name</code> column. That means that most up to date information is stored in the <code>surname</code> column.</p>
</div>
<div class="paragraph">
<p>Steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>roll back your app to version <code>2.0.0</code>.</p>
</li>
<li>
<p>version <code>2.0.0</code> is using both <code>last_name</code> and <code>surname</code> column.</p>
</li>
<li>
<p>version <code>2.0.0</code> will pick first <code>surname</code> column if it&#8217;s not null and if that&#8217;s not the case then it will pick <code>last_name</code></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_db_changes_4">DB changes</h4>
<div class="paragraph">
<p>There are no structure changes in the DB. The following script is executed that performs the final migration of old data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">-- WE'RE ASSUMING THAT IT'S A FAST MIGRATION - OTHERWISE WE WOULD HAVE TO MIGRATE IN BATCHES
-- ALSO WE'RE NOT CHECKING IF WE'RE NOT OVERRIDING EXISTING ENTRIES. WE WOULD HAVE TO COMPARE
-- ENTRY VERSIONS TO ENSURE THAT IF THERE IS ALREADY AN ENTRY WITH A HIGHER VERSION NUMBER
-- WE WILL NOT OVERRIDE IT.
UPDATE PERSON SET PERSON.surname = PERSON.last_name;

-- DROPPING THE NOT NULL CONSTRAINT; OTHERWISE YOU WILL TRY TO INSERT NULL VALUE OF THE LAST_NAME
-- WITH A NOT_NULL CONSTRAINT.
ALTER TABLE PERSON MODIFY COLUMN last_name varchar(255) NULL DEFAULT NULL;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_code_changes_4">Code changes</h4>
<div class="paragraph">
<p>We are storing data in both <code>last_name</code> and <code>surname</code>. Also, we are reading from the <code>last_name</code> column cause
it is most up to date. During the deployment process some requests might have been processed by the instance that
hasn&#8217;t yet been upgraded.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">/*
 * Copyright 2012-2016 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package sample.flyway;

import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;

@Entity
public class Person {
	@Id
	@GeneratedValue
	private Long id;
	private String firstName;
	private String surname;

	public String getFirstName() {
		return this.firstName;
	}

	public void setFirstName(String firstName) {
		this.firstName = firstName;
	}

	public String getSurname() {
		return this.surname;
	}

	public void setSurname(String lastname) {
		this.surname = lastname;
	}

	@Override
	public String toString() {
		return "Person [firstName=" + this.firstName + ", surname=" + this.surname
				+ "]";
	}
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_4_removing_last_name_from_db">Step 4: Removing last name from db</h3>
<div class="paragraph">
<p>Version of the app: <code>4.0.0</code></p>
</div>
<div class="paragraph">
<p>Version of the DB: <code>v4</code></p>
</div>
<div class="sect3">
<h4 id="_comment_5">Comment</h4>
<div class="paragraph">
<p>Since the code of version <code>3.0.0</code> wasn&#8217;t using <code>last_name</code> column, if we roll back to <code>3.0.0</code> after removing the
column from the database then nothing bad will happen at runtime.</p>
</div>
<div class="sect4">
<h5 id="_logs_from_script_execution_2">Logs from script execution</h5>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">We will do it in the following way:

01) Run 1.0.0
02) Wait for the app (1.0.0) to boot
03) Generate a person by calling POST localhost:9991/person to version 1.0.0
04) Run 2.0.0
05) Wait for the app (2.0.0) to boot
06) Generate a person by calling POST localhost:9991/person to version 1.0.0
07) Generate a person by calling POST localhost:9992/person to version 2.0.0
08) Kill app (1.0.0)
09) Run 3.0.0
10) Wait for the app (3.0.0) to boot
11) Generate a person by calling POST localhost:9992/person to version 2.0.0
12) Generate a person by calling POST localhost:9993/person to version 3.0.0
13) Kill app (3.0.0)
14) Run 4.0.0
15) Wait for the app (4.0.0) to boot
16) Generate a person by calling POST localhost:9993/person to version 3.0.0
17) Generate a person by calling POST localhost:9994/person to version 4.0.0


Starting app in version 1.0.0
Generate a person in version 1.0.0
Sending a post to 127.0.0.1:9991/person. This is the response:

{"firstName":"52b6e125-4a5c-429b-a47a-ef18bbc639d2","lastName":"52b6e125-4a5c-429b-a47a-ef18bbc639d2"}

Starting app in version 2.0.0

Generate a person in version 1.0.0
Sending a post to 127.0.0.1:9991/person. This is the response:

{"firstName":"e41ee756-4fa7-4737-b832-e28827a00deb","lastName":"e41ee756-4fa7-4737-b832-e28827a00deb"}

Generate a person in version 2.0.0
Sending a post to 127.0.0.1:9992/person. This is the response:

{"firstName":"0c1240f5-649a-4bc5-8aa9-cff855f3927f","lastName":"0c1240f5-649a-4bc5-8aa9-cff855f3927f","surname":"0c1240f5-649a-4bc5-8aa9-cff855f3927f"}

Killing app 1.0.0

Starting app in version 3.0.0

Generate a person in version 2.0.0
Sending a post to 127.0.0.1:9992/person. This is the response:
{"firstName":"74d84a9e-5f44-43b8-907c-148c6d26a71b","lastName":"74d84a9e-5f44-43b8-907c-148c6d26a71b","surname":"74d84a9e-5f44-43b8-907c-148c6d26a71b"}

Generate a person in version 3.0.0
Sending a post to 127.0.0.1:9993/person. This is the response:
{"firstName":"c6564dbe-9ab5-40ae-9077-8ae6668d5862","surname":"c6564dbe-9ab5-40ae-9077-8ae6668d5862"}

Killing app 2.0.0

Starting app in version 4.0.0

Generate a person in version 3.0.0
Sending a post to 127.0.0.1:9993/person. This is the response:

{"firstName":"cbe942fc-832e-45e9-a838-0fae25c10a51","surname":"cbe942fc-832e-45e9-a838-0fae25c10a51"}

Generate a person in version 4.0.0
Sending a post to 127.0.0.1:9994/person. This is the response:

{"firstName":"ff6857ce-9c41-413a-863e-358e2719bf88","surname":"ff6857ce-9c41-413a-863e-358e2719bf88"}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_db_changes_5">DB changes</h4>
<div class="paragraph">
<p>In comparison to <code>v3</code> we&#8217;re just removing the <code>last_name</code> column and add missing constraints.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">-- REMOVE THE COLUMN
ALTER TABLE PERSON DROP last_name;

-- ADD CONSTRAINTS
UPDATE PERSON SET surname='' WHERE surname IS NULL;
ALTER TABLE PERSON ALTER COLUMN surname VARCHAR NOT NULL;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_code_changes_5">Code changes</h4>
<div class="paragraph">
<p>There are no code changes.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_recap">Recap</h3>
<div class="paragraph">
<p>We have successfully applied the backward incompatible change of renaming the column by doing a couple of
backward compatible deploys. Here you can find the summary of the performed actions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>deploy version <code>1.0.0</code> of the application with <code>v1</code> of db schema (column name = <code>last_name</code>)</p>
</li>
<li>
<p>deploy version <code>2.0.0</code> of the application that saves data to <code>last_name</code> and <code>surname</code> columns.
The app reads from <code>last_name</code> column. Db is in version <code>v2</code> containing both <code>last_name</code> and <code>surname</code> columns. The <code>surname</code> column is
a copy of the <code>last_name</code> column. (NOTE: this column must not have the not null constraint)</p>
</li>
<li>
<p>deploy version <code>3.0.0</code> of the application that saves data only to <code>surname</code> and reads from <code>surname</code>. As for the db the final
migration of <code>last_name</code> to <code>surname</code> takes place. Also the <strong>NOT NULL</strong> constraint is dropped from <code>last_name</code>. Db is now in version <code>v3</code></p>
</li>
<li>
<p>deploy version <code>4.0.0</code> of the application - there are no changes in the code. Deploy db in <code>v4</code> that first
preforms a final migration of <code>last_name</code> to <code>surname</code> and removes the <code>last_name</code> column. Here you can add any missing constraints</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>By following this approach you can always rollback one version back without breaking the database / application compatibility.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_code">Code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All the code used in this article is available at <a href="https://github.com/spring-cloud-samples/zero-downtime-deployment">Github</a>. Below you can find some additional description.</p>
</div>
<div class="sect2">
<h3 id="_projects">Projects</h3>
<div class="paragraph">
<p>Once you clone the repo you&#8217;ll see the following folder structure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">├── boot-flyway-v1              - 1.0.0 version of the app with v1 of the schema
├── boot-flyway-v2              - 2.0.0 version of the app with v2 of the schema (backward-compatible - app can be rolled back)
├── boot-flyway-v2-bad          - 2.0.0.BAD version of the app with v2bad of the schema (backward-incompatible - app cannot be rolled back)
├── boot-flyway-v3              - 3.0.0 version of the app with v3 of the schema (app can be rolled back)
└── boot-flyway-v4              - 4.0.0 version of the app with v4 of the schema (app can be rolled back)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_scripts">Scripts</h3>
<div class="paragraph">
<p>You can run the scripts to execute the scenario that shows the backward compatible and incompatible changes applied to the db.</p>
</div>
<div class="paragraph">
<p>To check the <strong>backward compatible</strong> case just run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">./scripts/scenario_backward_compatible.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>To check the <strong>backward incompatible</strong> case just run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">./scripts/scenario_backward_incompatible.sh</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_boot_sample_flyway">Spring Boot Sample Flyway</h3>
<div class="paragraph">
<p>All samples are clones of the <code>Spring Boot Sample Flyway</code> project.</p>
</div>
<div class="paragraph">
<p>You can look at <code><a href="http://localhost:8080/flyway" class="bare">http://localhost:8080/flyway</a></code> to review the list of scripts.</p>
</div>
<div class="paragraph">
<p>The sample also enables the H2 console (at <code><a href="http://localhost:8080/h2-console" class="bare">http://localhost:8080/h2-console</a></code>)
so that you can review the state of the database (the default jdbc url is
<code>jdbc:h2:mem:testdb</code>).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_additional_reading">Additional Reading</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="http://databaserefactoring.com">Database Refactoring patterns</a></p>
</li>
<li>
<p><a href="http://martinfowler.com/bliki/ContinuousDelivery.html">Continuous Delivery</a></p>
</li>
</ul>
</div>
</div>
</div></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 2513;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>