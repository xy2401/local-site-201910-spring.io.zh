<html  data-code-prettify="" data-mobile-support="" data-search=""><head>
<title>数据库零停机部署</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="Zero Downtime Deployment with a Database">
<meta name="twitter:description" >
<meta name="twitter:creator" content="@mgrzejszczak"><meta name="twitter:image:src" content="https://gravatar.com/avatar/d4b43000c99fccc46455f42a841fa62e?s=200"><meta property="og:title" content="Zero Downtime Deployment with a Database"><meta property="og:image" content="https://gravatar.com/avatar/d4b43000c99fccc46455f42a841fa62e?s=200"><meta property="og:description" >
<meta content="article" property="og:type"><meta property="og:article:published_time" content="2016-05-31 09:09:00.0">



<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">数据库零停机部署</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/d4b43000c99fccc46455f42a841fa62e?s=20&amp;d=mm"> <a class="author" rel="author" href="/team/marcingrzejszczak">马尔辛·格热兹扎克（Marcin Grzejszczak）</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2016-05-31 09:09:00.0">2016年5月31日</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2016/05/31/zero-downtime-deployment-with-a-database#disqus_thread" data-disqus-identifier="2513">
</a></div>
</div>
</header>
<div class="blog--post"><div class="paragraph">
<p>本文将深入解释如何解决与数据库兼容性和部署过程有关的问题。如果您尝试不准备执行这种部署，我们将介绍生产应用程序可能发生的情况。然后，我们将逐步完成应用程序生命周期中为零停机所必需的步骤。我们的操作结果将以向后兼容的方式应用向后不兼容的数据库更改。</p>
</div>
<div class="paragraph">
<p>如果您想浏览下面的代码示例，则可以在<a href="https://github.com/spring-cloud-samples/zero-downtime-deployment">GitHub中</a>找到所需的一切。</p>
</div>
<div class="sect1">
<h2 id="_introduction">介绍</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_zero_downtime_deployment">零停机时间部署</h3>
<div class="paragraph">
<p>什么是<strong>零停机</strong>神话般的<strong>部署</strong> ？您可以说，如果您可以成功地将新版本的应用程序引入生产环境而又不让用户看到该应用程序已关闭，则可以通过这种方式部署您的应用程序。从用户和公司的角度来看，这是最佳的部署方案，因为可以引入新功能并且可以消除错误，而不会造成任何中断。</p>
</div>
<div class="paragraph">
<p>你怎么能做到？有很多方法，但是其中一种方法是：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>部署服务的版本1</p>
</li>
<li>
<p>将数据库迁移到新版本</p>
</li>
<li>
<p>与版本1并行部署服务的版本2</p>
</li>
<li>
<p>一旦您看到版本2像魅力一样工作，只需降低版本1</p>
</li>
<li>
<p>你完成了！</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>很简单，不是吗？不幸的是，这并非易事，我们稍后将重点介绍。现在，让我们检查另一个常见的部署过程，即蓝绿色部署。</p>
</div>
<div class="paragraph">
<p>您听说过<a href="http://martinfowler.com/bliki/BlueGreenDeployment.html">蓝绿色部署</a>吗？有了Cloud Foundry，这非常容易做到。只需查看<a href="https://spring.io/blog/2014/04/04/project-sagan-zero-downtime-deployments">本文</a> ，我们将对其进行更深入的描述。要快速回顾一下，进行蓝绿色部署很简单：</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="ulist">
<ul>
<li>
<p>维护您的生产环境的两个副本（“蓝色”和“绿色”）；</p>
</li>
<li>
<p>通过将生产URL映射到蓝色环境，将所有流量路由到蓝色环境；</p>
</li>
<li>
<p>在绿色环境中部署和测试对应用程序的任何更改；</p>
</li>
<li>
<p>通过将URL映射到绿色并将其从蓝色取消映射来“翻转开关”。</p>
</li>
</ul>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>蓝绿色部署是一种使您轻松引入新功能的方法，而不必担心某些东西会完全破坏生产。这是由于这样的事实，即使是这种情况，您也可以通过“翻转开关”轻松回滚路由器以指向先前的环境。</p>
</div>
<div class="paragraph">
<p>阅读完以上所有内容后，您可能会问自己一个问题： <em>零停机时间部署与蓝绿色部署有什么关系？</em></p>
</div>
<div class="paragraph">
<p>嗯，它们有很多共同点，因为维护同一环境的两个副本会使支持该环境的工作加倍。这就是为什么某些团队，如<a href="http://martinfowler.com/bliki/BlueGreenDeployment.html">马丁·福勒</a> （ <a href="http://martinfowler.com/bliki/BlueGreenDeployment.html">Martin Fowler）所言</a> ，倾向于采用这种方法的变体：</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>另一个变化是使用相同的数据库，从而为Web和域层设置了蓝绿色的开关。</p>
</div>
<div class="paragraph">
<p>使用这种技术，数据库通常是一个挑战，尤其是当您需要更改架构以支持软件的新版本时。</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>在这里，我们得出了本文将要涉及的主要问题。<strong>数据库</strong> 。让我们再看一下这句话：</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>将数据库迁移到新版本</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>现在您应该问自己一个问题-如果数据库更改向后不兼容怎么办？我的应用程序版本1不会爆炸吗？实际上，它将......</p>
</div>
<div class="paragraph">
<p>因此，即使零停机/蓝绿色部署带来的好处是巨大的，公司还是倾向于遵循这样更安全的部署应用程序的过程：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>使用新版本的应用程序准备软件包</p>
</li>
<li>
<p>关闭正在运行的应用程序</p>
</li>
<li>
<p>运行数据库迁移脚本</p>
</li>
<li>
<p>部署并运行新版本的应用程序</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>在本文中，我们将更深入地描述如何使用数据库和代码，以便从零停机时间部署中受益。</p>
</div>
</div>
<div class="sect2">
<h3 id="_database_issues">数据库问题</h3>
<div class="paragraph">
<p>如果您有一个无状态应用程序，该应用程序没有在数据库中存储任何数据，则可以立即开始进行零停机时间部署。不幸的是，大多数软件必须将数据存储在某个地方。这就是为什么在进行任何类型的架构更改之前必须三思而后行的原因。在详细介绍如何以零停机时间部署的方式更改架构之前，让我们首先关注架构版本控制。</p>
</div>
<div class="sect3">
<h4 id="_schema_versioning">模式版本控制</h4>
<div class="paragraph">
<p>在本文中，我们将使用<a href="http://flywaydb.org">Flyway</a>作为架构版本控制工具。自然地，我们还将编写一个对Flyway具有本机支持的Spring Boot应用程序，并将在应用程序上下文设置后执行模式迁移。使用Flyway时，您可以将迁移脚本存储在项目文件夹中（默认情况下在<code>classpath:db/migration</code> ）。在这里，您可以看到此类迁移文件的示例</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">└── db
 └── migration
     ├── V1__init.sql
     ├── V2__Add_surname.sql
     ├── V3__Final_migration.sql
     └── V4__Remove_lastname.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>在此示例中，我们可以看到4个迁移脚本，如果先前未执行，则将在应用程序启动时一个接一个地执行。让我们以其中一个文件（ <code>V1__init.sql</code> ）为例。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">CREATE TABLE PERSON (
	id BIGINT GENERATED BY DEFAULT AS IDENTITY,
	first_name varchar(255) not null,
	last_name varchar(255) not null
);

insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code></pre>
</div>
</div>
<div class="paragraph">
<p>这很容易解释：您可以使用SQL定义应如何更改数据库。有关Spring Boot和Flyway的更多信息， <a href="https://docs.spring.io/spring-boot/docs/1.3.5.RELEASE/reference/html/howto-database-initialization.html#howto-execute-flyway-database-migrations-on-startup">请查看Spring Boot Docs</a> 。</p>
</div>
<div class="paragraph">
<p>在Spring Boot中使用模式版本控制工具，您将获得2大好处。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>您将数据库更改与代码更改脱钩</p>
</li>
<li>
<p>数据库迁移与应用程序部署同时进行-简化了部署过程</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_solving_the_database_issue">解决数据库问题</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在本文的以下部分中，我们将重点介绍两种更改数据库的方法。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>向后不兼容</p>
</li>
<li>
<p>向下兼容</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>第一个将显示为警告，不要在没有任何准备的情况下尝试进行零停机时间部署。第二个将提出一个建议的解决方案，说明如何执行零停机时间部署并同时保持向后兼容性。</p>
</div>
<div class="paragraph">
<p>我们将要处理的项目将是一个简单的Spring Boot Flyway应用程序，其中我们的<code>Person</code>在数据库中具有<code>first_name</code>和<code>last_name</code> 。我们想将<code>last_name</code>列重命名为<code>surname</code> 。</p>
</div>
<div class="sect2">
<h3 id="_assumptions">假设条件</h3>
<div class="paragraph">
<p>在详细介绍之前，我们需要针对我们的应用定义几个假设。我们希望获得的关键结果是拥有一个相当简单的过程。</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<div class="title">小费</div>
</td>
<td class="content">商业专业提示。简化流程可以为您节省大量的支持费用（在公司工作的人越多，您可以节省的钱就更多）！
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><strong>我们不想进行数据库回滚</strong></p>
</div>
<div class="paragraph">
<p>不这样做会简化部署过程（某些数据库回滚几乎是不可能的，例如回滚删除操作）。我们更喜欢仅回滚应用程序。这样，即使您具有不同的数据库（例如SQL和NoSQL），您的部署管道也将看起来相同。</p>
</div>
<div class="paragraph">
<p><strong>我们希望始终能够将应用程序回滚到一个版本（而不是其他版本）</strong></p>
</div>
<div class="paragraph">
<p>我们只想回滚。如果当前版本中存在无法轻松解决的错误，我们希望能够恢复到最新的工作版本。我们假定最后一个工作版本是前一个版本。要为多个部署保持代码和数据库兼容性，将非常困难且成本很高。</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<div class="title">小费</div>
</td>
<td class="content">出于可读性考虑，我们将对本文中的应用程序进行主要的版本控制。
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_step_1_initial_situation">步骤1：初始情况</h3>
<div class="paragraph">
<p>应用程式版本： <code>1.0.0</code></p>
</div>
<div class="paragraph">
<p>数据库版本： <code>v1</code></p>
</div>
<div class="sect3">
<h4 id="_comment">评论</h4>
<div class="paragraph">
<p>这将是我们将要考虑的应用程序的初始状态。</p>
</div>
</div>
<div class="sect3">
<h4 id="_db_changes">数据库更改</h4>
<div class="paragraph">
<p>该数据库包含一个名为<code>last_name</code>的列。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">CREATE TABLE PERSON (
	id BIGINT GENERATED BY DEFAULT AS IDENTITY,
	first_name varchar(255) not null,
	last_name varchar(255) not null
);

insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_code_changes">代码变更</h4>
<div class="paragraph">
<p>该应用程序将Person数据存储到名为<code>last_name</code>的列中：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">/*
 * Copyright 2012-2016 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package sample.flyway;

import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;

@Entity
public class Person {
	@Id
	@GeneratedValue
	private Long id;
	private String firstName;
	private String lastName;

	public String getFirstName() {
		return this.firstName;
	}

	public void setFirstName(String firstName) {
		this.firstName = firstName;
	}

	public String getLastName() {
		return this.lastName;
	}

	public void setLastName(String lastname) {
		this.lastName = lastname;
	}

	@Override
	public String toString() {
		return "Person [firstName=" + this.firstName + ", lastName=" + this.lastName
				+ "]";
	}
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_renaming_a_column_in_backward_incompatible_way">以向后不兼容的方式重命名列</h3>
<div class="paragraph">
<p>如果要更改列名称，请看下面的示例：</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<div class="title">警告</div>
</td>
<td class="content">以下示例故意以可能会破坏的方式进行。我们正在展示它来描述数据库兼容性问题。
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>应用程式版本： <code>2.0.0.坏</code></p>
</div>
<div class="paragraph">
<p>数据库版本： <code>v2bad</code></p>
</div>
<div class="sect3">
<h4 id="_comment_2">评论</h4>
<div class="paragraph">
<p>当前的更改不允许我们同时运行两个实例（旧实例和新实例）。因此零停机时间部署将很难实现（如果我们考虑到假设，这实际上是不可能的）。</p>
</div>
<div class="sect4">
<h5 id="_a_b_testing">A / B测试</h5>
<div class="paragraph">
<p>当前的情况是，我们已经将一个应用程序部署到版本<code>1.0.0</code>并在<code>v1</code>部署到了db。我们要部署版本为<code>2.0.0.的应用程序的第二个实例<code>2.0.0.BAD</code>并将数据库更新为<code>v2bad</code> 。</p>
</div>
<div class="paragraph">
<p>脚步：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在<code>2.0.0.版中部署了一个新实例<code>2.0.0.BAD</code> ，更新数据库，以<code>v2bad</code></p>
</li>
<li>
<p>在数据库的<code>v2bad</code>中，列<code>last_name</code>不再存在-它已更改为<code>surname</code></p>
</li>
<li>
<p>数据库和应用程序升级成功，并且您有一些实例在<code>1.0.0</code>工作，其他实例在<code>2.0.0.BAD</code>所有人都在与<code>v2bad</code> db <code>v2bad</code></p>
</li>
<li>
<p>版本<code>1.0.0</code>所有实例将开始产生异常，因为它们将尝试将数据插入到不再存在的<code>last_name</code>列中</p>
</li>
<li>
<p>版本<code>2.0.0.所有实例<code>2.0.0.BAD</code>可以正常工作</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>您可以通过对数据库和应用程序进行向后不兼容的更改来进行A / B测试。</p>
</div>
</div>
<div class="sect4">
<h5 id="_rolling_back_the_application">回滚应用程序</h5>
<div class="paragraph">
<p>假设在尝试进行A / B部署后，我们决定需要将应用回滚到<code>1.0.0</code>版本。我们假设我们不想回滚数据库。</p>
</div>
<div class="paragraph">
<p>脚步：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>我们关闭了使用<code>2.0.0.版运行的实例<code>2.0.0.坏</code></p>
</li>
<li>
<p>数据库仍在<code>v2bad</code></p>
</li>
<li>
<p>由于版本<code>1.0.0</code>无法识别哪个<code>surname</code>列，因此会产生异常</p>
</li>
<li>
<p>地狱破裂了，我们不能回头</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>如您所愿，如果我们对数据库和应用程序进行了向后不兼容的更改，则无法回滚到以前的版本。</p>
</div>
</div>
<div class="sect4">
<h5 id="_logs_from_script_execution">脚本执行日志</h5>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">Backward incompatible scenario:

01) Run 1.0.0
02) Wait for the app (1.0.0) to boot
03) Generate a person by calling POST localhost:9991/person to version 1.0.0
04) Run 2.0.0.BAD
05) Wait for the app (2.0.0.BAD) to boot
06) Generate a person by calling POST localhost:9991/person to version 1.0.0 &lt;-- this should fail
07) Generate a person by calling POST localhost:9992/person to version 2.0.0.BAD &lt;-- this should pass

Starting app in version 1.0.0
Generate a person in version 1.0.0
Sending a post to 127.0.0.1:9991/person. This is the response:

{"firstName":"b73f639f-e176-4463-bf26-1135aace2f57","lastName":"b73f639f-e176-4463-bf26-1135aace2f57"}

Starting app in version 2.0.0.BAD
Generate a person in version 1.0.0
Sending a post to 127.0.0.1:9991/person. This is the response:

curl: (22) The requested URL returned error: 500 Internal Server Error

Generate a person in version 2.0.0.BAD
Sending a post to 127.0.0.1:9995/person. This is the response:

{"firstName":"e156be2e-06b6-4730-9c43-6e14cfcda125","surname":"e156be2e-06b6-4730-9c43-6e14cfcda125"}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_db_changes_2">数据库更改</h4>
<div class="paragraph">
<p>迁移脚本将列从<code>last_name</code>重命名为<code>surname</code></p>
</div>
<div class="paragraph">
<p>初始Flyway脚本：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">CREATE TABLE PERSON (
	id BIGINT GENERATED BY DEFAULT AS IDENTITY,
	first_name varchar(255) not null,
	last_name varchar(255) not null
);

insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code></pre>
</div>
</div>
<div class="paragraph">
<p>脚本重命名<code>last_name</code> 。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">-- This change is backward incompatible - you can't do A/B testing
ALTER TABLE PERSON CHANGE last_name surname VARCHAR;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_code_changes_2">代码变更</h4>
<div class="paragraph">
<p>我们已经将字段名称从<code>lastName</code>更改为<code>surname</code> 。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_renaming_a_column_in_backward_compatible_way">以向后兼容的方式重命名列</h3>
<div class="paragraph">
<p>这是我们遇到的最常见的情况。我们需要执行向后不兼容的更改。我们已经证明，要进行零宕机时间部署，我们绝不能简单地应用数据库迁移而不进行额外的工作。在本文的这一部分中，我们将对应用程序进行3种部署以及数据库迁移，以实现所需的效果并同时向后兼容。</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<div class="title">小费</div>
</td>
<td class="content">提醒一下-假设我们的数据库版本为<code>v1</code> 。它包含列<code>first_name</code>和<code>last_name</code> 。我们想要将<code>last_name</code>更改为<code>surname</code> 。我们还拥有版本<code>1.0.0</code>的应用程序，该应用程序目前尚未使用<code>surname</code>列。
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_step_2_adding_surname">步骤2：新增姓氏</h3>
<div class="paragraph">
<p>应用程式版本： <code>2.0.0</code></p>
</div>
<div class="paragraph">
<p>数据库版本： <code>v2</code></p>
</div>
<div class="sect3">
<h4 id="_comment_3">评论</h4>
<div class="paragraph">
<p>通过添加新列并复制其内容，我们创建了数据库的向后兼容更改。如果我们回滚JAR，ATM仍旧运行，而旧的JAR在运行时不会中断。</p>
</div>
<div class="sect4">
<h5 id="_rolling_a_new_version">滚动新版本</h5>
<div class="paragraph">
<p>脚步：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>迁移您的数据库以创建名为<code>surname</code>的新列。现在您的数据库在<code>v2</code></p>
</li>
<li>
<p>将数据从<code>last_name</code>列复制到<code>surname</code> 。<strong>注意</strong> ，如果您有很多此类数据，则应考虑批量迁移！</p>
</li>
<li>
<p>写<strong>同时</strong>使用<strong>新</strong> ， <strong>旧</strong>列的代码。现在您的应用程序版本为<code>2.0.0</code></p>
</li>
<li>
<p>如果不为空，则从<code>surname</code>列中读取姓氏值；如果未设置<code>surname</code> ，则从<code>last_name</code>读取。您可以从代码中删除<code>getLastName()</code> ，因为当您的应用程序从<code>3.0.0</code>回滚到<code>2.0.0</code>时，它将产生null。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>如果您使用的是Spring Boot Flyway，则在启动应用程序的<code>2.0.0</code>版本时将执行这两个步骤。如果您是手动运行数据库版本控制工具，则必须在单独的过程中进行操作（首先手动升级数据库版本，然后部署新应用程序）。</p>
</div>
<div class="admonitionblock important">
<table>
<tbody><tr>
<td class="icon">
<div class="title">重要</div>
</td>
<td class="content">请记住，新创建的列<strong>不能</strong>是<strong>NOT NULL。</strong>如果回滚，旧应用程序将不了解新列，并且不会在<code>Insert</code>设置。但是，如果您添加该约束，并且您的数据库位于<code>v2</code>则需要设置新列的值。这将导致约束冲突。
</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock important">
<table>
<tbody><tr>
<td class="icon">
<div class="title">重要</div>
</td>
<td class="content">您应该删除<code>getLastName()</code>方法，因为在<code>3.0.0</code>版中，代码中没有<code>last_name</code>列的概念。这意味着将在此处设置空值。您可以保留该方法并添加null检查，但是更好的解决方案是确保在<code>getSurname()</code>的逻辑中选择正确的非null值。
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect4">
<h5 id="_a_b_testing_2">A / B测试</h5>
<div class="paragraph">
<p>当前的情况是，我们已经将一个应用程序部署到版本<code>1.0.0</code>并在<code>v1</code>部署到了db。我们要部署版本为<code>2.0.0</code>的应用程序的第二个实例，并将数据库更新为<code>v2</code> 。</p>
</div>
<div class="paragraph">
<p>脚步：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在版本<code>2.0.0</code>中部署了一个新实例，该实例将数据库更新为<code>v2</code></p>
</li>
<li>
<p>同时，版本为<code>1.0.0</code>实例处理了一些请求</p>
</li>
<li>
<p>升级成功，并且您有一些实例在<code>1.0.0</code>工作，其他实例在<code>2.0.0</code> 。所有人都在与<code>v2</code> db通信</p>
</li>
<li>
<p><code>1.0.0</code>版未使用数据库的列<code>surname</code>而<code>2.0.0</code>版正在使用。它们不会互相干扰，也不会抛出异常。</p>
</li>
<li>
<p><code>2.0.0</code>版将数据保存到新旧列中，因此向后兼容</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tbody><tr>
<td class="icon">
<div class="title">重要</div>
</td>
<td class="content">如果您有任何查询要根据旧/新列中的值对项目进行计数，则必须记住，现在您有重复的值（很可能仍在迁移）。例如，如果您要计算姓氏（无论如何称呼）以字母<code>A</code>开头的用户数，则在完成数据迁移（ <code>old</code> → <code>new</code>列）之前，如果您对新用户执行查询，则数据可能会不一致柱。
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect4">
<h5 id="_rolling_back_the_application_2">回滚应用程序</h5>
<div class="paragraph">
<p>当前的情况是我们在<code>2.0.0</code>版本中有app，在<code>v2</code> db。</p>
</div>
<div class="paragraph">
<p>脚步：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>将您的应用回滚到<code>1.0.0</code>版本。</p>
</li>
<li>
<p><code>1.0.0</code>版未使用数据库的列<code>surname</code>因此回滚应该成功</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_db_changes_3">数据库更改</h4>
<div class="paragraph">
<p>该数据库包含一个名为<code>last_name</code>的列。</p>
</div>
<div class="paragraph">
<p>初始Flyway脚本：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">CREATE TABLE PERSON (
	id BIGINT GENERATED BY DEFAULT AS IDENTITY,
	first_name varchar(255) not null,
	last_name varchar(255) not null
);

insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code></pre>
</div>
</div>
<div class="paragraph">
<p>脚本添加<code>surname</code>列。</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<div class="title">警告</div>
</td>
<td class="content">记住不要在添加的列上添加任何NOT NULL约束。如果您回滚JAR，则会导致旧版本没有添加列的概念，并且会自动设置NULL值。如果有约束，旧的应用程序将崩溃。
</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">-- NOTE: This field can't have the NOT NULL constraint cause if you rollback, the old version won't know about this field
-- and will always set it to NULL
ALTER TABLE PERSON ADD surname varchar(255);

-- WE'RE ASSUMING THAT IT'S A FAST MIGRATION - OTHERWISE WE WOULD HAVE TO MIGRATE IN BATCHES
UPDATE PERSON SET PERSON.surname = PERSON.last_name</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_code_changes_3">代码变更</h4>
<div class="paragraph">
<p>我们将数据存储在<code>last_name</code>和<code>surname</code> 。另外，我们正在从<code>last_name</code>列读取数据，因为它是最新的。在部署过程中，尚未升级的实例可能已处理了一些请求。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">/*
 * Copyright 2012-2016 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package sample.flyway;

import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;

@Entity
public class Person {
	@Id
	@GeneratedValue
	private Long id;
	private String firstName;
	private String lastName;
	private String surname;

	public String getFirstName() {
		return this.firstName;
	}

	public void setFirstName(String firstName) {
		this.firstName = firstName;
	}

	/**
	 * Reading from the new column if it's set. If not the from the old one.
	 *
	 * When migrating from version 1.0.0 -&gt; 2.0.0 this can lead to a possibility that some data in
	 * the surname column is not up to date (during the migration process lastName could have been updated).
	 * In this case one can run yet another migration script after all applications have been deployed in the
	 * new version to ensure that the surname field is updated.
	 *
	 * However it makes sense since when looking at the migration from 2.0.0 -&gt; 3.0.0. In 3.0.0 we no longer
	 * have a notion of lastName at all - so we don't update that column. If we rollback from 3.0.0 -&gt; 2.0.0 if we
	 * would be reading from lastName, then we would have very old data (since not a single datum was inserted
	 * to lastName in version 3.0.0).
	 */
	public String getSurname() {
		return this.surname != null ? this.surname : this.lastName;
	}

	/**
	 * Storing both FIRST_NAME and SURNAME entries
	 */
	public void setSurname(String surname) {
		this.lastName = surname;
		this.surname = surname;
	}

	@Override
	public String toString() {
		return "Person [firstName=" + this.firstName + ", lastName=" + this.lastName + ", surname=" + this.surname
				+ "]";
	}
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_3_removing_last_name_from_code">步骤3：从代码中删除姓氏</h3>
<div class="paragraph">
<p>应用程式版本： <code>3.0.0</code></p>
</div>
<div class="paragraph">
<p>数据库版本： <code>v3</code></p>
</div>
<div class="sect3">
<h4 id="_comment_4">评论</h4>
<div class="paragraph">
<p>通过添加新列并复制其内容，我们创建了数据库的向后兼容更改。ATM如果我们回滚JAR或同时运行旧的JAR，它将不会在运行时中断。</p>
</div>
<div class="sect4">
<h5 id="_rolling_back_the_application_3">回滚应用程序</h5>
<div class="paragraph">
<p>当前的情况是我们在<code>3.0.0</code>版本中有app，而在<code>v3</code> db。<code>3.0.0</code>版未将数据存储到<code>last_name</code>列中。这意味着最新信息存储在<code>surname</code>列中。</p>
</div>
<div class="paragraph">
<p>脚步：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>将您的应用回滚到<code>2.0.0</code>版本。</p>
</li>
<li>
<p><code>2.0.0</code>版同时使用了<code>last_name</code>和<code>surname</code>列。</p>
</li>
<li>
<p>如果版本<code>2.0.0</code>不为null，则将选择第一个<code>surname</code>列；如果不是，则将选择<code>last_name</code></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_db_changes_4">数据库更改</h4>
<div class="paragraph">
<p>数据库中没有结构更改。执行以下脚本，执行旧数据的最终迁移：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">-- WE'RE ASSUMING THAT IT'S A FAST MIGRATION - OTHERWISE WE WOULD HAVE TO MIGRATE IN BATCHES
-- ALSO WE'RE NOT CHECKING IF WE'RE NOT OVERRIDING EXISTING ENTRIES. WE WOULD HAVE TO COMPARE
-- ENTRY VERSIONS TO ENSURE THAT IF THERE IS ALREADY AN ENTRY WITH A HIGHER VERSION NUMBER
-- WE WILL NOT OVERRIDE IT.
UPDATE PERSON SET PERSON.surname = PERSON.last_name;

-- DROPPING THE NOT NULL CONSTRAINT; OTHERWISE YOU WILL TRY TO INSERT NULL VALUE OF THE LAST_NAME
-- WITH A NOT_NULL CONSTRAINT.
ALTER TABLE PERSON MODIFY COLUMN last_name varchar(255) NULL DEFAULT NULL;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_code_changes_4">代码变更</h4>
<div class="paragraph">
<p>我们将数据存储在<code>last_name</code>和<code>surname</code> 。另外，我们正在从<code>last_name</code>列读取数据，因为它是最新的。在部署过程中，尚未升级的实例可能已处理了一些请求。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">/*
 * Copyright 2012-2016 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package sample.flyway;

import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;

@Entity
public class Person {
	@Id
	@GeneratedValue
	private Long id;
	private String firstName;
	private String surname;

	public String getFirstName() {
		return this.firstName;
	}

	public void setFirstName(String firstName) {
		this.firstName = firstName;
	}

	public String getSurname() {
		return this.surname;
	}

	public void setSurname(String lastname) {
		this.surname = lastname;
	}

	@Override
	public String toString() {
		return "Person [firstName=" + this.firstName + ", surname=" + this.surname
				+ "]";
	}
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_4_removing_last_name_from_db">步骤4：从数据库中删除姓氏</h3>
<div class="paragraph">
<p>应用程式版本： <code>4.0.0</code></p>
</div>
<div class="paragraph">
<p>数据库版本： <code>v4</code></p>
</div>
<div class="sect3">
<h4 id="_comment_5">评论</h4>
<div class="paragraph">
<p>由于版本<code>3.0.0</code>的代码未使用<code>last_name</code>列，因此，如果从数据库中删除该列后回滚到<code>3.0.0</code> ，则在运行时不会发生任何问题。</p>
</div>
<div class="sect4">
<h5 id="_logs_from_script_execution_2">脚本执行日志</h5>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">We will do it in the following way:

01) Run 1.0.0
02) Wait for the app (1.0.0) to boot
03) Generate a person by calling POST localhost:9991/person to version 1.0.0
04) Run 2.0.0
05) Wait for the app (2.0.0) to boot
06) Generate a person by calling POST localhost:9991/person to version 1.0.0
07) Generate a person by calling POST localhost:9992/person to version 2.0.0
08) Kill app (1.0.0)
09) Run 3.0.0
10) Wait for the app (3.0.0) to boot
11) Generate a person by calling POST localhost:9992/person to version 2.0.0
12) Generate a person by calling POST localhost:9993/person to version 3.0.0
13) Kill app (3.0.0)
14) Run 4.0.0
15) Wait for the app (4.0.0) to boot
16) Generate a person by calling POST localhost:9993/person to version 3.0.0
17) Generate a person by calling POST localhost:9994/person to version 4.0.0


Starting app in version 1.0.0
Generate a person in version 1.0.0
Sending a post to 127.0.0.1:9991/person. This is the response:

{"firstName":"52b6e125-4a5c-429b-a47a-ef18bbc639d2","lastName":"52b6e125-4a5c-429b-a47a-ef18bbc639d2"}

Starting app in version 2.0.0

Generate a person in version 1.0.0
Sending a post to 127.0.0.1:9991/person. This is the response:

{"firstName":"e41ee756-4fa7-4737-b832-e28827a00deb","lastName":"e41ee756-4fa7-4737-b832-e28827a00deb"}

Generate a person in version 2.0.0
Sending a post to 127.0.0.1:9992/person. This is the response:

{"firstName":"0c1240f5-649a-4bc5-8aa9-cff855f3927f","lastName":"0c1240f5-649a-4bc5-8aa9-cff855f3927f","surname":"0c1240f5-649a-4bc5-8aa9-cff855f3927f"}

Killing app 1.0.0

Starting app in version 3.0.0

Generate a person in version 2.0.0
Sending a post to 127.0.0.1:9992/person. This is the response:
{"firstName":"74d84a9e-5f44-43b8-907c-148c6d26a71b","lastName":"74d84a9e-5f44-43b8-907c-148c6d26a71b","surname":"74d84a9e-5f44-43b8-907c-148c6d26a71b"}

Generate a person in version 3.0.0
Sending a post to 127.0.0.1:9993/person. This is the response:
{"firstName":"c6564dbe-9ab5-40ae-9077-8ae6668d5862","surname":"c6564dbe-9ab5-40ae-9077-8ae6668d5862"}

Killing app 2.0.0

Starting app in version 4.0.0

Generate a person in version 3.0.0
Sending a post to 127.0.0.1:9993/person. This is the response:

{"firstName":"cbe942fc-832e-45e9-a838-0fae25c10a51","surname":"cbe942fc-832e-45e9-a838-0fae25c10a51"}

Generate a person in version 4.0.0
Sending a post to 127.0.0.1:9994/person. This is the response:

{"firstName":"ff6857ce-9c41-413a-863e-358e2719bf88","surname":"ff6857ce-9c41-413a-863e-358e2719bf88"}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_db_changes_5">数据库更改</h4>
<div class="paragraph">
<p>与<code>v3</code>相比，我们只是删除了<code>last_name</code>列并添加了缺少的约束。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-sql" data-lang="sql">-- REMOVE THE COLUMN
ALTER TABLE PERSON DROP last_name;

-- ADD CONSTRAINTS
UPDATE PERSON SET surname='' WHERE surname IS NULL;
ALTER TABLE PERSON ALTER COLUMN surname VARCHAR NOT NULL;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_code_changes_5">代码变更</h4>
<div class="paragraph">
<p>没有代码更改。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_recap">概括</h3>
<div class="paragraph">
<p>我们已经通过执行几个向后兼容的部署成功地应用了重命名列的向后不兼容更改。您可以在此处找到已执行操作的摘要：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>使用数据库架构<code>v1</code>部署应用程序的<code>1.0.0</code>版（列名= <code>last_name</code> ）</p>
</li>
<li>
<p>部署将数据保存到<code>last_name</code>和<code>surname</code>列的应用程序的<code>2.0.0</code>版本。该应用程序从<code>last_name</code>列读取。Db在<code>v2</code>版本中同时包含<code>last_name</code>和<code>surname</code>列。<code>surname</code>列是<code>last_name</code>列的副本。（注意：此列不得具有非null约束）</p>
</li>
<li>
<p>部署应用程序的<code>3.0.0</code>版本，该版本仅将数据保存到<code>surname</code>并从<code>surname</code>读取。对于数据库，将<code>last_name</code>最终迁移到<code>surname</code> 。同样， <strong>NOT NULL</strong>约束也从<code>last_name</code>删除。db现在是<code>v3</code>版本</p>
</li>
<li>
<p>部署该应用程序的<code>4.0.0</code>版本-代码中没有任何更改。在<code>v4</code>中部署数据库，该数据库首先执行将<code>last_name</code>最终迁移到<code>surname</code>并删除<code>last_name</code>列。在这里您可以添加任何缺少的约束</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>通过遵循这种方法，您始终可以回滚一个版本，而不会破坏数据库/应用程序的兼容性。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_code">码</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/spring-cloud-samples/zero-downtime-deployment">Github</a>上提供了本文中使用的所有代码。您可以在下面找到一些其他说明。</p>
</div>
<div class="sect2">
<h3 id="_projects">专案</h3>
<div class="paragraph">
<p>克隆存储库后，您将看到以下文件夹结构。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">├── boot-flyway-v1              - 1.0.0 version of the app with v1 of the schema
├── boot-flyway-v2              - 2.0.0 version of the app with v2 of the schema (backward-compatible - app can be rolled back)
├── boot-flyway-v2-bad          - 2.0.0.BAD version of the app with v2bad of the schema (backward-incompatible - app cannot be rolled back)
├── boot-flyway-v3              - 3.0.0 version of the app with v3 of the schema (app can be rolled back)
└── boot-flyway-v4              - 4.0.0 version of the app with v4 of the schema (app can be rolled back)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_scripts">剧本</h3>
<div class="paragraph">
<p>您可以运行脚本来执行方案，该方案显示应用于数据库的向后兼容和不兼容更改。</p>
</div>
<div class="paragraph">
<p>要检查<strong>向后兼容的</strong>情况，只需运行：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">./scripts/scenario_backward_compatible.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>要检查<strong>向后不兼容的</strong>情况，只需运行：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-bash" data-lang="bash">./scripts/scenario_backward_incompatible.sh</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_boot_sample_flyway"> Spring Boot 子样品飞行</h3>
<div class="paragraph">
<p>所有示例都是<code>Spring Boot Sample Flyway</code>项目的克隆。</p>
</div>
<div class="paragraph">
<p>您可以查看<code><a href="http://localhost:8080/flyway" class="bare">http://localhost:8080/flyway</a></code>来查看脚本列表。</p>
</div>
<div class="paragraph">
<p>该示例还启用了H2控制台（位于<code><a href="http://localhost:8080/h2-console" class="bare">http://localhost:8080/h2-console</a></code> ），以便您可以查看数据库的状态（默认的jdbc URL为<code>jdbc:h2:mem:testdb</code> ）。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_additional_reading">附加阅读</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="http://databaserefactoring.com">数据库重构模式</a></p>
</li>
<li>
<p><a href="http://martinfowler.com/bliki/ContinuousDelivery.html">持续交付</a></p>
</li>
</ul>
</div>
</div>
</div></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 2513;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>请启用JavaScript以查看<a href="http://disqus.com/?ref_noscript">由Disqus提供</a>的<a href="http://disqus.com/?ref_noscript">评论。</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">由<span class="logo-disqus">Disqus</span>提供动力的评论</a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>背部</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">所有帖子</a> <a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">工程</a> <a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">发布</a> <a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">新闻与活动</a> <a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>将The Spring Team的更新发送到您的收件箱</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">球队</a></li>
<li><a href="/tools">工具类</a></li>
<li><a href="https://store.pivotal.io/">商店</a></li>
<li><a href="/blog">通讯</a></li>
</ul>
</div>
</div>© <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a> ，Inc.保留所有权利。
<a href="https://pivotal.io/terms-of-use">使用条款</a> • <a href="https://pivotal.io/privacy-policy">隐私</a> • <a href="/trademarks">商标准则</a>
<div id="teconsent" style="display:inline-block"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>