<html dir="ltr" data-code-prettify="" data-mobile-support="" data-search=""><head>
<title>多语言世界中的Spring Cloud Contract</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>System.config({baseURL: "/b92013b"});</script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>System.import('app/main.js')</script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="Spring Cloud Contract in a polyglot world">
<meta name="twitter:description" content="<div class=" paragrap="="> 
 </head><body dir="ltr"><p>This article contains a short reminder of what Contract Testing is, how Spring Cloud Contract implements it, and how Spring Cloud Contract can be used in a polyglot world.</p> 

<h1 id="what-is-contract-testing" class="sect0"><a class="anchor" href="#what-is-contract-testing"></a>What is Contract Testing</h1>
<div class="paragraph"> 
 <p>In order to increase the certainty that our systems behave properly, we write different types of tests. According to the <a href="https://martinfowler.com/bliki/TestPyramid.html">test pyramid</a> the main types of tests are unit, integration, and UI. The more complex the tests, the more time and effort they require and the more brittle they become.</p> 
</div>
<div class="paragraph"> 
 <p>In a distributed system, one of the most frequent problems is testing integrations between applications. Let’s assume that your service sends a REST request to another application. When using Spring Boot, you can write a <code>@SpringBootTest</code> in which you test that behavior. You set up a Spring context, you prepare a request to be sent…​ and where do you send it? You haven’t started the other application, so you get a <code>Connection Refused</code> exception. You can try mocking the real HTTP call and returning a fake response. However, if you do that, you do not test any real HTTP integration, serialization and deserialization mechanisms, and so on. You could also start a fake HTTP server (for example, <a href="http://wiremock.org">WireMock</a>) and simulate how it should behave. The problem here is that you, as a client of an API, define how the server behaves. In other words, if you tell the fake server to return text <code>testText</code> when a request is sent to endpoint <code>/myEndpoint</code>, it does just that, even if the real server does not have such an endpoint. In short, the problem is that the stubs might not be reliable.</p> 
</div>
">
<meta name="twitter:creator" content="@mgrzejszczak">
<meta name="twitter:image:src" content="https://gravatar.com/avatar/d4b43000c99fccc46455f42a841fa62e?s=200">

<meta property="og:title" content="Spring Cloud Contract in a polyglot world">
<meta property="og:image" content="https://gravatar.com/avatar/d4b43000c99fccc46455f42a841fa62e?s=200">
<meta property="og:description" content="<div class=" paragrap="="> 
 <p>This article contains a short reminder of what Contract Testing is, how Spring Cloud Contract implements it, and how Spring Cloud Contract can be used in a polyglot world.</p> 

<h1 id="what-is-contract-testing" class="sect0"><a class="anchor" href="#what-is-contract-testing"></a>What is Contract Testing</h1>
<div class="paragraph"> 
 <p>In order to increase the certainty that our systems behave properly, we write different types of tests. According to the <a href="https://martinfowler.com/bliki/TestPyramid.html">test pyramid</a> the main types of tests are unit, integration, and UI. The more complex the tests, the more time and effort they require and the more brittle they become.</p> 
</div>
<div class="paragraph"> 
 <p>In a distributed system, one of the most frequent problems is testing integrations between applications. Let’s assume that your service sends a REST request to another application. When using Spring Boot, you can write a <code>@SpringBootTest</code> in which you test that behavior. You set up a Spring context, you prepare a request to be sent…​ and where do you send it? You haven’t started the other application, so you get a <code>Connection Refused</code> exception. You can try mocking the real HTTP call and returning a fake response. However, if you do that, you do not test any real HTTP integration, serialization and deserialization mechanisms, and so on. You could also start a fake HTTP server (for example, <a href="http://wiremock.org">WireMock</a>) and simulate how it should behave. The problem here is that you, as a client of an API, define how the server behaves. In other words, if you tell the fake server to return text <code>testText</code> when a request is sent to endpoint <code>/myEndpoint</code>, it does just that, even if the real server does not have such an endpoint. In short, the problem is that the stubs might not be reliable.</p> 
</div>
">
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2018-02-13 20:37:00.0">



<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">// Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }</script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">多语言世界中的Spring Cloud Contract</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/d4b43000c99fccc46455f42a841fa62e?s=20&d=mm"> <a class="author" rel="author" href="/team/marcingrzejszczak">马尔辛·格热兹扎克（Marcin Grzejszczak）</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2018-02-13 20:37:00.0">2018年2月13日</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2018/02/13/spring-cloud-contract-in-a-polyglot-world#disqus_thread" data-disqus-identifier="3169">
</a></div>
</div>
</header>
<div class="blog--post"><div class="paragraph">
<p>本文简短地提醒您什么是合同测试，Spring Cloud Contract如何实现它以及如何在多语言世界中使用Spring Cloud Contract。</p>
</div>
<h1 id="what-is-contract-testing" class="sect0"><a class="anchor" href="#what-is-contract-testing"></a>什么是合同测试</h1>
<div class="paragraph">
<p>为了增加我们系统正常运行的确定性，我们编写了不同类型的测试。根据<a href="https://martinfowler.com/bliki/TestPyramid.html">测试金字塔</a> ， <a href="https://martinfowler.com/bliki/TestPyramid.html">测试</a>的主要类型是单元，集成和UI。测试越复杂，所需的时间和精力就越多，并且变得越脆。</p>
</div>
<div class="paragraph">
<p>在分布式系统中，最常见的问题之一是测试应用程序之间的集成。假设您的服务将REST请求发送到另一个应用程序。使用Spring Boot时，您可以编写一个<code>@SpringBootTest</code>在其中测试该行为。您设置了Spring上下文，准备了要发送的请求...该将其发送到哪里？您尚未启动其他应用程序，因此收到“ <code>Connection Refused</code>异常。您可以尝试模拟真实的HTTP调用并返回假响应。但是，如果这样做，则不会测试任何实际的HTTP集成，序列化和反序列化机制，等等。您还可以启动一个伪造的HTTP服务器（例如<a href="http://wiremock.org">WireMock</a> ）并模拟其行为。这里的问题是，作为API的客户端，您需要定义服务器的行为方式。换句话说，如果您告诉伪造的服务器在将请求发送到端点<code>/myEndpoint</code> <code>testText</code>时返回文本<code>testText</code> ，即使真实的服务器没有这样的端点，它也<code>/myEndpoint</code> 。简而言之，问题在于存根可能不可靠。</p>
</div>
<div class="paragraph">
<p>另一个问题是与第三方系统的集成。可能有一个共享实例由于高负载而每5分钟崩溃一次。在这种情况下，我们希望对该系统进行存根处理，以免影响我们的集成测试，但是我们需要这些存根来确保可靠性。</p>
</div>
<div class="paragraph">
<p>为端到端测试设置环境，生成所有应用程序以及通过在整个系统上运行来执行测试总是很诱人的。通常，这是一个很好的解决方案，可以增加您的业务功能仍然运行良好的信心。但是，端到端测试的问题在于它们经常会由于没有明显的原因而失败并且非常缓慢。没有比这更令人沮丧的是，在运行十个小时之后，由于API调用中的错字，端到端测试失败了。</p>
</div>
<div class="paragraph">
<p>解决此问题的一种潜在方法是合同测试。在详细介绍这些内容之前，我们先定义一些术语：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>producer</strong> ：服务器端所有者（例如，HTTP API的所有者）或通过队列发送的消息的生产者，例如RabbitMQ。</p>
</li>
<li>
<p><strong>消费者</strong> ：使用HTTP API或侦听通过（例如）RabbitMQ接收的消息的应用程序。</p>
</li>
<li>
<p><strong>合同</strong> ：生产者和消费者之间就通信外观应达成的协议。<strong>它不是架构</strong> 。它更多是一种使用场景。例如，对于这种特定情况，我期望指定的输入，然后使用指定的输出进行回复。</p>
</li>
<li>
<p><strong>合同测试</strong> ：一种验证生产者和消费者可以相互融合的测试。<strong>这并不意味着该功能有效</strong> 。这种区别很重要，因为您不希望通过为每个功能编写合同来重复您的工作。合同测试断言，生产者和消费者之间的集成符合合同中定义的要求。它们的主要优点是快速可靠。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以下示例显示了用YAML编写的合同：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-yml" data-lang="yml">request: # (1)
  method: PUT # (2)
  url: /fraudcheck # (3)
  body: # (4)
    "client.id": 1234567890
    loanAmount: 99999
  headers: # (5)
    Content-Type: application/json
  matchers:
    body:
      - path: $.['client.id'] # (6)
        type: by_regex
        value: "[0-9]{10}"
response: # (7)
  status: 200 # (8)
  body:  # (9)
    fraudCheckStatus: "FRAUD"
    "rejection.reason": "Amount too high"
  headers: # (10)
    Content-Type: application/json;charset=UTF-8


#From the Consumer perspective, when running a request in the integration test, we can interpret that test as follows:
#
#(1) - If the consumer sends a request
#(2) - With the "PUT" method
#(3) - to the URL "/fraudcheck"
#(4) - with the JSON body that
# * has a `client.id` field
# * has a `loanAmount` field that is equal to `99999`
#(5) - with `Content-Type` header equal to `application/json`
#(6) - and a `client.id` json entry matches a regular expression of `[0-9]{10}`
#(7) - then the response is sent with
#(8) - status equal to `200`
#(9) - and JSON body equal to
# { "fraudCheckStatus": "FRAUD", "rejection.reason": "Amount too high" }
#(10) - with header `Content-Type` equal to `application/json`
#
#From the Producer perspective, in the autogenerated producer-side test, we can interpret that test as follows:
#
#(1) - A request is sent to the producer
#(2) - With the "PUT" method
#(3) - to the URL "/fraudcheck"
#(4) - with the JSON body that
# * has a `client.id` field with a value of `1234567890`
# * has a `loanAmount` field with a value of `99999`
#(5) - with a `Content-Type` header equal to `application/json`
#(7) - then the test asserts if the response has been sent with
#(8) - status equal `200`
#(9) - and a JSON body equal to
# { "fraudCheckStatus": "FRAUD", "rejection.reason": "Amount too high" }
#(10) - with a `Content-Type` header equal to `application/json;charset=UTF-8`</code></pre>
</div>
</div>
<div class="paragraph">
<p>本文重点介绍合同测试的两种主要类型：生产者合同测试和消费者驱动的合同测试。它们之间的主要区别是生产者和消费者的合作风格。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>在<strong>生产者合同</strong>测试方法中，生产者定义合同并编写合同测试，描述API，并在不与客户合作的情况下发布存根。通常，当API是公开的并且API的所有者甚至不知道确切使用它的人时，就会发生这种情况。一个示例是<a href="https://start.spring.io">Spring Initializr</a> ，它使用<a href="https://cloud.spring.io/spring-cloud-static/Edgware.SR2/multi/multi__spring_cloud_contract_wiremock.html#_generating_stubs_using_rest_docs">Spring Rest Docs</a>测试发布其存根。版本<code>0.5.0.BUILD-SNAPSHOT</code></p><code>0.5.0.BUILD-SNAPSHOT</code></li><code>0.5.0.BUILD-SNAPSHOT</code></ul><code>0.5.0.BUILD-SNAPSHOT</code></div><code>0.5.0.BUILD-SNAPSHOT</code></div><code>0.5.0.BUILD-SNAPSHOT</code></div><code>0.5.0.BUILD-SNAPSHOT</code></article><code>0.5.0.BUILD-SNAPSHOT</code></div><code>0.5.0.BUILD-SNAPSHOT</code></div><code>0.5.0.BUILD-SNAPSHOT</code></div><code>0.5.0.BUILD-SNAPSHOT</code></div><code>0.5.0.BUILD-SNAPSHOT</code></body></html>