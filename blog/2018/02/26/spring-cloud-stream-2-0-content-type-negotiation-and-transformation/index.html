<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Spring Cloud Stream 2.0 - content-type negotiation and transformation</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Spring Cloud Stream 2.0 - content-type negotiation and transformation" />
<meta name="twitter:description" content="&lt;blockquote&gt; 
 &lt;p&gt;&lt;em&gt;This is the first blog in a series of pre-release blogs in preparation for Spring Cloud Stream 2.0.0.RELEASE.&lt;/em&gt;&lt;/p&gt; 
&lt;/blockquote&gt;
&lt;h3&gt;&lt;a href=&quot;#preface&quot; class=&quot;anchor&quot; name=&quot;preface&quot;&gt;&lt;/a&gt;Preface&lt;/h3&gt;
&lt;p&gt;Spring Cloud Stream 2.0 includes a complete revamp of content-type negotiation for the &lt;em&gt;channel-based binders&lt;/em&gt; to address performance, flexibility and most importantly consistency. The following blog touches on some of the key points around what has been done, what to expect and how it may help you.&lt;/p&gt;
&lt;h4&gt;&lt;a href=&quot;#introduction&quot; class=&quot;anchor&quot; name=&quot;introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h4&gt;
&lt;p&gt;Data transformation is one of the core features of any &lt;em&gt;message-driven&lt;/em&gt; microservice architecture. In Spring Cloud Stream, such data is represented as a Spring &lt;code&gt;Message&lt;/code&gt;. &lt;/p&gt;
" />
<meta name="twitter:creator" content="@z_oleg" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/b44844c62a496e582a467cf95806ae92?s=200" />

<meta property="og:title" content="Spring Cloud Stream 2.0 - content-type negotiation and transformation" />
<meta property="og:image" content="https://gravatar.com/avatar/b44844c62a496e582a467cf95806ae92?s=200" />
<meta property="og:description" content="&lt;blockquote&gt; 
 &lt;p&gt;&lt;em&gt;This is the first blog in a series of pre-release blogs in preparation for Spring Cloud Stream 2.0.0.RELEASE.&lt;/em&gt;&lt;/p&gt; 
&lt;/blockquote&gt;
&lt;h3&gt;&lt;a href=&quot;#preface&quot; class=&quot;anchor&quot; name=&quot;preface&quot;&gt;&lt;/a&gt;Preface&lt;/h3&gt;
&lt;p&gt;Spring Cloud Stream 2.0 includes a complete revamp of content-type negotiation for the &lt;em&gt;channel-based binders&lt;/em&gt; to address performance, flexibility and most importantly consistency. The following blog touches on some of the key points around what has been done, what to expect and how it may help you.&lt;/p&gt;
&lt;h4&gt;&lt;a href=&quot;#introduction&quot; class=&quot;anchor&quot; name=&quot;introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h4&gt;
&lt;p&gt;Data transformation is one of the core features of any &lt;em&gt;message-driven&lt;/em&gt; microservice architecture. In Spring Cloud Stream, such data is represented as a Spring &lt;code&gt;Message&lt;/code&gt;. &lt;/p&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2018-02-26 16:16:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Spring Cloud Stream 2.0 - content-type negotiation and transformation</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/b44844c62a496e582a467cf95806ae92?s=20&amp;d=mm" />
<a class="author" rel="author" href="/team/olegz">Oleg Zhurakousky</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2018-02-26 16:16:00.0">February 26, 2018</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="3184" href="/blog/2018/02/26/spring-cloud-stream-2-0-content-type-negotiation-and-transformation#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><blockquote>
<p><em>This is the first blog in a series of pre-release blogs in preparation for Spring Cloud Stream 2.0.0.RELEASE.</em></p>
</blockquote><h3><a href="#preface" class="anchor" name="preface"></a>Preface</h3>
<p>Spring Cloud Stream 2.0 includes a complete revamp of content-type negotiation for the <em>channel-based binders</em> to address performance, flexibility and most importantly consistency. The following blog touches on some of the key points around what has been done, what to expect and how it may help you.</p><h4><a href="#introduction" class="anchor" name="introduction"></a>Introduction</h4>
<p>Data transformation is one of the core features of any <em>message-driven</em> microservice architecture. In Spring Cloud Stream, such data is represented as a Spring <code>Message</code>. </p>
<p>At various points of the message flow (a stream), a message may have to be transformed to a desired shape/size before reaching its destination. This is required for two reasons:</p>
<p><em>1. To convert the contents of the incoming message <strong><em>from</em></strong> the wire format to match the signature of the application-provided handler.<br />2. To convert the contents of the outgoing message <strong><em>to</em></strong> the signature of the next handler (in the event there is some internal flow) or back to the wire format.</em></p>
<p>The wire format is typically <code>byte[]</code> and is governed by the binder implementation.</p>
<p>In Spring Cloud Stream Message, transformation is accomplished with a <code>org.springframework.messaging.converter.MessageConverter</code> abstraction.</p>
<p>The following sequence of steps shows a typical message flow and the transformation(s) a <code>Message</code> goes through described using a <code>Processor</code> contract of Spring Cloud Stream essentially covering requirements behind both an <em>inbound</em> and an <em>outbound</em> content transformations. </p>
<p><em>1. Receive a Spring <code>Message</code> in wire format from the binder<br />2. Ensure that an <em>input</em> <code>contentType</code> header is set in the Spring <code>Message</code><br />3. Convert the Spring <code>Message</code> <em>from</em> the wire format to the signature of the application supplied <code>MessageHandler</code><br />4. Invoke the application supplied <code>MessageHandler</code><br />5. Convert the return value of the <code>MessageHandler</code> back to the Spring <code>Message</code><br />6. Ensure that an <em>output</em> <code>contentType</code> header is set in Spring <code>Message</code><br />7. Convert the Spring <code>Message</code> back <em>to</em> the wire format</em><br />8. Send the Spring <code>Message</code> in the wire format back to the binder</p>
<p>While the above provides a complete summary of major state changes in the typical message flow, the devil is always in the details, so let&rsquo;s look at each step more closely.</p><h4><a href="#details" class="anchor" name="details"></a>Details</h4>
<ol>
<li>The incoming message is received by the binder and is sent to the binder&rsquo;s input channel (e.g., <code>Processor.INPUT&#39;</code>) in the wire format.</li>
<li>The internal input channel is pre-configured with a channel interceptor to inject the incoming message with the <code>contentType</code> header if and only if the incoming message does not already have a <code>contentType</code> header set. This is required to ensure that, if needed, downstream message conversion can take <code>contentType</code> into consideration (more on this later). The injected <code>contentType</code> comes from the <em>content-type</em> set per individual destination binding, with <code>application/json</code> being the default content type.<br /><em>For example, &lsquo;spring.cloud.stream.bindings.myInput.content-type=text/plain&rsquo; sets the content type to &lsquo;text/plain&rsquo; for the &lsquo;myInput&rsquo; (incoming) destination binding. This means that every incoming message is injected with the &lsquo;contentType=text/plain&rsquo; header unless the message already contains a &lsquo;contentType&rsquo; header.</em><br />In other words, header-provided <code>contentType</code> supersedes the one set per-binding.</li>
<li>Now, with the help of <code>HandlerMethodArgumentResolvers</code> and preconfigured or user-provided <code>MessageConverters</code>, the incoming message is converted to the signature of the application-provided <code>MessageHandler</code> (e.g.,<code>public Text process(Foo foo){..}</code>). Such handler methods are typically annotated with one of <code>@StreamListener</code>, <code>@ServiceActivator</code>, <code>@Transformer</code>, and others. This is where <code>contentType</code> may be required by some of the converters, and action in step 2 guarantees that such message always has it available via its <code>contentType</code> header. Of course, if such method takes <code>Message</code> as its input argument, no conversion is performed.</li>
<li>A handler method is invoked and, upon success, the process of creating an outgoing message from the return value of the handler method begins (assumes non-void handler method).</li>
<li>The value returned by the handler method is converted back to the Spring <code>Message</code> if and only if the return value is not already a <code>Message</code>. This means that a new Spring <code>Message</code> is created with the payload being the handler&rsquo;s return value. The incoming message&rsquo;s headers are copied into a new outgoing message, stripping away any headers identified by the <em>&lsquo;SpringIntegrationProperties.messageHandlerNotPropagatedHeaders&rsquo;</em>. By default, there is only one header set there - <code>contentType</code>. This means that the new outgoing message is created with no <code>contentType</code> header set. This is to ensure that the <code>contentType</code> can evolve with application-level transformation of the actual data.<br /><em>NOTE: The <code>contentType</code> is only stripped if the handler method returned a non-Message.</em><br />The message is sent to the binder&rsquo;s output channel.</li>
<li>Similar to the binder&rsquo;s input channel, the binder&rsquo;s output channel (e.g., <code>Processor.OUTPUT</code>) is also pre-configured with channel interceptor. This is where we optionally inject a <code>contentType</code> header into an outgoing message in preparation for transforming the content of the outgoing message back to the wire format. Let&rsquo;s look at the only two possible scenarios:<br />a. <strong><em>The outgoing Message has a <code>contentType</code> header set</em></strong>. Since the header-set <code>contentType</code> takes precedence over any other <code>contentType</code>, no <code>contentType</code> injection will be performed and the value of the header-set <code>contentType</code> will be used during the conversion back to the wire format.<br />b. <strong><em>The outgoing Message doesn&rsquo;t have a <code>contentType</code> header set</em></strong>. The binding <code>contentType</code> (default or provided) will be injected as the header into the outgoing message and used during the conversion back to the wire format.</li>
<li>The message is converted to the wire format using one of the available <code>MessageConverters</code>.</li>
<li>The converted message is sent back to the binder retaining the injected or existing <code>contentType</code> header. In other words, the outgoing message will <strong><em>always</em></strong> have <code>contentType</code> header present.</li>
</ol><h4><a href="#customization" class="anchor" name="customization"></a>Customization</h4>
<p>The above covers the default out-of-the-box behavior. But that may not be enough, so <em>can we and if so how can we customize?</em>.<br />The goal of the content-type negotiation improvements that went into 2.0 was not only to answer these type of questions but to ensure that the answer is consistent - <em>the &lsquo;MessageConverters&rsquo; used by the <em>inbound</em> and <em>outbound</em> channel interceptors to convert to/from wire format are the same &lsquo;MessageConverters&rsquo; used by the &lsquo;HandlerMethodArgumentResolvers&rsquo; to convert to/from strong types</em>.</p>
<p>To add custom a <em>MessageConverter</em> simply create an implementation of the <code>org.springframework.messaging.converter.MessageConverter</code> and configure it as a <code>@Bean</code> and also annotate the bean as <code>@StreamMessageConverter</code> and it will be added as the first converter in the stack of existing <em>MessageConverters</em> essentially taking precedence over the existing <em>MessageConverters</em>.</p><h3><a href="#summary" class="anchor" name="summary"></a>Summary</h3>
<p>Hopefully by now it&rsquo;s fairly clear that <em>any and all</em> content-type transformations are done by the <code>MessageConverters</code>. While <code>MessageConverters</code> differ in their implementation most utilize both <code>contentType</code> header as well as the target type (<code>targetClass</code>) which allows them to perform intra-type conversions as well as to/from wire format conversions.<br />Currently there is a set of pre-configured <code>MessageConverters</code> to support majority of the use cases, so for most typical data types (i.e., json, text etc) nothing really needs to be done by the end user. Yet it&rsquo;s worth knowing how things work now vs. how to customize - <em>customize the existing and/or bring new <code>MessageConverter</code> implementation</em>.</p><h3><a href="#conclusion" class="anchor" name="conclusion"></a>Conclusion</h3>
<p>We&rsquo;re currently in the process of updating documentation where we&rsquo;ll be including more details and samples around this and many other subjects relevant to the work that went into 2.0, while the goal of these pre-release blogs is to primarily raise the awareness, facilitate the &ldquo;give it a try&rdquo; and solicit the feedback.<br />With that said; The Spring Cloud Stream 2.0.0.RC1 is available <a href="https://cloud.spring.io/spring-cloud-stream/">here</a></p>
<p>We encourage you to provide feedback using one of the following facilities:<br />- <a href="https://github.com/spring-cloud/spring-cloud-stream/issues">Project&rsquo;s GitHub Issues </a><br />- <a href="https://stackoverflow.com/tags/spring-cloud-stream">Stack Overflow channel</a><br />- <a href="https://gitter.im/spring-cloud/spring-cloud-stream">Gitter channel</a></p>
<p>Enjoy!</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 3184;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>