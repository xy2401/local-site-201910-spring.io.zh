<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>What&#39;s new in Spring Data Lovelace for MongoDB?</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="What&#39;s new in Spring Data Lovelace for MongoDB?" />
<meta name="twitter:description" content="&lt;div class=&quot;paragraph&quot;&gt; 
 &lt;p&gt;The past year has seen a lot of enhancements brought to the NoSQL Store including a bunch of new features and extended capabilities. We collaborated closely with the driver team at MongoDB, so the release already ships with decent support for sessions, change streams, schema validation, and (of course) transactions.&lt;/p&gt; 
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt; 
 &lt;p&gt;The most interesting new feature is probably MongoDB 4.0’s support for &lt;a href=&quot;https://www.mongodb.com/transactions&quot;&gt;Multi-Document Transactions&lt;/a&gt;. If you have followed this blog before, you have probably read our &lt;a href=&quot;https://spring.io/blog/2018/06/28/hands-on-mongodb-4-0-transactions-with-spring-data&quot;&gt;Hands on Guide&lt;/a&gt; that explains both &lt;code&gt;ClientSessions&lt;/code&gt; (which are the main building block) and transactions themselves. In short, SpringData provides you with everything you need to leverage &lt;a href=&quot;https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction&quot;&gt;Spring managed transaction support&lt;/a&gt; in your project. To use it, declare &lt;code&gt;MongoTransactionManager&lt;/code&gt; in your configuration, as the following example shows:&lt;/p&gt; 
&lt;/div&gt;
" />
<meta name="twitter:creator" content="@stroblchristoph" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/eeacd6c45e867cb36eb05c9daa5cc2de?s=200" />

<meta property="og:title" content="What&#39;s new in Spring Data Lovelace for MongoDB?" />
<meta property="og:image" content="https://gravatar.com/avatar/eeacd6c45e867cb36eb05c9daa5cc2de?s=200" />
<meta property="og:description" content="&lt;div class=&quot;paragraph&quot;&gt; 
 &lt;p&gt;The past year has seen a lot of enhancements brought to the NoSQL Store including a bunch of new features and extended capabilities. We collaborated closely with the driver team at MongoDB, so the release already ships with decent support for sessions, change streams, schema validation, and (of course) transactions.&lt;/p&gt; 
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt; 
 &lt;p&gt;The most interesting new feature is probably MongoDB 4.0’s support for &lt;a href=&quot;https://www.mongodb.com/transactions&quot;&gt;Multi-Document Transactions&lt;/a&gt;. If you have followed this blog before, you have probably read our &lt;a href=&quot;https://spring.io/blog/2018/06/28/hands-on-mongodb-4-0-transactions-with-spring-data&quot;&gt;Hands on Guide&lt;/a&gt; that explains both &lt;code&gt;ClientSessions&lt;/code&gt; (which are the main building block) and transactions themselves. In short, SpringData provides you with everything you need to leverage &lt;a href=&quot;https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction&quot;&gt;Spring managed transaction support&lt;/a&gt; in your project. To use it, declare &lt;code&gt;MongoTransactionManager&lt;/code&gt; in your configuration, as the following example shows:&lt;/p&gt; 
&lt;/div&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2018-09-27 14:45:40.257" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">What&#39;s new in Spring Data Lovelace for MongoDB?</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/eeacd6c45e867cb36eb05c9daa5cc2de?s=20&amp;d=mm" />
<a class="author" rel="author" href="/team/christophstrobl">Christoph Strobl</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2018-09-27 14:45:40.257">September 27, 2018</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="3409" href="/blog/2018/09/27/what-s-new-in-spring-data-lovelace-for-mongodb#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><div class="paragraph">
<p>The past year has seen a lot of enhancements brought to the NoSQL Store including a bunch of new features and extended capabilities. We collaborated closely with the driver team at MongoDB, so the release already ships with decent support for sessions, change streams, schema validation, and (of course) transactions.</p>
</div>
<div class="paragraph">
<p>The most interesting new feature is probably MongoDB 4.0&#8217;s support for <a href="https://www.mongodb.com/transactions">Multi-Document Transactions</a>. If you have followed this blog before, you have probably read our <a href="https://spring.io/blog/2018/06/28/hands-on-mongodb-4-0-transactions-with-spring-data">Hands on Guide</a> that explains both <code>ClientSessions</code> (which are the main building block) and transactions themselves.
In short, SpringData provides you with everything you need to leverage <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction">Spring managed transaction support</a> in your project.
To use it, declare <code>MongoTransactionManager</code> in your configuration, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
class Config extends AbstractMongoConfiguration {

  @Bean
  MongoTransactionManager transactionManager(MongoDbFactory dbFactory) {
    return new MongoTransactionManager(dbFactory);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Transactions operate on top of snapshots and, therefore, changes made during a transaction appear a little odd within the oplog.
Thankfully, <a href="https://docs.mongodb.com/manual/changeStreams/">change streams</a> have been introduced in MongoDB 3.6 to replace the current oplog tailing with a well supported solution that is capable of untangling entries during a transaction.
Change streams let you get notified whenever a certain event happens on the database or even the collection level.
It provides the means to filter events by using Aggregations but also lets you resume the stream at a given checkpoint or timestamp.
Consuming a change stream feels most natural when done with a reactive API, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Flux changeStream = reactiveTemplate
  .changeStream(newAggregation(match(where("operationType").is("insert"))),
    Person.class, ChangeStreamOptions.empty(), "users");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding stream returns only new documents that are inserted into the <code>users</code> collection and maps those to the <code>Person</code> domain type.
To achieve the same by using a synchronous API creates a long running blocking task that needs to be delegated to a separate component, a <code>MessageListenerContainer</code>, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">MessageListenerContainer container =
  new DefaultMessageListenerContainer(template);
container.start();

MessageListener&lt;ChangeStreamDocument&lt;Document&gt;, Person&gt; listener =
  System.out::println;

ChangeStreamRequest request = ChangeStreamRequest.builder()
  .collection("users")
  .filter(newAggregation(match(where("operationType").is("insert")))
  .publishTo(listener)
  .build();

container.register(request, Person.class);

// …

container.stop();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Having a <code>MessageListenerContainer</code> in place opens up other possibilities.
Using infinite streams with a tailable cursor on a capped collection has been limited to the reactive API so far.
Now it is a matter of passing a <code>SubscriptionRequest</code> to the container, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">MessageListener&lt;Document, Person&gt; listener = System.out::println;

TailableCursorRequest request = TailableCursorRequest.builder()
  .collection("users")
  .filter(query(where("active").eq(true)))
  .publishTo(listener)
  .build();

container.register(request, Person.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The preceding snippet listens to inserts on the <code>users</code> collection and publishes <code>Messages</code> on the console.
For quite a while, MongoDB has allowed validating documents that are added to a collection or updated within a collection by using a validator that follows the overall query syntax.
With its new version, MongoDB extended this validation by adding support for <a href="https://docs.mongodb.com/manual/core/schema-validation/#json-schema">JSON Schema</a>, which lets you define the document blueprint in more object oriented approach.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">{
  "type": "object",
  "required": [ "lastname" ],
  "properties": {
    "lastname": {
      "type": "string"
    },
    "address": {
      "type": "object",
      "properties": {
        "postCode": { "type": "string", "minLength": 4, "maxLength": 5 }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>MongoJsonSchema</code> and its builder is the Spring Data API gateway to defining a schema for your collection. The following example shows how to use it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">MongoJsonSchema jsonSchema = MongoJsonSchema.builder()
  .required("lastname")
  .properties(
     string("lastname"),
     object("address")
       .properties(string("postCode").minLength(4).maxLength(5))
  ).build();

CollectionOptions options = CollectionOptions.empty().schema(jsonSchema);

template.createCollection(Person.class, options);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Still, MongoDB, being a schema-less store, lets fields have different types on a per-document level. You can also use the schema to query for documents that match the blueprint without having to force a validation onto the collection, as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">template.query(Person.class)
  .matching(query(matchingDocumentStructure(jsonSchema))).all();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another minor but noticeable enhancement to the MongoDB module comes in the form of distinct value queries that let you retrieve a distinct list of all values assigned to a single field.
As mentioned before, fields do not necessarily have to have the same data type. That is why, by default, <code>distinct</code> returns an untyped <code>Collection</code>. The following example shows how to use <code>distinct</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">List&lt;Object&gt; distinctValues = template.query(Person.class)
  .distinct("active")
  .all();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The active flag might be a mixture of maybe "y/n", "true/false" and "0/1" pairs represented as <code>String</code>, <code>boolean</code>, and (maybe) <code>int32</code> within the store itself.
However, in cases where you are certain about at least the property type, it may be useful to use the <code>as</code> projection to obtain a strongly typed collection. The following example uses the <code>as</code> projection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">List&lt;Boolean&gt; distinctValues = template.query(Person.class)
  .distinct("active")
  .as(Boolean)
  .all();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Several other enhancements have found their way into the MongoDB module, but we do not have the space to address them here.
Make sure to check out the <a href="https://docs.spring.io/spring-data/mongodb/docs/2.1.0.RELEASE/reference/html/#new-features.2-1-0">new features</a> section in the reference documentation to learn more about reactive MapReduce, default sorting, <code>findAndReplace(…)</code> methods, and new Aggregation operators and stages.</p>
</div></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 3409;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>