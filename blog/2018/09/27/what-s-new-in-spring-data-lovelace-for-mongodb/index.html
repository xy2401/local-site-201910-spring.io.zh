<html dir="ltr" data-code-prettify="" data-mobile-support="" data-search=""><head>
<title>Spring Data Lovelace for MongoDB的新功能是什么？</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>System.config({baseURL: "/b92013b"});</script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>System.import('app/main.js')</script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="What's new in Spring Data Lovelace for MongoDB?">
<meta name="twitter:description" content="<div class=" paragrap="="> 
 </head><body dir="ltr"><p>The past year has seen a lot of enhancements brought to the NoSQL Store including a bunch of new features and extended capabilities. We collaborated closely with the driver team at MongoDB, so the release already ships with decent support for sessions, change streams, schema validation, and (of course) transactions.</p> 

<div class="paragraph"> 
 <p>The most interesting new feature is probably MongoDB 4.0’s support for <a href="https://www.mongodb.com/transactions">Multi-Document Transactions</a>. If you have followed this blog before, you have probably read our <a href="https://spring.io/blog/2018/06/28/hands-on-mongodb-4-0-transactions-with-spring-data">Hands on Guide</a> that explains both <code>ClientSessions</code> (which are the main building block) and transactions themselves. In short, SpringData provides you with everything you need to leverage <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction">Spring managed transaction support</a> in your project. To use it, declare <code>MongoTransactionManager</code> in your configuration, as the following example shows:</p> 
</div>
">
<meta name="twitter:creator" content="@stroblchristoph">
<meta name="twitter:image:src" content="https://gravatar.com/avatar/eeacd6c45e867cb36eb05c9daa5cc2de?s=200">

<meta property="og:title" content="What's new in Spring Data Lovelace for MongoDB?">
<meta property="og:image" content="https://gravatar.com/avatar/eeacd6c45e867cb36eb05c9daa5cc2de?s=200">
<meta property="og:description" content="<div class=" paragrap="="> 
 <p>The past year has seen a lot of enhancements brought to the NoSQL Store including a bunch of new features and extended capabilities. We collaborated closely with the driver team at MongoDB, so the release already ships with decent support for sessions, change streams, schema validation, and (of course) transactions.</p> 

<div class="paragraph"> 
 <p>The most interesting new feature is probably MongoDB 4.0’s support for <a href="https://www.mongodb.com/transactions">Multi-Document Transactions</a>. If you have followed this blog before, you have probably read our <a href="https://spring.io/blog/2018/06/28/hands-on-mongodb-4-0-transactions-with-spring-data">Hands on Guide</a> that explains both <code>ClientSessions</code> (which are the main building block) and transactions themselves. In short, SpringData provides you with everything you need to leverage <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction">Spring managed transaction support</a> in your project. To use it, declare <code>MongoTransactionManager</code> in your configuration, as the following example shows:</p> 
</div>
">
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2018-09-27 14:45:40.257">



<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">// Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }</script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Spring Data Lovelace for MongoDB的新功能是什么？</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/eeacd6c45e867cb36eb05c9daa5cc2de?s=20&d=mm"> <a class="author" rel="author" href="/team/christophstrobl">克里斯多夫·斯特罗布尔</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2018-09-27 14:45:40.257">九月27，2018</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2018/09/27/what-s-new-in-spring-data-lovelace-for-mongodb#disqus_thread" data-disqus-identifier="3409">
</a></div>
</div>
</header>
<div class="blog--post"><div class="paragraph">
<p>在过去的一年中，NoSQL Store进行了许多增强，包括一系列新功能和扩展功能。我们与MongoDB的驱动程序团队密切合作，因此该发行版已经提供了对会话，更改流，架构验证和（当然）事务的良好支持。</p>
</div>
<div class="paragraph">
<p>最有趣的新功能可能是MongoDB 4.0对<a href="https://www.mongodb.com/transactions">多文档事务</a>的支持。如果您以前关注过此博客，则可能已经阅读了<a href="https://spring.io/blog/2018/06/28/hands-on-mongodb-4-0-transactions-with-spring-data">动手指南</a> ，该<a href="https://spring.io/blog/2018/06/28/hands-on-mongodb-4-0-transactions-with-spring-data">指南</a>既介绍了<code>ClientSessions</code> （主要的构建模块）又介绍了交易本身。简而言之，SpringData为您提供了在项目中利用<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/data-access.html#transaction">Spring托管事务支持</a>所需的一切。要使用它， <code>MongoTransactionManager</code>在您的配置中声明<code>MongoTransactionManager</code> ，如以下示例所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Configuration
class Config extends AbstractMongoConfiguration {

  @Bean
  MongoTransactionManager transactionManager(MongoDbFactory dbFactory) {
    return new MongoTransactionManager(dbFactory);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>事务在快照之上运行，因此，在事务期间进行的更改在操作日志中显得有些奇怪。值得庆幸的是，MongoDB 3.6中引入了<a href="https://docs.mongodb.com/manual/changeStreams/">变更流</a> ，以支持良好的解决方案代替当前的oplog拖尾，该解决方案能够在事务处理期间解开条目。更改流使您可以在数据库甚至集合级别发生特定事件时得到通知。它提供了使用聚合来过滤事件的方法，而且还允许您在给定的检查点或时间戳记下恢复流。使用反应式API时，使用变更流是最自然的，如以下示例所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Flux changeStream = reactiveTemplate
  .changeStream(newAggregation(match(where("operationType").is("insert"))),
    Person.class, ChangeStreamOptions.empty(), "users");</code></pre>
</div>
</div>
<div class="paragraph">
<p>前面的流仅返回插入到<code>users</code>集合中的新文档，并将它们映射到<code>Person</code>域类型。要通过使用同步API来实现相同目的，需要创建一个长期运行的阻塞任务，该任务需要委托给一个单独的组件<code>MessageListenerContainer</code> ，如以下示例所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">MessageListenerContainer container =
  new DefaultMessageListenerContainer(template);
container.start();

MessageListener<ChangeStreamDocument<Document>, Person> listener =
  System.out::println;

ChangeStreamRequest request = ChangeStreamRequest.builder()
  .collection("users")
  .filter(newAggregation(match(where("operationType").is("insert")))
  .publishTo(listener)
  .build();

container.register(request, Person.class);

// …

container.stop();</code></pre>
</div>
</div>
<div class="paragraph">
<p>放置一个<code>MessageListenerContainer</code>其他可能性。到目前为止，在带上限的集合上使用带有可拖尾游标的无限流仅限于反应式API。现在，只需将<code>SubscriptionRequest</code>传递到容器即可，如以下示例所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">MessageListener<Document, Person> listener = System.out::println;

TailableCursorRequest request = TailableCursorRequest.builder()
  .collection("users")
  .filter(query(where("active").eq(true)))
  .publishTo(listener)
  .build();

container.register(request, Person.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>前面的代码段侦听了<code>users</code>集合上的插入内容，并在控制台上发布了<code>Messages</code> 。很长一段时间以来，MongoDB允许使用遵循整体查询语法的验证器来验证添加到集合中或在集合中更新的文档。在其新版本中，MongoDB通过添加对<a href="https://docs.mongodb.com/manual/core/schema-validation/#json-schema">JSON Schema的</a>支持来扩展了此验证，它使您可以使用更多面向对象的方法来定义文档蓝图。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">{
  "type": "object",
  "required": [ "lastname" ],
  "properties": {
    "lastname": {
      "type": "string"
    },
    "address": {
      "type": "object",
      "properties": {
        "postCode": { "type": "string", "minLength": 4, "maxLength": 5 }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>MongoJsonSchema</code>及其构建器是Spring Data API网关，用于为您的集合定义架构。以下示例显示了如何使用它：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">MongoJsonSchema jsonSchema = MongoJsonSchema.builder()
  .required("lastname")
  .properties(
     string("lastname"),
     object("address")
       .properties(string("postCode").minLength(4).maxLength(5))
  ).build();

CollectionOptions options = CollectionOptions.empty().schema(jsonSchema);

template.createCollection(Person.class, options);</code></pre>
</div>
</div>
<div class="paragraph">
<p>不过，MongoDB是一种无模式的存储，它使每个文档级别的字段具有不同的类型。您还可以使用该模式查询与蓝图匹配的文档，而不必强制对集合进行验证，如以下示例所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">template.query(Person.class)
  .matching(query(matchingDocumentStructure(jsonSchema))).all();</code></pre>
</div>
</div>
<div class="paragraph">
<p>MongoDB模块的另一个较小但值得注意的增强功能是不同值查询的形式，使您可以检索分配给单个字段的所有值的不同列表。如前所述，字段不一定必须具有相同的数据类型。这就是为什么，在默认情况下， <code>distinct</code>收益非类型化的<code>Collection</code> 。以下示例显示了如何使用<code>distinct</code> ：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">List<Object> distinctValues = template.query(Person.class)
  .distinct("active")
  .all();</code></pre>
</div>
</div>
<div class="paragraph">
<p>活动标志可能是“ y / n”，“ true / false”和“ 0/1”对的混合，表示为商店本身内的<code>String</code> ， <code>boolean</code>和<code>int32</code> 。但是，在至少确定属性类型的情况下，使用<code>as</code>投影来获得强类型集合可能很有用。以下示例将<code>as</code>投影：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">List<Boolean> distinctValues = template.query(Person.class)
  .distinct("active")
  .as(Boolean)
  .all();</code></pre>
</div>
</div>
<div class="paragraph">
<p>已经在MongoDB模块中找到了其他一些增强功能，但是我们在这里没有空间来解决它们。确保检查参考文档中的“ <a href="https://docs.spring.io/spring-data/mongodb/docs/2.1.0.RELEASE/reference/html/#new-features.2-1-0">新功能”</a>部分，以了解有关反应式MapReduce，默认排序， <code>findAndReplace(…)</code>方法以及新的Aggregation运算符和阶段的更多信息。</p>
</div></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">var disqus_shortname = 'spring-io';
      var disqus_identifier = 3409;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));</script>
<noscript>请启用JavaScript以查看<a href="http://disqus.com/?ref_noscript">由Disqus提供</a>的<a href="http://disqus.com/?ref_noscript">评论。</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">由<span class="logo-disqus">Disqus</span>提供动力的评论</a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>背部</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">所有帖子</a> <a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">工程</a> <a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">发布</a> <a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">新闻与活动</a> <a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>将The Spring Team的更新发送到您的收件箱</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });</script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">球队</a></li>
<li><a href="/tools">工具类</a></li>
<li><a href="https://store.pivotal.io/">商店</a></li>
<li><a href="/blog">通讯</a></li>
</ul>
</div>
</div>© <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a> ，Inc.保留所有权利。
<a href="https://pivotal.io/terms-of-use">使用条款</a> • <a href="https://pivotal.io/privacy-policy">隐私</a> • <a href="/trademarks">商标准则</a>
<div id="teconsent" style="display:inline-block"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>