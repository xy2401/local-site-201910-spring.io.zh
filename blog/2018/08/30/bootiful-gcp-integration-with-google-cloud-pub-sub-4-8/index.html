<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Bootiful GCP: Integration with Google Cloud Pub/Sub (4/8)</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Bootiful GCP: Integration with Google Cloud Pub/Sub (4/8)" />
<meta name="twitter:description" content="&lt;blockquote&gt; 
 &lt;p&gt;Hi Spring fans! In this brief 8 part series we’re going to look at the Spring Cloud integration for Google Cloud Platform, called Spring Cloud GCP. &lt;a href=&quot;https://cloud.spring.io/spring-cloud-gcp/&quot;&gt;Spring Cloud GCP&lt;/a&gt; represents a joint effort between Google and Pivotal that endeavors to provide a first class experience for Spring Cloud developers when using the Google Cloud Platform. Pivotal Cloud Foundry users will enjoy an even &lt;a href=&quot;https://docs.pivotal.io/partners/gcp-sb/index.html&quot;&gt;easier integration with the GCP service broker&lt;/a&gt;. I wrote these installments with input from Google Cloud Developer Advocate, and my buddy, &lt;a href=&quot;http://twitter.com/saturnism&quot;&gt;Ray Tsang&lt;/a&gt;. You can also catch a walkthrough of Spring Cloud GCP in our Google Next 2018 session, &lt;a href=&quot;https://www.youtube.com/watch?v=2Jo3vy7iQf8&quot;&gt;Bootiful Google Cloud Platform&lt;/a&gt;. Thanks buddy! As always, &lt;a href=&quot;http://twitter.com/starbuxman&quot;&gt;I’d love to hear from you if you have feedback&lt;/a&gt;.&lt;/p&gt; 
&lt;/blockquote&gt;
" />
<meta name="twitter:creator" content="@starbuxman" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/fb22593caf24e4bb4c98d467cdd247e6?s=200" />

<meta property="og:title" content="Bootiful GCP: Integration with Google Cloud Pub/Sub (4/8)" />
<meta property="og:image" content="https://gravatar.com/avatar/fb22593caf24e4bb4c98d467cdd247e6?s=200" />
<meta property="og:description" content="&lt;blockquote&gt; 
 &lt;p&gt;Hi Spring fans! In this brief 8 part series we’re going to look at the Spring Cloud integration for Google Cloud Platform, called Spring Cloud GCP. &lt;a href=&quot;https://cloud.spring.io/spring-cloud-gcp/&quot;&gt;Spring Cloud GCP&lt;/a&gt; represents a joint effort between Google and Pivotal that endeavors to provide a first class experience for Spring Cloud developers when using the Google Cloud Platform. Pivotal Cloud Foundry users will enjoy an even &lt;a href=&quot;https://docs.pivotal.io/partners/gcp-sb/index.html&quot;&gt;easier integration with the GCP service broker&lt;/a&gt;. I wrote these installments with input from Google Cloud Developer Advocate, and my buddy, &lt;a href=&quot;http://twitter.com/saturnism&quot;&gt;Ray Tsang&lt;/a&gt;. You can also catch a walkthrough of Spring Cloud GCP in our Google Next 2018 session, &lt;a href=&quot;https://www.youtube.com/watch?v=2Jo3vy7iQf8&quot;&gt;Bootiful Google Cloud Platform&lt;/a&gt;. Thanks buddy! As always, &lt;a href=&quot;http://twitter.com/starbuxman&quot;&gt;I’d love to hear from you if you have feedback&lt;/a&gt;.&lt;/p&gt; 
&lt;/blockquote&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2018-08-30 00:00:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Bootiful GCP: Integration with Google Cloud Pub/Sub (4/8)</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/fb22593caf24e4bb4c98d467cdd247e6?s=20&amp;d=mm" />
<a class="author" rel="author" href="/team/jlong">Josh Long</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2018-08-30 00:00:00.0">August 30, 2018</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="3366" href="/blog/2018/08/30/bootiful-gcp-integration-with-google-cloud-pub-sub-4-8#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><blockquote>
<p>Hi Spring fans! In this brief 8 part series we’re going to look at the Spring Cloud integration for Google Cloud Platform, called Spring Cloud GCP. <a href="https://cloud.spring.io/spring-cloud-gcp/">Spring Cloud GCP</a> represents a joint effort between Google and Pivotal that endeavors to provide a first class experience for Spring Cloud developers when using the Google Cloud Platform. Pivotal Cloud Foundry users will enjoy an even <a href="https://docs.pivotal.io/partners/gcp-sb/index.html">easier integration with the GCP service broker</a>. I wrote these installments with input from Google Cloud Developer Advocate, and my buddy, <a href="https://twitter.com/saturnism">Ray Tsang</a>. You can also catch a walkthrough of Spring Cloud GCP in our Google Next 2018 session, <a href="https://www.youtube.com/watch?v=2Jo3vy7iQf8">Bootiful Google Cloud Platform</a>. Thanks buddy! As always, <a href="https://twitter.com/starbuxman">I&rsquo;d love to hear from you if you have feedback</a>.</p>
</blockquote>
<p>There are eight posts in the series. Here they all are: </p>
<ul>
<li><a href="https://spring.io/blog/2018/08/20/bootiful-gcp-getting-started-with-spring-cloud-for-google-cloud-platform-1-8">Bootiful GCP: Getting Started with Spring Cloud for Google Cloud Platform (1/8)</a></li>
<li><a href="https://spring.io/blog/2018/08/23/bootiful-gcp-relational-data-access-with-spring-cloud-gcp-2-8">Bootiful GCP: Relational Data Access with Spring Cloud GCP (2/8)</a></li>
<li><a href="https://spring.io/blog/2018/08/27/bootiful-gcp-globally-consistent-data-access-with-spanner-3-8">Bootiful GCP: Globally Consistent Data Access with Spanner (3/8)</a></li>
<li><a href="https://spring.io/blog/2018/08/30/bootiful-gcp-integration-with-google-cloud-pub-sub-4-8">Bootiful GCP: Integration with Google Cloud Pub/Sub (4/8)</a></li>
<li><a href="https://spring.io/blog/2018/09/03/bootiful-gcp-runtime-configuration-with-spring-cloud-gcp-runtime-config-5-8">Bootiful GCP: Runtime Configuration with Spring Cloud GCP Runtime Config (5/8)</a></li>
<li><a href="https://spring.io/blog/2018/09/06/bootiful-gcp-supporting-observability-with-spring-cloud-gcp-stackdriver-trace-6-8">Bootiful GCP: Supporting Observability with Spring Cloud GCP Stackdriver Trace (6/8)<br /></a></li>
<li><a href="https://spring.io/blog/2018/09/10/bootiful-gcp-use-spring-cloud-gcp-to-connect-to-other-gcp-services-7-8">Bootiful GCP: Use Spring Cloud GCP to Connect to Other GCP Services (7/8)<br /> </a></li>
<li><a href="https://spring.io/blog/2018/09/13/bootiful-gcp-to-production-8-8">Bootiful GCP: To Production! (8/8)</a></li>
</ul>
<p>Let’s look at application integration with Google Cloud Pub/Sub. Google Cloud Pub/Sub supports a number of classic enterprise application integration use cases at Google scale. The <a href="https://cloud.google.com/pubsub/docs/overview">Google Cloud website for Pub/Sub</a> lists some:</p>
<ul>
<li>
<p><strong>Balancing workloads in network clusters</strong>. For example, a large queue of tasks can be efficiently distributed among multiple workers, such as Google Compute Engine instances.</p></li>
<li>
<p><strong>Implementing asynchronous workflows</strong>. For example, an order processing application can place an order on a topic, from which it can be processed by one or more workers.</p></li>
<li>
<p><strong>Distributing event notifications</strong>. For example, a service that accepts user signups can send notifications whenever a new user registers, and downstream services can subscribe to receive notifications of the event.</p></li>
<li>
<p><strong>Refreshing distributed caches</strong>. For example, an application can publish invalidation events to update the IDs of objects that have changed.</p></li>
<li>
<p><strong>Logging to multiple systems</strong>. For example, a Google Compute Engine instance can write logs to the monitoring system, to a database for later querying, and so on.</p></li>
<li>
<p><strong>Data streaming from various processes or devices</strong>. For example, a residential sensor can stream data to backend servers hosted in the cloud.</p></li>
<li>
<p><strong>Reliability improvement</strong>. For example, a single-zone Compute Engine service can operate in additional zones by subscribing to a common topic, to recover from failures in a zone or region.</p></li>
</ul>
<p>The flow when using Google Cloud Pub/Sub is exactly as you’d expect: a message is sent to a topic in the Pub/Sub broker (hosted in the cloud by GCP) which then persists it for you. Subscribers can either have messages pushed to it (through a webhook) or they can poll for the mesages from the broker. The subscriber receives messages from the broker and acknowledges each one. When a subscriber acknowledges a message it is removed from the subscriber’s subscription queue. Any client that can speak HTTPS can use this service. There’s no other API required.</p>
<p>The domain model is fairly straightforward if you’ve ever used any other messaging system (JMS, AMQP, Apache Kafka, Kestrel): a topic is the thing to which messages are published. A subscription represents the stream of messages from a specific topic that are to be delivered to a specific client application. A topic can have multiple subscriptions. A subscription can have many subscribers. If you want to distribute different messages around to different subscribers, then all the subscribers must be subscribing to the same subscription. If you want to publish the same messages to all the subscribers, then each subscriber needs to subscribe to its own subscription.</p>
<p>Pub/Sub delivery is at-least once. Hence, you must deal with idempotency and/or de-duplicate messages if you cannot process the same message more than once.</p>
<p>A message stores a combination of data and (optional) attributes that are conducted by Google Cloud Pub/Sub from a publisher to a subscriber. A message attribute, which you might better understand as a <em>header</em>, is a key value pair in a message. You might have a header the describes the language of the payload. You might have a header that describes the content-type.</p>
<p>Let’s add Google Cloud Pub/Sub to an application and tie them together.</p>
<p>As before, we need to enable the Google Cloud Pub/Sub API for use.</p>
<pre><code class="prettyprint shell">gcloud services enable pubsub.googleapis.com
</code></pre>
<p>You’ll then need to create a new topic, <code>reservations</code>.</p>
<pre><code class="prettyprint shell">gcloud pubsub topics create reservations
</code></pre>
<p>The topic represents where we will send messages. We still need to create a subscription that consumes messages from that topic. The following command creates a subscription, <code>reservations-subscription</code>, to connect to the <code>reservations</code> topic.</p>
<pre><code class="prettyprint shell">gcloud pubsub subscriptions create reservations-subscription --topic=reservations
</code></pre>
<p>Those pieces in place, we can use them from our application. Add the Spring Cloud GCP Pub/Sub starter, <code>org.springframework.cloud</code> : <code>spring-cloud-gcp-starter-pubsub</code>, to your build. This introduces auto-configuration for the Google Cloud <code>PubSubTemplate</code>. The <code>PubSubTemplate</code> should feel familiar if you’ve ever used the <code>JmsTemplate</code> or <code>KafkaTemplate</code>. It’s an easy-to-use client for producing and consuming messages with Google Cloud Pub/Sub. If you’re just getting started with GCP Pub/Sub and messaging in general, a <code>*Template</code> object in the Spring universe is a good place to start.</p>
<p>Let’s look at a simple example that publishes a message whenever you issue HTTP <code>POST</code> calls to an HTTP endpoint running in the Spring Boot application. Then we’ll setup a subscriber to consume the messages sent.</p>
<pre><code class="prettyprint java">package com.example.gcp.pubsub.template;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.gcp.pubsub.core.PubSubTemplate;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RestController;

@Configuration
@RestController
class PublisherConfig {

        private final PubSubTemplate template;
        private final String topic;

        PublisherConfig(PubSubTemplate template, @Value(&quot;${reservations.topic:reservations}&quot;) String t) {
                this.template = template;
                this.topic = t;
        }

        
        @PostMapping(&quot;/publish/{name}&quot;)
        void publish(@PathVariable String name) {
                this.template.publish(this.topic, &quot;Hello &quot; + name + &quot;!&quot;);
        }
}
</code></pre>
<ul>
<li>we use the injected <code>PubSubTemplate</code> to send a message - a String - to the configured topic.</li>
</ul>
<p>Now, let’s look at a simple application that might as easily run in another node that consumes messages from the subscription linked to the topic.</p>
<pre><code class="prettyprint java">package com.example.gcp.pubsub.template;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.cloud.gcp.pubsub.core.PubSubTemplate;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.event.EventListener;

@Slf4j
@Configuration
class SubscriberConfig {

        private final PubSubTemplate template;
        private final String subscription;

        SubscriberConfig(PubSubTemplate template, @Value(&quot;${reservations.subscription:reservations-subscription}&quot;) String s) {
                this.template = template;
                this.subscription = s;
        }

        @EventListener(ApplicationReadyEvent.class)
        public void start() {
                
                this.template.subscribe(this.subscription, (pubsubMessage, ackReply ) -&gt; {
                        log.info(&quot;consumed new message: [&quot; + pubsubMessage.getData().toStringUtf8() + &quot;]&quot;);
                        ackReply.ack();
                });
        }
}
</code></pre>
<ul>
<li>Once the application is up and running we explicitly subscribe, connecting our client to the right endpoint.</li>
</ul>
<p>This example uses the <code>PubSubTemplate</code> (to great effect). It’s simple, short and sweet. As integration becomes more complex, however, it becomes useful to decouple components involved in the flow of messages from one system to another. We introduce stages - links in a chain of components - through which messages must pass to arrive at downstream components. This staging allows us to write handling code that can be swapped out, indifferent to the origin or destination of a given message. This promotes testing, because components need only be written in terms of their immediate pre- and post-conditions: a component can say it only accepts Spring Framework <code>Message&lt;File&gt;</code> types, and nothing else. This interface indirection is <em>very</em> handy, especially as we start to tie together real world systems that may handle work at different cadences. It becomes trivial to introduce a broker to buffer work before it reaches downstream components where it may otherwise bottleneck. This approach - of isolating components involved in a messaging flow and introducing a buffer to protect downstream components - is called a <em>staged event driven architecture</em> (SEDA), and it is more valuable now as the world moves to microservices and highly distributed systems than ever.</p>
<p>Spring Integration is a framework that’s designed to promote this indirection. It has at its heart the concept of a <code>MessageChannel</code>, which you can think of us an in-memory <code>Queue</code>; a pipe through which messages flow. On each side of the <code>MessageChannel</code> are sat components. You can imagine one component outputting messages of a certain type and sending them into this <code>MessageChannel</code>, oblivious to where it’ll go. On the other end is another component that consumes messages of a certain type, utterly oblivious to the origin of any given message. Today there may be one service involved in the production of the message. Tomorrow there may be ten! The upstream and downstream components need not change. This indirection gives us a lot of possibilities. We change routing for a given message, stringing it through different services, splitting it, aggregating it, etc. We can transform other sources of data and adapt them to the messaging flow upstream (that’s called an inbound adapter). We can introduce new sinks for the data, adapting the Spring Framework <code>Message&lt;T&gt;</code> into the right type (that’s called an <em>outbound adapter</em>).</p>
<p>Let’s look at Spring Integration and the Google Cloud Pub/Sub inbound and outbound adapters. We’ll keep the same approach as before: an HTTP endpoint will publish messages which then get delivered to Google Cloud Pub/Sub. The code could run in different nodes. You’ll also need the Spring Integration types on the classpath for this example to work. Add <code>org.springframework.boot</code> : <code>spring-boot-starter-integration</code> to the build.</p>
<p>Let’s look at a publisher that publishes messages whenever an HTTP POST is made. In this case, the publisher sends requests into a <code>MessageChannel</code> which then delivers it to a <code>PubSubMessageHandler</code>. Today it’s going directly to Pub/Sub, but tomorrow it could go to a database, an FTP server, XMPP, Salesforce, or literally anything else, and <em>then</em> off to Pub/Sub.</p>
<pre><code class="prettyprint java">package com.example.gcp.pubsub.integration;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.gcp.pubsub.core.PubSubTemplate;
import org.springframework.cloud.gcp.pubsub.integration.outbound.PubSubMessageHandler;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.integration.dsl.IntegrationFlow;
import org.springframework.integration.dsl.IntegrationFlows;
import org.springframework.integration.dsl.channel.MessageChannels;
import org.springframework.messaging.SubscribableChannel;
import org.springframework.messaging.support.MessageBuilder;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RestController;

@Slf4j
@RestController
@Configuration
class PublisherConfig {

        private final String topic;
        private final PubSubTemplate template;

        public PublisherConfig(
            @Value(&quot;${reservations.topic:reservations}&quot;) String t,
            PubSubTemplate template) {
                this.topic = t;
                this.template = template;
        }

        @Bean
        IntegrationFlow publisherFlow() {
                return IntegrationFlows
                    .from(this.outgoing()) 
                    .handle(this.pubSubMessageHandler()) 
                    .get();
        }

        @PostMapping(&quot;/publish/{name}&quot;)
        void publish(@PathVariable String name) {
                
                outgoing().send(MessageBuilder.withPayload(name).build());
        }

        @Bean
        SubscribableChannel outgoing() {
                return MessageChannels.direct().get();
        }

        @Bean
        PubSubMessageHandler pubSubMessageHandler() {
                return new PubSubMessageHandler(template, this.topic);
        }
}
</code></pre>
<ul>
<li>
<p>the <code>IntegrationFlow</code> describes, well, the <em>flow</em> of messages in an integration. Messages sent into the <code>outgoing</code> <code>MessageChannel</code> are delivered to the <code>PubSubMessageHandler</code> which then writes it to Google Cloud Pub/Sub using the specified <code>topic</code></p></li>
<li>
<p>In the Spring MVC HTTP endpint we obtain a reference to the <code>MessageChannel</code> and publish a message (which we build with the <code>MessageBuilder</code>) into it. NB: calling <code>outgoing()</code> as I do in this example is fine because Spring memoizes the result of the method invocation; I’ll always obtain the same pre-instantiated singleton of the <code>MessageChannel</code> bean.</p></li>
</ul>
<p>On the consumer side, we do the same thing in reverse, adapting incoming messages and then logging them in an <code>IntegrationFlow</code>.</p>
<pre><code class="prettyprint java">package com.example.gcp.pubsub.integration;

import com.google.cloud.pubsub.v1.AckReplyConsumer;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.gcp.pubsub.core.PubSubTemplate;
import org.springframework.cloud.gcp.pubsub.integration.AckMode;
import org.springframework.cloud.gcp.pubsub.integration.inbound.PubSubInboundChannelAdapter;
import org.springframework.cloud.gcp.pubsub.support.GcpPubSubHeaders;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.integration.dsl.IntegrationFlow;
import org.springframework.integration.dsl.IntegrationFlows;
import org.springframework.integration.dsl.channel.MessageChannels;
import org.springframework.messaging.MessageChannel;

@Slf4j
@Configuration
class SubscriberConfig {

        private final String subscription;
        private final PubSubTemplate template;

        SubscriberConfig(
            @Value(&quot;${reservations.subscription:reservations-subscription}&quot;) String s,
            PubSubTemplate t) {
                this.subscription = s;
                this.template = t;
        }

        @Bean 
        public PubSubInboundChannelAdapter messageChannelAdapter() {
                PubSubInboundChannelAdapter adapter = new PubSubInboundChannelAdapter(
                    template, this.subscription);
                adapter.setOutputChannel(this.incoming());
                adapter.setAckMode(AckMode.MANUAL);
                return adapter;
        }

        @Bean
        MessageChannel incoming() {
                return MessageChannels.publishSubscribe().get();
        }

        @Bean
        IntegrationFlow subscriberFlow() {
                return IntegrationFlows
                    .from(this.incoming()) 
                    .handle(message -&gt; { 
                            log.info(&quot;consumed new message: [&quot; + message.getPayload() + &quot;]&quot;);
                            AckReplyConsumer consumer = message.getHeaders()
                                .get(GcpPubSubHeaders.ACKNOWLEDGEMENT, AckReplyConsumer.class);
                            consumer.ack();
                    })
                    .get();
        }
}
</code></pre>
<ul>
<li>
<p>the <code>PubSubInboundChannelAdapter</code> adapts messages from the subscription and sends them into the <code>incoming</code> <code>MessageChannel</code>.</p></li>
<li>
<p>the <code>IntegrationFlow</code> takes incoming messages and routes them to a <code>MessageHandler</code> (which we’ve contributed with lambda syntax) that a) logs the incoming message and b) manually acknowledges the receipt of the message.</p></li>
</ul>
<p>The nice thing about <code>IntegrationFlow</code> in both examples is that you can chain calls together. Here, we specify only where a message comes from (<code>.from()</code>) and what handles it (<code>.handle()</code>), but we could as easily after the <code>.handle()</code> call also route, split, transform, etc., the messages. The message sent as the output of one component (the adapters, the message handlers, transformers, etc.) become the input to any downstream components.</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 3366;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>