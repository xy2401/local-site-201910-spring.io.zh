<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>GORM Gotchas (Part 1)</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="GORM Gotchas (Part 1)" />
<meta name="twitter:description" content="&lt;p&gt;Are you new to Grails? Or have you perhaps run into your first GORM “oddity”? If so, then you’ll want to read this series on GORM gotchas. Not only will the articles highlight those little idiosyncrasies that often catch people out, but they will also explain why GORM behaves in these ways.&lt;/p&gt;
&lt;p&gt;Hopefully you will already know that GORM is the database access library that comes with Grails. It’s based on probably the most popular Java ORM out there: Hibernate. As you can imagine, Hibernate is a powerful and flexible library and it brings big benefits to GORM. But there is a cost to using it: many of the problems that users of GORM run into stem from the way Hibernate works. GORM tries to hide the implementation details as best it can, but they do leak out on occasion.&lt;/p&gt;
" />

<meta property="og:title" content="GORM Gotchas (Part 1)" />
<meta property="og:description" content="&lt;p&gt;Are you new to Grails? Or have you perhaps run into your first GORM “oddity”? If so, then you’ll want to read this series on GORM gotchas. Not only will the articles highlight those little idiosyncrasies that often catch people out, but they will also explain why GORM behaves in these ways.&lt;/p&gt;
&lt;p&gt;Hopefully you will already know that GORM is the database access library that comes with Grails. It’s based on probably the most popular Java ORM out there: Hibernate. As you can imagine, Hibernate is a powerful and flexible library and it brings big benefits to GORM. But there is a cost to using it: many of the problems that users of GORM run into stem from the way Hibernate works. GORM tries to hide the implementation details as best it can, but they do leak out on occasion.&lt;/p&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2010-06-23 17:34:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">GORM Gotchas (Part 1)</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="null?s=20&amp;d=mm" />
<span class="author">Peter Ledbrook</span>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2010-06-23 17:34:00.0">June 23, 2010</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="333" href="/blog/2010/06/23/gorm-gotchas-part-1#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><p>Are you new to Grails? Or have you perhaps run into your first GORM &ldquo;oddity&rdquo;? If so, then you&rsquo;ll want to read this series on GORM gotchas. Not only will the articles highlight those little idiosyncrasies that often catch people out, but they will also explain why GORM behaves in these ways.</p><p>Hopefully you will already know that GORM is the database access library that comes with Grails. It&rsquo;s based on probably the most popular Java ORM out there: Hibernate. As you can imagine, Hibernate is a powerful and flexible library and it brings big benefits to GORM. But there is a cost to using it: many of the problems that users of GORM run into stem from the way Hibernate works. GORM tries to hide the implementation details as best it can, but they do leak out on occasion.</p><p>In the rest of this post, I&rsquo;ll describe the basics of persisting objects to the database. Sounds simple, but GORM doesn&rsquo;t quite work as you might expect even on something so basic.</p>
<h2>When I call save(), I mean save!</h2><p>Problems with saving domain instances are probably the first ones that developers come across. How many of you have gone through the &ldquo;I saved it, so why isn&rsquo;t it in the database?&rdquo; phase? If it makes you feel any better, I&rsquo;ve been through it too. Why does this happen? There are a couple of possibilities.</p>
<h3>Don't forget the validation!</h3><p>Every time you save a domain instance, Grails validates it using the constraints that you have defined. If any values in the domain instance violate those constraints, the save will fail and the constraint errors will be attached to the domain instance. The trouble is, this failure to save the domain instance happens quietly: you won&rsquo;t know about it unless you check the return value of <tt>save()</tt> or call <tt>hasErrors()</tt>. </p><p>When you are binding user data to a domain instance, this is typically the behaviour you want. It&rsquo;s hardly a surprise if user input happens not to fit the constraints. Throwing an exception in this case just isn&rsquo;t appropriate, particularly when you&rsquo;re web application has quite a few concurrent users. In these circumstances it&rsquo;s always best to check the return value of <tt>save()</tt> and react accordingly (it returns <tt>null</tt> if the save failed, otherwise it returns the domain instance):</p>
<pre><code class="prettyprint groovy">def book = new Book(params)
if (!book.save()) {
    // Save failed! Present the errors to the user.
    ...
}
</code></pre><p>On the other hand, when you&rsquo;re setting up test data in BootStrap or in the Grails console, you usually expect the save to work. If there are any validation errors, it means a mistake on your part. In such cases as these, you don&rsquo;t want to mess around with checking the return value of every <tt>save()</tt> and you&rsquo;d be more than happy if Grails were to throw an exception for validation failures. This isn&rsquo;t the default behaviour, but you can easily switch it on via a <tt>failOnError</tt> argument:</p>
<pre><code class="prettyprint groovy">book.save(failOnError: true)
</code></pre><p>If you insist, you can even make it the default: simply set <tt>grails.gorm.failOnError</tt> to <tt>true</tt> in grails-app/conf/Config.groovy. And don&rsquo;t forget, all domain properties have an implicit <tt>nullable: false</tt> constraint!</p><p>That&rsquo;s probably the most common reason for domain instances not being saved when you expect them to be. So what&rsquo;s the other?</p>
<h3>Hibernate's session</h3><p>On rare occasions, you can find yourself saving a domain instance only to discover that a following query doesn&rsquo;t pick it up, even when the instance passes validation. This is a symptom of a wider issue connected with using Hibernate under the hood.</p><p><b>Hibernate is a session-based ORM framework.</b></p><p>This is a very important point and anyone that hopes to truly be comfortable with GORM has to understand what the session is and what impact it has on applications. So what is a session? It&rsquo;s basically an in-memory cache of objects that are backed by a database. When you save a new domain instance, it is implicitly attached to the session, i.e. it is added to the cache and becomes a Hibernate-managed object. <em>But it may not be persisted to the database at that point!</em> The following diagram illustrates this behaviour:</p><p><img src="http://blog.springsource.com/wp-content/uploads/2010/06/hibernate-session-in-action.png" alt="hibernate-session-in-action" title="hibernate-session-in-action" width="440" height="248" class="aligncenter size-full wp-image-5037" /></p><p>When you save instances, they will immediately be available from the session. But Hibernate uses it&rsquo;s discretion to decide when to persist the new instances to the database, which means it can optimise the order of the SQL statements. Normally you won&rsquo;t notice any of this because Grails and Hibernate take care of things, but occasionally you will get caught out.</p><p>As you&rsquo;d expect, though, Grails does allow you to control when data is actually persisted to the database. Have you ever seen code like this in examples?</p>
<pre><code class="prettyprint groovy">book.save(flush: true)
</code></pre><p>The <tt>flush: true</tt> forces Hibernate to persist all changes to the database right away. It corresponds to what is known as <em>flushing the session</em>.</p><p>The danger now is that you will go away and put <tt>flush: true</tt> everywhere. Don&rsquo;t. Let Hibernate do it&rsquo;s job and only manually flush the session when you have to, or at least only at the end of a batch of updates. You should only really use if you&rsquo;re not seeing the data in the database when it should be there. I know that&rsquo;s a bit wishy-washy, but the circumstances when such action is necessary depend on the database implementation and other factors. One area where manual flushing can be very useful is when you are interacting with another application or internal service that is accessing the same database as you but outside of your current session.</p><p>If you&rsquo;re still a little hazy on the session, don&rsquo;t worry - we&rsquo;ll be coming back to the Hibernate session again and again, because it is fundamental to many of the gotchas related to GORM. In fact, it&rsquo;s the reason why people are hit by the next problem.</p>
<h3>Now you're saving when I don't want you to?!</h3><p>Failing to persist a domain instance when you call <tt>save()</tt> is pretty common. Now consider the reverse situation: objects being persisted without a corresponding call to <tt>save()</tt>. If you haven&rsquo;t come across this behaviour yet, I can almost guarantee that you will. So why might might it happen?</p><p>Hibernate supports the concept of dirty-checking. What this means is that Hibernate checks whether any values of a domain instance&rsquo;s (persistent) properties have changed <em>after that instance has been pulled from the database</em>, and will persist those changes to the database. That&rsquo;s a bit of a mouthful so hopefully an example will help clarify this explanation. Let&rsquo;s say we have a <tt>Book</tt> domain class with <tt>title</tt> and <tt>author</tt> properties, and the following code is in a controller action:</p>
<pre><code class="prettyprint groovy">def b = Book.findByAuthor(params.author)
b.title = b.title.reverse()
</code></pre><p>Note that there is no call to <tt>save()</tt> here. When the request has completed you will find that the book&rsquo;s title has been reversed in the database - the change has been persisted without an explicit save. This is because:<br /><ol><br /><li>the book is attached to the session (by virtue of being retrieved by a query);</li><br /><li>the <tt>title</tt> property is persistent (all properties are persistent unless configured as transient); and</li><br /><li>the property value has changed by the time the session closes.</li><br /></ol></p><p>Let&rsquo;s look at those in a little more detail. First, I have already mentioned that objects can be &ldquo;attached&rdquo; to the session, i.e. managed by Hibernate and backed by the database, but how do objects become attached? If you use GORM to retrieve a domain instance in any way, for example via the <tt>get()</tt> method or any type of query, then the object is automatically associated with the session. If you just create a new instance via the <tt>new</tt> keyword, then the object is <em>not</em> attached to the session until the <tt>save()</tt> method is called.</p><p>Second, domain class properties are persistent by default, i.e. they have matching columns in the database where their values are stored. You can make properties transient by adding their names to the static <tt>transients</tt> list property, which means that their values aren&rsquo;t stored in the database.</p><p>Finally, I mentioned that changes are persisted if they exist when the session closes. What did I mean by that? In order to do anything with the database via Hibernate, you must have an open session. Once the session is closed, you can no longer use it for database access. Also, the session is flushed when it&rsquo;s closed, which is why changes are persisted at the end of our controller action above (Grails automatically opens a session at the start of a request and closes it at the end).</p><p>Can you prevent such changes being persisted? Sure. One option is to call <tt>save()</tt> on your domain instance: if any of the property values fail validation, the changes will <em>not</em> be persisted. Of course, if the values are valid and yet you still don&rsquo;t want to persist them, you can call <tt>discard()</tt> on your instance. This won&rsquo;t reset the values of the instance&rsquo;s properties, but it will ensure that they aren&rsquo;t saved to the database.</p><p>That&rsquo;s a fair bit of information to digest for just a few gotchas. The key is understanding how the Hibernate session affects persistence of domain instances. Even if you haven&rsquo;t quite grokked it yet, future GORM gotcha articles will provide more information and examples.</p><p>In general, I recommend that you always use <tt>save()</tt> to persist objects rather than relying on dirty-checking. It makes it clear in the code that you want to persist the changes and those changes get validated at the same time. I also recommend that you always check the return value of <tt>save()</tt> in application code, although you&rsquo;re better off using the <tt>failOnError: true</tt> option when setting up bootstrap or test data.</p><p>If you&rsquo;re at all intimidated by or wary of GORM at this point, don&rsquo;t be. It really does make playing around with a database easy and fun, and with the information gleaned from this series of articles, you&rsquo;ll have the confidence to deal with any problems that may crop up.</p><p>Until next time! </p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 333;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>