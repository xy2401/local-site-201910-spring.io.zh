<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Building RabbitMQ apps using Python</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Building RabbitMQ apps using Python" />
<meta name="twitter:description" content="&lt;p&gt;&lt;a href=&quot;http://rabbitmq.com&quot;&gt;RabbitMQ&lt;/a&gt; is a powerful messaging broker based on the &lt;a href=&quot;http://blog.springsource.com/2010/06/14/understanding-amqp-the-protocol-used-by-rabbitmq/&quot;&gt;Advanced Message Queueing Protocol (AMQP)&lt;/a&gt;. Thanks to the neutral nature of the AMQP spec, it is easy to connect to it from many platforms, including Python. In this blog entry, we will:&lt;br&gt;&lt;/p&gt;
&lt;ul&gt;
 &lt;br&gt; 
 &lt;li&gt;Create a simple stock ticker Python application&lt;/li&gt;
 &lt;br&gt; 
 &lt;li&gt;Create a brokerage Python application that decides when to buy and sell.&lt;/li&gt;
 &lt;br&gt; 
 &lt;li&gt;Compare&amp;nbsp;&lt;a href=&quot;http://github.com/tonyg/pika&quot;&gt;pika&lt;/a&gt;, an AMQP library created by the RabbitMQ team, with &lt;a href=&quot;http://code.google.com/p/py-amqplib/&quot;&gt;py-amqplib&lt;/a&gt;.&lt;/li&gt;
 &lt;br&gt;
&lt;/ul&gt;
&lt;br&gt;
&lt;a href=&quot;http://github.com/gregturn/amqp-demo&quot;&gt;&lt;/a&gt;
&lt;a href=&quot;http://github.com/gregturn/amqp-demo&quot;&gt;http://github.com/gregturn/amqp-demo&lt;/a&gt;
&lt;a href=&quot;http://www.rabbitmq.com/install.html&quot;&gt;instructions for your platform&lt;/a&gt;
" />
<meta name="twitter:creator" content="@gregturn" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/43e9a9d63f7f4f9891c9fcd592b89cfa?s=200" />

<meta property="og:title" content="Building RabbitMQ apps using Python" />
<meta property="og:image" content="https://gravatar.com/avatar/43e9a9d63f7f4f9891c9fcd592b89cfa?s=200" />
<meta property="og:description" content="&lt;p&gt;&lt;a href=&quot;http://rabbitmq.com&quot;&gt;RabbitMQ&lt;/a&gt; is a powerful messaging broker based on the &lt;a href=&quot;http://blog.springsource.com/2010/06/14/understanding-amqp-the-protocol-used-by-rabbitmq/&quot;&gt;Advanced Message Queueing Protocol (AMQP)&lt;/a&gt;. Thanks to the neutral nature of the AMQP spec, it is easy to connect to it from many platforms, including Python. In this blog entry, we will:&lt;br&gt;&lt;/p&gt;
&lt;ul&gt;
 &lt;br&gt; 
 &lt;li&gt;Create a simple stock ticker Python application&lt;/li&gt;
 &lt;br&gt; 
 &lt;li&gt;Create a brokerage Python application that decides when to buy and sell.&lt;/li&gt;
 &lt;br&gt; 
 &lt;li&gt;Compare&amp;nbsp;&lt;a href=&quot;http://github.com/tonyg/pika&quot;&gt;pika&lt;/a&gt;, an AMQP library created by the RabbitMQ team, with &lt;a href=&quot;http://code.google.com/p/py-amqplib/&quot;&gt;py-amqplib&lt;/a&gt;.&lt;/li&gt;
 &lt;br&gt;
&lt;/ul&gt;
&lt;br&gt;
&lt;a href=&quot;http://github.com/gregturn/amqp-demo&quot;&gt;&lt;/a&gt;
&lt;a href=&quot;http://github.com/gregturn/amqp-demo&quot;&gt;http://github.com/gregturn/amqp-demo&lt;/a&gt;
&lt;a href=&quot;http://www.rabbitmq.com/install.html&quot;&gt;instructions for your platform&lt;/a&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2010-08-19 15:15:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Building RabbitMQ apps using Python</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/43e9a9d63f7f4f9891c9fcd592b89cfa?s=20&amp;d=mm" />
<a class="author" rel="author" href="/team/gturnquist">Greg Turnquist</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2010-08-19 15:15:00.0">August 19, 2010</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="350" href="/blog/2010/08/19/building-rabbitmq-apps-using-python#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><p><a href="https://rabbitmq.com">RabbitMQ</a> is a powerful messaging broker based on the <a href="http://blog.springsource.com/2010/06/14/understanding-amqp-the-protocol-used-by-rabbitmq/">Advanced Message Queueing Protocol (AMQP)</a>. Thanks to the neutral nature of the AMQP spec, it is easy to connect to it from many platforms, including Python. In this blog entry, we will:<br /><ul><br /> <li>Create a simple stock ticker Python application</li><br /> <li>Create a brokerage Python application that decides when to buy and sell.</li><br /> <li>CompareÂ <a href="https://github.com/tonyg/pika">pika</a>, an AMQP library created by the RabbitMQ team, with <a href="https://code.google.com/p/py-amqplib/">py-amqplib</a>.</li><br /></ul><br />You can find all the source code for this blog at <a href="https://github.com/gregturn/amqp-demo"><a href="https://github.com/gregturn/amqp-demo">http://github.com/gregturn/amqp-demo</a></a>. This assumes you have already installed RabbitMQ based on <a href="https://www.rabbitmq.com/install.html">instructions for your platform</a> and fired it up. Personally, I have it running on my Mac OS X machine (snow leopard).</p><p>By the way:<br /><blockquote>The code written in this blog entry is for demonstration purposes only. Do not rely on the algorithms for financial advice.</blockquote><br />With that out of the way, let&rsquo;s write some code!<br /><h2>Building the stock ticker</h2><br />A good example for a messaging solution is a stock ticker system. The stock exchange publishes messages to the broker indicating stock name, price, and time.</p>
<pre><code class="prettyprint python">import pickle
import random
import time

class Ticker(object):
    def __init__(self, publisher, qname):
        self.publisher = publisher

        # This quickly creates four random stock symbols
        chars = range(ord(&quot;A&quot;), ord(&quot;Z&quot;)+1)
        def random_letter(): return chr(random.choice(chars))
        self.stock_symbols = [random_letter()+random_letter()+random_letter() for i in range(4)]

        self.last_quote = {}
        self.counter = 0
        self.time_format = &quot;%a, %d %b %Y %H:%M:%S +0000&quot;
        self.qname = qname

    def get_quote(self):
        symbol = random.choice(self.stock_symbols)
        if symbol in self.last_quote:
            previous_quote = self.last_quote[symbol]
            new_quote = random.uniform(0.9*previous_quote, 1.1*previous_quote)
            if abs(new_quote) - 0 &lt; 1.0:
                new_quote = 1.0
            self.last_quote[symbol] = new_quote
        else:
            new_quote = random.uniform(10.0, 250.0)
            self.last_quote[symbol] = new_quote
        self.counter += 1
        return (symbol, self.last_quote[symbol], time.gmtime(), self.counter)

    def monitor(self):
        while True:
            quote = self.get_quote()
            print(&quot;New quote is %s&quot; % str(quote))
            self.publisher.publish(pickle.dumps((quote[0], quote[1], time.strftime(self.time_format, quote[2]), quote[3])), routing_key=&quot;&quot;)
            secs = random.uniform(0.1, 0.5)
            #print(&quot;Sleeping %s seconds...&quot; % secs)
            time.sleep(secs)
</code></pre><p>This application randomly creates four stock symbols, and then starts to create quotes. It initially picks a random value between 10.0 and 250.0, then proceeds to randomly adjust the price between 90% and 110% of the previous price. It then randomly waits between 0.1 and 0.5 seconds before ticking off the next quote. An important part of this code design is the fact that publishing to an AMQP broker has been decoupled from the stock ticker. Instead, it expects a publisher service to be injected when constructed.</p><p>Its important to note that we are using pickle to serialize our tuple of stock quote data. In AMQP, the body of the message is just a series of bytes. What is stored and how it is serialized is not part of the spec, and instead must be agreed upon between sender and receiver. In our situation, the publisher and subscriber have both agreed upon it containing a pickled tuple.<br /><h2>Creating an AMQP service</h2><br />The next step is to create our AMQP client service. Its purpose is to make it easy for us to properly isolate talking to the AMQP server, either through publishing or by consuming events.</p>
<pre><code class="prettyprint python">from amqplib import client_0_8 as amqp

class PyAmqpLibPublisher(object):
    def __init__(self, exchange_name):
        self.exchange_name = exchange_name
        self.queue_exists = False

    def publish(self, message, routing_key):
        conn = amqp.Connection(host=&quot;127.0.0.1&quot;, userid=&quot;guest&quot;, password=&quot;guest&quot;, virtual_host=&quot;/&quot;, insist=False)

        ch = conn.channel()

        ch.exchange_declare(exchange=self.exchange_name, type=&quot;fanout&quot;, durable=False, auto_delete=False)

        msg = amqp.Message(message)
        msg.properties[&quot;content_type&quot;] = &quot;text/plain&quot;
        msg.properties[&quot;delivery_mode&quot;] = 2
        ch.basic_publish(exchange=self.exchange_name,
                         routing_key=routing_key,
                         msg=msg)
        ch.close()
        conn.close()
</code></pre><p>An important thing to notice here is that the declared exchange is type &ldquo;fanout&rdquo;. This means that every queue that binds to it will receive a copy of the message without expensive processing on the broker&rsquo;s end.</p><p>You may be wondering why the content_type of the body is &ldquo;text/plain&rdquo;, considering it&rsquo;s a serialized message. This is because Python&rsquo;s pickle library encodes data in an ASCII-armored format that is viewable with any tool without causing weird behavior.<br /><h2>Buy low, sell high</h2><br />Some simple, sage advice is to buy when the price is low and sell it when the price is high. Here we&rsquo;ll look at a simple client that subscribes for stock quotes, collects a historical trend of prices to figure out whether the next price is on the low end or high end, and then decides to buy or sell.</p>
<pre><code class="prettyprint python">import pickle
import random
import uuid

class Buyer(object):
    def __init__(self, client, qname, trend=5):
        self.holdings = {}
        self.cash = 100000.0
        self.history = {}
        self.qname = qname
        self.client = client
        self.trend = trend
        self.qname = uuid.uuid4().hex

    def decide_whether_to_buy_or_sell(self, quote):
        symbol, price, date, counter = quote
        #print &quot;Thinking about whether to buy or sell %s at %s&quot; % (symbol, price)

        if symbol not in self.history:
            self.history[symbol] = [price]
        else:
            self.history[symbol].append(price)

        if len(self.history[symbol]) &gt;= self.trend:
            price_low = min(self.history[symbol][-self.trend:])
            price_max = max(self.history[symbol][-self.trend:])
            price_avg = sum(self.history[symbol][-self.trend:])/self.trend
            #print &quot;Recent history of %s is %s&quot; % (symbol, self.history[symbol][-self.trend:])
        else:
            price_low, price_max, price_avg = (-1, -1, -1)
            print &quot;%s quotes until we start deciding whether to buy or sell %s&quot; % (self.trend - len(self.history[symbol]), symbol)
            #print &quot;Recent history of %s is %s&quot; % (symbol, self.history[symbol])

        if price_low == -1: return

        #print &quot;Trending minimum/avg/max of %s is %s-%s-%s&quot; % (symbol, price_low, price_avg, price_max)
        #for symbol in self.holdings.keys():
        #    print &quot;self.history[symbol][-1] = %s&quot; % self.history[symbol][-1]
        #    print &quot;self.holdings[symbol][0] = %s&quot; % self.holdings[symbol][0]
        #    print &quot;Value of %s is %s&quot; % (symbol, float(self.holdings[symbol][0])*self.history[symbol][-1])
        value = sum([self.holdings[symbol][0]*self.history[symbol][-1] for symbol in self.holdings.keys()])
        print &quot;Net worth is %s + %s = %s&quot; % (self.cash, value, self.cash + value)

        if symbol not in self.holdings:
            if price &lt; 1.01*price_low:
                shares_to_buy = random.choice([10, 15, 20, 25, 30])
                print &quot;I don&#39;t own any %s yet, and the price is below the trending minimum of %s so I&#39;m buying %s shares.&quot; % (symbol, price_low, shares_to_buy)
                cost = shares_to_buy * price
                print &quot;Cost is %s, cash is %s&quot; % (cost, self.cash)
                if cost &lt; self.cash:
                    self.holdings[symbol] = (shares_to_buy, price, cost)
                    self.cash -= cost
                    print &quot;Cash is now %s&quot; % self.cash
                else:
                    print &quot;Unfortunately, I don&#39;t have enough cash at this time.&quot;
        else:
            if price &gt; self.holdings[symbol][1] and price &gt; 0.99*price_max:
                print &quot;+++++++ Price of %s is higher than my holdings, so I&#39;m going to sell!&quot; % symbol
                sale_value = self.holdings[symbol][0] * price
                print &quot;Sale value is %s&quot; % sale_value
                print &quot;Holdings value is %s&quot; % self.holdings[symbol][2]
                print &quot;Total net is %s&quot; % (sale_value - self.holdings[symbol][2])
                self.cash += sale_value
                print &quot;Cash is now %s&quot; % self.cash
                del self.holdings[symbol]

    def handle_pyamqplib_delivery(self, msg):
        self.handle(msg.delivery_info[&quot;channel&quot;], msg.delivery_info[&quot;delivery_tag&quot;], msg.body)

    def handle(self, ch, delivery_tag, body):
        quote = pickle.loads(body)
        #print &quot;New price for %s =&gt; %s at %s&quot; % quote
        ch.basic_ack(delivery_tag = delivery_tag)
        print &quot;Received message %s&quot; % quote[3]
        self.decide_whether_to_buy_or_sell(quote)

    def monitor(self):
        self.client.monitor(self.qname, self.handle_pyamqplib_delivery)
</code></pre><p>This client has its strategy for buying and selling stocks nicely isolated from the machinery for receiving messages from RabbitMQ.<br /><ol><br /> <li><strong>monitor</strong> is the main hook to kick off listening for new stock quotes. It registers <strong>handle_pyamqplib_delivery</strong> as the callback method to invoke every time a new quote arrives.</li><br /> <li><strong>handle_pyamqplib_delivery</strong> pulls out the important parts of the message and hands them to <strong>handle</strong>. The reason for inserting this extra method call is to support swapping out py-amqplib with pika, which we&rsquo;ll look at later.</li><br /> <li><strong>handle</strong> de-pickles the opaque body of the message, acknowledges receipt of the message on the channel with the broker, and then fires off its algorithm about deciding whether to buy or sell.</li><br /> <li><strong>decide_whether_to_buy_or_sell</strong> splits up the tuple of the stock quote and then adds the price to its stock symbol history. It&rsquo;s geared to collect a minimum number of quotes before making a decision. Wouldn&rsquo;t you? Then it calculates the minimum and maximum of the trend, and if the price is relatively close to the minimum, it buys. However, if it already has shares, then it waits for the price to rise above what it originally paid for it. When that happens, it sells.</li><br /></ol><br />The part missing from this is the <strong>self.client.monitor</strong> function. <strong>self.client</strong> is our hook on the AMQP service coded earlier, and we need a way to bind our queue to the exchange to receive messages. The following function needs to be added to <strong>PyAmqpLibPublisher</strong>.</p>
<pre><code class="prettyprint python">    def monitor(self, qname, callback):
        conn = amqp.Connection(host=&quot;127.0.0.1&quot;, userid=&quot;guest&quot;, password=&quot;guest&quot;)

        ch = conn.channel()

        if not self.queue_exists:
            ch.queue_declare(queue=qname, durable=False, exclusive=False, auto_delete=False)
            ch.queue_bind(queue=qname, exchange=self.exchange_name)
            print &quot;Binding queue %s to exchange %s&quot; % (qname, self.exchange_name)
            #ch.queue_bind(queue=qname, exchange=self.exchange_name, routing_key=qname)
            self.queue_exists = True

        ch.basic_consume(callback=callback, queue=qname)

        while True:
            ch.wait()
        print &#39;Close reason:&#39;, conn.connection_close
</code></pre><p>This shows the basic pattern of connecting to our RabbitMQ broker, declaring a queue, binding it to the fanout exchange, and then registering a callback.</p><p>But let&rsquo;s not getting all wrapped up in how to make this algorithm better at picking winners and losers. Instead, let&rsquo;s recognize that this makes it very easy for any financial company to subscribe for stock quotes by creating a unique queue, binding to the stock system&rsquo;s fanout exchange, and then write their own algorithm for making financial decision.<br /><h2>Replacing py-amqplib with pika</h2><br />AMQP is a nicely written spec. It includes an XML format, supporting the ability to automatically generate client libraries. This means that libraries that were coded to spec are easy to swap out, and pick based on the merits of their implementation. A popular library in the Python community is <a href="https://code.google.com/p/py-amqplib/">py-amqplib</a>. One of its limitations, as noted on its project site, is that it blocks and doesn&rsquo;t currently provide concurrency. pika offers both.</p><p>The important point is that migrating from py-amqplib to pika is actually quite easy. The AMQP-based methods are the same, and the underpinning concepts are the same as well. Let&rsquo;s look at writing an alternative AMQP service using pika.</p>
<pre><code class="prettyprint python">import pika

class PikaPublisher(object):
    def __init__(self, exchange_name):
        self.exchange_name = exchange_name
        self.queue_exists = False

    def publish(self, message, routing_key):
        conn = pika.AsyncoreConnection(pika.ConnectionParameters(
                &#39;127.0.0.1&#39;,
                credentials=pika.PlainCredentials(&#39;guest&#39;, &#39;guest&#39;)))

        ch = conn.channel()

        ch.exchange_declare(exchange=self.exchange_name, type=&quot;fanout&quot;, durable=False, auto_delete=False)

        ch.basic_publish(exchange=self.exchange_name,
                         routing_key=routing_key,
                         body=message,
                         properties=pika.BasicProperties(
                                content_type = &quot;text/plain&quot;,
                                delivery_mode = 2, # persistent
                                ),
                         block_on_flow_control = True)
        ch.close()
        conn.close()

    def monitor(self, qname, callback):
        conn = pika.AsyncoreConnection(pika.ConnectionParameters(
                &#39;127.0.0.1&#39;,
                credentials=pika.PlainCredentials(&#39;guest&#39;, &#39;guest&#39;)))

        ch = conn.channel()

        if not self.queue_exists:
            ch.queue_declare(queue=qname, durable=False, exclusive=False, auto_delete=False)
            ch.queue_bind(queue=qname, exchange=self.exchange_name)
            print &quot;Binding queue %s to exchange %s&quot; % (qname, self.exchange_name)
            #ch.queue_bind(queue=qname, exchange=self.exchange_name, routing_key=qname)
            self.queue_exists = True

        ch.basic_consume(callback, queue=qname)

        pika.asyncore_loop()
        print &#39;Close reason:&#39;, conn.connection_close
</code></pre><p>This is very similar to the other service shown earlier. Creating a connection is a little different, but included the same pieces of data such as host for the <strong>broker</strong>, and <strong>username</strong> and <strong>password</strong>. <strong>basic_publish</strong> is slightly different in that the message and its properties are put together inside the method call. py-amqplib declares the entire message and its properties in a slightly different structure, and then passes it into basic_publish as one argument. Good thing about the spec is knowing that all the important pieces are in both libraries.</p><p>pika supports different waiting mechanisms compared to py-amqplib. py-amqplib has a blocking wait, while pika offers both a blocking mechanism as well as one that uses <a href="https://docs.python.org/library/asyncore.html">Python&rsquo;s asyncore utility</a> for asynchronous operations. We can explore this in future blog entries about RabbitMQ and Python.</p><p>There is a slight difference in the method signature of the callback between these two libraries. We need to update our brokerage client to handle it suitably.</p>
<pre><code class="prettyprint python">    def handle_pyamqplib_delivery(self, msg):
        self.handle(msg.delivery_info[&quot;channel&quot;], msg.delivery_info[&quot;delivery_tag&quot;], msg.body)
</code></pre><p>Compare this with pika&rsquo;s callback method signature.<span style="font-family: Consolas, Monaco, 'Courier New', Courier, monospace; line-height: 18px; font-size: 12px; white-space: pre;"> </span></p>
<pre><code class="prettyprint python">    def handle_pika_delivery(self, ch, method, header, body):
        self.handle(ch, delivery_tag, body)
</code></pre><p>They are very close. The important parts are there. The difference is based on the fact that pika splits up the parts of the message while py-amqplib combines it all inside a single class. This is the reason there is a decoupling between the callback method and the actual method that extracts the body of our message. By extracting the necessary parts, it is possible to switch between these two libraries without rewriting our buy/sell algorithm.<br /><h2>Running things</h2><br />With all this code, we need to run things. It&rsquo;s easy to code a runner script and just spin things up.</p>
<pre><code class="prettyprint python">########################################
# To run this demo using py-amqplib,
# uncomment this block, and  comment out
# the next block.
########################################

#from amqplib_client import *
#publisher = PyAmqpLibPublisher(exchange_name=&quot;my_exchange&quot;)

########################################
# To run this demo using pika,
# uncomment this block, and comment out
# the previous block
########################################

from pika_client import *
publisher = PikaPublisher(exchange_name=&quot;my_exchange&quot;)

########################################
# This part doesn&#39;t have to change
########################################

from ticker_system import *
ticker = Ticker(publisher, &quot;&quot;)
ticker.monitor()
</code></pre><p>This runner can be switched between running either the py-amqplib or pika version of our stock ticker system. Now we just need a runner for the brokerage service.</p>
<pre><code class="prettyprint python">########################################
# To run this demo using py-amqplib,
# uncomment this block, and  comment out
# the next block.
########################################

#from amqplib_client import *
#publisher = PyAmqpLibPublisher(exchange_name=&quot;my_exchange&quot;)

########################################
# To run this demo using pika,
# uncomment this block, and comment out
# the previous block
########################################

from pika_client import *
publisher = PikaPublisher(exchange_name=&quot;my_exchange&quot;)

########################################
# This part doesn&#39;t have to change
########################################

from buy_low_sell_high import *
buyer = Buyer(publisher, &quot;&quot;, trend=25)
print &quot;Buyer = %s&quot; % id(buyer)
buyer.monitor()
</code></pre><p>In future blog entries, we can entertain running the same code using a pythonic DI container.<br /><strong> </strong><br /><h2><strong>A good spec provides great options</strong></h2><br />The AMQP spec makes it easy to pick libraries based on more than just technical merit. By splitting up the machinery of AMQP from the logic of generating quotes as well as parsing them, it was pretty easy to swap out py-amqplib and pika. The core method names are the same. Several arguments are the same. But even more important: the architectural concepts are the same. The choice about which library to choose can now include not just technical merit, but instead things like customer support, spec compliance, synchronous vs. asynchronous support, and usability.</p><p><span style="font-family: Georgia, 'Times New Roman', 'Bitstream Charter', Times, serif; font-size: small;"><span style="line-height: 19px; white-space: normal;"> </span></span></p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 350;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>