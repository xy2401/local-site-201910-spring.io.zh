<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Exploiting encrypted cookies for fun and profit</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Exploiting encrypted cookies for fun and profit" />
<meta name="twitter:description" content="&lt;h2&gt;&lt;a href=&quot;#introduction&quot; class=&quot;anchor&quot; name=&quot;introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Developers often incorrectly use encryption in an attempt to provide authenticity. For example, a RESTful application may mistakenly use an encrypted cookie to embed the current user’s identity.&lt;/p&gt;
&lt;p&gt;The mistake is that encryption can only be used to keep a secret while signing is used to verify authenticity of a message. In this post, I will explain and provide an example of why encryption is not a guarantee of authenticity.&lt;/p&gt;
&lt;p&gt;If you just want to see code, feel free to skip &lt;a href=&quot;#source-code&quot;&gt;to the end&lt;/a&gt; which has a sample Java application that demonstrates the exploit.&lt;/p&gt;
" />
<meta name="twitter:creator" content="@rob_winch" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/30ed046efb35c67d4c055dab109b8933?s=200" />

<meta property="og:title" content="Exploiting encrypted cookies for fun and profit" />
<meta property="og:image" content="https://gravatar.com/avatar/30ed046efb35c67d4c055dab109b8933?s=200" />
<meta property="og:description" content="&lt;h2&gt;&lt;a href=&quot;#introduction&quot; class=&quot;anchor&quot; name=&quot;introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Developers often incorrectly use encryption in an attempt to provide authenticity. For example, a RESTful application may mistakenly use an encrypted cookie to embed the current user’s identity.&lt;/p&gt;
&lt;p&gt;The mistake is that encryption can only be used to keep a secret while signing is used to verify authenticity of a message. In this post, I will explain and provide an example of why encryption is not a guarantee of authenticity.&lt;/p&gt;
&lt;p&gt;If you just want to see code, feel free to skip &lt;a href=&quot;#source-code&quot;&gt;to the end&lt;/a&gt; which has a sample Java application that demonstrates the exploit.&lt;/p&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2014-01-20 16:48:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Exploiting encrypted cookies for fun and profit</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/30ed046efb35c67d4c055dab109b8933?s=20&amp;d=mm" />
<a class="author" rel="author" href="/team/rwinch">Rob Winch</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2014-01-20 16:48:00.0">January 20, 2014</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="1336" href="/blog/2014/01/20/exploiting-encrypted-cookies-for-fun-and-profit#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><h2><a href="#introduction" class="anchor" name="introduction"></a>Introduction</h2><p>Developers often incorrectly use encryption in an attempt to provide authenticity. For example, a RESTful application may mistakenly use an encrypted cookie to embed the current user&rsquo;s identity.</p><p>The mistake is that encryption can only be used to keep a secret while signing is used to verify authenticity of a message. In this post, I will explain and provide an example of why encryption is not a guarantee of authenticity.</p><p>If you just want to see code, feel free to skip <a href="#source-code">to the end</a> which has a sample Java application that demonstrates the exploit.</p><h2><a href="#encrypted-cookies-whoops" class="anchor" name="encrypted-cookies-whoops"></a>Encrypted Cookies (whoops)</h2><p>Assume we want to avoid looking up our users in session and instead want to embed the user information within a cookie. Since cookies can be modified by a malicious user we will need to be able to verify that the cookie that was provided was created by our application server.</p><p>To prevent users from tampering with the cookies we <em>mistakenly</em> decide to encrypt the cookie using <a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES encryption</a> with <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Cipher-block_chaining_.28CBC.29">CBC mode</a> instead of signing the cookie. Our cookie is properly encrypted (but mistakenly not signed) as follows:</p>
<pre><code class="prettyprint text">Cookie = Base64String( IV, aes_cbc(k, IV, plainText) )
</code></pre><p>Such that:</p>
<ul>
<li><strong>Base64String</strong> - concatenates each byte[] and then returns the Base64 String of the concatenated byte[]</li>
<li><strong>k</strong> - is a secret key that is only known to our server</li>
<li><strong>IV</strong> - is a randomly generated <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Initialization_vector_.28IV.29">Initialization Vector</a></li>
<li><strong>aes_cbc</strong> - encrypts the plainText using AES/CBC with the provided IV</li>
<li><strong>plainText</strong> - is in the format of &ldquo;username=winch&amp;firstName=Rob&amp;lastName=Winch&rdquo;</li>
</ul><p><strong>NOTE</strong>: It is safe and common for us to include the IV in plaintext along with the encrypted text. Since the IV is a fixed number of bytes, it can be easily extracted from a combined IV,encrypted_value byte[].</p><h2><a href="#review-of-xor" class="anchor" name="review-of-xor"></a>Review of XOR</h2><p>Before we go any further it is important to understand <a href="https://en.wikipedia.org/wiki/Exclusive_or">XOR</a>. To refresh your memory here is a truth table for XOR</p>
<table>
<thead>
<tr>
<th>A </th>
<th>B </th>
<th>Output</th>
</tr>
</thead>
<tbody>
<tr>
<td>0 </td>
<td>0 </td>
<td>0</td>
</tr>
<tr>
<td>0 </td>
<td>1 </td>
<td>1</td>
</tr>
<tr>
<td>1 </td>
<td>0 </td>
<td>1</td>
</tr>
<tr>
<td>1 </td>
<td>1 </td>
<td>0</td>
</tr>
</tbody>
</table><h2><a href="#how-does-cbc-decryption-use-the-iv" class="anchor" name="how-does-cbc-decryption-use-the-iv"></a>How does CBC decryption use the IV?</h2><p>To understand how we are going to impersonate another user, we first need to understand a little bit how AES / CBC works. AES is a <a href="https://en.wikipedia.org/wiki/Block_cipher">block cypher</a> which means our message is broken into fixed size blocks and then operations are performed on each block.</p><p>When decrypting AES / CBC, the decrypted value of the first block is XORed with the IV. For example, the following would hold true.</p>
<pre><code class="prettyprint text">decrypt(k, encrypted_first_block) XOR IV = plaintext_first_block
</code></pre><p>To get a better understanding, let&rsquo;s take a look at a concrete example. Assume that the following is true:</p>
<ul>
<li>decrypt(k, encrypted_first_block) is 11011101</li>
<li>IV is 10101010</li>
</ul><p><strong>NOTE</strong>: Our example is simplified by using a block size of 8 bits instead of the actual block size of 128 bits. This makes it easier for humans to follow along.</p><p>This means our plaintext_first_block would be 01110111 (&ldquo;w&rdquo; in <a href="https://en.wikipedia.org/wiki/ASCII#ASCII_printable_characters">ASCII</a>). Our work is shown below:</p>
<pre><code class="prettyprint text">     decrypt(k, encrypted_first_block)
 XOR IV
 ------------
     plaintext_first_block
 
    11011101       
XOR 10101010
------------
    01110111 // &quot;w&quot; ASCII
</code></pre><h2><a href="#modifying-the-decrypted-value" class="anchor" name="modifying-the-decrypted-value"></a>Modifying the decrypted value</h2><p>With the information above, we can modify the decrypted value. Specifically, given:</p>
<ul>
<li>a valid encrypted value</li>
<li>the corresponding IV</li>
<li>the corresponding plaintext</li>
</ul><p>we can calculate a modified IV named IV&rsquo; that will be combined with the original valid encrypted value to impersonate another user.</p><p>The first step is to calculate the unknown value of decrypt(k, encrypted_first_block) by canceling out all the bits in the IV by XOR with the first_block_plaintext. Our work is illustrated below:</p>
<pre><code class="prettyprint text">     IV
 XOR plaintext_first_block
 ------------
     decrypt(k, encrypted_first_block)
 
     10101010       
 XOR 01110111
 ------------
     11011101
</code></pre><p>The final step is to calculate IV&rsquo; by executing decrypt(k, encrypted_first_block) XOR desired_plaintext_first_block. Once again, our work is illustrated below:</p>
<pre><code class="prettyprint text">     decrypt(k, encrypted_first_block)
 XOR desired_plaintext_first_block
 ------------
     IV&#39;
 
     11011101       
 XOR 01100001 // &quot;a&quot; ASCII
 ------------
     10111100
</code></pre><p>We can now verify that providing IV&rsquo; with the originally encrypted value would result in &ldquo;a&rdquo; instead of &ldquo;w&rdquo;. </p>
<pre><code class="prettyprint text">     decrypt(k, encrypted_first_block)
 XOR IV&#39;
 ------------
     desired_plaintext_first_block
 
    11011101       
XOR 10111100
------------
    01100001 // This is &quot;a&quot; ASCII
</code></pre><p>This demonstrates that if we provide IV&rsquo; (instead of IV) along with the originally encrypted value it will be decrypted as &ldquo;a&rdquo;.</p><h2><a href="#impersonating-another-user" class="anchor" name="impersonating-another-user"></a>Impersonating another user</h2><p>Now that we have seen how we can create a modified IV to make our encrypted value whatever we like, let&rsquo;s explore how this applies to us authenticating as a user and then modifying our encrypted cookie to impersonate another user.</p><p>In the <a href="#modifying-the-decrypted-value">Modifying the decrypted value</a> section, we mentioned we needed some information before we could perform the exploit. Let&rsquo;s see how we can obtain the information necessary for the exploit with the encrypted cookie:</p>
<ul>
<li><strong>a valid encrypted value</strong> - An encrypted value is transmitted in the cookie and can be viewed by anyone with a valid account</li>
<li><strong>the corresponding IV</strong> - An IV is transmitted in the cookie and can be viewed by anyone with a valid account</li>
<li><strong>the corresponding plaintext</strong> - For simplicity, assume a malicious user discovered the format of the cookie by observing the cookie name corresponded to an open source framework. The format was then calculated by knowledge of the user we authenticated as and studying the code of the open source framework.</li>
</ul><p>Now that we have the necessary information and have an understanding of how we can <a href="#modifying-the-decrypted-value">modify the encrypted value</a>, it is easy to see that we can impersonate any user we want. So long as we have a valid account, we can create an IV&rsquo; that changes the username in the encrypted cookie to be the desired user of our choice.</p><h2><a href="#source-code" class="anchor" name="source-code"></a>Source Code</h2><p>Not convinced of the exploit? See it demonstrated by running the <a href="https://github.com/rwinch/encryption-not-signing">sample project on github</a>. To run the sample import it as a Maven project into your favorite IDE and run the <a href="https://github.com/rwinch/encryption-not-signing/blob/master/src/main/java/demo/Main.java">demo.Main</a> class. </p><p>You will observe that we authenticate as &ldquo;winch&rdquo; but are able to modify the encrypted cookie to impersonate a user named &ldquo;admin&rdquo;.</p><h2><a href="#conclusion" class="anchor" name="conclusion"></a>Conclusion</h2><p>At this point I hope you are convinced that encryption is not a valid way of providing authenticity. Instead, we would need ensure the cookie is signed. One solution would be to use <a href="https://en.wikipedia.org/wiki/Authenticated_encryption">authenticated encryption</a> which provides secrecy, integrity, and authenticity.</p><p>Please keep in mind that simply signing our cookie does not make it secure. There are other attack vectors, like <a href="https://en.wikipedia.org/wiki/Replay_attack">replay attacks</a>, that must be addressed in order to make the solution secure.</p><p>We must realize that security is hard and should not be implemented on your own or even within a small number of individuals. Instead security is best implemented in a community that can check one another for mistakes.</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 1336;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>