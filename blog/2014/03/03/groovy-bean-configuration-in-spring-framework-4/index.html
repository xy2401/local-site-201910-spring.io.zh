<html  data-code-prettify="" data-mobile-support="" data-search=""><head>
<title>Spring Framework 4中的Groovy Bean配置</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="Groovy Bean Configuration in Spring Framework 4">
<meta name="twitter:description" >
<meta name="twitter:creator" content="@dturanski">
<meta name="twitter:image:src" content="https://gravatar.com/avatar/1298cda9d866a053f693e17eee10902b?s=200">

<meta property="og:title" content="Groovy Bean Configuration in Spring Framework 4">
<meta property="og:image" content="https://gravatar.com/avatar/1298cda9d866a053f693e17eee10902b?s=200">
<meta property="og:description" >
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2014-03-03 17:24:00.0">



<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Spring Framework 4中的Groovy Bean配置</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/1298cda9d866a053f693e17eee10902b?s=20&d=mm"> <a class="author" rel="author" href="/team/dturanski">大卫·图兰斯基（David Turanski）</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2014-03-03 17:24:00.0">2014年3月3日</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2014/03/03/groovy-bean-configuration-in-spring-framework-4#disqus_thread" data-disqus-identifier="1387">
</a></div>
</div>
</header>
<div class="blog--post"><p>这篇文章旨在向Java开发人员介绍Groovy Bean Builder，作为Java @Configuration和XML配置的有力替代或补充。Spring Framework 4.0版包括Grails Bean Builder到核心Spring Framework的端口，提供用于配置Spring应用程序的Groovy DSL。Groovy和Grails开发人员无疑对以这种方式配置Spring应用程序很熟悉，我希望你们中的其他人已经在思考“那有多酷？”</p><p>如果您不是Groovy专家，请不要担心。正如许多Java程序员使用另一种流行的Groovy DSL Gradle来构建应用程序一样，您只需要知道一些基本语法即可上手。示例代码在<a href="https://github.com/dturanski/groovy-beans">github</a>上可用。</p><h2><a href="#the-basics" class="anchor" name="the-basics"></a>基础</h2><p>以下Groovy代码提供了一些非常简单的bean定义。最高层<code>beans {...}</code>构造实际上是<a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/beans/factory/groovy/GroovyBeanDefinitionReader.html">GroovyBeanDefinitionReader</a>作为DSL处理的闭包。</p>
<pre><code class="prettyprint groovy">beans {
    framework String, &#39;Grails&#39;
    foo String, &#39;hello&#39;
    bar(Bar,s:&#39;hello&#39;,i:123)
}
</code></pre><p>闭包中包含的三行是遵循语法的“虚拟”方法</p>
<pre><code class="prettyprint groovy">beanName(type, constructor-args)  // parens optional
</code></pre><p>请注意，Groovy对象始终提供一个接受可以包含任何类属性和对应值的映射的构造函数。最后一行实例化一个类的实例<code>Bar</code>包含两个字段， <code>s</code>和<code>i</code> 。使用嵌套闭包（无限）定义属性也很容易：</p>
<pre><code class="prettyprint groovy">import my.company.MyBeanImpl
beans = {
    myBean(MyBeanImpl) {
        someProperty = 42
        otherProperty = &quot;blue&quot;
    }
}
````

Bean references are also very straightforward. The Groovy equivalent of 

</code></pre><p><bean id="someBean" class="com.SomeClass"><br> <property name="someProperty" ref="someOtherBean"></property><br></bean><br>```<br>是</p>
<pre><code class="prettyprint groovy">someBean(com.SomeClass) {
    someProperty = ref(&#39;someOtherBean&#39;)
}
</code></pre><p>通常<code>ref</code>不需要：</p>
<pre><code class="prettyprint groovy">someBean(com.SomeClass) {
    someProperty = someOtherBean
}
</code></pre><p>马上就可以看到，Groovy在眼睛和键盘上比等效的XML或Java配置容易得多：</p>
<pre><code class="prettyprint xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;
      &lt;bean id=&quot;myBean&quot; class=&quot;my.company.MyBeanImpl&quot;&gt;
          &lt;property name=&quot;someProperty&quot; value=&quot;42&quot;/&gt;
          &lt;property name=&quot;anotherProperty&quot; value=&quot;blue&quot;/&gt;
     &lt;/bean&gt;
&lt;/beans&gt;
</code></pre>
<pre><code class="prettyprint java">import my.company.MyBeanImpl;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Bean;
@Configuration
public class MyConfig() {
    @Bean myBean() {
          MyBeanImpl myBean = new MyBeanImpl();
          myBean.setSomeProperty(42);
          myBean.setAnotherProperty(&quot;blue&quot;);
          return myBean;
    }
}
</code></pre><p>另外，Groovy Bean Builder接受闭包的参数，以允许您在必要时配置Spring Bean定义属性：</p>
<pre><code class="prettyprint groovy">sessionFactory(ConfigurableLocalSessionFactoryBean) { bean -&gt;
    // Sets the initialization method to &#39;init&#39;. [init-method]
    bean.initMethod = &#39;init&#39;

    // Sets the destruction method to &#39;destroy&#39;. [destroy-method]
    bean.destroyMethod = &#39;destroy&#39;

    // Sets the scope of the bean. [scope]
    bean.scope = &#39;request&#39;
    dataSource = ref(&#39;dataSource&#39;)

    hibernateProperties = [&quot;hibernate.hbm2ddl.auto&quot;: &quot;create-drop&quot;,
                           &quot;hibernate.show_sql&quot;:     &quot;true&quot;]
}
</code></pre><p>而且会变得更好。注意，Bean Builder DSL是有效的Groovy代码。这意味着您可以添加内联Groovy代码来执行一些有趣的事情，这些事情可能会使用更传统的方式来配置Spring应用程序而使您感到痛苦或无法实现。简而言之，您可以在Groovy中执行的任何操作都可以通过Bean Builder进行。实际上，您不想在DSL中加入很多逻辑，但是在有意义的地方，您可以有很多选择。</p><p>例如，当我在Spring 4的GA发布之前开始研究时，我惊讶于DSL不包含对Spring环境配置文件的支持。作者乐于考虑，但事实证明这并不是必须的。</p><p>使用环境配置文件<br>-</p><p>下面显示了使用配置文件的蛮力方式。的<code>beans</code>闭包委托给GroovyBeanDefinitionReader，您可以从其中访问环境。在这里，我们可以用<code>if...else</code>块，用于根据特定配置文件是否处于活动状态有条件地定义bean。</p>
<pre><code class="prettyprint groovy">beans {
    // org.springframework.beans.factory.groovy.GroovyBeanDefinitionReader
    if (environment.activeProfiles.contains(&quot;prof1&quot;)) {
        foo String, &#39;hello&#39;
    } else {
        foo String, &#39;world&#39;
    }
}
</code></pre><p>与在本示例中使用配置文件相比，更有趣的是能够将条件表达式应用于配置。GroovyBeanDefinitionReader基本上是在幕后编译Groovy脚本。DSL使用Groovy元编程来解释它在顶层遇到的未知方法<code>beans</code>封闭如<code>foo</code>作为bean的定义。这提供了两全其美的方法，将声明性配置的即时性与Groovy的全部功能结合在一起。实际上，Spring 3中引入的环境配置文件的主要驱动程序之一就是以一种在XML约束内简单起作用的方式来支持条件配置。尽管可以用XML实现编程结构，但事实证明，这样做的许多尝试（例如Jelly，XSLT）非常痛苦，极大地加剧了对XML的普遍反对。</p><p>在Java中使用Groovy配置<br>-<br>如果以上配置包含在<code>config/contextWithProfiles.groovy</code>然后使用Java中的应用程序上下文就像您期望的那样简单：</p>
<pre><code class="prettyprint java">ApplicationContext context = new GenericGroovyApplicationContext(&quot;file:config/contextWithProfiles.groovy&quot;);
String foo =  context.getBean(&quot;foo&quot;,String.class);
</code></pre><p>在上面的示例中， <code>foo</code>将是默认值<code>world</code> （除非有任何外部环境配置文件设置）。另外，您可以设置配置文件：</p>
<pre><code class="prettyprint java">GenericGroovyApplicationContext context = new GenericGroovyApplicationContext();
context.getEnvironment().addActiveProfile(&quot;prof1&quot;);
context.load(&quot;file:config/contextWithProfiles.groovy&quot;);
context.refresh();
String foo =  context.getBean(&quot;foo&quot;,String.class);
assertEquals(&quot;hello&quot;,foo);
</code></pre><h2><a href="#variable-binding" class="anchor" name="variable-binding"></a>变量绑定</h2><p>在讨论环境概要文件之前，让我们看一下如何绑定Groovy bean配置中引用的任何变量：</p>
<pre><code class="prettyprint java">import groovy.lang.Binding;
...
GenericGroovyApplicationContext context = new GenericGroovyApplicationContext();
context.getEnvironment().addActiveProfile(&quot;prof1&quot;);

Binding binding = new Binding();
binding.setVariable(&quot;profiles&quot;,context.getEnvironment().getActiveProfiles());
binding.setVariable(&quot;mode&quot;,&quot;test&quot;);
context.getReader().setBinding(binding);
context.load(&quot;file:config/contextWithBindings.groovy&quot;);
context.refresh();
````

The above snippet requires Groovy (e.g, groovy-all.jar) as a compile time dependency and works seamlessly with Java.  Here we are binding the variables `profiles` and `mode` before loading the configuration:

</code></pre><p>beans {<br>如果（profiles.contains（“ prof1”））{<br>foo字符串，模式=='测试'？'测试'：'你好'<br>}其他{<br>foo字符串，“世界”<br>}<br>}<br>```</p><p>使用变量绑定和内联条件表达式，我们可以开始了解为什么环境配置文件变得无关紧要。需要注意的是，如果要与已经使用环境配置文件的Spring生态系统集成，则可能需要对其进行支持。</p><p>使用外部属性<br>-<br>同样，此处的占位符用途有限。一方面，Groovy字符串已经使用相同的语法执行内联变量替换，所以传统的属性占位符往往使事情变得混乱：</p>
<pre><code class="prettyprint groovy">def val=&#39;world&#39;
def greeting=&quot;hello, ${val}!!&quot; 
</code></pre><p>在XML配置的早期，属性占位符是必需的，而Spring是从Ant剧本中借来的。即使使用基于注解的配置，它们仍在Spring中广泛使用。 <code>@Value</code> 。Groovy提供了一些强大的替代方案来合并外部属性。例如， <code>ConfigSlurper</code>是核心Groovy库的一部分，通常在Grails应用程序中使用。我们可以使用它直接加载外部配置：</p>
<pre><code class="prettyprint groovy">import org.springframework.core.io.ClassPathResource
def url = new ClassPathResource(&#39;spring.config&#39;).URL
def config = new ConfigSlurper().parse(url)

beans {
    if (config.color==&#39;red&#39;) {
        foo String, &#39;hello&#39;
    } else {
        foo String, &#39;world&#39;
    }
}
</code></pre><p>或者，如果您愿意，可以加载一个普通的旧属性文件：</p>
<pre><code class="prettyprint groovy">import org.springframework.core.io.ClassPathResource

def properties = new Properties()
properties.load(new ClassPathResource(&#39;spring.properties&#39;).inputStream);

beans {
    if (properties.color==&#39;red&#39;) {
        foo String, &#39;hello&#39;
    } else {
        foo String, &#39;world&#39;
    }
}
</code></pre><p>公平地说，您也可以使用Java配置来执行此类操作。Groovy使您可以将类型安全性换成富有表现力的优雅。</p><p>新视野<br>---<br>为了更进一步，Groovy配置提供了其他配置方法无法比拟的灵活性。例如，Spring的组件扫描器将扫描类路径，以查找带有注释（例如， <code>@Configuration</code>和<code>@Component</code> 。由于扫描整个类路径效率低下，因此Spring要求组件扫描器指定至少一个基本包。在XML中，这类似于：</p>
<pre><code class="prettyprint xml">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;
       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;&gt;
    &lt;context:component-scan base-package=&quot;my.beans&quot;/&gt;
&lt;/beans&gt;
</code></pre><p>如果我希望基本软件包可配置怎么办？我不能在包名称中使用属性占位符，因为Spring在生命周期后期会处理属性占位符。对于<code>@ComponentScan(basePackage="...")</code>注解。另一方面，使用GroovyBeanDefinitionReader，Groovy编译器处理配置脚本，在Spring bean工厂甚至没有看到它之前就解析变量。以下配置将基本程序包绑定到外部属性值：</p>
<pre><code class="prettyprint groovy">import org.springframework.core.io.ClassPathResource

def url = new ClassPathResource(&#39;spring.config&#39;).URL;
def config = new ConfigSlurper().parse(url);

beans {
    xmlns([ctx:&#39;http://www.springframework.org/schema/context&#39;])
    ctx.&#39;component-scan&#39;(&#39;base-package&#39;:config.basePackage)
}
</code></pre><p>请注意用于声明XML名称空间的简洁语法。</p><p>甚至可以将相同的技巧应用于bean id和class名称本身：</p>
<pre><code class="prettyprint groovy">def id1=&#39;bar&#39;
def clazz=Bar.class

beans {
    framework String, &#39;Grails&#39;
    foo String, &#39;hello&#39;
    &quot;$id1&quot;(clazz,s:&#39;hello&#39;,i:123)
}
</code></pre><p>最后两个示例似乎很深奥，但是我在使用Spring开发大型应用程序时遇到了这两个问题。</p><p>那么……那有多酷？让我们知道@SpringCentral</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 1387;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>请启用JavaScript以查看<a href="http://disqus.com/?ref_noscript">由Disqus提供</a>的<a href="http://disqus.com/?ref_noscript">评论。</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">由<span class="logo-disqus">Disqus</span>提供动力的评论</a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>背部</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">所有帖子</a> <a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">工程</a> <a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">发布</a> <a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">新闻与活动</a> <a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>将The Spring Team的更新发送到您的收件箱</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">工具类</a></li>
<li><a href="https://store.pivotal.io/">商店</a></li>
<li><a href="/blog">通讯</a></li>
</ul>
</div>
</div>© <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a> ，Inc.保留所有权利。
<a href="https://pivotal.io/terms-of-use">使用条款</a> • <a href="https://pivotal.io/privacy-policy">隐私</a> • <a href="/trademarks">商标准则</a>
<div id="teconsent" style="display:inline-block"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>