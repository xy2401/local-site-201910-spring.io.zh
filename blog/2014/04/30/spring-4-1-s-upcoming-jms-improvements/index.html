<html  data-code-prettify="" data-mobile-support="" data-search=""><head>
<title>Spring 4.1即将进行的JMS改进</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="Spring 4.1's Upcoming JMS Improvements">
<meta name="twitter:description" >
<meta name="twitter:creator" content="@snicoll">
<meta name="twitter:image:src" content="https://gravatar.com/avatar/33d0963a20138828608f3f61927545b8?s=200">

<meta property="og:title" content="Spring 4.1's Upcoming JMS Improvements">
<meta property="og:image" content="https://gravatar.com/avatar/33d0963a20138828608f3f61927545b8?s=200">
<meta class="anchor" name="annotation-driven-listener-endpoints" property="og:description" content="<p>Spring Framework 4.0 introduced a new <code>spring-messaging</code> module, adding a selection of Spring Integration types such as the core <code>Message</code> abstraction. Spring 4.1 aligns its JMS support to allow you to benefit from that abstraction. But before diving into that, I’d like to show you in details how we further improved the infrastructure for listener endpoints.</p>
<h1><a href=" #annotation-driven-listener-endpoint="=">Annotation-driven listener endpoints
<p>You are probably used to the <code><xyz:annotation-driven></code> element or the <code>@Enable*</code> counterpart and perhaps you were looking for something similar for JMS. Look no further: the next major release of the Spring framework will allow you to define JMS listeners with a simple annotation.</p>
">
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2014-04-30 12:52:00.0">



<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>工程</div>
</div>
<div class="blog-category content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Spring 4.1即将进行的JMS改进</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">工程</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/33d0963a20138828608f3f61927545b8?s=20&d=mm"> <a class="author" rel="author" href="/team/snicoll">斯特凡·尼科尔（StéphaneNicoll）</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2014-04-30 12:52:00.0">2014年4月30日</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2014/04/30/spring-4-1-s-upcoming-jms-improvements#disqus_thread" data-disqus-identifier="1529">
</a></div>
</div>
</header>
<div class="blog--post"><p>Spring Framework 4.0引入了新的<code>spring-messaging</code>模块，添加一些Spring Integration类型的选择，例如核心<code>Message</code>抽象。Spring 4.1调整了其对JMS的支持，使您可以从该抽象中受益。但是在深入探讨之前，我想向您详细介绍我们如何进一步改善侦听器端点的基础结构。</p><h1><a href="#annotation-driven-listener-endpoints" class="anchor" name="annotation-driven-listener-endpoints"></a>注释驱动的侦听器端点</h1>
<p>您可能已经习惯了<code><xyz:annotation-driven></code>元素或<code>@Enable*</code>同行，也许您正在寻找JMS的类似产品。不用再看了：Spring Framework 的下一个主要版本将使您可以使用简单的注释定义JMS侦听器。</p>
<pre><code class="prettyprint java">@Component
public class MyService {

    @JmsListener(containerFactory = &quot;myContainerFactory&quot;, destination = &quot;myQueue&quot;)
    public void processOrder(String data) { ... }

}
</code></pre>
<p>以下配置（忽略JMS基础结构设置）在Windows Server 2003的掩盖下创建了一个JMS消息侦听器容器。 <code>myQueue</code>目的地，将致电<code>processOrder</code>只要有消息可用：</p>
<pre><code class="prettyprint java">@Configuration
@EnableJms
public class AppConfig {
	
    @Bean
    public DefaultJmsListenerContainerFactory myContainerFactory() {
        DefaultJmsListenerContainerFactory factory =
                new DefaultJmsListenerContainerFactory();
        factory.setConnectionFactory(connectionFactory());
        factory.setDestinationResolver(destinationResolver());
        factory.setConcurrency(&quot;3-10&quot;);
        return factory;
    }
}
</code></pre>
<p>这与使用XML名称空间等效：</p>
<pre><code class="prettyprint xml">&lt;jms:annotation-driven/&gt;

&lt;bean id=&quot;myContainerFactory&quot;
        class=&quot;org.springframework.jms.config.DefaultJmsListenerContainerFactory&quot;&gt;
    &lt;property name=&quot;connectionFactory&quot; ref=&quot;connectionFactory&quot;/&gt;
    &lt;property name=&quot;destinationResolver&quot; ref=&quot;destinationResolver&quot;/&gt;
    &lt;property name=&quot;concurrency&quot; value=&quot;3-10&quot;/&gt;
&lt;/bean&gt;
</code></pre>
<p>照常， <code>@JmsListener</code>可以直接放置在方法上，也可以使用元注释间接放置。注释具有通常的选项，这些选项由<code>jms:listener</code> XML元素。的<code>containerFactory</code>是新的，并指代名称<code>JmsListenerContainerFactory</code> ，相当于您以前在<code><jms:listener-container></code>元件。</p>
<p>如果您希望从现有配置平稳过渡，我们添加了一个<code>factory-id</code>该元素的属性。如果存在，配置将自动显示为<code>JmsListenerContainerFactory</code>那个名字的豆子此XML配置等同于<code>myJmsContainerFactory</code>上面的bean：</p>
<pre><code class="prettyprint xml">&lt;jms:listener-container factory-id=&quot;myContainerFactory&quot; 
               connection-factory=&quot;connectionFactory&quot;
               destination-resolver=&quot;destinationResolver&quot;
               concurrency=&quot;3-10&quot;/&gt;
</code></pre>
<p>由于单个容器的出厂设置相当普遍，因此<code>containerFactory</code>如果已设置或发现了默认属性，则可以忽略该属性。默认情况下，我们查找一个名为<code>jmsListenerContainerFactory</code> 。</p>
<p>通过实施以下操作，可以通过多种方式自定义此基础架构的配置<code>JmsListenerConfigurer</code>接口。就像我们刚刚提到的，可以显式指定要使用的默认容器工厂，但是此回调接口还允许您以编程方式注册JMS端点！</p>
<pre><code class="prettyprint java">@Configuration
@EnableJms
public class AppConfig implements JmsListenerConfigurer {

    @Override
    public void configureJmsListeners(JmsListenerEndpointRegistrar registrar) {
        registrar.setDefaultContainerFactory(defaultContainerFactory());

        SimpleJmsListenerEndpoint endpoint = new SimpleJmsListenerEndpoint();
        endpoint.setDestination(&quot;anotherQueue&quot;);
        endpoint.setMessageListener(message -&gt; {
            // processing
        });
        registrar.registerEndpoint(endpoint);
    }

    @Bean
    public DefaultJmsListenerContainerFactory defaultContainerFactory() {
        ...
    }

</code></pre>
<p>上面的示例设置了默认值<code>JmsListenerContainerFactory</code>并在上配置其他端点<code>anotherQueue</code> 。 <code>JmsListenerEndpoint</code>为端点建模，并负责为该模型配置容器。在上面的示例中，我们使用了<code>SimpleJmsListenerEndpoint</code>提供实际的<code>MessageListener</code>调用，但您也可以构建自己的描述自定义调用机制的端点变体。 <code>MethodJmsListenerEndpoint</code>是另一个示例，所有带有注释的端点都使用<code>@JmsListener</code> 。</p><h1><a href="#messaging-abstraction" class="anchor" name="messaging-abstraction"></a>消息传递抽象</h1>
<p>到目前为止，我们一直在注入一种简单的方法<code>String</code>在我们的端点中，但实际上它可以具有非常灵活的方法签名。让我们重写它以注入<code>Order</code>具有自定义标头：</p>
<pre><code class="prettyprint java">@Component
public class MyService {

    @JmsListener(destination = &quot;myQueue&quot;)
    public void processOrder(Order order,  @Header(&quot;order_type&quot;) String orderType) {
        ...
    }
}
</code></pre>
<p>这些是您可以在JMS侦听器端点中注入的主要元素：<br>*原始<code>javax.jms.Message</code>或其任何子类（当然要与传入的消息类型匹配）。<br>*的<code>javax.jms.Session</code>用于对本机JMS API的可选访问，例如用于发送自定义回复。<br>*的<code>org.springframework.messaging.Message</code>表示传入的JMS消息。请注意，此消息同时包含自定义标头和标准标头（由<code>JmsHeaders</code> ）。<br>* <code>@Header</code> -带注释的方法参数以提取特定的标头值，包括标准的JMS标头。<br>* <code>@Headers</code>注释的参数，也必须可分配给<code>java.util.Map</code>用于访问所有标题。<br>*非注释元素，不是支持的类型之一（即<code>Message</code>和<code>Session</code> ）被视为有效负载。您可以通过使用<code>@Payload</code> 。您还可以通过添加额外的内容来启用验证<code>@Validated</code> 。</p>
<p>注入Spring的能力<code>Message</code>抽象特别有用，它可以受益于存储在特定于传输的消息中的所有信息，而无需依赖于特定于传输的API。</p>
<pre><code class="prettyprint java">@JmsListener(destination = &quot;myQueue&quot;)
public void processOrder(Message&lt;Order&gt; order) { ... }
</code></pre>
<p>这些功能位于所有带注释元素的封面下。可以自定义验证和转换服务，甚至可以为自定义用例添加其他方法参数解析器。以下示例设置了一个自定义<code>Validator</code>这样<code>@Validated</code>带注释的有效负载首先使用它进行验证，然后调用侦听器方法：</p>
<pre><code class="prettyprint java">@Configuration
@EnableJms
public class AppConfig implements JmsListenerConfigurer {

    @Override
    public void configureJmsListeners(JmsListenerEndpointRegistrar registrar) {
        registrar.setJmsHandlerMethodFactory(myJmsHandlerMethodFactory());
    }

    @Bean
    public DefaultJmsHandlerMethodFactory myJmsHandlerMethodFactory() {
        DefaultJmsHandlerMethodFactory factory = new DefaultJmsHandlerMethodFactory();
        factory.setValidator(myValidator());
        return factory;
    }
}
</code></pre><h1><a href="#reply-management" class="anchor" name="reply-management"></a>回复管理</h1>
<p>现有支持<code>MessageListenerAdapter</code>已经允许您的方法具有非<code>void</code>返回类型。在这种情况下，调用结果封装在<code>javax.jms.Message</code>在指定的目的地中发送<code>JMSReplyTo</code>原始消息的标题或在侦听器上配置的默认目标中。现在可以使用<code>@SendTo</code>消息传递抽象的注释。</p>
<p>假设我们<code>processOrder</code>方法现在应该返回<code>OrderStatus</code> ，可以按照以下方式编写以自动发送回复：</p>
<pre><code class="prettyprint java">@JmsListener(destination = &quot;myQueue&quot;)
@SendTo(&quot;queueOut&quot;)
public OrderStatus processOrder(Order order) {
    // order processing
    return status;
}
</code></pre>
<p>如果您需要以与传输无关的方式设置其他标头，则可以返回<code>Message</code>相反，类似：</p>
<pre><code class="prettyprint java">@JmsListener(destination = &quot;myQueue&quot;)
@SendTo(&quot;queueOut&quot;)
public Message&lt;OrderStatus&gt; processOrder(Order order) {
    // order processing
    return MessageBuilder
            .withPayload(status)
            .setHeader(&quot;code&quot;, 1234)
            .build();
}
</code></pre><h1><a href="#wrapping-up" class="anchor" name="wrapping-up"></a>包起来</h1>
<p>Spring Framework 4.1将于今年7月发布，并且将在JMS领域进行一些改进：JMS侦听器方法可以简单地进行注释，并且可以使用非常灵活的方法签名。JMS侦听器现在也支持Spring 4.0中引入的消息传递抽象。</p></div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 1529;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>请启用JavaScript以查看<a href="http://disqus.com/?ref_noscript">由Disqus提供</a>的<a href="http://disqus.com/?ref_noscript">评论。</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">由<span class="logo-disqus">Disqus</span>提供动力的评论</a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>背部</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">所有帖子</a> <a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">工程</a> <a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">发布</a> <a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">新闻与活动</a> <a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>将The Spring Team的更新发送到您的收件箱</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">球队</a></li>
<li><a href="/tools">工具类</a></li>
<li><a href="https://store.pivotal.io/">商店</a></li>
<li><a href="/blog">通讯</a></li>
</ul>
</div>
</div>© <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a> ，Inc.保留所有权利。
<a href="https://pivotal.io/terms-of-use">使用条款</a> • <a href="https://pivotal.io/privacy-policy">隐私</a> • <a href="/trademarks">商标准则</a>
<div id="teconsent" style="display:inline-block"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>