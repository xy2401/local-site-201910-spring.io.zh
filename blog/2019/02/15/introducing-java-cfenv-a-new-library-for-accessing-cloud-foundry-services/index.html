<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Introducing java-cfenv: A new library for accessing Cloud Foundry Services</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Introducing java-cfenv: A new library for accessing Cloud Foundry Services" />
<meta name="twitter:description" content="&lt;h2&gt;&lt;a href=&quot;#introduction&quot; class=&quot;anchor&quot; name=&quot;introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h2&gt;
&lt;p&gt;The Spring Cloud Connectors library has been with us since the launch event of Cloud Foundry itself back in 2011. One of the main goals of the connector library and Cloud Foundry’s Java buildpack was to “reduce the initial investment when you want to get started with Cloud Foundry”. The connector library creates the Spring bean definitions required to connect to backing services, like databases, using information contained in the VCAP_SERVICES environment variable. The buildpack then replaces these bean definitions you had in your application with those created by the connector library through a feature called ‘auto-reconfiguration’. You may have seen it mentioned in the logs when you pushed an app to Cloud Foundry…&lt;/p&gt;
" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/5cffed9a3aad16d33d07f6e7ef2ebbb7?s=200" />

<meta property="og:title" content="Introducing java-cfenv: A new library for accessing Cloud Foundry Services" />
<meta property="og:image" content="https://gravatar.com/avatar/5cffed9a3aad16d33d07f6e7ef2ebbb7?s=200" />
<meta property="og:description" content="&lt;h2&gt;&lt;a href=&quot;#introduction&quot; class=&quot;anchor&quot; name=&quot;introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h2&gt;
&lt;p&gt;The Spring Cloud Connectors library has been with us since the launch event of Cloud Foundry itself back in 2011. One of the main goals of the connector library and Cloud Foundry’s Java buildpack was to “reduce the initial investment when you want to get started with Cloud Foundry”. The connector library creates the Spring bean definitions required to connect to backing services, like databases, using information contained in the VCAP_SERVICES environment variable. The buildpack then replaces these bean definitions you had in your application with those created by the connector library through a feature called ‘auto-reconfiguration’. You may have seen it mentioned in the logs when you pushed an app to Cloud Foundry…&lt;/p&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2019-02-15 18:36:27.308" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
 </div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category content--title">
<div>Engineering</div>
</div>
<div class="blog-category active content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Introducing java-cfenv: A new library for accessing Cloud Foundry Services</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon releases"></div>
<a class="category">Releases</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/5cffed9a3aad16d33d07f6e7ef2ebbb7?s=20&amp;d=mm" />
<a class="author" rel="author" href="/team/mpollack">Mark Pollack</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2019-02-15 18:36:27.308">February 15, 2019</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="3566" href="/blog/2019/02/15/introducing-java-cfenv-a-new-library-for-accessing-cloud-foundry-services#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><h2><a href="#introduction" class="anchor" name="introduction"></a>Introduction</h2>
<p>The Spring Cloud Connectors library has been with us since the launch event of Cloud Foundry itself back in 2011. One of the main goals of the connector library and Cloud Foundry’s Java buildpack was to “reduce the initial investment when you want to get started with Cloud Foundry”. The connector library creates the Spring bean definitions required to connect to backing services, like databases, using information contained in the VCAP_SERVICES environment variable. The buildpack then replaces these bean definitions you had in your application with those created by the connector library through a feature called ‘auto-reconfiguration’. You may have seen it mentioned in the logs when you pushed an app to Cloud Foundry…</p>
<pre><code class="prettyprint bash">-----&gt; Downloading Spring Auto Reconfiguration 2.5.0_RELEASE from https://java-buildpack.cloudfoundry.org/auto-reconfiguration/auto-reconfiguration-2.5.0_RELEASE.jar
</code></pre>
<p>Auto-reconfiguration is great for getting started. However, it is not so great when you want more control, for example changing the size of the connection pool associated with a <code>DataSource</code>. This requires writing connector-specific code and it doesn’t expose as many connection pool options as Spring Boot does. The same limitations apply to other backing services. </p>
<p>This raises the question, why do we have two competing mechanisms to create service infrastructure beans? Can’t we let Spring Boot handle all of this for us? That was the motivation for creating our new <code>java-cfenv</code> library.</p><h2><a href="#introducing-java-cfenv" class="anchor" name="introducing-java-cfenv"></a>Introducing java-cfenv</h2>
<p>The <a href="https://github.com/pivotal-cf/java-cfenv">java-cfenv</a> library is inspired by the <a href="https://github.com/cloudfoundry-community/node-cfenv/">node-cfenv</a> and <a href="https://github.com/jmcarp/py-cfenv">py-cfenv</a> libraries used elsewhere in the Cloud Foundry ecosystem. These libraries provide a simple API for retrieving credentials from the JSON strings contained inside the <code>VCAP_SERVICES</code> environment variable. We will start with a tour of the Java API (which we don’t expect will be used very often) and then show how it integrates with Spring and Spring Boot’s auto-configuration functionality.</p>
<p>The core API consists of five classes </p>
<ul>
<li><code>CfEnv</code> which is responsible for parsing the contents of the <code>VCAP_SERVICES</code> and <code>VCAP_APPLICATION</code> environment variables.</li>
<li><code>CfApplication</code> that provides accessors for the contents of the <code>VCAP_APPLICATION</code> environment variable.</li>
<li>Finder methods on <code>CfEnv</code> return instances of a <code>CfService</code> class.</li>
<li><code>CfService</code> provides accessors for the name, label, tabs, and plan of the service as well as a <code>CfCredentials</code> object.</li>
<li><code>CfCredentials</code> provides accessors for getting the username, password, host, port, and URI. The URI is represented using a <code>UriInfo</code> class.</li>
</ul>
<p>For example, if you bind a MySql service to your application in Cloud Foundry, the <code>VCAP_SERVICES</code> environment variable would contain an entry such as</p>
<pre><code class="prettyprint javascript">{
 &quot;p-mysql&quot;: [
    {
      &quot;credentials&quot;: {
        &quot;hostname&quot;: &quot;10.0.4.35&quot;,
        &quot;port&quot;: 3306,
        &quot;name&quot;: &quot;cf_2e23d10a_8738_8c3c_66cf_13e44422698c&quot;,
        &quot;username&quot;: &quot;8McHri7aKbuTEGCR&quot;,
        &quot;password&quot;: &quot;J2BNJYkeXAH9idkG&quot;,
        &quot;uri&quot;: &quot;mysql://8McHri7aKbuTEGCR:<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="652f57272b2f3c0e003d242d5c0c010e222554554b554b514b5650">[email&#160;protected]</a>:3306/cf_2e23d10a_8738_8c3c_66cf_13e44422698c?reconnect=true&quot;,
        &quot;jdbcUrl&quot;: &quot;jdbc:mysql://10.0.4.35:3306/cf_2e23d10a_8738_8c3c_66cf_13e44422698c?user=8McHri7aKbuTEGCR&amp;password=J2BNJYkeXAH9idkG&quot;
      },
      &quot;syslog_drain_url&quot;: null,
      &quot;volume_mounts&quot;: [],
      &quot;label&quot;: &quot;p-mysql&quot;,
      &quot;provider&quot;: null,
      &quot;plan&quot;: &quot;100mb&quot;,
      &quot;name&quot;: &quot;mysql&quot;,
      &quot;tags&quot;: [
        &quot;mysql&quot;,
        &quot;relational&quot;
      ]
    }
  ]
}
</code></pre>
<p>When using the java-cfenv API, we can obtain the credential information using a few simple method calls, and then programmatically create a connection to your database.</p>
<pre><code class="prettyprint java">CfEnv cfEnv = new CfEnv();
CfService cfService = cfEnv.findServiceByName(“mysql”);
String plan = cfService.getPlan(); // 100mb
CfCredentials cfCredentials = cfService.getCredentials();
String password = cfCredentials.getPassword(); // J2BNJYkeXAH9idkG
UriInfo uriInfo = cfCredentials.getUriInfo();
String username = uriInfo.getUsername(); // 8McHri7aKbuTEGCR
</code></pre>
<p>The <code>findServiceByName</code> method takes a regular expression to help provide some portability across different Cloud Foundry environments which can name services slightly differently. There are other finder methods too, to help you select from tags and labels etc.</p><h2><a href="#database-support" class="anchor" name="database-support"></a>Database support</h2>
<p>In the previous example, you probably just want to obtain the JSON field jdbcUrl so you can pass it into a <code>DataSource</code>. You can do this using the API</p>
<pre><code class="prettyprint java">String jdbcUrl = cfCredentials.getString(“jdbcUrl”);
</code></pre>
<p>However, not all database services on Cloud Foundry provide this handy field. In fact, the fields provided by various database services on Cloud Foundry can be rather arbitrary. The existing connector library has developed heuristics to deal with this disparity, and this functionality has been ported over to the new java-cfenv library. It’s is available in the <code>CfEnvJdbc</code> class:</p>
<pre><code class="prettyprint java">CfEnvJdbc cfEnvJdbc = new CfEnvJdbc();
CfJdbcService cfJdbcService = cfEnvJdbc.findJdbcService();
String jdbcUrl = cfJdbcService.getUrl();
</code></pre>
<p>The method <code>findJdbcService</code> will throw an exception if there is more than one database service bound to the application. In this case, you can use the method <code>findJdbcServiceByName</code> to select among multiple database services.</p>
<pre><code class="prettyprint java">String jdbcUrl1 = cfEnvJdbc.findJdbcServiceByName(&#39;mysqlA&#39;).getUrl();
String jdbcUrl2 = cfEnvJdbc.findJdbcServiceByName(&#39;mysqlB&#39;).getUrl();
</code></pre><h2><a href="#use-with-spring" class="anchor" name="use-with-spring"></a>Use with Spring</h2>
<p>If you are using Spring and not Spring Boot, you can register a <code>CfJdbcEnv</code> instance as a bean and then invoke methods on it using the Spring Expression Language to set application properties.</p>
<pre><code class="prettyprint java">@Bean
public CfJdbcEnv cfJdbcEnv() {
  return new CfJdbcEnv();
}
</code></pre>
<p>Then in a property file, access the <code>CfJdbcEnv</code> instance</p>
<pre><code class="prettyprint java">myDatasourceUrl=#{ cfJdbcEnv.findJdbcService().getUrl() }
</code></pre><h2><a href="#use-with-spring-boot" class="anchor" name="use-with-spring-boot"></a>Use with Spring Boot</h2>
<p>Most Spring Boot users will not have to use the java-cfenv API directly. The java-cfenv library contains Spring Boot <code>EnvironmentPostProcessor</code> implementations that set well-known Spring Boot properties automatically. This allows for Spring Boot’s auto-configuration to kick-in while still leaving open the possibility of overriding values through environment variables or other higher prioritized environment property sources. </p>
<p>After generating your project from <a href="https://start.spring.io">start.spring.io</a>, all you need to do to make this work is to manually add the java-cfenv-boot dependency into your project, and disable auto-reconfiguration when pushing your application to Cloud Foundry. For maven, the dependency is:</p>
<pre><code class="prettyprint xml">&lt;dependency&gt;
  &lt;groupId&gt;io.pivotal.cfenv&lt;/groupId&gt;
  &lt;artifactId&gt;java-cfenv-boot&lt;/artifactId&gt;
  &lt;version&gt;1.0.0.M1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>Because this is currently a milestone build, you will need to add a milestone <code>&lt;repository&gt;</code> configuration such as:</p>
<pre><code class="prettyprint xml">&lt;repository&gt;
   &lt;id&gt;spring-milestones&lt;/id&gt;
   &lt;name&gt;Spring Milestones&lt;/name&gt;
   &lt;url&gt;http://repo.spring.io/libs-milestone-local&lt;/url&gt;
&lt;/repository&gt;
</code></pre>
<p>To disable auto-reconfiguration, use the following commands or their equivalent in a manifest file.</p>
<pre><code class="prettyprint bash">cf set-env &lt;APP&gt; JBP_CONFIG_SPRING_AUTO_RECONFIGURATION &#39;{enabled: false}&#39;
</code></pre>
<p>Since auto-reconfiguration also sets the <code>cloud</code> profile, which many applications have come to depend upon, you will likely need to also set this profile explicitly.</p>
<pre><code class="prettyprint bash">cf set-env &lt;APP&gt; SPRING_PROFILES_ACTIVE cloud
</code></pre>
<p>If you are using a manifest, the entries would be:</p>
<pre><code class="prettyprint yaml">env:
 SPRING_PROFILES_ACTIVE: cloud
 JBP_CONFIG_SPRING_AUTO_RECONFIGURATION: &#39;{enabled: false}&#39;
</code></pre>
<blockquote>
<p>It’s worth noting that in production, you probably should be doing this anyway.</p>
</blockquote>
<p>To set connection pool properties, you can now simply use standard Spring Boot properties such as <code>spring.datasource.maxActive=10</code> and other more specific connection pool properties.</p><h2><a href="#what-rsquo-s-next" class="anchor" name="what-rsquo-s-next"></a>What&rsquo;s next?</h2>
<p>More information on how to use the java-cfenv library is available on <a href="https://github.com/pivotal-cf/java-cfenv">GitHub</a>. The current release is 1.0.0.M1 and there will be a short path to a GA release since it is being incorporated into the Data Flow 2.0 GA release later this month. As always, we welcome your feedback and contributions, even if they result in breaking API changes that need to be incorporated into a java-cfenv 2.0 version shortly after the 1.0 release.</p>
<p>The 1.0 GA release of java-cfenv will support all the services that were part of the Spring Cloud Connectors project as they are well supported by Spring Boot auto-configuration. <strong>At that point, the existing Connectors library will be put into maintenance mode.</strong> Critical bugs and security issues will, of course, be addressed, but new features will not be added. A guide for migrating applications from Spring Cloud Connectors to java-cfenv will be provided with the 1.0 GA release of java-cfenv.</p>
<p>There are other libraries that build off the core Connectors project, listed on the project page. These extension projects can continue to use Connectors, but the maintainers are encouraged to migrate to a Boot-centric approach. </p></div>
</div>
<section id="disqus_thread"></section>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 3566;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>