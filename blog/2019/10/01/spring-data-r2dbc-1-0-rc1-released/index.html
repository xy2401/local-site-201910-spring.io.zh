<html dir="ltr" data-code-prettify="" data-mobile-support="" data-search=""><head>
<title>Spring Data R2DBC 1.0 RC1发布</title>
<meta id="Viewport" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no">
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png">
<link href="asset?aid=0" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css">
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>System.config({baseURL: "/b92013b"});</script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>System.import('app/main.js')</script>
<meta name="google-site-verification" content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M">

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@springcentral">
<meta name="twitter:title" content="Spring Data R2DBC 1.0 RC1 released">
<meta name="twitter:description" content="<p>On behalf of the team and everyone that contributed, I am pleased to announce that the first release candidate of Spring Data R2DBC 1.0 has been released and is available from our milestone repository. This release contains 60 issues and pull requests. It upgrades its baseline to R2DBC 0.8 RC1 and Spring Data Moore GA.</p>
<p>The most notable features are:</p>
<ul> 
 <li><code>ConnectionFactory</code> routing through <code>AbstractRoutingConnectionFactory</code>.</li> 
 <li>Utilities for schema initialization through <code>ResourceDatabasePopulator</code> and <code>ScriptUtils</code>.</li> 
 <li>Propagation and reset of Auto-Commit and Isolation Level control through <code>TransactionDefinition</code>.</li> 
 <li>Support for Entity-level converters.</li> 
 <li>Kotlin extensions for reified generics and Coroutines.</li> 
 <li>Add pluggable mechanism to register dialects.</li> 
 <li>API refinements.</li> 
</ul>
">
<meta name="twitter:creator" content="@mp911de">
<meta name="twitter:image:src" content="https://gravatar.com/avatar/6494a9d91e9ffef9adc8253257f1b35e?s=200">

<meta property="og:title" content="Spring Data R2DBC 1.0 RC1 released">
<meta property="og:image" content="https://gravatar.com/avatar/6494a9d91e9ffef9adc8253257f1b35e?s=200">
<meta property="og:description" content="<p>On behalf of the team and everyone that contributed, I am pleased to announce that the first release candidate of Spring Data R2DBC 1.0 has been released and is available from our milestone repository. This release contains 60 issues and pull requests. It upgrades its baseline to R2DBC 0.8 RC1 and Spring Data Moore GA.</p>
<p>The most notable features are:</p>
<ul> 
 <li><code>ConnectionFactory</code> routing through <code>AbstractRoutingConnectionFactory</code>.</li> 
 <li>Utilities for schema initialization through <code>ResourceDatabasePopulator</code> and <code>ScriptUtils</code>.</li> 
 <li>Propagation and reset of Auto-Commit and Isolation Level control through <code>TransactionDefinition</code>.</li> 
 <li>Support for Entity-level converters.</li> 
 <li>Kotlin extensions for reified generics and Coroutines.</li> 
 <li>Add pluggable mechanism to register dialects.</li> 
 <li>API refinements.</li> 
</ul>
">
<meta content="article" property="og:type">
<meta property="og:article:published_time" content="2019-10-01 14:19:00.0">
</head>
<body dir="ltr">

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" width="0" style="display:none"></iframe></noscript>

<script type="text/javascript">// Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }</script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">专案</a>
</li>
<li class="navbar-link">
<a href="/guides">导游</a>
</li>
<li class="navbar-link active">
<a href="/blog">博客</a>
</li>
<li class="navbar-link">
<a href="/services">培训与认证</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form class="form-inline form-search" action="/search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索文档，指南和帖子..." type="text" value="">
<button class="search-form--submit" type="submit"></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form class="form-inline form-search" action="/search" method="get">
<button class="search-form--submit" type="submit"></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="搜索..." type="text" value="">
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">家<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">专案<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">导游<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">博客<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">培训与认证<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category content--title">
<div>工程</div>
</div>
<div class="blog-category active content--title">
<div>发布</div>
</div>
<div class="blog-category content--title">
<div>新闻与活动</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Spring Data R2DBC 1.0 RC1发布</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon releases"></div>
<a class="category">发布</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/6494a9d91e9ffef9adc8253257f1b35e?s=20&d=mm"> <a class="author" rel="author" href="/team/mp911de">马克·帕鲁奇</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2019-10-01 14:19:00.0">十月01，2019</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" href="/blog/2019/10/01/spring-data-r2dbc-1-0-rc1-released#disqus_thread" data-disqus-identifier="3808">
</a></div>
</div>
</header>
<div class="blog--post"><p>我代表团队和所有贡献者，高兴地宣布，Spring Data R2DBC 1.0的第一个候选发行版已经发布，可以从我们的里程碑资料库中获得。此版本包含60个问题和请求请求。它将其基准升级到R2DBC 0.8 RC1和Spring Data Moore GA。</p>
<p>最值得注意的功能是：</p>
<ul>
<li><code>ConnectionFactory</code>通过<code>AbstractRoutingConnectionFactory</code>路由。</li>
<li>通过<code>ResourceDatabasePopulator</code>和<code>ScriptUtils</code>进行模式初始化的实用程序。</li>
<li>通过<code>TransactionDefinition</code>传播和重置自动提交和隔离级别控制。</li>
<li>支持实体级转换器。</li>
<li>Kotlin扩展，用于通用泛型和协程。</li>
<li>添加可插拔机制来注册方言。</li>
<li>API改进。</li>
</ul><h2><a href="#code-connectionfactory-code-routing" class="anchor" name="code-connectionfactory-code-routing"></a> <code>ConnectionFactory</code>路由</h2>
<p>对于每个操作， <code>DatabaseClient</code>获得<code>Connection</code>从<code>ConnectionFactory</code>被用于创建<code>DatabaseClient</code> 。</p>
<p>总体思路是，路由<code>ConnectionFactory</code>充当中介，而“真实的” <code>ConnectionFactory</code>在运行时根据查找键动态确定。一个潜在的使用情况是餐饮到多租户通过使用多个<code>ConnectionFactory</code>实例是指向一个单独的数据库。为了使路由<code>ConnectionFactory</code>确定要使用哪个<code>ConnectionFactory</code> ，它需要上下文信息。Spring Data R2DBC附带了<code>AbstractRoutingConnectionFactory</code> ，该函数可以返回用于查找正确的<code>ConnectionFactory</code>的查找键。</p>
<p>反应性流可以使用Project Reactor的<a href="https://projectreactor.io/docs/core/release/reference/#context"><code>Context</code></a>将上下文信息附加到订阅。</p>
<p>路由<code>ConnectionFactory</code>的示例实现可能类似于以下清单：</p>
<pre><code class="prettyprint java">class RoutingConnectionFactory extends AbstractRoutingConnectionFactory {

    public static final String ROUTING_KEY = "routing-key";

    @Override
    protected Mono<Object> determineCurrentLookupKey() {
        return Mono.subscriberContext().filter(it -> it.hasKey(ROUTING_KEY)).map(it -> it.get(ROUTING_KEY));
    }
}
</code></pre>
<p>下面的列表显示了如何初始化连接工厂的查找关键字和目标之间的映射<code>ConnectionFactory</code> ：</p>
<pre><code class="prettyprint java">RoutingConnectionFactory connectionFactory = new RoutingConnectionFactory();
Map<String, ConnectionFactory> factories = new HashMap<>();
factories.put("customer1", …);
factories.put("customer2", …);
connectionFactory.setTargetConnectionFactories(factories);
connectionFactory.afterPropertiesSet();
</code></pre>
<p>您可以通过使用路由<code>ConnectionFactory</code>来确定每个预订的适当<code>ConnectionFactory</code>来创建<code>DatabaseClient</code> 。<br>路由密钥本身已附加到<code>Context</code>并由<code>RoutingConnectionFactory</code>评估，如以下清单所示：</p>
<pre><code class="prettyprint java">DatabaseClient client = DatabaseClient.create(connectionFactory);

Context routingContext = Context.of(ROUTING_KEY, "customer1");

Flux<User> users = client.execute("SELECT first_name, last_name FROM user")
                .as(User.class)
                .fetch()
                .all()
                .subscriberContext(routingContext);
</code></pre><h2><a href="#schema-initialization" class="anchor" name="schema-initialization"></a>模式初始化</h2>
<p><code>org.springframework.data.r2dbc.connectionfactory.init</code>包提供了对初始化现有<code>ConnectionFactory</code>支持。有时您可能需要初始化一个实例，该实例在某处的服务器上运行，或者是嵌入式数据库。以下清单显示了如何注册和配置<code>ConnectionFactoryInitializer</code> bean来通过<code>ConnectionFactory</code>初始化数据库。</p>
<pre><code class="prettyprint java">@Configuration
public class InitializerConfiguration {

  @Bean
  public ConnectionFactoryInitializer initializer(ConnectionFactory connectionFactory) {

    ConnectionFactoryInitializer initializer = new ConnectionFactoryInitializer();
    initializer.setConnectionFactory(connectionFactory);

    CompositeDatabasePopulator populator = new CompositeDatabasePopulator();
    populator.addPopulators(new ResourceDatabasePopulator(new ClassPathResource("com/foo/sql/db-schema.sql")));
    populator.addPopulators(new ResourceDatabasePopulator(new ClassPathResource("com/foo/sql/test-data1.sql")));
    initializer.setDatabasePopulator(populator);

    return initializer;
  }
}
</code></pre>
<p>这初始化支持所使用的弹簧引导R2DBC自动配置应用<code>schema.sql</code>和<code>data.sql</code>配置的<code>ConnectionFactory</code> 。</p><h2><a href="#kotlin-extensions" class="anchor" name="kotlin-extensions"></a> Kotlin扩展</h2>
<p>此发行版随附Kotlin扩展，用于在使用Kotlin开发应用程序时惯用Spring Data R2DBC。</p>
<p>Spring Data R2DBC提供了以下扩展：</p>
<ul>
<li>改进的对<code>DatabaseClient</code>和<code>Criteria</code>泛型支持</li>
<li>Kotlin Coroutines对<code>DatabaseClient</code>支持</li>
</ul>
<p>要检索列表<code>User</code>在Java对象，你通常会写：</p>
<pre><code class="prettyprint java">Flux<User> characters = client.select().from(User.class).fetch().all();
</code></pre>
<p>使用Kotlin和Spring Data扩展，您可以编写以下内容：</p>
<pre><code class="prettyprint kotlin">val users =  client.select().from<User>().fetch().all()
</code></pre>
<p>Kotlin协程是Kotlin轻量级线程，允许以命令式风格编写非阻塞代码。<br>春季数据R2DBC的协同程序扩展充分利用了活性基础设施暴露可以功能<code>suspend</code> ，弥合<code>Flux</code>成果转化科特林的<code>Flow</code>类型。</p>
<p>以下示例显示了协程在Spring Framework的<code>TransactionalOperator</code>用法，以原子方式插入两行：</p>
<pre><code class="prettyprint kotlin">operator.executeAndAwait {
  client.execute("INSERT INTO person VALUES(:first_name, :last_name)")
        .bind("first_name", "John")
        .bind("last_name", "Doe")
        .await()
  client.execute("INSERT INTO person_events VALUES(:first_name, :last_name, :event_type)")
        .bind("first_name", "John")
        .bind("last_name", "Doe")
        .bind("event_type", "CREATED")
        .await()
}
</code></pre>
<p>请注意，大多数<code>suspend</code>方法都以<code>await</code>结尾，以此作为协程方法的指标。</p><h2><a href="#pluggable-dialects" class="anchor" name="pluggable-dialects"></a>可插拔方言</h2>
<p>到目前为止，R2DBC驱动程序生态系统仅由几个已知的驱动程序组成，但是驱动程序的数量正在增长。为了实现与其他驱动程序的无缝集成，Spring Data R2DBC公开了<code>R2dbcDialect</code>注册的扩展点。通过注册实现<code>org.springframework.data.r2dbc.dialect.DialectResolver$R2dbcDialectProvider</code></p><code>org.springframework.data.r2dbc.dialect.DialectResolver$R2dbcDialectProvider</code></div><code>org.springframework.data.r2dbc.dialect.DialectResolver$R2dbcDialectProvider</code></div><code>org.springframework.data.r2dbc.dialect.DialectResolver$R2dbcDialectProvider</code></article><code>org.springframework.data.r2dbc.dialect.DialectResolver$R2dbcDialectProvider</code></div><code>org.springframework.data.r2dbc.dialect.DialectResolver$R2dbcDialectProvider</code></div><code>org.springframework.data.r2dbc.dialect.DialectResolver$R2dbcDialectProvider</code></div><code>org.springframework.data.r2dbc.dialect.DialectResolver$R2dbcDialectProvider</code></div><code>org.springframework.data.r2dbc.dialect.DialectResolver$R2dbcDialectProvider</code></body></html>