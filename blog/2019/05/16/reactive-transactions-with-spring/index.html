<!DOCTYPE html>
<html data-code-prettify="" data-mobile-support="" data-search="">
<head>
<title>Reactive Transactions with Spring</title>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="Viewport" name="viewport" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon-ca31b78daf0dd9a106bbf3c6d87d4ec7.png" />
<link href="https://fonts.googleapis.com/css?family=Varela+Round|Montserrat:400,700" rel="stylesheet" type="text/css" />
<link rel="stylesheet" type="text/css" href="/css/main-bc256dba5f9d253d6425441ccfb82576.css" />
<script src="/jspm_packages/system-eccc019329febb5a1b06bde008ca5614.js"></script>
<script>
    System.config({baseURL: "/b92013b"});
  </script>
<script src="/config-5a675c9cddea3a5f55b71416e67d47d6.js"></script>
<script>
      System.import('app/main.js')
  </script>
<meta content="7qGntFPD9lWAVCtUu5U77v4l68PsTHf6xpzgjQv2j2M" name="google-site-verification" />

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KZM7GF6');</script>

<link href="/css/blog-92993c3ec6808bded45b277c18d7d621.css" rel="stylesheet" type="text/css" />

<meta content="summary" name="twitter:card" />
<meta content="@springcentral" name="twitter:site" />
<meta name="twitter:title" content="Reactive Transactions with Spring" />
<meta name="twitter:description" content="&lt;p&gt;Back in 2016, our reactive journey started with Spring Framework 5 accompanied by a couple of reactive integrations. Throughout our journey, other projects joined the reactive movement. With R2DBC, we now also provide a reactive integration for SQL databases. With the growth of transaction-capable integrations, we constantly got asked:&lt;/p&gt;
&lt;h2&gt;&lt;a href=&quot;#does-spring-framework-support-reactive-transaction&quot; class=&quot;anchor&quot; name=&quot;does-spring-framework-support-reactive-transaction&quot;&gt;&lt;/a&gt;Does Spring Framework support Reactive @Transaction?&lt;/h2&gt;
&lt;p&gt;At the time our journey began, we had no reactive form of transactional integrations, so this question was simple to answer: There’s no need for reactive transaction management. &lt;/p&gt;
" />
<meta name="twitter:creator" content="@mp911de" />
<meta name="twitter:image:src" content="https://gravatar.com/avatar/6494a9d91e9ffef9adc8253257f1b35e?s=200" />

<meta property="og:title" content="Reactive Transactions with Spring" />
<meta property="og:image" content="https://gravatar.com/avatar/6494a9d91e9ffef9adc8253257f1b35e?s=200" />
<meta property="og:description" content="&lt;p&gt;Back in 2016, our reactive journey started with Spring Framework 5 accompanied by a couple of reactive integrations. Throughout our journey, other projects joined the reactive movement. With R2DBC, we now also provide a reactive integration for SQL databases. With the growth of transaction-capable integrations, we constantly got asked:&lt;/p&gt;
&lt;h2&gt;&lt;a href=&quot;#does-spring-framework-support-reactive-transaction&quot; class=&quot;anchor&quot; name=&quot;does-spring-framework-support-reactive-transaction&quot;&gt;&lt;/a&gt;Does Spring Framework support Reactive @Transaction?&lt;/h2&gt;
&lt;p&gt;At the time our journey began, we had no reactive form of transactional integrations, so this question was simple to answer: There’s no need for reactive transaction management. &lt;/p&gt;
" />
<meta content="article" property="og:type" />
<meta property="og:article:published_time" content="2019-05-16 06:59:00.0" />
</head>
<body>

<noscript><iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-KZM7GF6" style="display:none;visibility:hidden" width="0"></iframe></noscript>

<script type="text/javascript">
    // Work around Google font rendering issues in webkit browsers on Windows 7
    if (navigator.userAgent.indexOf("NT 6.1") != -1) {
      document.body.style.WebkitTextStroke = "0.5px";
    }
  </script>
<div class="viewport">
<header class="navbar header--navbar desktop-only">
<div class="navbar-inner">
<div class="container-fluid">
<div class="spring-logo--container">
<a class="spring-logo" href="/"><span></span></a>
</div>
<ul class="nav pull-right">
<li class="navbar-link">
<a href="/projects">Projects</a>
</li>
<li class="navbar-link">
<a href="/guides">Guides</a>
</li>
<li class="navbar-link active">
<a href="/blog">Blog</a>
</li>
<li class="navbar-link">
<a href="/services">Training & Certification</a>
</li>
<li class="navbar-link nav-search js-nav-search">
<a>
<i class="icon-search navbar-search--icon js-search-input-open"></i>
<span class="search-input-close js-search-input-close">
<i class="icon-remove"></i>
</span>
</a>
</li>
</ul>
</div>
</div>
<div class="search-dropdown--container js-search-dropdown">
<div class="container-fluid">
<div class="search-form--container">
<form action="/search" class="form-inline form-search" method="get">
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search for documentation, guides, and posts..." type="text" value="" />
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
</form>
</div>
</div>
</div>
</header>
<div>
<div class="mobile-navigation--wrapper mobile-only">
<div class="navigation-drawer--container">
<div class="mobile-search--container">
<form action="/search" class="form-inline form-search" method="get">
<button class="search-form--submit" type="submit"><i class="icon-search"></i></button>
<input class="search-query search-form--form js-search-input" name="q" placeholder="Search..." type="text" value="" />
</form>
</div>
<div class="navigation-item-list">
<div class="navbar-link">
<a href="/">
Home
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/projects">
Projects
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/guides">
Guides
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link active">
<a href="/blog">
Blog
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
<div class="navbar-link">
<a href="/services">
Training & Certification
<i class="icon-chevron-right pull-right"></i>
</a>
</div>
</div>
</div>
<div class="mobile-nav">
<div class="nav-icon js-open-nav-drawer">
<i class="icon-reorder"></i>
</div>
<div class="header-center-icon">
<a href="/">
<div class="icon icon-spring-logo-mobile"></div>
</a>
</div>
</div>
</div>
</div>
<div class="header--container"></div>
<div class="container-fluid"></div>
<div></div>
<div class="container-fluid">
<div class="main-body--wrapper">
<div class="row-fluid blog--wrapper">
<article class="span8 mobile-left-pane" id="content">
<header class="desktop-only">
<div class="blog-category active content--title">
<div>Engineering</div>
</div>
<div class="blog-category content--title">
<div>Releases</div>
</div>
<div class="blog-category content--title">
<div>News and Events</div>
</div>
</header>
<div class="blog--container">
<header>
<h1 class="blog--title">Reactive Transactions with Spring</h1>
<div class="meta-data--container">
<div class="meta-data--item desktop-only">
<div class="meta-data--icon icon blog-icon engineering"></div>
<a class="category">Engineering</a>
</div>
<div class="meta-data--item">
<img class="meta-data--icon" src="https://gravatar.com/avatar/6494a9d91e9ffef9adc8253257f1b35e?s=20&amp;d=mm" />
<a class="author" rel="author" href="/team/mp911de">Mark Paluch</a>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon calendar"></div>
<time class="date" pubdate="" datetime="2019-05-16 06:59:00.0">May 16, 2019</time>
</div>
<div class="meta-data--item">
<div class="meta-data--icon icon blog-icon comments"></div>
<a class="comments" data-disqus-identifier="3668" href="/blog/2019/05/16/reactive-transactions-with-spring#disqus_thread">
</a></div>
</div>
</header>
<div class="blog--post"><p>Back in 2016, our reactive journey started with Spring Framework 5 accompanied by a couple of reactive integrations. Throughout our journey, other projects joined the reactive movement. With R2DBC, we now also provide a reactive integration for SQL databases. With the growth of transaction-capable integrations, we constantly got asked:</p><h2><a href="#does-spring-framework-support-reactive-transaction" class="anchor" name="does-spring-framework-support-reactive-transaction"></a>Does Spring Framework support Reactive @Transaction?</h2>
<p>At the time our journey began, we had no reactive form of transactional integrations, so this question was simple to answer: There’s no need for reactive transaction management. </p>
<p>Over time, MongoDB started to support multi-document transactions with MongoDB Server 4.0. R2DBC (the specification for reactive SQL database drivers) started to emerge, and we decided to pick up on R2DBC with Spring Data R2DBC. Both projects wanted to expose transactional behavior, so they eventually provided <code>inTransaction(…)</code> methods on their Template APIs to perform units of work guarded by native transactions.</p>
<p>While it is convenient to use an <code>inTransaction(…)</code> method for smaller chunks of work, it does not reflect the Spring way of supporting transactions. When working with imperative programming models, Spring Framework allows for two arrangements of transaction management: <code>@Transactional</code> and <code>TransactionTemplate</code> (declarative respective programmatic transaction management).</p>
<p>Both approaches to transaction management are built on top of <code>PlatformTransactionManager</code>, which manages transactions for transactional resources. <code>PlatformTransactionManager</code> can be either a Spring-provided transaction manager implementation or a Java EE one based on JTA.</p>
<p>Both approaches have in common that they bind the transactional state to <code>ThreadLocal</code> storage, which allows for transactional state management without passing a <code>TransactionStatus</code> object. Transaction management should happen in the background in a non-invasive manner.<br /><code>ThreadLocal</code> works in imperative programming arrangements because of the underlying assumption that we do not engage threads to continue work within a transaction.</p><h2><a href="#how-imperative-transaction-management-works" class="anchor" name="how-imperative-transaction-management-works"></a>How Imperative Transaction Management Works</h2>
<p>Transaction management needs to associate its transactional state with an execution. In imperative programming, this is typically a <code>ThreadLocal</code> storage – Transactional state is bound to a <code>Thread</code>. The underlying assumption is that transactional code gets executed on the same thread on which the container has invoked it.</p>
<p>Reactive programming models remove this fundamental assumption of imperative (synchronous/blocking) programming models. Taking a closer look at reactive execution, we can observe that code gets executed on different threads. This gets more visible when using inter-process communication. We can no longer safely assume that our code is fully executed on the same thread.</p>
<p>This change in assumptions invalidates transaction management implementations that rely on <code>ThreadLocal</code>.</p>
<p>Thread switches happen at arbitrary times, due to integrations and optimizations such as operator fusion. This change breaks all code that relies on <code>ThreadLocal</code>. The consequence is that we need a different arrangement to reflect transactional state without passing a <code>TransactionStatus</code> object all the time.</p>
<p>Associating out-of-band data is not a new requirement in the reactive space. We faced this requirement in other areas, such as the <code>SecurityContext</code> with Spring Security for reactive method security (to name one example). Project Reactor, the reactive library on top of which Spring builds its reactive support, has provided support for subscriber contexts since version 3.1.</p>
<p>Reactor <code>Context</code> is to reactive programming what <code>ThreadLocal</code> is to imperative programming: Contexts allow binding contextual data to a particular execution. For reactive programming, this is a <code>Subscription</code>. Reactor’s <code>Context</code> lets Spring bind the transaction state, along with all resources and synchronizations, to a particular <code>Subscription</code>. All reactive code that uses Project Reactor can now participate in reactive transactions. Code that returns scalar values and that wants to access transactional details must be rewritten to use reactive types to participate in transactions. Otherwise, the <code>Context</code> is not available.</p><h2><a href="#reactive-transaction-management" class="anchor" name="reactive-transaction-management"></a>Reactive Transaction Management</h2>
<p>Starting with Spring Framework 5.2 M2, Spring supports reactive transaction management through the <code>ReactiveTransactionManager</code> SPI.</p>
<p><code>ReactiveTransactionManager</code> is a transaction management abstraction for reactive and non-blocking integrations that uses transactional resources. It is a foundation for reactive <code>@Transactional</code> methods that return <code>Publisher</code> types and for programmatic transaction management that uses <code>TransactionalOperator</code>.</p>
<p>The first two reactive transaction manager implementations are:</p>
<ul>
<li>R2DBC through Spring Data R2DBC 1.0 M2</li>
<li>MongoDB through Spring Data MongoDB 2.2 M4</li>
</ul>
<p>Let’s take a look at how reactive transactions look like:</p>
<pre><code class="prettyprint java">class TransactionalService {

  final DatabaseClient db

  TransactionalService(DatabaseClient db) {
    this.db = db;
  }

  @Transactional
  Mono&lt;Void&gt; insertRows() {

    return db.execute()
      .sql(&quot;INSERT INTO person (name, age) VALUES(&#39;Joe&#39;, 34)&quot;)
      .fetch().rowsUpdated()
      .then(db.execute().sql(&quot;INSERT INTO contacts (name) VALUES(&#39;Joe&#39;)&quot;)
      .then();
  }
}
</code></pre>
<p>Reactive transactions look very similar to imperative transactions in annotation-driven arrangements. The main difference though is that we work with <code>DatabaseClient</code>, which is a reactive resource abstraction. All transaction management happens behind the scenes, leveraging Spring’s transaction interceptors and <code>ReactiveTransactionManager</code>. </p>
<p>Spring distinguishes (based on method return types) which type of transaction management to apply:</p>
<ul>
<li>Method returns a <code>Publisher</code> type: Reactive Transaction Management</li>
<li>All other return types: Imperative Transaction Management</li>
</ul>
<p>This distinction is significant, as you could still use imperative components such as a JPA or JDBC query. Wrapping these results into a <code>Publisher</code> type signals Spring to apply reactive rather than imperative transaction management. That being said, a reactive transaction arrangement does not open a <code>ThreadLocal</code>-bound transaction, which is required for JPA or JDBC.</p><h2><a href="#transactionaloperator" class="anchor" name="transactionaloperator"></a>TransactionalOperator</h2>
<p>As a next step, let’s take a look at programmatic transaction management by using <code>TransactionalOperator</code>:</p>
<pre><code class="prettyprint java">ConnectionFactory factory = …
ReactiveTransactionManager tm = new R2dbcTransactionManager(factory);
DatabaseClient db = DatabaseClient.create(factory);

TransactionalOperator rxtx = TransactionalOperator.create(tm);

Mono&lt;Void&gt; atomicOperation = db.execute()
  .sql(&quot;INSERT INTO person (name, age) VALUES(&#39;joe&#39;, &#39;Joe&#39;)&quot;)
  .fetch().rowsUpdated()
  .then(db.execute()
    .sql(&quot;INSERT INTO contacts (name) VALUES(&#39;Joe&#39;)&quot;)
    .then())
  .as(rxtx::transactional);
</code></pre>
<p>The code above contains some notable components:</p>
<ul>
<li><code>R2dbcTransactionManager</code>: This is the reactive transaction manager for a R2DBC <code>ConnectionFactory</code> .</li>
<li><code>DatabaseClient</code>: The client provides access to SQL databases using R2DBC drivers.</li>
<li><code>TransactionalOperator</code>: This operator associates all upstream R2DBC publishers with a transactional context. You can use it either operator style <code>as(…::transactional)</code> or call-back style with <code>execute(txStatus -&gt; …)</code>.</li>
</ul>
<p>Reactive transactions are started lazily upon subscription. The operator starts a transaction, sets the appropriate isolation level and associates the database connection with its subscriber context. All participating (upstream) <code>Publisher</code> instances use a single <code>Context</code>-bound transactional connection. </p>
<p>Reactive-functional operator chains can be either linear (by using a single <code>Publisher</code>) or non-linear (by merging multiple streams). Reactive transactions affect all upstream <code>Publisher</code>s when using operator style. To limit the transaction scope to a particular set of <code>Publisher</code>s, apply callback style, as follows:</p>
<pre><code class="prettyprint java">TransactionalOperator rxtx = TransactionalOperator.create(tm);

Mono&lt;Void&gt; outsideTransaction = db.execute()
  .sql(&quot;INSERT INTO person (name, age) VALUES(&#39;Jack&#39;, 31)&quot;)
  .then();

Mono&lt;Void&gt; insideTransaction = rxtx.execute(txStatus -&gt; {
  return db.execute()
    .sql(&quot;INSERT INTO person (name, age) VALUES(&#39;Joe&#39;, 34)&quot;)
    .fetch().rowsUpdated()
    .then(db.execute()
      .sql(&quot;INSERT INTO contacts (name) VALUES(&#39;Joe Black&#39;)&quot;)
      .then());
  }).then();

Mono&lt;Void&gt; completion = outsideTransaction.then(insideTransaction);
</code></pre>
<p>In the example above, transaction management is limited to <code>Publisher</code> instances subscribed within <code>execute(…)</code>. Or, to put it differently, the transaction is scoped. <code>Publisher</code> instances within <code>execute(…)</code> participate in the transaction, and the <code>Publisher</code> named <code>outsideTransaction</code> performs its work outside the transaction.</p>
<p>R2DBC is one of Spring’s integrations with reactive transactions. Another integration is MongoDB through Spring Data MongoDB, which you can use to participate in multi-document transactions by using reactive programming.</p>
<p>Spring Data MongoDB ships with <code>ReactiveMongoTransactionManager</code> as a <code>ReactiveTransactionManager</code> implementation. It creates a session and manages transactions so that code executed within a managed transaction participates in multi-document transactions.</p>
<p>The following example shows programmatic transaction management with MongoDB:</p>
<pre><code class="prettyprint java">ReactiveTransactionManager tm 
  = new ReactiveMongoTransactionManager(databaseFactory);
ReactiveMongoTemplate template = …
template.setSessionSynchronization(ALWAYS);                                          

TransactionalOperator rxtx = TransactionalOperator.create(tm);

Mono&lt;Void&gt; atomic = template.update(Step.class)
  .apply(Update.set(&quot;state&quot;, …))
  .then(template.insert(EventLog.class).one(new EventLog(…))
  .as(rxtx::transactional)
  .then();
</code></pre>
<p>The code above sets up a <code>ReactiveTransactionManager</code> and uses <code>TransactionalOperator</code> to perform multiple write actions within a single transaction. <code>ReactiveMongoTemplate</code> gets configured to participate in reactive transactions.</p><h2><a href="#next-steps" class="anchor" name="next-steps"></a>Next Steps</h2>
<p>Reactive Transaction Management ships with Spring Framework 5.2 M2, Spring Data MongoDB 2.2 M4, and Spring Data R2DBC 1.0 M2 milestone releases. You can pick up these and start integrating reactive transaction management in your code. We look forward to community feedback so that we can smooth out any sharp edges before shipping release candidates in early June.</p>
</div>
</div>
<section id="disqus_thread"></section>
<script type="text/javascript">
      var disqus_shortname = 'spring-io';
      var disqus_identifier = 3668;

      (function(disqus_shortname, document) {
        injectScript('//' + disqus_shortname + '.disqus.com/embed.js');
        injectScript('//' + disqus_shortname + '.disqus.com/count.js');

        function injectScript(url) {
          var s = document.createElement('script');
          s.async = true;
          s.src = url;
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(s);
        }

      }(disqus_shortname, document));
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a>
<div class="mobile-only">
<p><a href="/blog">
<i class="icon-chevron-left"></i>
Back
</a></p>
</div>
</article>
<aside class="span4 mobile-right-pane" id="sidebar">
<div>
<ul class="right-pane-widget--container secondary-nav with-icon">
<li class="blog-category">
<div class="icon blog-icon all-posts"></div>
<a href="/blog">All Posts</a>
<a class="pull-right" href="/blog.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category active">
<div class="icon blog-icon engineering"></div>
<a href="/blog/category/engineering">Engineering</a>
<a class="pull-right" href="/blog/category/engineering.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon releases"></div>
<a href="/blog/category/releases">Releases</a>
<a class="pull-right" href="/blog/category/releases.atom"><i class="icon-rss"></i></a>
</li>
<li class="blog-category">
<div class="icon blog-icon news-and-events"></div>
<a href="/blog/category/news">News and Events</a>
<a class="pull-right" href="/blog/category/news.atom"><i class="icon-rss"></i></a>
</li>
</ul>
<ul class="social-btn--container">
<a class="social-btn twitter" href="https://twitter.com/springcentral"></a>

<a class="social-btn linkedin" href="https://www.linkedin.com/groups/46964"></a>
<a class="social-btn youtube" href="/videos"></a>
</ul>
<div id="blog-sidebar-newsletter">
<p>Get updates from The Spring Team delivered to your inbox</p>
<script src="https://app-sj05.marketo.com/js/forms2/js/forms2.min.js"></script>
<form id="mktoForm_4723"></form>
<script>
        MktoForms2.loadForm("https://app-sj05.marketo.com", "625-IUJ-009", 4723, function(form){
          form.onSuccess(function(values, followUpUrl) {
            form.getFormElem().html("<p>Thank you!</p>");
            return false;
          });
        });
      </script>
</div>
</div>
</aside>
</div>
</div>
</div>
<footer class="footer">
<div class="container-fluid">
<div class="row-fluid">
<div class="span12">
<div class="navbar">
<div class="container">
<ul class="nav">
<li><a href="/team">Team</a></li>
<li><a href="/tools">Tools</a></li>
<li><a href="https://store.pivotal.io/">Store</a></li>
<li><a href="/blog">Newsletter</a></li>
</ul>
</div>
</div>
&copy; <span>2019</span> <a href="https://www.pivotal.io/">Pivotal Software</a>, Inc. All Rights Reserved.
<a href="https://pivotal.io/terms-of-use">Terms of Use</a> &bullet;
<a href="https://pivotal.io/privacy-policy">Privacy</a> &bullet;
<a href="/trademarks">Trademark Guidelines</a>
<div id="teconsent" style="display:inline-block;"></div>
</div>
</div>
</div>
</footer>
<div id="scrim"></div>
</div>
</body></html>